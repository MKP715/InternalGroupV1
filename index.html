<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rowlett Group Home</title>
    <!-- Link to the custom favicon logo -->
    <!-- Include Tailwind CSS for utility classes and Font Awesome for icons -->
    <script type="text/javascript" nonce="6a1ecf93e9ea40d69745a521409" src="//local.adguard.org?ts=1756309701836&amp;type=content-script&amp;dmn=chatgpt.com&amp;url=https%3A%2F%2Fchatgpt.com%2Fbackend-api%2Festuary%2Fcontent%3Fid%3Dfile-FWN5RSYCJYXFxtPJuZcVXR%26ts%3D487864%26p%3Dfs%26cid%3D1%26sig%3D7ff30eeb1ec578f48096db98306ce9016bf2e3d0dab442c691f75906ada342cb&amp;app=chrome.exe&amp;css=2&amp;js=1&amp;rel=1&amp;rji=1&amp;sbe=1"></script><script type="text/javascript" nonce="6a1ecf93e9ea40d69745a521409" src="//local.adguard.org?ts=1756309701836&amp;name=AdGuard%20Extra&amp;name=AdGuard%20Popup%20Blocker&amp;type=user-script"></script><script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <!-- Link to the custom favicon logo -->
    <link rel="icon" type="image/svg+xml" href="logo.svg">
    <style>
        /* Basic reset and typography */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #2c3e50; /* Dark Slate Gray */
            color: #ecf0f1; /* Silver */
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        h1, h2, h3 {
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: #3498db; /* Metallic Blue */
        }

        /* Navigation bar */
        nav {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            background: #34495e; /* Wet Asphalt */
            color: #ecf0f1;
            padding: 0.5rem 1rem;
            border-bottom: 2px solid #3498db; /* Metallic Blue */
        }
        nav .logo {
            display: flex;
            align-items: center;
            font-size: 1.25rem;
        }
        nav .logo svg {
            width: 32px;
            height: 32px;
            margin-right: 0.5rem;
        }
        nav ul {
            list-style: none;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }
        nav li {
            cursor: pointer;
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            transition: background 0.2s;
        }
        nav li:hover, nav li.active {
            background: #3498db; /* Metallic Blue */
            color: #ffffff;
        }

        /* Main content area */
        main {
            flex: 1;
            padding: 1rem;
            width: 100%;
            max-width: none;
            margin: 0;
            overflow-y: auto;
        }
        section {
            display: none;
        }
        section.active {
            display: block;
        }

        /* Home overview boxes */
        .grid {
            display: grid;
            gap: 1rem;
        }
        .grid-cols-2 {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }
        .box {
            background: #34495e; /* Wet Asphalt */
            border: 1px solid #7f8c8d; /* Silver-Gray */
            border-radius: 6px;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            color: #ecf0f1; /* Silver */
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }
        th, td {
            padding: 0.5rem;
            border-bottom: 1px solid #7f8c8d; /* Silver-Gray */
            text-align: left;
        }
        th {
            background: #2c3e50; /* Dark Slate Gray */
            color: #3498db; /* Metallic Blue */
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 4px;
            background: #3498db; /* Metallic Blue */
            color: #fff;
            border: 1px solid #2980b9; /* Darker Blue */
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn:hover {
            background: #2980b9;
        }
        .btn.secondary {
            background: #7f8c8d; /* Silver-Gray */
            border-color: #95a5a6;
        }
        .btn.secondary:hover {
            background: #95a5a6;
        }

        /* Form styling */
        .form-group {
            margin-bottom: 0.75rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.25rem;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #7f8c8d; /* Silver-Gray */
            border-radius: 4px;
            background: #34495e; /* Wet Asphalt */
            color: #ecf0f1; /* Silver */
        }

        /* Gallery */
        #gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
        }
        #gallery-grid img {
            width: 100%;
            height: auto;
            border-radius: 6px;
            object-fit: cover;
            cursor: pointer;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            max-width: 80%;
            max-height: 80%;
        }
        .modal-close {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #fff;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 101;
        }

        /* Next & previous buttons */
        .prev, .next {
            cursor: pointer;
            position: absolute;
            top: 50%;
            width: auto;
            padding: 16px;
            margin-top: -22px;
            color: white;
            font-weight: bold;
            font-size: 20px;
            transition: 0.6s ease;
            border-radius: 0 3px 3px 0;
            user-select: none;
            -webkit-user-select: none;
        }
        .next {
            right: 0;
            border-radius: 3px 0 0 3px;
        }
        .prev {
            left: 0;
        }
        .prev:hover, .next:hover {
            background-color: rgba(0,0,0,0.8);
        }

        /* History section */
        .history-nav {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .history-nav button {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #7f8c8d;
            border-radius: 4px;
            background: #34495e; /* Wet Asphalt */
            color: #ecf0f1; /* Silver */
            cursor: pointer;
            transition: background 0.2s;
        }
        .history-nav button.active {
            background: #3498db; /* Metallic Blue */
            border-color: #2980b9;
        }
        /* Timeline styles adapted from the original history pages.  */
        .timeline-container {
            position: relative;
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        .timeline-container::after {
            content: '';
            position: absolute;
            width: 6px;
            background-color: #7f8c8d; /* Silver-Gray */
            top: 0;
            bottom: 0;
            left: 50%;
            margin-left: -3px;
            border-radius: 3px;
        }
        .timeline-block {
            padding: 10px 40px;
            position: relative;
            background-color: inherit;
            width: 50%;
        }
        .timeline-block.left {
            left: 0;
        }
        .timeline-block.right {
            left: 50%;
        }
        .timeline-block::after {
            content: '';
            position: absolute;
            width: 25px;
            height: 25px;
            right: -14px;
            background-color: #34495e; /* Wet Asphalt */
            border: 4px solid #3498db; /* Metallic Blue */
            top: 25px;
            border-radius: 50%;
            z-index: 1;
            transition: all 0.3s ease;
        }
        .timeline-block.right::after {
            left: -12px;
            right: auto;
        }
        .timeline-content {
            padding: 20px 30px;
            background-color: #2c3e50; /* Dark Slate Gray */
            color: #ecf0f1; /* Silver */
            position: relative;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .timeline-content:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .timeline-block:hover::after {
            transform: scale(1.2);
            border-color: #FBBF24; /* amber-400 */
        }
        /* Info popups are hidden by default. They will appear on hover via timeline-content:hover .info-popup. */
        .info-popup {
            position: absolute;
            bottom: calc(100% + 15px);
            left: 50%;
            transform: translateX(-50%) scale(0.95);
            width: 90%;
            min-width: 250px;
            background-color: #34495e; /* Wet Asphalt */
            color: #ecf0f1; /* Silver */
            padding: 15px;
            border-radius: 8px;
            z-index: 10;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .timeline-content:hover .info-popup {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) scale(1);
        }
        /* History content sections */
        .history-content {
            display: none;
        }
        .history-content.active {
            display: block;
        }
        /* Calendar styles */
        #calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            border: 1px solid #7f8c8d; /* Silver-Gray */
            border-radius: 6px;
            overflow: hidden;
        }
        .calendar-day {
            border-right: 1px solid #7f8c8d;
            border-bottom: 1px solid #7f8c8d;
            min-height: 110px;
            padding: 4px;
            font-size: 0.8rem;
            position: relative;
        }
        .calendar-day:nth-child(7n) {
            border-right: none;
        }
        .calendar-day-name {
            font-weight: bold;
            background-color: #2c3e50; /* Dark Slate Gray */
            color: #3498db; /* Metallic Blue */
            text-align: center;
            padding: 4px 0;
            border-bottom: 1px solid #7f8c8d;
        }
        .calendar-day-number {
            font-weight: bold;
            margin-bottom: 4px;
        }
        .calendar-event {
            background-color: #3498db; /* Metallic Blue */
            color: white;
            border-radius: 3px;
            border-left: 5px solid #2980b9; /* Default category color */
            padding: 2px 4px;
            font-size: 0.7rem;
            margin-bottom: 2px;
            display: block;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            position: relative; /* For tooltip positioning */
            cursor: help;
        }
        /* Tooltip styles */
        .calendar-event .tooltip {
            visibility: hidden;
            width: 220px;
            background-color: #34495e;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 10;
            bottom: 110%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
            white-space: normal;
            font-size: 0.8rem;
            line-height: 1.4;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .calendar-event:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
        .calendar-event .tooltip strong {
            color: #3498db; /* Metallic Blue */
        }
        /* Toast Notification styles */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
        }
        .toast {
            background-color: #34495e; /* Wet Asphalt */
            color: #ecf0f1; /* Silver */
            padding: 15px 20px;
            border-radius: 6px;
            border-left: 5px solid #3498db; /* Default: info */
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.4s ease;
        }
        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        .toast.success { border-left-color: #2ecc71; /* Green */ }
        .toast.error { border-left-color: #e74c3c; /* Red */ }

        /* Back to Top Button */
        #back-to-top-btn {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 30px;
            z-index: 99;
            font-size: 18px;
            border: none;
            outline: none;
            background-color: #3498db;
            color: white;
            cursor: pointer;
            padding: 15px;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            line-height: 18px;
            text-align: center;
        }
        #back-to-top-btn:hover {
            background-color: #2980b9;
        }
    </style>
</head>
<body>
    <div id="toast-container"></div>
    <button id="back-to-top-btn" title="Go to top"><i class="fas fa-arrow-up"></i></button>
    <nav>
        <div class="logo">
            <!-- Inline SVG to display the logo in the nav -->
            <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <circle cx="50" cy="50" r="48" fill="#3498db"/>
                <text x="50" y="57" text-anchor="middle" font-size="45" fill="white" font-family="Verdana, sans-serif">R</text>
            </svg>
            <span>Rowlett Group</span>
        </div>
        <ul id="nav-menu">
            <li data-section="home-section" class="active">Home</li>
            <li data-section="companion-section">Meeting Companion</li>
            <li data-section="schedule-section">Schedule</li>
            <li data-section="birthdays-section">Birthdays</li>
            <li data-section="announcements-section">Announcements</li>
            <li data-section="gallery-section">Gallery</li>
            <li data-section="history-section">History</li>
            <li data-section="chairperson-section">Chairperson's Corner</li>
            <li data-section="settings-section">Settings</li>
        </ul>
    </nav>

    <main>
        <!-- Home Section -->
        <section id="home-section" class="active">
            <h1>Welcome to the Rowlett Group</h1>
            <p class="mb-4">This internal site serves as your one-stop hub for meeting schedules, member birthdays, group announcements, and more. All data you add here is stored locally in your browser.</p>
            <div class="grid grid-cols-2">
                <div class="box">
                    <h3>Upcoming Meetings</h3>
                    <a href="zoommtg://zoom.us/join?action=join&confno=89039357234&pwd=dGFobXpwY04yalVZQ1RySlRCcitsUT09" class="btn" style="display: block; text-align: center; margin-bottom: 1rem;">
                        <i class="fas fa-video"></i> Start Zoom Meeting
                    </a>
                    <p style="font-size: 0.8rem; text-align: center; margin-bottom: 1rem;">(Requires Zoom to be installed)</p>
                    <ul id="home-upcoming-events"></ul>
                    <button class="btn" onclick="goToSection('schedule-section')">View Full Schedule</button>
                </div>
                <div class="box">
                    <h3>Upcoming Birthdays</h3>
                    <ul id="home-upcoming-birthdays"></ul>
                    <button class="btn" onclick="goToSection('birthdays-section')">Manage Birthdays</button>
                </div>
                <div class="box">
                    <h3>Recent Announcements</h3>
                    <ul id="home-recent-announcements"></ul>
                    <button class="btn" onclick="goToSection('announcements-section')">View All Announcements</button>
                </div>
                <div class="box">
                    <h3>Latest Photos</h3>
                    <div id="home-latest-photos" style="display:flex; gap:0.5rem; overflow-x: auto;"></div>
                    <button class="btn" onclick="goToSection('gallery-section')">Browse Gallery</button>
                </div>
                <div class="box" style="text-align: center;">
                    <h3>7th Tradition</h3>
                    <img id="qr-code-img" src="https://via.placeholder.com/250" alt="QR Code Placeholder" style="width: 250px; height: 250px; margin: auto; border-radius: 8px;">
                    <p class="mt-2">For questions, please contact Nathan D at 214-000-0000.</p>
                </div>
            </div>
        </section>

        <!-- Chairperson's Corner Section -->
        <section id="chairperson-section">
            <h2>Chairperson's Corner</h2>
            <p class="mb-4">Track meeting attendance and contributions. All data is stored locally.</p>
            <div class="box mb-4">
                <h3 class="text-lg font-bold">Member Management</h3>
                <button class="btn" onclick="openRosterModal()">View Full Member Roster</button>
            </div>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <!-- Left column for form and table -->
                <div>
                    <div class="box">
                        <h3 id="chairperson-form-title">Log New Entry</h3>
                        <div class="form-group">
                            <label for="log-date">Meeting Date</label>
                            <input type="date" id="log-date">
                        </div>
                        <div class="form-group">
                            <label for="log-time">Meeting Time</label>
                            <input type="time" id="log-time">
                        </div>
                        <div class="form-group">
                            <label for="log-chairperson">Chairperson's Name</label>
                            <select id="log-chairperson"></select>
                        </div>
                        <div class="form-group">
                            <label for="log-headcount">Head Count</label>
                            <input type="number" id="log-headcount" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label for="log-7th-tradition">7th Tradition ($)</label>
                            <input type="number" id="log-7th-tradition" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label for="log-orange-can">Orange Can ($)</label>
                            <input type="number" id="log-orange-can" step="0.01" placeholder="0.00">
                        </div>
                        <input type="hidden" id="log-edit-id">
                        <button id="log-form-btn" class="btn" onclick="handleChairpersonLogSubmit()">Add Log Entry</button>
                        <button id="log-form-cancel-btn" class="btn secondary" onclick="cancelLogEdit()" style="display:none; margin-left: 0.5rem;">Cancel</button>
                    </div>

                    <h3 class="mt-4">Contribution Log</h3>
                    <button class="btn" onclick="exportChairpersonLogToPDF()" style="margin-bottom: 1rem;">Export Log to PDF</button>
                    <table id="chairperson-log-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Chairperson</th>
                                <th>Head Count</th>
                                <th>7th Tradition</th>
                                <th>Orange Can</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="chairperson-log-body"></tbody>
                    </table>
                </div>

                <!-- Right column for Group Conscience Log -->
                <div>
                    <div class="box mb-4">
                        <h3>Active Announcements</h3>
                        <ul id="chairperson-announcements-list"></ul>
                    </div>
                    <div class="box">
                        <h3 id="gc-form-title">Log Group Conscience Item</h3>
                        <div class="form-group">
                            <label for="gc-date">Date</label>
                            <input type="date" id="gc-date">
                        </div>
                        <div class="form-group">
                            <label for="gc-item">Item/Motion</label>
                            <textarea id="gc-item" rows="2" placeholder="Describe the motion..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="gc-submitted-by">Submitted By</label>
                            <input type="text" id="gc-submitted-by" placeholder="Name">
                        </div>
                        <div class="form-group">
                            <label for="gc-status">Status</label>
                            <select id="gc-status">
                                <option value="passed">Passed</option>
                                <option value="failed">Failed</option>
                                <option value="tabled">Tabled</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="gc-votes">Votes (For-Against)</label>
                            <input type="text" id="gc-votes" placeholder="e.g., 10-2">
                        </div>
                        <div class="form-group">
                            <label for="gc-attendees">Members Present</label>
                            <select multiple id="gc-attendees" style="height: 120px; background: #34495e; color: #ecf0f1; border: 1px solid #7f8c8d; border-radius: 4px; padding: 0.5rem; width: 100%;"></select>
                        </div>
                        <div class="form-group">
                            <label for="gc-servant-reports">Servant Reports</label>
                            <textarea id="gc-servant-reports" rows="3" placeholder="Summary of reports..."></textarea>
                        </div>
                        <input type="hidden" id="gc-edit-id">
                        <button id="gc-form-btn" class="btn" onclick="handleGCLogSubmit()">Add GC Entry</button>
                        <button id="gc-form-cancel-btn" class="btn secondary" onclick="cancelGCEdit()" style="display:none; margin-left: 0.5rem;">Cancel</button>
                    </div>

                    <h3 class="mt-4">Current Month's Group Conscience</h3>
                    <table id="gc-log-table-current">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Item</th>
                                <th>Submitted By</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="gc-log-body-current"></tbody>
                    </table>

                    <h3 class="mt-4">Previous Months' Group Conscience</h3>
                    <table id="gc-log-table-previous">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Item</th>
                                <th>Submitted By</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="gc-log-body-previous"></tbody>
                    </table>
                    <button class="btn mt-2" onclick="exportGroupConscienceLogToPDF()" style="margin-bottom: 1rem;">Export Full GC Log to PDF</button>

                    <div class="box mt-4">
                        <h3>Record Meeting Audio</h3>
                        <p class="mb-2 text-sm" style="font-size: 0.8rem; opacity: 0.8;">Record audio from your microphone and save it as a local file.</p>
                        <div id="audio-recorder-controls" class="flex items-center gap-2" style="display:flex; gap: 0.5rem; align-items: center;">
                            <button id="record-btn" class="btn"><i class="fas fa-microphone" style="margin-right: 0.5rem;"></i>Start Recording</button>
                            <button id="stop-btn" class="btn secondary" disabled><i class="fas fa-stop" style="margin-right: 0.5rem;"></i>Stop</button>
                        </div>
                        <div id="audio-player-container" class="mt-4" style="display: none;">
                            <audio id="audio-player" controls style="width: 100%;"></audio>
                            <a id="download-link" class="btn mt-2" style="display: none;"><i class="fas fa-download" style="margin-right: 0.5rem;"></i>Download Recording</a>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Meeting Companion Section -->
        <section id="companion-section">
            <h2>Meeting Companion</h2>
            <p class="mb-4">Select a meeting type to view the format and readings.</p>
            <div id="meeting-format-buttons" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                <button class="btn" onclick="showMeetingFormat('open-discussion')">Open Discussion</button>
                <button class="btn" onclick="showMeetingFormat('closed-discussion')">Closed Discussion</button>
                <button class="btn" onclick="showMeetingFormat('big-book')">Big Book Study</button>
                <button class="btn" onclick="showMeetingFormat('12x12')">12x12 Study</button>
                <button class="btn" onclick="showMeetingFormat('personal-story')">Personal Story</button>
                <button class="btn" onclick="showMeetingFormat('foundations')">Foundations Speaker</button>
                <button class="btn" onclick="showMeetingFormat('birthday')">Birthday Night</button>
            </div>
            <h3 class="mt-4">Readings</h3>
            <div id="reading-buttons" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                <button class="btn" onclick="showMeetingFormat('how-it-works')">How It Works</button>
                <button class="btn" onclick="showMeetingFormat('traditions')">The 12 Traditions</button>
                <button class="btn" onclick="showMeetingFormat('promises')">The 9th Step Promises</button>
            </div>
            <div id="meeting-format-display" class="box mt-4" style="display: none;">
                <!-- Meeting format will be injected here -->
            </div>
        </section>

        <!-- Schedule Section -->
        <section id="schedule-section">
            <h2>Schedule of Meetings & Events</h2>
            <p class="mb-2">Add recurring weekly meetings or special one-time events. Use the calendar to browse by month. Upcoming events for the next 60 days are listed below.</p>

            <!-- Calendar Controls -->
            <div id="calendar-controls" style="display:flex; align-items:center; justify-content: space-between; gap:0.5rem; margin-bottom:0.5rem;">
                <button class="btn secondary" id="prev-month-btn">&lt; Prev</button>
                <h3 id="calendar-month-year" style="flex:1; text-align:center;"></h3>
                <button class="btn secondary" id="next-month-btn">Next &gt;</button>
            </div>
            <div id="calendar-grid"></div>

            <button class="btn" onclick="toggleEventForm()" style="margin-top: 1rem;">Add New Event</button>
            <div id="add-event-form" class="box" style="display:none; margin-top: 1rem;">
                <div class="form-group">
                    <label for="event-title">Title</label>
                    <input type="text" id="event-title" placeholder="e.g. Big Book Study" />
                </div>
                <div class="form-group">
                    <label for="event-date">Date (leave blank for weekly)</label>
                    <input type="date" id="event-date" />
                </div>
                <div class="form-group">
                    <label for="event-day">Day of Week (for weekly meetings)</label>
                    <select id="event-day">
                        <option value="">--Select day--</option>
                        <option value="0">Sunday</option>
                        <option value="1">Monday</option>
                        <option value="2">Tuesday</option>
                        <option value="3">Wednesday</option>
                        <option value="4">Thursday</option>
                        <option value="5">Friday</option>
                        <option value="6">Saturday</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="event-time">Time</label>
                    <input type="time" id="event-time" />
                </div>
                <div class="form-group">
                    <label for="event-category">Category</label>
                    <select id="event-category">
                        <option value="General">General</option>
                        <option value="Open Discussion">Open Discussion</option>
                        <option value="Closed Discussion">Closed Discussion</option>
                        <option value="Big Book Study">Big Book Study</option>
                        <option value="12x12 Study">12x12 Study</option>
                        <option value="Personal Story">Personal Story</option>
                        <option value="Foundations Speaker">Foundations Speaker</option>
                        <option value="Birthday Night">Birthday Night</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="event-reading">Reading</label>
                    <input type="text" id="event-reading" placeholder="e.g. How It Works" />
                </div>
                <div class="form-group">
                    <label for="event-speaker">Speaker</label>
                    <select id="event-speaker"></select>
                </div>
                <div class="form-group">
                    <label for="event-chair">Chairperson</label>
                    <select id="event-chair"></select>
                </div>
                <div class="form-group">
                    <label for="event-description">Description</label>
                    <textarea id="event-description" rows="2" placeholder="Notes or description..."></textarea>
                </div>
                <input type="hidden" id="event-edit-id">
                <button id="event-form-btn" class="btn" onclick="handleEventSubmit()">Add Event</button>
                <button id="event-form-cancel-btn" class="btn secondary" onclick="cancelEventEdit()" style="display:none; margin-left: 0.5rem;">Cancel</button>
            </div>

            <h3 class="mt-4">Upcoming Events (Next 30 Days)</h3>
            <div class="form-group">
                <label for="category-filter">Filter by Category</label>
                <select id="category-filter" onchange="updateEventsTable()">
                    <option value="All">All Categories</option>
                    <option value="General">General</option>
                    <option value="Open Discussion">Open Discussion</option>
                    <option value="Closed Discussion">Closed Discussion</option>
                    <option value="Big Book Study">Big Book Study</option>
                    <option value="12x12 Study">12x12 Study</option>
                    <option value="Personal Story">Personal Story</option>
                    <option value="Foundations Speaker">Foundations Speaker</option>
                    <option value="Birthday Night">Birthday Night</option>
                </select>
            </div>
            <table id="events-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Title</th>
                        <th>Category</th>
                        <th>Time</th>
                        <th>Speaker</th>
                        <th>Chair</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="events-body"></tbody>
            </table>
        </section>

        <!-- Members Section -->
        <section id="birthdays-section">
            <h2>Member Roster & Birthdays</h2>
            <p class="mb-2">Add and manage member information and see upcoming sobriety birthdays.</p>
            <button class="btn" onclick="toggleMemberForm()">Add Member</button>
            <div id="add-member-form" class="box" style="display:none; margin-top: 1rem;">
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <div class="form-group">
                            <label for="member-name">Name*</label>
                            <input type="text" id="member-name" placeholder="Member's name" />
                        </div>
                        <div class="form-group">
                            <label for="member-birthday">Sobriety Date*</label>
                            <input type="date" id="member-birthday" />
                        </div>
                        <div class="form-group">
                            <label for="member-phone">Phone Number</label>
                            <input type="tel" id="member-phone" placeholder="e.g., 123-456-7890" />
                        </div>
                        <div class="form-group">
                            <label for="member-email">Email</label>
                            <input type="email" id="member-email" placeholder="member@example.com" />
                        </div>
                    </div>
                    <div>
                        <div class="form-group">
                            <label for="member-city">City</label>
                            <input type="text" id="member-city" placeholder="e.g., Rowlett" />
                        </div>
                        <div class="form-group">
                            <label for="member-homegroup">Homegroup</label>
                            <input type="text" id="member-homegroup" placeholder="e.g., The Rowlett Group" />
                        </div>
                        <div class="form-group">
                            <label for="member-sponsor">Sponsor</label>
                            <input type="text" id="member-sponsor" placeholder="Sponsor's name" />
                        </div>
                    </div>
                </div>
                <div class="box" style="margin-top: 1rem; border-top: 1px solid #7f8c8d; padding-top: 1rem;">
                    <h4 class="font-bold">Service Position</h4>
                    <div class="form-group" style="display: flex; align-items: center; gap: 1rem;">
                        <input type="checkbox" id="member-is-servant" style="width: auto;"/>
                        <label for="member-is-servant">Is this member a current servant?</label>
                    </div>
                    <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="member-servant-position">Position</label>
                            <input type="text" id="member-servant-position" placeholder="e.g., Treasurer" />
                        </div>
                        <div class="form-group">
                            <label for="member-servant-since">Serving Since</label>
                            <input type="date" id="member-servant-since" />
                        </div>
                    </div>
                </div>
                <input type="hidden" id="member-edit-id">
                <button id="member-form-btn" class="btn" onclick="handleMemberSubmit()">Add Member</button>
                <button id="member-form-cancel-btn" class="btn secondary" onclick="cancelMemberEdit()" style="display:none; margin-left: 0.5rem;">Cancel</button>
            </div>
            
            <h3 class="mt-4">Upcoming & Recent Birthdays</h3>
            <table id="birthdays-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Sobriety Date</th>
                        <th>Next Birthday</th>
                        <th>Years</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="birthdays-body"></tbody>
            </table>
        </section>

        <!-- Announcements Section -->
        <section id="announcements-section">
            <h2>Announcements</h2>
            <div class="form-group">
                <label for="announcement-text">Announcement</label>
                <textarea id="announcement-text" rows="2" placeholder="Enter announcement..."></textarea>
            </div>
            <button class="btn" onclick="addAnnouncement()">Add Announcement</button>
            
            <h3 class="mt-4">Current Announcements</h3>
            <ul id="announcements-list"></ul>
        </section>

        <!-- Gallery Section -->
        <section id="gallery-section">
            <h2>Photo Gallery</h2>
            <p class="mb-2">Upload pictures of fliers or events. Add comma-separated tags to help organize them.</p>
            <div class="form-group">
                <label for="photo-upload">Select Photos</label>
                <input type="file" id="photo-upload" accept="image/*" multiple />
            </div>
            <div class="form-group">
                <label for="photo-tags">Tags (comma-separated)</label>
                <input type="text" id="photo-tags" placeholder="e.g. bbq, anniversary, 2024" />
            </div>
            <button class="btn" onclick="uploadPhotos()">Upload Selected</button>

            <h3 class="mt-4">Filter Photos</h3>
            <div class="form-group">
                <input type="text" id="tag-filter" onkeyup="updateGallery()" placeholder="Filter by tag..." />
            </div>
            <div id="tag-list" class="mb-4"></div>

            <h3 class="mt-4">Photos</h3>
            <div id="gallery-grid"></div>
        </section>

        <!-- The Modal -->
        <div id="photo-modal" class="modal">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <a class="prev" onclick="showPreviousPhoto()">&#10094;</a>
            <a class="next" onclick="showNextPhoto()">&#10095;</a>
            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; max-width: 90vw; max-height: 90vh;">
                <img class="modal-content" id="modal-image" style="max-height: 80vh; object-fit: contain;">
                <div id="modal-caption" style="text-align: center; color: #ccc; padding: 10px 0; font-size: 1rem; height: 2rem;"></div>
            </div>
        </div>

        <!-- History Section -->
        <section id="history-section">
            <h2>History &amp; Resources</h2>
            <!-- History navigation buttons for different timelines -->
            <div class="history-nav">
                <button id="genesis-btn" onclick="showHistory('genesis-history')">Genesis of AA</button>
                <button id="dfw-btn" onclick="showHistory('dfw-history')">Dallas/Fort Worth History</button>
                <button id="rowlett-btn" onclick="showHistory('rowlett-history')">Rowlett Group History</button>
            </div>
            <!-- Embedded histories (hidden by default, toggled via showHistory()) -->
            <div id="genesis-history" class="history-content">
                <h3 class="mb-4 font-bold text-xl">The Genesis of Alcoholics Anonymous</h3>
                <!-- Genesis timeline -->
                <div class="timeline-wrapper">
                <div class="timeline-container">
                
                            <!-- Event 1: 1895 - Bill W. Born -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-blue-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-blue-400 pb-1 mb-2">William Griffith Wilson's Birth</h4>
                                        <p class="text-sm">Born in East Dorset, Vermont. His early life was marked by feelings of isolation and a strong drive for recognition, factors that would later influence his drinking and recovery.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-blue-800">Nov 26, 1895: Bill W. Born <i class="fa-solid fa-baby ml-2 text-blue-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Birth of William Griffith Wilson, co-founder of Alcoholics Anonymous.</p>
                                </div>
                            </div>
                
                            <!-- Event 2: 1879 - Dr. Bob Born -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-purple-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-purple-400 pb-1 mb-2">Robert Holbrook Smith's Birth</h4>
                                        <p class="text-sm">Born in St. Johnsbury, Vermont. He would later become a respected surgeon in Akron, Ohio, and co-founder of AA, despite his long struggle with alcoholism.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-purple-800">Aug 8, 1879: Dr. Bob Born <i class="fa-solid fa-baby ml-2 text-purple-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Birth of Robert Holbrook Smith, co-founder of Alcoholics Anonymous.</p>
                                </div>
                            </div>
                
                            <!-- Event 3: Early 1900s - Bill W.'s Descent & Marriage -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-green-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-green-400 pb-1 mb-2">Bill's Struggle & Lois Wilson</h4>
                                        <p class="text-sm">Bill's drinking progresses, leading to severe consequences. He marries Lois Burnham Wilson in 1918, who would become a steadfast supporter and co-founder of Al-Anon.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-green-800">1910s-30s: Bill's Descent & Lois <i class="fa-solid fa-ring ml-2 text-green-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Bill's alcoholism escalates, bringing financial ruin and repeated hospitalizations, deeply impacting his wife, Lois.</p>
                                </div>
                            </div>
                
                            <!-- Event 4: Early 1900s - Dr. Bob's Hidden Battle & Marriage -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-teal-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-teal-400 pb-1 mb-2">Dr. Bob's Hidden Battle & Anne Smith</h4>
                                        <p class="text-sm">Dr. Bob's alcoholism becomes a decades-long struggle, hidden from many. He marries Anne Ripley Smith, who would become a crucial figure in early AA and Al-Anon, supporting his recovery efforts.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-teal-800">1910s-30s: Dr. Bob's Struggle & Anne <i class="fa-solid fa-house-medical-flag ml-2 text-teal-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Dr. Bob battles severe, often hidden, alcoholism despite his medical career, supported by his wife, Anne.</p>
                                </div>
                            </div>
                
                            <!-- Event 5: November 1934 - Ebby T.'s Visit & Bill's Turning Point -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-cyan-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-cyan-400 pb-1 mb-2">The Spiritual Solution Introduced</h4>
                                        <p class="text-sm">Bill's old drinking friend, Ebby T., visits him, sober, and introduces the idea of a spiritual solution, learned from the Oxford Group. This plants the seed for Bill's own spiritual awakening.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-cyan-800">Nov 1934: Ebby T. & Bill's Shift <i class="fa-solid fa-hand-holding-heart ml-2 text-cyan-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Ebby T. visits Bill, sharing his newfound sobriety through a spiritual experience, igniting hope in Bill during his deepest despair.</p>
                                </div>
                            </div>
                
                            <!-- Event 6: December 1934 - Bill's Spiritual Awakening -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-yellow-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-yellow-400 pb-1 mb-2">The "White Light" Experience</h4>
                                        <p class="text-sm">While hospitalized in Towns Hospital, Bill experiences a profound spiritual awakening after crying out to God in desperation. The obsession with alcohol is lifted, and he finds immediate sobriety.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-yellow-800">Dec 1934: Bill's Awakening <i class="fa-solid fa-lightbulb ml-2 text-yellow-500"></i></h2>
                                    <p class="mt-2 text-slate-700">In Towns Hospital, Bill W. has a powerful spiritual experience that removes his obsession to drink, marking his last drink.</p>
                                </div>
                            </div>
                
                            <!-- Event 7: Early 1935 - Bill's Early Attempts & The Paradox -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-orange-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-orange-400 pb-1 mb-2">The Helper Therapy Principle</h4>
                                        <p class="text-sm">Bill's initial attempts to "convert" other alcoholics fail until he realizes he must share his experience with empathy, not preach. He discovers that helping others is crucial for his own sobriety.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-orange-800">Early 1935: The Paradox Discovered <i class="fa-solid fa-person-digging ml-2 text-orange-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Bill learns that helping other alcoholics is essential for maintaining his own sobriety, laying the groundwork for AA's core service principle.</p>
                                </div>
                            </div>
                
                            <!-- Event 8: May 1935 - Bill W. Meets Dr. Bob (AA's Founding) -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-red-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-red-400 pb-1 mb-2">The Birth of AA</h4>
                                        <p class="text-sm">During a business trip to Akron, Bill, desperate to help another alcoholic to stay sober himself, is introduced to Dr. Bob by Henrietta Seiberling. Their shared experience and mutual need ignite the spark of Alcoholics Anonymous.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-red-800">May 1935: AA is Born <i class="fa-solid fa-handshake ml-2 text-red-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Bill W. meets Dr. Bob in Akron, Ohio. Their first conversation and shared experience mark the official founding of Alcoholics Anonymous.</p>
                                </div>
                            </div>
                
                            <!-- Event 9: June 10, 1935 - Dr. Bob's Last Drink -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-indigo-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-indigo-400 pb-1 mb-2">The Last Drink</h4>
                                        <p class="text-sm">After continued discussions with Bill and a final relapse, Dr. Bob takes his last drink on June 10, 1935, achieving continuous sobriety. This date is celebrated as AA's founding day.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-indigo-800">June 10, 1935: Dr. Bob Sober <i class="fa-solid fa-calendar-check ml-2 text-indigo-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Dr. Bob takes his last drink, achieving continuous sobriety and solidifying the foundation of the new fellowship.</p>
                                </div>
                            </div>
                
                            <!-- Event 10: June 1935 Onwards - The First AA Group in Akron -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-purple-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-purple-400 pb-1 mb-2">Working with Others</h4>
                                        <p class="text-sm">Bill and Dr. Bob begin working with other alcoholics, primarily at Akron City Hospital. They apply their principles of sharing experience, spiritual transformation, and mutual support, forming the nucleus of the first AA group.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-purple-800">June 1935+: Akron Group <i class="fa-solid fa-hospital ml-2 text-purple-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Bill and Dr. Bob begin intensive work with other alcoholics, particularly in hospitals, forming the first AA group in Akron.</p>
                                </div>
                            </div>
                
                            <!-- Event 11: Late 1930s - Evolution of the Twelve Steps -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-green-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-green-400 pb-1 mb-2">From Oxford Group to AA's Principles</h4>
                                        <p class="text-sm">The Twelve Steps evolved from the six principles of the Oxford Group, a spiritual movement that influenced early AA. Bill W. expanded and formalized these into the Twelve Steps, making them more specific to alcoholism and accessible to a wider audience, including those without a traditional religious background.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-green-800">Late 1930s: Steps Evolve <i class="fa-solid fa-scroll ml-2 text-green-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The Twelve Steps are developed and formalized by Bill W., building on earlier spiritual principles.</p>
                                </div>
                            </div>
                
                            <!-- Event 12: 1938-1939 - Drafting of the Twelve Steps -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-teal-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-teal-400 pb-1 mb-2">Codifying the Program</h4>
                                        <p class="text-sm">Bill W., with input from Dr. Bob and early members, drafts the Twelve Steps, codifying the spiritual principles and actions necessary for recovery. These steps become the core program of AA.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-teal-800">1938-1939: Twelve Steps Drafted <i class="fa-solid fa-list-ol ml-2 text-teal-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The Twelve Steps are formally drafted, outlining the program of recovery for alcoholics.</p>
                                </div>
                            </div>
                
                            <!-- Event 13: April 1939 - Publication of "Alcoholics Anonymous" (First Edition) -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-cyan-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-cyan-400 pb-1 mb-2">Carrying the Message to the World</h4>
                                        <p class="text-sm">The foundational text, "Alcoholics Anonymous" (the Big Book), is published. It details the problem of alcoholism, the spiritual solution, and the Twelve Steps, making the program accessible to a wider audience.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-cyan-800">Apr 1939: Big Book (1st Ed.) <i class="fa-solid fa-book-open ml-2 text-cyan-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The book "Alcoholics Anonymous" is published, providing the definitive text for the fellowship's program of recovery.</p>
                                </div>
                            </div>
                
                            <!-- Event 14: Late 1930s - 1940s - Growth & Emergence of Traditions -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-yellow-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-yellow-400 pb-1 mb-2">Maintaining Unity</h4>
                                        <p class="text-sm">As AA grows rapidly, issues of group autonomy, money, and public relations arise. The Twelve Traditions emerge informally and are later codified to ensure the unity and survival of the fellowship.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-yellow-800">1930s-40s: Traditions Emerge <i class="fa-solid fa-users-line ml-2 text-yellow-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Rapid growth leads to the development of the Twelve Traditions, guiding AA's groups and preserving its unity.</p>
                                </div>
                            </div>
                
                            <!-- Event 15: Nov 16, 1950 - Dr. Bob's Passing -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-orange-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-orange-400 pb-1 mb-2">A Legacy of Service</h4>
                                        <p class="text-sm">Dr. Bob passes away in Akron, Ohio, having maintained continuous sobriety since June 10, 1935. His life of dedicated service, particularly in hospitals, leaves an enduring legacy as AA's co-founder.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-orange-800">Nov 16, 1950: Dr. Bob Passes <i class="fa-solid fa-cross ml-2 text-orange-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Dr. Bob, co-founder of AA, passes away, having achieved continuous sobriety and dedicated his life to helping others.</p>
                                </div>
                            </div>
                
                            <!-- Event 16: 1953 - Publication of "Twelve Steps and Twelve Traditions" -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-red-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-red-400 pb-1 mb-2">Deeper Understanding & Guidance</h4>
                                        <p class="text-sm">Written by Bill W., this book provides detailed interpretations and historical context for both the Twelve Steps and the Twelve Traditions. It was created to offer members a deeper understanding of the spiritual principles and the guidelines for group unity, helping AA mature as a fellowship.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-red-800">1953: 12 & 12 Published <i class="fa-solid fa-book-bookmark ml-2 text-red-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The "Twelve Steps and Twelve Traditions" book is published, offering deeper insights into the program and guiding principles.</p>
                                </div>
                            </div>
                
                            <!-- Event 17: 1955 - Publication of "Alcoholics Anonymous" (Second Edition) -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-indigo-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-indigo-400 pb-1 mb-2">Growth and Traditions</h4>
                                        <p class="text-sm">The second edition of the Big Book is published, reflecting AA's significant growth and including the formalized Twelve Traditions.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-indigo-800">1955: Big Book (2nd Ed.) <i class="fa-solid fa-book-reader ml-2 text-indigo-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The second edition of the Big Book is released, documenting AA's growth and formally including the Twelve Traditions.</p>
                                </div>
                            </div>
                
                            <!-- Event 18: 1950s - Development of Concepts for World Service -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-purple-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-purple-400 pb-1 mb-2">Guiding Global Service</h4>
                                        <p class="text-sm">Bill W. develops the Twelve Concepts for World Service to provide a framework for AA's growing global service structure, ensuring effective leadership and decision-making while maintaining group autonomy.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-purple-800">1950s: World Service Concepts <i class="fa-solid fa-globe ml-2 text-purple-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The Twelve Concepts for World Service are developed to guide AA's expanding global service structure.</p>
                                </div>
                            </div>
                
                            <!-- Event 19: 1971 - Bill W.'s Passing -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-green-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-green-400 pb-1 mb-2">A Founder's Legacy</h4>
                                        <p class="text-sm">Bill W. passes away in Miami Beach, Florida. His vision and dedication led to the founding of AA and its global spread, leaving an immeasurable legacy for millions in recovery.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-green-800">Jan 24, 1971: Bill W. Passes <i class="fa-solid fa-person-praying ml-2 text-green-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Bill W., co-founder of AA, passes away, leaving behind a global fellowship dedicated to sobriety.</p>
                                </div>
                            </div>
                
                            <!-- Event 20: 1976 - Publication of "Alcoholics Anonymous" (Third Edition) -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-teal-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-teal-400 pb-1 mb-2">Continued Expansion</h4>
                                        <p class="text-sm">The third edition of the Big Book is published, reflecting further growth in AA membership worldwide and reaffirming the unchanging core principles.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-teal-800">1976: Big Book (3rd Ed.) <i class="fa-solid fa-book-bookmark ml-2 text-teal-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The third edition of the Big Book is released, documenting AA's continued expansion.</p>
                                </div>
                            </div>
                
                            <!-- Event 21: 2001 - Publication of "Alcoholics Anonymous" (Fourth Edition) -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-cyan-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-cyan-400 pb-1 mb-2">Into the New Millennium</h4>
                                        <p class="text-sm">The fourth edition of the Big Book is published, highlighting AA's global reach into the new millennium and the enduring power of its message.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-cyan-800">2001: Big Book (4th Ed.) <i class="fa-solid fa-book-atlas ml-2 text-cyan-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The fourth edition of the Big Book is released, marking AA's presence worldwide at the turn of the millennium.</p>
                                </div>
                            </div>
                
                        </div>
                </div>
            </div>
            <div id="dfw-history" class="history-content">
                <h3 class="mb-4 font-bold text-xl">Dallas/Fort Worth AA History</h3>
                <!-- Dallas/Fort Worth timeline -->
                <div class="timeline-wrapper">
                <div class="timeline-container">
                
                            <!-- Event 1: 1940 - AA Comes to Houston -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-blue-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-blue-400 pb-1 mb-2">Texas Roots</h4>
                                        <p class="text-sm">The first documented AA group in Texas forms in Houston with Larry Jewell. This is significant as Esther E., a key figure in Dallas AA, sobered up here before moving to Dallas.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-blue-800">1940: AA in Houston <i class="fa-solid fa-map-pin ml-2 text-blue-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The first AA group in Texas is established in Houston.</p>
                                </div>
                            </div>
                
                            <!-- Event 2: June 14, 1941 - Ruth T.'s Letter (Dallas) -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-purple-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-purple-400 pb-1 mb-2">First Dallas Outreach</h4>
                                        <p class="text-sm">Ruth T., a Dallas alcoholic, sends the first recorded letter from Dallas to Ruth Hock, Bill W.'s secretary in New York, inquiring about AA activity in the area. This marks the initial plea for help from Dallas.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-purple-800">Jun 14, 1941: Ruth T.'s Plea <i class="fa-solid fa-envelope ml-2 text-purple-500"></i></h2>
                                    <p class="mt-2 text-slate-700">First recorded outreach from Dallas to AA General Service Office.</p>
                                </div>
                            </div>
                
                            <!-- Event 3: 1941 - First Fort Worth Group (Hazy History) -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-green-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-green-400 pb-1 mb-2">Fort Worth's Early Beginnings</h4>
                                        <p class="text-sm">George McL. is credited with starting the first AA group in Fort Worth. Early history is "hazy," but correspondence details an initial meeting with seven attendees.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-green-800">1941: Fort Worth's First Group <i class="fa-solid fa-users ml-2 text-green-500"></i></h2>
                                    <p class="mt-2 text-slate-700">George McL. is credited with starting the first AA group in Fort Worth.</p>
                                </div>
                            </div>
                
                            <!-- Event 4: Dec 1, 1941 - Kent W.'s Arrival (Dallas) -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-teal-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-teal-400 pb-1 mb-2">Energetic but Fleeting Efforts</h4>
                                        <p class="text-sm">Kent W., a sober AA member from Florida, moves to Dallas and eagerly begins promoting AA in local media, planning meetings, and even titled himself "Chief Sponsor" of Dallas AA.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-teal-800">Dec 1, 1941: Kent W. in Dallas <i class="fa-solid fa-bullhorn ml-2 text-teal-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Kent W. arrives in Dallas, eager to establish an AA group.</p>
                                </div>
                            </div>
                
                            <!-- Event 5: Jan 7, 1942 - First Recorded Dallas Meeting (Kent W.) -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-cyan-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-cyan-400 pb-1 mb-2">Initial Surge and Disappearance</h4>
                                        <p class="text-sm">Kent W. holds the first recorded AA meeting in Dallas at the White Plaza Hotel, attended by 12 people. A Dallas Morning News story sparks 72 inquiries. Despite his efforts, Kent W. is "never heard from again," highlighting the fragility of early group formation.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-cyan-800">Jan 7, 1942: 1st Dallas Meeting <i class="fa-solid fa-hotel ml-2 text-cyan-500"></i></h2>
                                    <p class="mt-2 text-slate-700">First recorded AA meeting in Dallas held by Kent W. at the White Plaza Hotel.</p>
                                </div>
                            </div>
                
                            <!-- Event 6: April 2, 1943 - Esther E. Starts "The Dallas Group" -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-yellow-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-yellow-400 pb-1 mb-2">AA Takes Root in Dallas</h4>
                                        <p class="text-sm">Esther E. (whose story "A Flower of the South" is in the Big Book), having sobered up in Houston, moves to Dallas and starts "The Dallas Group" in her home. Ruth T. attends this inaugural meeting.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-yellow-800">Apr 2, 1943: "The Dallas Group" <i class="fa-solid fa-house-chimney ml-2 text-yellow-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Esther E. starts "The Dallas Group" in her home, marking AA truly taking root in Dallas.</p>
                                </div>
                            </div>
                
                            <!-- Event 7: 1945 - Dallas AA First Permanent Home -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-orange-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-orange-400 pb-1 mb-2">Establishing a Presence</h4>
                                        <p class="text-sm">Dallas AA secures its first permanent home at 912 ½ Main Street in downtown. By year-end, fewer than 20 people in the city are sober, but numbers are growing by word-of-mouth.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-orange-800">1945: Dallas AA Home <i class="fa-solid fa-building ml-2 text-orange-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Dallas AA establishes its first permanent home downtown.</p>
                                </div>
                            </div>
                
                            <!-- Event 8: 1946 - Suburban Group Formed (Dallas) -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-red-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-red-400 pb-1 mb-2">Post-War Expansion</h4>
                                        <p class="text-sm">Following World War II, AA membership surges. Searcy W. forms a second group, the Suburban Group, which remains active in Dallas today.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-red-800">1946: Suburban Group <i class="fa-solid fa-people-group ml-2 text-red-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Searcy W. forms the Suburban Group in Dallas.</p>
                                </div>
                            </div>
                
                            <!-- Event 9: Sep 18, 1947 - Dallas Central Office Opens -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-indigo-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-indigo-400 pb-1 mb-2">Organizational Foresight</h4>
                                        <p class="text-sm">The Dallas Central Office holds its first Board meeting and officially opens on Akard Street. Dick P. serves as the first Office Manager, despite suffering physically from Jamaica Ginger Poisoning, demonstrating profound commitment.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-indigo-800">Sep 18, 1947: Dallas Central Office <i class="fa-solid fa-phone ml-2 text-indigo-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The Dallas Central Office officially opens for business.</p>
                                </div>
                            </div>
                
                            <!-- Event 10: 1960 - Esther E. Passes Away -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-purple-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-purple-400 pb-1 mb-2">A Pioneer's Legacy</h4>
                                        <p class="text-sm">Esther E. passes away with slightly more than 19 years of sobriety. Her personal copy of the Big Book, inscribed by Bill W., is displayed at the Dallas Intergroup Office, a tangible link to her foundational role.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-purple-800">1960: Esther E. Passes <i class="fa-solid fa-book-heart ml-2 text-purple-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Esther E., instrumental in establishing AA in Dallas, passes away.</p>
                                </div>
                            </div>
                
                            <!-- Event 11: 1968 - Dallas Intergroup Reorganizes -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-green-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-green-400 pb-1 mb-2">Maturation of Service</h4>
                                        <p class="text-sm">Dallas Intergroup reorganizes, and the Central Office begins operating more formally under the guidance of the then eight or nine AA groups. A member generously loans \$2,000 to stock AA literature.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-green-800">1968: Dallas Intergroup Reorg <i class="fa-solid fa-sitemap ml-2 text-green-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Dallas Intergroup reorganizes for more formal operations.</p>
                                </div>
                            </div>
                
                            <!-- Event 12: 1971 - Dallas Central Office Publishes Directory -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-teal-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-teal-400 pb-1 mb-2">Broadening Reach</h4>
                                        <p class="text-sm">The Dallas Central Office, then located in the Hudson & Hudson Building, publishes a comprehensive meeting directory that includes groups in jails, hospitals, and other facilities, reflecting the broadening reach of AA.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-teal-800">1971: Dallas Meeting Directory <i class="fa-solid fa-address-book ml-2 text-teal-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Dallas Central Office publishes a comprehensive meeting directory.</p>
                                </div>
                            </div>
                
                            <!-- Event 13: 1973 - Dallas Fellowship Grows to 30 Groups -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-cyan-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-cyan-400 pb-1 mb-2">Significant Growth</h4>
                                        <p class="text-sm">The Dallas fellowship experiences substantial growth, reaching 30 active groups, demonstrating the increasing demand for AA's message in the region.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-cyan-800">1973: 30 Dallas Groups <i class="fa-solid fa-chart-line ml-2 text-cyan-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The Dallas AA fellowship grows to 30 groups.</p>
                                </div>
                            </div>
                
                            <!-- Event 14: 1978 - Lambda Dallas Group Founded -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-yellow-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-yellow-400 pb-1 mb-2">Serving Diverse Communities</h4>
                                        <p class="text-sm">The Lambda Dallas Group is founded in Oak Lawn, Dallas' LGBTQ neighborhood. This group plays a vital role in carrying the AA message to thousands within this specific community, highlighting AA's adaptability.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-yellow-800">1978: Lambda Dallas Group <i class="fa-solid fa-rainbow ml-2 text-yellow-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The Lambda Dallas Group is founded, serving the LGBTQ community.</p>
                                </div>
                            </div>
                
                            <!-- Event 15: June 10, 1983 - The Glass House Group Founded (Fort Worth) -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-orange-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-orange-400 pb-1 mb-2">Fort Worth Milestone</h4>
                                        <p class="text-sm">The Glass House group is founded on the west side of Fort Worth by a few members emphasizing spirituality. Its first meeting on Houghton Street notably coincides with AA's 48th anniversary. The podium built by founder Don A. is still in use today.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-orange-800">Jun 10, 1983: Glass House (FW) <i class="fa-solid fa-house-crack ml-2 text-orange-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The Glass House group is founded in Fort Worth.</p>
                                </div>
                            </div>
                
                            <!-- Event 16: 1984 - The Glass House Moves to Hemsell Place -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-red-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-red-400 pb-1 mb-2">Rapid Growth & Incorporation</h4>
                                        <p class="text-sm">Within months, The Glass House outgrows its initial location, leading to the acquisition of its current facility at 6713 Hemsell Place. The move involves extensive volunteer effort, and the group is incorporated by Bryan H., Jim Williams, Kelly Y., and Massie T.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-red-800">1984: Glass House Relocates <i class="fa-solid fa-location-dot ml-2 text-red-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The Glass House group moves to its current Fort Worth facility.</p>
                                </div>
                            </div>
                
                            <!-- Event 17: 1989 - Dallas Intergroup Becomes DIA -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-indigo-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-indigo-400 pb-1 mb-2">Formalizing Structure</h4>
                                        <p class="text-sm">The Dallas Intergroup formalizes its structure by incorporating and becoming the Dallas Intergroup Association (DIA), a non-profit organization, reflecting its maturation as a service entity.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-indigo-800">1989: Dallas Intergroup (DIA) <i class="fa-solid fa-building-columns ml-2 text-indigo-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Dallas Intergroup incorporates as the Dallas Intergroup Association (DIA).</p>
                                </div>
                            </div>
                
                            <!-- Event 18: June 1993 - Bryan Honts (Glass House Founder) Passes -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-purple-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-purple-400 pb-1 mb-2">A Founder Remembered</h4>
                                        <p class="text-sm">Bryan Honts, a founder of The Glass House group in Fort Worth, passes away. His contributions were vital to the group's establishment and early growth.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-purple-800">Jun 1993: Bryan Honts Passes <i class="fa-solid fa-user-tie ml-2 text-purple-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Bryan Honts, a founder of The Glass House group, passes away.</p>
                                </div>
                            </div>
                
                            <!-- Event 19: Jan 1999 - Jim Williams (Glass House Founder) Passes -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-green-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-green-400 pb-1 mb-2">Speaker and Founder</h4>
                                        <p class="text-sm">Jim Williams, a founder of The Glass House group and a prolific AA speaker, passes away. His shares and service significantly impacted many members.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-green-800">Jan 1999: Jim Williams Passes <i class="fa-solid fa-microphone ml-2 text-green-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Jim Williams, a founder and speaker at The Glass House, passes away.</p>
                                </div>
                            </div>
                
                            <!-- Event 20: April 2000 - Dallas AA Central Office Reverts Name -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-teal-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-teal-400 pb-1 mb-2">Clarifying Identity</h4>
                                        <p class="text-sm">The Dallas Intergroup Association (DIA) reverts its name to the Dallas AA Central Office. This change was made to better describe its primary function to potential newcomers seeking help, emphasizing accessibility.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-teal-800">Apr 2000: Dallas Central Office <i class="fa-solid fa-retweet ml-2 text-teal-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Dallas Intergroup Association (DIA) reverts its name to Dallas AA Central Office.</p>
                                </div>
                            </div>
                
                            <!-- Event 21: 2002 - Dr. Rex Howard (Glass House Founder) Passes -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-cyan-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-cyan-400 pb-1 mb-2">Another Founder's Departure</h4>
                                        <p class="text-sm">Dr. Rex Howard, another founder of The Glass House group, passes away. His contributions were integral to the early spiritual emphasis of the group.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-cyan-800">2002: Dr. Rex Howard Passes <i class="fa-solid fa-user-md ml-2 text-cyan-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Dr. Rex Howard, a founder of The Glass House group, passes away.</p>
                                </div>
                            </div>
                
                            <!-- Event 22: 2003 - Searcy W. Passes (Dallas) -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-yellow-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-yellow-400 pb-1 mb-2">Dallas's Oldest Member</h4>
                                        <p class="text-sm">Searcy W., founder of Dallas's Suburban Group and then Dallas's oldest AA member, passes away with 57 years of sobriety, leaving a long legacy of recovery and service.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-yellow-800">2003: Searcy W. Passes <i class="fa-solid fa-star-of-life ml-2 text-yellow-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Searcy W., founder of the Suburban Group and Dallas's oldest AA member, passes away.</p>
                                </div>
                            </div>
                
                            <!-- Event 23: April 2009 - Kelly Young (Glass House Key Figure) Passes -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-orange-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-orange-400 pb-1 mb-2">Spiritual Leadership</h4>
                                        <p class="text-sm">Kelly Young, a key figure at The Glass House group who served as Chairman of its Board for 24 years, passes away after 27 years of active service, leaving a lasting legacy of spiritual leadership.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-orange-800">Apr 2009: Kelly Young Passes <i class="fa-solid fa-hand-holding-medical ml-2 text-orange-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Kelly Young, a key figure at The Glass House group, passes away.</p>
                                </div>
                            </div>
                
                            <!-- Event 24: Present - DFW AA Today -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-red-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-red-400 pb-1 mb-2">Continuing Service</h4>
                                        <p class="text-sm">The Dallas Central Office/DIA supports over 160 AA groups, hosting over 1500 meetings. The Fort Worth AA Central Office serves a wide multi-county area, and NETA 65 serves over 500 AA groups, demonstrating ongoing growth and vital service.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-red-800">Present: DFW AA Today <i class="fa-solid fa-city ml-2 text-red-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Dallas and Fort Worth AA continue to thrive, supporting thousands of members.</p>
                                </div>
                            </div>
                
                        </div>
                </div>
            </div>
            <div id="rowlett-history" class="history-content">
                <h3 class="mb-4 font-bold text-xl">Rowlett Group History</h3>
                <!-- Rowlett Group timeline -->
                <div class="timeline-wrapper">
                <div class="timeline-container">
                            <!-- 1995 -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-sky-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-sky-400 pb-1 mb-2">The Backstory</h4>
                                        <p class="text-sm">The Sunshine Group was struggling financially. Knowing the end was near, members gave notice to their landlord, promising to somehow pay two months of back rent. After it folded, a new vision was born.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-sky-800">1995: A Leap of Faith <i class="fa-solid fa-seedling ml-2 text-sky-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Eight former Sunshine Group members founded a new, non-smoking group. On July 22, the first meeting was held at 4501 Rowlett Road in a tiny 10.5' x 14' room.</p>
                                </div>
                            </div>
                
                            <!-- 1996 -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-teal-50">
                                     <div class="info-popup">
                                        <h4 class="font-bold border-b border-teal-400 pb-1 mb-2">Volunteer Spirit</h4>
                                        <p class="text-sm">Extensive remodeling and refinishing was mostly done by Group volunteers working nights and weekends, creating the group home for the next six years!</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-teal-800">1996: Building Our Home <i class="fa-solid fa-hammer ml-2 text-teal-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The 1st Anniversary BBQ was memorably rained out. That fall, the group room tripled in size, and the Open House featured speaker Searcy W., who held a fifty-year chip!</p>
                                </div>
                            </div>
                            
                            <!-- 1997-1998 -->
                            <div class="timeline-block left">
                                 <div class="timeline-content bg-teal-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-teal-400 pb-1 mb-2">Meeting Growth</h4>
                                        <p class="text-sm">Monthly AA birthday meetings were combined with Al-Anon. The total weekly meeting count grew rapidly: from none to 12 in 1997, then to 17 by the end of 1998.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-teal-800">1997-1998: More Meetings! <i class="fa-solid fa-users ml-2 text-teal-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The group expanded its schedule, adding monthly birthday meetings, multiple noon meetings, and 6 PM meetings to better serve the growing community.</p>
                                 </div>
                            </div>
                
                            <!-- 1999-2002 -->
                            <div class="timeline-block right">
                                 <div class="timeline-content bg-teal-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-teal-400 pb-1 mb-2">Key Events</h4>
                                        <ul class="text-sm list-disc list-inside space-y-1">
                                            <li><b>May 1999:</b> $500 approved to double Al-Anon space with volunteer labor.</li>
                                            <li><b>Feb 2002:</b> Sponsorship workshop featured a four-member panel with a moderator.</li>
                                             <li><b>Aug 2002:</b> 7th Anniversary had ~100 members and guests.</li>
                                        </ul>
                                    </div>
                                    <h2 class="text-2xl font-bold text-teal-800">1999-2002: Service & Structure <i class="fa-solid fa-book-open ml-2 text-teal-500"></i></h2>
                                    <p class="mt-2 text-slate-700">This era focused on service, with a 4th Anniversary party, a Sponsorship Workshop, and the formal designation of the Rowlett Group Bylaws.</p>
                                 </div>
                            </div>
                
                            <!-- 2003 -->
                            <div class="timeline-block left">
                                 <div class="timeline-content bg-amber-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-amber-400 pb-1 mb-2">The Big Move</h4>
                                        <p class="text-sm">Minimum requirements for a new space: affordable rent, 1,000 sq ft, kitchen, bathroom, and storage. The new Garland facility's 2nd birthday night celebrated 27 members representing over 140 years of sobriety.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-amber-800">2003: A Test of Unity <i class="fa-solid fa-truck-moving ml-2 text-amber-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Forced to move, the group relocated to Garland. In an amazing show of unity, 50-60 members moved everything in under an hour, ensuring no meetings were missed.</p>
                                 </div>
                            </div>
                
                            <!-- 2004-2007 -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-amber-50">
                                     <div class="info-popup">
                                        <h4 class="font-bold border-b border-amber-400 pb-1 mb-2">Lease & Name</h4>
                                        <p class="text-sm">In 2006, the lease was extended, with the Rowlett Group becoming the official signatory. In June 2007, the group reconsidered a name change but elected to keep the Rowlett Group name despite being in Garland.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-amber-800">2004-2007: Settling In <i class="fa-solid fa-anchor ml-2 text-amber-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The group held its 2nd inventory, created job descriptions, and hosted workshops. The 12th Anniversary theme was "Imagine Life Without Faith."</p>
                                </div>
                            </div>
                
                             <!-- 2008-2009 -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-amber-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-amber-400 pb-1 mb-2">Fellowship!</h4>
                                        <p class="text-sm">Members insisted on enjoying life: Friday Night Candlelight Meetings followed by Denny's, Starbucks after the Saturday 8 PM meeting with guitars and sing-alongs, July 4th at the lake, and Sober Celebrations with live music by Turning Point.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-amber-800">2008-2009: Thriving! <i class="fa-solid fa-star ml-2 text-amber-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The Chaha/Bass Pro location boomed. Birthday nights were Standing Room Only, and the "Luau" themed 14th Anniversary party was a huge success.</p>
                                </div>
                            </div>
                
                            <!-- 2010-2014 -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-amber-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-amber-400 pb-1 mb-2">A New Home</h4>
                                        <p class="text-sm">In July 2010, 48 members attended a Group Conscience to approve the move "Behind Denny's." Work commenced, and the group held an Open House in lieu of an anniversary party after moving on Oct 30.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-amber-800">2010-2014: Service & A New Move <i class="fa-solid fa-briefcase ml-2 text-amber-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Members carried the message to correctional facilities, providing Big Books. The group hosted workshops and remained active in District/Area service.</p>
                                </div>
                            </div>
                
                            <!-- 2015 -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-red-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-red-400 pb-1 mb-2">A Fateful Year</h4>
                                        <p class="text-sm">The decision to find a new home was made at Denny's in June. The lease at 362 Oaks Trail commenced on August 15. The tornado hit on December 26, minutes after attendees had traveled past the heavily damaged I-30/190 interchange.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-red-800">2015: Resilience & Rebirth <i class="fa-solid fa-heart-pulse ml-2 text-red-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Facing decline, four members decided to stick together, finding a new home at Oaks Trail. The year ended with a tornado narrowly missing the group's birthday night.</p>
                                </div>
                            </div>
                
                            <!-- 2016-2019 -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-indigo-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-indigo-400 pb-1 mb-2">Holding Fast</h4>
                                        <p class="text-sm">Though many AAs came and went, the central core of the group held fast. In 2019, the group signed another three-year lease, bringing the total years at Oaks Trail to seven. Overhead remained low and reserves prudent.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-indigo-800">2016-2019: A New Home <i class="fa-solid fa-house-chimney-heart ml-2 text-indigo-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Slow, steady growth continued. A fresh crop of dedicated AAs took hold, and newcomers were getting and staying sober by way of the twelve steps.</p>
                                </div>
                            </div>
                            
                             <!-- 2020 -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-indigo-50">
                                     <div class="info-popup">
                                        <h4 class="font-bold border-b border-indigo-400 pb-1 mb-2">Digital Fellowship</h4>
                                        <p class="text-sm">To keep members informed during the pandemic lockdown, the "Rowlett Friends of Bill" private Facebook page was created in April.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-indigo-800">2020: The Pandemic Pivot <i class="fa-solid fa-laptop ml-2 text-indigo-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The COVID-19 pandemic led to our first Zoom meeting on April 1. In-person meetings resumed in May, and in June, Tuesday night became a dedicated Newcomer meeting.</p>
                                </div>
                            </div>
                
                            <!-- 2021-Present -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-green-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-green-400 pb-1 mb-2">Anniversary Update</h4>
                                        <p class="text-sm">The 26th Anniversary Party was planned for August 2021, but once again COVID reared its ugly head, forcing the anniversary to be postponed until February 2022.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-green-800">2021-Present: Re-Energized! <i class="fa-solid fa-champagne-glasses ml-2 text-green-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Group unity is stronger than ever. Fellowship dinners are popular, and outdoor Birthday Nights are celebrated with enthusiasm by friends and family.</p>
                                </div>
                            </div>
                
                        </div>
                </div>
            </div>
        </section>

        <!-- Settings Section -->
        <section id="settings-section">
            <h2>Settings & Data Management</h2>
            <div class="box mb-4">
                <h3>Export Data</h3>
                <p class="mb-2">Download your data as a JSON file for backup.</p>
                <button class="btn" onclick="exportData('all')">Export All Data</button>
                <button class="btn secondary" onclick="exportData('events')">Export Events Only</button>
                <button class="btn secondary" onclick="exportData('birthdays')">Export Birthdays Only</button>
                <button class="btn secondary" onclick="exportData('chairpersonLog')">Export Chairperson Log Only</button>
            </div>
            <div class="box">
                <h3>Import Data</h3>
                <p class="mb-2">Import data from a previously exported JSON file. <strong>Warning:</strong> This will overwrite existing data of the same type.</p>
                <input type="file" id="import-file" accept=".json">
                <button class="btn" onclick="importData()">Import Data</button>
            </div>
        </section>
    </main>

    <!-- Member Roster Modal -->
    <div id="roster-modal" class="modal">
        <div class="box" style="width: 90%; max-width: 1200px; max-height: 90vh; overflow-y: auto; background: #2c3e50; color: #ecf0f1; border: 1px solid #3498db;">
            <span class="modal-close" onclick="closeRosterModal()">&times;</span>
            <h2 style="color: #3498db;">Full Member Roster</h2>
            <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                <input type="text" id="roster-search" onkeyup="renderRosterTable()" placeholder="Search by name, email, phone..." style="flex-grow: 1;" />
                <button class="btn" onclick="openMemberFormFromModal()">Add New Member</button>
            </div>
            <div style="overflow-x: auto;">
                <table id="roster-table">
                    <thead>
                        <tr>
                            <th onclick="sortRosterBy('name')" style="cursor: pointer;">Name &#x2195;</th>
                            <th onclick="sortRosterBy('city')" style="cursor: pointer;">City &#x2195;</th>
                            <th onclick="sortRosterBy('homegroup')" style="cursor: pointer;">Homegroup &#x2195;</th>
                            <th>Phone</th>
                            <th>Email</th>
                            <th onclick="sortRosterBy('isServant')" style="cursor: pointer;">Servant? &#x2195;</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="roster-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Embed the application script directly into this file -->
    <script>
// Utility to generate unique IDs based on timestamp
function genId() {
    return Date.now().toString() + Math.random().toString(36).substring(2);
}
// Navigate to a given section and update nav active states
function goToSection(sectionId) {
    document.querySelectorAll('main section').forEach(sec => sec.classList.remove('active'));
    document.querySelectorAll('nav li').forEach(li => li.classList.remove('active'));
    const section = document.getElementById(sectionId);
    if (section) section.classList.add('active');
    const navItem = document.querySelector('nav li[data-section="' + sectionId + '"]');
    if (navItem) navItem.classList.add('active');

    // If navigating to the schedule, render the calendar
    if (sectionId === 'schedule-section') {
        renderCalendar();
    }
}
// Toggle form visibility
function toggleEventForm() {
    const form = document.getElementById('add-event-form');
    const isVisible = form.style.display === 'block';
    form.style.display = isVisible ? 'none' : 'block';
}

function toggleMemberForm() {
    const form = document.getElementById('add-member-form');
    const isVisible = form.style.display === 'block';
    form.style.display = isVisible ? 'none' : 'block';
}
// Toast Notification
function showToast(message, type = 'info') { // type can be 'info', 'success', or 'error'
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    container.appendChild(toast);

    // Animate in
    setTimeout(() => {
        toast.classList.add('show');
    }, 100);

    // Animate out and remove
    setTimeout(() => {
        toast.classList.remove('show');
        toast.addEventListener('transitionend', () => {
            toast.remove();
        });
    }, 3000); // Toast disappears after 3 seconds
}
// Storage wrappers using localStorage
const storage = {
    getEvents() { return JSON.parse(localStorage.getItem('events') || '[]'); },
    saveEvents(events) { localStorage.setItem('events', JSON.stringify(events)); },
    getMembers() { return JSON.parse(localStorage.getItem('members') || '[]'); },
    saveMembers(m) { localStorage.setItem('members', JSON.stringify(m)); },
    getAnnouncements() { return JSON.parse(localStorage.getItem('announcements') || '[]'); },
    saveAnnouncements(a) { localStorage.setItem('announcements', JSON.stringify(a)); },
    getPhotos() { return JSON.parse(localStorage.getItem('photos') || '[]'); },
    savePhotos(p) { localStorage.setItem('photos', JSON.stringify(p)); },
    getChairpersonLog() { return JSON.parse(localStorage.getItem('chairpersonLog') || '[]'); },
    saveChairpersonLog(log) { localStorage.setItem('chairpersonLog', JSON.stringify(log)); },
    getGroupConscienceLog() { return JSON.parse(localStorage.getItem('groupConscienceLog') || '[]'); },
    saveGroupConscienceLog(log) { localStorage.setItem('groupConscienceLog', JSON.stringify(log)); }
};
// Initialize default data on first load
function initDefaults() {
    // Migration from 'birthdays' to 'members' for backward compatibility
    if (localStorage.getItem('birthdays') && !localStorage.getItem('members')) {
        const oldBirthdays = JSON.parse(localStorage.getItem('birthdays') || '[]');
        const newMembers = oldBirthdays.map(b => ({
            id: b.id,
            name: b.name,
            birthday: b.birthday,
            phone: '',
            email: '',
            homegroup: '',
            sponsor: '',
            city: '',
            isServant: false,
            servantPosition: '',
            servantSince: ''
        }));
        storage.saveMembers(newMembers);
        localStorage.removeItem('birthdays'); // Clean up old data
    }

    if (!localStorage.getItem('events')) {
        const defaults = [
            { id: genId(), title: 'Open Discussion', dayOfWeek: 0, time: '19:00', reading: 'How It Works', speaker: '', chair: '', description: 'Weekly open discussion meeting' },
            { id: genId(), title: 'Big Book Study', dayOfWeek: 2, time: '19:00', reading: 'Big Book', speaker: '', chair: '', description: 'Weekly big book study' },
            { id: genId(), title: 'Speaker Meeting', dayOfWeek: 5, time: '19:00', reading: 'Speaker’s Choice', speaker: 'Guest Speaker', chair: '', description: 'Weekly speaker meeting' }
        ];
        storage.saveEvents(defaults);
    }
    if (!localStorage.getItem('members')) {
        const members = [
            { id: genId(), name: 'Alice', birthday: '1990-09-10', phone: '123-456-7890', email: 'alice@example.com', homegroup: 'Rowlett Group', sponsor: 'Bob', city: 'Rowlett', isServant: true, servantPosition: 'Treasurer', servantSince: '2022-01-01' },
            { id: genId(), name: 'Bob', birthday: '1985-12-05', phone: '', email: '', homegroup: 'Rowlett Group', sponsor: '', city: 'Garland', isServant: false, servantPosition: '', servantSince: '' },
            { id: genId(), name: 'Charlie', birthday: '1993-04-22', phone: '', email: '', homegroup: '', sponsor: '', city: 'Dallas', isServant: false, servantPosition: '', servantSince: '' }
        ];
        storage.saveMembers(members);
    }
    if (!localStorage.getItem('announcements')) {
        storage.saveAnnouncements([]);
    }
    if (!localStorage.getItem('photos')) {
        // We will now store photos as objects with src and tags
        storage.savePhotos([]);
    } else {
        // Backwards compatibility: convert old string array to new object array
        const photos = storage.getPhotos();
        if (photos.length > 0 && typeof photos[0] === 'string') {
            const newPhotos = photos.map(p => ({ src: p, tags: [] }));
            storage.savePhotos(newPhotos);
        }
    }
    if (!localStorage.getItem('chairpersonLog')) {
        storage.saveChairpersonLog([]);
    }
    if (!localStorage.getItem('groupConscienceLog')) {
        storage.saveGroupConscienceLog([]);
    }
}
function handleEventSubmit() {
    const editId = document.getElementById('event-edit-id').value;
    if (editId) {
        updateEvent();
    } else {
        addEvent();
    }
}

function editEvent(id) {
    const events = storage.getEvents();
    const eventToEdit = events.find(ev => ev.id === id);
    if (!eventToEdit) {
        console.error('Event not found for editing');
        return;
    }

    // Show the form
    const form = document.getElementById('add-event-form');
    if (form.style.display === 'none') {
        form.style.display = 'block';
    }

    document.getElementById('event-edit-id').value = eventToEdit.id;
    document.getElementById('event-title').value = eventToEdit.title;
    document.getElementById('event-date').value = eventToEdit.date || '';
    document.getElementById('event-day').value = eventToEdit.dayOfWeek !== null ? eventToEdit.dayOfWeek : '';
    document.getElementById('event-time').value = eventToEdit.time;
    document.getElementById('event-category').value = eventToEdit.category || 'General';
    document.getElementById('event-reading').value = eventToEdit.reading || '';
    document.getElementById('event-speaker').value = eventToEdit.speaker || '';
    document.getElementById('event-chair').value = eventToEdit.chair || '';
    document.getElementById('event-description').value = eventToEdit.description || '';

    document.getElementById('event-form-btn').textContent = 'Save Changes';
    document.getElementById('event-form-cancel-btn').style.display = 'inline-block';

    // Scroll to form for better UX
    document.getElementById('schedule-section').scrollIntoView({ behavior: 'smooth' });
}

function cancelEventEdit() {
    document.getElementById('event-edit-id').value = '';
    document.getElementById('event-title').value = '';
    document.getElementById('event-date').value = '';
    document.getElementById('event-day').value = '';
    document.getElementById('event-time').value = '';
    document.getElementById('event-category').value = 'General';
    document.getElementById('event-reading').value = '';
    document.getElementById('event-speaker').value = '';
    document.getElementById('event-chair').value = '';
    document.getElementById('event-description').value = '';

    document.getElementById('event-form-btn').textContent = 'Add Event';
    document.getElementById('event-form-cancel-btn').style.display = 'none';
}

function updateEvent() {
    const id = document.getElementById('event-edit-id').value;
    if (!id) return;

    const title = document.getElementById('event-title').value.trim();
    const dateVal = document.getElementById('event-date').value;
    const dayVal = document.getElementById('event-day').value;
    const time = document.getElementById('event-time').value;
    const category = document.getElementById('event-category').value;
    const reading = document.getElementById('event-reading').value.trim();
    const speaker = document.getElementById('event-speaker').value.trim();
    const chair = document.getElementById('event-chair').value.trim();
    const description = document.getElementById('event-description').value.trim();

    if (!title || !time || (!dateVal && dayVal === '')) {
        showToast('Please provide at least a title, time, and either a date or day of week.', 'error');
        return;
    }

    let events = storage.getEvents();
    const eventIndex = events.findIndex(ev => ev.id === id);

    if (eventIndex > -1) {
        events[eventIndex] = {
            id,
            title,
            date: dateVal || null,
            dayOfWeek: dateVal ? null : parseInt(dayVal, 10),
            time,
            category,
            reading,
            speaker,
            chair,
            description
        };
        storage.saveEvents(events);
        showToast('Event updated successfully!', 'success');
    }

    cancelEventEdit(); // Resets form and buttons
    updateEventsTable();
    updateHome();
    renderCalendar();
}

// Add an event
function addEvent() {
    const title = document.getElementById('event-title').value.trim();
    const dateVal = document.getElementById('event-date').value;
    const dayVal = document.getElementById('event-day').value;
    const time = document.getElementById('event-time').value;
    const category = document.getElementById('event-category').value;
    const reading = document.getElementById('event-reading').value.trim();
    const speaker = document.getElementById('event-speaker').value.trim();
    const chair = document.getElementById('event-chair').value.trim();
    const description = document.getElementById('event-description').value.trim();
    if (!title || !time || (!dateVal && dayVal === '')) {
        showToast('Please provide at least a title, time, and either a date or day of week.', 'error');
        return;
    }
    const events = storage.getEvents();
    events.push({
        id: genId(),
        title,
        date: dateVal || null,
        dayOfWeek: dateVal ? null : parseInt(dayVal, 10),
        time,
        category,
        reading,
        speaker,
        chair,
        description
    });
    storage.saveEvents(events);
    showToast('Event added successfully!', 'success');
    document.getElementById('event-title').value = '';
    document.getElementById('event-date').value = '';
    document.getElementById('event-day').value = '';
    document.getElementById('event-time').value = '';
    document.getElementById('event-reading').value = '';
    document.getElementById('event-speaker').value = '';
    document.getElementById('event-chair').value = '';
    document.getElementById('event-description').value = '';
    updateEventsTable();
    updateHome();
    renderCalendar();
}
// Delete an event by id
function deleteEvent(id) {
    if (!confirm('Delete this event?')) return;
    let events = storage.getEvents();
    events = events.filter(ev => ev.id !== id);
    storage.saveEvents(events);
    showToast('Event deleted.', 'info');
    updateEventsTable();
    updateHome();
    renderCalendar();
}
// Compute upcoming occurrences within next X days
function computeUpcomingOccurrences(daysAhead = 30) {
    const events = storage.getEvents();
    const now = new Date();
    const end = new Date();
    end.setDate(end.getDate() + daysAhead);
    let occurrences = [];
    events.forEach(ev => {
        if (ev.date) {
            const eventDate = new Date(ev.date + 'T' + (ev.time || '00:00'));
            if (eventDate >= now && eventDate <= end) occurrences.push({ occurDate: eventDate, event: ev });
        } else if (ev.dayOfWeek !== null && ev.dayOfWeek !== undefined) {
            for (let d = 0; d <= daysAhead; d++) {
                const date = new Date(now);
                date.setHours(0, 0, 0, 0);
                date.setDate(date.getDate() + d);
                if (date.getDay() === ev.dayOfWeek) {
                    const [hours, minutes] = (ev.time || '00:00').split(':');
                    date.setHours(parseInt(hours, 10), parseInt(minutes, 10), 0, 0);
                    if (date >= now && date <= end) occurrences.push({ occurDate: new Date(date), event: ev });
                }
            }
        }
    });
    occurrences.sort((a, b) => a.occurDate - b.occurDate);
    return occurrences;
}
// Update events table
function updateEventsTable() {
    const tbody = document.getElementById('events-body');
    const categoryFilter = document.getElementById('category-filter').value;
    tbody.innerHTML = '';
    let occ = computeUpcomingOccurrences(60);

    if (categoryFilter !== 'All') {
        occ = occ.filter(item => (item.event.category || 'General') === categoryFilter);
    }

    occ.forEach(item => {
        const tr = document.createElement('tr');
        const dateStr = item.occurDate.toLocaleDateString();
        const timeStr = item.occurDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        tr.innerHTML = `<td>${dateStr}</td><td>${item.event.title}</td><td>${item.event.category || 'General'}</td><td>${timeStr}</td><td>${item.event.speaker || ''}</td><td>${item.event.chair || ''}</td><td><button class="btn" onclick="editEvent('${item.event.id}')" style="margin-right: 5px;">Edit</button><button class="btn secondary" onclick="deleteEvent('${item.event.id}')">Delete</button></td>`;
        tbody.appendChild(tr);
    });
    if (occ.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="7">No upcoming events match the filter.</td>';
        tbody.appendChild(tr);
    }
}
function handleMemberSubmit() {
    const editId = document.getElementById('member-edit-id').value;
    if (editId) {
        updateMember();
    } else {
        addMember();
    }
}

function editMember(id) {
    const members = storage.getMembers();
    const memberToEdit = members.find(m => m.id === id);
    if (!memberToEdit) {
        console.error('Member not found for editing');
        return;
    }

    // Show the form
    const form = document.getElementById('add-member-form');
    if (form.style.display === 'none') {
        form.style.display = 'block';
    }

    document.getElementById('member-edit-id').value = memberToEdit.id;
    document.getElementById('member-name').value = memberToEdit.name;
    document.getElementById('member-birthday').value = memberToEdit.birthday;
    document.getElementById('member-phone').value = memberToEdit.phone || '';
    document.getElementById('member-email').value = memberToEdit.email || '';
    document.getElementById('member-homegroup').value = memberToEdit.homegroup || '';
    document.getElementById('member-sponsor').value = memberToEdit.sponsor || '';
    document.getElementById('member-city').value = memberToEdit.city || '';
    document.getElementById('member-is-servant').checked = memberToEdit.isServant || false;
    document.getElementById('member-servant-position').value = memberToEdit.servantPosition || '';
    document.getElementById('member-servant-since').value = memberToEdit.servantSince || '';

    document.getElementById('member-form-btn').textContent = 'Save Changes';
    document.getElementById('member-form-cancel-btn').style.display = 'inline-block';

    document.getElementById('birthdays-section').scrollIntoView({ behavior: 'smooth' });
}

function cancelMemberEdit() {
    document.getElementById('member-edit-id').value = '';
    document.getElementById('member-name').value = '';
    document.getElementById('member-birthday').value = '';
    document.getElementById('member-phone').value = '';
    document.getElementById('member-email').value = '';
    document.getElementById('member-homegroup').value = '';
    document.getElementById('member-sponsor').value = '';
    document.getElementById('member-city').value = '';
    document.getElementById('member-is-servant').checked = false;
    document.getElementById('member-servant-position').value = '';
    document.getElementById('member-servant-since').value = '';


    document.getElementById('member-form-btn').textContent = 'Add Member';
    document.getElementById('member-form-cancel-btn').style.display = 'none';
}

function updateMember() {
    const id = document.getElementById('member-edit-id').value;
    if (!id) return;

    const name = document.getElementById('member-name').value.trim();
    const bdate = document.getElementById('member-birthday').value;

    if (!name || !bdate) {
        showToast('Please provide both name and sobriety date.', 'error');
        return;
    }

    let members = storage.getMembers();
    const memberIndex = members.findIndex(m => m.id === id);

    if (memberIndex > -1) {
        members[memberIndex] = {
            id,
            name,
            birthday: bdate,
            phone: document.getElementById('member-phone').value.trim(),
            email: document.getElementById('member-email').value.trim(),
            homegroup: document.getElementById('member-homegroup').value.trim(),
            sponsor: document.getElementById('member-sponsor').value.trim(),
            city: document.getElementById('member-city').value.trim(),
            isServant: document.getElementById('member-is-servant').checked,
            servantPosition: document.getElementById('member-servant-position').value.trim(),
            servantSince: document.getElementById('member-servant-since').value
        };
        storage.saveMembers(members);
        showToast('Member updated successfully!', 'success');
    }

    cancelMemberEdit(); // Resets form and buttons
    updateBirthdaysTable();
    updateHome();
    populateAttendeeDropdown();
    populateMemberDropdowns();
}

// Add member
function addMember() {
    const name = document.getElementById('member-name').value.trim();
    const bdate = document.getElementById('member-birthday').value;
    if (!name || !bdate) {
        showToast('Please provide both name and sobriety date.', 'error');
        return;
    }
    const members = storage.getMembers();
    members.push({
        id: genId(),
        name,
        birthday: bdate,
        phone: document.getElementById('member-phone').value.trim(),
        email: document.getElementById('member-email').value.trim(),
        homegroup: document.getElementById('member-homegroup').value.trim(),
        sponsor: document.getElementById('member-sponsor').value.trim(),
        city: document.getElementById('member-city').value.trim(),
        isServant: document.getElementById('member-is-servant').checked,
        servantPosition: document.getElementById('member-servant-position').value.trim(),
        servantSince: document.getElementById('member-servant-since').value
    });
    storage.saveMembers(members);
    showToast('Member added successfully!', 'success');
    cancelMemberEdit();
    updateBirthdaysTable();
    updateHome();
    populateAttendeeDropdown();
    populateMemberDropdowns();
}
// Delete member
function deleteMember(id) {
    if (!confirm('Delete this member?')) return;
    let members = storage.getMembers();
    members = members.filter(m => m.id !== id);
    storage.saveMembers(members);
    showToast('Member deleted.', 'info');
    updateBirthdaysTable();
    updateHome();
    populateAttendeeDropdown();
    populateMemberDropdowns();
}

// Helper to find all anniversaries within a given date window
function getAnniversariesInWindow(members, pastDays, futureDays) {
    const now = new Date();
    now.setHours(0,0,0,0);

    const lowerBound = new Date(now);
    lowerBound.setDate(lowerBound.getDate() - pastDays);

    const upperBound = new Date(now);
    upperBound.setDate(upperBound.getDate() + futureDays);

    const relevantMembers = [];

    members.forEach(member => {
        if (!member.birthday) return; // Skip members with no birthday
        const [origYear, month, day] = member.birthday.split('-').map(Number);

        // Check anniversary for the current year
        const thisYearAnniversary = new Date(now.getFullYear(), month - 1, day);
        if (thisYearAnniversary >= lowerBound && thisYearAnniversary <= upperBound) {
            relevantMembers.push({ ...member, displayDate: thisYearAnniversary });
            return; // Move to next member, avoid duplicates
        }

        // Check anniversary for last year (for pastDays window)
        if (now.getFullYear() > origYear) {
             const lastYearAnniversary = new Date(now.getFullYear() - 1, month - 1, day);
             if (lastYearAnniversary >= lowerBound && lastYearAnniversary <= upperBound) {
                relevantMembers.push({ ...member, displayDate: lastYearAnniversary });
                return;
             }
        }

        // Check anniversary for next year (for futureDays window)
        const nextYearAnniversary = new Date(now.getFullYear() + 1, month - 1, day);
        if (nextYearAnniversary >= lowerBound && nextYearAnniversary <= upperBound) {
            relevantMembers.push({ ...member, displayDate: nextYearAnniversary });
        }
    });

    return relevantMembers.sort((a, b) => a.displayDate - b.displayDate);
}

// Compute next birthday date relative to now
function nextBirthdayDate(bdayStr) {
    const now = new Date();
    const [year, month, day] = bdayStr.split('-').map(Number);
    let nextDate = new Date(now.getFullYear(), month - 1, day);
    if (nextDate < now.setHours(0, 0, 0, 0)) {
        nextDate = new Date(now.getFullYear() + 1, month - 1, day);
    }
    return nextDate;
}
// Update birthdays table
function updateBirthdaysTable() {
    const tbody = document.getElementById('birthdays-body');
    tbody.innerHTML = '';
    const members = storage.getMembers();
    const membersInWindow = getAnniversariesInWindow(members, 15, 60);

    const now = new Date();
    now.setHours(0,0,0,0);

    membersInWindow.forEach(m => {
        const tr = document.createElement('tr');

        // Highlight past birthdays in a muted yellow/gold color
        if (m.displayDate < now) {
            tr.style.backgroundColor = '#6b5d2f';
        }

        const displayDateStr = m.displayDate.toLocaleDateString();
        const origDate = new Date(m.birthday);
        const md = origDate.toLocaleDateString(undefined, { month: 'long', day: 'numeric', year: 'numeric' });

        // Calculate years of sobriety based on the anniversary date
        const years = m.displayDate.getFullYear() - origDate.getFullYear();

        tr.innerHTML = `
            <td>${m.name}</td>
            <td>${md}</td>
            <td>${displayDateStr}</td>
            <td>${years}</td>
            <td>
                <button class="btn" onclick="editMember('${m.id}')" style="margin-right: 5px;">Edit</button>
                <button class="btn secondary" onclick="deleteMember('${m.id}')">Delete</button>
            </td>`;
        tbody.appendChild(tr);
    });
    if (membersInWindow.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="5">No recent or upcoming birthdays in the next 60 days.</td>';
        tbody.appendChild(tr);
    }
}
// Add announcement
function addAnnouncement() {
    const text = document.getElementById('announcement-text').value.trim();
    if (!text) {
        showToast('Enter an announcement.', 'error');
        return;
    }
    const ann = storage.getAnnouncements();
    ann.unshift({ id: genId(), text, dateCreated: new Date().toISOString(), active: true });
    storage.saveAnnouncements(ann);
    showToast('Announcement added!', 'success');
    document.getElementById('announcement-text').value = '';
    updateAnnouncementsList();
    updateHome();
    updateChairpersonAnnouncements();
}
// Delete announcement
function deleteAnnouncement(id) {
    if (!confirm('Delete this announcement?')) return;
    let ann = storage.getAnnouncements();
    ann = ann.filter(a => a.id !== id);
    storage.saveAnnouncements(ann);
    showToast('Announcement deleted.', 'info');
    updateAnnouncementsList();
    updateHome();
    updateChairpersonAnnouncements();
}
// Toggle announcement active state
function toggleAnnouncementActive(id) {
    let ann = storage.getAnnouncements();
    const index = ann.findIndex(a => a.id === id);
    if (index > -1) {
        ann[index].active = !ann[index].active;
        storage.saveAnnouncements(ann);
        updateAnnouncementsList();
        updateHome();
        updateChairpersonAnnouncements();
    }
}

// Update announcements list
function updateAnnouncementsList() {
    const ul = document.getElementById('announcements-list');
    ul.innerHTML = '';
    const ann = storage.getAnnouncements();
    ann.forEach(a => {
        const li = document.createElement('li');
        li.style.display = 'flex';
        li.style.alignItems = 'center';
        li.style.marginBottom = '0.5rem';
        if (!a.active) {
            li.style.opacity = '0.5';
        }

        const dateStr = new Date(a.dateCreated).toLocaleDateString();

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = a.active;
        checkbox.style.marginRight = '1rem';
        checkbox.onchange = () => toggleAnnouncementActive(a.id);

        const text = document.createElement('span');
        text.innerHTML = `<strong>${dateStr}:</strong> ${a.text}`;
        text.style.flexGrow = '1';

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn secondary';
        deleteBtn.textContent = 'Delete';
        deleteBtn.onclick = () => deleteAnnouncement(a.id);

        li.appendChild(checkbox);
        li.appendChild(text);
        li.appendChild(deleteBtn);
        ul.appendChild(li);
    });
    if (ann.length === 0) {
        ul.innerHTML = '<li>No announcements posted</li>';
    }
}

function updateChairpersonAnnouncements() {
    const ul = document.getElementById('chairperson-announcements-list');
    if (!ul) return;
    ul.innerHTML = '';
    const activeAnnouncements = storage.getAnnouncements().filter(a => a.active);
    activeAnnouncements.forEach(a => {
        const li = document.createElement('li');
        const dateStr = new Date(a.dateCreated).toLocaleDateString();
        li.innerHTML = `<strong>${dateStr}:</strong> ${a.text}`;
        ul.appendChild(li);
    });
    if (activeAnnouncements.length === 0) {
        ul.innerHTML = '<li>No active announcements</li>';
    }
}
// Modal functions
let currentPhotoIndex = 0;
let currentPhotoList = [];

function updateModalContent() {
    const photo = currentPhotoList[currentPhotoIndex];
    if (!photo) { closeModal(); return; }

    const modalImg = document.getElementById('modal-image');
    const caption = document.getElementById('modal-caption');

    modalImg.src = photo.src;
    caption.textContent = photo.tags && photo.tags.length > 0 ? `Tags: ${photo.tags.join(', ')}` : '';
}

function showNextPhoto() {
    if (currentPhotoList.length === 0) return;
    currentPhotoIndex = (currentPhotoIndex + 1) % currentPhotoList.length;
    updateModalContent();
}

function showPreviousPhoto() {
    if (currentPhotoList.length === 0) return;
    currentPhotoIndex = (currentPhotoIndex - 1 + currentPhotoList.length) % currentPhotoList.length;
    updateModalContent();
}

function handleModalKeys(event) {
    if (event.key === 'Escape') {
        closeModal();
    } else if (event.key === 'ArrowRight') {
        showNextPhoto();
    } else if (event.key === 'ArrowLeft') {
        showPreviousPhoto();
    }
}

function openModal(index, photos) {
    currentPhotoList = photos;
    currentPhotoIndex = index;

    if (currentPhotoList.length === 0) return;

    const modal = document.getElementById('photo-modal');
    modal.style.display = "flex";

    updateModalContent();

    document.addEventListener('keydown', handleModalKeys);
}

function closeModal() {
    const modal = document.getElementById('photo-modal');
    modal.style.display = "none";
    document.removeEventListener('keydown', handleModalKeys);
}
// Photo uploading
function uploadPhotos() {
    const input = document.getElementById('photo-upload');
    const tagsInput = document.getElementById('photo-tags');
    const files = Array.from(input.files);
    if (!files || files.length === 0) {
        showToast('Select one or more images to upload.', 'error');
        return;
    }
    const tags = tagsInput.value.split(',').map(tag => tag.trim()).filter(tag => tag);
    const photos = storage.getPhotos();
    let remaining = files.length;
    files.forEach(file => {
        const reader = new FileReader();
        reader.onload = function (e) {
            photos.push({ src: e.target.result, tags: tags });
            remaining--;
            if (remaining === 0) {
                storage.savePhotos(photos);
                showToast(`${files.length} photo(s) uploaded!`, 'success');
                input.value = '';
                tagsInput.value = '';
                updateGallery();
                updateHome();
            }
        };
        reader.readAsDataURL(file);
    });
}
// Delete photo by index
function deletePhoto(index) {
    if (!confirm('Delete this photo?')) return;
    const photos = storage.getPhotos();
    photos.splice(index, 1);
    storage.savePhotos(photos);
    showToast('Photo deleted.', 'info');
    updateGallery();
    updateHome();
}

// Chairperson's Corner functions
function handleChairpersonLogSubmit() {
    const editId = document.getElementById('log-edit-id').value;
    if (editId) {
        updateChairpersonLog(editId);
    } else {
        addChairpersonLog();
    }
}

function addChairpersonLog() {
    const date = document.getElementById('log-date').value;
    const time = document.getElementById('log-time').value;
    const chairperson = document.getElementById('log-chairperson').value.trim();
    const headcount = document.getElementById('log-headcount').value;
    const tradition = document.getElementById('log-7th-tradition').value;
    const orangeCan = document.getElementById('log-orange-can').value;

    if (!date) {
        showToast('Please select a date.', 'error');
        return;
    }

    const log = storage.getChairpersonLog();
    log.push({
        id: genId(),
        date,
        time,
        chairperson,
        headcount: parseInt(headcount) || 0,
        tradition: parseFloat(tradition) || 0,
        orangeCan: parseFloat(orangeCan) || 0,
    });
    storage.saveChairpersonLog(log);
    showToast('Log entry added.', 'success');
    updateChairpersonLogTable();
    document.getElementById('log-date').value = '';
    document.getElementById('log-time').value = '';
    document.getElementById('log-chairperson').value = '';
    document.getElementById('log-headcount').value = '';
    document.getElementById('log-7th-tradition').value = '';
    document.getElementById('log-orange-can').value = '';
}

function updateChairpersonLogTable() {
    const tbody = document.getElementById('chairperson-log-body');
    tbody.innerHTML = '';
    const log = storage.getChairpersonLog().sort((a, b) => new Date(b.date) - new Date(a.date));

    // Update the table header
    const thead = document.getElementById('chairperson-log-table').querySelector('thead');
    thead.innerHTML = `
        <tr>
            <th>Date</th>
            <th>Time</th>
            <th>Chairperson</th>
            <th>Head Count</th>
            <th>7th Tradition</th>
            <th>Orange Can</th>
            <th>Actions</th>
        </tr>
    `;

    log.forEach(entry => {
        const tr = document.createElement('tr');
        const timeStr = entry.time ? new Date('1970-01-01T' + entry.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'N/A';
        tr.innerHTML = `
            <td>${new Date(entry.date).toLocaleDateString()}</td>
            <td>${timeStr}</td>
            <td>${entry.chairperson || 'N/A'}</td>
            <td>${entry.headcount}</td>
            <td>$${entry.tradition.toFixed(2)}</td>
            <td>$${entry.orangeCan.toFixed(2)}</td>
            <td>
                <button class="btn" onclick="editChairpersonLog('${entry.id}')" style="margin-right: 5px;">Edit</button>
                <button class="btn secondary" onclick="deleteChairpersonLog('${entry.id}')">Delete</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function editChairpersonLog(id) {
    const log = storage.getChairpersonLog();
    const entry = log.find(e => e.id === id);
    if (!entry) return;

    document.getElementById('log-edit-id').value = entry.id;
    document.getElementById('log-date').value = entry.date;
    document.getElementById('log-time').value = entry.time;
    document.getElementById('log-chairperson').value = entry.chairperson;
    document.getElementById('log-headcount').value = entry.headcount;
    document.getElementById('log-7th-tradition').value = entry.tradition;
    document.getElementById('log-orange-can').value = entry.orangeCan;

    document.getElementById('chairperson-form-title').textContent = 'Edit Log Entry';
    document.getElementById('log-form-btn').textContent = 'Save Changes';
    document.getElementById('log-form-cancel-btn').style.display = 'inline-block';
}

function updateChairpersonLog(id) {
    const log = storage.getChairpersonLog();
    const index = log.findIndex(e => e.id === id);
    if (index === -1) return;

    const date = document.getElementById('log-date').value;
    const time = document.getElementById('log-time').value;
    const chairperson = document.getElementById('log-chairperson').value.trim();
    const headcount = document.getElementById('log-headcount').value;
    const tradition = document.getElementById('log-7th-tradition').value;
    const orangeCan = document.getElementById('log-orange-can').value;

    if (!date) {
        showToast('Please select a date.', 'error');
        return;
    }

    log[index] = {
        id,
        date,
        time,
        chairperson,
        headcount: parseInt(headcount) || 0,
        tradition: parseFloat(tradition) || 0,
        orangeCan: parseFloat(orangeCan) || 0,
    };

    storage.saveChairpersonLog(log);
    showToast('Log entry updated.', 'success');
    cancelLogEdit();
    updateChairpersonLogTable();
}

function cancelLogEdit() {
    document.getElementById('log-edit-id').value = '';
    document.getElementById('log-date').value = '';
    document.getElementById('log-time').value = '';
    document.getElementById('log-chairperson').value = '';
    document.getElementById('log-headcount').value = '';
    document.getElementById('log-7th-tradition').value = '';
    document.getElementById('log-orange-can').value = '';

    document.getElementById('chairperson-form-title').textContent = 'Log New Entry';
    document.getElementById('log-form-btn').textContent = 'Add Log Entry';
    document.getElementById('log-form-cancel-btn').style.display = 'none';
}

function deleteChairpersonLog(id) {
    if (!confirm('Delete this log entry?')) return;
    let log = storage.getChairpersonLog();
    log = log.filter(e => e.id !== id);
    storage.saveChairpersonLog(log);
    showToast('Log entry deleted.', 'info');
    updateChairpersonLogTable();
}

// Group Conscience Log Functions
function handleGCLogSubmit() {
    const editId = document.getElementById('gc-edit-id').value;
    if (editId) {
        updateGCLog(editId);
    } else {
        addGCLog();
    }
}

function addGCLog() {
    const log = {
        id: genId(),
        date: document.getElementById('gc-date').value,
        item: document.getElementById('gc-item').value.trim(),
        submittedBy: document.getElementById('gc-submitted-by').value.trim(),
        status: document.getElementById('gc-status').value,
        votes: document.getElementById('gc-votes').value.trim(),
        attendees: Array.from(document.getElementById('gc-attendees').selectedOptions).map(opt => opt.value),
        servantReports: document.getElementById('gc-servant-reports').value.trim(),
    };

    if (!log.date || !log.item) {
        showToast('Please provide at least a date and an item/motion.', 'error');
        return;
    }

    const logs = storage.getGroupConscienceLog();
    logs.push(log);
    storage.saveGroupConscienceLog(logs);
    showToast('Group Conscience entry added.', 'success');
    updateGCLogTable();
    cancelGCEdit(); // Clear form
}

function updateGCLogTable() {
    const currentTbody = document.getElementById('gc-log-body-current');
    const previousTbody = document.getElementById('gc-log-body-previous');
    currentTbody.innerHTML = '';
    previousTbody.innerHTML = '';

    const logs = storage.getGroupConscienceLog().sort((a, b) => new Date(b.date) - new Date(a.date));
    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();

    logs.forEach(log => {
        const logDate = new Date(log.date);
        const logMonth = logDate.getMonth();
        const logYear = logDate.getFullYear();

        const isCurrentMonth = logMonth === currentMonth && logYear === currentYear;
        const tbody = isCurrentMonth ? currentTbody : previousTbody;

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${logDate.toLocaleDateString()}</td>
            <td>${log.item.substring(0, 50)}${log.item.length > 50 ? '...' : ''}</td>
            <td>${log.submittedBy || 'N/A'}</td>
            <td>${log.status}</td>
            <td>
                <button class="btn" onclick="editGCLog('${log.id}')" style="margin-right: 5px;">Edit</button>
                <button class="btn secondary" onclick="deleteGCLog('${log.id}')">Delete</button>
            </td>
        `;
        tbody.appendChild(tr);
    });

    if (currentTbody.innerHTML === '') {
        currentTbody.innerHTML = '<tr><td colspan="5">No entries for the current month.</td></tr>';
    }
    if (previousTbody.innerHTML === '') {
        previousTbody.innerHTML = '<tr><td colspan="5">No entries for previous months.</td></tr>';
    }
}

function editGCLog(id) {
    const logs = storage.getGroupConscienceLog();
    const log = logs.find(l => l.id === id);
    if (!log) return;

    document.getElementById('gc-edit-id').value = log.id;
    document.getElementById('gc-date').value = log.date;
    document.getElementById('gc-item').value = log.item;
    document.getElementById('gc-submitted-by').value = log.submittedBy;
    document.getElementById('gc-status').value = log.status;
    document.getElementById('gc-votes').value = log.votes;

    // Handle populating the multi-select dropdown
    const attendees = log.attendees || [];
    const select = document.getElementById('gc-attendees');
    if (Array.isArray(attendees)) {
        Array.from(select.options).forEach(option => {
            option.selected = attendees.includes(option.value);
        });
    } else {
        // For old string data, we can't reliably pre-select. Clear selection.
        select.selectedIndex = -1;
    }

    document.getElementById('gc-servant-reports').value = log.servantReports;

    document.getElementById('gc-form-title').textContent = 'Edit GC Entry';
    document.getElementById('gc-form-btn').textContent = 'Save Changes';
    document.getElementById('gc-form-cancel-btn').style.display = 'inline-block';
}

function updateGCLog(id) {
    const logs = storage.getGroupConscienceLog();
    const index = logs.findIndex(l => l.id === id);
    if (index === -1) return;

    const log = {
        id,
        date: document.getElementById('gc-date').value,
        item: document.getElementById('gc-item').value.trim(),
        submittedBy: document.getElementById('gc-submitted-by').value.trim(),
        status: document.getElementById('gc-status').value,
        votes: document.getElementById('gc-votes').value.trim(),
        attendees: Array.from(document.getElementById('gc-attendees').selectedOptions).map(opt => opt.value),
        servantReports: document.getElementById('gc-servant-reports').value.trim(),
    };

    if (!log.date || !log.item) {
        showToast('Please provide at least a date and an item/motion.', 'error');
        return;
    }

    logs[index] = log;
    storage.saveGroupConscienceLog(logs);
    showToast('Group Conscience entry updated.', 'success');
    cancelGCEdit();
    updateGCLogTable();
}

function cancelGCEdit() {
    document.getElementById('gc-edit-id').value = '';
    document.getElementById('gc-date').value = '';
    document.getElementById('gc-item').value = '';
    document.getElementById('gc-submitted-by').value = '';
    document.getElementById('gc-status').value = 'passed';
    document.getElementById('gc-votes').value = '';
    document.getElementById('gc-attendees').value = '';
    document.getElementById('gc-servant-reports').value = '';

    document.getElementById('gc-form-title').textContent = 'Log Group Conscience Item';
    document.getElementById('gc-form-btn').textContent = 'Add GC Entry';
    document.getElementById('gc-form-cancel-btn').style.display = 'none';
}

function deleteGCLog(id) {
    if (!confirm('Delete this Group Conscience entry?')) return;
    let logs = storage.getGroupConscienceLog();
    logs = logs.filter(l => l.id !== id);
    storage.saveGroupConscienceLog(logs);
    showToast('GC entry deleted.', 'info');
    updateGCLogTable();
}


function exportChairpersonLogToPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const log = storage.getChairpersonLog().sort((a, b) => new Date(a.date) - new Date(b.date));

    if (log.length === 0) {
        showToast('No log entries to export.', 'error');
        return;
    }

    doc.setFontSize(18);
    doc.text("Chairperson's Contribution Log", 14, 22);

    const tableColumn = ["Date", "Time", "Chairperson", "Head Count", "7th Tradition ($)", "Orange Can ($)"];
    const tableRows = [];

    log.forEach(entry => {
        const timeStr = entry.time ? new Date('1970-01-01T' + entry.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'N/A';
        const logData = [
            new Date(entry.date).toLocaleDateString(),
            timeStr,
            entry.chairperson || 'N/A',
            entry.headcount,
            entry.tradition.toFixed(2),
            entry.orangeCan.toFixed(2)
        ];
        tableRows.push(logData);
    });

    doc.autoTable({
        head: [tableColumn],
        body: tableRows,
        startY: 30,
    });

    doc.save('Chairperson_Log_Report.pdf');
    showToast('PDF export generated!', 'success');
}

function exportGroupConscienceLogToPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const logs = storage.getGroupConscienceLog().sort((a, b) => new Date(a.date) - new Date(b.date));

    if (logs.length === 0) {
        showToast('No Group Conscience entries to export.', 'error');
        return;
    }

    doc.setFontSize(18);
    doc.text("Group Conscience Log", 14, 22);

    let y = 30;

    logs.forEach((log, index) => {
        if (y > 260) {
            doc.addPage();
            y = 20;
        }

        doc.setFontSize(14);
        doc.text(`Date: ${new Date(log.date).toLocaleDateString()}`, 14, y);
        y += 7;

        doc.setFontSize(12);
        doc.text(`Motion/Item: ${log.item}`, 14, y);
        y += 7;

        doc.text(`Submitted By: ${log.submittedBy}`, 14, y);
        y += 7;

        doc.text(`Status: ${log.status}`, 14, y);
        y += 7;

        doc.text(`Votes: ${log.votes}`, 14, y);
        y += 7;

        doc.text("Members Present:", 14, y);
        y += 7;
        const attendeesText = Array.isArray(log.attendees) ? log.attendees.join(', ') : (log.attendees || '');
        const attendees = doc.splitTextToSize(attendeesText, 180);
        doc.text(attendees, 14, y);
        y += attendees.length * 5;

        doc.text("Servant Reports:", 14, y);
        y += 7;
        const reports = doc.splitTextToSize(log.servantReports, 180);
        doc.text(reports, 14, y);
        y += reports.length * 5;

        if (index < logs.length - 1) {
            doc.line(14, y, 200, y); // Separator line
            y += 10;
        }
    });

    doc.save('Group_Conscience_Log.pdf');
    showToast('PDF export generated!', 'success');
}

// Data Management
function exportData(dataType) {
    let data;
    let filename = 'rowlett_group_data.json';
    const keys = {
        events: 'events',
        birthdays: 'birthdays',
        announcements: 'announcements',
        photos: 'photos',
        chairpersonLog: 'chairpersonLog',
        groupConscienceLog: 'groupConscienceLog',
    };

    if (dataType === 'all') {
        data = {};
        Object.keys(keys).forEach(key => {
            data[key] = JSON.parse(localStorage.getItem(keys[key]) || '[]');
        });
        // Handle non-JSON items

    } else if (keys[dataType]) {
        data = { [dataType]: JSON.parse(localStorage.getItem(keys[dataType]) || '[]') };
        filename = `rowlett_group_${dataType}.json`;
    } else {
        showToast('Invalid data type for export.', 'error');
        return;
    }

    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
    showToast('Data exported successfully!', 'success');
}

function importData() {
    const fileInput = document.getElementById('import-file');
    const file = fileInput.files[0];
    if (!file) {
        showToast('Please select a file to import.', 'error');
        return;
    }

    if (!confirm('Are you sure you want to import this data? This will overwrite existing data.')) {
        return;
    }

    const reader = new FileReader();
    reader.onload = function(event) {
        try {
            const data = JSON.parse(event.target.result);
            let imported = false;

            if (data.events) { storage.saveEvents(data.events); imported = true; }
            if (data.birthdays) { storage.saveBirthdays(data.birthdays); imported = true; }
            if (data.announcements) { storage.saveAnnouncements(data.announcements); imported = true; }
            if (data.photos) { storage.savePhotos(data.photos); imported = true; }
            if (data.chairpersonLog) { storage.saveChairpersonLog(data.chairpersonLog); imported = true; }
            if (data.groupConscienceLog) { storage.saveGroupConscienceLog(data.groupConscienceLog); imported = true; }

            if (imported) {
                showToast('Data imported successfully! The page will now reload.', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showToast('The selected file does not contain valid data to import.', 'error');
            }
        } catch (e) {
            showToast('Failed to parse JSON file. Ensure it is a valid backup file.', 'error');
            console.error('Import error:', e);
        }
    };
    reader.readAsText(file);
}

// Update gallery display
function updateGallery() {
    const grid = document.getElementById('gallery-grid');
    const filterInput = document.getElementById('tag-filter');
    const filterValue = filterInput.value.toLowerCase().trim();
    grid.innerHTML = '';

    const photos = storage.getPhotos();
    const filteredPhotos = filterValue ? photos.filter(p => p.tags.some(tag => tag.toLowerCase().includes(filterValue))) : photos;

    filteredPhotos.forEach((photo, idx) => {
        const originalIndex = photos.findIndex(p => p.src === photo.src); // Find original index for deletion
        const wrapper = document.createElement('div');
        wrapper.style.position = 'relative';
        const img = document.createElement('img');
        img.src = photo.src;
        img.onclick = () => openModal(idx, filteredPhotos);
        wrapper.appendChild(img);
        const delBtn = document.createElement('button');
        delBtn.innerHTML = '<i class="fas fa-trash"></i>';
        delBtn.style.position = 'absolute';
        delBtn.style.top = '5px';
        delBtn.style.right = '5px';
        delBtn.style.background = 'rgba(0,0,0,0.7)';
        delBtn.style.color = 'white';
        delBtn.style.border = 'none';
        delBtn.style.borderRadius = '50%';
        delBtn.style.width = '30px';
        delBtn.style.height = '30px';
        delBtn.style.lineHeight = '30px';
        delBtn.style.textAlign = 'center';
        delBtn.style.cursor = 'pointer';
        delBtn.style.fontSize = '14px';
        delBtn.onclick = (e) => {
            e.stopPropagation(); // Prevent modal from opening
            deletePhoto(originalIndex);
        };
        wrapper.appendChild(delBtn);
        grid.appendChild(wrapper);
    });

    if (filteredPhotos.length === 0) {
        grid.innerHTML = '<p>No photos match the filter.</p>';
    }
    renderTagList();
}

function renderTagList() {
    const tagList = document.getElementById('tag-list');
    const photos = storage.getPhotos();
    const allTags = [...new Set(photos.flatMap(p => p.tags))]; // Get unique tags
    tagList.innerHTML = '';
    allTags.forEach(tag => {
        const tagEl = document.createElement('span');
        tagEl.className = 'btn secondary';
        tagEl.textContent = tag;
        tagEl.style.marginRight = '0.5rem';
        tagEl.style.marginBottom = '0.5rem';
        tagEl.style.cursor = 'pointer';
        tagEl.onclick = () => setTagFilter(tag);
        tagList.appendChild(tagEl);
    });
}

function setTagFilter(tag) {
    const filterInput = document.getElementById('tag-filter');
    filterInput.value = tag;
    updateGallery();
}
// Update home overview boxes
function updateHome() {
    const homeEvents = document.getElementById('home-upcoming-events');
    homeEvents.innerHTML = '';
    const occ = computeUpcomingOccurrences(30);
    occ.slice(0, 5).forEach(item => {
        const li = document.createElement('li');
        li.textContent = `${item.occurDate.toLocaleDateString()} ${item.occurDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} — ${item.event.title}`;
        homeEvents.appendChild(li);
    });
    if (occ.length === 0) {
        homeEvents.innerHTML = '<li>No upcoming events</li>';
    }
    const homeBirthdays = document.getElementById('home-upcoming-birthdays');
    homeBirthdays.innerHTML = '';
    const allMembers = storage.getMembers();
    const membersInWindow = getAnniversariesInWindow(allMembers, 15, 60);

    const now = new Date();
    now.setHours(0,0,0,0);

    if (membersInWindow.length > 0) {
        membersInWindow.forEach(m => {
            const li = document.createElement('li');
            const years = m.displayDate.getFullYear() - new Date(m.birthday).getFullYear();
            li.textContent = `${m.name} — ${m.displayDate.toLocaleDateString()} (${years} years)`;

            // Highlight past birthdays
            if (m.displayDate < now) {
                li.style.backgroundColor = '#6b5d2f'; // Muted yellow/gold
                li.style.padding = '2px 4px';
                li.style.borderRadius = '3px';
            }
            homeBirthdays.appendChild(li);
        });
    } else {
        homeBirthdays.innerHTML = '<li>No recent or upcoming birthdays.</li>';
    }
    const homeAnnouncements = document.getElementById('home-recent-announcements');
    homeAnnouncements.innerHTML = '';
    const activeAnnouncements = storage.getAnnouncements().filter(a => a.active).slice(0, 3);
    activeAnnouncements.forEach(a => {
        const li = document.createElement('li');
        const dateStr = new Date(a.dateCreated).toLocaleDateString();
        li.textContent = `${dateStr}: ${a.text}`;
        homeAnnouncements.appendChild(li);
    });
    if (activeAnnouncements.length === 0) {
        homeAnnouncements.innerHTML = '<li>No active announcements</li>';
    }
    const homePhotos = document.getElementById('home-latest-photos');
    homePhotos.innerHTML = '';
    const allPhotos = storage.getPhotos();
    const recentPhotos = allPhotos.slice(-Math.min(3, allPhotos.length)).reverse();
    recentPhotos.forEach(photo => {
        const img = document.createElement('img');
        img.src = photo.src;
        img.style.height = '60px';
        img.style.width = 'auto';
        img.style.borderRadius = '4px';
        img.style.cursor = 'pointer';
        const originalIndex = allPhotos.findIndex(p => p.src === photo.src);
        img.onclick = () => openModal(originalIndex, allPhotos);
        homePhotos.appendChild(img);
    });
    if (photos.length === 0) {
        homePhotos.innerHTML = '<span>No photos yet</span>';
    }
}
// History display: show selected timeline and hide others
function showHistory(id) {
    document.querySelectorAll('.history-content').forEach(sec => sec.classList.remove('active'));
    const target = document.getElementById(id);
    if (target) target.classList.add('active');
    document.querySelectorAll('.history-nav button').forEach(btn => btn.classList.remove('active'));
    if (id === 'genesis-history') document.getElementById('genesis-btn').classList.add('active');
    if (id === 'dfw-history') document.getElementById('dfw-btn').classList.add('active');
    if (id === 'rowlett-history') document.getElementById('rowlett-btn').classList.add('active');
}
// Calendar: state for current month
const categoryColors = {
    "General": "#7f8c8d",
    "Open Discussion": "#2ecc71",
    "Closed Discussion": "#e74c3c",
    "Big Book Study": "#f1c40f",
    "12x12 Study": "#9b59b6",
    "Personal Story": "#1abc9c",
    "Foundations Speaker": "#d35400",
    "Birthday Night": "#e67e22"
};
let currentMonthDate = new Date();
currentMonthDate.setDate(1);
function renderCalendar() {
    const grid = document.getElementById('calendar-grid');
    if (!grid) return;
    grid.innerHTML = '';
    const year = currentMonthDate.getFullYear();
    const month = currentMonthDate.getMonth();
    const monthName = currentMonthDate.toLocaleString('default', { month: 'long', year: 'numeric' });
    document.getElementById('calendar-month-year').textContent = monthName;
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    dayNames.forEach(name => {
        const div = document.createElement('div');
        div.className = 'calendar-day-name';
        div.textContent = name;
        grid.appendChild(div);
    });
    for (let i = 0; i < firstDay; i++) {
        const blank = document.createElement('div');
        blank.className = 'calendar-day';
        blank.style.visibility = 'hidden';
        grid.appendChild(blank);
    }
    for (let d = 1; d <= daysInMonth; d++) {
        const date = new Date(year, month, d);
        const cell = document.createElement('div');
        cell.className = 'calendar-day';
        const num = document.createElement('div');
        num.className = 'calendar-day-number';
        num.textContent = d;
        cell.appendChild(num);
        const events = storage.getEvents();
        events.forEach(ev => {
            let occurs = false;
            if (ev.date) {
                if (ev.date === date.toISOString().substring(0,10)) occurs = true;
            } else if (ev.dayOfWeek !== null && ev.dayOfWeek !== undefined) {
                if (date.getDay() === ev.dayOfWeek) occurs = true;
            }
            if (occurs) {
                const evEl = document.createElement('div');
                evEl.className = 'calendar-event';
                evEl.textContent = ev.title;
                evEl.style.borderLeftColor = categoryColors[ev.category] || categoryColors['General'];

                const tooltip = document.createElement('div');
                tooltip.className = 'tooltip';
                let tooltipContent = `<strong>${ev.title}</strong><br>`;
                try {
                    const eventTime = new Date('1970-01-01T' + (ev.time || '00:00'));
                    tooltipContent += `Time: ${eventTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}<br>`;
                } catch(e) { /* Ignore invalid time format */ }
                if (ev.speaker) tooltipContent += `Speaker: ${ev.speaker}<br>`;
                if (ev.chair) tooltipContent += `Chair: ${ev.chair}<br>`;
                if (ev.description) tooltipContent += `Description: ${ev.description}`;
                tooltip.innerHTML = tooltipContent;
                evEl.appendChild(tooltip);

                cell.appendChild(evEl);
            }
        });
        grid.appendChild(cell);
    }
    const totalCells = dayNames.length + firstDay + daysInMonth;
    const remainder = totalCells % 7;
    if (remainder !== 0) {
        for (let i = 0; i < 7 - remainder; i++) {
            const blank = document.createElement('div');
            blank.className = 'calendar-day';
            blank.style.visibility = 'hidden';
            grid.appendChild(blank);
        }
    }
}
function initCalendarNav() {
    const prevBtn = document.getElementById('prev-month-btn');
    const nextBtn = document.getElementById('next-month-btn');
    if (prevBtn) {
        prevBtn.addEventListener('click', () => {
            currentMonthDate.setMonth(currentMonthDate.getMonth() - 1);
            renderCalendar();
        });
    }
    if (nextBtn) {
        nextBtn.addEventListener('click', () => {
            currentMonthDate.setMonth(currentMonthDate.getMonth() + 1);
            renderCalendar();
        });
    }
}
// Navigation click handlers
function initNav() {
    document.querySelectorAll('nav li').forEach(li => {
        li.addEventListener('click', () => {
            const target = li.getAttribute('data-section');
            goToSection(target);
        });
    });
}
// Meeting Companion: format data and display logic
const contentData = {
    'open-discussion': {
        title: 'Open Discussion Meeting',
        content: [
            { type: 'p', text: '<strong>Chairperson opens the meeting:</strong> "Welcome to the Rowlett Group of Alcoholics Anonymous. My name is ___, and I am an alcoholic."' },
            { type: 'p', text: 'Moment of silence, followed by the Serenity Prayer.' },
            { type: 'p', text: 'Read "How It Works" from Chapter 5 of the Big Book.' },
            { type: 'p', text: 'Acknowledge newcomers and visitors.' },
            { type: 'p', text: 'Introduce the topic for discussion. (e.g., a Step, a Tradition, a reading from AA literature, or a general topic related to recovery).' },
            { type: 'p', text: 'Facilitate sharing, ensuring everyone who wants to share has the opportunity.' },
            { type: 'p', text: 'Close with the Lord\'s Prayer or the Responsibility Declaration.' }
        ]
    },
    'closed-discussion': {
        title: 'Closed Discussion Meeting (for alcoholics only)',
        content: [
            { type: 'p', text: '<strong>Chairperson opens the meeting:</strong> "Welcome to the Rowlett Group of Alcoholics Anonymous. This is a closed meeting, for alcoholics or those who have a desire to stop drinking. My name is ___, and I am an alcoholic."' },
            { type: 'p', text: 'Moment of silence, followed by the Serenity Prayer.' },
            { type: 'p', text: 'Read "How It Works" and the Twelve Traditions.' },
            { type: 'p', text: 'Acknowledge newcomers.' },
            { type: 'p', text: 'Introduce the topic, often focusing on more in-depth aspects of the Steps, Traditions, or personal recovery challenges.' },
            { type: 'p', text: 'Facilitate sharing in a safe, closed environment.' },
            { type: 'p', text: 'Close with the Lord\'s Prayer or the Responsibility Declaration.' }
        ]
    },
    'big-book': {
        title: 'Big Book Study',
        content: [
            { type: 'p', text: '<strong>Chairperson opens the meeting:</strong> "Welcome to the Big Book study of the Rowlett Group. My name is ___, and I am an alcoholic."' },
            { type: 'p', text: 'Moment of silence, followed by the Serenity Prayer.' },
            { type: 'p', text: 'Read a chapter or section from the book "Alcoholics Anonymous."' },
            { type: 'p', text: 'The reader or chairperson may pause to allow for comments or questions, or discussion may follow the reading.' },
            { type: 'p', text: 'Focus is on understanding the text and applying it to personal recovery.' },
            { type: 'p', text: 'Close with the Lord\'s Prayer or the Responsibility Declaration.' }
        ]
    },
    '12x12': {
        title: '12 Steps and 12 Traditions Study',
        content: [
            { type: 'p', text: '<strong>Chairperson opens the meeting:</strong> "Welcome to the 12 & 12 study of the Rowlett Group. My name is ___, and I am an alcoholic."' },
            { type: 'p', text: 'Moment of silence, followed by the Serenity Prayer.' },
            { type: 'p', text: 'Read a Step or Tradition from the book "Twelve Steps and Twelve Traditions."' },
            { type: 'p', text: 'Discussion focuses on the selected Step or Tradition, its meaning, and its application in members\' lives.' },
            { type: 'p', text: 'Close with the Lord\'s Prayer or the Responsibility Declaration.' }
        ]
    },
    'personal-story': {
        title: 'Personal Story Speaker Meeting',
        content: [
            { type: 'p', text: '<strong>Chairperson opens the meeting:</strong> "Welcome to the Rowlett Group of Alcoholics Anonymous. My name is ___, and I am an alcoholic."' },
            { type: 'p', text: 'Moment of silence and Serenity Prayer.' },
            { type: 'p', text: 'Read "How It Works."' },
            { type: 'p', text: 'Introduce the speaker. The speaker shares their experience, strength, and hope: what it was like, what happened, and what it\'s like now.' },
            { type: 'p', text: 'Sharing is typically for a set amount of time (e.g., 20-30 minutes).' },
            { type: 'p', text: 'After the speaker, the meeting may open for brief sharing or proceed to closing.' },
            { type: 'p', text: 'Close with the Lord\'s Prayer or the Responsibility Declaration.' }
        ]
    },
    'foundations': {
        title: 'Foundations Speaker Meeting',
        content: [
            { type: 'p', text: '<strong>Chairperson opens the meeting:</strong> "Welcome to the Foundations meeting of the Rowlett Group. My name is ___, and I am an alcoholic."' },
            { type: 'p', text: 'Moment of silence and Serenity Prayer.' },
            { type: 'p', text: 'Introduce the speaker, who will share on a foundational aspect of AA recovery (e.g., Sponsorship, Service, Home Group, a specific Step).' },
            { type: 'p', text: 'The speaker\'s share is the main focus of the meeting.' },
            { type: 'p', text: 'Close with the Lord\'s Prayer or the Responsibility Declaration.' }
        ]
    },
    'birthday': {
        title: 'Birthday Night Meeting',
        content: [
            { type: 'p', text: '<strong>Chairperson opens the meeting:</strong> "Welcome to the Birthday Night celebration of the Rowlett Group. My name is ___, and I am an alcoholic."' },
            { type: 'p', text: 'Moment of silence and Serenity Prayer.' },
            { type: 'p', text: 'Acknowledge members celebrating a sobriety anniversary this month.' },
            { type: 'p', text: 'Invite each person up to receive a chip. They may share briefly on their recovery.' },
            { type: 'p', text: 'The group celebrates their milestones.' },
            { type: 'p', text: 'Close with the Serenity Prayer, often holding hands in a circle.' }
        ]
    },
    'how-it-works': {
        title: 'How It Works',
        content: [
            { type: 'p', text: 'RARELY HAVE we seen a person fail who has thoroughly followed our path. Those who do not recover are people who cannot or will not completely give themselves to this simple program, usually men and women who are constitutionally incapable of being honest with themselves. There are such unfortunates. They are not at fault; they seem to have been born that way. They are naturally incapable of grasping and developing a manner of living which demands rigorous honesty. Their chances are less than average. There are those, too, who suffer from grave emotional and mental disorders, but many of them do recover if they have the capacity to be honest.' },
            { type: 'p', text: 'Our stories disclose in a general way what we used to be like, what happened, and what we are like now. If you have decided you want what we have and are willing to go to any length to get it-then you are ready to take certain steps.' },
            { type: 'p', text: 'At some of these we balked. We thought we could find an easier, softer way. But we could not. With all the earnestness at our command, we beg of you to be fearless and thorough from the very start. Some of us have tried to hold on to our old ideas and the result was nil until we let go absolutely.' },
            { type: 'p', text: 'Remember that we deal with alcohol - cunning, baffling, powerful! Without help it is too much for us. But there is One who has all power-that One is God. May you find Him now!' },
            { type: 'p', text: 'Half measures availed us nothing. We stood at the turning point. We asked His protection and care with complete abandon.' },
            { type: 'p', text: 'Here are the steps we took, which are suggested as a program of recovery:' },
            { type: 'ol', items: [
                'We admitted we were powerless over alcohol - that our lives had become unmanageable.',
                'Came to believe that a Power greater than ourselves could restore us to sanity.',
                'Made a decision to turn our will and our lives over to the care of God as we understood Him.',
                'Made a searching and fearless moral inventory of ourselves.',
                'Admitted to God, to ourselves and to another human being the exact nature of our wrongs.',
                'Were entirely ready to have God remove all these defects of character.',
                'Humbly asked Him to remove our shortcomings.',
                'Made a list of all persons we had harmed, and became willing to make amends to them all.',
                'Made direct amends to such people wherever possible, except when to do so would injure them or others.',
                'Continued to take personal inventory and when we were wrong promptly admitted it.',
                'Sought through prayer and meditation to improve our conscious contact with God as we understood Him, praying only for knowledge of His will for us and the power to carry that out.',
                'Having had a spiritual awakening as the result of these steps, we tried to carry this message to alcoholics and to practice these principles in all our affairs.'
            ]},
            { type: 'p', text: 'Many of us exclaimed, "What an order! I can\'t go through with it." Do not be discouraged. No one among us has been able to maintain anything like perfect adherence to these principles. We are not saints. The point is, that we are willing to grow along spiritual lines. The principles we have set down are guides to progress. We claim spiritual progress rather than spiritual perfection.' },
            { type: 'p', text: 'Our description of the alcoholic, the chapter to the agnostic, and our personal adventures before and after make clear three pertinent ideas:' },
            { type: 'ul', items: [
                'a. That we were alcoholic and could not manage our own lives.',
                'b. That probably no human power could have relieved our alcoholism.',
                'c. That God could and would if He were sought.'
            ]}
        ]
    },
    'traditions': {
        title: 'The Twelve Traditions',
        content: [
            { type: 'ol', items: [
                'Our common welfare should come first; personal recovery depends upon A.A. unity.',
                'For our group purpose there is but one ultimate authority — a loving God as He may express Himself in our group conscience. Our leaders are but trusted servants; they do not govern.',
                'The only requirement for A.A. membership is a desire to stop drinking.',
                'Each group should be autonomous except in matters affecting other groups or A.A. as a whole.',
                'Each group has but one primary purpose — to carry its message to the alcoholic who still suffers.',
                'An A.A. group ought never endorse, finance, or lend the A.A. name to any related facility or outside enterprise, lest problems of money, property, and prestige divert us from our primary purpose.',
                'Every A.A. group ought to be fully self-supporting, declining outside contributions.',
                'Alcoholics Anonymous should remain forever non-professional, but our service centers may employ special workers.',
                'A.A., as such, ought never be organized; but we may create service boards or committees directly responsible to those they serve.',
                'Alcoholics Anonymous has no opinion on outside issues; hence the A.A. name ought never be drawn into public controversy.',
                'Our public relations policy is based on attraction rather than promotion; we need always maintain personal anonymity at the level of press, radio, and films.',
                'Anonymity is the spiritual foundation of all our traditions, ever reminding us to place principles before personalities.'
            ]}
        ]
    },
    'promises': {
        title: 'The 9th Step Promises',
        content: [
            { type: 'p', text: 'If we are painstaking about this phase of our development, we will be amazed before we are halfway through. We are going to know a new freedom and a new happiness. We will not regret the past nor wish to shut the door on it. We will comprehend the word serenity and we will know peace. No matter how far down the scale we have gone, we will see how our experience can benefit others. That feeling of uselessness and self pity will disappear. We will lose interest in selfish things and gain interest in our fellows. Self seeking will slip away. Our whole attitude and outlook upon life will change. Fear of a Meda and of economic insecurity will leave us. We will intuitively know how to handle situations which used to baffle us. We will suddenly realize that God is doing for us what we could not do for ourselves.' },
            { type: 'p', text: 'Are these extravagant promises? We think not! They are being fulfilled among us – Sometimes quickly, sometimes slowly. They will always materialize if we work for them.' }
        ]
    }
};

function renderMeetingFormat(data) {
    if (!data) return '';
    let html = `<h3>${data.title}</h3>`;
    data.content.forEach(item => {
        if (item.type === 'p') {
            html += `<p>${item.text}</p>`;
        } else if (item.type === 'ol' || item.type === 'ul') {
            const listTag = item.type;
            html += `<${listTag} style="list-style-position: inside;">`;
            item.items.forEach(li => {
                html += `<li>${li}</li>`;
            });
            html += `</${listTag}>`;
        }
    });
    return html;
}

function showMeetingFormat(format) {
    const display = document.getElementById('meeting-format-display');
    const data = contentData[format];
    if (data) {
        display.innerHTML = renderMeetingFormat(data);
        display.style.display = 'block';
    }
}
// Chairperson's Corner Roster Modal Logic
let rosterSortColumn = 'name';
let rosterSortDirection = 'asc';

function openRosterModal() {
    document.getElementById('roster-modal').style.display = 'flex';
    renderRosterTable();
}

function closeRosterModal() {
    document.getElementById('roster-modal').style.display = 'none';
}

function sortRosterBy(column) {
    if (rosterSortColumn === column) {
        rosterSortDirection = rosterSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        rosterSortColumn = column;
        rosterSortDirection = 'asc';
    }
    // Update header indicators
    document.querySelectorAll('#roster-table th').forEach(th => {
        th.textContent = th.textContent.replace(/ [↑↓]/, '');
    });
    const header = Array.from(document.querySelectorAll('#roster-table th')).find(th => th.textContent.toLowerCase().startsWith(column));
    if (header) {
        header.textContent += rosterSortDirection === 'asc' ? ' ↓' : ' ↑';
    }
    renderRosterTable();
}

function renderRosterTable() {
    const tbody = document.getElementById('roster-table-body');
    if (!tbody) return;
    const searchTerm = document.getElementById('roster-search').value.toLowerCase();
    tbody.innerHTML = '';

    let members = storage.getMembers();

    // 1. Filter
    if (searchTerm) {
        members = members.filter(m => {
            return m.name.toLowerCase().includes(searchTerm) ||
                   (m.email && m.email.toLowerCase().includes(searchTerm)) ||
                   (m.phone && m.phone.includes(searchTerm)) ||
                   (m.homegroup && m.homegroup.toLowerCase().includes(searchTerm)) ||
                   (m.city && m.city.toLowerCase().includes(searchTerm));
        });
    }

    // 2. Sort
    members.sort((a, b) => {
        let valA = a[rosterSortColumn] === undefined ? '' : a[rosterSortColumn];
        let valB = b[rosterSortColumn] === undefined ? '' : b[rosterSortColumn];

        if (typeof valA === 'boolean') {
            valA = valA ? 1 : 0;
            valB = valB ? 1 : 0;
        } else if (typeof valA === 'string') {
            valA = valA.toLowerCase();
            valB = valB.toLowerCase();
        }

        if (valA < valB) return rosterSortDirection === 'asc' ? -1 : 1;
        if (valA > valB) return rosterSortDirection === 'asc' ? 1 : -1;
        return 0;
    });

    // 3. Render
    if(members.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7">No members found.</td></tr>';
        return;
    }

    members.forEach(member => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${member.name}</td>
            <td>${member.city || ''}</td>
            <td>${member.homegroup || ''}</td>
            <td>${member.phone || ''}</td>
            <td>${member.email || ''}</td>
            <td>${member.isServant ? 'Yes' : 'No'}</td>
            <td>
                <button class="btn" onclick="editMemberFromRoster('${member.id}')">Edit</button>
                <button class="btn secondary" onclick="deleteMemberAndRefreshRoster('${member.id}')">Delete</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function editMemberFromRoster(id) {
    closeRosterModal();
    editMember(id);
}

function deleteMemberAndRefreshRoster(id) {
    deleteMember(id);
    renderRosterTable();
}

function openMemberFormFromModal() {
    closeRosterModal();
    const form = document.getElementById('add-member-form');
    form.style.display = 'block';
    goToSection('birthdays-section');
    form.scrollIntoView({ behavior: 'smooth' });
}

function populateAttendeeDropdown() {
    const select = document.getElementById('gc-attendees');
    if (!select) return;
    const members = storage.getMembers().sort((a, b) => a.name.localeCompare(b.name));

    // Preserve selected values if they exist, useful if the list is refreshed while form is open
    const selectedValues = Array.from(select.selectedOptions).map(opt => opt.value);

    select.innerHTML = ''; // Clear existing options
    members.forEach(member => {
        const option = document.createElement('option');
        option.value = member.name;
        option.textContent = member.name;
        if (selectedValues.includes(member.name)) {
            option.selected = true;
        }
        select.appendChild(option);
    });
}

function populateMemberDropdowns() {
    const members = storage.getMembers().sort((a, b) => a.name.localeCompare(b.name));
    const dropdowns = [
        { id: 'log-chairperson', placeholder: 'Select Chairperson' },
        { id: 'event-speaker', placeholder: 'Select Speaker (optional)', optional: true },
        { id: 'event-chair', placeholder: 'Select Chairperson (optional)', optional: true }
    ];

    dropdowns.forEach(dd_info => {
        const select = document.getElementById(dd_info.id);
        if (!select) return;

        const currentValue = select.value;
        select.innerHTML = '';

        const placeholderOption = document.createElement('option');
        placeholderOption.value = '';
        placeholderOption.textContent = dd_info.placeholder;
        select.appendChild(placeholderOption);

        if (dd_info.optional) {
            const noneOption = document.createElement('option');
            noneOption.value = 'None';
            noneOption.textContent = 'None';
            select.appendChild(noneOption);
        }

        members.forEach(member => {
            const option = document.createElement('option');
            option.value = member.name;
            option.textContent = member.name;
            select.appendChild(option);
        });

        select.value = currentValue;
    });
}

function setupAudioRecorder() {
    const recordBtn = document.getElementById('record-btn');
    const stopBtn = document.getElementById('stop-btn');
    const audioPlayer = document.getElementById('audio-player');
    const downloadLink = document.getElementById('download-link');
    const playerContainer = document.getElementById('audio-player-container');

    if (!recordBtn) return; // Exit if the recorder elements aren't on the page

    let mediaRecorder;
    let chunks = [];

    async function startRecording() {
        try {
            // Request microphone access
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);

            // Event handler for when data is available
            mediaRecorder.ondataavailable = e => {
                chunks.push(e.data);
            };

            // Event handler for when recording stops
            mediaRecorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'audio/webm' });
                chunks = [];
                const audioURL = window.URL.createObjectURL(blob);
                audioPlayer.src = audioURL;
                downloadLink.href = audioURL;

                // Create a filename with a timestamp
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[-:T]/g, '').replace(/ /g, '_');
                downloadLink.download = `meeting-audio-${timestamp}.webm`;

                // Make the player and download link visible
                playerContainer.style.display = 'block';
                downloadLink.style.display = 'inline-block';

                // Stop the microphone track to turn off the browser's recording indicator
                stream.getTracks().forEach(track => track.stop());
            };

            // Start recording and update UI
            mediaRecorder.start();
            recordBtn.disabled = true;
            stopBtn.disabled = false;
            playerContainer.style.display = 'none';
            downloadLink.style.display = 'none';
            showToast('Recording started...', 'info');

        } catch (err) {
            console.error("Error starting recording:", err);
            if (err.name === "NotAllowedError" || err.name === "PermissionDeniedError") {
                showToast('Microphone permission denied. Please allow access in your browser settings.', 'error');
            } else {
                showToast('Could not start recording. No microphone found or an error occurred.', 'error');
            }
        }
    }

    function stopRecording() {
        if (mediaRecorder && mediaRecorder.state !== "inactive") {
            mediaRecorder.stop();
            recordBtn.disabled = false;
            stopBtn.disabled = true;
            showToast('Recording stopped.', 'info');
        }
    }

    recordBtn.addEventListener('click', startRecording);
    stopBtn.addEventListener('click', stopRecording);
}


// Initialize the application
function init() {
    initDefaults();
    initNav();
    initCalendarNav();
    updateEventsTable();
    updateBirthdaysTable();
    updateAnnouncementsList();
    updateGallery();
    updateHome();
    renderCalendar();
    showHistory('genesis-history');
    updateChairpersonLogTable();
    updateGCLogTable();
    updateChairpersonAnnouncements();
    populateAttendeeDropdown();
    populateMemberDropdowns();
    setupAudioRecorder();

    // Back to Top button logic
    const mainEl = document.querySelector('main');
    const backToTopBtn = document.getElementById('back-to-top-btn');

    mainEl.addEventListener('scroll', () => {
        const historySection = document.getElementById('history-section');
        if (historySection.classList.contains('active') && mainEl.scrollTop > 100) {
            backToTopBtn.style.display = 'block';
        } else {
            backToTopBtn.style.display = 'none';
        }
    });

    backToTopBtn.addEventListener('click', () => {
        mainEl.scrollTo({ top: 0, behavior: 'smooth' });
    });
}
document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>