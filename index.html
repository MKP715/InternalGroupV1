<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="description" content="Rowlett Group AA - Internal Group Conscience Management Tool">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; font-src 'self' https://cdnjs.cloudflare.com; img-src 'self' data: blob:; connect-src 'self' https://api.dictionaryapi.dev;">
    <title>Rowlett Group Home</title>
    <!-- Link to the custom favicon logo -->
    <!-- Include Tailwind CSS for utility classes and Font Awesome for icons -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- DOMPurify for XSS Protection -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"></script>
    <!-- Link to the custom favicon logo -->
    <link rel="icon" type="image/svg+xml" href="logo.svg">
    <style>
        /* Basic reset and typography */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #2c3e50; /* Dark Slate Gray */
            color: #ecf0f1; /* Silver */
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-y: scroll; /* Persistent vertical scrollbar */
            overflow-x: hidden; /* Prevent horizontal scrollbar */
        }

        h1, h2, h3 {
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: #3498db; /* Metallic Blue */
        }

        /* Navigation bar */
        nav {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            background: #34495e; /* Wet Asphalt */
            color: #ecf0f1;
            padding: 0.5rem 1rem;
            border-bottom: 2px solid #3498db; /* Metallic Blue */
        }
        nav .logo {
            display: flex;
            align-items: center;
            font-size: 1.25rem;
        }
        nav .logo svg {
            width: 32px;
            height: 32px;
            margin-right: 0.5rem;
        }
        nav ul {
            list-style: none;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-right: 1rem;
        }

        @media (min-width: 768px) {
            nav ul {
                margin-right: 4rem;
            }
        }
        nav li {
            cursor: pointer;
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            transition: background 0.2s;
            position: relative;
        }
        nav li:hover, nav li.active {
            background: #3498db; /* Metallic Blue */
            color: #ffffff;
        }

        /* Dropdown menu styles */
        nav li.has-dropdown {
            padding-right: 1.5rem;
        }
        nav li.has-dropdown::after {
            content: '\f107'; /* Font Awesome down arrow */
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.75rem;
            transition: transform 0.2s;
        }
        nav li.has-dropdown:hover::after {
            transform: translateY(-50%) rotate(180deg);
        }
        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            min-width: 200px;
            background: #2c3e50;
            border: 1px solid #3498db;
            border-radius: 4px;
            margin-top: 0.25rem;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        nav li:hover .dropdown-menu,
        nav li.dropdown-open .dropdown-menu {
            display: block;
        }
        .dropdown-menu li {
            padding: 0.5rem 1rem;
            border-radius: 0;
            border-bottom: 1px solid #34495e;
        }
        .dropdown-menu li:last-child {
            border-bottom: none;
        }
        .dropdown-menu li:hover {
            background: #34495e;
        }
        .dropdown-menu li.active {
            background: #2980b9;
        }
        /* Right-align the last dropdown (settings) */
        nav ul li.has-dropdown:last-child .dropdown-menu {
            left: auto;
            right: 0;
        }

        /* Main content area */
        main {
            flex: 1;
            padding: 1rem;
            width: 100%;
            max-width: none;
            margin: 0;
            overflow-y: auto;
        }
        section {
            display: none;
        }
        section.active {
            display: block;
        }

        /* Home overview boxes */
        .grid {
            display: grid;
            gap: 1rem;
        }
        .grid-cols-2 {
            grid-template-columns: 1fr;
        }

        @media (min-width: 640px) {
            .grid-cols-2 {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
        }
        .box {
            background: #34495e; /* Wet Asphalt */
            border: 1px solid #7f8c8d; /* Silver-Gray */
            border-radius: 6px;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            color: #ecf0f1; /* Silver */
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
            display: block;
            overflow-x: auto;
            white-space: nowrap;
        }

        @media (min-width: 768px) {
            table {
                display: table;
                white-space: normal;
            }
        }

        th, td {
            padding: 0.5rem;
            border-bottom: 1px solid #7f8c8d; /* Silver-Gray */
            text-align: left;
            min-width: 80px;
        }

        @media (max-width: 640px) {
            th, td {
                padding: 0.3rem;
                font-size: 0.85rem;
            }
        }
        th {
            background: #2c3e50; /* Dark Slate Gray */
            color: #3498db; /* Metallic Blue */
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 4px;
            background: #3498db; /* Metallic Blue */
            color: #fff;
            border: 1px solid #2980b9; /* Darker Blue */
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
            font-size: 0.9rem;
            min-height: 44px;
            min-width: 44px;
            touch-action: manipulation;
        }

        @media (max-width: 640px) {
            .btn {
                padding: 0.6rem 0.8rem;
                font-size: 0.85rem;
            }
        }
        .btn:hover {
            background: #2980b9;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .btn.secondary {
            background: #7f8c8d; /* Silver-Gray */
            border-color: #95a5a6;
        }
        .btn.secondary:hover {
            background: #95a5a6;
        }

        /* Form styling */
        .form-group {
            margin-bottom: 0.75rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.25rem;
            font-weight: 500;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #7f8c8d; /* Silver-Gray */
            border-radius: 4px;
            background: #34495e; /* Wet Asphalt */
            color: #ecf0f1; /* Silver */
            font-size: 16px;
            min-height: 44px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: 2px solid #3498db;
            outline-offset: 2px;
        }

        /* Specific style for the roster search input to ensure visibility */
        #roster-search {
            padding: 0.5rem;
            border: 1px solid #7f8c8d; /* Silver-Gray */
            border-radius: 4px;
            background: #34495e; /* Wet Asphalt */
            color: #ecf0f1; /* Silver */
        }

        /* Gallery */
        #gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
        }
        #gallery-grid img {
            width: 100%;
            height: auto;
            border-radius: 6px;
            object-fit: cover;
            cursor: pointer;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
        .modal-content {
            max-width: 95%;
            max-height: 90%;
            width: 100%;
        }

        @media (min-width: 768px) {
            .modal-content {
                max-width: 80%;
                max-height: 80%;
            }
        }
        .modal-close {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #fff;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 101;
        }

        /* Next & previous buttons */
        .prev, .next {
            cursor: pointer;
            position: absolute;
            top: 50%;
            width: auto;
            padding: 16px;
            margin-top: -22px;
            color: white;
            font-weight: bold;
            font-size: 20px;
            transition: 0.6s ease;
            border-radius: 0 3px 3px 0;
            user-select: none;
            -webkit-user-select: none;
        }
        .next {
            right: 0;
            border-radius: 3px 0 0 3px;
        }
        .prev {
            left: 0;
        }
        .prev:hover, .next:hover {
            background-color: rgba(0,0,0,0.8);
        }

        /* History section */
        .history-nav {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .history-nav button {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #7f8c8d;
            border-radius: 4px;
            background: #34495e; /* Wet Asphalt */
            color: #ecf0f1; /* Silver */
            cursor: pointer;
            transition: background 0.2s;
        }
        .history-nav button.active {
            background: #3498db; /* Metallic Blue */
            border-color: #2980b9;
        }
        /* Timeline styles adapted from the original history pages.  */
        .timeline-container {
            position: relative;
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        .timeline-container::after {
            content: '';
            position: absolute;
            width: 6px;
            background-color: #7f8c8d; /* Silver-Gray */
            top: 0;
            bottom: 0;
            left: 50%;
            margin-left: -3px;
            border-radius: 3px;
        }
        .timeline-block {
            padding: 10px 40px;
            position: relative;
            background-color: inherit;
            width: 50%;
        }
        .timeline-block.left {
            left: 0;
        }
        .timeline-block.right {
            left: 50%;
        }
        .timeline-block::after {
            content: '';
            position: absolute;
            width: 25px;
            height: 25px;
            right: -14px;
            background-color: #34495e; /* Wet Asphalt */
            border: 4px solid #3498db; /* Metallic Blue */
            top: 25px;
            border-radius: 50%;
            z-index: 1;
            transition: all 0.3s ease;
        }
        .timeline-block.right::after {
            left: -12px;
            right: auto;
        }
        .timeline-content {
            padding: 20px 30px;
            background-color: #2c3e50; /* Dark Slate Gray */
            color: #ecf0f1; /* Silver */
            position: relative;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .timeline-content:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .timeline-block:hover::after {
            transform: scale(1.2);
            border-color: #FBBF24; /* amber-400 */
        }
        /* Info popups are hidden by default. They will appear on hover via timeline-content:hover .info-popup. */
        .info-popup {
            position: absolute;
            bottom: calc(100% + 15px);
            left: 50%;
            transform: translateX(-50%) scale(0.95);
            width: 90%;
            min-width: 250px;
            background-color: #34495e; /* Wet Asphalt */
            color: #ecf0f1; /* Silver */
            padding: 15px;
            border-radius: 8px;
            z-index: 10;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .timeline-content:hover .info-popup {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) scale(1);
        }
        /* History content sections */
        .history-content {
            display: none;
        }
        .history-content.active {
            display: block;
        }
        /* Calendar styles */
        #calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            border: 1px solid #7f8c8d; /* Silver-Gray */
            border-radius: 6px;
            overflow: hidden;
        }

        @media (max-width: 640px) {
            #calendar-grid {
                font-size: 0.7rem;
            }
        }

        .calendar-day {
            border-right: 1px solid #7f8c8d;
            border-bottom: 1px solid #7f8c8d;
            min-height: 110px;
            padding: 4px;
            font-size: 0.8rem;
            position: relative;
        }

        @media (max-width: 640px) {
            .calendar-day {
                min-height: 80px;
                padding: 2px;
                font-size: 0.7rem;
            }
        }
        .calendar-day:nth-child(7n) {
            border-right: none;
        }
        .calendar-day-name {
            font-weight: bold;
            background-color: #2c3e50; /* Dark Slate Gray */
            color: #3498db; /* Metallic Blue */
            text-align: center;
            padding: 4px 0;
            border-bottom: 1px solid #7f8c8d;
        }
        .calendar-day-number {
            font-weight: bold;
            margin-bottom: 4px;
        }
        .calendar-event {
            background-color: #3498db; /* Metallic Blue */
            color: white;
            border-radius: 3px;
            border-left: 5px solid #2980b9; /* Default category color */
            padding: 2px 4px;
            font-size: 0.7rem;
            margin-bottom: 2px;
            display: block;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            position: relative; /* For tooltip positioning */
            cursor: help;
        }
        /* Tooltip styles */
        .calendar-event .tooltip {
            visibility: hidden;
            width: 220px;
            background-color: #34495e;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 10;
            bottom: 110%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
            white-space: normal;
            font-size: 0.8rem;
            line-height: 1.4;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .calendar-event:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
        .calendar-event .tooltip strong {
            color: #3498db; /* Metallic Blue */
        }
        /* Toast Notification styles */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
        }
        .toast {
            background-color: #34495e; /* Wet Asphalt */
            color: #ecf0f1; /* Silver */
            padding: 15px 20px;
            border-radius: 6px;
            border-left: 5px solid #3498db; /* Default: info */
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.4s ease;
        }
        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        .toast.success { border-left-color: #2ecc71; /* Green */ }
        .toast.error { border-left-color: #e74c3c; /* Red */ }

        /* Back to Top Button */
        #back-to-top-btn {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 30px;
            z-index: 99;
            font-size: 18px;
            border: none;
            outline: none;
            background-color: #3498db;
            color: white;
            cursor: pointer;
            padding: 15px;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            line-height: 18px;
            text-align: center;
        }
        #back-to-top-btn:hover {
            background-color: #2980b9;
        }

        /* Finance tab styles */
        .finance-tab {
            display: none;
        }
        .finance-tab.active {
            display: block;
        }

        /* Announcement priority badges */
        .announcement-item {
            position: relative;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            background: #34495e;
            border-left: 5px solid #7f8c8d;
        }
        .announcement-item.urgent {
            border-left-color: #e74c3c;
            background: #3d2d2d;
        }
        .announcement-item.normal {
            border-left-color: #3498db;
        }
        .announcement-item.info {
            border-left-color: #95a5a6;
        }
        .priority-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 8px;
        }
        .priority-badge.urgent {
            background: #e74c3c;
            color: white;
        }
        .priority-badge.normal {
            background: #3498db;
            color: white;
        }
        .priority-badge.info {
            background: #95a5a6;
            color: white;
        }
        .read-receipt-indicator {
            font-size: 0.75rem;
            color: #95a5a6;
            margin-top: 5px;
        }
        .mark-as-read-btn {
            font-size: 0.75rem;
            padding: 4px 8px;
            margin-top: 5px;
        }

        /* Vote Progress Bars */
        .vote-progress-container {
            margin: 1rem 0;
        }
        .vote-progress-item {
            margin-bottom: 0.75rem;
        }
        .vote-progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }
        .vote-progress-bar-bg {
            background: #2c3e50;
            border-radius: 10px;
            overflow: hidden;
            height: 24px;
            border: 1px solid #7f8c8d;
            position: relative;
        }
        .vote-progress-bar-fill {
            height: 100%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        .vote-progress-bar-fill.for {
            background: linear-gradient(90deg, #27ae60, #2ecc71);
        }
        .vote-progress-bar-fill.against {
            background: linear-gradient(90deg, #c0392b, #e74c3c);
        }
        .vote-progress-bar-fill.abstain {
            background: linear-gradient(90deg, #d68910, #f39c12);
        }

        /* GC Trends Dashboard */
        .trends-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        .trend-chart-container {
            background: #34495e;
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid #7f8c8d;
        }
        .trend-chart-container h4 {
            color: #3498db;
            margin-bottom: 0.5rem;
        }

        /* Amendment Tracking */
        .amendment-timeline {
            border-left: 3px solid #3498db;
            padding-left: 1rem;
            margin: 1rem 0;
        }
        .amendment-item {
            position: relative;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: #34495e;
            border-radius: 6px;
        }
        .amendment-item::before {
            content: '';
            position: absolute;
            left: -1.5rem;
            top: 1rem;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #3498db;
            border: 2px solid #2c3e50;
        }
        .amendment-item.adopted::before {
            background: #2ecc71;
        }
        .amendment-item.rejected::before {
            background: #e74c3c;
        }

        /* Notification Badge */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
        }

        /* Notification Banner Animations */
        @keyframes slideDown {
            from {
                transform: translateX(-50%) translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }
        @keyframes slideUp {
            from {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
            to {
                transform: translateX(-50%) translateY(-100%);
                opacity: 0;
            }
        }

        /* Message styles */
        .message-item {
            background: #34495e;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            border-left: 4px solid #3498db;
        }
        .message-item.unread {
            background: #2d3e4e;
            border-left-color: #e74c3c;
        }
        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .message-subject {
            font-weight: bold;
            color: #3498db;
        }
        .message-date {
            font-size: 0.85rem;
            color: #95a5a6;
        }

        /* Template card styles */
        .template-card {
            background: #34495e;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            border-left: 4px solid #3498db;
        }
        .template-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .template-type-badge {
            font-size: 0.75rem;
            padding: 3px 8px;
            border-radius: 3px;
            background: #2980b9;
            color: white;
        }

        /* Service position card */
        .position-card {
            background: #34495e;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        .term-warning {
            color: #f39c12;
            font-weight: bold;
        }
        .term-expired {
            color: #e74c3c;
            font-weight: bold;
        }

        /* Nomination card */
        .nomination-card {
            background: #2c3e50;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 4px;
            border-left: 3px solid #3498db;
        }

        /* Chart container */
        #yoy-chart {
            min-height: 300px;
        }

        /* Utility classes */
        .mt-4 { margin-top: 1rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }

        /* ========================================
           PRINT STYLESHEETS
           ======================================== */
        @media print {
            /* Hide navigation and UI elements */
            nav, #toast-container, #back-to-top-btn, .btn, button {
                display: none !important;
            }

            /* Reset colors for printing */
            body {
                background: white;
                color: black;
            }

            .box, section {
                background: white !important;
                border: 1px solid #000;
                page-break-inside: avoid;
            }

            /* Optimize tables for printing */
            table {
                border-collapse: collapse;
                width: 100%;
                page-break-inside: avoid;
            }

            th, td {
                border: 1px solid #000;
                padding: 0.5rem;
                color: black !important;
                background: white !important;
            }

            th {
                background: #e0e0e0 !important;
                font-weight: bold;
            }

            /* Page breaks */
            h1, h2, h3 {
                page-break-after: avoid;
                color: black !important;
            }

            /* Show URLs for links */
            a[href]:after {
                content: " (" attr(href) ")";
            }

            /* Optimize charts for printing */
            canvas {
                max-width: 100%;
                page-break-inside: avoid;
            }

            /* Print-specific header */
            @page {
                margin: 2cm;
            }

            body::before {
                content: "Rowlett Group - Printed: " attr(data-print-date);
                display: block;
                text-align: center;
                font-size: 0.8rem;
                padding-bottom: 1rem;
                border-bottom: 1px solid #000;
                margin-bottom: 1rem;
            }
        }
    </style>
</head>
<body>
    <div id="toast-container"></div>
    <button id="back-to-top-btn" title="Go to top"><i class="fas fa-arrow-up"></i></button>
    <nav>
        <div class="logo">
            <!-- Inline SVG to display the logo in the nav -->
            <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <circle cx="50" cy="50" r="48" fill="#3498db"/>
                <text x="50" y="57" text-anchor="middle" font-size="45" fill="white" font-family="Verdana, sans-serif">R</text>
            </svg>
            <span>Rowlett Group</span>
        </div>
        <ul id="nav-menu">
            <li data-section="home-section" class="active">Home</li>

            <li class="has-dropdown">
                Meetings
                <ul class="dropdown-menu">
                    <li data-section="schedule-section">Schedule & Calendar</li>
                    <li data-section="format-rotation-section">Format Rotation</li>
                    <li data-section="companion-section">Meeting Companion</li>
                    <li data-section="commitment-board-section">Commitment Board</li>
                    <li data-section="secretary-section">Secretary Functions</li>
                </ul>
            </li>

            <li class="has-dropdown">
                Fellowship
                <ul class="dropdown-menu">
                    <li data-section="birthdays-section">Birthdays & Anniversaries</li>
                    <li data-section="announcements-section">Announcements</li>
                    <li data-section="messaging-section">Messages</li>
                    <li data-section="gallery-section">Photo Gallery</li>
                </ul>
            </li>

            <li class="has-dropdown">
                Group Conscience
                <ul class="dropdown-menu">
                    <li data-section="gc-live-section">Live GC Session</li>
                    <li data-section="parliamentary-section">Parliamentary Procedure</li>
                    <li data-section="gc-decisions-section">Decision History</li>
                    <li data-section="motion-templates-section">Motion Templates</li>
                    <li data-section="tradition-checker-section">Tradition & Concept Checker</li>
                    <li data-section="tradition-moments-section">Tradition Moments</li>
                    <li data-section="spiritual-principles-section">Spiritual Principles</li>
                    <li data-section="unity-checker-section">Unity Checker</li>
                    <li data-section="gc-inventory-section">GC Inventory</li>
                    <li data-section="gc-bylaws-section">Guidelines & By-Laws</li>
                    <li data-section="voting-settings-section">Voting Settings</li>
                </ul>
            </li>

            <li class="has-dropdown">
                Service
                <ul class="dropdown-menu">
                    <li data-section="service-positions-section">Service Positions</li>
                    <li data-section="service-elections-section">Service Elections</li>
                    <li data-section="sponsorship-section">Sponsorship Tracking</li>
                    <li data-section="district-area-section">District/Area Committee</li>
                    <li data-section="district-motions-section">District Motions</li>
                    <li data-section="service-structure-section">Service Structure</li>
                </ul>
            </li>

            <li class="has-dropdown">
                Treasury
                <ul class="dropdown-menu">
                    <li data-section="finance-section">Financial Reports</li>
                    <li data-section="budget-approval-section">Budget Approval</li>
                    <li data-section="seventh-tradition-section">7th Tradition Analysis</li>
                    <li data-section="prudent-reserve-section">Prudent Reserve</li>
                    <li data-section="chip-inventory-section">Chip Inventory</li>
                </ul>
            </li>

            <li class="has-dropdown">
                Reports
                <ul class="dropdown-menu">
                    <li data-section="chairperson-section">Chairperson Reports</li>
                    <li data-section="meeting-minutes-section">Meeting Minutes</li>
                    <li data-section="analytics-section">Group Analytics</li>
                    <li data-section="participation-analytics-section">Participation Analytics</li>
                    <li data-section="financial-health-section">Financial Health</li>
                    <li data-section="decision-impact-section">Decision Impact</li>
                    <li onclick="displayExecutiveDashboard()" style="border-top: 1px solid #7f8c8d; margin-top: 0.5rem; padding-top: 0.5rem;"><i class="fas fa-tachometer-alt"></i> Executive Dashboard</li>
                    <li onclick="openGSRDashboard()"><i class="fas fa-handshake"></i> GSR Dashboard</li>
                </ul>
            </li>

            <li class="has-dropdown">
                Resources
                <ul class="dropdown-menu">
                    <li data-section="literature-inventory-section">Literature Inventory</li>
                    <li data-section="history-section">Group History</li>
                    <li data-section="templates-section">Document Templates</li>
                    <li onclick="displayTraditionOfMonth()" style="border-top: 1px solid #7f8c8d; margin-top: 0.5rem; padding-top: 0.5rem;"><i class="fas fa-book-open"></i> Tradition of the Month</li>
                    <li onclick="scheduleGroupInventory()"><i class="fas fa-tasks"></i> Schedule Group Inventory</li>
                </ul>
            </li>

            <!-- P4-2: Universal Search -->
            <li onclick="displayUniversalSearch()" style="cursor: pointer; position: relative;" title="Universal Search">
                <i class="fas fa-search"></i>
            </li>

            <!-- P2-2: Notification Center -->
            <li onclick="showNotificationCenter()" style="cursor: pointer; position: relative;">
                <i class="fas fa-bell"></i>
                <span id="notification-badge" style="display: none; position: absolute; top: -5px; right: -5px; background: #e74c3c; color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.7rem; font-weight: bold;">0</span>
            </li>

            <li class="has-dropdown">
                <i class="fas fa-cog"></i>
                <ul class="dropdown-menu">
                    <li data-section="settings-section">General Settings</li>
                    <li data-section="privacy-section">Privacy & Anonymity</li>
                    <li data-section="quorum-management-section">Quorum Management</li>
                    <li data-section="inventory-scheduler-section">Group Inventory Scheduler</li>
                    <li data-section="role-settings-section">Role & View Settings</li>
                    <li onclick="viewBackupHistory()" style="border-top: 1px solid #7f8c8d; margin-top: 0.5rem; padding-top: 0.5rem;"><i class="fas fa-database"></i> Backup & Restore</li>
                    <li onclick="viewAuditLog()"><i class="fas fa-history"></i> Audit Log</li>
                    <li onclick="displayEngagementDashboard()"><i class="fas fa-chart-line"></i> Engagement Metrics</li>
                    <li onclick="openMeetingFeedbackSurvey()" style="border-top: 1px solid #7f8c8d; margin-top: 0.5rem; padding-top: 0.5rem;"><i class="fas fa-comment-dots"></i> Meeting Feedback Survey</li>
                    <li onclick="viewMeetingFeedbackResults()"><i class="fas fa-chart-bar"></i> View Feedback Results</li>
                    <li data-section="accessibility-section" style="border-top: 1px solid #7f8c8d; margin-top: 0.5rem; padding-top: 0.5rem;">Accessibility</li>
                </ul>
            </li>
        </ul>
    </nav>

    <main>
        <!-- Home Section -->
        <section id="home-section" class="active" style="border-left: 4px solid #3498db;">
            <h1><i class="fas fa-home"></i> Welcome to the Rowlett Group</h1>
            <p class="mb-4">This internal site serves as your one-stop hub for meeting schedules, member birthdays, group announcements, and more. All data you add here is stored locally in your browser.</p>
            <div class="grid grid-cols-2">
                <div class="box">
                    <h3>Upcoming Meetings</h3>
                    <a id="zoom-meeting-btn" href="#" class="btn" style="display: none; text-align: center; margin-bottom: 1rem;">
                        <i class="fas fa-video"></i> Start Zoom Meeting
                    </a>
                    <p id="zoom-meeting-note" style="font-size: 0.8rem; text-align: center; margin-bottom: 1rem; display: none;">(Requires Zoom to be installed)</p>
                    <ul id="home-upcoming-events" style="margin-bottom: 1rem; min-height: 60px;"></ul>
                    <button class="btn" onclick="goToSection('schedule-section')">View Full Schedule</button>
                </div>
                <div class="box">
                    <h3>Upcoming Birthdays</h3>
                    <ul id="home-upcoming-birthdays" style="margin-bottom: 1rem; min-height: 60px;"></ul>
                    <button class="btn" onclick="goToSection('birthdays-section')">Manage Birthdays</button>
                </div>
                <div class="box">
                    <h3>Recent Announcements</h3>
                    <ul id="home-recent-announcements" style="margin-bottom: 1rem; min-height: 60px;"></ul>
                    <button class="btn" onclick="goToSection('announcements-section')">View All Announcements</button>
                </div>
                <div class="box">
                    <h3>Latest Photos</h3>
                    <div id="home-latest-photos" style="display:flex; gap:0.5rem; overflow-x: auto; margin-bottom: 1rem; min-height: 60px;"></div>
                    <button class="btn" onclick="goToSection('gallery-section')">Browse Gallery</button>
                </div>
                <div id="qr-code-box" class="box" style="text-align: center; display: none;">
                    <h3>7th Tradition</h3>
                    <img id="qr-code-img" src="" alt="7th Tradition QR Code" style="width: 250px; height: 250px; margin: auto; border-radius: 8px;">
                    <p id="qr-code-contact" class="mt-2"></p>
                </div>
                <div class="box">
                    <h3>Leadership Tools</h3>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem; min-height: 60px;">
                        <button class="btn" onclick="displayExecutiveDashboard()" style="font-size: 0.9rem;">
                            <i class="fas fa-tachometer-alt"></i> Executive Dashboard
                        </button>
                        <button class="btn" onclick="openGSRDashboard()" style="font-size: 0.9rem;">
                            <i class="fas fa-handshake"></i> GSR Dashboard
                        </button>
                        <button class="btn" onclick="displayTraditionOfMonth()" style="font-size: 0.9rem;">
                            <i class="fas fa-book-open"></i> Tradition of the Month
                        </button>
                    </div>
                </div>
                <div class="box">
                    <h3>Quick Actions</h3>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem; min-height: 60px;">
                        <button class="btn" onclick="initiateEmergencyGC()" style="font-size: 0.9rem; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); font-weight: bold;">
                            <i class="fas fa-exclamation-triangle"></i> Emergency GC Protocol
                        </button>
                        <button class="btn" onclick="displayUniversalSearch()" style="font-size: 0.9rem;">
                            <i class="fas fa-search"></i> Universal Search
                        </button>
                        <button class="btn" onclick="scheduleGroupInventory()" style="font-size: 0.9rem;">
                            <i class="fas fa-tasks"></i> Schedule Group Inventory
                        </button>
                        <button class="btn" onclick="showNotificationCenter()" style="font-size: 0.9rem;">
                            <i class="fas fa-bell"></i> Notification Center
                            <span id="home-notification-badge" style="display: none; background: #e74c3c; color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.7rem; font-weight: bold; margin-left: 0.5rem;">0</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- P1: UNIFIED COMMAND CENTER DASHBOARD -->
            <div style="margin-top: 2rem;">
                <h2 style="color: #3498db; border-bottom: 2px solid #3498db; padding-bottom: 0.5rem; margin-bottom: 1.5rem;">
                    <i class="fas fa-tachometer-alt"></i> Command Center
                </h2>

                <!-- Attention Required -->
                <div class="box mb-4" style="border-left: 4px solid #e74c3c;">
                    <h3><i class="fas fa-exclamation-triangle"></i> Attention Required</h3>
                    <div id="attention-items" style="min-height: 60px;">
                        <!-- Dynamically populated -->
                    </div>
                </div>

                <!-- Upcoming Timeline -->
                <div class="box mb-4" style="border-left: 4px solid #f39c12;">
                    <h3><i class="fas fa-calendar-check"></i> Upcoming Events (Next 30 Days)</h3>
                    <div id="upcoming-timeline" style="min-height: 60px;">
                        <!-- Dynamically populated -->
                    </div>
                </div>

                <!-- Recent Activity Feed -->
                <div class="box mb-4" style="border-left: 4px solid #3498db;">
                    <h3><i class="fas fa-stream"></i> Recent Activity Feed</h3>
                    <div id="activity-feed" style="min-height: 60px;">
                        <!-- Dynamically populated -->
                    </div>
                </div>
            </div>

            <!-- GROUP HEALTH METRICS DASHBOARD -->
            <div style="margin-top: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="color: #2ecc71; border-bottom: 2px solid #2ecc71; padding-bottom: 0.5rem; margin: 0; flex: 1;">
                        <i class="fas fa-heartbeat"></i> Group Health Metrics
                    </h2>
                    <button class="btn" onclick="viewDetailedHealthReport()" style="background: #2ecc71; white-space: nowrap; margin-left: 1rem;">
                        <i class="fas fa-chart-line"></i> Detailed Report
                    </button>
                </div>

                <!-- Key Performance Indicators -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                    <!-- Participation Rate -->
                    <div class="box" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); text-align: center; padding: 1.5rem;">
                        <div style="font-size: 2rem; font-weight: bold;" id="participation-rate">--%</div>
                        <div style="font-size: 0.85rem; opacity: 0.9; margin-top: 0.5rem;">GC Participation</div>
                        <div style="font-size: 0.75rem; opacity: 0.7; margin-top: 0.25rem;">Last 3 months</div>
                    </div>

                    <!-- Decision Quality -->
                    <div class="box" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); text-align: center; padding: 1.5rem;">
                        <div style="font-size: 2rem; font-weight: bold;" id="consensus-rate">--%</div>
                        <div style="font-size: 0.85rem; opacity: 0.9; margin-top: 0.5rem;">Consensus Rate</div>
                        <div style="font-size: 0.75rem; opacity: 0.7; margin-top: 0.25rem;">Substantial unanimity</div>
                    </div>

                    <!-- Follow-Through -->
                    <div class="box" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); text-align: center; padding: 1.5rem;">
                        <div style="font-size: 2rem; font-weight: bold;" id="action-completion-rate">--%</div>
                        <div style="font-size: 0.85rem; opacity: 0.9; margin-top: 0.5rem;">Action Completion</div>
                        <div style="font-size: 0.75rem; opacity: 0.7; margin-top: 0.25rem;">On-time delivery</div>
                    </div>

                    <!-- Service Continuity -->
                    <div class="box" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); text-align: center; padding: 1.5rem;">
                        <div style="font-size: 2rem; font-weight: bold;" id="service-filled-rate">--%</div>
                        <div style="font-size: 0.85rem; opacity: 0.9; margin-top: 0.5rem;">Service Positions</div>
                        <div style="font-size: 0.75rem; opacity: 0.7; margin-top: 0.25rem;">Filled vs vacant</div>
                    </div>

                    <!-- Financial Health -->
                    <div class="box" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); text-align: center; padding: 1.5rem;">
                        <div style="font-size: 2rem; font-weight: bold;" id="prudent-reserve-status">--</div>
                        <div style="font-size: 0.85rem; opacity: 0.9; margin-top: 0.5rem;">Prudent Reserve</div>
                        <div style="font-size: 0.75rem; opacity: 0.7; margin-top: 0.25rem;">3-month operating</div>
                    </div>

                    <!-- Member Engagement -->
                    <div class="box" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); text-align: center; padding: 1.5rem; color: #2c3e50;">
                        <div style="font-size: 2rem; font-weight: bold;" id="avg-attendance">--</div>
                        <div style="font-size: 0.85rem; opacity: 0.9; margin-top: 0.5rem;">Avg. Attendance</div>
                        <div style="font-size: 0.75rem; opacity: 0.7; margin-top: 0.25rem;">Weekly meetings</div>
                    </div>
                </div>

                <!-- Health Trend Indicators -->
                <div class="box" style="border-left: 4px solid #2ecc71;">
                    <h3><i class="fas fa-chart-line"></i> Health Trends</h3>
                    <div id="health-trends" style="min-height: 100px;">
                        <!-- Dynamically populated -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Chairperson's Corner Section -->
        <section id="chairperson-section" style="border-left: 4px solid #1abc9c;">
            <h2><i class="fas fa-user-tie"></i> Chairperson's Corner</h2>
            <p class="mb-4">Track meeting attendance, contributions, and manage group affairs efficiently.</p>

            <!-- Quick Actions Bar -->
            <div style="display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 2rem; padding: 1rem; background: #2c3e50; border-radius: 6px;">
                <button class="btn" onclick="openRosterModal()">
                    <i class="fas fa-users"></i> Member Roster
                </button>
                <button class="btn" onclick="exportChairpersonLogToPDF()">
                    <i class="fas fa-file-pdf"></i> Export Report
                </button>
                <button class="btn" onclick="goToSection('gc-live-section')">
                    <i class="fas fa-gavel"></i> Live GC Session
                </button>
                <button class="btn" onclick="goToSection('gc-decisions-section')">
                    <i class="fas fa-history"></i> GC Decisions
                </button>
            </div>

            <!-- Main Content: Two Column Layout -->
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <!-- Left Column: Meeting Attendance Logging -->
                <div>
                    <div class="box" style="border-left: 4px solid #3498db;">
                        <h3><i class="fas fa-clipboard-check"></i> <span id="chairperson-form-title">Log New Meeting</span></h3>
                        <p style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 1rem;">Record attendance and contributions for each meeting.</p>

                        <div class="form-group">
                            <label for="log-date">Meeting Date *</label>
                            <input type="date" id="log-date">
                        </div>
                        <div class="form-group">
                            <label for="log-time">Meeting Time</label>
                            <input type="time" id="log-time">
                        </div>
                        <div class="form-group">
                            <label for="log-chairperson">Chairperson's Name *</label>
                            <select id="log-chairperson"></select>
                        </div>
                        <div class="form-group">
                            <label for="log-headcount"><i class="fas fa-users"></i> Head Count</label>
                            <input type="number" id="log-headcount" placeholder="0" min="0">
                        </div>
                        <div class="form-group">
                            <label for="log-7th-tradition"><i class="fas fa-hand-holding-usd"></i> 7th Tradition ($)</label>
                            <input type="number" id="log-7th-tradition" step="0.01" placeholder="0.00" min="0">
                        </div>
                        <div class="form-group">
                            <label for="log-orange-can"><i class="fas fa-donate"></i> Orange Can ($)</label>
                            <input type="number" id="log-orange-can" step="0.01" placeholder="0.00" min="0">
                        </div>
                        <input type="hidden" id="log-edit-id">
                        <div style="display: flex; gap: 0.5rem;">
                            <button id="log-form-btn" class="btn" onclick="handleChairpersonLogSubmit()">
                                <i class="fas fa-save"></i> Save Entry
                            </button>
                            <button id="log-form-cancel-btn" class="btn secondary" onclick="cancelLogEdit()" style="display:none;">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </div>

                    <!-- Meeting Log Table -->
                    <div class="box mt-4">
                        <h3><i class="fas fa-table"></i> Recent Meetings</h3>
                        <div style="overflow-x: auto; margin-top: 1rem;">
                            <table id="chairperson-log-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Time</th>
                                        <th>Chairperson</th>
                                        <th>Count</th>
                                        <th>7th Trad.</th>
                                        <th>Orange Can</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="chairperson-log-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Quick Links & Info -->
                <div>
                    <!-- Active Announcements -->
                    <div class="box" style="border-left: 4px solid #f39c12;">
                        <h3><i class="fas fa-bullhorn"></i> Active Announcements</h3>
                        <ul id="chairperson-announcements-list" style="min-height: 80px;"></ul>
                        <button class="btn" onclick="goToSection('announcements-section')" style="width: 100%; margin-top: 0.5rem;">
                            <i class="fas fa-edit"></i> Manage Announcements
                        </button>
                    </div>

                    <!-- Live GC Queue Preview -->
                    <div class="box mt-4" style="border-left: 4px solid #e74c3c;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3><i class="fas fa-gavel"></i> Live GC Queue</h3>
                            <button class="btn secondary" onclick="toggleLiveGC()" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                                <i class="fas fa-eye"></i> Toggle
                            </button>
                        </div>
                        <div id="live-gc-module" style="display: none;">
                            <div class="form-group">
                                <label for="new-business-item">Quick Add Item</label>
                                <textarea id="new-business-item" rows="2" placeholder="Describe new business..."></textarea>
                            </div>
                            <button class="btn" onclick="addNewBusinessItem()" style="width: 100%; margin-bottom: 1rem;">
                                <i class="fas fa-plus"></i> Add Item
                            </button>
                            <div style="max-height: 250px; overflow-y: auto;">
                                <table id="live-gc-table">
                                    <thead>
                                        <tr>
                                            <th>Item</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="live-gc-body"></tbody>
                                </table>
                            </div>
                        </div>
                        <button class="btn" onclick="goToSection('gc-live-section')" style="width: 100%; margin-top: 0.5rem;">
                            <i class="fas fa-arrow-right"></i> Full GC Session
                        </button>
                    </div>

                    <!-- Recent GC Decisions Preview -->
                    <div class="box mt-4" style="border-left: 4px solid #9b59b6;">
                        <h3><i class="fas fa-history"></i> Recent GC Decisions</h3>
                        <p style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 1rem;">Current month's decisions</p>
                        <div style="max-height: 300px; overflow-y: auto;">
                            <table id="gc-log-table-current" style="font-size: 0.85rem;">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Item</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="gc-log-body-current"></tbody>
                            </table>
                        </div>
                        <button class="btn" onclick="goToSection('gc-decisions-section')" style="width: 100%; margin-top: 1rem;">
                            <i class="fas fa-arrow-right"></i> View All GC Decisions
                        </button>
                    </div>
                </div>
            </div>

            <!-- Note about GC Logging -->
            <div class="box mt-4" style="background: #2c3e50; border-left: 4px solid #3498db;">
                <h4><i class="fas fa-info-circle"></i> Need to Log Group Conscience Decisions?</h4>
                <p style="margin-top: 0.5rem; margin-bottom: 1rem;">For detailed Group Conscience logging with workflow tracking, research periods, and complete voting records, please visit the dedicated GC sections.</p>
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button class="btn" onclick="goToSection('gc-live-section')">
                        <i class="fas fa-play"></i> Live GC Session
                    </button>
                    <button class="btn" onclick="goToSection('gc-decisions-section')">
                        <i class="fas fa-archive"></i> GC Decision History
                    </button>
                </div>
            </div>

            <!-- Audio Recording Tool -->
            <div class="box mt-4" style="border-left: 4px solid #2ecc71;">
                <h3><i class="fas fa-microphone"></i> Record Meeting Audio</h3>
                <p class="mb-2 text-sm" style="font-size: 0.85rem; opacity: 0.8;">Record audio from your microphone and save it as a local file for meeting minutes.</p>
                <div id="audio-recorder-controls" class="flex items-center gap-2" style="display:flex; gap: 0.5rem; align-items: center;">
                    <button id="record-btn" class="btn"><i class="fas fa-microphone" style="margin-right: 0.5rem;"></i>Start Recording</button>
                    <button id="stop-btn" class="btn secondary" disabled><i class="fas fa-stop" style="margin-right: 0.5rem;"></i>Stop</button>
                </div>
                <div id="audio-player-container" class="mt-4" style="display: none;">
                    <audio id="audio-player" controls style="width: 100%;"></audio>
                    <a id="download-link" class="btn mt-2" style="display: none;"><i class="fas fa-download" style="margin-right: 0.5rem;"></i>Download Recording</a>
                </div>
            </div>
        </section>

        <!-- Hidden GC Form Elements (for JavaScript compatibility - actual forms are in GC sections) -->
        <div style="display: none;">
            <input type="hidden" id="gc-edit-id">
            <select id="gc-workflow-status"><option value="decided">Decided</option></select>
            <input type="date" id="gc-date">
            <textarea id="gc-item"></textarea>
            <input type="text" id="gc-submitted-by">
            <input type="date" id="gc-research-start">
            <input type="date" id="gc-research-end">
            <select id="gc-status"><option value="passed">Passed</option></select>
            <input type="number" id="gc-votes-for">
            <input type="number" id="gc-votes-against">
            <input type="number" id="gc-votes-abstain">
            <select multiple id="gc-attendees"></select>
            <div id="gc-servant-reports-container"></div>
            <div id="gc-servant-reports-legacy-container"></div>
            <div id="gc-research-period-section"></div>
            <textarea id="gc-servant-reports-legacy"></textarea>
            <button id="gc-form-btn"></button>
            <button id="gc-form-cancel-btn"></button>
            <div id="vote-summary">
                <span id="total-votes"></span><span id="votes-for-count"></span><span id="percent-for"></span>
                <div id="progress-bar-for"></div><span id="votes-against-count"></span><span id="percent-against"></span>
                <div id="progress-bar-against"></div><span id="votes-abstain-count"></span><span id="percent-abstain"></span>
                <div id="progress-bar-abstain"></div><div id="quorum-status"></div>
            </div>
            <table id="gc-log-table-previous"><thead><tr><th>Date</th></tr></thead><tbody id="gc-log-body-previous"></tbody></table>
            <input type="text" id="proposed-item-title">
            <select id="proposed-item-submitter"></select>
            <textarea id="proposed-item-description"></textarea>
            <input type="number" id="proposed-item-time">
            <select id="proposed-item-urgency"></select>
            <textarea id="proposed-item-background"></textarea>
            <input type="number" id="quorum-percentage">
            <input type="number" id="quorum-minimum">
            <textarea id="action-item-description"></textarea>
            <select id="action-item-assignee"></select>
            <input type="date" id="action-item-due-date">
            <select id="action-item-priority"></select>
            <select id="action-item-related-gc"></select>
            <select id="action-item-dependencies"></select>
            <input type="hidden" id="action-item-edit-id">
            <button id="action-item-btn"></button>
            <button id="action-item-cancel-btn"></button>
            <input type="text" id="gc-search">
            <select id="gc-filter-status"></select>
            <input type="date" id="gc-filter-date-from">
            <input type="date" id="gc-filter-date-to">
            <select id="annual-report-year"></select>
            <table id="proposed-agenda-table"><tbody id="proposed-agenda-body"></tbody></table>
            <table id="action-items-table"><tbody id="action-items-body"></tbody></table>
            <table id="gc-history-search-table"><tbody id="gc-history-search-body"></tbody></table>
            <div id="gc-stats"></div>
            <div id="stat-total-motions"></div>
            <div id="stat-passed-motions"></div>
            <div id="stat-failed-motions"></div>
            <div id="stat-tabled-motions"></div>
            <div id="stat-pass-rate"></div>
            <div id="gc-top-topics"></div>
            <canvas id="gc-trends-monthly-chart"></canvas>
            <canvas id="gc-trends-status-chart"></canvas>
            <canvas id="gc-trends-participation-chart"></canvas>
            <div id="agenda-submission-notice"><span id="agenda-notice-text"></span></div>
            <input type="checkbox" id="action-item-show-completed">
            <select id="action-item-filter-assignee"></select>
        </div>
        </section>

        <!-- Meeting Companion Section -->
        <section id="companion-section" style="border-left: 4px solid #3498db;">
            <h2><i class="fas fa-book-open"></i> Meeting Companion</h2>
            <p class="mb-4">Select a meeting type to view the format and readings.</p>
            <div id="meeting-format-buttons" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                <button class="btn" onclick="showMeetingFormat('open-discussion')">Open Discussion</button>
                <button class="btn" onclick="showMeetingFormat('closed-discussion')">Closed Discussion</button>
                <button class="btn" onclick="showMeetingFormat('big-book')">Big Book Study</button>
                <button class="btn" onclick="showMeetingFormat('12x12')">12x12 Study</button>
                <button class="btn" onclick="showMeetingFormat('personal-story')">Personal Story</button>
                <button class="btn" onclick="showMeetingFormat('foundations')">Foundations Speaker</button>
                <button class="btn" onclick="showMeetingFormat('birthday')">Birthday Night</button>
            </div>
            <h3 class="mt-4">Readings</h3>
            <div id="reading-buttons" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                <button class="btn" onclick="showMeetingFormat('how-it-works')">How It Works</button>
                <button class="btn" onclick="showMeetingFormat('traditions')">The 12 Traditions</button>
                <button class="btn" onclick="showMeetingFormat('promises')">The 9th Step Promises</button>
            </div>

            <h3 class="mt-4">Dictionary</h3>
            <div class="box mt-4">
                <div class="form-group" style="display: flex; gap: 0.5rem;">
                    <input type="text" id="dictionary-search-word" placeholder="Enter a word..." style="flex-grow: 1;">
                    <button id="dictionary-search-btn" class="btn">Search</button>
                </div>
                <div id="dictionary-results" class="mt-4"></div>
            </div>

            <div id="meeting-format-display" class="box mt-4" style="display: none;">
                <!-- Meeting format will be injected here -->
            </div>
        </section>

        <!-- Schedule Section -->
        <section id="schedule-section" style="border-left: 4px solid #3498db;">
            <h2><i class="fas fa-calendar-alt"></i> Schedule of Meetings & Events</h2>
            <p class="mb-2">Add recurring weekly meetings or special one-time events. Use the calendar to browse by month. Upcoming events for the next 60 days are listed below.</p>

            <!-- Calendar Controls -->
            <div id="calendar-controls" style="display:flex; align-items:center; justify-content: space-between; gap:0.5rem; margin-bottom:0.5rem;">
                <button class="btn secondary" id="prev-month-btn">&lt; Prev</button>
                <h3 id="calendar-month-year" style="flex:1; text-align:center;"></h3>
                <button class="btn secondary" id="next-month-btn">Next &gt;</button>
            </div>
            <div id="calendar-grid"></div>

            <button class="btn" onclick="toggleEventForm()" style="margin-top: 1rem;">Add New Event</button>
            <div id="add-event-form" class="box" style="display:none; margin-top: 1rem;">
                <div class="form-group">
                    <label for="event-title">Title</label>
                    <input type="text" id="event-title" placeholder="e.g. Big Book Study" />
                </div>
                <div class="form-group">
                    <label for="event-date">Date (leave blank for weekly)</label>
                    <input type="date" id="event-date" />
                </div>
                <div class="form-group">
                    <label for="event-day">Day of Week (for weekly meetings)</label>
                    <select id="event-day">
                        <option value="">--Select day--</option>
                        <option value="0">Sunday</option>
                        <option value="1">Monday</option>
                        <option value="2">Tuesday</option>
                        <option value="3">Wednesday</option>
                        <option value="4">Thursday</option>
                        <option value="5">Friday</option>
                        <option value="6">Saturday</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="event-time">Time</label>
                    <input type="time" id="event-time" />
                </div>
                <div class="form-group">
                    <label for="event-category">Category</label>
                    <select id="event-category">
                        <option value="General">General</option>
                        <option value="Open Discussion">Open Discussion</option>
                        <option value="Closed Discussion">Closed Discussion</option>
                        <option value="Big Book Study">Big Book Study</option>
                        <option value="12x12 Study">12x12 Study</option>
                        <option value="Personal Story">Personal Story</option>
                        <option value="Foundations Speaker">Foundations Speaker</option>
                        <option value="Birthday Night">Birthday Night</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="event-reading">Reading</label>
                    <input type="text" id="event-reading" placeholder="e.g. How It Works" />
                </div>
                <div class="form-group">
                    <label for="event-speaker">Speaker</label>
                    <select id="event-speaker"></select>
                </div>
                <div class="form-group">
                    <label for="event-chair">Chairperson</label>
                    <select id="event-chair"></select>
                </div>
                <div class="form-group">
                    <label for="event-description">Description</label>
                    <textarea id="event-description" rows="2" placeholder="Notes or description..."></textarea>
                </div>
                <input type="hidden" id="event-edit-id">
                <button id="event-form-btn" class="btn" onclick="handleEventSubmit()">Add Event</button>
                <button id="event-form-cancel-btn" class="btn secondary" onclick="cancelEventEdit()" style="display:none; margin-left: 0.5rem;">Cancel</button>
            </div>

            <h3 class="mt-4">Upcoming Events (Next 30 Days)</h3>
            <div class="form-group">
                <label for="category-filter">Filter by Category</label>
                <select id="category-filter" onchange="updateEventsTable()">
                    <option value="All">All Categories</option>
                    <option value="General">General</option>
                    <option value="Open Discussion">Open Discussion</option>
                    <option value="Closed Discussion">Closed Discussion</option>
                    <option value="Big Book Study">Big Book Study</option>
                    <option value="12x12 Study">12x12 Study</option>
                    <option value="Personal Story">Personal Story</option>
                    <option value="Foundations Speaker">Foundations Speaker</option>
                    <option value="Birthday Night">Birthday Night</option>
                </select>
            </div>
            <table id="events-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Title</th>
                        <th>Category</th>
                        <th>Time</th>
                        <th>Speaker</th>
                        <th>Chair</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="events-body"></tbody>
            </table>
        </section>

        <!-- Members Section -->
        <section id="birthdays-section" style="border-left: 4px solid #f39c12;">
            <h2><i class="fas fa-birthday-cake"></i> Member Roster & Birthdays</h2>
            <p class="mb-2">Add and manage member information and see upcoming sobriety birthdays.</p>
            <button class="btn" onclick="toggleMemberForm()">Add Member</button>
            <div id="add-member-form" class="box" style="display:none; margin-top: 1rem;">
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <div class="form-group">
                            <label for="member-name">Name*</label>
                            <input type="text" id="member-name" placeholder="Member's name" />
                        </div>
                        <div class="form-group">
                            <label for="member-birthday">Sobriety Date*</label>
                            <input type="date" id="member-birthday" />
                        </div>
                        <div class="form-group">
                            <label for="member-phone">Phone Number</label>
                            <input type="tel" id="member-phone" placeholder="e.g., 123-456-7890" />
                        </div>
                        <div class="form-group">
                            <label for="member-email">Email</label>
                            <input type="email" id="member-email" placeholder="member@example.com" />
                        </div>
                    </div>
                    <div>
                        <div class="form-group">
                            <label for="member-city">City</label>
                            <input type="text" id="member-city" placeholder="e.g., Rowlett" />
                        </div>
                        <div class="form-group">
                            <label for="member-homegroup">Homegroup</label>
                            <input type="text" id="member-homegroup" placeholder="e.g., The Rowlett Group" />
                        </div>
                        <div class="form-group">
                            <label for="member-sponsor">Sponsor</label>
                            <input type="text" id="member-sponsor" placeholder="Sponsor's name" />
                        </div>
                    </div>
                </div>
                <div class="box" style="margin-top: 1rem; border-top: 1px solid #7f8c8d; padding-top: 1rem;">
                    <h4 class="font-bold">Service Position</h4>
                    <div class="form-group" style="display: flex; align-items: center; gap: 1rem;">
                        <input type="checkbox" id="member-is-servant" style="width: auto;"/>
                        <label for="member-is-servant">Is this member a current servant?</label>
                    </div>
                    <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="member-servant-position">Position</label>
                            <input type="text" id="member-servant-position" placeholder="e.g., Treasurer" />
                        </div>
                        <div class="form-group">
                            <label for="member-servant-since">Serving Since</label>
                            <input type="date" id="member-servant-since" />
                        </div>
                    </div>
                </div>
                <input type="hidden" id="member-edit-id">
                <button id="member-form-btn" class="btn" onclick="handleMemberSubmit()">Add Member</button>
                <button id="member-form-cancel-btn" class="btn secondary" onclick="cancelMemberEdit()" style="display:none; margin-left: 0.5rem;">Cancel</button>
            </div>
            
            <h3 class="mt-4">Upcoming & Recent Birthdays</h3>
            <table id="birthdays-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Sobriety Date</th>
                        <th>Next Birthday</th>
                        <th>Years</th>
                        <th>Sober Time</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="birthdays-body"></tbody>
            </table>
        </section>

        <!-- Announcements Section -->
        <section id="announcements-section" style="border-left: 4px solid #f39c12;">
            <h2><i class="fas fa-bullhorn"></i> Announcements</h2>
            <div class="form-group">
                <label for="announcement-text">Announcement</label>
                <textarea id="announcement-text" rows="2" placeholder="Enter announcement..."></textarea>
            </div>
            <div class="form-group">
                <label for="announcement-priority">Priority Level</label>
                <select id="announcement-priority">
                    <option value="info">Info</option>
                    <option value="normal">Normal</option>
                    <option value="urgent">Urgent</option>
                </select>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="announcement-require-read-receipt" />
                    Require read receipt (for important announcements)
                </label>
            </div>
            <button class="btn" onclick="addAnnouncement()">Add Announcement</button>

            <h3 class="mt-4">Current Announcements</h3>
            <ul id="announcements-list"></ul>
        </section>

        <!-- Member Messaging Section -->
        <section id="messaging-section" style="border-left: 4px solid #f39c12;">
            <h2><i class="fas fa-comments"></i> Member Messaging</h2>
            <p>Send messages to other members for service work coordination.</p>

            <div class="form-group">
                <label for="message-recipient">Send to:</label>
                <select id="message-recipient">
                    <option value="">Select a member...</option>
                </select>
            </div>
            <div class="form-group">
                <label for="message-subject">Subject</label>
                <input type="text" id="message-subject" placeholder="Message subject..." />
            </div>
            <div class="form-group">
                <label for="message-text">Message</label>
                <textarea id="message-text" rows="4" placeholder="Your message..."></textarea>
            </div>
            <button class="btn" onclick="sendMessage()">Send Message</button>

            <h3 class="mt-4">Messages</h3>
            <div class="history-nav">
                <button onclick="showMessages('inbox')" class="active" id="inbox-btn">Inbox</button>
                <button onclick="showMessages('sent')" id="sent-btn">Sent</button>
            </div>
            <div id="messages-container"></div>
        </section>

        <!-- Service Positions Section -->
        <section id="service-positions-section" style="border-left: 4px solid #2ecc71;">
            <h2><i class="fas fa-users-cog"></i> Service Position Management</h2>

            <h3>Add/Edit Service Position</h3>
            <div class="form-group">
                <label for="position-name">Position Name</label>
                <input type="text" id="position-name" placeholder="e.g., Chairperson, Secretary, Treasurer..." />
            </div>
            <div class="form-group">
                <label for="position-description">Description & Responsibilities</label>
                <textarea id="position-description" rows="4" placeholder="Enter position responsibilities..."></textarea>
            </div>
            <div class="form-group">
                <label for="position-term-length">Term Length (months)</label>
                <input type="number" id="position-term-length" placeholder="6" min="1" />
            </div>
            <div class="form-group">
                <label for="position-current-holder">Current Holder</label>
                <select id="position-current-holder">
                    <option value="">Vacant</option>
                </select>
            </div>
            <div class="form-group">
                <label for="position-start-date">Term Start Date</label>
                <input type="date" id="position-start-date" />
            </div>
            <button class="btn" onclick="addServicePosition()">Add Position</button>

            <h3 class="mt-4">Current Service Positions</h3>
            <table>
                <thead>
                    <tr>
                        <th>Position</th>
                        <th>Current Holder</th>
                        <th>Term Start</th>
                        <th>Term End</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="service-positions-table"></tbody>
            </table>

            <h3 class="mt-4">Rotation Calendar</h3>
            <p>Upcoming position elections (positions coming up in next 60 days)</p>
            <div id="rotation-calendar"></div>

            <h3 class="mt-4">Nomination System</h3>
            <div class="form-group">
                <label for="nomination-position">Position</label>
                <select id="nomination-position">
                    <option value="">Select position...</option>
                </select>
            </div>
            <div class="form-group">
                <label for="nomination-nominee">Nominee</label>
                <select id="nomination-nominee">
                    <option value="">Select member...</option>
                </select>
            </div>
            <button class="btn" onclick="addNomination()">Submit Nomination</button>

            <h3 class="mt-4">Current Nominations</h3>
            <div id="nominations-list"></div>
        </section>

        <!-- Finance Section -->
        <section id="finance-section" style="border-left: 4px solid #f1c40f;">
            <h2><i class="fas fa-money-bill-wave"></i> Financial Tracking</h2>

            <div class="history-nav">
                <button onclick="showFinanceTab('budget')" class="active" id="budget-tab">Budget</button>
                <button onclick="showFinanceTab('expenses')" id="expenses-tab">Expenses</button>
                <button onclick="showFinanceTab('reports')" id="reports-tab">Reports</button>
            </div>

            <div id="budget-content" class="finance-tab active">
                <h3>Budget Management</h3>
                <div class="form-group">
                    <label for="budget-category">Category</label>
                    <input type="text" id="budget-category" placeholder="e.g., Rent, Literature, Refreshments..." />
                </div>
                <div class="form-group">
                    <label for="budget-amount">Monthly Budget Amount</label>
                    <input type="number" id="budget-amount" placeholder="0.00" step="0.01" min="0" />
                </div>
                <button class="btn" onclick="addBudgetCategory()">Add Budget Category</button>

                <h3 class="mt-4">Current Budget</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Monthly Budget</th>
                            <th>Spent This Month</th>
                            <th>Remaining</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="budget-table"></tbody>
                </table>
            </div>

            <div id="expenses-content" class="finance-tab">
                <h3>Log Expense</h3>
                <div class="form-group">
                    <label for="expense-date">Date</label>
                    <input type="date" id="expense-date" />
                </div>
                <div class="form-group">
                    <label for="expense-category">Category</label>
                    <select id="expense-category">
                        <option value="">Select category...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="expense-description">Description</label>
                    <input type="text" id="expense-description" placeholder="What was purchased..." />
                </div>
                <div class="form-group">
                    <label for="expense-amount">Amount</label>
                    <input type="number" id="expense-amount" placeholder="0.00" step="0.01" min="0" />
                </div>
                <button class="btn" onclick="addExpense()">Log Expense</button>

                <h3 class="mt-4">Recent Expenses</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Category</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="expenses-table"></tbody>
                </table>
            </div>

            <div id="reports-content" class="finance-tab">
                <h3>Financial Reports</h3>
                <div class="form-group">
                    <label for="report-month">Select Month</label>
                    <input type="month" id="report-month" />
                </div>
                <button class="btn" onclick="generateMonthlyReport()">Generate Report</button>

                <!-- Quick Win #1: Monthly Treasurer Report -->
                <div class="box mt-4" style="background: #34495e; padding: 1rem; border-left: 4px solid #3498db;">
                    <h4 style="color: #3498db; margin: 0 0 0.5rem 0;">📋 Monthly Treasurer Report</h4>
                    <p style="color: #ecf0f1; font-size: 0.9rem; margin: 0 0 1rem 0;">
                        Generate comprehensive treasurer reports with budget analysis and prudent reserve status
                    </p>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn" onclick="displayTreasurerReport()" style="background: #3498db;">
                            <i class="fas fa-file-alt"></i> View Report
                        </button>
                        <button class="btn" onclick="exportTreasurerReportPDF()" style="background: #2ecc71;">
                            <i class="fas fa-file-pdf"></i> Export PDF
                        </button>
                    </div>
                </div>

                <div id="monthly-report" class="box mt-4"></div>

                <h3 class="mt-4">Year-over-Year Comparison</h3>
                <div id="yoy-chart" class="box"></div>
            </div>
        </section>

        <!-- Meeting Format Templates Section -->
        <section id="templates-section" style="border-left: 4px solid #95a5a6;">
            <h2><i class="fas fa-file-alt"></i> Meeting Format Templates</h2>

            <h3>Create/Edit Template</h3>
            <div class="form-group">
                <label for="template-name">Template Name</label>
                <input type="text" id="template-name" placeholder="e.g., Speaker Meeting, Step Study, Big Book..." />
            </div>
            <div class="form-group">
                <label for="template-type">Template Type</label>
                <select id="template-type">
                    <option value="meeting-format">Meeting Format</option>
                    <option value="speaker-checklist">Speaker Meeting Checklist</option>
                    <option value="event-planning">Event Planning</option>
                </select>
            </div>
            <div class="form-group">
                <label for="template-content">Template Content</label>
                <textarea id="template-content" rows="10" placeholder="Enter template content..."></textarea>
            </div>
            <button class="btn" onclick="saveTemplate()">Save Template</button>

            <h3 class="mt-4">Saved Templates</h3>
            <div class="history-nav">
                <button onclick="filterTemplates('all')" class="active" id="all-templates-btn">All</button>
                <button onclick="filterTemplates('meeting-format')" id="meeting-templates-btn">Meeting Formats</button>
                <button onclick="filterTemplates('speaker-checklist')" id="speaker-templates-btn">Speaker Checklists</button>
                <button onclick="filterTemplates('event-planning')" id="event-templates-btn">Event Planning</button>
            </div>
            <div id="templates-list"></div>
        </section>

        <!-- Gallery Section -->
        <section id="gallery-section" style="border-left: 4px solid #f39c12;">
            <h2><i class="fas fa-images"></i> Photo Gallery</h2>
            <p class="mb-2">Upload pictures of fliers or events. Add comma-separated tags to help organize them.</p>
            <div class="form-group">
                <label for="photo-upload">Select Photos</label>
                <input type="file" id="photo-upload" accept="image/*" multiple />
            </div>
            <div class="form-group">
                <label for="photo-tags">Tags (comma-separated)</label>
                <input type="text" id="photo-tags" placeholder="e.g. bbq, anniversary, 2024" />
            </div>
            <button class="btn" onclick="uploadPhotos()">Upload Selected</button>

            <h3 class="mt-4">Filter Photos</h3>
            <div class="form-group">
                <input type="text" id="tag-filter" onkeyup="updateGallery()" placeholder="Filter by tag..." />
            </div>
            <div id="tag-list" class="mb-4"></div>

            <h3 class="mt-4">Photos</h3>
            <div id="gallery-grid"></div>
        </section>

        <!-- The Modal -->
        <div id="photo-modal" class="modal">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <a class="prev" onclick="showPreviousPhoto()">&#10094;</a>
            <a class="next" onclick="showNextPhoto()">&#10095;</a>
            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; max-width: 90vw; max-height: 90vh;">
                <img class="modal-content" id="modal-image" style="max-height: 80vh; object-fit: contain;">
                <div id="modal-caption" style="text-align: center; color: #ccc; padding: 10px 0; font-size: 1rem; height: 2rem;"></div>
            </div>
        </div>

        <!-- History Section -->
        <section id="history-section" style="border-left: 4px solid #95a5a6;">
            <h2><i class="fas fa-history"></i> History &amp; Resources</h2>
            <!-- History navigation buttons for different timelines -->
            <div class="history-nav">
                <button id="genesis-btn" onclick="showHistory('genesis-history')">Genesis of AA</button>
                <button id="dfw-btn" onclick="showHistory('dfw-history')">Dallas/Fort Worth History</button>
                <button id="rowlett-btn" onclick="showHistory('rowlett-history')">Rowlett Group History</button>
            </div>
            <!-- Embedded histories (hidden by default, toggled via showHistory()) -->
            <div id="genesis-history" class="history-content">
                <h3 class="mb-4 font-bold text-xl">The Genesis of Alcoholics Anonymous</h3>
                <!-- Genesis timeline -->
                <div class="timeline-wrapper">
                <div class="timeline-container">
                
                            <!-- Event 1: 1895 - Bill W. Born -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-blue-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-blue-400 pb-1 mb-2">William Griffith Wilson's Birth</h4>
                                        <p class="text-sm">Born in East Dorset, Vermont. His early life was marked by feelings of isolation and a strong drive for recognition, factors that would later influence his drinking and recovery.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-blue-800">Nov 26, 1895: Bill W. Born <i class="fa-solid fa-baby ml-2 text-blue-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Birth of William Griffith Wilson, co-founder of Alcoholics Anonymous.</p>
                                </div>
                            </div>
                
                            <!-- Event 2: 1879 - Dr. Bob Born -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-purple-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-purple-400 pb-1 mb-2">Robert Holbrook Smith's Birth</h4>
                                        <p class="text-sm">Born in St. Johnsbury, Vermont. He would later become a respected surgeon in Akron, Ohio, and co-founder of AA, despite his long struggle with alcoholism.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-purple-800">Aug 8, 1879: Dr. Bob Born <i class="fa-solid fa-baby ml-2 text-purple-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Birth of Robert Holbrook Smith, co-founder of Alcoholics Anonymous.</p>
                                </div>
                            </div>
                
                            <!-- Event 3: Early 1900s - Bill W.'s Descent & Marriage -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-green-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-green-400 pb-1 mb-2">Bill's Struggle & Lois Wilson</h4>
                                        <p class="text-sm">Bill's drinking progresses, leading to severe consequences. He marries Lois Burnham Wilson in 1918, who would become a steadfast supporter and co-founder of Al-Anon.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-green-800">1910s-30s: Bill's Descent & Lois <i class="fa-solid fa-ring ml-2 text-green-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Bill's alcoholism escalates, bringing financial ruin and repeated hospitalizations, deeply impacting his wife, Lois.</p>
                                </div>
                            </div>
                
                            <!-- Event 4: Early 1900s - Dr. Bob's Hidden Battle & Marriage -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-teal-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-teal-400 pb-1 mb-2">Dr. Bob's Hidden Battle & Anne Smith</h4>
                                        <p class="text-sm">Dr. Bob's alcoholism becomes a decades-long struggle, hidden from many. He marries Anne Ripley Smith, who would become a crucial figure in early AA and Al-Anon, supporting his recovery efforts.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-teal-800">1910s-30s: Dr. Bob's Struggle & Anne <i class="fa-solid fa-house-medical-flag ml-2 text-teal-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Dr. Bob battles severe, often hidden, alcoholism despite his medical career, supported by his wife, Anne.</p>
                                </div>
                            </div>
                
                            <!-- Event 5: November 1934 - Ebby T.'s Visit & Bill's Turning Point -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-cyan-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-cyan-400 pb-1 mb-2">The Spiritual Solution Introduced</h4>
                                        <p class="text-sm">Bill's old drinking friend, Ebby T., visits him, sober, and introduces the idea of a spiritual solution, learned from the Oxford Group. This plants the seed for Bill's own spiritual awakening.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-cyan-800">Nov 1934: Ebby T. & Bill's Shift <i class="fa-solid fa-hand-holding-heart ml-2 text-cyan-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Ebby T. visits Bill, sharing his newfound sobriety through a spiritual experience, igniting hope in Bill during his deepest despair.</p>
                                </div>
                            </div>
                
                            <!-- Event 6: December 1934 - Bill's Spiritual Awakening -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-yellow-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-yellow-400 pb-1 mb-2">The "White Light" Experience</h4>
                                        <p class="text-sm">While hospitalized in Towns Hospital, Bill experiences a profound spiritual awakening after crying out to God in desperation. The obsession with alcohol is lifted, and he finds immediate sobriety.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-yellow-800">Dec 1934: Bill's Awakening <i class="fa-solid fa-lightbulb ml-2 text-yellow-500"></i></h2>
                                    <p class="mt-2 text-slate-700">In Towns Hospital, Bill W. has a powerful spiritual experience that removes his obsession to drink, marking his last drink.</p>
                                </div>
                            </div>
                
                            <!-- Event 7: Early 1935 - Bill's Early Attempts & The Paradox -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-orange-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-orange-400 pb-1 mb-2">The Helper Therapy Principle</h4>
                                        <p class="text-sm">Bill's initial attempts to "convert" other alcoholics fail until he realizes he must share his experience with empathy, not preach. He discovers that helping others is crucial for his own sobriety.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-orange-800">Early 1935: The Paradox Discovered <i class="fa-solid fa-person-digging ml-2 text-orange-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Bill learns that helping other alcoholics is essential for maintaining his own sobriety, laying the groundwork for AA's core service principle.</p>
                                </div>
                            </div>
                
                            <!-- Event 8: May 1935 - Bill W. Meets Dr. Bob (AA's Founding) -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-red-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-red-400 pb-1 mb-2">The Birth of AA</h4>
                                        <p class="text-sm">During a business trip to Akron, Bill, desperate to help another alcoholic to stay sober himself, is introduced to Dr. Bob by Henrietta Seiberling. Their shared experience and mutual need ignite the spark of Alcoholics Anonymous.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-red-800">May 1935: AA is Born <i class="fa-solid fa-handshake ml-2 text-red-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Bill W. meets Dr. Bob in Akron, Ohio. Their first conversation and shared experience mark the official founding of Alcoholics Anonymous.</p>
                                </div>
                            </div>
                
                            <!-- Event 9: June 10, 1935 - Dr. Bob's Last Drink -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-indigo-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-indigo-400 pb-1 mb-2">The Last Drink</h4>
                                        <p class="text-sm">After continued discussions with Bill and a final relapse, Dr. Bob takes his last drink on June 10, 1935, achieving continuous sobriety. This date is celebrated as AA's founding day.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-indigo-800">June 10, 1935: Dr. Bob Sober <i class="fa-solid fa-calendar-check ml-2 text-indigo-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Dr. Bob takes his last drink, achieving continuous sobriety and solidifying the foundation of the new fellowship.</p>
                                </div>
                            </div>
                
                            <!-- Event 10: June 1935 Onwards - The First AA Group in Akron -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-purple-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-purple-400 pb-1 mb-2">Working with Others</h4>
                                        <p class="text-sm">Bill and Dr. Bob begin working with other alcoholics, primarily at Akron City Hospital. They apply their principles of sharing experience, spiritual transformation, and mutual support, forming the nucleus of the first AA group.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-purple-800">June 1935+: Akron Group <i class="fa-solid fa-hospital ml-2 text-purple-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Bill and Dr. Bob begin intensive work with other alcoholics, particularly in hospitals, forming the first AA group in Akron.</p>
                                </div>
                            </div>
                
                            <!-- Event 11: Late 1930s - Evolution of the Twelve Steps -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-green-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-green-400 pb-1 mb-2">From Oxford Group to AA's Principles</h4>
                                        <p class="text-sm">The Twelve Steps evolved from the six principles of the Oxford Group, a spiritual movement that influenced early AA. Bill W. expanded and formalized these into the Twelve Steps, making them more specific to alcoholism and accessible to a wider audience, including those without a traditional religious background.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-green-800">Late 1930s: Steps Evolve <i class="fa-solid fa-scroll ml-2 text-green-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The Twelve Steps are developed and formalized by Bill W., building on earlier spiritual principles.</p>
                                </div>
                            </div>
                
                            <!-- Event 12: 1938-1939 - Drafting of the Twelve Steps -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-teal-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-teal-400 pb-1 mb-2">Codifying the Program</h4>
                                        <p class="text-sm">Bill W., with input from Dr. Bob and early members, drafts the Twelve Steps, codifying the spiritual principles and actions necessary for recovery. These steps become the core program of AA.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-teal-800">1938-1939: Twelve Steps Drafted <i class="fa-solid fa-list-ol ml-2 text-teal-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The Twelve Steps are formally drafted, outlining the program of recovery for alcoholics.</p>
                                </div>
                            </div>
                
                            <!-- Event 13: April 1939 - Publication of "Alcoholics Anonymous" (First Edition) -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-cyan-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-cyan-400 pb-1 mb-2">Carrying the Message to the World</h4>
                                        <p class="text-sm">The foundational text, "Alcoholics Anonymous" (the Big Book), is published. It details the problem of alcoholism, the spiritual solution, and the Twelve Steps, making the program accessible to a wider audience.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-cyan-800">Apr 1939: Big Book (1st Ed.) <i class="fa-solid fa-book-open ml-2 text-cyan-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The book "Alcoholics Anonymous" is published, providing the definitive text for the fellowship's program of recovery.</p>
                                </div>
                            </div>
                
                            <!-- Event 14: Late 1930s - 1940s - Growth & Emergence of Traditions -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-yellow-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-yellow-400 pb-1 mb-2">Maintaining Unity</h4>
                                        <p class="text-sm">As AA grows rapidly, issues of group autonomy, money, and public relations arise. The Twelve Traditions emerge informally and are later codified to ensure the unity and survival of the fellowship.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-yellow-800">1930s-40s: Traditions Emerge <i class="fa-solid fa-users-line ml-2 text-yellow-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Rapid growth leads to the development of the Twelve Traditions, guiding AA's groups and preserving its unity.</p>
                                </div>
                            </div>
                
                            <!-- Event 15: Nov 16, 1950 - Dr. Bob's Passing -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-orange-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-orange-400 pb-1 mb-2">A Legacy of Service</h4>
                                        <p class="text-sm">Dr. Bob passes away in Akron, Ohio, having maintained continuous sobriety since June 10, 1935. His life of dedicated service, particularly in hospitals, leaves an enduring legacy as AA's co-founder.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-orange-800">Nov 16, 1950: Dr. Bob Passes <i class="fa-solid fa-cross ml-2 text-orange-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Dr. Bob, co-founder of AA, passes away, having achieved continuous sobriety and dedicated his life to helping others.</p>
                                </div>
                            </div>
                
                            <!-- Event 16: 1953 - Publication of "Twelve Steps and Twelve Traditions" -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-red-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-red-400 pb-1 mb-2">Deeper Understanding & Guidance</h4>
                                        <p class="text-sm">Written by Bill W., this book provides detailed interpretations and historical context for both the Twelve Steps and the Twelve Traditions. It was created to offer members a deeper understanding of the spiritual principles and the guidelines for group unity, helping AA mature as a fellowship.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-red-800">1953: 12 & 12 Published <i class="fa-solid fa-book-bookmark ml-2 text-red-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The "Twelve Steps and Twelve Traditions" book is published, offering deeper insights into the program and guiding principles.</p>
                                </div>
                            </div>
                
                            <!-- Event 17: 1955 - Publication of "Alcoholics Anonymous" (Second Edition) -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-indigo-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-indigo-400 pb-1 mb-2">Growth and Traditions</h4>
                                        <p class="text-sm">The second edition of the Big Book is published, reflecting AA's significant growth and including the formalized Twelve Traditions.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-indigo-800">1955: Big Book (2nd Ed.) <i class="fa-solid fa-book-reader ml-2 text-indigo-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The second edition of the Big Book is released, documenting AA's growth and formally including the Twelve Traditions.</p>
                                </div>
                            </div>
                
                            <!-- Event 18: 1950s - Development of Concepts for World Service -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-purple-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-purple-400 pb-1 mb-2">Guiding Global Service</h4>
                                        <p class="text-sm">Bill W. develops the Twelve Concepts for World Service to provide a framework for AA's growing global service structure, ensuring effective leadership and decision-making while maintaining group autonomy.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-purple-800">1950s: World Service Concepts <i class="fa-solid fa-globe ml-2 text-purple-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The Twelve Concepts for World Service are developed to guide AA's expanding global service structure.</p>
                                </div>
                            </div>
                
                            <!-- Event 19: 1971 - Bill W.'s Passing -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-green-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-green-400 pb-1 mb-2">A Founder's Legacy</h4>
                                        <p class="text-sm">Bill W. passes away in Miami Beach, Florida. His vision and dedication led to the founding of AA and its global spread, leaving an immeasurable legacy for millions in recovery.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-green-800">Jan 24, 1971: Bill W. Passes <i class="fa-solid fa-person-praying ml-2 text-green-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Bill W., co-founder of AA, passes away, leaving behind a global fellowship dedicated to sobriety.</p>
                                </div>
                            </div>
                
                            <!-- Event 20: 1976 - Publication of "Alcoholics Anonymous" (Third Edition) -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-teal-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-teal-400 pb-1 mb-2">Continued Expansion</h4>
                                        <p class="text-sm">The third edition of the Big Book is published, reflecting further growth in AA membership worldwide and reaffirming the unchanging core principles.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-teal-800">1976: Big Book (3rd Ed.) <i class="fa-solid fa-book-bookmark ml-2 text-teal-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The third edition of the Big Book is released, documenting AA's continued expansion.</p>
                                </div>
                            </div>
                
                            <!-- Event 21: 2001 - Publication of "Alcoholics Anonymous" (Fourth Edition) -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-cyan-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-cyan-400 pb-1 mb-2">Into the New Millennium</h4>
                                        <p class="text-sm">The fourth edition of the Big Book is published, highlighting AA's global reach into the new millennium and the enduring power of its message.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-cyan-800">2001: Big Book (4th Ed.) <i class="fa-solid fa-book-atlas ml-2 text-cyan-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The fourth edition of the Big Book is released, marking AA's presence worldwide at the turn of the millennium.</p>
                                </div>
                            </div>
                
                        </div>
                </div>
            </div>
            <div id="dfw-history" class="history-content">
                <h3 class="mb-4 font-bold text-xl">Dallas/Fort Worth AA History</h3>
                <!-- Dallas/Fort Worth timeline -->
                <div class="timeline-wrapper">
                <div class="timeline-container">
                
                            <!-- Event 1: 1940 - AA Comes to Houston -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-blue-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-blue-400 pb-1 mb-2">Texas Roots</h4>
                                        <p class="text-sm">The first documented AA group in Texas forms in Houston with Larry Jewell. This is significant as Esther E., a key figure in Dallas AA, sobered up here before moving to Dallas.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-blue-800">1940: AA in Houston <i class="fa-solid fa-map-pin ml-2 text-blue-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The first AA group in Texas is established in Houston.</p>
                                </div>
                            </div>
                
                            <!-- Event 2: June 14, 1941 - Ruth T.'s Letter (Dallas) -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-purple-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-purple-400 pb-1 mb-2">First Dallas Outreach</h4>
                                        <p class="text-sm">Ruth T., a Dallas alcoholic, sends the first recorded letter from Dallas to Ruth Hock, Bill W.'s secretary in New York, inquiring about AA activity in the area. This marks the initial plea for help from Dallas.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-purple-800">Jun 14, 1941: Ruth T.'s Plea <i class="fa-solid fa-envelope ml-2 text-purple-500"></i></h2>
                                    <p class="mt-2 text-slate-700">First recorded outreach from Dallas to AA General Service Office.</p>
                                </div>
                            </div>
                
                            <!-- Event 3: 1941 - First Fort Worth Group (Hazy History) -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-green-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-green-400 pb-1 mb-2">Fort Worth's Early Beginnings</h4>
                                        <p class="text-sm">George McL. is credited with starting the first AA group in Fort Worth. Early history is "hazy," but correspondence details an initial meeting with seven attendees.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-green-800">1941: Fort Worth's First Group <i class="fa-solid fa-users ml-2 text-green-500"></i></h2>
                                    <p class="mt-2 text-slate-700">George McL. is credited with starting the first AA group in Fort Worth.</p>
                                </div>
                            </div>
                
                            <!-- Event 4: Dec 1, 1941 - Kent W.'s Arrival (Dallas) -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-teal-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-teal-400 pb-1 mb-2">Energetic but Fleeting Efforts</h4>
                                        <p class="text-sm">Kent W., a sober AA member from Florida, moves to Dallas and eagerly begins promoting AA in local media, planning meetings, and even titled himself "Chief Sponsor" of Dallas AA.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-teal-800">Dec 1, 1941: Kent W. in Dallas <i class="fa-solid fa-bullhorn ml-2 text-teal-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Kent W. arrives in Dallas, eager to establish an AA group.</p>
                                </div>
                            </div>
                
                            <!-- Event 5: Jan 7, 1942 - First Recorded Dallas Meeting (Kent W.) -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-cyan-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-cyan-400 pb-1 mb-2">Initial Surge and Disappearance</h4>
                                        <p class="text-sm">Kent W. holds the first recorded AA meeting in Dallas at the White Plaza Hotel, attended by 12 people. A Dallas Morning News story sparks 72 inquiries. Despite his efforts, Kent W. is "never heard from again," highlighting the fragility of early group formation.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-cyan-800">Jan 7, 1942: 1st Dallas Meeting <i class="fa-solid fa-hotel ml-2 text-cyan-500"></i></h2>
                                    <p class="mt-2 text-slate-700">First recorded AA meeting in Dallas held by Kent W. at the White Plaza Hotel.</p>
                                </div>
                            </div>
                
                            <!-- Event 6: April 2, 1943 - Esther E. Starts "The Dallas Group" -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-yellow-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-yellow-400 pb-1 mb-2">AA Takes Root in Dallas</h4>
                                        <p class="text-sm">Esther E. (whose story "A Flower of the South" is in the Big Book), having sobered up in Houston, moves to Dallas and starts "The Dallas Group" in her home. Ruth T. attends this inaugural meeting.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-yellow-800">Apr 2, 1943: "The Dallas Group" <i class="fa-solid fa-house-chimney ml-2 text-yellow-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Esther E. starts "The Dallas Group" in her home, marking AA truly taking root in Dallas.</p>
                                </div>
                            </div>
                
                            <!-- Event 7: 1945 - Dallas AA First Permanent Home -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-orange-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-orange-400 pb-1 mb-2">Establishing a Presence</h4>
                                        <p class="text-sm">Dallas AA secures its first permanent home at 912 ½ Main Street in downtown. By year-end, fewer than 20 people in the city are sober, but numbers are growing by word-of-mouth.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-orange-800">1945: Dallas AA Home <i class="fa-solid fa-building ml-2 text-orange-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Dallas AA establishes its first permanent home downtown.</p>
                                </div>
                            </div>
                
                            <!-- Event 8: 1946 - Suburban Group Formed (Dallas) -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-red-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-red-400 pb-1 mb-2">Post-War Expansion</h4>
                                        <p class="text-sm">Following World War II, AA membership surges. Searcy W. forms a second group, the Suburban Group, which remains active in Dallas today.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-red-800">1946: Suburban Group <i class="fa-solid fa-people-group ml-2 text-red-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Searcy W. forms the Suburban Group in Dallas.</p>
                                </div>
                            </div>
                
                            <!-- Event 9: Sep 18, 1947 - Dallas Central Office Opens -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-indigo-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-indigo-400 pb-1 mb-2">Organizational Foresight</h4>
                                        <p class="text-sm">The Dallas Central Office holds its first Board meeting and officially opens on Akard Street. Dick P. serves as the first Office Manager, despite suffering physically from Jamaica Ginger Poisoning, demonstrating profound commitment.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-indigo-800">Sep 18, 1947: Dallas Central Office <i class="fa-solid fa-phone ml-2 text-indigo-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The Dallas Central Office officially opens for business.</p>
                                </div>
                            </div>
                
                            <!-- Event 10: 1960 - Esther E. Passes Away -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-purple-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-purple-400 pb-1 mb-2">A Pioneer's Legacy</h4>
                                        <p class="text-sm">Esther E. passes away with slightly more than 19 years of sobriety. Her personal copy of the Big Book, inscribed by Bill W., is displayed at the Dallas Intergroup Office, a tangible link to her foundational role.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-purple-800">1960: Esther E. Passes <i class="fa-solid fa-book-heart ml-2 text-purple-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Esther E., instrumental in establishing AA in Dallas, passes away.</p>
                                </div>
                            </div>
                
                            <!-- Event 11: 1968 - Dallas Intergroup Reorganizes -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-green-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-green-400 pb-1 mb-2">Maturation of Service</h4>
                                        <p class="text-sm">Dallas Intergroup reorganizes, and the Central Office begins operating more formally under the guidance of the then eight or nine AA groups. A member generously loans \$2,000 to stock AA literature.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-green-800">1968: Dallas Intergroup Reorg <i class="fa-solid fa-sitemap ml-2 text-green-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Dallas Intergroup reorganizes for more formal operations.</p>
                                </div>
                            </div>
                
                            <!-- Event 12: 1971 - Dallas Central Office Publishes Directory -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-teal-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-teal-400 pb-1 mb-2">Broadening Reach</h4>
                                        <p class="text-sm">The Dallas Central Office, then located in the Hudson & Hudson Building, publishes a comprehensive meeting directory that includes groups in jails, hospitals, and other facilities, reflecting the broadening reach of AA.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-teal-800">1971: Dallas Meeting Directory <i class="fa-solid fa-address-book ml-2 text-teal-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Dallas Central Office publishes a comprehensive meeting directory.</p>
                                </div>
                            </div>
                
                            <!-- Event 13: 1973 - Dallas Fellowship Grows to 30 Groups -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-cyan-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-cyan-400 pb-1 mb-2">Significant Growth</h4>
                                        <p class="text-sm">The Dallas fellowship experiences substantial growth, reaching 30 active groups, demonstrating the increasing demand for AA's message in the region.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-cyan-800">1973: 30 Dallas Groups <i class="fa-solid fa-chart-line ml-2 text-cyan-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The Dallas AA fellowship grows to 30 groups.</p>
                                </div>
                            </div>
                
                            <!-- Event 14: 1978 - Lambda Dallas Group Founded -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-yellow-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-yellow-400 pb-1 mb-2">Serving Diverse Communities</h4>
                                        <p class="text-sm">The Lambda Dallas Group is founded in Oak Lawn, Dallas' LGBTQ neighborhood. This group plays a vital role in carrying the AA message to thousands within this specific community, highlighting AA's adaptability.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-yellow-800">1978: Lambda Dallas Group <i class="fa-solid fa-rainbow ml-2 text-yellow-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The Lambda Dallas Group is founded, serving the LGBTQ community.</p>
                                </div>
                            </div>
                
                            <!-- Event 15: June 10, 1983 - The Glass House Group Founded (Fort Worth) -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-orange-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-orange-400 pb-1 mb-2">Fort Worth Milestone</h4>
                                        <p class="text-sm">The Glass House group is founded on the west side of Fort Worth by a few members emphasizing spirituality. Its first meeting on Houghton Street notably coincides with AA's 48th anniversary. The podium built by founder Don A. is still in use today.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-orange-800">Jun 10, 1983: Glass House (FW) <i class="fa-solid fa-house-crack ml-2 text-orange-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The Glass House group is founded in Fort Worth.</p>
                                </div>
                            </div>
                
                            <!-- Event 16: 1984 - The Glass House Moves to Hemsell Place -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-red-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-red-400 pb-1 mb-2">Rapid Growth & Incorporation</h4>
                                        <p class="text-sm">Within months, The Glass House outgrows its initial location, leading to the acquisition of its current facility at 6713 Hemsell Place. The move involves extensive volunteer effort, and the group is incorporated by Bryan H., Jim Williams, Kelly Y., and Massie T.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-red-800">1984: Glass House Relocates <i class="fa-solid fa-location-dot ml-2 text-red-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The Glass House group moves to its current Fort Worth facility.</p>
                                </div>
                            </div>
                
                            <!-- Event 17: 1989 - Dallas Intergroup Becomes DIA -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-indigo-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-indigo-400 pb-1 mb-2">Formalizing Structure</h4>
                                        <p class="text-sm">The Dallas Intergroup formalizes its structure by incorporating and becoming the Dallas Intergroup Association (DIA), a non-profit organization, reflecting its maturation as a service entity.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-indigo-800">1989: Dallas Intergroup (DIA) <i class="fa-solid fa-building-columns ml-2 text-indigo-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Dallas Intergroup incorporates as the Dallas Intergroup Association (DIA).</p>
                                </div>
                            </div>
                
                            <!-- Event 18: June 1993 - Bryan Honts (Glass House Founder) Passes -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-purple-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-purple-400 pb-1 mb-2">A Founder Remembered</h4>
                                        <p class="text-sm">Bryan Honts, a founder of The Glass House group in Fort Worth, passes away. His contributions were vital to the group's establishment and early growth.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-purple-800">Jun 1993: Bryan Honts Passes <i class="fa-solid fa-user-tie ml-2 text-purple-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Bryan Honts, a founder of The Glass House group, passes away.</p>
                                </div>
                            </div>
                
                            <!-- Event 19: Jan 1999 - Jim Williams (Glass House Founder) Passes -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-green-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-green-400 pb-1 mb-2">Speaker and Founder</h4>
                                        <p class="text-sm">Jim Williams, a founder of The Glass House group and a prolific AA speaker, passes away. His shares and service significantly impacted many members.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-green-800">Jan 1999: Jim Williams Passes <i class="fa-solid fa-microphone ml-2 text-green-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Jim Williams, a founder and speaker at The Glass House, passes away.</p>
                                </div>
                            </div>
                
                            <!-- Event 20: April 2000 - Dallas AA Central Office Reverts Name -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-teal-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-teal-400 pb-1 mb-2">Clarifying Identity</h4>
                                        <p class="text-sm">The Dallas Intergroup Association (DIA) reverts its name to the Dallas AA Central Office. This change was made to better describe its primary function to potential newcomers seeking help, emphasizing accessibility.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-teal-800">Apr 2000: Dallas Central Office <i class="fa-solid fa-retweet ml-2 text-teal-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Dallas Intergroup Association (DIA) reverts its name to Dallas AA Central Office.</p>
                                </div>
                            </div>
                
                            <!-- Event 21: 2002 - Dr. Rex Howard (Glass House Founder) Passes -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-cyan-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-cyan-400 pb-1 mb-2">Another Founder's Departure</h4>
                                        <p class="text-sm">Dr. Rex Howard, another founder of The Glass House group, passes away. His contributions were integral to the early spiritual emphasis of the group.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-cyan-800">2002: Dr. Rex Howard Passes <i class="fa-solid fa-user-md ml-2 text-cyan-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Dr. Rex Howard, a founder of The Glass House group, passes away.</p>
                                </div>
                            </div>
                
                            <!-- Event 22: 2003 - Searcy W. Passes (Dallas) -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-yellow-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-yellow-400 pb-1 mb-2">Dallas's Oldest Member</h4>
                                        <p class="text-sm">Searcy W., founder of Dallas's Suburban Group and then Dallas's oldest AA member, passes away with 57 years of sobriety, leaving a long legacy of recovery and service.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-yellow-800">2003: Searcy W. Passes <i class="fa-solid fa-star-of-life ml-2 text-yellow-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Searcy W., founder of the Suburban Group and Dallas's oldest AA member, passes away.</p>
                                </div>
                            </div>
                
                            <!-- Event 23: April 2009 - Kelly Young (Glass House Key Figure) Passes -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-orange-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-orange-400 pb-1 mb-2">Spiritual Leadership</h4>
                                        <p class="text-sm">Kelly Young, a key figure at The Glass House group who served as Chairman of its Board for 24 years, passes away after 27 years of active service, leaving a lasting legacy of spiritual leadership.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-orange-800">Apr 2009: Kelly Young Passes <i class="fa-solid fa-hand-holding-medical ml-2 text-orange-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Kelly Young, a key figure at The Glass House group, passes away.</p>
                                </div>
                            </div>
                
                            <!-- Event 24: Present - DFW AA Today -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-red-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-red-400 pb-1 mb-2">Continuing Service</h4>
                                        <p class="text-sm">The Dallas Central Office/DIA supports over 160 AA groups, hosting over 1500 meetings. The Fort Worth AA Central Office serves a wide multi-county area, and NETA 65 serves over 500 AA groups, demonstrating ongoing growth and vital service.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-red-800">Present: DFW AA Today <i class="fa-solid fa-city ml-2 text-red-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Dallas and Fort Worth AA continue to thrive, supporting thousands of members.</p>
                                </div>
                            </div>
                
                        </div>
                </div>
            </div>
            <div id="rowlett-history" class="history-content">
                <h3 class="mb-4 font-bold text-xl">Rowlett Group History</h3>
                <!-- Rowlett Group timeline -->
                <div class="timeline-wrapper">
                <div class="timeline-container">
                            <!-- 1995 -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-sky-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-sky-400 pb-1 mb-2">The Backstory</h4>
                                        <p class="text-sm">The Sunshine Group was struggling financially. Knowing the end was near, members gave notice to their landlord, promising to somehow pay two months of back rent. After it folded, a new vision was born.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-sky-800">1995: A Leap of Faith <i class="fa-solid fa-seedling ml-2 text-sky-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Eight former Sunshine Group members founded a new, non-smoking group. On July 22, the first meeting was held at 4501 Rowlett Road in a tiny 10.5' x 14' room.</p>
                                </div>
                            </div>
                
                            <!-- 1996 -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-teal-50">
                                     <div class="info-popup">
                                        <h4 class="font-bold border-b border-teal-400 pb-1 mb-2">Volunteer Spirit</h4>
                                        <p class="text-sm">Extensive remodeling and refinishing was mostly done by Group volunteers working nights and weekends, creating the group home for the next six years!</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-teal-800">1996: Building Our Home <i class="fa-solid fa-hammer ml-2 text-teal-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The 1st Anniversary BBQ was memorably rained out. That fall, the group room tripled in size, and the Open House featured speaker Searcy W., who held a fifty-year chip!</p>
                                </div>
                            </div>
                            
                            <!-- 1997-1998 -->
                            <div class="timeline-block left">
                                 <div class="timeline-content bg-teal-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-teal-400 pb-1 mb-2">Meeting Growth</h4>
                                        <p class="text-sm">Monthly AA birthday meetings were combined with Al-Anon. The total weekly meeting count grew rapidly: from none to 12 in 1997, then to 17 by the end of 1998.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-teal-800">1997-1998: More Meetings! <i class="fa-solid fa-users ml-2 text-teal-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The group expanded its schedule, adding monthly birthday meetings, multiple noon meetings, and 6 PM meetings to better serve the growing community.</p>
                                 </div>
                            </div>
                
                            <!-- 1999-2002 -->
                            <div class="timeline-block right">
                                 <div class="timeline-content bg-teal-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-teal-400 pb-1 mb-2">Key Events</h4>
                                        <ul class="text-sm list-disc list-inside space-y-1">
                                            <li><b>May 1999:</b> $500 approved to double Al-Anon space with volunteer labor.</li>
                                            <li><b>Feb 2002:</b> Sponsorship workshop featured a four-member panel with a moderator.</li>
                                             <li><b>Aug 2002:</b> 7th Anniversary had ~100 members and guests.</li>
                                        </ul>
                                    </div>
                                    <h2 class="text-2xl font-bold text-teal-800">1999-2002: Service & Structure <i class="fa-solid fa-book-open ml-2 text-teal-500"></i></h2>
                                    <p class="mt-2 text-slate-700">This era focused on service, with a 4th Anniversary party, a Sponsorship Workshop, and the formal designation of the Rowlett Group Bylaws.</p>
                                 </div>
                            </div>
                
                            <!-- 2003 -->
                            <div class="timeline-block left">
                                 <div class="timeline-content bg-amber-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-amber-400 pb-1 mb-2">The Big Move</h4>
                                        <p class="text-sm">Minimum requirements for a new space: affordable rent, 1,000 sq ft, kitchen, bathroom, and storage. The new Garland facility's 2nd birthday night celebrated 27 members representing over 140 years of sobriety.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-amber-800">2003: A Test of Unity <i class="fa-solid fa-truck-moving ml-2 text-amber-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Forced to move, the group relocated to Garland. In an amazing show of unity, 50-60 members moved everything in under an hour, ensuring no meetings were missed.</p>
                                 </div>
                            </div>
                
                            <!-- 2004-2007 -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-amber-50">
                                     <div class="info-popup">
                                        <h4 class="font-bold border-b border-amber-400 pb-1 mb-2">Lease & Name</h4>
                                        <p class="text-sm">In 2006, the lease was extended, with the Rowlett Group becoming the official signatory. In June 2007, the group reconsidered a name change but elected to keep the Rowlett Group name despite being in Garland.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-amber-800">2004-2007: Settling In <i class="fa-solid fa-anchor ml-2 text-amber-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The group held its 2nd inventory, created job descriptions, and hosted workshops. The 12th Anniversary theme was "Imagine Life Without Faith."</p>
                                </div>
                            </div>
                
                             <!-- 2008-2009 -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-amber-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-amber-400 pb-1 mb-2">Fellowship!</h4>
                                        <p class="text-sm">Members insisted on enjoying life: Friday Night Candlelight Meetings followed by Denny's, Starbucks after the Saturday 8 PM meeting with guitars and sing-alongs, July 4th at the lake, and Sober Celebrations with live music by Turning Point.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-amber-800">2008-2009: Thriving! <i class="fa-solid fa-star ml-2 text-amber-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The Chaha/Bass Pro location boomed. Birthday nights were Standing Room Only, and the "Luau" themed 14th Anniversary party was a huge success.</p>
                                </div>
                            </div>
                
                            <!-- 2010-2014 -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-amber-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-amber-400 pb-1 mb-2">A New Home</h4>
                                        <p class="text-sm">In July 2010, 48 members attended a Group Conscience to approve the move "Behind Denny's." Work commenced, and the group held an Open House in lieu of an anniversary party after moving on Oct 30.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-amber-800">2010-2014: Service & A New Move <i class="fa-solid fa-briefcase ml-2 text-amber-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Members carried the message to correctional facilities, providing Big Books. The group hosted workshops and remained active in District/Area service.</p>
                                </div>
                            </div>
                
                            <!-- 2015 -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-red-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-red-400 pb-1 mb-2">A Fateful Year</h4>
                                        <p class="text-sm">The decision to find a new home was made at Denny's in June. The lease at 362 Oaks Trail commenced on August 15. The tornado hit on December 26, minutes after attendees had traveled past the heavily damaged I-30/190 interchange.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-red-800">2015: Resilience & Rebirth <i class="fa-solid fa-heart-pulse ml-2 text-red-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Facing decline, four members decided to stick together, finding a new home at Oaks Trail. The year ended with a tornado narrowly missing the group's birthday night.</p>
                                </div>
                            </div>
                
                            <!-- 2016-2019 -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-indigo-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-indigo-400 pb-1 mb-2">Holding Fast</h4>
                                        <p class="text-sm">Though many AAs came and went, the central core of the group held fast. In 2019, the group signed another three-year lease, bringing the total years at Oaks Trail to seven. Overhead remained low and reserves prudent.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-indigo-800">2016-2019: A New Home <i class="fa-solid fa-house-chimney-heart ml-2 text-indigo-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Slow, steady growth continued. A fresh crop of dedicated AAs took hold, and newcomers were getting and staying sober by way of the twelve steps.</p>
                                </div>
                            </div>
                            
                             <!-- 2020 -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-indigo-50">
                                     <div class="info-popup">
                                        <h4 class="font-bold border-b border-indigo-400 pb-1 mb-2">Digital Fellowship</h4>
                                        <p class="text-sm">To keep members informed during the pandemic lockdown, the "Rowlett Friends of Bill" private Facebook page was created in April.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-indigo-800">2020: The Pandemic Pivot <i class="fa-solid fa-laptop ml-2 text-indigo-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The COVID-19 pandemic led to our first Zoom meeting on April 1. In-person meetings resumed in May, and in June, Tuesday night became a dedicated Newcomer meeting.</p>
                                </div>
                            </div>
                
                            <!-- 2021-Present -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-green-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-green-400 pb-1 mb-2">Anniversary Update</h4>
                                        <p class="text-sm">The 26th Anniversary Party was planned for August 2021, but once again COVID reared its ugly head, forcing the anniversary to be postponed until February 2022.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-green-800">2021-Present: Re-Energized! <i class="fa-solid fa-champagne-glasses ml-2 text-green-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Group unity is stronger than ever. Fellowship dinners are popular, and outdoor Birthday Nights are celebrated with enthusiasm by friends and family.</p>
                                </div>
                            </div>
                
                        </div>
                </div>
            </div>
        </section>

        <!-- Analytics Dashboard Section -->
        <section id="analytics-section" style="border-left: 4px solid #1abc9c;">
            <h2><i class="fas fa-chart-bar"></i> Analytics Dashboard</h2>
            <p class="mb-4">Track group engagement, attendance trends, and participation metrics.</p>

            <!-- Attendance Trends -->
            <div class="box mb-4">
                <h3>Attendance Trends Over Time</h3>
                <div class="form-group">
                    <label for="analytics-time-range">Time Range</label>
                    <select id="analytics-time-range" onchange="refreshAnalytics()">
                        <option value="30">Last 30 Days</option>
                        <option value="60">Last 60 Days</option>
                        <option value="90" selected>Last 90 Days</option>
                        <option value="180">Last 6 Months</option>
                        <option value="365">Last Year</option>
                    </select>
                </div>
                <canvas id="attendance-chart" style="max-height: 300px;"></canvas>
            </div>

            <!-- Active Member Engagement -->
            <div class="box mb-4">
                <h3>Active Member Engagement</h3>
                <div id="engagement-metrics" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <!-- Metrics will be inserted here -->
                </div>
            </div>

            <!-- GC Participation Rates -->
            <div class="box mb-4">
                <h3>Group Conscience Participation Rates</h3>
                <div id="gc-participation-stats">
                    <!-- Stats will be inserted here -->
                </div>
                <canvas id="gc-participation-chart" style="max-height: 250px; margin-top: 1rem;"></canvas>
            </div>

            <!-- Service Position Engagement -->
            <div class="box mb-4">
                <h3>Service Position Engagement</h3>
                <div id="service-engagement-stats">
                    <!-- Stats will be inserted here -->
                </div>
            </div>

            <!-- Recent Activity Summary -->
            <div class="box">
                <h3>Recent Activity Summary</h3>
                <div id="activity-summary">
                    <!-- Activity summary will be inserted here -->
                </div>
            </div>
        </section>

        <!-- Accessibility Features Section -->
        <section id="accessibility-section" style="border-left: 4px solid #34495e;">
            <h2><i class="fas fa-universal-access"></i> Accessibility Settings</h2>
            <p class="mb-4">Customize your viewing experience for better accessibility.</p>

            <!-- Dark Mode Toggle -->
            <div class="box mb-4">
                <h3>Theme Settings</h3>
                <div class="form-group">
                    <label for="theme-mode">Color Theme</label>
                    <select id="theme-mode" onchange="changeTheme()">
                        <option value="dark">Dark Mode (Default)</option>
                        <option value="light">Light Mode</option>
                        <option value="high-contrast">High Contrast</option>
                    </select>
                </div>
                <p style="font-size: 0.9rem; color: #95a5a6; margin-top: 0.5rem;">
                    Choose a theme that works best for your eyes and environment.
                </p>
            </div>

            <!-- Font Size Controls -->
            <div class="box mb-4">
                <h3>Font Size</h3>
                <div class="form-group">
                    <label for="font-size-slider">Text Size: <span id="font-size-display">100%</span></label>
                    <input type="range" id="font-size-slider" min="80" max="150" value="100" step="10"
                           style="width: 100%;" oninput="changeFontSize(this.value)" />
                </div>
                <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn secondary" onclick="changeFontSize(80)">Small</button>
                    <button class="btn secondary" onclick="changeFontSize(100)">Medium</button>
                    <button class="btn secondary" onclick="changeFontSize(120)">Large</button>
                    <button class="btn secondary" onclick="changeFontSize(150)">Extra Large</button>
                </div>
                <p style="font-size: 0.9rem; color: #95a5a6; margin-top: 1rem;">
                    Sample text: The quick brown fox jumps over the lazy dog. 0123456789
                </p>
            </div>

            <!-- Screen Reader Optimization -->
            <div class="box mb-4">
                <h3>Screen Reader Optimization</h3>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="screen-reader-mode" onchange="toggleScreenReaderMode()" />
                        Enable Screen Reader Optimizations
                    </label>
                </div>
                <p style="font-size: 0.9rem; color: #95a5a6; margin-top: 0.5rem;">
                    This mode adds enhanced ARIA labels, skip navigation links, and improved semantic structure for screen readers.
                </p>
            </div>

            <!-- Additional Accessibility Options -->
            <div class="box mb-4">
                <h3>Additional Options</h3>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="reduce-animations" onchange="toggleReduceAnimations()" />
                        Reduce Animations
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="focus-indicators" onchange="toggleFocusIndicators()" />
                        Enhanced Focus Indicators
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="dyslexia-font" onchange="toggleDyslexiaFont()" />
                        Use Dyslexia-Friendly Font
                    </label>
                </div>
            </div>

            <!-- Keyboard Shortcuts Reference -->
            <div class="box">
                <h3>Keyboard Shortcuts</h3>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th style="text-align: left; padding: 0.5rem; border-bottom: 1px solid #3498db;">Action</th>
                            <th style="text-align: left; padding: 0.5rem; border-bottom: 1px solid #3498db;">Shortcut</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="padding: 0.5rem;">Navigate sections</td>
                            <td style="padding: 0.5rem;"><kbd>Tab</kbd> / <kbd>Shift+Tab</kbd></td>
                        </tr>
                        <tr>
                            <td style="padding: 0.5rem;">Activate button/link</td>
                            <td style="padding: 0.5rem;"><kbd>Enter</kbd> or <kbd>Space</kbd></td>
                        </tr>
                        <tr>
                            <td style="padding: 0.5rem;">Close modal</td>
                            <td style="padding: 0.5rem;"><kbd>Esc</kbd></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Settings Section -->
        <section id="settings-section" style="border-left: 4px solid #34495e;">
            <h2><i class="fas fa-cog"></i> Settings & Data Management</h2>

            <div class="box mb-4">
                <h3>Group Settings</h3>
                <p class="mb-2">Configure your group's information and meeting details.</p>
                <div class="form-group">
                    <label for="group-qr-code-url">7th Tradition QR Code URL</label>
                    <input type="text" id="group-qr-code-url" placeholder="Enter QR code image URL (Venmo/PayPal/CashApp QR code)" />
                    <small style="font-size: 0.75rem; opacity: 0.8;">Upload your QR code to an image hosting service and paste the URL here, or leave blank to hide.</small>
                </div>
                <div class="form-group">
                    <label for="group-zoom-link">Zoom Meeting Link</label>
                    <input type="text" id="group-zoom-link" placeholder="zoommtg://zoom.us/join?action=join&confno=XXXXX&pwd=XXXXX" />
                    <small style="font-size: 0.75rem; opacity: 0.8;">Your Zoom meeting link. Leave blank to hide the Zoom button.</small>
                </div>
                <div class="form-group">
                    <label for="group-contact-name">Treasurer/Contact Name</label>
                    <input type="text" id="group-contact-name" placeholder="e.g., Nathan D" />
                </div>
                <div class="form-group">
                    <label for="group-contact-phone">Treasurer/Contact Phone</label>
                    <input type="tel" id="group-contact-phone" placeholder="e.g., 214-555-1234" />
                </div>
                <button class="btn" onclick="saveGroupSettings()">Save Group Settings</button>
            </div>

            <div class="box mb-4">
                <h3>User Identity</h3>
                <p class="mb-2">Set your name for messages and read receipts.</p>
                <div class="form-group">
                    <label for="current-user-name">Your Name</label>
                    <input type="text" id="current-user-name" placeholder="Enter your name..." />
                </div>
                <button class="btn" onclick="saveCurrentUser()">Save Name</button>
            </div>

            <!-- UNIFIED BACKUP & RESTORE SYSTEM -->
            <div class="box mb-4" style="border-left: 4px solid #3498db;">
                <h3><i class="fas fa-database"></i> Backup & Restore System</h3>
                <p class="mb-2" style="color: #ecf0f1;">Choose your preferred backup format. Both methods include <strong>ALL</strong> application data.</p>

                <!-- Method 1: JSON Backup -->
                <div class="box mt-4" style="background: #2c3e50; padding: 1.5rem;">
                    <h4 style="color: #3498db; margin: 0 0 1rem 0;"><i class="fas fa-file-code"></i> Method 1: JSON Backup (Recommended)</h4>
                    <p style="color: #95a5a6; font-size: 0.9rem; margin-bottom: 1rem;">
                        <strong>Best for:</strong> Complete backups, restoring to same or different device<br>
                        <strong>Format:</strong> Single JSON file containing all data<br>
                        <strong>Size:</strong> Smallest file size, optimized for storage
                    </p>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button class="btn" onclick="exportFullBackupJSON()" style="background: #2ecc71;">
                            <i class="fas fa-download"></i> Export JSON Backup
                        </button>
                        <button class="btn" onclick="importFullBackupJSON()" style="background: #3498db;">
                            <i class="fas fa-upload"></i> Import JSON Backup
                        </button>
                    </div>
                </div>

                <!-- Method 2: CSV Backup -->
                <div class="box mt-4" style="background: #2c3e50; padding: 1.5rem;">
                    <h4 style="color: #2ecc71; margin: 0 0 1rem 0;"><i class="fas fa-file-csv"></i> Method 2: CSV Backup (Human-Readable)</h4>
                    <p style="color: #95a5a6; font-size: 0.9rem; margin-bottom: 1rem;">
                        <strong>Best for:</strong> Viewing data in Excel/Sheets, data analysis, easy inspection<br>
                        <strong>Format:</strong> Multiple CSV files (pipe-delimited) in a ZIP archive<br>
                        <strong>Size:</strong> Larger file size, but readable in any spreadsheet program
                    </p>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button class="btn" onclick="exportFullBackupCSV()" style="background: #2ecc71;">
                            <i class="fas fa-download"></i> Export CSV Backup
                        </button>
                        <button class="btn" onclick="importFullBackupCSV()" style="background: #3498db;">
                            <i class="fas fa-upload"></i> Import CSV Backup
                        </button>
                    </div>
                    <p style="margin-top: 0.75rem; font-size: 0.8rem; color: #f39c12;">
                        <i class="fas fa-info-circle"></i> CSV files use pipe delimiter (|) for better compatibility with commas in data
                    </p>
                </div>

                <!-- Backup Info -->
                <div class="mt-4" style="padding: 1rem; background: #34495e; border-radius: 6px; border-left: 4px solid #f39c12;">
                    <h4 style="color: #f39c12; margin: 0 0 0.5rem 0;"><i class="fas fa-lightbulb"></i> Backup Best Practices</h4>
                    <ul style="margin: 0; padding-left: 1.5rem; color: #ecf0f1;">
                        <li>Create backups regularly (weekly recommended)</li>
                        <li>Store backups in multiple locations (cloud + local)</li>
                        <li>Always export before making major changes</li>
                        <li>Test restore process periodically to ensure backups work</li>
                        <li>Keep at least 3 recent backups for safety</li>
                    </ul>
                </div>
            </div>

            <!-- Automated Backup History -->
            <div class="box mb-4">
                <h3><i class="fas fa-history"></i> Automated Backup History</h3>
                <p class="mb-2">The system automatically creates backups. View and restore from backup history.</p>
                <button class="btn" onclick="createAutomatedBackup(); showToast('Backup created successfully!', 'success');">Create Backup Now</button>
                <button class="btn secondary" onclick="viewBackupHistory()">View Backup History</button>
            </div>

            <!-- Storage Usage Monitor -->
            <div class="box mb-4">
                <h3><i class="fas fa-chart-pie"></i> Storage Usage Monitor</h3>
                <p class="mb-2">Track your browser's localStorage usage to prevent data loss.</p>
                <div style="padding: 1rem; background: #2c3e50; border-radius: 6px; margin-bottom: 1rem;">
                    <div style="margin-bottom: 0.5rem;">
                        <strong>Used:</strong> <span id="storage-used">0</span> KB / <span id="storage-limit">~5,000</span> KB
                    </div>
                    <div class="vote-progress-bar-bg" style="height: 30px; margin-bottom: 0.5rem;">
                        <div id="storage-progress-bar" class="vote-progress-bar-fill" style="width: 0%; background: linear-gradient(90deg, #27ae60, #2ecc71);"></div>
                    </div>
                    <div id="storage-warning" style="display: none; color: #f39c12; font-weight: bold;">
                        <i class="fas fa-exclamation-triangle"></i> Warning: Storage is over 80% full. Consider exporting and clearing old data.
                    </div>
                    <div id="storage-critical" style="display: none; color: #e74c3c; font-weight: bold;">
                        <i class="fas fa-exclamation-circle"></i> Critical: Storage is nearly full! Export data immediately to prevent loss.
                    </div>
                </div>
                <button class="btn secondary" onclick="checkStorageUsage()">Refresh Storage Info</button>
            </div>

            <div class="box" style="border: 2px solid #e74c3c;">
                <h3 style="color: #e74c3c;"><i class="fas fa-exclamation-triangle"></i> Reset Application</h3>
                <p class="mb-2" style="color: #f39c12;"><strong>Warning:</strong> This will permanently delete ALL data from the application. This action cannot be undone!</p>
                <p class="mb-2">Before resetting, make sure you have exported your data for backup.</p>
                <button class="btn" style="background: #e74c3c; border-color: #c0392b;" onclick="resetApplication()">Reset All Application Data</button>
            </div>
        </section>

        <!-- FORMAT ROTATION SECTION -->
        <section id="format-rotation-section" style="border-left: 4px solid #3498db;">
            <h2><i class="fas fa-sync-alt"></i> Meeting Format Rotation</h2>
            <p class="mb-4">Manage automated format rotation patterns for weekly meetings.</p>

            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box mb-4">
                        <h3>Current Week's Format</h3>
                        <div id="current-format-display" style="padding: 1.5rem; background: #2c3e50; border-radius: 6px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #3498db;" id="current-format-name">Big Book Study</div>
                            <div style="margin-top: 0.5rem; color: #95a5a6;" id="current-format-week">Week of: <span id="current-week-date"></span></div>
                        </div>
                    </div>

                    <div class="box">
                        <h3>Add/Edit Format</h3>
                        <div class="form-group">
                            <label for="format-name">Format Name</label>
                            <input type="text" id="format-name" placeholder="e.g., Big Book Study, Step Study, Speaker Meeting">
                        </div>
                        <div class="form-group">
                            <label for="format-description">Description</label>
                            <textarea id="format-description" rows="2" placeholder="Brief description..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="format-order">Rotation Order</label>
                            <input type="number" id="format-order" min="1" placeholder="1">
                            <small style="font-size: 0.75rem; opacity: 0.8;">Order in the rotation cycle</small>
                        </div>
                        <input type="hidden" id="format-edit-id">
                        <button id="format-form-btn" class="btn" onclick="handleFormatSubmit()">Add Format</button>
                        <button id="format-form-cancel-btn" class="btn secondary" onclick="cancelFormatEdit()" style="display:none; margin-left: 0.5rem;">Cancel</button>
                    </div>
                </div>

                <div>
                    <div class="box">
                        <h3>Format Rotation Schedule</h3>
                        <table id="format-rotation-table">
                            <thead>
                                <tr>
                                    <th>Order</th>
                                    <th>Format</th>
                                    <th>Description</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="format-rotation-body"></tbody>
                        </table>
                    </div>

                    <div class="box mt-4">
                        <h3>Upcoming Formats (Next 8 Weeks)</h3>
                        <div id="upcoming-formats-list"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- COMMITMENT BOARD SECTION -->
        <section id="commitment-board-section" style="border-left: 4px solid #3498db;">
            <h2><i class="fas fa-clipboard-check"></i> Meeting Commitment Board</h2>
            <p class="mb-4">Sign-up system for meeting responsibilities with automated reminders.</p>

            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Sign Up for Commitment</h3>
                        <div class="form-group">
                            <label for="commitment-date">Meeting Date</label>
                            <input type="date" id="commitment-date">
                        </div>
                        <div class="form-group">
                            <label for="commitment-role">Responsibility</label>
                            <select id="commitment-role">
                                <option value="greeter">Greeter</option>
                                <option value="coffee">Coffee Maker</option>
                                <option value="setup">Setup</option>
                                <option value="cleanup">Cleanup</option>
                                <option value="secretary">Secretary</option>
                                <option value="treasurer">Treasurer Report</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="commitment-member">Member Name</label>
                            <select id="commitment-member"></select>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="commitment-reminder" checked>
                                Send reminder notification
                            </label>
                        </div>
                        <input type="hidden" id="commitment-edit-id">
                        <button id="commitment-form-btn" class="btn" onclick="handleCommitmentSubmit()">Sign Up</button>
                        <button id="commitment-form-cancel-btn" class="btn secondary" onclick="cancelCommitmentEdit()" style="display:none; margin-left: 0.5rem;">Cancel</button>
                    </div>
                </div>

                <div>
                    <div class="box">
                        <h3>This Week's Commitments</h3>
                        <div id="current-week-commitments"></div>
                    </div>

                    <div class="box mt-4">
                        <h3>Upcoming Commitments</h3>
                        <table id="commitment-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Role</th>
                                    <th>Member</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="commitment-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECRETARY FUNCTIONS SECTION -->
        <section id="secretary-section" style="border-left: 4px solid #3498db;">
            <h2><i class="fas fa-pen"></i> Meeting Secretary Functions</h2>
            <p class="mb-4">Attendance tracking, automated minutes, and meeting statistics.</p>

            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Take Attendance</h3>
                        <div class="form-group">
                            <label for="attendance-date">Meeting Date</label>
                            <input type="date" id="attendance-date">
                        </div>
                        <div class="form-group">
                            <label for="attendance-members">Members Present</label>
                            <select multiple id="attendance-members" style="height: 200px; background: #34495e; color: #ecf0f1; border: 1px solid #7f8c8d; border-radius: 4px; padding: 0.5rem; width: 100%;"></select>
                            <small style="font-size: 0.75rem; opacity: 0.8;">Hold Ctrl/Cmd to select multiple</small>
                        </div>
                        <div class="form-group">
                            <label for="attendance-visitors">Visitors/Newcomers</label>
                            <input type="number" id="attendance-visitors" min="0" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label for="attendance-oldtimers">Old-Timers (10+ years)</label>
                            <div id="attendance-oldtimers-list"></div>
                        </div>
                        <button class="btn" onclick="handleAttendanceSubmit()">Save Attendance</button>
                    </div>
                </div>

                <div>
                    <div class="box">
                        <h3>Meeting Statistics</h3>
                        <div id="attendance-stats" style="padding: 1rem; background: #2c3e50; border-radius: 6px;">
                            <div class="mb-2"><strong>Average Attendance:</strong> <span id="avg-attendance">0</span></div>
                            <div class="mb-2"><strong>Regular Members:</strong> <span id="regular-members">0</span></div>
                            <div class="mb-2"><strong>This Month's Visitors:</strong> <span id="monthly-visitors">0</span></div>
                            <div class="mb-2"><strong>Recognized Old-Timers:</strong> <span id="oldtimer-count">0</span></div>
                        </div>
                    </div>

                    <div class="box mt-4">
                        <h3>Recent Attendance</h3>
                        <table id="attendance-history-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Members</th>
                                    <th>Visitors</th>
                                    <th>Total</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="attendance-history-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- GC LIVE SESSION (moved from chairperson) -->
        <section id="gc-live-section" style="border-left: 4px solid #9b59b6;">
            <h2><i class="fas fa-broadcast-tower"></i> Live Group Conscience Session</h2>
            <p class="mb-4">Real-time motion tracking during Group Conscience meetings.</p>

            <div class="box">
                <h3>New Business / Open Motions</h3>
                <div class="form-group">
                    <label for="live-gc-new-item">New Item</label>
                    <textarea id="live-gc-new-item" rows="2" placeholder="Describe the new business item or motion..."></textarea>
                </div>
                <button class="btn" onclick="addLiveGCItem()">Add to Queue</button>
            </div>

            <div class="box mt-4">
                <h3>Active Motions Queue</h3>
                <table id="live-gc-queue-table">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="live-gc-queue-body"></tbody>
                </table>
            </div>
        </section>

        <!-- EMERGENCY GC PROTOCOL SECTION -->
        <section id="emergency-gc-section" style="border-left: 4px solid #e74c3c; display: none;">
            <div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); padding: 2rem; border-radius: 8px; margin-bottom: 2rem;">
                <h2 style="color: white; margin: 0 0 0.5rem 0;">
                    <i class="fas fa-exclamation-triangle"></i> EMERGENCY GROUP CONSCIENCE PROTOCOL
                </h2>
                <p style="color: rgba(255,255,255,0.9); margin: 0; font-size: 1.05rem;">
                    For crisis situations requiring immediate group conscience decision
                </p>
            </div>

            <!-- Emergency Type Selection -->
            <div class="box" style="border-left: 4px solid #e74c3c;">
                <h3><i class="fas fa-clipboard-check"></i> Emergency Classification</h3>
                <p style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 1.5rem;">
                    Select the type of emergency to load the appropriate protocol and checklist
                </p>

                <div class="form-group">
                    <label for="emergency-type">Emergency Type *</label>
                    <select id="emergency-type" onchange="loadEmergencyProtocol(this.value)">
                        <option value="">-- Select Emergency Type --</option>
                        <option value="venue-loss">Venue Loss / Location Crisis</option>
                        <option value="safety-concern">Safety/Security Concern</option>
                        <option value="financial-crisis">Financial Crisis</option>
                        <option value="member-conduct">Serious Member Conduct Issue</option>
                        <option value="legal-issue">Legal/Liability Issue</option>
                        <option value="service-disruption">Critical Service Disruption</option>
                        <option value="other">Other Emergency</option>
                    </select>
                </div>
            </div>

            <!-- Emergency Protocol Checklist -->
            <div id="emergency-protocol-container" style="display: none;">
                <div class="box" style="border-left: 4px solid #f39c12;">
                    <h3><i class="fas fa-list-check"></i> Emergency Protocol Checklist</h3>
                    <div id="emergency-checklist" style="margin-top: 1rem;">
                        <!-- Dynamically populated based on emergency type -->
                    </div>
                </div>

                <!-- Emergency GC Form -->
                <div class="box mt-4" style="border-left: 4px solid #e74c3c;">
                    <h3><i class="fas fa-gavel"></i> Emergency Decision Form</h3>

                    <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label for="emergency-facilitator">Emergency Facilitator *</label>
                            <select id="emergency-facilitator"></select>
                        </div>
                        <div class="form-group">
                            <label for="emergency-date">Date/Time *</label>
                            <input type="datetime-local" id="emergency-date">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="emergency-situation">Situation Description *</label>
                        <textarea id="emergency-situation" rows="3" placeholder="Clearly describe the emergency situation..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="emergency-decision">Proposed Emergency Decision/Action *</label>
                        <textarea id="emergency-decision" rows="3" placeholder="What action is being proposed to address the emergency?"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="emergency-rationale">Rationale for Emergency Process *</label>
                        <textarea id="emergency-rationale" rows="2" placeholder="Why must this be handled as an emergency vs. regular GC?"></textarea>
                    </div>

                    <div class="grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="emergency-notification-method">Notification Method *</label>
                            <select id="emergency-notification-method">
                                <option value="phone-tree">Phone Tree</option>
                                <option value="email-blast">Email Blast</option>
                                <option value="text-message">Group Text</option>
                                <option value="in-person">In-Person/Emergency Meeting</option>
                                <option value="combined">Combined Methods</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="emergency-members-reached">Members Reached</label>
                            <input type="number" id="emergency-members-reached" min="0" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label for="emergency-quorum-met">Quorum Met?</label>
                            <select id="emergency-quorum-met">
                                <option value="yes">Yes</option>
                                <option value="no">No</option>
                                <option value="emergency-override">Emergency Override</option>
                            </select>
                        </div>
                    </div>

                    <!-- Vote Recording -->
                    <div style="background: #2c3e50; padding: 1.5rem; border-radius: 4px; margin-top: 1.5rem;">
                        <h4 style="margin-top: 0;"><i class="fas fa-vote-yea"></i> Emergency Vote Results</h4>
                        <div class="grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label for="emergency-votes-for">Votes For</label>
                                <input type="number" id="emergency-votes-for" min="0" value="0">
                            </div>
                            <div class="form-group">
                                <label for="emergency-votes-against">Votes Against</label>
                                <input type="number" id="emergency-votes-against" min="0" value="0">
                            </div>
                            <div class="form-group">
                                <label for="emergency-votes-abstain">Abstentions</label>
                                <input type="number" id="emergency-votes-abstain" min="0" value="0">
                            </div>
                        </div>
                        <div id="emergency-vote-result" style="margin-top: 1rem; padding: 1rem; border-radius: 4px; background: #34495e; font-size: 1.1rem; font-weight: bold; text-align: center;">
                            Enter votes to see result
                        </div>
                    </div>

                    <div class="form-group" style="margin-top: 1.5rem;">
                        <label for="emergency-follow-up">Follow-Up Actions Required</label>
                        <textarea id="emergency-follow-up" rows="3" placeholder="What follow-up actions or regular GC review is needed?"></textarea>
                    </div>

                    <div style="background: #f39c12; padding: 1rem; border-radius: 4px; margin: 1.5rem 0;">
                        <i class="fas fa-info-circle"></i> <strong>Important:</strong> Emergency decisions should be reviewed at the next regular GC meeting for final ratification.
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button class="btn secondary" onclick="cancelEmergencyGC()">Cancel</button>
                        <button class="btn" onclick="submitEmergencyGC()" style="background: #e74c3c;">
                            <i class="fas fa-save"></i> Log Emergency Decision
                        </button>
                    </div>
                </div>
            </div>

            <!-- Emergency GC History -->
            <div class="box mt-4">
                <h3><i class="fas fa-history"></i> Emergency GC History</h3>
                <div id="emergency-gc-history" style="min-height: 100px;">
                    <!-- Populated with past emergency GCs -->
                </div>
            </div>
        </section>

        <!-- GC DECISION HISTORY & REFERENCE SECTION -->
        <section id="gc-decisions-section" style="border-left: 4px solid #9b59b6;">
            <h2><i class="fas fa-gavel"></i> Group Conscience Decision Management</h2>
            <p class="mb-4">Log GC decisions, submit agenda items, track action items, and analyze historical patterns.</p>

            <!-- GC Logging Form -->
            <div class="box mb-4" style="border-left: 4px solid #3498db;">
                <h3 id="gc-form-title"><i class="fas fa-plus-circle"></i> Log Group Conscience Decision</h3>
                <p style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 1.5rem;">Record the outcome of group conscience decisions with full details, workflow tracking, and research periods.</p>

                <!-- Workflow Status Indicator -->
                <div class="form-group" style="background: #34495e; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                    <label for="gc-workflow-status">Motion Workflow Status</label>
                    <select id="gc-workflow-status" onchange="toggleGCWorkflowSections()">
                        <option value="draft">Draft - Motion being prepared</option>
                        <option value="research">Research Period - Members reviewing & asking questions</option>
                        <option value="voting">Ready for Vote - Research complete</option>
                        <option value="decided" selected>Decided - Vote complete</option>
                    </select>
                    <small style="font-size: 0.75rem; opacity: 0.8; display: block; margin-top: 0.5rem;">
                        Select workflow stage to enable appropriate fields below
                    </small>
                </div>

                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="gc-date">Meeting Date *</label>
                        <input type="date" id="gc-date">
                    </div>
                    <div class="form-group">
                        <label for="gc-submitted-by">Submitted By</label>
                        <input type="text" id="gc-submitted-by" placeholder="Member name">
                    </div>
                </div>

                <div class="form-group">
                    <label for="gc-item">Motion / Item *</label>
                    <textarea id="gc-item" rows="3" placeholder="Describe the motion clearly..."></textarea>
                </div>

                <!-- Research Period Dates -->
                <div id="gc-research-period-section" style="display: none; background: #2c3e50; padding: 1rem; border-radius: 6px; margin-bottom: 1rem; border-left: 4px solid #3498db;">
                    <h4 style="color: #3498db; margin-bottom: 0.75rem;"><i class="fas fa-search"></i> Research Period Configuration</h4>
                    <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="gc-research-start">Research Period Start Date</label>
                            <input type="date" id="gc-research-start">
                            <small style="font-size: 0.75rem; opacity: 0.8; display: block; margin-top: 0.25rem;">
                                When members can start reviewing and asking questions
                            </small>
                        </div>
                        <div class="form-group">
                            <label for="gc-research-end">Research Period End Date (Vote Date)</label>
                            <input type="date" id="gc-research-end">
                            <small style="font-size: 0.75rem; opacity: 0.8; display: block; margin-top: 0.25rem;">
                                Research ends; vote will occur on this date
                            </small>
                        </div>
                    </div>
                </div>

                <div class="grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="gc-status">Final Decision Status</label>
                        <select id="gc-status">
                            <option value="passed">Passed</option>
                            <option value="failed">Failed</option>
                            <option value="tabled">Tabled</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="gc-votes-for">Votes For</label>
                        <input type="number" id="gc-votes-for" min="0" placeholder="0" oninput="updateVotePercentages()">
                    </div>
                    <div class="form-group">
                        <label for="gc-votes-against">Votes Against</label>
                        <input type="number" id="gc-votes-against" min="0" placeholder="0" oninput="updateVotePercentages()">
                    </div>
                </div>

                <div class="form-group">
                    <label for="gc-votes-abstain">Votes Abstain</label>
                    <input type="number" id="gc-votes-abstain" min="0" placeholder="0" oninput="updateVotePercentages()" style="max-width: 200px;">
                </div>

                <div id="vote-summary" style="padding: 0.75rem; background: #2c3e50; border-radius: 4px; margin-bottom: 0.75rem; font-size: 0.85rem;">
                    <div style="margin-bottom: 0.5rem;"><strong>Total Votes:</strong> <span id="total-votes">0</span></div>
                    <div class="vote-progress-container">
                        <div class="vote-progress-item">
                            <div class="vote-progress-label">
                                <span><strong>For:</strong> <span id="votes-for-count">0</span></span>
                                <span id="percent-for">0%</span>
                            </div>
                            <div class="vote-progress-bar-bg">
                                <div id="progress-bar-for" class="vote-progress-bar-fill for" style="width: 0%;"></div>
                            </div>
                        </div>
                        <div class="vote-progress-item">
                            <div class="vote-progress-label">
                                <span><strong>Against:</strong> <span id="votes-against-count">0</span></span>
                                <span id="percent-against">0%</span>
                            </div>
                            <div class="vote-progress-bar-bg">
                                <div id="progress-bar-against" class="vote-progress-bar-fill against" style="width: 0%;"></div>
                            </div>
                        </div>
                        <div class="vote-progress-item">
                            <div class="vote-progress-label">
                                <span><strong>Abstain:</strong> <span id="votes-abstain-count">0</span></span>
                                <span id="percent-abstain">0%</span>
                            </div>
                            <div class="vote-progress-bar-bg">
                                <div id="progress-bar-abstain" class="vote-progress-bar-fill abstain" style="width: 0%;"></div>
                            </div>
                        </div>
                    </div>
                    <div id="quorum-status" style="margin-top: 0.5rem;"></div>
                </div>

                <div class="form-group">
                    <label for="gc-attendees">Members Present</label>
                    <select multiple id="gc-attendees" style="height: 120px; background: #34495e; color: #ecf0f1; border: 1px solid #7f8c8d; border-radius: 4px; padding: 0.5rem; width: 100%;" onchange="updateVotePercentages()"></select>
                    <small style="font-size: 0.75rem; opacity: 0.8;">Hold Ctrl/Cmd to select multiple members</small>
                </div>

                <div class="form-group">
                    <label>Servant Reports</label>
                    <div id="gc-servant-reports-container">
                        <!-- Servant report inputs will be dynamically generated here -->
                    </div>
                    <div id="gc-servant-reports-legacy-container" style="display: none;">
                        <label for="gc-servant-reports-legacy">Legacy Reports (read-only)</label>
                        <textarea id="gc-servant-reports-legacy" rows="4" readonly></textarea>
                    </div>
                </div>

                <!-- FEATURE 3: Motion Amendment System -->
                <div id="gc-amendments-section" style="background: #34495e; padding: 1rem; border-radius: 6px; margin: 1rem 0; border-left: 4px solid #f39c12;">
                    <h4 style="color: #f39c12; margin-bottom: 0.75rem;"><i class="fas fa-edit"></i> Motion Amendments</h4>
                    <p style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 1rem;">Propose changes to the main motion before voting</p>

                    <div class="form-group">
                        <label for="amendment-text">Amendment Text *</label>
                        <textarea id="amendment-text" rows="2" placeholder="Proposed amendment to the motion..."></textarea>
                    </div>

                    <div class="grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="amendment-type">Amendment Type</label>
                            <select id="amendment-type">
                                <option value="friendly">Friendly - Accepted by maker</option>
                                <option value="unfriendly">Unfriendly - Requires vote</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="amendment-proposer">Proposed By</label>
                            <input type="text" id="amendment-proposer" placeholder="Member name">
                        </div>
                        <div class="form-group">
                            <label for="amendment-status">Status</label>
                            <select id="amendment-status">
                                <option value="proposed">Proposed</option>
                                <option value="accepted">Accepted</option>
                                <option value="rejected">Rejected</option>
                                <option value="withdrawn">Withdrawn</option>
                            </select>
                        </div>
                    </div>

                    <button class="btn" onclick="addAmendment()" style="background: #f39c12;">
                        <i class="fas fa-plus"></i> Add Amendment
                    </button>

                    <div id="amendments-list" style="margin-top: 1rem;"></div>
                </div>

                <!-- FEATURE 5: Discussion Thread System -->
                <div id="gc-discussion-section" style="background: #34495e; padding: 1rem; border-radius: 6px; margin: 1rem 0; border-left: 4px solid #3498db;">
                    <h4 style="color: #3498db; margin-bottom: 0.75rem;"><i class="fas fa-comments"></i> Discussion & Questions</h4>
                    <p style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 1rem;">Members can post questions and comments during research period</p>

                    <div class="form-group">
                        <label for="discussion-comment">Your Comment/Question</label>
                        <textarea id="discussion-comment" rows="3" placeholder="Post a question or comment about this motion..."></textarea>
                    </div>

                    <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="discussion-author">Your Name</label>
                            <select id="discussion-author"></select>
                        </div>
                        <div class="form-group">
                            <label for="discussion-type">Type</label>
                            <select id="discussion-type">
                                <option value="question">Question</option>
                                <option value="comment">Comment</option>
                                <option value="concern">Concern</option>
                                <option value="support">Support</option>
                            </select>
                        </div>
                    </div>

                    <button class="btn" onclick="addDiscussionComment()" style="background: #3498db;">
                        <i class="fas fa-paper-plane"></i> Post Comment
                    </button>

                    <h5 style="margin-top: 1.5rem; margin-bottom: 0.75rem;">Discussion Thread</h5>
                    <div id="discussion-thread" style="max-height: 400px; overflow-y: auto;"></div>
                </div>

                <!-- FEATURE 2: Table Motion for Future -->
                <div id="gc-table-motion-section" style="background: #34495e; padding: 1rem; border-radius: 6px; margin: 1rem 0; border-left: 4px solid #e74c3c;">
                    <h4 style="color: #e74c3c; margin-bottom: 0.75rem;"><i class="fas fa-pause-circle"></i> Table Motion</h4>
                    <p style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 1rem;">Postpone this motion to a future GC meeting</p>

                    <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="table-until-date">Table Until Date *</label>
                            <input type="date" id="table-until-date">
                            <small style="font-size: 0.75rem; opacity: 0.8;">Will automatically appear on agenda for this date</small>
                        </div>
                        <div class="form-group">
                            <label for="table-reason">Reason for Tabling</label>
                            <select id="table-reason">
                                <option value="need-info">Need More Information</option>
                                <option value="need-research">Need Research Period</option>
                                <option value="waiting-report">Waiting for Report/Data</option>
                                <option value="timing">Timing Not Right</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="table-notes">Notes</label>
                        <textarea id="table-notes" rows="2" placeholder="What needs to happen before we revisit this?"></textarea>
                    </div>

                    <div style="padding: 1rem; background: #e74c3c; border-radius: 4px; margin-top: 1rem;">
                        <i class="fas fa-info-circle"></i> <strong>Note:</strong> Tabling will set status to "Tabled" and auto-add to future agenda
                    </div>
                </div>

                <input type="hidden" id="gc-edit-id">
                <input type="hidden" id="gc-amendments-data">
                <input type="hidden" id="gc-discussion-data">
                <input type="hidden" id="gc-tabled-data">
                <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                    <button id="gc-form-btn" class="btn" onclick="handleGCLogSubmit()">
                        <i class="fas fa-save"></i> Add GC Entry
                    </button>
                    <button id="gc-form-cancel-btn" class="btn secondary" onclick="cancelGCEdit()" style="display:none;">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button class="btn" onclick="exportGroupConscienceLogToPDF()" style="background: #9b59b6;">
                        <i class="fas fa-file-pdf"></i> Export GC Log
                    </button>
                </div>
            </div>

            <!-- Current & Previous GC Decisions Tables -->
            <div class="box mb-4">
                <h3><i class="fas fa-list"></i> Current Month's Group Conscience</h3>
                <div style="overflow-x: auto; margin-top: 1rem;">
                    <table id="gc-log-table-current">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Item</th>
                                <th>Submitted By</th>
                                <th>Status</th>
                                <th>Votes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="gc-log-body-current"></tbody>
                    </table>
                </div>
            </div>

            <div class="box mb-4">
                <h3><i class="fas fa-history"></i> Previous Months' Group Conscience</h3>
                <div style="overflow-x: auto; margin-top: 1rem;">
                    <table id="gc-log-table-previous">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Item</th>
                                <th>Submitted By</th>
                                <th>Status</th>
                                <th>Votes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="gc-log-body-previous"></tbody>
                    </table>
                </div>
            </div>

            <!-- Pre-GC Submission System -->
            <div class="box mb-4" style="border-left: 4px solid #f39c12;">
                <h3><i class="fas fa-calendar-alt"></i> Pre-GC Agenda Submissions</h3>
                <p class="mb-3" style="font-size: 0.85rem; opacity: 0.8;">
                    Collaborative agenda building - Submit items 7 days before meeting for member review
                </p>

                <div id="agenda-submission-notice" style="display: none; padding: 1rem; background: #f39c12; border-radius: 4px; margin-bottom: 1rem;">
                    <i class="fas fa-info-circle"></i> <span id="agenda-notice-text"></span>
                </div>

                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="proposed-item-title">Item Title *</label>
                        <input type="text" id="proposed-item-title" placeholder="Brief title for the item">
                    </div>
                    <div class="form-group">
                        <label for="proposed-item-submitter">Submitted By *</label>
                        <select id="proposed-item-submitter">
                            <option value="">Select your name...</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="proposed-item-description">Description & Rationale *</label>
                    <textarea id="proposed-item-description" rows="3" placeholder="Detailed description and why this is important..."></textarea>
                </div>

                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="proposed-item-time">Estimated Time (minutes)</label>
                        <input type="number" id="proposed-item-time" min="5" max="60" value="15" placeholder="15">
                        <small style="font-size: 0.75rem; opacity: 0.8;">How long will this discussion need?</small>
                    </div>
                    <div class="form-group">
                        <label for="proposed-item-urgency">Urgency</label>
                        <select id="proposed-item-urgency">
                            <option value="low">Low - Can wait</option>
                            <option value="medium" selected>Medium - Should discuss soon</option>
                            <option value="high">High - Time-sensitive</option>
                            <option value="urgent">Urgent - Immediate attention needed</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="proposed-item-background">Background Materials / Context</label>
                    <textarea id="proposed-item-background" rows="3" placeholder="Any relevant history, prior discussions, research, or supporting information..."></textarea>
                    <small style="font-size: 0.75rem; opacity: 0.8;">Help members make informed decisions</small>
                </div>

                <button class="btn" onclick="addProposedAgendaItem()">
                    <i class="fas fa-paper-plane"></i> Submit Agenda Item
                </button>

                <div style="margin-top: 2rem; display: flex; justify-content: space-between; align-items: center;">
                    <h4 style="margin: 0;">Proposed Agenda Items</h4>
                    <button class="btn" onclick="viewAgendaSummaryForUpcomingMeeting()" style="background: #9b59b6;">
                        <i class="fas fa-clipboard-list"></i> Generate Agenda
                    </button>
                </div>

                <div style="overflow-x: auto; margin-top: 1rem;">
                    <table id="proposed-agenda-table">
                        <thead>
                            <tr>
                                <th>Urgency</th>
                                <th>Title</th>
                                <th>Submitter</th>
                                <th>Time</th>
                                <th>Interest</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="proposed-agenda-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- FEATURE 1: Standing/Recurring Agenda Items -->
            <div class="box mb-4" style="border-left: 4px solid #9b59b6;">
                <h3><i class="fas fa-redo-alt"></i> Standing/Recurring Agenda Items</h3>
                <p class="mb-3" style="font-size: 0.85rem; opacity: 0.8;">
                    Configure items that automatically appear on agendas (monthly reports, quarterly inventory, annual elections)
                </p>

                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="standing-item-title">Item Title *</label>
                        <input type="text" id="standing-item-title" placeholder="e.g., Treasurer Report">
                    </div>
                    <div class="form-group">
                        <label for="standing-item-frequency">Frequency *</label>
                        <select id="standing-item-frequency">
                            <option value="monthly">Monthly - Every month</option>
                            <option value="quarterly">Quarterly - Every 3 months</option>
                            <option value="semi-annual">Semi-Annual - Every 6 months</option>
                            <option value="annual">Annual - Once per year</option>
                            <option value="first-meeting">First Meeting of Month</option>
                            <option value="last-meeting">Last Meeting of Month</option>
                        </select>
                    </div>
                </div>

                <div class="grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="standing-item-time">Estimated Time (min)</label>
                        <input type="number" id="standing-item-time" min="5" max="60" value="10" placeholder="10">
                    </div>
                    <div class="form-group">
                        <label for="standing-item-assignee">Assignee/Presenter</label>
                        <select id="standing-item-assignee">
                            <option value="">None</option>
                            <option value="Treasurer">Treasurer</option>
                            <option value="Secretary">Secretary</option>
                            <option value="GSR">GSR</option>
                            <option value="Chairperson">Chairperson</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="standing-item-consent">Consent Agenda?</label>
                        <select id="standing-item-consent">
                            <option value="no">No - Full discussion</option>
                            <option value="yes">Yes - Consent agenda</option>
                        </select>
                        <small style="font-size: 0.7rem; opacity: 0.7;">Consent = routine, approved without discussion</small>
                    </div>
                </div>

                <div class="form-group">
                    <label for="standing-item-description">Description</label>
                    <textarea id="standing-item-description" rows="2" placeholder="Brief description of this recurring item..."></textarea>
                </div>

                <button class="btn" onclick="addStandingAgendaItem()">
                    <i class="fas fa-plus"></i> Add Standing Item
                </button>

                <h4 class="mt-4">Active Standing Items</h4>
                <div style="overflow-x: auto; margin-top: 1rem;">
                    <table>
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Frequency</th>
                                <th>Assignee</th>
                                <th>Time</th>
                                <th>Consent</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="standing-items-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Action Items Tracking -->
            <div class="box mb-4" style="border-left: 4px solid #e74c3c;">
                <h3><i class="fas fa-tasks"></i> Action Items & Follow-Up</h3>
                <p class="mb-3" style="font-size: 0.85rem; opacity: 0.8;">Track action items with accountability, dependencies, and automatic reminders</p>

                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="action-item-description">Action Item *</label>
                        <textarea id="action-item-description" rows="2" placeholder="What needs to be done?"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="action-item-assignee">Assigned To *</label>
                        <select id="action-item-assignee"></select>
                    </div>
                    <div class="form-group">
                        <label for="action-item-due-date">Due Date *</label>
                        <input type="date" id="action-item-due-date">
                    </div>
                    <div class="form-group">
                        <label for="action-item-priority">Priority</label>
                        <select id="action-item-priority">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="action-item-related-gc">Related GC Motion</label>
                        <select id="action-item-related-gc">
                            <option value="">None</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="action-item-dependencies">Dependencies (Optional)</label>
                        <select id="action-item-dependencies" multiple style="height: 60px;">
                            <option value="">None - select other action items this depends on</option>
                        </select>
                    </div>
                </div>

                <input type="hidden" id="action-item-edit-id">
                <div style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button id="action-item-btn" class="btn" onclick="handleActionItemSubmit()">
                        <i class="fas fa-plus"></i> Add Action Item
                    </button>
                    <button id="action-item-cancel-btn" class="btn secondary" onclick="cancelActionItemEdit()" style="display:none;">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button class="btn" onclick="viewActionItemReport()" style="background: #9b59b6;">
                        <i class="fas fa-chart-bar"></i> Accountability Report
                    </button>
                </div>

                <div style="margin-top: 2rem; display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                    <h4 style="margin: 0;">Action Items</h4>
                    <div style="flex: 1;"></div>
                    <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
                        <input type="checkbox" id="action-item-show-completed" onchange="updateActionItemsTable()"> Show Completed
                    </label>
                    <select id="action-item-filter-assignee" onchange="updateActionItemsTable()" style="background: #34495e; color: #ecf0f1; border: 1px solid #7f8c8d; border-radius: 4px; padding: 0.5rem;">
                        <option value="">All Assignees</option>
                    </select>
                </div>

                <div style="overflow-x: auto; margin-top: 1rem;">
                    <table id="action-items-table">
                        <thead>
                            <tr>
                                <th>Priority</th>
                                <th>Item</th>
                                <th>Assigned To</th>
                                <th>Due Date</th>
                                <th>Progress</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="action-items-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- FEATURE 9: Decision Implementation Tracking -->
            <div class="box mb-4" style="border-left: 4px solid #1abc9c;">
                <h3><i class="fas fa-clipboard-check"></i> Decision Implementation Tracking</h3>
                <p class="mb-3" style="font-size: 0.85rem; opacity: 0.8;">
                    Track the full lifecycle of decisions from approval through implementation to outcomes
                </p>

                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="impl-decision">Decision to Track *</label>
                        <select id="impl-decision" onchange="loadDecisionForImplementation()">
                            <option value="">Select a passed decision...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="impl-status">Implementation Status *</label>
                        <select id="impl-status">
                            <option value="planned">Planned - Not started</option>
                            <option value="in-progress">In Progress - Currently implementing</option>
                            <option value="completed">Completed - Fully implemented</option>
                            <option value="delayed">Delayed - Behind schedule</option>
                            <option value="blocked">Blocked - Cannot proceed</option>
                            <option value="abandoned">Abandoned - Decision reversed</option>
                        </select>
                    </div>
                </div>

                <div class="grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="impl-start-date">Start Date</label>
                        <input type="date" id="impl-start-date">
                    </div>
                    <div class="form-group">
                        <label for="impl-target-date">Target Completion Date</label>
                        <input type="date" id="impl-target-date">
                    </div>
                    <div class="form-group">
                        <label for="impl-actual-date">Actual Completion Date</label>
                        <input type="date" id="impl-actual-date">
                    </div>
                </div>

                <div class="form-group">
                    <label for="impl-progress">Progress (%)</label>
                    <input type="range" id="impl-progress" min="0" max="100" value="0" oninput="document.getElementById('impl-progress-value').textContent = this.value + '%'">
                    <div style="text-align: center; margin-top: 0.5rem;">
                        <strong id="impl-progress-value">0%</strong>
                    </div>
                </div>

                <div class="form-group">
                    <label for="impl-milestones">Milestones/Steps Completed</label>
                    <textarea id="impl-milestones" rows="3" placeholder="List key milestones and checkpoints achieved..."></textarea>
                </div>

                <div class="form-group">
                    <label for="impl-challenges">Challenges/Blockers</label>
                    <textarea id="impl-challenges" rows="2" placeholder="Any obstacles or issues encountered..."></textarea>
                </div>

                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="impl-outcome">Outcome Assessment</label>
                        <select id="impl-outcome">
                            <option value="">Not yet assessed</option>
                            <option value="exceeded">Exceeded Expectations</option>
                            <option value="met">Met Expectations</option>
                            <option value="partial">Partially Met Expectations</option>
                            <option value="below">Below Expectations</option>
                            <option value="failed">Failed to Achieve Goal</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="impl-owner">Implementation Owner</label>
                        <select id="impl-owner"></select>
                    </div>
                </div>

                <button class="btn" onclick="saveDecisionImplementation()">
                    <i class="fas fa-save"></i> Save Implementation Update
                </button>

                <h4 class="mt-4">Implementation Status Dashboard</h4>
                <div style="overflow-x: auto; margin-top: 1rem;">
                    <table>
                        <thead>
                            <tr>
                                <th>Decision</th>
                                <th>Status</th>
                                <th>Progress</th>
                                <th>Owner</th>
                                <th>Target Date</th>
                                <th>Outcome</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="implementation-tracking-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- FEATURE 8: Member Voting History -->
            <div class="box mb-4" style="border-left: 4px solid #3498db;">
                <h3><i class="fas fa-user-check"></i> Member Voting History</h3>
                <p class="mb-3" style="font-size: 0.85rem; opacity: 0.8;">
                    Track individual member participation and voting patterns for accountability
                </p>

                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="voting-history-member">Select Member *</label>
                        <select id="voting-history-member" onchange="loadMemberVotingHistory()"></select>
                    </div>
                    <div class="form-group">
                        <label for="voting-history-period">Time Period</label>
                        <select id="voting-history-period" onchange="loadMemberVotingHistory()">
                            <option value="30">Last 30 Days</option>
                            <option value="90" selected>Last 90 Days</option>
                            <option value="180">Last 6 Months</option>
                            <option value="365">Last Year</option>
                            <option value="all">All Time</option>
                        </select>
                    </div>
                </div>

                <div id="member-voting-stats" style="display: none; padding: 1.5rem; background: #2c3e50; border-radius: 6px; margin-top: 1rem;">
                    <h4 style="margin-bottom: 1rem; color: #3498db;">Participation Statistics</h4>
                    <div class="grid" style="grid-template-columns: repeat(4, 1fr); gap: 1rem; text-align: center;">
                        <div>
                            <div style="font-size: 2rem; font-weight: bold; color: #2ecc71;" id="votes-participated">0</div>
                            <div style="font-size: 0.85rem; opacity: 0.8;">Votes Participated</div>
                        </div>
                        <div>
                            <div style="font-size: 2rem; font-weight: bold; color: #3498db;" id="votes-for-total">0</div>
                            <div style="font-size: 0.85rem; opacity: 0.8;">Voted For</div>
                        </div>
                        <div>
                            <div style="font-size: 2rem; font-weight: bold; color: #e74c3c;" id="votes-against-total">0</div>
                            <div style="font-size: 0.85rem; opacity: 0.8;">Voted Against</div>
                        </div>
                        <div>
                            <div style="font-size: 2rem; font-weight: bold; color: #95a5a6;" id="votes-abstain-total">0</div>
                            <div style="font-size: 0.85rem; opacity: 0.8;">Abstained</div>
                        </div>
                    </div>
                    <div style="margin-top: 1.5rem;">
                        <strong>Participation Rate:</strong> <span id="participation-rate">0%</span>
                    </div>
                </div>

                <h4 class="mt-4">Voting Record</h4>
                <div style="overflow-x: auto; margin-top: 1rem;">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Motion</th>
                                <th>Vote</th>
                                <th>Result</th>
                                <th>Consensus</th>
                            </tr>
                        </thead>
                        <tbody id="member-voting-history-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- FEATURE 10: Consent Agenda -->
            <div class="box mb-4" style="border-left: 4px solid #2ecc71;">
                <h3><i class="fas fa-check-double"></i> Consent Agenda</h3>
                <p class="mb-3" style="font-size: 0.85rem; opacity: 0.8;">
                    Batch-approve routine items in one vote to save time (any item can be pulled for discussion)
                </p>

                <div style="padding: 1rem; background: #27ae60; border-radius: 4px; margin-bottom: 1rem;">
                    <i class="fas fa-info-circle"></i> <strong>How it works:</strong> Members review all items. If no objections, approve all at once. Any member can request discussion on specific items.
                </div>

                <h4>Items for Next Consent Agenda</h4>
                <div style="overflow-x: auto; margin-top: 1rem;">
                    <table>
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" id="consent-select-all" onchange="toggleAllConsentItems()">
                                </th>
                                <th>Item</th>
                                <th>Type</th>
                                <th>Submitter</th>
                                <th>Pull for Discussion?</th>
                            </tr>
                        </thead>
                        <tbody id="consent-agenda-body"></tbody>
                    </table>
                </div>

                <div style="margin-top: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button class="btn" onclick="approveConsentAgenda()" style="background: #2ecc71;">
                        <i class="fas fa-check"></i> Approve All Consent Items
                    </button>
                    <button class="btn" onclick="pullConsentItems()" style="background: #f39c12;">
                        <i class="fas fa-hand-paper"></i> Pull Selected for Discussion
                    </button>
                    <button class="btn" onclick="refreshConsentAgenda()">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                </div>

                <h4 class="mt-4">Previously Approved via Consent</h4>
                <div id="consent-history" style="font-size: 0.9rem; opacity: 0.9; margin-top: 1rem;"></div>
            </div>

            <!-- FEATURE 6: Enhanced Decision Search & Smart Filtering -->
            <div class="box mb-4" style="border-left: 4px solid #2ecc71;">
                <h3><i class="fas fa-search-plus"></i> Enhanced Decision Search & Smart Filtering</h3>

                <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                    <div class="form-group">
                        <label for="gc-search">Search GC History</label>
                        <input type="text" id="gc-search" placeholder="Search by motion, submitter, keywords, tags..." oninput="searchGCHistory()">
                    </div>
                    <div class="form-group">
                        <label for="gc-filter-status">Filter by Status</label>
                        <select id="gc-filter-status" onchange="searchGCHistory()">
                            <option value="">All</option>
                            <option value="passed">Passed</option>
                            <option value="failed">Failed</option>
                            <option value="tabled">Tabled</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="gc-filter-category">Category</label>
                        <select id="gc-filter-category" onchange="searchGCHistory()">
                            <option value="">All Categories</option>
                            <option value="financial">Financial</option>
                            <option value="service">Service</option>
                            <option value="meeting">Meeting</option>
                            <option value="property">Property</option>
                            <option value="traditions">Traditions</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="gc-filter-date-from">From Date</label>
                        <input type="date" id="gc-filter-date-from" onchange="searchGCHistory()">
                    </div>
                    <div class="form-group">
                        <label for="gc-filter-date-to">To Date</label>
                        <input type="date" id="gc-filter-date-to" onchange="searchGCHistory()">
                    </div>
                    <div class="form-group">
                        <label for="gc-filter-submitter">Submitted By</label>
                        <select id="gc-filter-submitter" onchange="searchGCHistory()">
                            <option value="">All Submitters</option>
                        </select>
                    </div>
                </div>

                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem;">
                    <button class="btn" onclick="searchGCHistory()" style="background: #2ecc71;">
                        <i class="fas fa-search"></i> Search
                    </button>
                    <button class="btn" onclick="clearGCSearch()">
                        <i class="fas fa-eraser"></i> Clear Filters
                    </button>
                    <button class="btn" onclick="showRelatedDecisions()" style="background: #3498db;">
                        <i class="fas fa-link"></i> Find Related Decisions
                    </button>
                    <button class="btn" onclick="exportSearchResults()" style="background: #9b59b6;">
                        <i class="fas fa-download"></i> Export Results
                    </button>
                </div>

                <!-- Smart Suggestions -->
                <div id="search-suggestions" style="display: none; padding: 1rem; background: #3498db; border-radius: 4px; margin-bottom: 1rem;">
                    <strong><i class="fas fa-lightbulb"></i> Similar Decisions Found:</strong>
                    <div id="suggestions-list" style="margin-top: 0.5rem;"></div>
                </div>

                <h4 class="mt-3">Search Results</h4>
                <div style="overflow-x: auto;">
                    <table id="gc-history-search-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Motion</th>
                                <th>Status</th>
                                <th>Votes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="gc-history-search-body"></tbody>
                    </table>
                </div>

                <h4 class="mt-4">Quick Statistics</h4>
                <div id="gc-stats" style="padding: 1rem; background: #2c3e50; border-radius: 6px; margin-bottom: 1.5rem;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                        <div>
                            <strong style="color: #3498db;">Total Motions:</strong>
                            <div id="stat-total-motions" style="font-size: 1.5rem;">0</div>
                        </div>
                        <div>
                            <strong style="color: #2ecc71;">Passed:</strong>
                            <div id="stat-passed-motions" style="font-size: 1.5rem;">0</div>
                        </div>
                        <div>
                            <strong style="color: #e74c3c;">Failed:</strong>
                            <div id="stat-failed-motions" style="font-size: 1.5rem;">0</div>
                        </div>
                        <div>
                            <strong style="color: #f39c12;">Tabled:</strong>
                            <div id="stat-tabled-motions" style="font-size: 1.5rem;">0</div>
                        </div>
                        <div>
                            <strong style="color: #3498db;">Pass Rate:</strong>
                            <div id="stat-pass-rate" style="font-size: 1.5rem;">0%</div>
                        </div>
                    </div>
                </div>

                <!-- GC Trends Dashboard -->
                <h4 class="mt-4"><i class="fas fa-chart-bar"></i> Group Conscience Trends & Analysis</h4>
                <div class="trends-grid">
                    <div class="trend-chart-container">
                        <h4>Monthly Motion Activity</h4>
                        <div style="position: relative; height: 250px;">
                            <canvas id="gc-trends-monthly-chart"></canvas>
                        </div>
                    </div>
                    <div class="trend-chart-container">
                        <h4>Pass/Fail/Tabled Distribution</h4>
                        <div style="position: relative; height: 250px;">
                            <canvas id="gc-trends-status-chart"></canvas>
                        </div>
                    </div>
                    <div class="trend-chart-container">
                        <h4>Voting Participation Trend</h4>
                        <div style="position: relative; height: 250px;">
                            <canvas id="gc-trends-participation-chart"></canvas>
                        </div>
                    </div>
                    <div class="trend-chart-container">
                        <h4>Top Motion Topics (Keywords)</h4>
                        <div id="gc-top-topics" style="padding: 1rem; max-height: 250px; overflow-y: auto;">
                            <!-- Top topics will be listed here -->
                        </div>
                    </div>
                </div>

                <!-- Annual Summary Report Generator -->
                <h4 class="mt-4"><i class="fas fa-file-pdf"></i> Annual Summary Report</h4>
                <div style="padding: 1rem; background: #2c3e50; border-radius: 6px;">
                    <div class="form-group">
                        <label for="annual-report-year">Select Year</label>
                        <select id="annual-report-year" style="max-width: 200px;">
                            <!-- Years will be populated dynamically -->
                        </select>
                    </div>
                    <button class="btn" onclick="generateAnnualReport()">
                        <i class="fas fa-file-pdf"></i> Generate Annual PDF Report
                    </button>
                    <button class="btn secondary" onclick="refreshGCTrends()" style="margin-left: 0.5rem;">
                        <i class="fas fa-sync"></i> Refresh Charts
                    </button>
                </div>
            </div>

            <!-- Motion Linking & History Section -->
            <h3 class="mt-4"><i class="fas fa-link"></i> Motion Relationships & History</h3>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Search Decisions</h3>
                        <div class="form-group">
                            <label for="gc-search">Search by keyword, topic, or date</label>
                            <input type="text" id="gc-search" placeholder="Search decisions...">
                        </div>
                        <div class="form-group">
                            <label for="gc-filter-status">Filter by Status</label>
                            <select id="gc-filter-status">
                                <option value="all">All Decisions</option>
                                <option value="passed">Passed</option>
                                <option value="failed">Failed</option>
                                <option value="tabled">Tabled</option>
                                <option value="amended">Amended</option>
                                <option value="superseded">Superseded</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="gc-filter-year">Filter by Year</label>
                            <select id="gc-filter-year">
                                <option value="all">All Years</option>
                            </select>
                        </div>
                        <button class="btn" onclick="searchGCDecisions()">Search</button>
                    </div>

                    <div class="box mt-4">
                        <h3>Link Related Motions</h3>
                        <div class="form-group">
                            <label for="gc-link-primary">Primary Motion</label>
                            <select id="gc-link-primary"></select>
                        </div>
                        <div class="form-group">
                            <label for="gc-link-related">Related Motion</label>
                            <select id="gc-link-related"></select>
                        </div>
                        <div class="form-group">
                            <label for="gc-link-type">Relationship Type</label>
                            <select id="gc-link-type">
                                <option value="amends">Amends</option>
                                <option value="supersedes">Supersedes</option>
                                <option value="related">Related To</option>
                                <option value="implements">Implements</option>
                            </select>
                        </div>
                        <button class="btn" onclick="linkGCMotions()">Link Motions</button>
                    </div>
                </div>

                <div>
                    <div class="box">
                        <h3>Decision History</h3>
                        <div id="gc-decisions-list" style="max-height: 600px; overflow-y: auto;"></div>
                    </div>

                    <div class="box mt-4">
                        <h3>Motion Chain Viewer</h3>
                        <p style="font-size: 0.85rem; margin-bottom: 1rem;">Click any motion to view its full history chain</p>
                        <div id="motion-chain-display" style="padding: 1rem; background: #2c3e50; border-radius: 6px;"></div>
                    </div>
                </div>
            </div>

            <!-- FEATURE 7: Email Integration for Agendas/Minutes -->
            <div class="box mb-4" style="border-left: 4px solid #e67e22;">
                <h3><i class="fas fa-envelope"></i> Email Integration - Agendas & Minutes</h3>
                <p class="mb-3" style="font-size: 0.85rem; opacity: 0.8;">
                    Automatically send meeting agendas before GC and minutes after meetings via email
                </p>

                <div style="padding: 1rem; background: #34495e; border-radius: 4px; margin-bottom: 1.5rem;">
                    <h4 style="margin-bottom: 0.75rem; color: #e67e22;"><i class="fas fa-cog"></i> Email Configuration</h4>

                    <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="email-from-address">From Email Address</label>
                            <input type="email" id="email-from-address" placeholder="group@example.com">
                            <small style="font-size: 0.75rem; opacity: 0.7;">Group's email address (display only - uses mailto:)</small>
                        </div>
                        <div class="form-group">
                            <label for="email-from-name">From Name</label>
                            <input type="text" id="email-from-name" placeholder="Rowlett AA Group">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="email-recipient-list">Default Recipient List</label>
                        <textarea id="email-recipient-list" rows="3" placeholder="Enter email addresses, one per line or comma-separated..."></textarea>
                        <small style="font-size: 0.75rem; opacity: 0.7;">Members' email addresses for agenda and minutes distribution</small>
                    </div>

                    <button class="btn" onclick="saveEmailSettings()" style="background: #e67e22;">
                        <i class="fas fa-save"></i> Save Email Settings
                    </button>
                </div>

                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <!-- Send Agenda -->
                    <div style="padding: 1rem; background: #3498db; border-radius: 6px;">
                        <h4 style="color: white; margin-bottom: 0.75rem;"><i class="fas fa-calendar-alt"></i> Send Agenda</h4>

                        <div class="form-group">
                            <label for="agenda-meeting-date" style="color: white;">Meeting Date</label>
                            <input type="date" id="agenda-meeting-date">
                        </div>

                        <div class="form-group">
                            <label style="color: white;">
                                <input type="checkbox" id="agenda-include-standing" checked> Include Standing Items
                            </label>
                        </div>

                        <div class="form-group">
                            <label style="color: white;">
                                <input type="checkbox" id="agenda-include-tabled" checked> Include Tabled Motions
                            </label>
                        </div>

                        <button class="btn" onclick="generateAndEmailAgenda()" style="background: white; color: #3498db;">
                            <i class="fas fa-paper-plane"></i> Generate & Email Agenda
                        </button>

                        <div id="agenda-preview" style="display: none; margin-top: 1rem; padding: 1rem; background: white; color: #2c3e50; border-radius: 4px; font-size: 0.85rem; max-height: 300px; overflow-y: auto;"></div>
                    </div>

                    <!-- Send Minutes -->
                    <div style="padding: 1rem; background: #2ecc71; border-radius: 6px;">
                        <h4 style="color: white; margin-bottom: 0.75rem;"><i class="fas fa-file-alt"></i> Send Minutes</h4>

                        <div class="form-group">
                            <label for="minutes-meeting-date" style="color: white;">Meeting Date</label>
                            <input type="date" id="minutes-meeting-date">
                        </div>

                        <div class="form-group">
                            <label style="color: white;">
                                <input type="checkbox" id="minutes-include-discussion" checked> Include Discussion Thread
                            </label>
                        </div>

                        <div class="form-group">
                            <label style="color: white;">
                                <input type="checkbox" id="minutes-include-amendments"> Include Amendments
                            </label>
                        </div>

                        <button class="btn" onclick="generateAndEmailMinutes()" style="background: white; color: #2ecc71;">
                            <i class="fas fa-paper-plane"></i> Generate & Email Minutes
                        </button>

                        <div id="minutes-preview" style="display: none; margin-top: 1rem; padding: 1rem; background: white; color: #2c3e50; border-radius: 4px; font-size: 0.85rem; max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>

                <div style="margin-top: 1.5rem; padding: 1rem; background: #34495e; border-radius: 4px;">
                    <h4 style="margin-bottom: 0.75rem;"><i class="fas fa-history"></i> Email Send History</h4>
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date Sent</th>
                                    <th>Type</th>
                                    <th>Meeting Date</th>
                                    <th>Recipients</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="email-history-body"></tbody>
                        </table>
                    </div>
                </div>

                <div style="margin-top: 1rem; padding: 1rem; background: #f39c12; border-radius: 4px;">
                    <i class="fas fa-info-circle"></i> <strong>Note:</strong> This uses your device's default email client (mailto:). For automated email delivery, consider integrating with an email service provider.
                </div>
            </div>

            <!-- MEDIUM PRIORITY FEATURE 11: Motion Reconsideration Workflow -->
            <div class="box mb-4" style="border-left: 4px solid #8e44ad;">
                <h3><i class="fas fa-redo"></i> Motion Reconsideration Workflow</h3>
                <p class="mb-3" style="font-size: 0.85rem; opacity: 0.8;">
                    Formally reconsider a previously decided motion with new information
                </p>

                <div style="padding: 1rem; background: #8e44ad; border-radius: 4px; margin-bottom: 1.5rem;">
                    <i class="fas fa-info-circle"></i> <strong>AA Tradition Note:</strong> Reconsideration should be rare and only when significant new information emerges or circumstances change substantially.
                </div>

                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="reconsider-original-decision">Original Decision to Reconsider *</label>
                        <select id="reconsider-original-decision" onchange="loadOriginalDecision()">
                            <option value="">Select a past decision...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="reconsider-requested-by">Requested By *</label>
                        <select id="reconsider-requested-by"></select>
                    </div>
                </div>

                <div id="original-decision-summary" style="display: none; padding: 1rem; background: #2c3e50; border-radius: 4px; margin-bottom: 1rem;">
                    <h4 style="margin-bottom: 0.5rem;">Original Decision Summary</h4>
                    <div id="original-decision-details"></div>
                </div>

                <div class="form-group">
                    <label for="reconsider-reason">Reason for Reconsideration *</label>
                    <select id="reconsider-reason">
                        <option value="new-information">Significant New Information</option>
                        <option value="changed-circumstances">Changed Circumstances</option>
                        <option value="implementation-issues">Implementation Issues Discovered</option>
                        <option value="tradition-conflict">Potential Tradition Conflict</option>
                        <option value="financial-impact">Unexpected Financial Impact</option>
                        <option value="member-feedback">Substantial Member Feedback</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="reconsider-justification">Detailed Justification *</label>
                    <textarea id="reconsider-justification" rows="4" placeholder="Explain what new information or changes justify reconsidering this decision..."></textarea>
                </div>

                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="reconsider-proposed-date">Proposed Reconsideration Date</label>
                        <input type="date" id="reconsider-proposed-date">
                    </div>
                    <div class="form-group">
                        <label for="reconsider-research-period">Research Period (days)</label>
                        <input type="number" id="reconsider-research-period" min="7" max="90" value="14" placeholder="14">
                    </div>
                </div>

                <div class="form-group">
                    <label for="reconsider-proposed-change">Proposed Change/Alternative</label>
                    <textarea id="reconsider-proposed-change" rows="3" placeholder="What specific change are you proposing?"></textarea>
                </div>

                <button class="btn" onclick="submitReconsiderationRequest()" style="background: #8e44ad;">
                    <i class="fas fa-paper-plane"></i> Submit Reconsideration Request
                </button>

                <h4 class="mt-4">Pending Reconsideration Requests</h4>
                <div style="overflow-x: auto; margin-top: 1rem;">
                    <table>
                        <thead>
                            <tr>
                                <th>Original Motion</th>
                                <th>Requested By</th>
                                <th>Reason</th>
                                <th>Proposed Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reconsideration-requests-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- MEDIUM PRIORITY FEATURE 12: Calendar Integration -->
            <div class="box mb-4" style="border-left: 4px solid #16a085;">
                <h3><i class="fas fa-calendar-plus"></i> Calendar Integration</h3>
                <p class="mb-3" style="font-size: 0.85rem; opacity: 0.8;">
                    Sync GC meetings and decision deadlines to Google Calendar, Outlook, or Apple Calendar
                </p>

                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div style="padding: 1rem; background: #3498db; border-radius: 6px;">
                        <h4 style="color: white; margin-bottom: 0.75rem;"><i class="fas fa-calendar-alt"></i> Add GC Meeting to Calendar</h4>

                        <div class="form-group">
                            <label for="cal-meeting-date" style="color: white;">Meeting Date *</label>
                            <input type="date" id="cal-meeting-date">
                        </div>

                        <div class="form-group">
                            <label for="cal-meeting-time" style="color: white;">Meeting Time</label>
                            <input type="time" id="cal-meeting-time" value="18:00">
                        </div>

                        <div class="form-group">
                            <label for="cal-duration" style="color: white;">Duration (hours)</label>
                            <input type="number" id="cal-duration" min="0.5" max="4" step="0.5" value="1.5">
                        </div>

                        <div class="form-group">
                            <label for="cal-location" style="color: white;">Location</label>
                            <input type="text" id="cal-location" placeholder="Meeting location">
                        </div>

                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 1rem;">
                            <button class="btn" onclick="exportToGoogleCalendar()" style="background: white; color: #4285F4;">
                                <i class="fab fa-google"></i> Google
                            </button>
                            <button class="btn" onclick="exportToOutlook()" style="background: white; color: #0078D4;">
                                <i class="fab fa-microsoft"></i> Outlook
                            </button>
                            <button class="btn" onclick="exportToICS()" style="background: white; color: #3498db;">
                                <i class="fas fa-download"></i> .ICS
                            </button>
                        </div>
                    </div>

                    <div style="padding: 1rem; background: #e74c3c; border-radius: 6px;">
                        <h4 style="color: white; margin-bottom: 0.75rem;"><i class="fas fa-clock"></i> Add Decision Deadline</h4>

                        <div class="form-group">
                            <label for="cal-decision-title" style="color: white;">Decision Title *</label>
                            <input type="text" id="cal-decision-title" placeholder="e.g., Vote on Rent Increase">
                        </div>

                        <div class="form-group">
                            <label for="cal-deadline-date" style="color: white;">Deadline Date *</label>
                            <input type="date" id="cal-deadline-date">
                        </div>

                        <div class="form-group">
                            <label for="cal-reminder" style="color: white;">Reminder</label>
                            <select id="cal-reminder">
                                <option value="0">None</option>
                                <option value="1">1 day before</option>
                                <option value="3">3 days before</option>
                                <option value="7" selected>1 week before</option>
                            </select>
                        </div>

                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 1rem;">
                            <button class="btn" onclick="exportDeadlineToGoogleCalendar()" style="background: white; color: #4285F4;">
                                <i class="fab fa-google"></i> Google
                            </button>
                            <button class="btn" onclick="exportDeadlineToOutlook()" style="background: white; color: #0078D4;">
                                <i class="fab fa-microsoft"></i> Outlook
                            </button>
                            <button class="btn" onclick="exportDeadlineToICS()" style="background: white; color: #e74c3c;">
                                <i class="fas fa-download"></i> .ICS
                            </button>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 1.5rem; padding: 1rem; background: #34495e; border-radius: 4px;">
                    <h4 style="margin-bottom: 0.75rem;"><i class="fas fa-list"></i> Upcoming Calendar Events</h4>
                    <div id="upcoming-calendar-events"></div>
                </div>
            </div>

            <!-- MEDIUM PRIORITY FEATURE 13: Decision ROI/Impact Calculator -->
            <div class="box mb-4" style="border-left: 4px solid #f39c12;">
                <h3><i class="fas fa-calculator"></i> Decision ROI/Impact Calculator</h3>
                <p class="mb-3" style="font-size: 0.85rem; opacity: 0.8;">
                    Predict financial impact and return on investment before voting on financial decisions
                </p>

                <div class="grid" style="grid-template-columns: 1fr 2fr; gap: 2rem;">
                    <div>
                        <div class="form-group">
                            <label for="roi-decision-title">Decision Title *</label>
                            <input type="text" id="roi-decision-title" placeholder="e.g., Purchase New Coffee Maker">
                        </div>

                        <div class="form-group">
                            <label for="roi-initial-cost">Initial Cost ($) *</label>
                            <input type="number" id="roi-initial-cost" step="0.01" placeholder="0.00">
                        </div>

                        <div class="form-group">
                            <label for="roi-ongoing-cost">Monthly Ongoing Cost ($)</label>
                            <input type="number" id="roi-ongoing-cost" step="0.01" placeholder="0.00">
                            <small style="font-size: 0.75rem; opacity: 0.7;">Maintenance, supplies, etc.</small>
                        </div>

                        <div class="form-group">
                            <label for="roi-revenue-impact">Monthly Revenue Impact ($)</label>
                            <input type="number" id="roi-revenue-impact" step="0.01" placeholder="0.00">
                            <small style="font-size: 0.75rem; opacity: 0.7;">Increased 7th tradition, etc.</small>
                        </div>

                        <div class="form-group">
                            <label for="roi-expense-savings">Monthly Expense Savings ($)</label>
                            <input type="number" id="roi-expense-savings" step="0.01" placeholder="0.00">
                            <small style="font-size: 0.75rem; opacity: 0.7;">What costs will this reduce?</small>
                        </div>

                        <div class="form-group">
                            <label for="roi-timeframe">Timeframe (months)</label>
                            <input type="number" id="roi-timeframe" min="1" max="60" value="12" placeholder="12">
                        </div>

                        <button class="btn" onclick="calculateROI()" style="background: #f39c12;">
                            <i class="fas fa-chart-line"></i> Calculate Impact
                        </button>
                    </div>

                    <div>
                        <div id="roi-results" style="display: none;">
                            <div style="padding: 1.5rem; background: #2c3e50; border-radius: 6px; margin-bottom: 1rem;">
                                <h4 style="color: #f39c12; margin-bottom: 1rem;">Financial Impact Summary</h4>

                                <div class="grid" style="grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                                    <div style="text-align: center;">
                                        <div style="font-size: 2rem; font-weight: bold;" id="roi-total-cost-display">$0</div>
                                        <div style="font-size: 0.85rem; opacity: 0.8;">Total Cost</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 2rem; font-weight: bold;" id="roi-net-impact-display">$0</div>
                                        <div style="font-size: 0.85rem; opacity: 0.8;">Net Impact</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 2rem; font-weight: bold;" id="roi-payback-display">N/A</div>
                                        <div style="font-size: 0.85rem; opacity: 0.8;">Payback Period</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 2rem; font-weight: bold;" id="roi-percentage-display">0%</div>
                                        <div style="font-size: 0.85rem; opacity: 0.8;">ROI</div>
                                    </div>
                                </div>

                                <div id="roi-recommendation" style="padding: 1rem; border-radius: 4px; margin-bottom: 1rem;"></div>

                                <canvas id="roi-chart"></canvas>
                            </div>

                            <div style="padding: 1rem; background: #34495e; border-radius: 4px;">
                                <h4 style="margin-bottom: 0.75rem;">Budget Impact Analysis</h4>
                                <div id="budget-impact-details"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MEDIUM PRIORITY FEATURE 14: Proxy Voting System -->
            <div class="box mb-4" style="border-left: 4px solid #9b59b6;">
                <h3><i class="fas fa-user-friends"></i> Proxy Voting System</h3>
                <p class="mb-3" style="font-size: 0.85rem; opacity: 0.8;">
                    Allow members to designate proxy voters when unable to attend GC meetings
                </p>

                <div style="padding: 1rem; background: #e67e22; border-radius: 4px; margin-bottom: 1.5rem;">
                    <i class="fas fa-exclamation-triangle"></i> <strong>Important:</strong> Proxy voting should align with group guidelines. Some groups may not allow proxies. Check your bylaws first.
                </div>

                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <div>
                        <h4><i class="fas fa-user-plus"></i> Designate Proxy</h4>

                        <div class="form-group">
                            <label for="proxy-member">Your Name *</label>
                            <select id="proxy-member"></select>
                        </div>

                        <div class="form-group">
                            <label for="proxy-designated-voter">Designate Proxy To *</label>
                            <select id="proxy-designated-voter"></select>
                            <small style="font-size: 0.75rem; opacity: 0.7;">This person will vote on your behalf</small>
                        </div>

                        <div class="form-group">
                            <label for="proxy-meeting-date">For Meeting Date *</label>
                            <input type="date" id="proxy-meeting-date">
                        </div>

                        <div class="form-group">
                            <label for="proxy-scope">Proxy Scope</label>
                            <select id="proxy-scope" onchange="toggleProxyInstructions()">
                                <option value="general">General Proxy - Vote as they see fit</option>
                                <option value="directed">Directed Proxy - Vote as I specify</option>
                            </select>
                        </div>

                        <div id="proxy-directed-instructions" style="display: none;">
                            <div class="form-group">
                                <label for="proxy-instructions">Voting Instructions</label>
                                <textarea id="proxy-instructions" rows="3" placeholder="Specify how you want your proxy to vote on each item..."></textarea>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="proxy-reason">Reason for Proxy</label>
                            <select id="proxy-reason">
                                <option value="travel">Travel</option>
                                <option value="work">Work Conflict</option>
                                <option value="health">Health Issue</option>
                                <option value="emergency">Emergency</option>
                                <option value="other">Other</option>
                            </select>
                        </div>

                        <button class="btn" onclick="submitProxyDesignation()" style="background: #9b59b6;">
                            <i class="fas fa-save"></i> Submit Proxy Designation
                        </button>
                    </div>

                    <div>
                        <h4><i class="fas fa-list-alt"></i> Active Proxies</h4>
                        <div style="overflow-x: auto; margin-top: 1rem;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Member</th>
                                        <th>Proxy</th>
                                        <th>Meeting</th>
                                        <th>Type</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="active-proxies-body"></tbody>
                            </table>
                        </div>

                        <h4 class="mt-4"><i class="fas fa-user-check"></i> My Proxy Assignments</h4>
                        <p style="font-size: 0.85rem; opacity: 0.8;">Meetings where others have designated you to vote for them</p>
                        <div id="my-proxy-assignments"></div>
                    </div>
                </div>
            </div>

            <!-- MEDIUM PRIORITY FEATURE 15: Decision Reversal Tracking -->
            <div class="box mb-4" style="border-left: 4px solid #e74c3c;">
                <h3><i class="fas fa-exchange-alt"></i> Decision Reversal Tracking</h3>
                <p class="mb-3" style="font-size: 0.85rem; opacity: 0.8;">
                    Track when and why decisions are reversed to learn from past patterns
                </p>

                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="reversal-original-decision">Original Decision *</label>
                        <select id="reversal-original-decision" onchange="loadReversalDecision()"></select>
                    </div>
                    <div class="form-group">
                        <label for="reversal-new-decision">New/Replacement Decision *</label>
                        <select id="reversal-new-decision"></select>
                    </div>
                </div>

                <div id="reversal-original-summary" style="display: none; padding: 1rem; background: #2c3e50; border-radius: 4px; margin-bottom: 1rem;">
                    <h4>Original Decision</h4>
                    <div id="reversal-original-details"></div>
                </div>

                <div class="form-group">
                    <label for="reversal-reason-category">Reversal Reason Category *</label>
                    <select id="reversal-reason-category">
                        <option value="ineffective">Original Decision Ineffective</option>
                        <option value="unintended-consequences">Unintended Consequences</option>
                        <option value="financial">Financial Reasons</option>
                        <option value="changed-circumstances">Circumstances Changed</option>
                        <option value="tradition-conflict">Tradition/Principle Conflict</option>
                        <option value="member-feedback">Member Feedback/Unity Issues</option>
                        <option value="better-alternative">Better Alternative Found</option>
                        <option value="implementation-failed">Implementation Failed</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="reversal-explanation">Detailed Explanation *</label>
                    <textarea id="reversal-explanation" rows="4" placeholder="Explain why the original decision is being reversed and what we learned..."></textarea>
                </div>

                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="reversal-date">Reversal Date</label>
                        <input type="date" id="reversal-date">
                    </div>
                    <div class="form-group">
                        <label for="reversal-months-elapsed">Months Since Original</label>
                        <input type="number" id="reversal-months-elapsed" readonly>
                    </div>
                </div>

                <div class="form-group">
                    <label for="reversal-lessons-learned">Lessons Learned *</label>
                    <textarea id="reversal-lessons-learned" rows="3" placeholder="What can we learn to avoid similar issues in the future?"></textarea>
                </div>

                <button class="btn" onclick="saveDecisionReversal()" style="background: #e74c3c;">
                    <i class="fas fa-save"></i> Record Reversal
                </button>

                <h4 class="mt-4">Reversal History & Analysis</h4>
                <div style="overflow-x: auto; margin-top: 1rem;">
                    <table>
                        <thead>
                            <tr>
                                <th>Original Decision</th>
                                <th>Reversed To</th>
                                <th>Reason</th>
                                <th>Time Elapsed</th>
                                <th>Lessons Learned</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="decision-reversals-body"></tbody>
                    </table>
                </div>

                <div class="mt-4" style="padding: 1.5rem; background: #2c3e50; border-radius: 6px;">
                    <h4 style="margin-bottom: 1rem;"><i class="fas fa-chart-pie"></i> Reversal Patterns Analysis</h4>
                    <div class="grid" style="grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: #e74c3c;" id="total-reversals-count">0</div>
                            <div style="font-size: 0.85rem; opacity: 0.8;">Total Reversals</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: #f39c12;" id="avg-reversal-time">0</div>
                            <div style="font-size: 0.85rem; opacity: 0.8;">Avg Time to Reversal</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: #3498db;" id="most-common-reason">N/A</div>
                            <div style="font-size: 0.85rem; opacity: 0.8;">Most Common Reason</div>
                        </div>
                    </div>
                    <div style="margin-top: 1.5rem;">
                        <canvas id="reversal-reasons-chart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- GC INVENTORY SECTION -->
        <section id="gc-inventory-section" style="border-left: 4px solid #9b59b6;">
            <h2><i class="fas fa-tasks"></i> Group Conscience Inventory</h2>
            <p class="mb-4">Tradition inventory questions, Concept templates, and anonymous feedback collection.</p>

            <div class="box mb-4">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3>Select Inventory Type</h3>
                    <button class="btn secondary" onclick="exportInventoryResults()">Export Results</button>
                </div>
                <div class="form-group">
                    <select id="inventory-type" onchange="loadInventoryTemplate()">
                        <option value="">-- Select Type --</option>
                        <option value="traditions">12 Traditions Inventory</option>
                        <option value="concepts">12 Concepts Inventory</option>
                        <option value="group-health">Group Health Check</option>
                        <option value="annual">Annual Group Inventory</option>
                    </select>
                </div>
            </div>

            <div id="inventory-questions-container"></div>

            <div class="box mt-4">
                <h3>Anonymous Feedback</h3>
                <p style="font-size: 0.85rem; margin-bottom: 1rem;">Members can submit anonymous feedback about group health</p>
                <div class="form-group">
                    <label for="anonymous-feedback-text">Your Anonymous Feedback</label>
                    <textarea id="anonymous-feedback-text" rows="4" placeholder="Share your thoughts about group health, traditions, or concerns..."></textarea>
                </div>
                <button class="btn" onclick="submitAnonymousFeedback()">Submit Anonymously</button>
            </div>

            <div class="box mt-4">
                <h3>Collected Feedback</h3>
                <div id="anonymous-feedback-list"></div>
            </div>
        </section>

        <!-- GC BY-LAWS SECTION -->
        <section id="gc-bylaws-section" style="border-left: 4px solid #9b59b6;">
            <h2><i class="fas fa-book-open"></i> Group Guidelines & By-Laws Repository</h2>
            <p class="mb-4">Store group documents with version control and amendment tracking.</p>

            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Add/Update Document</h3>
                        <div class="form-group">
                            <label for="bylaw-title">Document Title</label>
                            <input type="text" id="bylaw-title" placeholder="e.g., Group Guidelines, By-Laws">
                        </div>
                        <div class="form-group">
                            <label for="bylaw-version">Version</label>
                            <input type="text" id="bylaw-version" placeholder="e.g., 1.0, 2.1">
                        </div>
                        <div class="form-group">
                            <label for="bylaw-content">Document Content</label>
                            <textarea id="bylaw-content" rows="10" placeholder="Enter the full text of the document..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="bylaw-amendment-notes">Amendment Notes</label>
                            <textarea id="bylaw-amendment-notes" rows="2" placeholder="What changed in this version?"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="bylaw-effective-date">Effective Date</label>
                            <input type="date" id="bylaw-effective-date">
                        </div>
                        <input type="hidden" id="bylaw-edit-id">
                        <button id="bylaw-form-btn" class="btn" onclick="handleByLawSubmit()">Save Document</button>
                        <button id="bylaw-form-cancel-btn" class="btn secondary" onclick="cancelByLawEdit()" style="display:none; margin-left: 0.5rem;">Cancel</button>
                    </div>
                </div>

                <div>
                    <div class="box">
                        <h3>Current Documents</h3>
                        <div id="bylaws-current-list"></div>
                    </div>

                    <div class="box mt-4">
                        <h3>Version History</h3>
                        <table id="bylaws-history-table">
                            <thead>
                                <tr>
                                    <th>Document</th>
                                    <th>Version</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="bylaws-history-body"></tbody>
                        </table>
                    </div>

                    <div class="box mt-4">
                        <h3>Generate PDF</h3>
                        <div class="form-group">
                            <label for="pdf-document-select">Select Document</label>
                            <select id="pdf-document-select"></select>
                        </div>
                        <button class="btn" onclick="generateByLawPDF()">Generate PDF</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- SPONSORSHIP TRACKING SECTION -->
        <section id="sponsorship-section" style="border-left: 4px solid #2ecc71;">
            <h2><i class="fas fa-handshake"></i> Sponsorship Tracking</h2>
            <p class="mb-4">Track sponsorship relationships with tree visualization and service sponsorship.</p>

            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Add Sponsorship Relationship</h3>
                        <div class="form-group">
                            <label for="sponsor-name">Sponsor</label>
                            <select id="sponsor-name"></select>
                        </div>
                        <div class="form-group">
                            <label for="sponsee-name">Sponsee</label>
                            <select id="sponsee-name"></select>
                        </div>
                        <div class="form-group">
                            <label for="sponsorship-type">Type</label>
                            <select id="sponsorship-type">
                                <option value="program">Program Sponsorship</option>
                                <option value="service">Service Sponsorship</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="sponsorship-start-date">Start Date</label>
                            <input type="date" id="sponsorship-start-date">
                        </div>
                        <div class="form-group" id="step-progress-group" style="display: none;">
                            <label for="current-step">Current Step (Optional)</label>
                            <select id="current-step">
                                <option value="">Not tracking</option>
                                <option value="1">Step 1</option>
                                <option value="2">Step 2</option>
                                <option value="3">Step 3</option>
                                <option value="4">Step 4</option>
                                <option value="5">Step 5</option>
                                <option value="6">Step 6</option>
                                <option value="7">Step 7</option>
                                <option value="8">Step 8</option>
                                <option value="9">Step 9</option>
                                <option value="10">Step 10</option>
                                <option value="11">Step 11</option>
                                <option value="12">Step 12</option>
                            </select>
                        </div>
                        <input type="hidden" id="sponsorship-edit-id">
                        <button id="sponsorship-form-btn" class="btn" onclick="handleSponsorshipSubmit()">Add Relationship</button>
                        <button id="sponsorship-form-cancel-btn" class="btn secondary" onclick="cancelSponsorshipEdit()" style="display:none; margin-left: 0.5rem;">Cancel</button>
                    </div>
                </div>

                <div>
                    <div class="box">
                        <h3>Sponsorship Tree Visualization</h3>
                        <div id="sponsorship-tree" style="min-height: 400px; padding: 1rem; background: #2c3e50; border-radius: 6px; overflow-x: auto;"></div>
                    </div>

                    <div class="box mt-4">
                        <h3>Sponsorship List</h3>
                        <table id="sponsorship-table">
                            <thead>
                                <tr>
                                    <th>Sponsor</th>
                                    <th>Sponsee</th>
                                    <th>Type</th>
                                    <th>Start Date</th>
                                    <th>Progress</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="sponsorship-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- DISTRICT/AREA INTEGRATION SECTION -->
        <section id="district-area-section" style="border-left: 4px solid #2ecc71;">
            <h2><i class="fas fa-sitemap"></i> District/Area Committee Integration</h2>
            <p class="mb-4">GSR reports, district meeting schedules, and area assembly tracking.</p>

            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Log GSR Report</h3>
                        <div class="form-group">
                            <label for="gsr-report-date">Meeting Date</label>
                            <input type="date" id="gsr-report-date">
                        </div>
                        <div class="form-group">
                            <label for="gsr-meeting-type">Meeting Type</label>
                            <select id="gsr-meeting-type">
                                <option value="district">District Meeting</option>
                                <option value="area">Area Assembly</option>
                                <option value="special">Special Meeting</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="gsr-report-content">Report Summary</label>
                            <textarea id="gsr-report-content" rows="5" placeholder="Summarize key points, motions, and announcements..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="gsr-action-items">Action Items</label>
                            <textarea id="gsr-action-items" rows="3" placeholder="Any action items for the group..."></textarea>
                        </div>
                        <input type="hidden" id="gsr-report-edit-id">
                        <button id="gsr-report-form-btn" class="btn" onclick="handleGSRReportSubmit()">Save Report</button>
                        <button id="gsr-report-form-cancel-btn" class="btn secondary" onclick="cancelGSRReportEdit()" style="display:none; margin-left: 0.5rem;">Cancel</button>
                    </div>

                    <div class="box mt-4">
                        <h3>District Meeting Schedule</h3>
                        <div class="form-group">
                            <label for="district-schedule-date">Meeting Date</label>
                            <input type="date" id="district-schedule-date">
                        </div>
                        <div class="form-group">
                            <label for="district-schedule-time">Time</label>
                            <input type="time" id="district-schedule-time">
                        </div>
                        <div class="form-group">
                            <label for="district-schedule-location">Location</label>
                            <input type="text" id="district-schedule-location" placeholder="Meeting location">
                        </div>
                        <button class="btn" onclick="addDistrictMeeting()">Add to Schedule</button>
                    </div>
                </div>

                <div>
                    <div class="box">
                        <h3>Recent GSR Reports</h3>
                        <div id="gsr-reports-list" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>

                    <div class="box mt-4">
                        <h3>Upcoming District/Area Meetings</h3>
                        <div id="district-meetings-list"></div>
                    </div>

                    <div class="box mt-4">
                        <h3>DCM Communication Log</h3>
                        <div class="form-group">
                            <label for="dcm-comm-date">Date</label>
                            <input type="date" id="dcm-comm-date">
                        </div>
                        <div class="form-group">
                            <label for="dcm-comm-content">Communication</label>
                            <textarea id="dcm-comm-content" rows="3" placeholder="Log communication with DCM..."></textarea>
                        </div>
                        <button class="btn" onclick="addDCMCommunication()">Add Entry</button>
                        <div id="dcm-comm-history" class="mt-4"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- PRUDENT RESERVE SECTION -->
        <section id="prudent-reserve-section" style="border-left: 4px solid #f1c40f;">
            <h2><i class="fas fa-piggy-bank"></i> Prudent Reserve Tracking</h2>
            <p class="mb-4">Set reserve targets, visualize operational vs reserve balance, and track trends.</p>

            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Prudent Reserve Settings</h3>
                        <div class="form-group">
                            <label for="reserve-target">Target Reserve Amount ($)</label>
                            <input type="number" id="reserve-target" step="0.01" placeholder="0.00">
                            <small style="font-size: 0.75rem; opacity: 0.8;">Recommended: 3-6 months of operating expenses</small>
                        </div>
                        <div class="form-group">
                            <label for="monthly-expenses">Estimated Monthly Expenses ($)</label>
                            <input type="number" id="monthly-expenses" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label for="reserve-months">Reserve Target (Months)</label>
                            <input type="number" id="reserve-months" min="1" max="12" value="3">
                        </div>
                        <button class="btn" onclick="calculateReserveTarget()">Calculate Target</button>
                        <button class="btn secondary" onclick="saveReserveSettings()" style="margin-left: 0.5rem;">Save Settings</button>
                    </div>

                    <div class="box mt-4">
                        <h3>Current Financial Status</h3>
                        <div id="reserve-status" style="padding: 1rem; background: #2c3e50; border-radius: 6px;">
                            <div class="mb-2"><strong>Total Balance:</strong> $<span id="total-balance">0.00</span></div>
                            <div class="mb-2"><strong>Prudent Reserve:</strong> $<span id="current-reserve">0.00</span></div>
                            <div class="mb-2"><strong>Operating Balance:</strong> $<span id="operating-balance">0.00</span></div>
                            <div class="mb-2"><strong>Reserve Target:</strong> $<span id="display-reserve-target">0.00</span></div>
                            <div class="mb-2"><strong>Status:</strong> <span id="reserve-health-status">--</span></div>

                            <!-- Quick Win #2: Prudent Reserve Progress Bar -->
                            <div style="margin-top: 1rem;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span style="font-size: 0.85rem; color: #ecf0f1;">Reserve Progress</span>
                                    <span id="reserve-percentage" style="font-size: 0.85rem; font-weight: bold; color: #3498db;">0%</span>
                                </div>
                                <div style="width: 100%; height: 24px; background: #34495e; border-radius: 12px; overflow: hidden; position: relative;">
                                    <div id="reserve-progress-bar" style="height: 100%; width: 0%; background: linear-gradient(90deg, #e74c3c 0%, #f39c12 33%, #f1c40f 66%, #2ecc71 100%); transition: width 0.5s ease; display: flex; align-items: center; justify-content: center;">
                                        <span id="reserve-progress-text" style="font-size: 0.75rem; font-weight: bold; color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); position: absolute;"></span>
                                    </div>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-top: 0.25rem; font-size: 0.7rem; color: #95a5a6;">
                                    <span>0 months</span>
                                    <span>Target: <span id="reserve-target-months">3</span> months</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="box">
                        <h3>Reserve vs Operating Balance</h3>
                        <canvas id="reserve-balance-chart" style="max-height: 300px;"></canvas>
                    </div>

                    <div class="box mt-4">
                        <h3>7th Tradition Trend Analysis</h3>
                        <canvas id="seventh-tradition-trend-chart" style="max-height: 300px;"></canvas>
                    </div>

                    <div class="box mt-4">
                        <h3>Contribution Source Breakdown</h3>
                        <canvas id="contribution-source-chart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- 7TH TRADITION ANALYSIS SECTION -->
        <section id="seventh-tradition-section" style="border-left: 4px solid #f1c40f;">
            <h2><i class="fas fa-hand-holding-usd"></i> 7th Tradition Analysis</h2>
            <p class="mb-4">Detailed analysis of contribution patterns and trends.</p>

            <div class="box mb-4">
                <h3>Contribution Trends</h3>
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                    <button class="btn" onclick="load7thTraditionPeriod('weekly')">Weekly</button>
                    <button class="btn" onclick="load7thTraditionPeriod('monthly')">Monthly</button>
                    <button class="btn" onclick="load7thTraditionPeriod('quarterly')">Quarterly</button>
                    <button class="btn" onclick="load7thTraditionPeriod('yearly')">Yearly</button>
                </div>
                <canvas id="seventh-tradition-detail-chart"></canvas>
            </div>

            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div class="box">
                    <h3>Statistics</h3>
                    <div id="seventh-tradition-stats">
                        <div class="mb-2"><strong>Average per Meeting:</strong> $<span id="avg-per-meeting">0.00</span></div>
                        <div class="mb-2"><strong>Highest Contribution:</strong> $<span id="highest-contribution">0.00</span></div>
                        <div class="mb-2"><strong>Lowest Contribution:</strong> $<span id="lowest-contribution">0.00</span></div>
                        <div class="mb-2"><strong>YTD Total:</strong> $<span id="ytd-total">0.00</span></div>
                        <div class="mb-2"><strong>Trend:</strong> <span id="contribution-trend">--</span></div>
                    </div>
                </div>

                <div class="box">
                    <h3>Goals & Targets</h3>
                    <div class="form-group">
                        <label for="contribution-goal">Monthly Contribution Goal ($)</label>
                        <input type="number" id="contribution-goal" step="0.01" placeholder="0.00">
                    </div>
                    <button class="btn" onclick="saveContributionGoal()">Save Goal</button>
                    <div id="goal-progress" class="mt-4"></div>
                </div>
            </div>
        </section>

        <!-- CHIP INVENTORY SECTION -->
        <section id="chip-inventory-section" style="border-left: 4px solid #f1c40f;">
            <h2><i class="fas fa-medal"></i> Sobriety Chip Inventory</h2>
            <p class="mb-4">Track chip stock levels, set low stock alerts, and log distributions.</p>

            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Update Chip Inventory</h3>
                        <div class="form-group">
                            <label for="chip-type">Chip Type</label>
                            <select id="chip-type">
                                <option value="24-hour">24 Hours (White)</option>
                                <option value="30-day">30 Days (Red)</option>
                                <option value="60-day">60 Days (Gold)</option>
                                <option value="90-day">90 Days (Green)</option>
                                <option value="6-month">6 Months (Blue)</option>
                                <option value="9-month">9 Months (Purple)</option>
                                <option value="1-year">1 Year (Bronze)</option>
                                <option value="18-month">18 Months</option>
                                <option value="multi-year">Multi-Year</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="chip-quantity">Current Quantity</label>
                            <input type="number" id="chip-quantity" min="0" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label for="chip-low-threshold">Low Stock Alert Threshold</label>
                            <input type="number" id="chip-low-threshold" min="0" placeholder="5">
                        </div>
                        <button class="btn" onclick="updateChipInventory()">Update Inventory</button>
                    </div>

                    <div class="box mt-4">
                        <h3>Log Chip Distribution</h3>
                        <div class="form-group">
                            <label for="dist-chip-type">Chip Type</label>
                            <select id="dist-chip-type">
                                <option value="24-hour">24 Hours</option>
                                <option value="30-day">30 Days</option>
                                <option value="60-day">60 Days</option>
                                <option value="90-day">90 Days</option>
                                <option value="6-month">6 Months</option>
                                <option value="9-month">9 Months</option>
                                <option value="1-year">1 Year</option>
                                <option value="18-month">18 Months</option>
                                <option value="multi-year">Multi-Year</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="dist-recipient">Recipient (Optional)</label>
                            <input type="text" id="dist-recipient" placeholder="Name">
                        </div>
                        <div class="form-group">
                            <label for="dist-date">Date</label>
                            <input type="date" id="dist-date">
                        </div>
                        <button class="btn" onclick="logChipDistribution()">Log Distribution</button>
                    </div>
                </div>

                <div>
                    <div class="box">
                        <h3>Current Inventory Status</h3>
                        <table id="chip-inventory-table">
                            <thead>
                                <tr>
                                    <th>Chip Type</th>
                                    <th>Quantity</th>
                                    <th>Status</th>
                                    <th>Alert Threshold</th>
                                </tr>
                            </thead>
                            <tbody id="chip-inventory-body"></tbody>
                        </table>
                    </div>

                    <div class="box mt-4">
                        <h3>Low Stock Alerts</h3>
                        <div id="chip-alerts"></div>
                    </div>

                    <div class="box mt-4">
                        <h3>Recent Distributions</h3>
                        <table id="chip-distribution-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Chip Type</th>
                                    <th>Recipient</th>
                                </tr>
                            </thead>
                            <tbody id="chip-distribution-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- VOTING SETTINGS SECTION -->
        <section id="voting-settings-section" style="border-left: 4px solid #9b59b6;">
            <h2><i class="fas fa-vote-yea"></i> Voting Settings & Methods</h2>
            <p class="mb-4">Configure your group's preferred voting method for Group Conscience decisions.</p>

            <div class="box mb-4">
                <h3>Current Voting Method</h3>
                <div id="current-voting-display" style="padding: 1.5rem; background: #2c3e50; border-radius: 6px;">
                    <div style="font-size: 1.2rem; font-weight: bold; color: #3498db;" id="current-method-name">Substantial Unanimity</div>
                    <div style="margin-top: 0.5rem; color: #95a5a6;" id="current-method-desc">Requires 2/3 majority (66.67%)</div>
                </div>
            </div>

            <div class="box">
                <h3>Configure Voting Method</h3>
                <div class="form-group">
                    <label for="voting-method">Voting Method</label>
                    <select id="voting-method" onchange="updateVotingMethodDisplay()">
                        <option value="substantialUnanimity">Substantial Unanimity (2/3 Majority)</option>
                        <option value="simpleMajority">Simple Majority (50% + 1)</option>
                        <option value="unanimousConsent">Unanimous Consent (100%)</option>
                        <option value="senseOfMeeting">Sense of the Meeting (Consensus)</option>
                        <option value="custom">Custom Threshold</option>
                    </select>
                    <small style="font-size: 0.75rem; opacity: 0.8;">Most AA groups use Substantial Unanimity (2/3 majority)</small>
                </div>

                <div class="form-group" id="custom-threshold-group" style="display: none;">
                    <label for="custom-threshold">Custom Threshold (%)</label>
                    <input type="number" id="custom-threshold" min="1" max="100" step="0.1" placeholder="66.67">
                    <small style="font-size: 0.75rem; opacity: 0.8;">Enter the percentage required for a motion to pass</small>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="allow-abstain" checked>
                        Allow Abstain Votes
                    </label>
                    <small style="font-size: 0.75rem; opacity: 0.8; display: block; margin-top: 0.25rem;">When enabled, abstentions are not counted in the total</small>
                </div>

                <button class="btn" onclick="saveVotingSettings()">Save Voting Settings</button>
            </div>

            <div class="box mt-4">
                <h3>Voting Method Descriptions</h3>
                <div style="padding: 1rem; background: #2c3e50; border-radius: 6px;">
                    <div class="mb-3">
                        <strong style="color: #3498db;">Substantial Unanimity (2/3):</strong>
                        <p style="font-size: 0.9rem; margin-top: 0.25rem;">The traditional AA method. Requires at least 66.67% approval. Respects the minority opinion while allowing the group to move forward.</p>
                    </div>
                    <div class="mb-3">
                        <strong style="color: #3498db;">Simple Majority (50% + 1):</strong>
                        <p style="font-size: 0.9rem; margin-top: 0.25rem;">Requires just over half of votes to be in favor. Used for routine, non-controversial decisions.</p>
                    </div>
                    <div class="mb-3">
                        <strong style="color: #3498db;">Unanimous Consent:</strong>
                        <p style="font-size: 0.9rem; margin-top: 0.25rem;">Requires 100% agreement. Reserved for major decisions affecting the group's foundation.</p>
                    </div>
                    <div>
                        <strong style="color: #3498db;">Sense of the Meeting:</strong>
                        <p style="font-size: 0.9rem; margin-top: 0.25rem;">Informal consensus-based decision making. Chairperson gauges general agreement without formal vote count.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- MOTION TEMPLATES SECTION -->
        <section id="motion-templates-section" style="border-left: 4px solid #9b59b6;">
            <h2><i class="fas fa-file-signature"></i> Motion Templates</h2>
            <p class="mb-4">Pre-formatted motion templates for common AA Group Conscience items.</p>

            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Create/Edit Template</h3>
                        <div class="form-group">
                            <label for="template-name">Template Name</label>
                            <input type="text" id="template-name" placeholder="e.g., Change Meeting Format">
                        </div>
                        <div class="form-group">
                            <label for="template-category">Category</label>
                            <select id="template-category">
                                <option value="Finance">Finance</option>
                                <option value="Service">Service</option>
                                <option value="Meeting Format">Meeting Format</option>
                                <option value="Group Health">Group Health</option>
                                <option value="Literature">Literature</option>
                                <option value="Special Events">Special Events</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="template-text">Motion Template Text</label>
                            <textarea id="template-text" rows="4" placeholder="Motion to... Use [placeholders] for values to be filled in."></textarea>
                            <small style="font-size: 0.75rem; opacity: 0.8;">Use square brackets [like this] for placeholders</small>
                        </div>
                        <input type="hidden" id="template-edit-id">
                        <button id="template-form-btn" class="btn" onclick="saveMotionTemplate()">Add Template</button>
                        <button id="template-form-cancel-btn" class="btn secondary" onclick="cancelTemplateEdit()" style="display:none; margin-left: 0.5rem;">Cancel</button>
                    </div>
                </div>

                <div>
                    <div class="box">
                        <h3>Available Templates</h3>
                        <div id="templates-filter" class="form-group">
                            <select id="template-filter-category" onchange="renderMotionTemplates()">
                                <option value="all">All Categories</option>
                                <option value="Finance">Finance</option>
                                <option value="Service">Service</option>
                                <option value="Meeting Format">Meeting Format</option>
                                <option value="Group Health">Group Health</option>
                                <option value="Literature">Literature</option>
                                <option value="Special Events">Special Events</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div id="motion-templates-list" style="max-height: 500px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- TRADITION & CONCEPT CHECKER SECTION -->
        <section id="tradition-checker-section" style="border-left: 4px solid #9b59b6;">
            <h2><i class="fas fa-check-circle"></i> Tradition & Concept Checker</h2>
            <p class="mb-4">Ensure your motions align with AA's 12 Traditions and 12 Concepts.</p>

            <div class="box mb-4">
                <h3>Check a Motion</h3>
                <div class="form-group">
                    <label for="check-motion-text">Motion to Check</label>
                    <textarea id="check-motion-text" rows="3" placeholder="Enter the motion you want to check..."></textarea>
                </div>
                <button class="btn" onclick="checkTraditionsAndConcepts()">Analyze Motion</button>
            </div>

            <div id="tradition-check-results" style="display: none;">
                <div class="box mb-4" style="border-left: 4px solid #f39c12;">
                    <h3 style="color: #f39c12;"><i class="fas fa-exclamation-triangle"></i> Potential Issues</h3>
                    <div id="tradition-warnings"></div>
                </div>

                <div class="box mb-4" style="border-left: 4px solid #3498db;">
                    <h3 style="color: #3498db;"><i class="fas fa-info-circle"></i> Relevant Traditions</h3>
                    <div id="relevant-traditions"></div>
                </div>

                <div class="box mb-4" style="border-left: 4px solid #9b59b6;">
                    <h3 style="color: #9b59b6;"><i class="fas fa-lightbulb"></i> Relevant Concepts</h3>
                    <div id="relevant-concepts"></div>
                </div>

                <div class="box" style="border-left: 4px solid #2ecc71;">
                    <h3 style="color: #2ecc71;"><i class="fas fa-question-circle"></i> Guided Questions</h3>
                    <div id="guided-questions"></div>
                </div>
            </div>

            <div class="box mt-4">
                <h3>Quick Reference</h3>
                <div style="display: flex; gap: 1rem;">
                    <button class="btn secondary" onclick="showTraditionsReference()">View 12 Traditions</button>
                    <button class="btn secondary" onclick="showConceptsReference()">View 12 Concepts</button>
                </div>
            </div>
        </section>

        <!-- PARLIAMENTARY PROCEDURE SECTION -->
        <section id="parliamentary-section" style="border-left: 4px solid #9b59b6;">
            <h2><i class="fas fa-gavel"></i> Parliamentary Procedure Assistant</h2>
            <p class="mb-4">Guide motions through proper parliamentary procedure.</p>

            <div class="grid" style="grid-template-columns: 2fr 1fr; gap: 2rem;">
                <div>
                    <div class="box mb-4">
                        <h3>Current Motion Workflow</h3>
                        <div id="motion-workflow-display" style="padding: 1rem; background: #2c3e50; border-radius: 6px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                                <div class="workflow-step" style="flex: 1; text-align: center; padding: 1rem; border-radius: 4px;" id="step-motion">
                                    <div style="font-weight: bold;">1. Motion</div>
                                    <div style="font-size: 0.8rem; opacity: 0.7;">Member proposes</div>
                                </div>
                                <div style="color: #3498db; font-size: 1.5rem;">→</div>
                                <div class="workflow-step" style="flex: 1; text-align: center; padding: 1rem; border-radius: 4px;" id="step-second">
                                    <div style="font-weight: bold;">2. Second</div>
                                    <div style="font-size: 0.8rem; opacity: 0.7;">Another supports</div>
                                </div>
                                <div style="color: #3498db; font-size: 1.5rem;">→</div>
                                <div class="workflow-step" style="flex: 1; text-align: center; padding: 1rem; border-radius: 4px;" id="step-discussion">
                                    <div style="font-weight: bold;">3. Discussion</div>
                                    <div style="font-size: 0.8rem; opacity: 0.7;">Group discusses</div>
                                </div>
                                <div style="color: #3498db; font-size: 1.5rem;">→</div>
                                <div class="workflow-step" style="flex: 1; text-align: center; padding: 1rem; border-radius: 4px;" id="step-vote">
                                    <div style="font-weight: bold;">4. Vote</div>
                                    <div style="font-size: 0.8rem; opacity: 0.7;">Group decides</div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button class="btn" onclick="advanceMotionWorkflow()">Advance to Next Step</button>
                            <button class="btn secondary" onclick="resetMotionWorkflow()">Reset Workflow</button>
                        </div>
                    </div>

                    <div class="box">
                        <h3>Speaking Queue</h3>
                        <div class="form-group">
                            <label for="speaker-name">Add Speaker to Queue</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <select id="speaker-name" style="flex: 1;">
                                    <option value="">-- Select Member --</option>
                                </select>
                                <button class="btn" onclick="addToSpeakingQueue()">Add</button>
                            </div>
                        </div>
                        <div id="speaking-queue-list" style="min-height: 200px; max-height: 400px; overflow-y: auto;"></div>
                        <div id="discussion-timer-display" style="margin-top: 1rem; padding: 1rem; background: #2c3e50; border-radius: 6px; text-align: center; display: none;">
                            <div style="font-size: 2rem; font-weight: bold; color: #3498db;" id="timer-display">3:00</div>
                            <div style="margin-top: 0.5rem;">
                                <button class="btn secondary" onclick="startSpeakerTimer()">Start</button>
                                <button class="btn secondary" onclick="pauseSpeakerTimer()">Pause</button>
                                <button class="btn secondary" onclick="resetSpeakerTimer()">Reset</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="box mb-4">
                        <h3>Quick Actions</h3>
                        <button class="btn mb-2" onclick="callForSecond()" style="width: 100%;">Call for Second</button>
                        <button class="btn mb-2" onclick="openDiscussion()" style="width: 100%;">Open Discussion</button>
                        <button class="btn mb-2" onclick="closeDiscussion()" style="width: 100%;">Close Discussion</button>
                        <button class="btn mb-2" onclick="callTheQuestion()" style="width: 100%;">Call the Question</button>
                        <button class="btn mb-2" onclick="tableMotion()" style="width: 100%;">Table Motion</button>
                    </div>

                    <div class="box">
                        <h3>Points of Order</h3>
                        <button class="btn secondary mb-2" onclick="pointOfInformation()" style="width: 100%; font-size: 0.85rem;">Point of Information</button>
                        <button class="btn secondary mb-2" onclick="pointOfOrder()" style="width: 100%; font-size: 0.85rem;">Point of Order</button>
                        <button class="btn secondary mb-2" onclick="pointOfPrivilege()" style="width: 100%; font-size: 0.85rem;">Point of Privilege</button>
                    </div>

                    <div class="box mt-4">
                        <h3>Amendments</h3>
                        <div class="form-group">
                            <label for="amendment-text">Proposed Amendment</label>
                            <textarea id="amendment-text" rows="2" placeholder="Describe the amendment..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="radio" name="amendment-type" value="friendly" checked> Friendly Amendment
                            </label>
                            <label style="margin-left: 1rem;">
                                <input type="radio" name="amendment-type" value="unfriendly"> Unfriendly Amendment
                            </label>
                        </div>
                        <button class="btn" onclick="proposeAmendment()">Propose Amendment</button>
                        <div id="active-amendments-list" class="mt-3"></div>
                    </div>
                </div>
            </div>

            <!-- P2: ENHANCED ROBERT'S RULES COMPONENTS -->
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 2rem;">
                <div>
                    <!-- Motion Stack -->
                    <div class="box mb-4">
                        <h3><i class="fas fa-layer-group"></i> Motion Stack (Precedence Order)</h3>
                        <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem;">Higher precedence motions must be resolved first</p>
                        <div id="motion-stack" style="min-height: 150px;">
                            <p style="opacity: 0.6; text-align: center; padding: 2rem;">No active motions</p>
                        </div>
                    </div>

                    <!-- Voting Method Selector -->
                    <div class="box mb-4">
                        <h3><i class="fas fa-vote-yea"></i> Voting Method</h3>
                        <div class="form-group">
                            <label for="voting-method">Select Method</label>
                            <select id="voting-method" onchange="updateVotingMethod()">
                                <option value="voice">Voice Vote (Aye/Nay)</option>
                                <option value="show-hands">Show of Hands</option>
                                <option value="roll-call">Roll Call</option>
                                <option value="written-ballot">Written Ballot (Anonymous)</option>
                                <option value="consensus" selected>Consensus (AA Substantial Unanimity)</option>
                            </select>
                        </div>
                        <div id="vote-counter" style="display: none; margin-top: 1rem;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label>For</label>
                                    <input type="number" id="votes-for-input" min="0" value="0" style="width: 100%;">
                                </div>
                                <div>
                                    <label>Against</label>
                                    <input type="number" id="votes-against-input" min="0" value="0" style="width: 100%;">
                                </div>
                                <div>
                                    <label>Abstain</label>
                                    <input type="number" id="votes-abstain-input" min="0" value="0" style="width: 100%;">
                                </div>
                            </div>
                            <div id="vote-result" style="margin-top: 1rem; padding: 1rem; background: #2c3e50; border-radius: 4px; display: none;">
                                <div style="font-weight: bold; font-size: 1.1rem;" id="vote-result-text"></div>
                                <div style="font-size: 0.9rem; opacity: 0.8; margin-top: 0.5rem;" id="vote-result-details"></div>
                            </div>
                            <button class="btn mt-2" onclick="calculateVoteResult()" style="width: 100%;">Calculate Result</button>
                        </div>
                    </div>
                </div>

                <div>
                    <!-- Quorum Display -->
                    <div class="box mb-4" style="border-left: 4px solid #3498db;">
                        <h3><i class="fas fa-users"></i> Quorum Status</h3>
                        <div id="quorum-display" style="padding: 1rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>Required:</span>
                                <strong id="quorum-required">0</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>Present:</span>
                                <strong id="quorum-present">0</strong>
                            </div>
                            <div style="margin-top: 1rem; padding: 0.75rem; border-radius: 4px;" id="quorum-status">
                                <i class="fas fa-info-circle"></i> Enter attendance to check quorum
                            </div>
                        </div>
                        <button class="btn secondary" onclick="goToSection('quorum-management-section')" style="width: 100%; margin-top: 0.5rem;">
                            Configure Quorum Settings
                        </button>
                    </div>

                    <!-- Minority Report Section -->
                    <div class="box mb-4" style="border-left: 4px solid #f39c12;">
                        <h3><i class="fas fa-balance-scale"></i> Minority Opinion Protection</h3>
                        <p style="font-size: 0.9rem; margin-bottom: 1rem; opacity: 0.9;">
                            When a motion passes with significant opposition (&gt;33%), the minority has the right to have their concerns heard and recorded per AA Tradition.
                        </p>
                        <div id="minority-report-section" style="display: none;">
                            <label>Minority Concerns</label>
                            <textarea id="minority-concerns" rows="3" placeholder="Record minority viewpoint..."></textarea>
                            <button class="btn mt-2" onclick="saveMinorityReport()" style="width: 100%;">Save Minority Report</button>
                        </div>
                        <div id="minority-not-needed" style="padding: 1rem; background: #2c3e50; border-radius: 4px; text-align: center;">
                            <i class="fas fa-check-circle" style="color: #2ecc71;"></i>
                            <div style="margin-top: 0.5rem; font-size: 0.9rem;">No minority report needed</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- SERVICE ELECTIONS SECTION -->
        <section id="service-elections-section" style="border-left: 4px solid #2ecc71;">
            <h2><i class="fas fa-poll"></i> Service Position Elections</h2>
            <p class="mb-4">Conduct elections for service positions with eligibility checking and term tracking.</p>

            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box mb-4">
                        <h3>Start New Election</h3>
                        <div class="form-group">
                            <label for="election-position">Service Position</label>
                            <select id="election-position" onchange="updateElectionEligibility()">
                                <option value="">-- Select Position --</option>
                            </select>
                        </div>
                        <div id="position-requirements" style="padding: 0.75rem; background: #2c3e50; border-radius: 4px; margin-bottom: 1rem; display: none;">
                            <strong>Requirements:</strong>
                            <div id="position-req-details"></div>
                        </div>
                        <div class="form-group">
                            <label for="election-date">Election Date</label>
                            <input type="date" id="election-date">
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="election-anonymous"> Anonymous Ballot
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="election-method">Voting Method</label>
                            <select id="election-method">
                                <option value="simple">Simple Majority</option>
                                <option value="runoff">Runoff (if no majority)</option>
                                <option value="ranked">Ranked Choice</option>
                            </select>
                        </div>
                        <button class="btn" onclick="startElection()">Start Election</button>
                    </div>

                    <div class="box">
                        <h3>Nominations</h3>
                        <div id="current-election-info" style="display: none; padding: 0.75rem; background: #2c3e50; border-radius: 4px; margin-bottom: 1rem;">
                            <strong>Current Election:</strong> <span id="current-election-position"></span>
                        </div>
                        <div class="form-group">
                            <label for="nominee-select">Nominate Member</label>
                            <select id="nominee-select">
                                <option value="">-- Select Member --</option>
                            </select>
                        </div>
                        <div id="nominee-eligibility-check"></div>
                        <button class="btn" onclick="nominateMember()">Nominate</button>
                        <div id="nominees-list" class="mt-3"></div>
                    </div>
                </div>

                <div>
                    <div class="box mb-4">
                        <h3>Cast Ballots</h3>
                        <div id="ballot-interface"></div>
                    </div>

                    <div class="box mb-4">
                        <h3>Current Service Positions</h3>
                        <table id="current-positions-table">
                            <thead>
                                <tr>
                                    <th>Position</th>
                                    <th>Holder</th>
                                    <th>Term Ends</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="current-positions-body"></tbody>
                        </table>
                    </div>

                    <div class="box">
                        <h3>Election History</h3>
                        <div id="election-history-list" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- BUDGET APPROVAL SECTION -->
        <section id="budget-approval-section" style="border-left: 4px solid #f1c40f;">
            <h2><i class="fas fa-file-invoice-dollar"></i> Budget Approval Workflow</h2>
            <p class="mb-4">Propose, review, and vote on annual budgets and budget amendments.</p>

            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Create Budget Proposal</h3>
                        <div class="form-group">
                            <label for="budget-year">Fiscal Year</label>
                            <input type="number" id="budget-year" min="2020" max="2050" placeholder="2024">
                        </div>
                        <div class="form-group">
                            <label for="budget-type">Budget Type</label>
                            <select id="budget-type">
                                <option value="annual">Annual Budget</option>
                                <option value="amendment">Budget Amendment</option>
                                <option value="special">Special Project Budget</option>
                            </select>
                        </div>
                        <div id="budget-categories-input">
                            <h4 class="mt-3 mb-2">Budget Line Items</h4>
                            <div id="budget-line-items"></div>
                            <button class="btn secondary" onclick="addBudgetLineItem()">Add Line Item</button>
                        </div>
                        <div class="form-group mt-3">
                            <label>Total Proposed Budget: $<span id="total-proposed-budget">0.00</span></label>
                        </div>
                        <button class="btn mt-2" onclick="submitBudgetProposal()">Submit for GC Approval</button>
                    </div>
                </div>

                <div>
                    <div class="box mb-4">
                        <h3>Pending Budget Proposals</h3>
                        <div id="pending-budgets-list"></div>
                    </div>

                    <div class="box mb-4">
                        <h3>Approved Budgets</h3>
                        <div id="approved-budgets-list"></div>
                    </div>

                    <div class="box">
                        <h3>Budget vs Actual (Current Year)</h3>
                        <canvas id="budget-actual-chart" style="max-height: 300px;"></canvas>
                        <div id="budget-variance-summary" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- LITERATURE INVENTORY SECTION -->
        <section id="literature-inventory-section" style="border-left: 4px solid #95a5a6;">
            <h2><i class="fas fa-book-reader"></i> Literature & Supplies Inventory</h2>
            <p class="mb-4">Track AA literature, supplies, and loan management.</p>

            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Add/Update Literature Item</h3>
                        <div class="form-group">
                            <label for="lit-item-name">Item Name</label>
                            <input type="text" id="lit-item-name" placeholder="e.g., Big Book, Living Sober">
                        </div>
                        <div class="form-group">
                            <label for="lit-item-type">Type</label>
                            <select id="lit-item-type">
                                <option value="book">Book</option>
                                <option value="pamphlet">Pamphlet</option>
                                <option value="chip">Chip/Medallion</option>
                                <option value="supplies">Meeting Supplies</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="lit-quantity">Quantity in Stock</label>
                            <input type="number" id="lit-quantity" min="0" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label for="lit-min-quantity">Minimum Stock Alert</label>
                            <input type="number" id="lit-min-quantity" min="0" placeholder="5">
                        </div>
                        <div class="form-group">
                            <label for="lit-cost">Unit Cost ($)</label>
                            <input type="number" id="lit-cost" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="lit-loanable"> Available for Loan
                            </label>
                        </div>
                        <input type="hidden" id="lit-edit-id">
                        <button id="lit-form-btn" class="btn" onclick="saveLiteratureItem()">Add Item</button>
                        <button id="lit-form-cancel-btn" class="btn secondary" onclick="cancelLitEdit()" style="display:none; margin-left: 0.5rem;">Cancel</button>
                    </div>
                </div>

                <div>
                    <div class="box mb-4">
                        <h3>Current Inventory</h3>
                        <table id="literature-inventory-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Type</th>
                                    <th>Quantity</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="literature-inventory-body"></tbody>
                        </table>
                    </div>

                    <div class="box">
                        <h3>Low Stock Alerts</h3>
                        <div id="lit-low-stock-alerts"></div>
                    </div>
                </div>
            </div>

            <div class="box mt-4">
                <h3>Literature Loans</h3>
                <div class="grid" style="grid-template-columns: 1fr 2fr; gap: 2rem;">
                    <div>
                        <h4>Check Out Literature</h4>
                        <div class="form-group">
                            <label for="loan-member">Member</label>
                            <select id="loan-member">
                                <option value="">-- Select Member --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="loan-item">Literature Item</label>
                            <select id="loan-item">
                                <option value="">-- Select Item --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="loan-due-date">Due Date</label>
                            <input type="date" id="loan-due-date">
                        </div>
                        <button class="btn" onclick="checkOutLiterature()">Check Out</button>
                    </div>
                    <div>
                        <h4>Active Loans</h4>
                        <table id="literature-loans-table">
                            <thead>
                                <tr>
                                    <th>Member</th>
                                    <th>Item</th>
                                    <th>Due Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="literature-loans-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="box mt-4">
                <h3>Purchase Approval</h3>
                <p class="mb-2">Submit purchase requests for Group Conscience approval</p>
                <div class="form-group">
                    <label for="purchase-items">Items to Purchase</label>
                    <textarea id="purchase-items" rows="2" placeholder="List items and quantities..."></textarea>
                </div>
                <div class="form-group">
                    <label for="purchase-estimated-cost">Estimated Cost ($)</label>
                    <input type="number" id="purchase-estimated-cost" step="0.01" placeholder="0.00">
                </div>
                <button class="btn" onclick="submitLiteraturePurchaseRequest()">Submit for GC Approval</button>
            </div>
        </section>

        <!-- DISTRICT MOTIONS SECTION -->
        <section id="district-motions-section" style="border-left: 4px solid #2ecc71;">
            <h2><i class="fas fa-building"></i> District & Area Motions</h2>
            <p class="mb-4">Track district and area motions that require group input, and record the group's positions.</p>

            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Add District/Area Motion</h3>
                        <div class="form-group">
                            <label for="district-motion-source">Source</label>
                            <select id="district-motion-source">
                                <option value="district">District Meeting</option>
                                <option value="area">Area Assembly</option>
                                <option value="conference">General Service Conference</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="district-motion-title">Motion Title</label>
                            <input type="text" id="district-motion-title" placeholder="Brief title">
                        </div>
                        <div class="form-group">
                            <label for="district-motion-text">Motion Details</label>
                            <textarea id="district-motion-text" rows="4" placeholder="Full motion text..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="district-motion-deadline">Response Deadline</label>
                            <input type="date" id="district-motion-deadline">
                        </div>
                        <div class="form-group">
                            <label for="district-motion-background">Background Information</label>
                            <textarea id="district-motion-background" rows="3" placeholder="Context and background..."></textarea>
                        </div>
                        <input type="hidden" id="district-motion-edit-id">
                        <button id="district-motion-form-btn" class="btn" onclick="saveDistrictMotion()">Add Motion</button>
                        <button id="district-motion-cancel-btn" class="btn secondary" onclick="cancelDistrictMotionEdit()" style="display:none; margin-left: 0.5rem;">Cancel</button>
                    </div>
                </div>

                <div>
                    <div class="box mb-4">
                        <h3>Pending Responses</h3>
                        <div id="pending-district-motions-list"></div>
                    </div>

                    <div class="box">
                        <h3>Group Position History</h3>
                        <div id="district-motions-history-list" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>

            <div class="box mt-4">
                <h3>Record Group's Position</h3>
                <div class="form-group">
                    <label for="position-motion-select">Select Motion</label>
                    <select id="position-motion-select">
                        <option value="">-- Select Motion --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="group-position">Group's Position</label>
                    <select id="group-position">
                        <option value="support">Support</option>
                        <option value="oppose">Oppose</option>
                        <option value="abstain">Abstain</option>
                        <option value="needs-info">Needs More Information</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="position-rationale">Rationale</label>
                    <textarea id="position-rationale" rows="3" placeholder="Why did the group take this position?"></textarea>
                </div>
                <div class="form-group">
                    <label for="position-vote-count">Vote Count</label>
                    <input type="text" id="position-vote-count" placeholder="e.g., 15-3-2 (For-Against-Abstain)">
                </div>
                <button class="btn" onclick="recordGroupPosition()">Record Position</button>
            </div>
        </section>

        <!-- QUORUM MANAGEMENT SECTION -->
        <section id="quorum-management-section" style="border-left: 4px solid #34495e;">
            <h2><i class="fas fa-users-cog"></i> Quorum Management</h2>
            <p class="mb-4">Configure quorum requirements for group conscience voting and different types of decisions.</p>

            <!-- Default GC Settings -->
            <div class="box mb-4" style="border-left: 4px solid #3498db;">
                <h3><i class="fas fa-cog"></i> Default Group Conscience Settings</h3>
                <p style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 1.5rem;">
                    Set the default quorum requirements for standard group conscience votes.
                </p>
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="quorum-percentage">Quorum Percentage (%)</label>
                        <input type="number" id="quorum-percentage" min="1" max="100" placeholder="50">
                        <small style="font-size: 0.75rem; opacity: 0.8;">Percentage of total members required for quorum</small>
                    </div>
                    <div class="form-group">
                        <label for="quorum-minimum">Minimum Quorum Count</label>
                        <input type="number" id="quorum-minimum" min="1" placeholder="5">
                        <small style="font-size: 0.75rem; opacity: 0.8;">Minimum number of members required regardless of percentage</small>
                    </div>
                </div>
                <button class="btn" onclick="saveGCSettings()">
                    <i class="fas fa-save"></i> Save Default Settings
                </button>
            </div>

            <h3 class="mt-4"><i class="fas fa-list-alt"></i> Category-Specific Quorum Rules</h3>
            <p class="mb-4" style="font-size: 0.85rem; opacity: 0.8;">
                Create custom quorum requirements for specific types of decisions (e.g., financial decisions may require higher quorum).
            </p>

            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Add/Edit Quorum Rule</h3>
                        <div class="form-group">
                            <label for="quorum-category">Decision Category</label>
                            <input type="text" id="quorum-category" placeholder="e.g., Financial Decisions">
                        </div>
                        <div class="form-group">
                            <label for="quorum-percent">Quorum Percentage (%)</label>
                            <input type="number" id="quorum-percent" min="1" max="100" placeholder="60">
                        </div>
                        <div class="form-group">
                            <label for="quorum-min-count">Minimum Count</label>
                            <input type="number" id="quorum-min-count" min="1" placeholder="7">
                        </div>
                        <div class="form-group">
                            <label for="quorum-desc">Description</label>
                            <textarea id="quorum-desc" rows="2" placeholder="When this quorum applies..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="quorum-allow-proxy"> Allow Proxy Voting
                            </label>
                        </div>
                        <input type="hidden" id="quorum-edit-id">
                        <button id="quorum-form-btn" class="btn" onclick="saveQuorumRule()">Add Rule</button>
                        <button id="quorum-cancel-btn" class="btn secondary" onclick="cancelQuorumEdit()" style="display:none; margin-left: 0.5rem;">Cancel</button>
                    </div>

                    <div class="box mt-4">
                        <h3>Live Quorum Check</h3>
                        <div class="form-group">
                            <label for="live-quorum-attendees">Current Attendees</label>
                            <input type="number" id="live-quorum-attendees" min="0" placeholder="12">
                        </div>
                        <div class="form-group">
                            <label for="live-quorum-category">Motion Category</label>
                            <select id="live-quorum-category">
                                <option value="">-- Select Category --</option>
                            </select>
                        </div>
                        <button class="btn" onclick="checkLiveQuorum()">Check Quorum Status</button>
                        <div id="live-quorum-result" class="mt-3" style="display: none;"></div>
                    </div>
                </div>

                <div>
                    <div class="box">
                        <h3>Quorum Rules</h3>
                        <table id="quorum-rules-table">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Quorum</th>
                                    <th>Proxy</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="quorum-rules-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- MEETING MINUTES SECTION -->
        <section id="meeting-minutes-section" style="border-left: 4px solid #1abc9c;">
            <h2><i class="fas fa-file-alt"></i> Meeting Minutes</h2>
            <p class="mb-4">Auto-generated minutes from Group Conscience meetings with approval workflow.</p>

            <div class="box mb-4">
                <h3>Generate Minutes from GC Log</h3>
                <p class="mb-2">Select a Group Conscience meeting to auto-generate formatted minutes</p>
                <div class="form-group">
                    <label for="minutes-gc-select">Select GC Meeting Date</label>
                    <select id="minutes-gc-select">
                        <option value="">-- Select Meeting --</option>
                    </select>
                </div>
                <button class="btn" onclick="generateMinutesFromGC()">Generate Minutes</button>
            </div>

            <div class="grid" style="grid-template-columns: 2fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3 id="minutes-editor-title">Minute Editor</h3>
                        <div id="minutes-preview" style="padding: 1rem; background: #2c3e50; border-radius: 6px; min-height: 400px; max-height: 600px; overflow-y: auto;">
                            <p style="opacity: 0.7;">Generate or select minutes to edit</p>
                        </div>
                        <div class="mt-3">
                            <button class="btn" onclick="saveMinutes()">Save Minutes</button>
                            <button class="btn secondary" onclick="approveMinutes()">Approve Minutes</button>
                            <button class="btn secondary" onclick="exportMinutesPDF()">Export PDF</button>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="box mb-4">
                        <h3>Minutes Archive</h3>
                        <div id="minutes-archive-list" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>

                    <div class="box">
                        <h3>Secretary Settings</h3>
                        <div class="form-group">
                            <label for="secretary-name">Secretary Name</label>
                            <input type="text" id="secretary-name" placeholder="John S.">
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="auto-generate-minutes"> Auto-generate after each GC
                            </label>
                        </div>
                        <button class="btn" onclick="saveSecretarySettings()">Save Settings</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- PARTICIPATION ANALYTICS SECTION -->
        <section id="participation-analytics-section" style="border-left: 4px solid #1abc9c;">
            <h2><i class="fas fa-chart-line"></i> Participation Analytics</h2>
            <p class="mb-4">Privacy-conscious analytics on meeting attendance and voting participation.</p>

            <div class="grid" style="grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem;">
                <div style="padding: 1.5rem; background: #34495e; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2.5rem; color: #3498db; font-weight: bold;" id="avg-attendance">0</div>
                    <div style="margin-top: 0.5rem; opacity: 0.8;">Avg GC Attendance</div>
                </div>
                <div style="padding: 1.5rem; background: #34495e; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2.5rem; color: #2ecc71; font-weight: bold;" id="voting-participation">0%</div>
                    <div style="margin-top: 0.5rem; opacity: 0.8;">Voting Participation</div>
                </div>
                <div style="padding: 1.5rem; background: #34495e; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2.5rem; color: #f39c12; font-weight: bold;" id="avg-meeting-length">0</div>
                    <div style="margin-top: 0.5rem; opacity: 0.8;">Avg Meeting (min)</div>
                </div>
                <div style="padding: 1.5rem; background: #34495e; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2.5rem; color: #9b59b6; font-weight: bold;" id="engagement-score">0%</div>
                    <div style="margin-top: 0.5rem; opacity: 0.8;">Engagement Score</div>
                </div>
            </div>

            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div class="box">
                    <h3>Attendance Trends (Last 6 GC Meetings)</h3>
                    <canvas id="attendance-trend-chart" style="max-height: 300px;"></canvas>
                </div>
                <div class="box">
                    <h3>Voting Participation Over Time</h3>
                    <canvas id="voting-trend-chart" style="max-height: 300px;"></canvas>
                </div>
            </div>

            <div class="box mt-4">
                <h3>Privacy Notice</h3>
                <p style="font-size: 0.9rem; opacity: 0.8;">All participation data is anonymous and aggregated. No individual voting records are tracked or displayed. This data helps the group understand overall engagement patterns.</p>
            </div>
        </section>

        <!-- DECISION IMPACT TRACKING SECTION -->
        <section id="decision-impact-section" style="border-left: 4px solid #1abc9c;">
            <h2><i class="fas fa-chart-line"></i> Decision Impact Tracking</h2>
            <p class="mb-4">Follow up on past decisions to see if they achieved their intended goals.</p>

            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Add Impact Assessment</h3>
                        <div class="form-group">
                            <label for="impact-gc-motion">Select Past Motion</label>
                            <select id="impact-gc-motion">
                                <option value="">-- Select Motion --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="impact-months">Months Since Implementation</label>
                            <input type="number" id="impact-months" min="1" max="24" placeholder="6">
                        </div>
                        <div class="form-group">
                            <label for="impact-achieved">Goal Achieved?</label>
                            <select id="impact-achieved">
                                <option value="yes">Yes - Fully achieved</option>
                                <option value="partial">Partially achieved</option>
                                <option value="no">No - Did not achieve goal</option>
                                <option value="unknown">Too soon to tell</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="impact-rating">Effectiveness Rating</label>
                            <select id="impact-rating">
                                <option value="5">5 - Excellent decision</option>
                                <option value="4">4 - Good decision</option>
                                <option value="3">3 - Neutral/OK</option>
                                <option value="2">2 - Poor decision</option>
                                <option value="1">1 - Should reverse</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="impact-lessons">Lessons Learned</label>
                            <textarea id="impact-lessons" rows="4" placeholder="What did we learn from this decision?"></textarea>
                        </div>
                        <button class="btn" onclick="saveDecisionImpact()">Save Impact Assessment</button>
                    </div>
                </div>

                <div>
                    <div class="box mb-4">
                        <h3>Impact Assessments</h3>
                        <div id="impact-list" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>

                    <div class="box">
                        <h3>Decision Quality Insights</h3>
                        <div id="decision-insights"></div>
                    </div>
                </div>
            </div>

            <!-- FINANCIAL PROJECTION SIMULATOR -->
            <div class="box mt-4" style="border-left: 4px solid #f39c12;">
                <h3><i class="fas fa-chart-line"></i> Financial Projection Simulator</h3>
                <p class="mb-4" style="font-size: 0.9rem; opacity: 0.8;">
                    Model the long-term financial impact of proposed decisions before voting.
                </p>

                <div class="grid" style="grid-template-columns: 1fr 2fr; gap: 2rem;">
                    <div>
                        <div class="form-group">
                            <label for="projection-amount">Proposed Amount ($)</label>
                            <input type="number" id="projection-amount" step="0.01" placeholder="500.00">
                        </div>
                        <div class="form-group">
                            <label for="projection-type">Expense Type</label>
                            <select id="projection-type">
                                <option value="oneTime">One-time expense</option>
                                <option value="monthly">Monthly recurring</option>
                                <option value="annual">Annual recurring</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="projection-period">Projection Period</label>
                            <select id="projection-period">
                                <option value="6">6 months</option>
                                <option value="12" selected>12 months</option>
                                <option value="24">24 months</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="projection-revenue-type">Expected Revenue Change</label>
                            <select id="projection-revenue-type">
                                <option value="none">No change</option>
                                <option value="increase">Will increase contributions</option>
                                <option value="decrease">Will decrease contributions</option>
                            </select>
                        </div>
                        <div class="form-group" id="projection-revenue-amount-group" style="display: none;">
                            <label for="projection-revenue-amount">Revenue Change ($/month)</label>
                            <input type="number" id="projection-revenue-amount" step="0.01" placeholder="50.00">
                        </div>
                        <button class="btn" onclick="runFinancialProjection()" style="width: 100%; background: #f39c12;">
                            <i class="fas fa-calculator"></i> Run Projection
                        </button>
                    </div>

                    <div>
                        <div id="projection-summary" style="display: none; padding: 1rem; background: #2c3e50; border-radius: 6px; margin-bottom: 1rem;">
                            <!-- Summary will be populated here -->
                        </div>
                        <canvas id="projection-chart" style="display: none; max-height: 350px;"></canvas>
                        <div id="projection-insights" style="margin-top: 1rem; font-size: 0.9rem;">
                            <p style="opacity: 0.7; text-align: center; padding: 2rem;">
                                Enter values and click "Run Projection" to see the financial impact over time.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- INSTITUTIONAL MEMORY & LEARNING SYSTEM -->
            <div class="box mt-4" style="border-left: 4px solid #9b59b6;">
                <h3><i class="fas fa-brain"></i> Institutional Memory & Learning System</h3>
                <p class="mb-4" style="font-size: 0.9rem; opacity: 0.8;">
                    Searchable database of lessons learned from past decisions. Learn from history to make better decisions.
                </p>

                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <div>
                        <div class="form-group">
                            <label for="memory-search">Search Lessons Learned</label>
                            <input type="text" id="memory-search" placeholder="Search by keyword, category, or date..." oninput="searchLessonsLearned()">
                        </div>
                        <div class="form-group">
                            <label for="memory-category-filter">Filter by Category</label>
                            <select id="memory-category-filter" onchange="searchLessonsLearned()">
                                <option value="">All Categories</option>
                                <option value="financial">Financial Decisions</option>
                                <option value="service">Service Structure</option>
                                <option value="meeting">Meeting Format</option>
                                <option value="fellowship">Fellowship</option>
                                <option value="traditions">Traditions/Concepts</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="memory-rating-filter">Filter by Effectiveness</label>
                            <select id="memory-rating-filter" onchange="searchLessonsLearned()">
                                <option value="">All Ratings</option>
                                <option value="5">5 Stars - Excellent</option>
                                <option value="4">4 Stars - Good</option>
                                <option value="3">3 Stars - Neutral</option>
                                <option value="2">2 Stars - Poor</option>
                                <option value="1">1 Star - Should Reverse</option>
                            </select>
                        </div>
                        <div style="margin-top: 1rem; padding: 1rem; background: #2c3e50; border-radius: 6px;">
                            <h4 style="margin-bottom: 0.5rem; color: #9b59b6;">Memory Insights</h4>
                            <div id="memory-stats" style="font-size: 0.85rem;">
                                <p><strong>Total Lessons:</strong> <span id="total-lessons">0</span></p>
                                <p><strong>Avg. Rating:</strong> <span id="avg-lesson-rating">--</span>/5</p>
                                <p><strong>Most Common Category:</strong> <span id="common-category">--</span></p>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h4 style="margin-bottom: 0.75rem;">Lessons Learned Archive</h4>
                        <div id="lessons-list" style="max-height: 500px; overflow-y: auto;">
                            <p style="opacity: 0.7; text-align: center; padding: 2rem;">
                                No lessons learned yet. Add impact assessments to build your institutional memory.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Pattern Recognition -->
                <div style="margin-top: 1.5rem; padding: 1rem; background: #2c3e50; border-radius: 6px; border-left: 3px solid #9b59b6;">
                    <h4><i class="fas fa-lightbulb"></i> Pattern Recognition</h4>
                    <div id="pattern-insights" style="margin-top: 0.75rem; font-size: 0.9rem;">
                        <p style="opacity: 0.7;">Patterns will appear here once you have multiple lessons logged.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- FINANCIAL HEALTH DASHBOARD SECTION -->
        <section id="financial-health-section" style="border-left: 4px solid #1abc9c;">
            <h2><i class="fas fa-heartbeat"></i> Financial Health Dashboard</h2>
            <p class="mb-4">Monitor financial health and impact of spending decisions.</p>

            <div class="grid" style="grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 2rem;">
                <div style="padding: 1.5rem; background: #27ae60; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2rem; color: #fff; font-weight: bold;" id="current-balance">$0.00</div>
                    <div style="margin-top: 0.5rem; color: #ecf0f1;">Current Balance</div>
                </div>
                <div style="padding: 1.5rem; background: #3498db; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2rem; color: #fff; font-weight: bold;" id="prudent-reserve">$0.00</div>
                    <div style="margin-top: 0.5rem; color: #ecf0f1;">Prudent Reserve</div>
                </div>
                <div style="padding: 1.5rem; background: #9b59b6; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2rem; color: #fff; font-weight: bold;" id="contribution-health">0%</div>
                    <div style="margin-top: 0.5rem; color: #ecf0f1;">Contribution Health</div>
                </div>
            </div>

            <div class="box mb-4">
                <h3>"Can We Afford This?" Calculator</h3>
                <div class="grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="afford-amount">Proposed Spending ($)</label>
                        <input type="number" id="afford-amount" step="0.01" placeholder="500.00">
                    </div>
                    <div class="form-group">
                        <label for="afford-category">Category</label>
                        <select id="afford-category">
                            <option value="oneTime">One-time expense</option>
                            <option value="monthly">Monthly recurring</option>
                            <option value="annual">Annual expense</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: flex-end;">
                        <button class="btn" onclick="calculateAffordability()" style="width: 100%;">Calculate</button>
                    </div>
                </div>
                <div id="affordability-result" class="mt-3" style="display: none;"></div>
            </div>

            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div class="box">
                    <h3>7th Tradition Trend (6 Months)</h3>
                    <canvas id="contribution-trend-chart" style="max-height: 300px;"></canvas>
                </div>
                <div class="box">
                    <h3>Spending vs Income</h3>
                    <canvas id="spending-income-chart" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </section>

        <!-- GROUP INVENTORY SCHEDULER SECTION -->
        <section id="inventory-scheduler-section" style="border-left: 4px solid #34495e;">
            <h2><i class="fas fa-calendar-check"></i> Group Inventory Scheduler</h2>
            <p class="mb-4">Schedule and track regular group inventories.</p>

            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Schedule New Inventory</h3>
                        <div class="form-group">
                            <label for="inventory-type">Inventory Type</label>
                            <select id="inventory-type">
                                <option value="traditions">12 Traditions Inventory</option>
                                <option value="concepts">12 Concepts Inventory</option>
                                <option value="format">Meeting Format Inventory</option>
                                <option value="service">Service Structure Inventory</option>
                                <option value="custom">Custom Inventory</option>
                            </select>
                        </div>
                        <div class="form-group" id="custom-inventory-name" style="display: none;">
                            <label for="inventory-custom-name">Custom Inventory Name</label>
                            <input type="text" id="inventory-custom-name" placeholder="e.g., Literature Needs Assessment">
                        </div>
                        <div class="form-group">
                            <label for="inventory-scheduled-date">Scheduled Date</label>
                            <input type="date" id="inventory-scheduled-date">
                        </div>
                        <div class="form-group">
                            <label for="inventory-frequency">Frequency</label>
                            <select id="inventory-frequency">
                                <option value="once">One-time</option>
                                <option value="annual">Annual</option>
                                <option value="semiannual">Semi-annual</option>
                                <option value="quarterly">Quarterly</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="inventory-notes">Notes/Purpose</label>
                            <textarea id="inventory-notes" rows="3" placeholder="Why are we doing this inventory?"></textarea>
                        </div>
                        <button class="btn" onclick="scheduleInventory()">Schedule Inventory</button>
                    </div>
                </div>

                <div>
                    <div class="box mb-4">
                        <h3>Upcoming Inventories</h3>
                        <div id="upcoming-inventories-list"></div>
                    </div>

                    <div class="box">
                        <h3>Completed Inventories</h3>
                        <div id="completed-inventories-list"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ROLE SETTINGS SECTION -->
        <section id="role-settings-section" style="border-left: 4px solid #34495e;">
            <h2><i class="fas fa-user-shield"></i> Role & View Settings</h2>
            <p class="mb-4">Customize your view based on your service position.</p>

            <div class="grid" style="grid-template-columns: 1fr 2fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Select Your Role</h3>
                        <div class="form-group">
                            <label for="user-role-select">Primary Role</label>
                            <select id="user-role-select" onchange="updateRoleView()">
                                <option value="member">Member</option>
                                <option value="gsr">GSR</option>
                                <option value="treasurer">Treasurer</option>
                                <option value="secretary">Secretary</option>
                                <option value="chairperson">Chairperson</option>
                                <option value="literature">Literature Coordinator</option>
                            </select>
                        </div>
                        <button class="btn" onclick="saveUserRole()">Save Role</button>

                        <div class="mt-4">
                            <h4>Role Benefits</h4>
                            <div id="role-benefits" style="font-size: 0.9rem; opacity: 0.8;">
                                <p>Select a role to see customizations</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="box">
                        <h3>Role-Specific Dashboards</h3>
                        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <button class="btn secondary" onclick="showDashboard('gsr')" style="padding: 2rem; font-size: 1rem;">
                                <i class="fas fa-bullhorn"></i><br>GSR Dashboard
                            </button>
                            <button class="btn secondary" onclick="showDashboard('treasurer')" style="padding: 2rem; font-size: 1rem;">
                                <i class="fas fa-dollar-sign"></i><br>Treasurer Dashboard
                            </button>
                            <button class="btn secondary" onclick="showDashboard('secretary')" style="padding: 2rem; font-size: 1rem;">
                                <i class="fas fa-file-alt"></i><br>Secretary Dashboard
                            </button>
                            <button class="btn secondary" onclick="showDashboard('chairperson')" style="padding: 2rem; font-size: 1rem;">
                                <i class="fas fa-gavel"></i><br>Chairperson Dashboard
                            </button>
                        </div>
                    </div>

                    <div class="box mt-4" id="role-dashboard" style="display: none;">
                        <h3 id="dashboard-title">Dashboard</h3>
                        <div id="dashboard-content"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- PRIVACY & ANONYMITY PROTECTION SECTION -->
        <section id="privacy-section" style="border-left: 4px solid #34495e;">
            <h2><i class="fas fa-user-secret"></i> Privacy & Anonymity Protection</h2>
            <p class="mb-4">Configure privacy settings to protect member anonymity and sensitive information.</p>

            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Privacy Settings</h3>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="privacy-anonymous-voting">
                                <strong>Anonymous Voting Mode</strong>
                            </label>
                            <p style="font-size: 0.85rem; opacity: 0.8; margin-left: 1.5rem;">
                                Enable for sensitive topics. Votes are recorded without names.
                            </p>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="privacy-hide-names-export">
                                <strong>Hide Names in Exports</strong>
                            </label>
                            <p style="font-size: 0.85rem; opacity: 0.8; margin-left: 1.5rem;">
                                Replace member names with "Member 1", "Member 2" in exported data.
                            </p>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="privacy-encrypt-sensitive">
                                <strong>Mark Sensitive Motions</strong>
                            </label>
                            <p style="font-size: 0.85rem; opacity: 0.8; margin-left: 1.5rem;">
                                Flag motions as "sensitive" - requires extra confirmation to view.
                            </p>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="privacy-redact-lastnames">
                                <strong>Auto-Redact Last Names</strong>
                            </label>
                            <p style="font-size: 0.85rem; opacity: 0.8; margin-left: 1.5rem;">
                                Show only first names and last initial (e.g., "John S.")
                            </p>
                        </div>
                        <button class="btn" onclick="savePrivacySettings()">Save Privacy Settings</button>
                    </div>
                </div>

                <div>
                    <div class="box">
                        <h3>Multi-Level Access Control</h3>
                        <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem;">
                            Control who can see what information. Based on AA traditions of anonymity and transparency.
                        </p>
                        <div style="background: #34495e; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                            <h4 style="color: #2ecc71; margin-bottom: 0.5rem;">Public Info</h4>
                            <p style="font-size: 0.85rem;">Meeting times, location, format</p>
                            <p style="font-size: 0.75rem; opacity: 0.7;">Anyone can view this information</p>
                        </div>
                        <div style="background: #34495e; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                            <h4 style="color: #3498db; margin-bottom: 0.5rem;">Member Info</h4>
                            <p style="font-size: 0.85rem;">Financial details, voting records, member roster</p>
                            <p style="font-size: 0.75rem; opacity: 0.7;">Homegroup members only</p>
                        </div>
                        <div style="background: #34495e; padding: 1rem; border-radius: 6px;">
                            <h4 style="color: #f39c12; margin-bottom: 0.5rem;">Trusted Servant Info</h4>
                            <p style="font-size: 0.85rem;">Sensitive GC discussions, personnel matters</p>
                            <p style="font-size: 0.75rem; opacity: 0.7;">Trusted servants only (GSR, Secretary, Treasurer, Chairperson)</p>
                        </div>
                        <div class="mt-4">
                            <p style="font-size: 0.85rem; opacity: 0.8;">
                                <strong>Note:</strong> This app honors tradition 12: "Anonymity is the spiritual foundation of all our traditions."
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- TRADITION MOMENTS SECTION -->
        <section id="tradition-moments-section" style="border-left: 4px solid #9b59b6;">
            <h2><i class="fas fa-lightbulb"></i> Tradition Moments</h2>
            <p class="mb-4">Daily reminders of AA's 12 Traditions to guide group decisions.</p>

            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <h3 style="color: white;">Tradition of the Day</h3>
                        <div id="tradition-of-day-display" style="font-size: 1.1rem; padding: 1.5rem;">
                            <!-- Will be populated by JavaScript -->
                        </div>
                        <button class="btn" onclick="randomizeTradition()" style="background: white; color: #667eea;">Show Random Tradition</button>
                    </div>

                    <div class="box mt-4">
                        <h3>Before Voting Reminder</h3>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="tradition-reminder-enabled" checked>
                                <strong>Show tradition reminder before finalizing votes</strong>
                            </label>
                        </div>
                        <p style="font-size: 0.85rem; opacity: 0.8;">
                            When enabled, a relevant tradition will be shown before finalizing important votes to ensure decisions align with AA principles.
                        </p>
                    </div>
                </div>

                <div>
                    <div class="box">
                        <h3>Tradition Violation Warnings</h3>
                        <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem;">
                            Automatic checks for potential tradition violations:
                        </p>
                        <div id="tradition-warnings-list">
                            <div style="padding: 0.75rem; background: #34495e; border-left: 3px solid #e74c3c; margin-bottom: 0.5rem;">
                                <strong>Tradition 6:</strong> Outside enterprises
                                <p style="font-size: 0.85rem; margin-top: 0.25rem;">Warns if motion mentions endorsement, affiliation, or lending the AA name</p>
                            </div>
                            <div style="padding: 0.75rem; background: #34495e; border-left: 3px solid #f39c12; margin-bottom: 0.5rem;">
                                <strong>Tradition 7:</strong> Self-supporting
                                <p style="font-size: 0.85rem; margin-top: 0.25rem;">Warns if accepting outside contributions or donations</p>
                            </div>
                            <div style="padding: 0.75rem; background: #34495e; border-left: 3px solid #f39c12; margin-bottom: 0.5rem;">
                                <strong>Tradition 10:</strong> No outside issues
                                <p style="font-size: 0.85rem; margin-top: 0.25rem;">Warns if motion involves public controversy or outside issues</p>
                            </div>
                            <div style="padding: 0.75rem; background: #34495e; border-left: 3px solid #3498db;">
                                <strong>Tradition 12:</strong> Anonymity
                                <p style="font-size: 0.85rem; margin-top: 0.25rem;">Warns if personal names might be exposed publicly</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- SPIRITUAL PRINCIPLES INTEGRATION SECTION -->
        <section id="spiritual-principles-section" style="border-left: 4px solid #9b59b6;">
            <h2><i class="fas fa-praying-hands"></i> Spiritual Principles Integration</h2>
            <p class="mb-4">Tag motions with spiritual principles and guide decisions based on AA's spiritual foundation.</p>

            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Tag Motion with Principles</h3>
                        <div class="form-group">
                            <label for="principle-motion-select">Select Motion</label>
                            <select id="principle-motion-select">
                                <option value="">-- Select Motion --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="principle-tags">Spiritual Principles (select all that apply)</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                                <label><input type="checkbox" class="principle-checkbox" value="honesty"> Honesty</label>
                                <label><input type="checkbox" class="principle-checkbox" value="humility"> Humility</label>
                                <label><input type="checkbox" class="principle-checkbox" value="unity"> Unity</label>
                                <label><input type="checkbox" class="principle-checkbox" value="service"> Service</label>
                                <label><input type="checkbox" class="principle-checkbox" value="responsibility"> Responsibility</label>
                                <label><input type="checkbox" class="principle-checkbox" value="love"> Love</label>
                                <label><input type="checkbox" class="principle-checkbox" value="tolerance"> Tolerance</label>
                                <label><input type="checkbox" class="principle-checkbox" value="wisdom"> Wisdom</label>
                            </div>
                        </div>
                        <button class="btn" onclick="saveSpiritualPrincipleTags()">Save Principle Tags</button>
                    </div>

                    <div class="box mt-4">
                        <h3>Principles-Based Decision Guide</h3>
                        <p style="font-size: 0.9rem; opacity: 0.8;">Before making a decision, ask:</p>
                        <ul style="font-size: 0.9rem; line-height: 1.8;">
                            <li><strong>Honesty:</strong> Are we being truthful?</li>
                            <li><strong>Humility:</strong> Are we putting principles before personalities?</li>
                            <li><strong>Unity:</strong> Does this promote group unity?</li>
                            <li><strong>Service:</strong> Does this serve our primary purpose?</li>
                        </ul>
                    </div>
                </div>

                <div>
                    <div class="box">
                        <h3>Tagged Motions</h3>
                        <div id="principle-tagged-list" style="max-height: 400px; overflow-y: auto;">
                            <!-- Tagged motions will be displayed here -->
                        </div>
                    </div>

                    <div class="box mt-4">
                        <h3>Step 10 for Groups - Group Inventory Prompts</h3>
                        <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem;">
                            Regular group inventory questions to keep the group healthy:
                        </p>
                        <button class="btn secondary" onclick="startGroupInventory()">Start Group Inventory</button>
                        <div id="group-inventory-questions" style="display: none; margin-top: 1rem;">
                            <div style="padding: 1rem; background: #34495e; border-radius: 6px; margin-bottom: 0.5rem;">
                                <p>1. Are we placing principles before personalities?</p>
                            </div>
                            <div style="padding: 1rem; background: #34495e; border-radius: 6px; margin-bottom: 0.5rem;">
                                <p>2. Are our decisions guided by our primary purpose?</p>
                            </div>
                            <div style="padding: 1rem; background: #34495e; border-radius: 6px; margin-bottom: 0.5rem;">
                                <p>3. Do we practice rotation of leadership?</p>
                            </div>
                            <div style="padding: 1rem; background: #34495e; border-radius: 6px; margin-bottom: 0.5rem;">
                                <p>4. Are we self-supporting?</p>
                            </div>
                            <div style="padding: 1rem; background: #34495e; border-radius: 6px;">
                                <p>5. Is our group atmosphere welcoming and inclusive?</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- UNITY CHECKER SECTION -->
        <section id="unity-checker-section" style="border-left: 4px solid #9b59b6;">
            <h2><i class="fas fa-handshake"></i> Unity Checker & Minority Opinion</h2>
            <p class="mb-4">Ensure decisions promote unity and respect minority voices.</p>

            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Unity Check Before Vote</h3>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="unity-check-enabled" checked>
                                <strong>Enable unity check before finalizing votes</strong>
                            </label>
                        </div>
                        <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem;">
                            When enabled, these questions will appear before finalizing any vote:
                        </p>
                        <div style="background: #34495e; padding: 1rem; border-radius: 6px;">
                            <p style="font-size: 0.9rem; margin-bottom: 0.5rem;"><strong>✓ Does this decision promote unity?</strong></p>
                            <p style="font-size: 0.9rem; margin-bottom: 0.5rem;"><strong>✓ Have all voices been heard?</strong></p>
                            <p style="font-size: 0.9rem;"><strong>✓ Is there a minority opinion that should be recorded?</strong></p>
                        </div>
                    </div>

                    <div class="box mt-4">
                        <h3>Record Minority Opinion</h3>
                        <div class="form-group">
                            <label for="minority-motion-select">Select Motion</label>
                            <select id="minority-motion-select">
                                <option value="">-- Select Motion --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="minority-opinion-text">Minority Opinion Statement</label>
                            <textarea id="minority-opinion-text" rows="4" placeholder="Record the concerns or alternative viewpoint..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="minority-vote-count">Number in Minority</label>
                            <input type="number" id="minority-vote-count" min="1" placeholder="e.g., 3">
                        </div>
                        <button class="btn" onclick="saveMinorityOpinion()">Record Minority Opinion</button>
                    </div>
                </div>

                <div>
                    <div class="box">
                        <h3>Consensus Builder Tools</h3>
                        <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem;">
                            When there's disagreement, try these approaches:
                        </p>
                        <div style="background: #34495e; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                            <h4 style="color: #3498db;">1. Table the Motion</h4>
                            <p style="font-size: 0.85rem;">Give time for prayer, reflection, and discussion outside the meeting</p>
                            <button class="btn secondary" onclick="tableCurrentMotion()">Table Current Motion</button>
                        </div>
                        <div style="background: #34495e; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                            <h4 style="color: #3498db;">2. Form Committee</h4>
                            <p style="font-size: 0.85rem;">Create a committee to research and bring recommendations</p>
                            <button class="btn secondary" onclick="formCommittee()">Form Ad Hoc Committee</button>
                        </div>
                        <div style="background: #34495e; padding: 1rem; border-radius: 6px;">
                            <h4 style="color: #3498db;">3. Find Common Ground</h4>
                            <p style="font-size: 0.85rem;">Identify what everyone agrees on and build from there</p>
                            <button class="btn secondary" onclick="openCommonGroundDialog()">Start Common Ground Exercise</button>
                        </div>
                    </div>

                    <div class="box mt-4">
                        <h3>Recorded Minority Opinions</h3>
                        <div id="minority-opinions-list" style="max-height: 300px; overflow-y: auto;">
                            <!-- Minority opinions will be displayed here -->
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- SERVICE STRUCTURE VISUALIZER SECTION -->
        <section id="service-structure-section" style="border-left: 4px solid #2ecc71;">
            <h2><i class="fas fa-sitemap"></i> Service Structure Visualizer</h2>
            <p class="mb-4">Visual representation of AA's service structure and how group conscience flows.</p>

            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Configure Your Service Structure</h3>
                        <div class="form-group">
                            <label for="structure-group-name">Group Name</label>
                            <input type="text" id="structure-group-name" placeholder="Your group name">
                        </div>
                        <div class="form-group">
                            <label for="structure-district">District</label>
                            <input type="text" id="structure-district" placeholder="District number or name">
                        </div>
                        <div class="form-group">
                            <label for="structure-area">Area</label>
                            <input type="text" id="structure-area" placeholder="Area name">
                        </div>
                        <div class="form-group">
                            <label for="structure-gsr-name">GSR Name</label>
                            <input type="text" id="structure-gsr-name" placeholder="General Service Representative">
                        </div>
                        <button class="btn" onclick="saveServiceStructure()">Save Structure Info</button>
                    </div>
                </div>

                <div>
                    <div class="box">
                        <h3>Upside-Down Triangle</h3>
                        <p style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 1rem;">
                            In AA, the traditional leadership triangle is inverted - servants are at the bottom supporting the groups.
                        </p>
                        <div id="service-triangle" style="text-align: center; padding: 2rem;">
                            <div style="width: 100%; border-bottom: 3px solid #3498db; padding: 1rem; background: #34495e; margin-bottom: 1rem;">
                                <strong style="font-size: 1.1rem;">The Groups</strong>
                                <p style="font-size: 0.8rem; opacity: 0.8;">Ultimate authority & responsibility</p>
                            </div>
                            <div style="width: 90%; margin: 0 auto; border-bottom: 3px solid #3498db; padding: 1rem; background: #34495e; margin-bottom: 1rem;">
                                <strong>District & GSRs</strong>
                                <p style="font-size: 0.8rem; opacity: 0.8;">Serve the groups</p>
                            </div>
                            <div style="width: 80%; margin: 0 auto; border-bottom: 3px solid #3498db; padding: 1rem; background: #34495e; margin-bottom: 1rem;">
                                <strong>Area Assembly</strong>
                                <p style="font-size: 0.8rem; opacity: 0.8;">Coordinates districts</p>
                            </div>
                            <div style="width: 70%; margin: 0 auto; padding: 1rem; background: #34495e;">
                                <strong>GSO (General Service Office)</strong>
                                <p style="font-size: 0.8rem; opacity: 0.8;">Supports worldwide AA</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="box mt-4">
                <h3>Flow of Group Conscience</h3>
                <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem;">
                    How decisions flow through AA's service structure:
                </p>
                <div class="grid" style="grid-template-columns: repeat(4, 1fr); gap: 1rem; text-align: center;">
                    <div style="background: #34495e; padding: 1.5rem; border-radius: 6px; border-top: 4px solid #2ecc71;">
                        <strong>1. Home Group</strong>
                        <p style="font-size: 0.85rem; margin-top: 0.5rem; opacity: 0.8;">Group conscience formed</p>
                    </div>
                    <div style="background: #34495e; padding: 1.5rem; border-radius: 6px; border-top: 4px solid #3498db;">
                        <strong>2. GSR Reports</strong>
                        <p style="font-size: 0.85rem; margin-top: 0.5rem; opacity: 0.8;">Carries voice to district</p>
                    </div>
                    <div style="background: #34495e; padding: 1.5rem; border-radius: 6px; border-top: 4px solid #9b59b6;">
                        <strong>3. District Meeting</strong>
                        <p style="font-size: 0.85rem; margin-top: 0.5rem; opacity: 0.8;">Groups share & discuss</p>
                    </div>
                    <div style="background: #34495e; padding: 1.5rem; border-radius: 6px; border-top: 4px solid #f39c12;">
                        <strong>4. Area Assembly</strong>
                        <p style="font-size: 0.85rem; margin-top: 0.5rem; opacity: 0.8;">Collective conscience</p>
                    </div>
                </div>
                <div style="margin-top: 2rem; text-align: center;">
                    <p style="font-size: 1.1rem; color: #3498db;">
                        <strong>"Our leaders are but trusted servants; they do not govern."</strong>
                    </p>
                    <p style="font-size: 0.85rem; opacity: 0.8; margin-top: 0.5rem;">- Tradition 2</p>
                </div>
            </div>
        </section>
    </main>

    <!-- Member Roster Modal -->
    <!-- GC Details Modal with Discussion/Comments -->
    <div id="gc-details-modal" class="modal">
        <div class="box" style="width: 90%; max-width: 900px; max-height: 90vh; overflow-y: auto; background: #2c3e50; color: #ecf0f1; border: 1px solid #3498db;">
            <span class="modal-close" onclick="closeGCDetailsModal()">&times;</span>
            <h2 style="color: #3498db;">Motion Details & Discussion</h2>
            <div id="gc-details-content" style="margin: 1rem 0;">
                <!-- Motion details will be inserted here -->
            </div>

            <div style="margin-top: 2rem;">
                <h3 style="color: #3498db; margin-bottom: 1rem;">Discussion & Comments</h3>
                <div id="gc-comments-list" style="max-height: 300px; overflow-y: auto; margin-bottom: 1rem; padding: 0.5rem; background: #34495e; border-radius: 6px;">
                    <!-- Comments will be listed here -->
                </div>

                <div class="form-group">
                    <label for="gc-comment-text">Add Comment</label>
                    <textarea id="gc-comment-text" rows="3" placeholder="Add your comment or discussion note..."></textarea>
                </div>
                <div class="form-group">
                    <label for="gc-comment-author">Your Name</label>
                    <input type="text" id="gc-comment-author" placeholder="Name">
                </div>
                <div class="form-group">
                    <label for="gc-comment-type">Comment Type</label>
                    <select id="gc-comment-type">
                        <option value="discussion">Discussion Note</option>
                        <option value="amendment">Proposed Amendment</option>
                        <option value="clarification">Clarification</option>
                        <option value="support">Support Statement</option>
                        <option value="concern">Concern/Opposition</option>
                    </select>
                </div>
                <button class="btn" onclick="addGCComment()">Add Comment</button>
                <button class="btn secondary" onclick="closeGCDetailsModal()" style="margin-left: 0.5rem;">Close</button>
            </div>
        </div>
    </div>

    <div id="roster-modal" class="modal">
        <div class="box" style="width: 90%; max-width: 1200px; max-height: 90vh; overflow-y: auto; background: #2c3e50; color: #ecf0f1; border: 1px solid #3498db;">
            <span class="modal-close" onclick="closeRosterModal()">&times;</span>
            <h2 style="color: #3498db;">Full Member Roster</h2>
            <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                <input type="text" id="roster-search" onkeyup="renderRosterTable()" placeholder="Search by name, email, phone..." style="flex-grow: 1;" />
                <button class="btn" onclick="openMemberFormFromModal()">Add New Member</button>
            </div>
            <div style="overflow-x: auto;">
                <table id="roster-table">
                    <thead>
                        <tr>
                            <th onclick="sortRosterBy('name')" style="cursor: pointer;">Name &#x2195;</th>
                            <th onclick="sortRosterBy('city')" style="cursor: pointer;">City &#x2195;</th>
                            <th onclick="sortRosterBy('homegroup')" style="cursor: pointer;">Homegroup &#x2195;</th>
                            <th>Phone</th>
                            <th>Email</th>
                            <th onclick="sortRosterBy('isServant')" style="cursor: pointer;">Servant? &#x2195;</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="roster-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Embed the application script directly into this file -->
    <script>
// Utility to generate unique IDs based on timestamp
function genId() {
    return Date.now().toString() + Math.random().toString(36).substring(2);
}

// Sanitize user input to prevent XSS attacks
function sanitizeInput(input) {
    if (typeof input !== 'string') return input;
    // Use DOMPurify if available, otherwise basic escaping
    if (typeof DOMPurify !== 'undefined') {
        return DOMPurify.sanitize(input, { ALLOWED_TAGS: [] });
    }
    // Fallback: basic HTML entity encoding
    const div = document.createElement('div');
    div.textContent = input;
    return div.innerHTML;
}

// Sanitize HTML content (for rich text that needs some HTML)
function sanitizeHTML(html) {
    if (typeof html !== 'string') return html;
    if (typeof DOMPurify !== 'undefined') {
        return DOMPurify.sanitize(html, {
            ALLOWED_TAGS: ['b', 'i', 'em', 'strong', 'br', 'p', 'ul', 'ol', 'li'],
            ALLOWED_ATTR: []
        });
    }
    return sanitizeInput(html);
}

// Navigate to a given section and update nav active states
function goToSection(sectionId) {
    // Remove active class from all sections and nav items
    document.querySelectorAll('main section').forEach(sec => sec.classList.remove('active'));
    document.querySelectorAll('nav li').forEach(li => li.classList.remove('active'));

    // Add active class to target section
    const section = document.getElementById(sectionId);
    if (section) {
        section.classList.add('active');
    } else {
        console.warn('Section not found:', sectionId);
        return;
    }

    // Add active class to corresponding nav item
    const navItem = document.querySelector('nav li[data-section="' + sectionId + '"]');
    if (navItem) {
        navItem.classList.add('active');
    }

    // Scroll to top of main content
    const mainEl = document.querySelector('main');
    if (mainEl) {
        mainEl.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Close all dropdowns after navigation
    document.querySelectorAll('nav li.has-dropdown').forEach(dd => {
        dd.classList.remove('dropdown-open');
    });

    // Section-specific initialization
    if (sectionId === 'schedule-section') {
        renderCalendar();
    } else if (sectionId === 'analytics-section') {
        refreshAnalytics();
    } else if (sectionId === 'birthdays-section') {
        updateBirthdaysTable();
    } else if (sectionId === 'announcements-section') {
        updateAnnouncementsList();
    }
}
// Toggle form visibility
function toggleEventForm() {
    const form = document.getElementById('add-event-form');
    if (!form) return;
    const isVisible = form.style.display === 'block';
    form.style.display = isVisible ? 'none' : 'block';
}

function toggleMemberForm() {
    const form = document.getElementById('add-member-form');
    if (!form) return;
    const isVisible = form.style.display === 'block';
    form.style.display = isVisible ? 'none' : 'block';
}
// Toast Notification
function showToast(message, type = 'info') { // type can be 'info', 'success', or 'error'
    const container = document.getElementById('toast-container');
    if (!container) return;
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    container.appendChild(toast);

    // Animate in
    setTimeout(() => {
        toast.classList.add('show');
    }, 100);

    // Animate out and remove
    setTimeout(() => {
        toast.classList.remove('show');
        toast.addEventListener('transitionend', () => {
            toast.remove();
        }, { once: true }); // Use once option to prevent multiple fires
    }, 3000); // Toast disappears after 3 seconds
}

// Input validation utilities
function validateEmail(email) {
    if (!email) return true; // Empty email is allowed
    // Improved email regex - RFC 5322 compliant with reasonable restrictions
    const emailRegex = /^[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;

    // Additional checks
    if (email.length > 254) return false; // RFC 5321 maximum length
    if (!emailRegex.test(email)) return false;

    // Ensure TLD is at least 2 characters
    const parts = email.split('@');
    if (parts.length !== 2) return false;
    const domain = parts[1];
    const domainParts = domain.split('.');
    const tld = domainParts[domainParts.length - 1];

    return tld.length >= 2;
}

function validatePhone(phone) {
    if (!phone) return true; // Empty phone is allowed
    // Accepts formats: 123-456-7890, (123) 456-7890, 123.456.7890, 1234567890, +1-123-456-7890
    const phoneRegex = /^[\d\s\-\(\)\.\+]+$/;
    const digits = phone.replace(/\D/g, '');

    // Phone must have 10-15 digits (supports international)
    return phoneRegex.test(phone) && digits.length >= 10 && digits.length <= 15;
}

// HTML/attribute escaping utilities
function escapeHtml(text) {
    if (text === null || text === undefined) return '';
    const div = document.createElement('div');
    div.textContent = String(text);
    return div.innerHTML;
}

function escapeAttribute(value) {
    if (value === null || value === undefined) return '';
    if (typeof value !== 'string') value = String(value);
    return value.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
}

// Enhanced sanitization using DOMPurify (for rich content if needed)
function sanitizeHtml(dirty) {
    if (typeof DOMPurify === 'undefined') {
        console.warn('DOMPurify not loaded, falling back to basic escaping');
        return escapeHtml(dirty);
    }
    return DOMPurify.sanitize(dirty, {
        ALLOWED_TAGS: ['b', 'i', 'em', 'strong', 'br', 'p', 'ul', 'ol', 'li'],
        ALLOWED_ATTR: []
    });
}

// Safe number parsing with validation
function parseIntSafe(value, defaultValue = 0) {
    const parsed = parseInt(value, 10);
    return isNaN(parsed) ? defaultValue : parsed;
}

function parseFloatSafe(value, defaultValue = 0.0) {
    const parsed = parseFloat(value);
    return isNaN(parsed) ? defaultValue : parsed;
}

// LocalStorage quota monitoring utilities
function getLocalStorageSize() {
    let total = 0;
    for (let key in localStorage) {
        if (localStorage.hasOwnProperty(key)) {
            total += localStorage[key].length + key.length;
        }
    }
    return total;
}

function checkLocalStorageQuota() {
    try {
        const currentSize = getLocalStorageSize();
        const estimatedLimit = 5 * 1024 * 1024; // 5MB typical limit
        const usagePercent = (currentSize / estimatedLimit) * 100;

        if (usagePercent > 90) {
            showToast(`Warning: localStorage is ${usagePercent.toFixed(1)}% full. Consider exporting and archiving old data.`, 'error');
            return false;
        } else if (usagePercent > 75) {
            showToast(`Notice: localStorage is ${usagePercent.toFixed(1)}% full.`, 'warning');
        }
        return true;
    } catch (e) {
        showToast('Error checking storage quota: ' + e.message, 'error');
        return false;
    }
}

function safeLocalStorageSet(key, value) {
    try {
        localStorage.setItem(key, value);
        return true;
    } catch (e) {
        if (e.name === 'QuotaExceededError' || e.code === 22) {
            const sizeKB = (getLocalStorageSize() / 1024).toFixed(2);
            showToast(`Storage quota exceeded! Current usage: ${sizeKB}KB. Please export and delete old data.`, 'error');
            return false;
        }
        throw e;
    }
}

// Storage wrappers using localStorage with error handling
const storage = {
    getEvents() {
        try { return JSON.parse(localStorage.getItem('events') || '[]'); }
        catch(e) { console.error('Error parsing events:', e); return []; }
    },
    saveEvents(events) { localStorage.setItem('events', JSON.stringify(events)); },
    getMembers() {
        try { return JSON.parse(localStorage.getItem('members') || '[]'); }
        catch(e) { console.error('Error parsing members:', e); return []; }
    },
    saveMembers(m) { localStorage.setItem('members', JSON.stringify(m)); },
    getAnnouncements() {
        try { return JSON.parse(localStorage.getItem('announcements') || '[]'); }
        catch(e) { console.error('Error parsing announcements:', e); return []; }
    },
    saveAnnouncements(a) { localStorage.setItem('announcements', JSON.stringify(a)); },
    getPhotos() {
        try { return JSON.parse(localStorage.getItem('photos') || '[]'); }
        catch(e) { console.error('Error parsing photos:', e); return []; }
    },
    savePhotos(p) {
        const jsonStr = JSON.stringify(p);
        if (!safeLocalStorageSet('photos', jsonStr)) {
            throw new Error('Failed to save photos due to storage quota exceeded');
        }
    },
    getChairpersonLog() {
        try { return JSON.parse(localStorage.getItem('chairpersonLog') || '[]'); }
        catch(e) { console.error('Error parsing chairpersonLog:', e); return []; }
    },
    saveChairpersonLog(log) { localStorage.setItem('chairpersonLog', JSON.stringify(log)); },
    getGroupConscienceLog() {
        try { return JSON.parse(localStorage.getItem('groupConscienceLog') || '[]'); }
        catch(e) { console.error('Error parsing groupConscienceLog:', e); return []; }
    },
    saveGroupConscienceLog(log) { localStorage.setItem('groupConscienceLog', JSON.stringify(log)); },
    getLiveGCItems() {
        try { return JSON.parse(localStorage.getItem('liveGCItems') || '[]'); }
        catch(e) { console.error('Error parsing liveGCItems:', e); return []; }
    },
    saveLiveGCItems(items) { localStorage.setItem('liveGCItems', JSON.stringify(items)); },
    getProposedAgendaItems() {
        try { return JSON.parse(localStorage.getItem('proposedAgendaItems') || '[]'); }
        catch(e) { console.error('Error parsing proposedAgendaItems:', e); return []; }
    },
    saveProposedAgendaItems(items) { localStorage.setItem('proposedAgendaItems', JSON.stringify(items)); },
    getGCComments() {
        try { return JSON.parse(localStorage.getItem('gcComments') || '[]'); }
        catch(e) { console.error('Error parsing gcComments:', e); return []; }
    },
    saveGCComments(comments) { localStorage.setItem('gcComments', JSON.stringify(comments)); },
    getGCActionItems() {
        try { return JSON.parse(localStorage.getItem('gcActionItems') || '[]'); }
        catch(e) { console.error('Error parsing gcActionItems:', e); return []; }
    },
    saveGCActionItems(actions) { localStorage.setItem('gcActionItems', JSON.stringify(actions)); },
    getGCSettings() {
        try { return JSON.parse(localStorage.getItem('gcSettings') || '{"quorumPercentage": 50, "quorumMinimum": 5}'); }
        catch(e) { console.error('Error parsing gcSettings:', e); return {"quorumPercentage": 50, "quorumMinimum": 5}; }
    },
    saveGCSettings(settings) { localStorage.setItem('gcSettings', JSON.stringify(settings)); },

    // New feature storage methods
    getMessages() {
        try { return JSON.parse(localStorage.getItem('messages') || '[]'); }
        catch(e) { console.error('Error parsing messages:', e); return []; }
    },
    saveMessages(messages) { localStorage.setItem('messages', JSON.stringify(messages)); },
    getServicePositions() {
        try { return JSON.parse(localStorage.getItem('servicePositions') || '[]'); }
        catch(e) { console.error('Error parsing servicePositions:', e); return []; }
    },
    saveServicePositions(positions) { localStorage.setItem('servicePositions', JSON.stringify(positions)); },
    getNominations() {
        try { return JSON.parse(localStorage.getItem('nominations') || '[]'); }
        catch(e) { console.error('Error parsing nominations:', e); return []; }
    },
    saveNominations(nominations) { localStorage.setItem('nominations', JSON.stringify(nominations)); },
    getBudgetCategories() {
        try { return JSON.parse(localStorage.getItem('budgetCategories') || '[]'); }
        catch(e) { console.error('Error parsing budgetCategories:', e); return []; }
    },
    saveBudgetCategories(categories) { localStorage.setItem('budgetCategories', JSON.stringify(categories)); },
    getExpenses() {
        try { return JSON.parse(localStorage.getItem('expenses') || '[]'); }
        catch(e) { console.error('Error parsing expenses:', e); return []; }
    },
    saveExpenses(expenses) { localStorage.setItem('expenses', JSON.stringify(expenses)); },
    getTemplates() {
        try { return JSON.parse(localStorage.getItem('templates') || '[]'); }
        catch(e) { console.error('Error parsing templates:', e); return []; }
    },
    saveTemplates(templates) { localStorage.setItem('templates', JSON.stringify(templates)); },
    getAnnouncementReadReceipts() {
        try { return JSON.parse(localStorage.getItem('announcementReadReceipts') || '{}'); }
        catch(e) { console.error('Error parsing announcementReadReceipts:', e); return {}; }
    },
    saveAnnouncementReadReceipts(receipts) { localStorage.setItem('announcementReadReceipts', JSON.stringify(receipts)); },
    getCurrentUser() { return localStorage.getItem('currentUser') || 'Anonymous'; },
    saveCurrentUser(user) { localStorage.setItem('currentUser', user); },

    // New High-Impact Features Storage
    getLiteratureInventory() {
        try { return JSON.parse(localStorage.getItem('literatureInventory') || '[]'); }
        catch(e) { console.error('Error parsing literatureInventory:', e); return []; }
    },
    saveLiteratureInventory(inventory) { localStorage.setItem('literatureInventory', JSON.stringify(inventory)); },
    getLiteratureLoans() {
        try { return JSON.parse(localStorage.getItem('literatureLoans') || '[]'); }
        catch(e) { console.error('Error parsing literatureLoans:', e); return []; }
    },
    saveLiteratureLoans(loans) { localStorage.setItem('literatureLoans', JSON.stringify(loans)); },
    getServiceElections() {
        try { return JSON.parse(localStorage.getItem('serviceElections') || '[]'); }
        catch(e) { console.error('Error parsing serviceElections:', e); return []; }
    },
    saveServiceElections(elections) { localStorage.setItem('serviceElections', JSON.stringify(elections)); },
    getElectionBallots() {
        try { return JSON.parse(localStorage.getItem('electionBallots') || '[]'); }
        catch(e) { console.error('Error parsing electionBallots:', e); return []; }
    },
    saveElectionBallots(ballots) { localStorage.setItem('electionBallots', JSON.stringify(ballots)); },
    getSpeakingQueue() {
        try { return JSON.parse(localStorage.getItem('speakingQueue') || '[]'); }
        catch(e) { console.error('Error parsing speakingQueue:', e); return []; }
    },
    saveSpeakingQueue(queue) { localStorage.setItem('speakingQueue', JSON.stringify(queue)); },
    getMotionTemplates() {
        try { return JSON.parse(localStorage.getItem('motionTemplates') || '[]'); }
        catch(e) { console.error('Error parsing motionTemplates:', e); return []; }
    },
    saveMotionTemplates(templates) { localStorage.setItem('motionTemplates', JSON.stringify(templates)); },
    getTraditionChecks() {
        try { return JSON.parse(localStorage.getItem('traditionChecks') || '[]'); }
        catch(e) { console.error('Error parsing traditionChecks:', e); return []; }
    },
    saveTraditionChecks(checks) { localStorage.setItem('traditionChecks', JSON.stringify(checks)); },
    getBudgetProposals() {
        try { return JSON.parse(localStorage.getItem('budgetProposals') || '[]'); }
        catch(e) { console.error('Error parsing budgetProposals:', e); return []; }
    },
    saveBudgetProposals(proposals) { localStorage.setItem('budgetProposals', JSON.stringify(proposals)); },
    getDistrictMotions() {
        try { return JSON.parse(localStorage.getItem('districtMotions') || '[]'); }
        catch(e) { console.error('Error parsing districtMotions:', e); return []; }
    },
    saveDistrictMotions(motions) { localStorage.setItem('districtMotions', JSON.stringify(motions)); },
    getGroupPositions() {
        try { return JSON.parse(localStorage.getItem('groupPositions') || '[]'); }
        catch(e) { console.error('Error parsing groupPositions:', e); return []; }
    },
    saveGroupPositions(positions) { localStorage.setItem('groupPositions', JSON.stringify(positions)); },
    getVotingSettings() {
        try { return JSON.parse(localStorage.getItem('votingSettings') || '{"method": "substantialUnanimity", "threshold": 66.67, "allowAbstain": true}'); }
        catch(e) { console.error('Error parsing votingSettings:', e); return {"method": "substantialUnanimity", "threshold": 66.67, "allowAbstain": true}; }
    },
    saveVotingSettings(settings) { localStorage.setItem('votingSettings', JSON.stringify(settings)); },

    // Enhanced Features Storage
    getQuorumRules() {
        try { return JSON.parse(localStorage.getItem('quorumRules') || '[]'); }
        catch(e) { console.error('Error parsing quorumRules:', e); return []; }
    },
    saveQuorumRules(rules) { localStorage.setItem('quorumRules', JSON.stringify(rules)); },
    getMeetingMinutes() {
        try { return JSON.parse(localStorage.getItem('meetingMinutes') || '[]'); }
        catch(e) { console.error('Error parsing meetingMinutes:', e); return []; }
    },
    saveMeetingMinutes(minutes) { localStorage.setItem('meetingMinutes', JSON.stringify(minutes)); },
    getInventorySchedules() {
        try { return JSON.parse(localStorage.getItem('inventorySchedules') || '[]'); }
        catch(e) { console.error('Error parsing inventorySchedules:', e); return []; }
    },
    saveInventorySchedules(schedules) { localStorage.setItem('inventorySchedules', JSON.stringify(schedules)); },
    getDecisionImpacts() {
        try { return JSON.parse(localStorage.getItem('decisionImpacts') || '[]'); }
        catch(e) { console.error('Error parsing decisionImpacts:', e); return []; }
    },
    saveDecisionImpacts(impacts) { localStorage.setItem('decisionImpacts', JSON.stringify(impacts)); },
    getParticipationData() {
        try { return JSON.parse(localStorage.getItem('participationData') || '{"votes": [], "attendance": []}'); }
        catch(e) { console.error('Error parsing participationData:', e); return {"votes": [], "attendance": []}; }
    },
    saveParticipationData(data) { localStorage.setItem('participationData', JSON.stringify(data)); },
    getUserRole() {
        try { return localStorage.getItem('userRole') || 'member'; }
        catch(e) { console.error('Error getting userRole:', e); return 'member'; }
    },
    saveUserRole(role) { localStorage.setItem('userRole', role); },
    getEducationalProgress() {
        try { return JSON.parse(localStorage.getItem('educationalProgress') || '{"completed": [], "dismissed": []}'); }
        catch(e) { console.error('Error parsing educationalProgress:', e); return {"completed": [], "dismissed": []}; }
    },
    saveEducationalProgress(progress) { localStorage.setItem('educationalProgress', JSON.stringify(progress)); },

    // Privacy & Security Storage
    getPrivacySettings() {
        try { return JSON.parse(localStorage.getItem('privacySettings') || '{"anonymousVoting": false, "hideNamesInExports": false, "encryptSensitive": false, "autoRedactLastNames": false}'); }
        catch(e) { console.error('Error parsing privacySettings:', e); return {"anonymousVoting": false, "hideNamesInExports": false, "encryptSensitive": false, "autoRedactLastNames": false}; }
    },
    savePrivacySettings(settings) { localStorage.setItem('privacySettings', JSON.stringify(settings)); },
    getAccessLevels() {
        try { return JSON.parse(localStorage.getItem('accessLevels') || '{}'); }
        catch(e) { console.error('Error parsing accessLevels:', e); return {}; }
    },
    saveAccessLevels(levels) { localStorage.setItem('accessLevels', JSON.stringify(levels)); },

    // AA-Specific Features Storage
    getTraditionOfDay() {
        try { return JSON.parse(localStorage.getItem('traditionOfDay') || '{"tradition": 1, "date": ""}'); }
        catch(e) { console.error('Error parsing traditionOfDay:', e); return {"tradition": 1, "date": ""}; }
    },
    saveTraditionOfDay(data) { localStorage.setItem('traditionOfDay', JSON.stringify(data)); },
    getSpiritualPrinciples() {
        try { return JSON.parse(localStorage.getItem('spiritualPrinciples') || '[]'); }
        catch(e) { console.error('Error parsing spiritualPrinciples:', e); return []; }
    },
    saveSpiritualPrinciples(principles) { localStorage.setItem('spiritualPrinciples', JSON.stringify(principles)); },

    // P2-2: Notification System Storage
    getNotifications() {
        try { return JSON.parse(localStorage.getItem('notifications') || '[]'); }
        catch(e) { console.error('Error parsing notifications:', e); return []; }
    },
    saveNotifications(notifications) { localStorage.setItem('notifications', JSON.stringify(notifications)); },

    getUnityChecks() {
        try { return JSON.parse(localStorage.getItem('unityChecks') || '[]'); }
        catch(e) { console.error('Error parsing unityChecks:', e); return []; }
    },
    saveUnityChecks(checks) { localStorage.setItem('unityChecks', JSON.stringify(checks)); },
    getMinorityOpinions() {
        try { return JSON.parse(localStorage.getItem('minorityOpinions') || '[]'); }
        catch(e) { console.error('Error parsing minorityOpinions:', e); return []; }
    },
    saveMinorityOpinions(opinions) { localStorage.setItem('minorityOpinions', JSON.stringify(opinions)); },
    getServiceStructure() {
        try { return JSON.parse(localStorage.getItem('serviceStructure') || '{"group": {}, "district": {}, "area": {}}'); }
        catch(e) { console.error('Error parsing serviceStructure:', e); return {"group": {}, "district": {}, "area": {}}; }
    },
    saveServiceStructure(structure) { localStorage.setItem('serviceStructure', JSON.stringify(structure)); },

    // Backward compatibility: Import birthdays from old format
    saveBirthdays(birthdays) {
        const existingMembers = this.getMembers();
        birthdays.forEach(b => {
            const existingIndex = existingMembers.findIndex(m => m.id === b.id);
            if (existingIndex >= 0) {
                // Update existing member's birthday
                existingMembers[existingIndex].birthday = b.birthday;
                if (b.phone) existingMembers[existingIndex].phone = b.phone;
                if (b.email) existingMembers[existingIndex].email = b.email;
            } else {
                // Add new member
                existingMembers.push({
                    id: b.id || genId(),
                    name: b.name,
                    birthday: b.birthday,
                    phone: b.phone || '',
                    email: b.email || '',
                    homegroup: 'Yes',
                    sponsor: '',
                    city: '',
                    isServant: false,
                    servantPosition: '',
                    servantSince: ''
                });
            }
        });
        this.saveMembers(existingMembers);
    },

    // NEW FEATURE STORAGE METHODS (10 High-Priority Enhancements)

    // Feature 1: Standing/Recurring Agenda Items
    getStandingAgendaItems() {
        try { return JSON.parse(localStorage.getItem('standingAgendaItems') || '[]'); }
        catch(e) { console.error('Error parsing standingAgendaItems:', e); return []; }
    },
    saveStandingAgendaItems(items) { localStorage.setItem('standingAgendaItems', JSON.stringify(items)); },

    // Feature 2 & 3: Tabled Motions and Amendments
    getTabledMotions() {
        try { return JSON.parse(localStorage.getItem('tabledMotions') || '[]'); }
        catch(e) { console.error('Error parsing tabledMotions:', e); return []; }
    },
    saveTabledMotions(motions) { localStorage.setItem('tabledMotions', JSON.stringify(motions)); },

    getMotionAmendments() {
        try { return JSON.parse(localStorage.getItem('motionAmendments') || '{}'); }
        catch(e) { console.error('Error parsing motionAmendments:', e); return {}; }
    },
    saveMotionAmendments(amendments) { localStorage.setItem('motionAmendments', JSON.stringify(amendments)); },

    // Feature 5: Discussion Threads
    getDiscussionThreads() {
        try { return JSON.parse(localStorage.getItem('discussionThreads') || '{}'); }
        catch(e) { console.error('Error parsing discussionThreads:', e); return {}; }
    },
    saveDiscussionThreads(threads) { localStorage.setItem('discussionThreads', JSON.stringify(threads)); },

    // Feature 7: Email Integration Settings
    getEmailSettings() {
        try { return JSON.parse(localStorage.getItem('emailSettings') || '{"fromAddress": "", "fromName": "", "recipientList": ""}'); }
        catch(e) { console.error('Error parsing emailSettings:', e); return {"fromAddress": "", "fromName": "", "recipientList": ""}; }
    },
    saveEmailSettings(settings) { localStorage.setItem('emailSettings', JSON.stringify(settings)); },

    getEmailHistory() {
        try { return JSON.parse(localStorage.getItem('emailHistory') || '[]'); }
        catch(e) { console.error('Error parsing emailHistory:', e); return []; }
    },
    saveEmailHistory(history) { localStorage.setItem('emailHistory', JSON.stringify(history)); },

    // Feature 8: Member Voting History
    getMemberVotingRecords() {
        try { return JSON.parse(localStorage.getItem('memberVotingRecords') || '{}'); }
        catch(e) { console.error('Error parsing memberVotingRecords:', e); return {}; }
    },
    saveMemberVotingRecords(records) { localStorage.setItem('memberVotingRecords', JSON.stringify(records)); },

    // Feature 9: Decision Implementation Tracking
    getImplementationTracking() {
        try { return JSON.parse(localStorage.getItem('implementationTracking') || '[]'); }
        catch(e) { console.error('Error parsing implementationTracking:', e); return []; }
    },
    saveImplementationTracking(tracking) { localStorage.setItem('implementationTracking', JSON.stringify(tracking)); },

    // Feature 10: Consent Agenda
    getConsentAgendaItems() {
        try { return JSON.parse(localStorage.getItem('consentAgendaItems') || '[]'); }
        catch(e) { console.error('Error parsing consentAgendaItems:', e); return []; }
    },
    saveConsentAgendaItems(items) { localStorage.setItem('consentAgendaItems', JSON.stringify(items)); },

    getConsentHistory() {
        try { return JSON.parse(localStorage.getItem('consentHistory') || '[]'); }
        catch(e) { console.error('Error parsing consentHistory:', e); return []; }
    },
    saveConsentHistory(history) { localStorage.setItem('consentHistory', JSON.stringify(history)); },

    // MEDIUM PRIORITY FEATURE STORAGE METHODS

    // Feature 11: Motion Reconsideration
    getReconsiderationRequests() {
        try { return JSON.parse(localStorage.getItem('reconsiderationRequests') || '[]'); }
        catch(e) { console.error('Error parsing reconsiderationRequests:', e); return []; }
    },
    saveReconsiderationRequests(requests) { localStorage.setItem('reconsiderationRequests', JSON.stringify(requests)); },

    // Feature 12: Calendar Events
    getCalendarEvents() {
        try { return JSON.parse(localStorage.getItem('calendarEvents') || '[]'); }
        catch(e) { console.error('Error parsing calendarEvents:', e); return []; }
    },
    saveCalendarEvents(events) { localStorage.setItem('calendarEvents', JSON.stringify(events)); },

    // Feature 13: ROI Calculations
    getROICalculations() {
        try { return JSON.parse(localStorage.getItem('roiCalculations') || '[]'); }
        catch(e) { console.error('Error parsing roiCalculations:', e); return []; }
    },
    saveROICalculations(calculations) { localStorage.setItem('roiCalculations', JSON.stringify(calculations)); },

    // Feature 14: Proxy Voting
    getProxyVotes() {
        try { return JSON.parse(localStorage.getItem('proxyVotes') || '[]'); }
        catch(e) { console.error('Error parsing proxyVotes:', e); return []; }
    },
    saveProxyVotes(proxies) { localStorage.setItem('proxyVotes', JSON.stringify(proxies)); },

    // Feature 15: Decision Reversals
    getDecisionReversals() {
        try { return JSON.parse(localStorage.getItem('decisionReversals') || '[]'); }
        catch(e) { console.error('Error parsing decisionReversals:', e); return []; }
    },
    saveDecisionReversals(reversals) { localStorage.setItem('decisionReversals', JSON.stringify(reversals)); }
};
// Initialize default data on first load
function initDefaults() {
    // Migration from 'birthdays' to 'members' for backward compatibility
    if (localStorage.getItem('birthdays') && !localStorage.getItem('members')) {
        const oldBirthdays = JSON.parse(localStorage.getItem('birthdays') || '[]');
        const newMembers = oldBirthdays.map(b => ({
            id: b.id,
            name: b.name,
            birthday: b.birthday,
            phone: '',
            email: '',
            homegroup: '',
            sponsor: '',
            city: '',
            isServant: false,
            servantPosition: '',
            servantSince: ''
        }));
        storage.saveMembers(newMembers);
        localStorage.removeItem('birthdays'); // Clean up old data
    }

    if (!localStorage.getItem('events')) {
        storage.saveEvents([]);
    }
    if (!localStorage.getItem('members')) {
        storage.saveMembers([]);
    }
    if (!localStorage.getItem('announcements')) {
        storage.saveAnnouncements([]);
    }
    if (!localStorage.getItem('photos')) {
        // We will now store photos as objects with src and tags
        storage.savePhotos([]);
    } else {
        // Backwards compatibility: convert old string array to new object array
        const photos = storage.getPhotos();
        if (photos.length > 0 && typeof photos[0] === 'string') {
            const newPhotos = photos.map(p => ({ src: p, tags: [] }));
            storage.savePhotos(newPhotos);
        }
    }
    if (!localStorage.getItem('chairpersonLog')) {
        storage.saveChairpersonLog([]);
    }
    if (!localStorage.getItem('groupConscienceLog')) {
        storage.saveGroupConscienceLog([]);
    }
    if (!localStorage.getItem('liveGCItems')) {
        storage.saveLiveGCItems([]);
    }
    if (!localStorage.getItem('proposedAgendaItems')) {
        storage.saveProposedAgendaItems([]);
    }
    if (!localStorage.getItem('gcComments')) {
        storage.saveGCComments([]);
    }
    if (!localStorage.getItem('gcActionItems')) {
        storage.saveGCActionItems([]);
    }
    if (!localStorage.getItem('gcSettings')) {
        storage.saveGCSettings({ quorumPercentage: 50, quorumMinimum: 5 });
    }

    // Initialize new High-Impact Features
    if (!localStorage.getItem('votingSettings')) {
        storage.saveVotingSettings({ method: 'substantialUnanimity', threshold: 66.67, allowAbstain: true });
    }
    if (!localStorage.getItem('literatureInventory')) {
        storage.saveLiteratureInventory([]);
    }
    if (!localStorage.getItem('literatureLoans')) {
        storage.saveLiteratureLoans([]);
    }
    if (!localStorage.getItem('serviceElections')) {
        storage.saveServiceElections([]);
    }
    if (!localStorage.getItem('electionBallots')) {
        storage.saveElectionBallots([]);
    }
    if (!localStorage.getItem('speakingQueue')) {
        storage.saveSpeakingQueue([]);
    }
    if (!localStorage.getItem('motionTemplates')) {
        // Initialize with common AA motion templates
        const defaultTemplates = [
            {
                id: genId(),
                name: 'Change 7th Tradition Split',
                template: 'Motion to change our 7th Tradition contribution split to [X]% for group expenses, [Y]% for District, [Z]% for Area, and [W]% for GSO.',
                category: 'Finance'
            },
            {
                id: genId(),
                name: 'Approve Service Position',
                template: 'Motion to approve [Name] as [Service Position] for a term of [Duration].',
                category: 'Service'
            },
            {
                id: genId(),
                name: 'Change Meeting Format',
                template: 'Motion to change the meeting format from [Current Format] to [New Format] effective [Date].',
                category: 'Meeting Format'
            },
            {
                id: genId(),
                name: 'Approve Group Inventory',
                template: 'Motion to conduct a group inventory on [Date] using the [12 Traditions/12 Concepts/Custom] format.',
                category: 'Group Health'
            },
            {
                id: genId(),
                name: 'Purchase Literature',
                template: 'Motion to purchase [Quantity] of [Literature Item] at an estimated cost of $[Amount].',
                category: 'Literature'
            },
            {
                id: genId(),
                name: 'Approve Budget',
                template: 'Motion to approve the proposed annual budget of $[Amount] for fiscal year [Year].',
                category: 'Finance'
            }
        ];
        storage.saveMotionTemplates(defaultTemplates);
    }
    if (!localStorage.getItem('traditionChecks')) {
        storage.saveTraditionChecks([]);
    }
    if (!localStorage.getItem('budgetProposals')) {
        storage.saveBudgetProposals([]);
    }
    if (!localStorage.getItem('districtMotions')) {
        storage.saveDistrictMotions([]);
    }
    if (!localStorage.getItem('groupPositions')) {
        // Initialize common AA service positions
        const defaultPositions = [
            { id: genId(), title: 'General Service Representative (GSR)', term: 24, minSobriety: 12, description: 'Represents the group at District and Area meetings' },
            { id: genId(), title: 'Alternate GSR', term: 24, minSobriety: 6, description: 'Backs up the GSR' },
            { id: genId(), title: 'Treasurer', term: 24, minSobriety: 12, description: 'Manages group finances' },
            { id: genId(), title: 'Secretary', term: 12, minSobriety: 6, description: 'Takes meeting minutes and attendance' },
            { id: genId(), title: 'Chairperson', term: 12, minSobriety: 6, description: 'Chairs the meeting' },
            { id: genId(), title: 'Literature Coordinator', term: 12, minSobriety: 6, description: 'Manages group literature' },
            { id: genId(), title: 'Coffee/Setup Coordinator', term: 6, minSobriety: 3, description: 'Coordinates coffee and setup duties' }
        ];
        storage.saveGroupPositions(defaultPositions);
    }

    // Initialize Enhanced Features
    if (!localStorage.getItem('quorumRules')) {
        const defaultRules = [
            { id: genId(), category: 'General Motions', quorumPercent: 50, quorumMin: 5, description: 'Standard group conscience items' },
            { id: genId(), category: 'Financial Decisions', quorumPercent: 60, quorumMin: 7, description: 'Spending over prudent reserve' },
            { id: genId(), category: 'Major Changes', quorumPercent: 66.67, quorumMin: 10, description: 'Format changes, location moves, etc.' }
        ];
        storage.saveQuorumRules(defaultRules);
    }
    if (!localStorage.getItem('meetingMinutes')) {
        storage.saveMeetingMinutes([]);
    }
    if (!localStorage.getItem('inventorySchedules')) {
        storage.saveInventorySchedules([]);
    }
    if (!localStorage.getItem('decisionImpacts')) {
        storage.saveDecisionImpacts([]);
    }
    if (!localStorage.getItem('participationData')) {
        storage.saveParticipationData({ votes: [], attendance: [] });
    }
    if (!localStorage.getItem('userRole')) {
        storage.saveUserRole('member');
    }
    if (!localStorage.getItem('educationalProgress')) {
        storage.saveEducationalProgress({ completed: [], dismissed: [] });
    }
}
function handleEventSubmit() {
    const editId = document.getElementById('event-edit-id').value;
    if (editId) {
        updateEvent();
    } else {
        addEvent();
    }
}

function editEvent(id) {
    const events = storage.getEvents();
    const eventToEdit = events.find(ev => ev.id === id);
    if (!eventToEdit) {
        console.error('Event not found for editing');
        return;
    }

    // Show the form
    const form = document.getElementById('add-event-form');
    if (form.style.display === 'none') {
        form.style.display = 'block';
    }

    document.getElementById('event-edit-id').value = eventToEdit.id;
    document.getElementById('event-title').value = eventToEdit.title;
    document.getElementById('event-date').value = eventToEdit.date || '';
    document.getElementById('event-day').value = eventToEdit.dayOfWeek !== null ? eventToEdit.dayOfWeek : '';
    document.getElementById('event-time').value = eventToEdit.time;
    document.getElementById('event-category').value = eventToEdit.category || 'General';
    document.getElementById('event-reading').value = eventToEdit.reading || '';
    document.getElementById('event-speaker').value = eventToEdit.speaker || '';
    document.getElementById('event-chair').value = eventToEdit.chair || '';
    document.getElementById('event-description').value = eventToEdit.description || '';

    document.getElementById('event-form-btn').textContent = 'Save Changes';
    document.getElementById('event-form-cancel-btn').style.display = 'inline-block';

    // Scroll to form for better UX
    document.getElementById('schedule-section').scrollIntoView({ behavior: 'smooth' });
}

function cancelEventEdit() {
    document.getElementById('event-edit-id').value = '';
    document.getElementById('event-title').value = '';
    document.getElementById('event-date').value = '';
    document.getElementById('event-day').value = '';
    document.getElementById('event-time').value = '';
    document.getElementById('event-category').value = 'General';
    document.getElementById('event-reading').value = '';
    document.getElementById('event-speaker').value = '';
    document.getElementById('event-chair').value = '';
    document.getElementById('event-description').value = '';

    document.getElementById('event-form-btn').textContent = 'Add Event';
    document.getElementById('event-form-cancel-btn').style.display = 'none';
}

function updateEvent() {
    const id = document.getElementById('event-edit-id').value;
    if (!id) return;

    const title = document.getElementById('event-title').value.trim();
    const dateVal = document.getElementById('event-date').value;
    const dayVal = document.getElementById('event-day').value;
    const time = document.getElementById('event-time').value;
    const category = document.getElementById('event-category').value;
    const reading = document.getElementById('event-reading').value.trim();
    const speaker = document.getElementById('event-speaker').value.trim();
    const chair = document.getElementById('event-chair').value.trim();
    const description = document.getElementById('event-description').value.trim();

    if (!title || !time || (!dateVal && dayVal === '')) {
        showToast('Please provide at least a title, time, and either a date or day of week.', 'error');
        return;
    }

    let events = storage.getEvents();
    const eventIndex = events.findIndex(ev => ev.id === id);

    if (eventIndex > -1) {
        events[eventIndex] = {
            id,
            title,
            date: dateVal || null,
            dayOfWeek: dateVal ? null : parseInt(dayVal, 10),
            time,
            category,
            reading,
            speaker,
            chair,
            description
        };
        storage.saveEvents(events);
        showToast('Event updated successfully!', 'success');
    }

    cancelEventEdit(); // Resets form and buttons
    updateEventsTable();
    updateHome();
    renderCalendar();
}

// Add an event
function addEvent() {
    const title = document.getElementById('event-title').value.trim();
    const dateVal = document.getElementById('event-date').value;
    const dayVal = document.getElementById('event-day').value;
    const time = document.getElementById('event-time').value;
    const category = document.getElementById('event-category').value;
    const reading = document.getElementById('event-reading').value.trim();
    const speaker = document.getElementById('event-speaker').value.trim();
    const chair = document.getElementById('event-chair').value.trim();
    const description = document.getElementById('event-description').value.trim();
    if (!title || !time || (!dateVal && dayVal === '')) {
        showToast('Please provide at least a title, time, and either a date or day of week.', 'error');
        return;
    }
    const events = storage.getEvents();
    events.push({
        id: genId(),
        title,
        date: dateVal || null,
        dayOfWeek: dateVal ? null : parseInt(dayVal, 10),
        time,
        category,
        reading,
        speaker,
        chair,
        description
    });
    storage.saveEvents(events);
    showToast('Event added successfully!', 'success');
    document.getElementById('event-title').value = '';
    document.getElementById('event-date').value = '';
    document.getElementById('event-day').value = '';
    document.getElementById('event-time').value = '';
    document.getElementById('event-reading').value = '';
    document.getElementById('event-speaker').value = '';
    document.getElementById('event-chair').value = '';
    document.getElementById('event-description').value = '';
    updateEventsTable();
    updateHome();
    renderCalendar();
}
// Delete an event by id
function deleteEvent(id) {
    if (!confirm('Delete this event?')) return;
    let events = storage.getEvents();
    events = events.filter(ev => ev.id !== id);
    storage.saveEvents(events);
    showToast('Event deleted.', 'info');
    updateEventsTable();
    updateHome();
    renderCalendar();
}
// Compute upcoming occurrences within next X days
function computeUpcomingOccurrences(daysAhead = 30) {
    const events = storage.getEvents();
    const now = new Date();
    const end = new Date();
    end.setDate(end.getDate() + daysAhead);
    let occurrences = [];
    events.forEach(ev => {
        if (ev.date) {
            const eventDate = new Date(ev.date + 'T' + (ev.time || '00:00'));
            if (eventDate >= now && eventDate <= end) occurrences.push({ occurDate: eventDate, event: ev });
        } else if (ev.dayOfWeek !== null && ev.dayOfWeek !== undefined) {
            for (let d = 0; d <= daysAhead; d++) {
                const date = new Date(now);
                date.setHours(0, 0, 0, 0);
                date.setDate(date.getDate() + d);
                if (date.getDay() === ev.dayOfWeek) {
                    const timeParts = (ev.time || '00:00').split(':');
                    if (timeParts.length >= 2) {
                        const hours = parseInt(timeParts[0], 10) || 0;
                        const minutes = parseInt(timeParts[1], 10) || 0;
                        date.setHours(hours, minutes, 0, 0);
                    }
                    if (date >= now && date <= end) occurrences.push({ occurDate: new Date(date), event: ev });
                }
            }
        }
    });
    occurrences.sort((a, b) => a.occurDate - b.occurDate);
    return occurrences;
}
// Update events table
function updateEventsTable() {
    const tbody = document.getElementById('events-body');
    const categoryFilter = document.getElementById('category-filter').value;
    tbody.innerHTML = '';
    let occ = computeUpcomingOccurrences(60);

    if (categoryFilter !== 'All') {
        occ = occ.filter(item => (item.event.category || 'General') === categoryFilter);
    }

    occ.forEach(item => {
        const tr = document.createElement('tr');
        const dateStr = item.occurDate.toLocaleDateString();
        const timeStr = item.occurDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        tr.innerHTML = `<td>${escapeHtml(dateStr)}</td><td>${escapeHtml(item.event.title)}</td><td>${escapeHtml(item.event.category || 'General')}</td><td>${escapeHtml(timeStr)}</td><td>${escapeHtml(item.event.speaker || '')}</td><td>${escapeHtml(item.event.chair || '')}</td><td><button class="btn" data-action="edit-event" data-id="${escapeAttribute(item.event.id)}" style="margin-right: 5px;">Edit</button><button class="btn secondary" data-action="delete-event" data-id="${escapeAttribute(item.event.id)}">Delete</button></td>`;
        tbody.appendChild(tr);
    });
    if (occ.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="7">No upcoming events match the filter.</td>';
        tbody.appendChild(tr);
    }
}
function handleMemberSubmit() {
    const editId = document.getElementById('member-edit-id').value;
    if (editId) {
        updateMember();
    } else {
        addMember();
    }
}

function editMember(id) {
    const members = storage.getMembers();
    const memberToEdit = members.find(m => m.id === id);
    if (!memberToEdit) {
        console.error('Member not found for editing');
        return;
    }

    // Show the form
    const form = document.getElementById('add-member-form');
    if (form.style.display === 'none') {
        form.style.display = 'block';
    }

    document.getElementById('member-edit-id').value = memberToEdit.id;
    document.getElementById('member-name').value = memberToEdit.name;
    document.getElementById('member-birthday').value = memberToEdit.birthday;
    document.getElementById('member-phone').value = memberToEdit.phone || '';
    document.getElementById('member-email').value = memberToEdit.email || '';
    document.getElementById('member-homegroup').value = memberToEdit.homegroup || '';
    document.getElementById('member-sponsor').value = memberToEdit.sponsor || '';
    document.getElementById('member-city').value = memberToEdit.city || '';
    document.getElementById('member-is-servant').checked = memberToEdit.isServant || false;
    document.getElementById('member-servant-position').value = memberToEdit.servantPosition || '';
    document.getElementById('member-servant-since').value = memberToEdit.servantSince || '';

    document.getElementById('member-form-btn').textContent = 'Save Changes';
    document.getElementById('member-form-cancel-btn').style.display = 'inline-block';

    document.getElementById('birthdays-section').scrollIntoView({ behavior: 'smooth' });
}

function cancelMemberEdit() {
    document.getElementById('member-edit-id').value = '';
    document.getElementById('member-name').value = '';
    document.getElementById('member-birthday').value = '';
    document.getElementById('member-phone').value = '';
    document.getElementById('member-email').value = '';
    document.getElementById('member-homegroup').value = '';
    document.getElementById('member-sponsor').value = '';
    document.getElementById('member-city').value = '';
    document.getElementById('member-is-servant').checked = false;
    document.getElementById('member-servant-position').value = '';
    document.getElementById('member-servant-since').value = '';


    document.getElementById('member-form-btn').textContent = 'Add Member';
    document.getElementById('member-form-cancel-btn').style.display = 'none';
}

function updateMember() {
    const id = document.getElementById('member-edit-id').value;
    if (!id) return;

    const name = document.getElementById('member-name').value.trim();
    const bdate = document.getElementById('member-birthday').value;
    const email = document.getElementById('member-email').value.trim();
    const phone = document.getElementById('member-phone').value.trim();

    if (!name || !bdate) {
        showToast('Please provide both name and sobriety date.', 'error');
        return;
    }

    if (!validateEmail(email)) {
        showToast('Please enter a valid email address (e.g., user@example.com).', 'error');
        return;
    }

    if (!validatePhone(phone)) {
        showToast('Please enter a valid phone number with at least 10 digits.', 'error');
        return;
    }

    let members = storage.getMembers();
    const memberIndex = members.findIndex(m => m.id === id);

    if (memberIndex > -1) {
        members[memberIndex] = {
            id,
            name,
            birthday: bdate,
            phone: phone,
            email: email,
            homegroup: document.getElementById('member-homegroup').value.trim(),
            sponsor: document.getElementById('member-sponsor').value.trim(),
            city: document.getElementById('member-city').value.trim(),
            isServant: document.getElementById('member-is-servant').checked,
            servantPosition: document.getElementById('member-servant-position').value.trim(),
            servantSince: document.getElementById('member-servant-since').value
        };
        storage.saveMembers(members);
        showToast('Member updated successfully!', 'success');
    }

    cancelMemberEdit(); // Resets form and buttons
    updateBirthdaysTable();
    updateHome();
    populateAttendeeDropdown();
    populateMemberDropdowns();
    renderServantReportInputs();
}

// Add member
function addMember() {
    const name = document.getElementById('member-name').value.trim();
    const bdate = document.getElementById('member-birthday').value;
    const email = document.getElementById('member-email').value.trim();
    const phone = document.getElementById('member-phone').value.trim();

    if (!name || !bdate) {
        showToast('Please provide both name and sobriety date.', 'error');
        return;
    }

    if (!validateEmail(email)) {
        showToast('Please enter a valid email address (e.g., user@example.com).', 'error');
        return;
    }

    if (!validatePhone(phone)) {
        showToast('Please enter a valid phone number with at least 10 digits.', 'error');
        return;
    }

    // Quick Win #8: Check for duplicate members
    const newMember = {
        id: genId(),
        name,
        birthday: bdate,
        phone: phone,
        email: email,
        homegroup: document.getElementById('member-homegroup').value.trim(),
        sponsor: document.getElementById('member-sponsor').value.trim(),
        city: document.getElementById('member-city').value.trim(),
        isServant: document.getElementById('member-is-servant').checked,
        servantPosition: document.getElementById('member-servant-position').value.trim(),
        servantSince: document.getElementById('member-servant-since').value
    };

    const duplicates = checkForDuplicateMembers(newMember);

    if (duplicates.length > 0) {
        const topMatch = duplicates[0];
        const confirmMsg = `⚠️ Possible duplicate member detected!\n\n` +
            `Existing member: ${topMatch.member.name}\n` +
            `Match confidence: ${topMatch.score}%\n` +
            `Reasons: ${topMatch.reasons.join(', ')}\n\n` +
            `Do you want to add this member anyway?`;

        if (!confirm(confirmMsg)) {
            return; // User cancelled
        }
    }

    const members = storage.getMembers();
    members.push(newMember);
    storage.saveMembers(members);
    showToast('Member added successfully!', 'success');
    cancelMemberEdit();
    updateBirthdaysTable();
    updateHome();
    populateAttendeeDropdown();
    populateMemberDropdowns();
    renderServantReportInputs();
}
// Delete member
function deleteMember(id) {
    if (!confirm('Delete this member?')) return;
    let members = storage.getMembers();
    members = members.filter(m => m.id !== id);
    storage.saveMembers(members);
    showToast('Member deleted.', 'info');
    updateBirthdaysTable();
    updateHome();
    populateAttendeeDropdown();
    populateMemberDropdowns();
    renderServantReportInputs();
}

// Helper to find all anniversaries within a given date window
function getAnniversariesInWindow(members, pastDays, futureDays) {
    const now = new Date();
    now.setHours(0,0,0,0);

    const lowerBound = new Date(now);
    lowerBound.setDate(lowerBound.getDate() - pastDays);

    const upperBound = new Date(now);
    upperBound.setDate(upperBound.getDate() + futureDays);

    const relevantMembers = [];

    members.forEach(member => {
        if (!member.birthday) return; // Skip members with no birthday
        const parts = member.birthday.split('-');
        if (parts.length < 3) return; // Invalid date format
        const [origYear, month, day] = parts.map(Number);
        if (isNaN(month) || isNaN(day)) return; // Invalid numbers

        // Check anniversary for the current year
        const thisYearAnniversary = new Date(now.getFullYear(), month - 1, day);
        if (thisYearAnniversary >= lowerBound && thisYearAnniversary <= upperBound) {
            relevantMembers.push({ ...member, displayDate: thisYearAnniversary });
            return; // Move to next member, avoid duplicates
        }

        // Check anniversary for last year (for pastDays window)
        if (now.getFullYear() > origYear) {
             const lastYearAnniversary = new Date(now.getFullYear() - 1, month - 1, day);
             if (lastYearAnniversary >= lowerBound && lastYearAnniversary <= upperBound) {
                relevantMembers.push({ ...member, displayDate: lastYearAnniversary });
                return;
             }
        }

        // Check anniversary for next year (for futureDays window)
        const nextYearAnniversary = new Date(now.getFullYear() + 1, month - 1, day);
        if (nextYearAnniversary >= lowerBound && nextYearAnniversary <= upperBound) {
            relevantMembers.push({ ...member, displayDate: nextYearAnniversary });
        }
    });

    return relevantMembers.sort((a, b) => a.displayDate - b.displayDate);
}

// Calculate sober time
function calculateSoberTime(bdayStr) {
    if (!bdayStr) return { years: 0, months: 0, days: 0 };
    const soberDate = new Date(bdayStr);
    const now = new Date();

    let years = now.getFullYear() - soberDate.getFullYear();
    let months = now.getMonth() - soberDate.getMonth();
    let days = now.getDate() - soberDate.getDate();

    if (days < 0) {
        months--;
        const lastMonth = new Date(now.getFullYear(), now.getMonth(), 0);
        days += lastMonth.getDate();
    }

    if (months < 0) {
        years--;
        months += 12;
    }

    return { years, months, days };
}

// Compute next birthday date relative to now
function nextBirthdayDate(bdayStr) {
    const now = new Date();
    const parts = bdayStr.split('-');
    if (parts.length < 3) return null; // Invalid format
    const [year, month, day] = parts.map(Number);
    if (isNaN(year) || isNaN(month) || isNaN(day)) return null; // Invalid numbers
    const today = new Date(now);
    today.setHours(0, 0, 0, 0);
    let nextDate = new Date(today.getFullYear(), month - 1, day);
    if (nextDate < today) {
        nextDate = new Date(today.getFullYear() + 1, month - 1, day);
    }
    return nextDate;
}
// Update birthdays table
function updateBirthdaysTable() {
    const tbody = document.getElementById('birthdays-body');
    tbody.innerHTML = '';
    const members = storage.getMembers();
    const membersInWindow = getAnniversariesInWindow(members, 15, 60);

    const now = new Date();
    now.setHours(0,0,0,0);

    membersInWindow.forEach(m => {
        const tr = document.createElement('tr');

        // Highlight past birthdays in a muted yellow/gold color
        if (m.displayDate < now) {
            tr.style.backgroundColor = '#6b5d2f';
        }

        const displayDateStr = m.displayDate.toLocaleDateString();
        const origDate = new Date(m.birthday);
        const md = origDate.toLocaleDateString(undefined, { month: 'long', day: 'numeric', year: 'numeric' });

        // Calculate years of sobriety based on the anniversary date
        const years = m.displayDate.getFullYear() - origDate.getFullYear();
        const soberTime = calculateSoberTime(m.birthday);
        const soberTimeStr = `${soberTime.years}y ${soberTime.months}m ${soberTime.days}d`;

        tr.innerHTML = `
            <td>${escapeHtml(m.name)}</td>
            <td>${escapeHtml(md)}</td>
            <td>${escapeHtml(displayDateStr)}</td>
            <td>${escapeHtml(String(years))}</td>
            <td>${escapeHtml(soberTimeStr)}</td>
            <td>
                <button class="btn" data-action="edit-member" data-id="${escapeAttribute(m.id)}" style="margin-right: 5px;">Edit</button>
                <button class="btn secondary" data-action="delete-member" data-id="${escapeAttribute(m.id)}">Delete</button>
            </td>`;
        tbody.appendChild(tr);
    });
    if (membersInWindow.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="6">No recent or upcoming birthdays in the next 60 days.</td>';
        tbody.appendChild(tr);
    }
}
// Add announcement
function addAnnouncement() {
    const text = document.getElementById('announcement-text').value.trim();
    if (!text) {
        showToast('Enter an announcement.', 'error');
        return;
    }
    const priority = document.getElementById('announcement-priority').value;
    const requireReadReceipt = document.getElementById('announcement-require-read-receipt').checked;

    const ann = storage.getAnnouncements();
    ann.unshift({
        id: genId(),
        text,
        dateCreated: new Date().toISOString(),
        active: true,
        priority: priority,
        requireReadReceipt: requireReadReceipt,
        readBy: []
    });
    storage.saveAnnouncements(ann);
    showToast('Announcement added!', 'success');
    document.getElementById('announcement-text').value = '';
    document.getElementById('announcement-priority').value = 'info';
    document.getElementById('announcement-require-read-receipt').checked = false;
    updateAnnouncementsList();
    updateHome();
    updateChairpersonAnnouncements();
}
// Delete announcement
function deleteAnnouncement(id) {
    if (!confirm('Delete this announcement?')) return;
    let ann = storage.getAnnouncements();
    ann = ann.filter(a => a.id !== id);
    storage.saveAnnouncements(ann);
    showToast('Announcement deleted.', 'info');
    updateAnnouncementsList();
    updateHome();
    updateChairpersonAnnouncements();
}
// Toggle announcement active state
function toggleAnnouncementActive(id) {
    let ann = storage.getAnnouncements();
    const index = ann.findIndex(a => a.id === id);
    if (index > -1) {
        ann[index].active = !ann[index].active;
        storage.saveAnnouncements(ann);
        updateAnnouncementsList();
        updateHome();
        updateChairpersonAnnouncements();
    }
}

// Update announcements list
function updateAnnouncementsList() {
    const ul = document.getElementById('announcements-list');
    ul.innerHTML = '';
    const ann = storage.getAnnouncements();
    const currentUser = storage.getCurrentUser();

    ann.forEach(a => {
        const li = document.createElement('div');
        li.className = `announcement-item ${a.priority || 'info'}`;
        if (!a.active) {
            li.style.opacity = '0.5';
        }

        const dateStr = new Date(a.dateCreated).toLocaleDateString();

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = a.active;
        checkbox.style.marginRight = '1rem';
        checkbox.onchange = () => toggleAnnouncementActive(a.id);

        const priorityBadge = document.createElement('span');
        priorityBadge.className = `priority-badge ${a.priority || 'info'}`;
        priorityBadge.textContent = (a.priority || 'info').toUpperCase();

        const text = document.createElement('span');
        text.innerHTML = `<strong>${dateStr}:</strong> ${escapeHtml(a.text)}`;
        text.style.flexGrow = '1';

        const topRow = document.createElement('div');
        topRow.style.display = 'flex';
        topRow.style.alignItems = 'center';
        topRow.style.marginBottom = '8px';
        topRow.appendChild(checkbox);
        topRow.appendChild(text);
        topRow.appendChild(priorityBadge);

        li.appendChild(topRow);

        // Read receipt handling
        if (a.requireReadReceipt) {
            const readBy = a.readBy || [];
            const hasRead = readBy.includes(currentUser);

            const readInfo = document.createElement('div');
            readInfo.className = 'read-receipt-indicator';
            readInfo.innerHTML = `<i class="fas fa-check-circle"></i> Read by ${readBy.length} member(s)`;

            li.appendChild(readInfo);

            if (!hasRead) {
                const markReadBtn = document.createElement('button');
                markReadBtn.className = 'btn mark-as-read-btn';
                markReadBtn.textContent = 'Mark as Read';
                markReadBtn.onclick = () => markAnnouncementAsRead(a.id);
                li.appendChild(markReadBtn);
            }
        }

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn secondary';
        deleteBtn.style.marginTop = '8px';
        deleteBtn.textContent = 'Delete';
        deleteBtn.onclick = () => deleteAnnouncement(a.id);

        li.appendChild(deleteBtn);
        ul.appendChild(li);
    });
    if (ann.length === 0) {
        ul.innerHTML = '<li>No announcements posted</li>';
    }
}

function updateChairpersonAnnouncements() {
    const ul = document.getElementById('chairperson-announcements-list');
    if (!ul) return;
    ul.innerHTML = '';
    const activeAnnouncements = storage.getAnnouncements().filter(a => a.active);
    activeAnnouncements.forEach(a => {
        const li = document.createElement('li');
        const dateStr = new Date(a.dateCreated).toLocaleDateString();
        li.innerHTML = `<strong>${dateStr}:</strong> ${escapeHtml(a.text)}`;
        ul.appendChild(li);
    });
    if (activeAnnouncements.length === 0) {
        ul.innerHTML = '<li>No active announcements</li>';
    }
}
// Modal functions
let currentPhotoIndex = 0;
let currentPhotoList = [];

function updateModalContent() {
    const photo = currentPhotoList[currentPhotoIndex];
    if (!photo) { closeModal(); return; }

    const modalImg = document.getElementById('modal-image');
    const caption = document.getElementById('modal-caption');

    modalImg.src = photo.src;
    caption.textContent = photo.tags && photo.tags.length > 0 ? `Tags: ${photo.tags.join(', ')}` : '';
}

function showNextPhoto() {
    if (currentPhotoList.length === 0) return;
    currentPhotoIndex = (currentPhotoIndex + 1) % currentPhotoList.length;
    updateModalContent();
}

function showPreviousPhoto() {
    if (currentPhotoList.length === 0) return;
    currentPhotoIndex = (currentPhotoIndex - 1 + currentPhotoList.length) % currentPhotoList.length;
    updateModalContent();
}

function handleModalKeys(event) {
    if (event.key === 'Escape') {
        closeModal();
    } else if (event.key === 'ArrowRight') {
        showNextPhoto();
    } else if (event.key === 'ArrowLeft') {
        showPreviousPhoto();
    }
}

function openModal(index, photos) {
    currentPhotoList = photos;
    currentPhotoIndex = index;

    if (currentPhotoList.length === 0) return;

    const modal = document.getElementById('photo-modal');
    if (modal) {
        modal.style.display = "flex";
        document.body.style.overflow = 'hidden'; // Prevent background scrolling
        updateModalContent();
        document.addEventListener('keydown', handleModalKeys);
    }
}

function closeModal() {
    const modal = document.getElementById('photo-modal');
    if (modal) {
        modal.style.display = "none";
        document.body.style.overflow = ''; // Restore scrolling
        document.removeEventListener('keydown', handleModalKeys);
    }
}
// Photo uploading
function uploadPhotos() {
    const input = document.getElementById('photo-upload');
    const tagsInput = document.getElementById('photo-tags');
    const files = Array.from(input.files);
    if (!files || files.length === 0) {
        showToast('Select one or more images to upload.', 'error');
        return;
    }

    // Check storage quota before uploading
    if (!checkLocalStorageQuota()) {
        showToast('Cannot upload photos: storage quota warning. Please free up space.', 'error');
        return;
    }

    const tags = tagsInput.value.split(',').map(tag => tag.trim()).filter(tag => tag);
    const photos = storage.getPhotos();
    let remaining = files.length;
    files.forEach(file => {
        const reader = new FileReader();
        reader.onload = function (e) {
            photos.push({ src: e.target.result, tags: tags });
            remaining--;
            if (remaining === 0) {
                try {
                    storage.savePhotos(photos);
                    showToast(`${files.length} photo(s) uploaded!`, 'success');
                    input.value = '';
                    tagsInput.value = '';
                    updateGallery();
                    updateHome();
                } catch (err) {
                    showToast('Failed to save photos: ' + err.message, 'error');
                }
            }
        };
        reader.readAsDataURL(file);
    });
}
// Delete photo by index
function deletePhoto(index) {
    if (!confirm('Delete this photo?')) return;
    const photos = storage.getPhotos();
    photos.splice(index, 1);
    storage.savePhotos(photos);
    showToast('Photo deleted.', 'info');
    updateGallery();
    updateHome();
}

// Chairperson's Corner functions
function handleChairpersonLogSubmit() {
    const editId = document.getElementById('log-edit-id').value;
    if (editId) {
        updateChairpersonLog(editId);
    } else {
        addChairpersonLog();
    }
}

function addChairpersonLog() {
    const date = document.getElementById('log-date').value;
    const time = document.getElementById('log-time').value;
    const chairperson = document.getElementById('log-chairperson').value.trim();
    const headcount = document.getElementById('log-headcount').value;
    const tradition = document.getElementById('log-7th-tradition').value;
    const orangeCan = document.getElementById('log-orange-can').value;

    if (!date) {
        showToast('Please select a date.', 'error');
        return;
    }

    const log = storage.getChairpersonLog();
    log.push({
        id: genId(),
        date,
        time,
        chairperson,
        headcount: parseInt(headcount) || 0,
        tradition: parseFloat(tradition) || 0,
        orangeCan: parseFloat(orangeCan) || 0,
    });
    storage.saveChairpersonLog(log);
    showToast('Log entry added.', 'success');
    updateChairpersonLogTable();
    document.getElementById('log-date').value = '';
    document.getElementById('log-time').value = '';
    document.getElementById('log-chairperson').value = '';
    document.getElementById('log-headcount').value = '';
    document.getElementById('log-7th-tradition').value = '';
    document.getElementById('log-orange-can').value = '';
}

function updateChairpersonLogTable() {
    const tbody = document.getElementById('chairperson-log-body');
    tbody.innerHTML = '';
    const log = storage.getChairpersonLog().sort((a, b) => new Date(b.date) - new Date(a.date));

    // Update the table header
    const thead = document.getElementById('chairperson-log-table').querySelector('thead');
    thead.innerHTML = `
        <tr>
            <th>Date</th>
            <th>Time</th>
            <th>Chairperson</th>
            <th>Head Count</th>
            <th>7th Tradition</th>
            <th>Orange Can</th>
            <th>Actions</th>
        </tr>
    `;

    log.forEach(entry => {
        const tr = document.createElement('tr');
        const timeStr = entry.time ? new Date('1970-01-01T' + entry.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'N/A';
        tr.innerHTML = `
            <td>${escapeHtml(new Date(entry.date).toLocaleDateString())}</td>
            <td>${escapeHtml(timeStr)}</td>
            <td>${escapeHtml(entry.chairperson || 'N/A')}</td>
            <td>${escapeHtml(String(entry.headcount))}</td>
            <td>$${escapeHtml(entry.tradition.toFixed(2))}</td>
            <td>$${escapeHtml(entry.orangeCan.toFixed(2))}</td>
            <td>
                <button class="btn" data-action="edit-chairperson" data-id="${escapeAttribute(entry.id)}" style="margin-right: 5px;">Edit</button>
                <button class="btn secondary" data-action="delete-chairperson" data-id="${escapeAttribute(entry.id)}">Delete</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function editChairpersonLog(id) {
    const log = storage.getChairpersonLog();
    const entry = log.find(e => e.id === id);
    if (!entry) return;

    document.getElementById('log-edit-id').value = entry.id;
    document.getElementById('log-date').value = entry.date;
    document.getElementById('log-time').value = entry.time;
    document.getElementById('log-chairperson').value = entry.chairperson;
    document.getElementById('log-headcount').value = entry.headcount;
    document.getElementById('log-7th-tradition').value = entry.tradition;
    document.getElementById('log-orange-can').value = entry.orangeCan;

    document.getElementById('chairperson-form-title').textContent = 'Edit Log Entry';
    document.getElementById('log-form-btn').textContent = 'Save Changes';
    document.getElementById('log-form-cancel-btn').style.display = 'inline-block';
}

function updateChairpersonLog(id) {
    const log = storage.getChairpersonLog();
    const index = log.findIndex(e => e.id === id);
    if (index === -1) return;

    const date = document.getElementById('log-date').value;
    const time = document.getElementById('log-time').value;
    const chairperson = document.getElementById('log-chairperson').value.trim();
    const headcount = document.getElementById('log-headcount').value;
    const tradition = document.getElementById('log-7th-tradition').value;
    const orangeCan = document.getElementById('log-orange-can').value;

    if (!date) {
        showToast('Please select a date.', 'error');
        return;
    }

    log[index] = {
        id,
        date,
        time,
        chairperson,
        headcount: parseInt(headcount) || 0,
        tradition: parseFloat(tradition) || 0,
        orangeCan: parseFloat(orangeCan) || 0,
    };

    storage.saveChairpersonLog(log);
    showToast('Log entry updated.', 'success');
    cancelLogEdit();
    updateChairpersonLogTable();
}

function cancelLogEdit() {
    document.getElementById('log-edit-id').value = '';
    document.getElementById('log-date').value = '';
    document.getElementById('log-time').value = '';
    document.getElementById('log-chairperson').value = '';
    document.getElementById('log-headcount').value = '';
    document.getElementById('log-7th-tradition').value = '';
    document.getElementById('log-orange-can').value = '';

    document.getElementById('chairperson-form-title').textContent = 'Log New Entry';
    document.getElementById('log-form-btn').textContent = 'Add Log Entry';
    document.getElementById('log-form-cancel-btn').style.display = 'none';
}

function deleteChairpersonLog(id) {
    if (!confirm('Delete this log entry?')) return;
    let log = storage.getChairpersonLog();
    log = log.filter(e => e.id !== id);
    storage.saveChairpersonLog(log);
    showToast('Log entry deleted.', 'info');
    updateChairpersonLogTable();
}

// Group Conscience Log Functions

// ========== P0-1: ENHANCED INFORMED GROUP CONSCIENCE ==========

// Toggle visibility of workflow sections based on status
function toggleGCWorkflowSections() {
    const status = document.getElementById('gc-workflow-status')?.value || 'decided';
    const researchSection = document.getElementById('gc-research-period-section');
    const votingSection = document.getElementById('gc-voting-section');

    // Show research period fields for research and voting stages
    if (researchSection) {
        researchSection.style.display = (status === 'research' || status === 'voting') ? 'block' : 'none';
    }

    // Show voting fields only for decided status
    if (votingSection) {
        const voteFields = ['gc-votes-for', 'gc-votes-against', 'gc-votes-abstain', 'gc-attendees'];
        const shouldShow = (status === 'decided');
        voteFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.closest('.form-group').style.display = shouldShow ? 'block' : 'none';
            }
        });
    }
}

// Get current user name from storage
function getCurrentUserName() {
    return localStorage.getItem('currentUser') || 'Anonymous';
}

// Add question to a GC motion during research period
function addGCQuestion(gcId) {
    const questionText = prompt('Enter your question about this motion:');
    if (!questionText || !questionText.trim()) return;

    const logs = storage.getGroupConscienceLog();
    const log = logs.find(l => l.id === gcId);

    if (!log) {
        showToast('Motion not found', 'error');
        return;
    }

    // Check if in research period
    const today = new Date().toISOString().split('T')[0];
    if (log.workflowStatus !== 'research' && log.workflowStatus !== 'draft') {
        showToast('Research period has ended for this motion', 'error');
        return;
    }

    if (!log.questions) log.questions = [];

    const question = {
        id: genId(),
        memberId: getCurrentUserName(), // In production, use actual member ID
        memberName: getCurrentUserName(),
        question: questionText.trim(),
        answer: null,
        answeredBy: null,
        answeredDate: null,
        askedDate: new Date().toISOString()
    };

    log.questions.push(question);
    storage.saveGroupConscienceLog(logs);
    showToast('Question submitted successfully', 'success');

    // Refresh display
    if (typeof viewGCDetailsModal === 'function') {
        openGCDetailsModal(gcId);
    }
}

// Answer a question on a GC motion
function answerGCQuestion(gcId, questionId) {
    const answerText = prompt('Enter your answer:');
    if (!answerText || !answerText.trim()) return;

    const logs = storage.getGroupConscienceLog();
    const log = logs.find(l => l.id === gcId);

    if (!log || !log.questions) {
        showToast('Question not found', 'error');
        return;
    }

    const question = log.questions.find(q => q.id === questionId);
    if (!question) {
        showToast('Question not found', 'error');
        return;
    }

    question.answer = answerText.trim();
    question.answeredBy = getCurrentUserName();
    question.answeredDate = new Date().toISOString();

    storage.saveGroupConscienceLog(logs);
    showToast('Answer posted successfully', 'success');

    // Refresh display
    if (typeof openGCDetailsModal === 'function') {
        openGCDetailsModal(gcId);
    }
}

// Mark motion as reviewed by current user
function markGCReviewed(gcId) {
    const logs = storage.getGroupConscienceLog();
    const log = logs.find(l => l.id === gcId);

    if (!log) {
        showToast('Motion not found', 'error');
        return;
    }

    if (!log.reviewedBy) log.reviewedBy = [];

    const userId = getCurrentUserName();
    if (!log.reviewedBy.includes(userId)) {
        log.reviewedBy.push(userId);
        storage.saveGroupConscienceLog(logs);
        showToast('Marked as reviewed. Thank you for staying informed!', 'success');

        // Refresh display
        if (typeof openGCDetailsModal === 'function') {
            openGCDetailsModal(gcId);
        }
    } else {
        showToast('You have already reviewed this motion', 'info');
    }
}

// Calculate review completion percentage
function getReviewCompletionPercentage(log) {
    if (!log.reviewedBy || log.reviewedBy.length === 0) return 0;

    const members = storage.getMembers();
    if (members.length === 0) return 0;

    return Math.round((log.reviewedBy.length / members.length) * 100);
}

// Check if research period is active
function isResearchPeriodActive(log) {
    if (!log.researchPeriodStart || !log.researchPeriodEnd) return false;

    const today = new Date().toISOString().split('T')[0];
    return today >= log.researchPeriodStart && today <= log.researchPeriodEnd;
}

// Get days remaining in research period
function getDaysRemainingInResearch(log) {
    if (!log.researchPeriodEnd) return null;

    const today = new Date();
    const endDate = new Date(log.researchPeriodEnd);
    const diffTime = endDate - today;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

    return diffDays;
}

// ========== P0-2: MINORITY OPINION PROTECTION ==========

// Prompt for minority opinion if significant dissent
function promptMinorityOpinion(gcId) {
    const logs = storage.getGroupConscienceLog();
    const log = logs.find(l => l.id === gcId);

    if (!log) return;

    // Check if minority percentage >= 33%
    if (log.minorityPercentage < 33) {
        return; // No need for minority opinion
    }

    const shouldRecord = confirm(
        `This motion passed with ${log.minorityPercentage.toFixed(1)}% voting against.\n\n` +
        `In the spirit of unity and informed group conscience, would members of the minority ` +
        `like to record their concerns for the group's consideration?`
    );

    if (!shouldRecord) return;

    const opinionText = prompt(
        'Please share the minority viewpoint:\n\n' +
        '(This will be attached to the motion for the group to consider)'
    );

    if (!opinionText || !opinionText.trim()) return;

    log.minorityOpinion = {
        text: opinionText.trim(),
        submittedBy: getCurrentUserName(),
        submittedDate: new Date().toISOString(),
        signatories: [getCurrentUserName()]
    };

    storage.saveGroupConscienceLog(logs);
    showToast('Minority opinion recorded. The group will revisit this in 6 months.', 'success');

    // Refresh display
    if (typeof openGCDetailsModal === 'function') {
        openGCDetailsModal(gcId);
    }
}

// Add signatory to minority opinion
function signMinorityOpinion(gcId) {
    const logs = storage.getGroupConscienceLog();
    const log = logs.find(l => l.id === gcId);

    if (!log || !log.minorityOpinion) {
        showToast('No minority opinion exists for this motion', 'error');
        return;
    }

    const userName = getCurrentUserName();
    if (!log.minorityOpinion.signatories) {
        log.minorityOpinion.signatories = [];
    }

    if (!log.minorityOpinion.signatories.includes(userName)) {
        log.minorityOpinion.signatories.push(userName);
        storage.saveGroupConscienceLog(logs);
        showToast('Your support for this viewpoint has been recorded', 'success');

        // Refresh display
        if (typeof openGCDetailsModal === 'function') {
            openGCDetailsModal(gcId);
        }
    } else {
        showToast('You have already signed this opinion', 'info');
    }
}

// ========== END P0 ENHANCEMENTS ==========

function handleGCLogSubmit() {
    const editId = document.getElementById('gc-edit-id').value;
    if (editId) {
        updateGCLog(editId);
    } else {
        addGCLog();
    }
}

function addGCLog() {
    const servantReportInputs = document.querySelectorAll('.servant-report-input');
    const servantReports = [];
    servantReportInputs.forEach(input => {
        if (input.value.trim() !== '') {
            servantReports.push({
                servantId: input.dataset.servantId,
                servantName: input.dataset.servantName,
                report: input.value.trim()
            });
        }
    });

    const votesFor = parseInt(document.getElementById('gc-votes-for')?.value || 0);
    const votesAgainst = parseInt(document.getElementById('gc-votes-against')?.value || 0);
    const votesAbstain = parseInt(document.getElementById('gc-votes-abstain')?.value || 0);

    // Enhanced data structure for informed group conscience
    const log = {
        id: genId(),
        date: document.getElementById('gc-date').value,
        item: document.getElementById('gc-item').value.trim(),
        submittedBy: document.getElementById('gc-submitted-by').value.trim(),
        status: document.getElementById('gc-status').value,
        votesFor,
        votesAgainst,
        votesAbstain,
        attendees: Array.from(document.getElementById('gc-attendees').selectedOptions).map(opt => opt.value),
        servantReports: servantReports,

        // P0-1: Enhanced Informed Group Conscience fields
        workflowStatus: document.getElementById('gc-workflow-status')?.value || 'decided', // draft, research, voting, decided
        researchPeriodStart: document.getElementById('gc-research-start')?.value || null,
        researchPeriodEnd: document.getElementById('gc-research-end')?.value || null,
        questions: [], // Array of {id, memberId, memberName, question, answer, answeredBy, answeredDate}
        reviewedBy: [], // Array of member IDs who reviewed materials
        createdDate: new Date().toISOString(),

        // P0-2: Minority Opinion Protection (structure ready)
        minorityOpinion: null, // {text, submittedBy, submittedDate, signatories[]}
        minorityPercentage: 0, // Calculated from votes
        requiresFollowUp: false, // Auto-set if minority >= 33%
        followUpDate: null, // 6 months from decision if significant dissent
    };

    if (!log.date || !log.item) {
        showToast('Please provide at least a date and an item/motion.', 'error');
        return;
    }

    // Calculate minority percentage if votes exist
    const totalVotes = votesFor + votesAgainst + votesAbstain;
    if (totalVotes > 0) {
        const minority = Math.max(votesFor, votesAgainst); // Higher of for/against
        const majority = Math.min(votesFor, votesAgainst);
        log.minorityPercentage = totalVotes > 0 ? ((minority > majority ? votesAgainst : votesFor) / totalVotes * 100) : 0;

        // Check if requires follow-up (minority >= 33%)
        if (log.minorityPercentage >= 33 && log.status === 'passed') {
            log.requiresFollowUp = true;
            const followUp = new Date(log.date);
            followUp.setMonth(followUp.getMonth() + 6);
            log.followUpDate = followUp.toISOString().split('T')[0];
        }
    }

    const logs = storage.getGroupConscienceLog();
    logs.push(log);
    storage.saveGroupConscienceLog(logs);
    showToast('Group Conscience entry added.', 'success');
    updateGCLogTable();
    cancelGCEdit(); // Clear form
}

function updateGCLogTable() {
    const currentTbody = document.getElementById('gc-log-body-current');
    const previousTbody = document.getElementById('gc-log-body-previous');
    currentTbody.innerHTML = '';
    previousTbody.innerHTML = '';

    const logs = storage.getGroupConscienceLog().sort((a, b) => new Date(b.date) - new Date(a.date));
    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();

    logs.forEach(log => {
        const logDate = new Date(log.date);
        const logMonth = logDate.getMonth();
        const logYear = logDate.getFullYear();

        const isCurrentMonth = logMonth === currentMonth && logYear === currentYear;
        const tbody = isCurrentMonth ? currentTbody : previousTbody;

        const votesFor = log.votesFor || 0;
        const votesAgainst = log.votesAgainst || 0;
        const votesAbstain = log.votesAbstain || 0;
        const votesDisplay = (votesFor || votesAgainst || votesAbstain)
            ? `${votesFor}-${votesAgainst}-${votesAbstain}`
            : (log.votes || 'N/A');

        // P0-1: Workflow status badge
        const workflowStatus = log.workflowStatus || 'decided';
        const statusBadges = {
            'draft': '<span style="background: #95a5a6; padding: 2px 8px; border-radius: 3px; font-size: 0.75rem; margin-left: 5px;">DRAFT</span>',
            'research': '<span style="background: #3498db; padding: 2px 8px; border-radius: 3px; font-size: 0.75rem; margin-left: 5px;">RESEARCH</span>',
            'voting': '<span style="background: #f39c12; padding: 2px 8px; border-radius: 3px; font-size: 0.75rem; margin-left: 5px;">VOTING</span>',
            'decided': ''
        };

        // P0-1: Research period indicator
        let researchInfo = '';
        if (log.researchPeriodEnd && isResearchPeriodActive(log)) {
            const daysLeft = getDaysRemainingInResearch(log);
            researchInfo = `<br><small style="color: #3498db;">Research ends in ${daysLeft} day${daysLeft !== 1 ? 's' : ''}</small>`;
        }

        // P0-1: Review completion percentage
        let reviewBadge = '';
        if (workflowStatus === 'research' || workflowStatus === 'voting') {
            const reviewPct = getReviewCompletionPercentage(log);
            const reviewColor = reviewPct >= 75 ? '#2ecc71' : reviewPct >= 50 ? '#f39c12' : '#e74c3c';
            reviewBadge = `<br><small style="color: ${reviewColor};">${reviewPct}% reviewed</small>`;
        }

        // P0-2: Minority opinion indicator
        let minorityBadge = '';
        if (log.minorityOpinion) {
            const sigCount = log.minorityOpinion.signatories ? log.minorityOpinion.signatories.length : 0;
            minorityBadge = `<br><small style="color: #e67e22;"><i class="fas fa-comment-alt"></i> Minority opinion (${sigCount} signatories)</small>`;
        } else if (log.requiresFollowUp && log.followUpDate) {
            minorityBadge = `<br><small style="color: #f39c12;"><i class="fas fa-clock"></i> Follow-up: ${log.followUpDate}</small>`;
        }

        // P0-1: Q&A indicator
        let qaInfo = '';
        if (log.questions && log.questions.length > 0) {
            const answered = log.questions.filter(q => q.answer).length;
            const qaColor = answered === log.questions.length ? '#2ecc71' : '#f39c12';
            qaInfo = `<br><small style="color: ${qaColor};"><i class="fas fa-question-circle"></i> ${answered}/${log.questions.length} questions answered</small>`;
        }

        // Quick Win #4: Tradition alignment badge
        const traditionBadge = addTraditionBadgeToMotion(log.id);

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${escapeHtml(logDate.toLocaleDateString())}</td>
            <td>
                ${escapeHtml(log.item.substring(0, 50))}${log.item.length > 50 ? '...' : ''}
                ${statusBadges[workflowStatus]}
                ${traditionBadge}
                ${researchInfo}
                ${reviewBadge}
                ${qaInfo}
                ${minorityBadge}
            </td>
            <td>${escapeHtml(log.submittedBy || 'N/A')}</td>
            <td style="color: ${log.status === 'passed' ? '#2ecc71' : log.status === 'failed' ? '#e74c3c' : '#f39c12'};">${escapeHtml(log.status.toUpperCase())}</td>
            <td>${escapeHtml(votesDisplay)}</td>
            <td>
                <button class="btn" data-action="view-gc" data-id="${escapeAttribute(log.id)}" style="margin-right: 5px;">View</button>
                <button class="btn" data-action="edit-gc" data-id="${escapeAttribute(log.id)}" style="margin-right: 5px;">Edit</button>
                <button class="btn secondary" data-action="delete-gc" data-id="${escapeAttribute(log.id)}">Delete</button>
            </td>
        `;
        tbody.appendChild(tr);
    });

    if (currentTbody.innerHTML === '') {
        currentTbody.innerHTML = '<tr><td colspan="6">No entries for the current month.</td></tr>';
    }
    if (previousTbody.innerHTML === '') {
        previousTbody.innerHTML = '<tr><td colspan="6">No entries for previous months.</td></tr>';
    }
}

function editGCLog(id) {
    const logs = storage.getGroupConscienceLog();
    const log = logs.find(l => l.id === id);
    if (!log) return;

    document.getElementById('gc-edit-id').value = log.id;
    document.getElementById('gc-date').value = log.date;
    document.getElementById('gc-item').value = log.item;
    document.getElementById('gc-submitted-by').value = log.submittedBy;
    document.getElementById('gc-status').value = log.status;

    // Populate new vote fields (or fall back to old format)
    if (document.getElementById('gc-votes-for')) {
        document.getElementById('gc-votes-for').value = log.votesFor || 0;
        document.getElementById('gc-votes-against').value = log.votesAgainst || 0;
        document.getElementById('gc-votes-abstain').value = log.votesAbstain || 0;
        updateVotePercentages();
    }

    // Handle populating the multi-select dropdown
    const attendees = log.attendees || [];
    const select = document.getElementById('gc-attendees');
    if (Array.isArray(attendees)) {
        Array.from(select.options).forEach(option => {
            option.selected = attendees.includes(option.value);
        });
    } else {
        // For old string data, we can't reliably pre-select. Clear selection.
        select.selectedIndex = -1;
    }

    // Clear existing reports and hide legacy container
    document.querySelectorAll('.servant-report-input').forEach(input => input.value = '');
    const legacyContainer = document.getElementById('gc-servant-reports-legacy-container');
    const legacyTextarea = document.getElementById('gc-servant-reports-legacy');
    legacyContainer.style.display = 'none';

    if (log.servantReports && Array.isArray(log.servantReports)) {
        log.servantReports.forEach(report => {
            const textarea = document.getElementById(`servant-report-${report.servantId}`);
            if (textarea) {
                textarea.value = report.report;
            }
        });
    } else if (log.servantReports && typeof log.servantReports === 'string' && log.servantReports.trim() !== '') {
        legacyContainer.style.display = 'block';
        legacyTextarea.value = log.servantReports;
    }

    document.getElementById('gc-form-title').textContent = 'Edit GC Entry';
    document.getElementById('gc-form-btn').textContent = 'Save Changes';
    document.getElementById('gc-form-cancel-btn').style.display = 'inline-block';
}

function updateGCLog(id) {
    const logs = storage.getGroupConscienceLog();
    const index = logs.findIndex(l => l.id === id);
    if (index === -1) return;

    const servantReportInputs = document.querySelectorAll('.servant-report-input');
    const servantReports = [];
    servantReportInputs.forEach(input => {
        if (input.value.trim() !== '') {
            servantReports.push({
                servantId: input.dataset.servantId,
                servantName: input.dataset.servantName,
                report: input.value.trim()
            });
        }
    });

    const votesFor = parseInt(document.getElementById('gc-votes-for')?.value || 0);
    const votesAgainst = parseInt(document.getElementById('gc-votes-against')?.value || 0);
    const votesAbstain = parseInt(document.getElementById('gc-votes-abstain')?.value || 0);

    const log = {
        id,
        date: document.getElementById('gc-date').value,
        item: document.getElementById('gc-item').value.trim(),
        submittedBy: document.getElementById('gc-submitted-by').value.trim(),
        status: document.getElementById('gc-status').value,
        votesFor,
        votesAgainst,
        votesAbstain,
        attendees: Array.from(document.getElementById('gc-attendees').selectedOptions).map(opt => opt.value),
        servantReports: servantReports,
    };

    if (!log.date || !log.item) {
        showToast('Please provide at least a date and an item/motion.', 'error');
        return;
    }

    logs[index] = log;
    storage.saveGroupConscienceLog(logs);
    showToast('Group Conscience entry updated.', 'success');
    cancelGCEdit();
    updateGCLogTable();
}

function cancelGCEdit() {
    document.getElementById('gc-edit-id').value = '';
    document.getElementById('gc-date').value = '';
    document.getElementById('gc-item').value = '';
    document.getElementById('gc-submitted-by').value = '';
    document.getElementById('gc-status').value = 'passed';

    // Clear new vote fields
    if (document.getElementById('gc-votes-for')) {
        document.getElementById('gc-votes-for').value = '';
        document.getElementById('gc-votes-against').value = '';
        document.getElementById('gc-votes-abstain').value = '';
        updateVotePercentages();
    }

    document.getElementById('gc-attendees').value = '';
    document.querySelectorAll('.servant-report-input').forEach(input => input.value = '');
    document.getElementById('gc-servant-reports-legacy-container').style.display = 'none';
    document.getElementById('gc-servant-reports-legacy').value = '';

    document.getElementById('gc-form-title').textContent = 'Log Group Conscience Item';
    document.getElementById('gc-form-btn').textContent = 'Add GC Entry';
    document.getElementById('gc-form-cancel-btn').style.display = 'none';
}

function deleteGCLog(id) {
    if (!confirm('Delete this Group Conscience entry?')) return;
    let logs = storage.getGroupConscienceLog();
    logs = logs.filter(l => l.id !== id);
    storage.saveGroupConscienceLog(logs);
    showToast('GC entry deleted.', 'info');
    updateGCLogTable();
}

// Live Group Conscience functions
function toggleLiveGC() {
    const module = document.getElementById('live-gc-module');
    module.style.display = module.style.display === 'none' ? 'block' : 'none';
}

function addNewBusinessItem() {
    const itemText = document.getElementById('new-business-item').value.trim();
    if (!itemText) {
        showToast('Please enter an item.', 'error');
        return;
    }

    const items = storage.getLiveGCItems();
    items.push({
        id: genId(),
        item: itemText,
        status: 'Proposed'
    });
    storage.saveLiveGCItems(items);
    showToast('New business item added.', 'success');
    document.getElementById('new-business-item').value = '';
    updateLiveGCTable();
}

function updateLiveGCTable() {
    const tbody = document.getElementById('live-gc-body');
    if (!tbody) return;
    tbody.innerHTML = '';
    const items = storage.getLiveGCItems();

    items.forEach(item => {
        const tr = document.createElement('tr');
        const statusOptions = ['Proposed', 'Active Discussion', 'Tabled']
            .map(s => `<option value="${s}" ${s === item.status ? 'selected' : ''}>${s}</option>`)
            .join('');

        tr.innerHTML = `
            <td>${escapeHtml(item.item)}</td>
            <td>
                <select onchange="updateLiveGCItemStatus('${escapeAttribute(item.id)}', this.value)">
                    ${statusOptions}
                </select>
            </td>
            <td>
                <button class="btn secondary" data-action="delete-live-gc" data-id="${escapeAttribute(item.id)}">Delete</button>
            </td>
        `;
        tbody.appendChild(tr);
    });

    if (items.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3">No new business items.</td></tr>';
    }
}

function updateLiveGCItemStatus(id, newStatus) {
    let items = storage.getLiveGCItems();
    const index = items.findIndex(item => item.id === id);
    if (index > -1) {
        items[index].status = newStatus;
        storage.saveLiveGCItems(items);
        showToast('Item status updated.', 'success');
        updateLiveGCTable();
    }
}

function deleteLiveGCItem(id) {
    if (!confirm('Delete this item?')) return;
    let items = storage.getLiveGCItems();
    items = items.filter(item => item.id !== id);
    storage.saveLiveGCItems(items);
    showToast('Item deleted.', 'info');
    updateLiveGCTable();
}

// ========== FEATURE 1: Pre-GC Submission System ==========
// ===== ENHANCED PRE-MEETING AGENDA COLLABORATION =====

function addProposedAgendaItem() {
    const title = document.getElementById('proposed-item-title').value.trim();
    const description = document.getElementById('proposed-item-description').value.trim();
    const submitter = document.getElementById('proposed-item-submitter').value;
    const estimatedTime = parseInt(document.getElementById('proposed-item-time').value) || 15;
    const urgency = document.getElementById('proposed-item-urgency').value;
    const background = document.getElementById('proposed-item-background').value.trim();

    if (!title || !description || !submitter) {
        showToast('Please fill in all required fields (title, description, submitter).', 'error');
        return;
    }

    const items = storage.getProposedAgendaItems();

    // Check if submission is within allowed timeframe
    const notice = checkAgendaSubmissionDeadline();
    if (notice && notice.closed) {
        showToast('Agenda submissions are closed for the upcoming meeting. Please submit for the next meeting.', 'error');
        return;
    }

    const newItem = {
        id: genId(),
        title,
        description,
        submitter,
        estimatedTime,
        urgency,
        background,
        dateSubmitted: new Date().toISOString().split('T')[0],
        status: 'pending',
        discussionNotes: '',
        interestedMembers: [], // Members who expressed interest
        historicalContext: findHistoricalContext(title, description)
    };

    items.push(newItem);
    storage.saveProposedAgendaItems(items);

    // Add audit log
    addAuditLog('CREATE', 'proposed-agenda', newItem.id, submitter, null,
        `Submitted agenda item: ${title}`, null);

    showToast('Agenda item submitted successfully! Members will be notified.', 'success');

    // Send notification to all members
    sendAgendaItemNotification(newItem);

    // Clear form
    document.getElementById('proposed-item-title').value = '';
    document.getElementById('proposed-item-description').value = '';
    document.getElementById('proposed-item-time').value = '15';
    document.getElementById('proposed-item-urgency').value = 'medium';
    document.getElementById('proposed-item-background').value = '';

    updateProposedAgendaTable();
}

function updateProposedAgendaTable() {
    const tbody = document.getElementById('proposed-agenda-body');
    if (!tbody) return;
    tbody.innerHTML = '';

    // Populate submitter dropdown
    const submitterSelect = document.getElementById('proposed-item-submitter');
    if (submitterSelect && submitterSelect.options.length <= 1) {
        const members = storage.getMembers().sort((a, b) => a.name.localeCompare(b.name));
        members.forEach(m => {
            const option = document.createElement('option');
            option.value = m.name;
            option.textContent = m.name;
            submitterSelect.appendChild(option);
        });
    }

    const items = storage.getProposedAgendaItems();

    // Filter to only pending items for upcoming meeting
    const pendingItems = items.filter(i => i.status === 'pending' || i.status === 'reviewed');

    // Sort by urgency, then date
    const urgencyOrder = { urgent: 0, high: 1, medium: 2, low: 3 };
    pendingItems.sort((a, b) => {
        const urgencyA = urgencyOrder[a.urgency || 'medium'];
        const urgencyB = urgencyOrder[b.urgency || 'medium'];
        if (urgencyA !== urgencyB) return urgencyA - urgencyB;
        return new Date(a.dateSubmitted) - new Date(b.dateSubmitted);
    });

    pendingItems.forEach(item => {
        const tr = document.createElement('tr');

        // Urgency badge
        const urgencyColors = { urgent: '#e74c3c', high: '#f39c12', medium: '#3498db', low: '#95a5a6' };
        const urgencyColor = urgencyColors[item.urgency || 'medium'];
        const urgencyBadge = `<span style="display: inline-block; padding: 0.25rem 0.5rem; background: ${urgencyColor}; border-radius: 4px; font-size: 0.75rem; font-weight: bold;">${(item.urgency || 'medium').toUpperCase()}</span>`;

        // Interest indicator
        const interestedCount = (item.interestedMembers || []).length;
        const members = storage.getMembers();
        const interestPercentage = members.length > 0 ? ((interestedCount / members.length) * 100).toFixed(0) : 0;
        const interestDisplay = `
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-users" style="color: #3498db;"></i>
                <span>${interestedCount} (${interestPercentage}%)</span>
            </div>
        `;

        // Status color
        const statusColor = item.status === 'converted' ? '#2ecc71' : item.status === 'discussed' ? '#f39c12' : '#3498db';

        // Historical context indicator
        const hasContext = item.historicalContext && item.historicalContext.length > 0;
        const contextBadge = hasContext ? `<span style="color: #f39c12; margin-left: 0.5rem;" title="Related to ${item.historicalContext.length} past decision(s)"><i class="fas fa-history"></i></span>` : '';

        tr.innerHTML = `
            <td>${urgencyBadge}</td>
            <td>
                <div style="font-weight: 500;">${escapeHtml(item.title)}${contextBadge}</div>
                <div style="font-size: 0.75rem; opacity: 0.7; margin-top: 0.25rem;">
                    Submitted: ${new Date(item.dateSubmitted).toLocaleDateString()}
                </div>
            </td>
            <td>${escapeHtml(item.submitter)}</td>
            <td>${item.estimatedTime || 15} min</td>
            <td onclick="toggleAgendaInterest('${escapeAttribute(item.id)}')" style="cursor: pointer;" title="Click to express interest">
                ${interestDisplay}
            </td>
            <td style="color: ${statusColor};">${escapeHtml(item.status.charAt(0).toUpperCase() + item.status.slice(1))}</td>
            <td style="white-space: nowrap;">
                <button class="btn" data-action="view-proposed" data-id="${escapeAttribute(item.id)}" style="margin-right: 5px; font-size: 0.8rem; padding: 0.3rem 0.6rem;">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn secondary" data-action="delete-proposed" data-id="${escapeAttribute(item.id)}" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });

    if (pendingItems.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; opacity: 0.7;">No pending agenda items. Submit items to begin collaborative agenda building!</td></tr>';
    }

    // Update submission deadline notice
    updateAgendaSubmissionNotice();
}

function viewProposedAgendaItem(id) {
    const items = storage.getProposedAgendaItems();
    const item = items.find(i => i.id === id);
    if (!item) return;

    // Build historical context section
    let contextSection = '';
    if (item.historicalContext && item.historicalContext.length > 0) {
        const contextList = item.historicalContext.map(ctx => `
            <div style="padding: 0.75rem; background: #2c3e50; border-left: 3px solid #f39c12; margin-bottom: 0.5rem;">
                <div style="font-weight: bold;">${escapeHtml(ctx.item)}</div>
                <div style="font-size: 0.85rem; opacity: 0.7; margin-top: 0.25rem;">
                    ${new Date(ctx.date).toLocaleDateString()} - ${ctx.outcome}
                </div>
            </div>
        `).join('');

        contextSection = `
            <div style="margin-top: 1.5rem;">
                <h4 style="margin-bottom: 0.75rem;"><i class="fas fa-history"></i> Historical Context</h4>
                <div style="background: #2c3e50; padding: 1rem; border-radius: 4px;">
                    <div style="margin-bottom: 0.5rem; opacity: 0.8;">Similar past decisions:</div>
                    ${contextList}
                </div>
            </div>
        `;
    }

    // Build interested members section
    let interestSection = '';
    if (item.interestedMembers && item.interestedMembers.length > 0) {
        const membersList = item.interestedMembers.map(name => `<span style="display: inline-block; padding: 0.25rem 0.5rem; background: #34495e; border-radius: 4px; margin: 0.25rem;">${escapeHtml(name)}</span>`).join('');
        interestSection = `
            <div style="margin-top: 1rem;">
                <div style="font-weight: bold; margin-bottom: 0.5rem;"><i class="fas fa-users"></i> Interested Members (${item.interestedMembers.length})</div>
                <div>${membersList}</div>
            </div>
        `;
    }

    const urgencyColors = { urgent: '#e74c3c', high: '#f39c12', medium: '#3498db', low: '#95a5a6' };
    const urgencyColor = urgencyColors[item.urgency || 'medium'];

    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; overflow-y: auto;';
    modal.innerHTML = `
        <div style="background: #34495e; padding: 2rem; border-radius: 8px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; margin: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1.5rem;">
                <h3 style="margin: 0;"><i class="fas fa-clipboard-list"></i> Agenda Item Details</h3>
                <button onclick="this.closest('div[style*=fixed]').remove()" class="btn secondary" style="padding: 0.25rem 0.75rem;">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Main Info -->
            <div style="background: #2c3e50; padding: 1.5rem; border-radius: 4px; border-left: 4px solid ${urgencyColor};">
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                    <span style="display: inline-block; padding: 0.25rem 0.75rem; background: ${urgencyColor}; border-radius: 4px; font-size: 0.85rem; font-weight: bold;">
                        ${(item.urgency || 'medium').toUpperCase()}
                    </span>
                    <span style="display: inline-block; padding: 0.25rem 0.75rem; background: #7f8c8d; border-radius: 4px; font-size: 0.85rem;">
                        ${item.estimatedTime || 15} minutes
                    </span>
                </div>

                <div style="font-size: 1.1rem; font-weight: bold; margin-bottom: 1rem;">${escapeHtml(item.title)}</div>

                <div style="margin-bottom: 1rem;">
                    <div style="font-weight: bold; margin-bottom: 0.5rem;">Description & Rationale:</div>
                    <div style="line-height: 1.6;">${escapeHtml(item.description)}</div>
                </div>

                ${item.background ? `
                <div>
                    <div style="font-weight: bold; margin-bottom: 0.5rem;">Background Materials:</div>
                    <div style="background: #1a252f; padding: 1rem; border-radius: 4px; line-height: 1.6;">
                        ${escapeHtml(item.background)}
                    </div>
                </div>
                ` : ''}

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem; font-size: 0.9rem;">
                    <div>
                        <div style="opacity: 0.7;">Submitted By:</div>
                        <div style="font-weight: bold;">${escapeHtml(item.submitter)}</div>
                    </div>
                    <div>
                        <div style="opacity: 0.7;">Date Submitted:</div>
                        <div>${new Date(item.dateSubmitted).toLocaleDateString()}</div>
                    </div>
                </div>

                ${interestSection}
            </div>

            ${contextSection}

            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                <button onclick="toggleAgendaInterest('${escapeAttribute(item.id)}'); this.closest('div[style*=fixed]').remove(); updateProposedAgendaTable();" class="btn" style="background: #3498db;">
                    <i class="fas fa-hand-paper"></i> Express Interest
                </button>
                <button onclick="this.closest('div[style*=fixed]').remove()" class="btn secondary">Close</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function deleteProposedAgendaItem(id) {
    const items = storage.getProposedAgendaItems();
    const item = items.find(i => i.id === id);

    if (!confirm(`Delete proposed agenda item: "${item.title}"?`)) return;

    const filtered = items.filter(i => i.id !== id);
    storage.saveProposedAgendaItems(filtered);

    // Add audit log
    addAuditLog('DELETE', 'proposed-agenda', id, item.submitter, item,
        `Deleted agenda item: ${item.title}`, null);

    showToast('Proposed agenda item deleted.', 'info');
    updateProposedAgendaTable();
}

function toggleAgendaInterest(itemId) {
    const items = storage.getProposedAgendaItems();
    const item = items.find(i => i.id === itemId);
    if (!item) return;

    const userName = prompt('Enter your name to express interest in this agenda item:');
    if (!userName || userName.trim() === '') return;

    if (!item.interestedMembers) item.interestedMembers = [];

    if (item.interestedMembers.includes(userName.trim())) {
        // Remove interest
        item.interestedMembers = item.interestedMembers.filter(n => n !== userName.trim());
        showToast('Interest removed', 'info');
    } else {
        // Add interest
        item.interestedMembers.push(userName.trim());
        showToast('Interest recorded! This helps prioritize agenda items.', 'success');
    }

    storage.saveProposedAgendaItems(items);
    updateProposedAgendaTable();
}

function findHistoricalContext(title, description) {
    const gcLogs = storage.getGroupConscienceLog();
    const searchTerms = (title + ' ' + description).toLowerCase().split(' ').filter(word => word.length > 3);

    // Find similar past decisions
    const relatedDecisions = gcLogs.filter(log => {
        const logText = (log.item + ' ' + (log.discussionNotes || '')).toLowerCase();
        return searchTerms.some(term => logText.includes(term));
    }).slice(0, 3); // Limit to 3 most recent

    return relatedDecisions;
}

function sendAgendaItemNotification(item) {
    const notification = {
        id: genId(),
        date: new Date().toISOString(),
        priority: item.urgency === 'urgent' || item.urgency === 'high' ? 'high' : 'medium',
        title: `New Agenda Item: ${item.title}`,
        message: `${item.submitter} submitted a new item for the next GC meeting. Review and express interest if relevant to you.`,
        actionLink: 'gc-decisions-section',
        read: false
    };

    const notifications = storage.getNotifications();
    notifications.unshift(notification);
    storage.saveNotifications(notifications);
}

function checkAgendaSubmissionDeadline() {
    // This would integrate with GC meeting schedule if available
    // For now, return null (always open)
    return null;
}

function updateAgendaSubmissionNotice() {
    const notice = checkAgendaSubmissionDeadline();
    const noticeEl = document.getElementById('agenda-submission-notice');
    const textEl = document.getElementById('agenda-notice-text');

    if (!noticeEl || !textEl) return;

    if (notice) {
        noticeEl.style.display = 'block';
        textEl.textContent = notice.message;
        if (notice.closed) {
            noticeEl.style.background = '#e74c3c';
        } else {
            noticeEl.style.background = '#f39c12';
        }
    } else {
        noticeEl.style.display = 'none';
    }
}

function viewAgendaSummaryForUpcomingMeeting() {
    const items = storage.getProposedAgendaItems().filter(i => i.status === 'pending' || i.status === 'reviewed');

    if (items.length === 0) {
        showToast('No agenda items to display', 'info');
        return;
    }

    // Sort by urgency and interest
    const urgencyOrder = { urgent: 0, high: 1, medium: 2, low: 3 };
    items.sort((a, b) => {
        const urgencyA = urgencyOrder[a.urgency || 'medium'];
        const urgencyB = urgencyOrder[b.urgency || 'medium'];
        if (urgencyA !== urgencyB) return urgencyA - urgencyB;

        const interestA = (a.interestedMembers || []).length;
        const interestB = (b.interestedMembers || []).length;
        return interestB - interestA;
    });

    const totalTime = items.reduce((sum, item) => sum + (item.estimatedTime || 15), 0);

    const itemsList = items.map((item, idx) => `
        <div style="padding: 1rem; background: #2c3e50; border-left: 4px solid ${urgencyOrder[item.urgency || 'medium'] <= 1 ? '#e74c3c' : '#3498db'}; margin-bottom: 0.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div style="flex: 1;">
                    <div style="font-weight: bold; font-size: 1.05rem;">${idx + 1}. ${escapeHtml(item.title)}</div>
                    <div style="font-size: 0.9rem; opacity: 0.8; margin-top: 0.5rem;">${escapeHtml(item.description)}</div>
                    <div style="font-size: 0.85rem; opacity: 0.7; margin-top: 0.5rem;">
                        Submitted by ${escapeHtml(item.submitter)} | ${(item.interestedMembers || []).length} members interested
                    </div>
                </div>
                <div style="text-align: right; min-width: 80px; margin-left: 1rem;">
                    <div style="font-size: 0.9rem; font-weight: bold;">${item.estimatedTime || 15} min</div>
                    <div style="font-size: 0.75rem; opacity: 0.7;">${(item.urgency || 'medium').toUpperCase()}</div>
                </div>
            </div>
        </div>
    `).join('');

    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; overflow-y: auto;';
    modal.innerHTML = `
        <div style="background: #34495e; padding: 2rem; border-radius: 8px; max-width: 900px; width: 90%; max-height: 90vh; overflow-y: auto; margin: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="margin: 0;"><i class="fas fa-clipboard-list"></i> Proposed Agenda for Next Meeting</h3>
                <button onclick="this.closest('div[style*=fixed]').remove()" class="btn secondary">Close</button>
            </div>

            <div style="background: #2c3e50; padding: 1rem; border-radius: 4px; margin-bottom: 1.5rem; display: flex; justify-content: space-around;">
                <div style="text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #3498db;">${items.length}</div>
                    <div style="font-size: 0.85rem; opacity: 0.7;">Agenda Items</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #f39c12;">${totalTime} min</div>
                    <div style="font-size: 0.85rem; opacity: 0.7;">Est. Total Time</div>
                </div>
            </div>

            <div style="margin-bottom: 1rem;">
                <h4 style="margin-bottom: 0.75rem;">Prioritized Agenda (by urgency and interest):</h4>
                ${itemsList}
            </div>

            <div style="padding: 1rem; background: #2c3e50; border-radius: 4px; font-size: 0.9rem; opacity: 0.8;">
                <i class="fas fa-info-circle"></i> This prioritized agenda is based on urgency level and member interest.
                Actual agenda order will be finalized by the facilitator before the meeting.
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// ========== FEATURE 2: Voting Transparency & Quorum ==========
function updateVotePercentages() {
    const votesFor = parseIntSafe(document.getElementById('gc-votes-for')?.value, 0);
    const votesAgainst = parseIntSafe(document.getElementById('gc-votes-against')?.value, 0);
    const votesAbstain = parseIntSafe(document.getElementById('gc-votes-abstain')?.value, 0);
    const totalVotes = votesFor + votesAgainst + votesAbstain;

    // Safety: Update total votes display
    const totalVotesEl = document.getElementById('total-votes');
    if (totalVotesEl) totalVotesEl.textContent = totalVotes;

    // Update vote counts safely
    const votesForCountEl = document.getElementById('votes-for-count');
    const votesAgainstCountEl = document.getElementById('votes-against-count');
    const votesAbstainCountEl = document.getElementById('votes-abstain-count');

    if (votesForCountEl) votesForCountEl.textContent = votesFor;
    if (votesAgainstCountEl) votesAgainstCountEl.textContent = votesAgainst;
    if (votesAbstainCountEl) votesAbstainCountEl.textContent = votesAbstain;

    // Calculate percentages safely (avoid division by zero)
    if (totalVotes > 0) {
        const percentFor = ((votesFor / totalVotes) * 100).toFixed(1);
        const percentAgainst = ((votesAgainst / totalVotes) * 100).toFixed(1);
        const percentAbstain = ((votesAbstain / totalVotes) * 100).toFixed(1);

        // Update percentage displays
        const percentForEl = document.getElementById('percent-for');
        const percentAgainstEl = document.getElementById('percent-against');
        const percentAbstainEl = document.getElementById('percent-abstain');

        if (percentForEl) percentForEl.textContent = percentFor + '%';
        if (percentAgainstEl) percentAgainstEl.textContent = percentAgainst + '%';
        if (percentAbstainEl) percentAbstainEl.textContent = percentAbstain + '%';

        // Update progress bars
        const progressBarFor = document.getElementById('progress-bar-for');
        const progressBarAgainst = document.getElementById('progress-bar-against');
        const progressBarAbstain = document.getElementById('progress-bar-abstain');

        if (progressBarFor) progressBarFor.style.width = percentFor + '%';
        if (progressBarAgainst) progressBarAgainst.style.width = percentAgainst + '%';
        if (progressBarAbstain) progressBarAbstain.style.width = percentAbstain + '%';
    } else {
        // Reset to zero when no votes
        const percentForEl = document.getElementById('percent-for');
        const percentAgainstEl = document.getElementById('percent-against');
        const percentAbstainEl = document.getElementById('percent-abstain');

        if (percentForEl) percentForEl.textContent = '0%';
        if (percentAgainstEl) percentAgainstEl.textContent = '0%';
        if (percentAbstainEl) percentAbstainEl.textContent = '0%';

        // Reset progress bars
        const progressBarFor = document.getElementById('progress-bar-for');
        const progressBarAgainst = document.getElementById('progress-bar-against');
        const progressBarAbstain = document.getElementById('progress-bar-abstain');

        if (progressBarFor) progressBarFor.style.width = '0%';
        if (progressBarAgainst) progressBarAgainst.style.width = '0%';
        if (progressBarAbstain) progressBarAbstain.style.width = '0%';
    }

    updateQuorumStatus();
}

function updateQuorumStatus() {
    const attendees = document.getElementById('gc-attendees').selectedOptions.length;
    const totalMembers = storage.getMembers().length;
    const settings = storage.getGCSettings();

    const quorumByPercentage = Math.ceil((totalMembers * settings.quorumPercentage) / 100);
    const quorumRequired = Math.max(quorumByPercentage, settings.quorumMinimum);

    const quorumStatus = document.getElementById('quorum-status');
    if (!quorumStatus) return;

    if (attendees >= quorumRequired) {
        quorumStatus.innerHTML = `<strong style="color: #2ecc71;">✓ Quorum Met:</strong> ${attendees} of ${totalMembers} members (${quorumRequired} required)`;
    } else {
        quorumStatus.innerHTML = `<strong style="color: #e74c3c;">✗ No Quorum:</strong> ${attendees} of ${totalMembers} members (${quorumRequired} required)`;
    }
}

function saveGCSettings() {
    const percentage = parseInt(document.getElementById('quorum-percentage').value) || 50;
    const minimum = parseInt(document.getElementById('quorum-minimum').value) || 5;

    if (percentage < 1 || percentage > 100) {
        showToast('Quorum percentage must be between 1 and 100.', 'error');
        return;
    }

    if (minimum < 1) {
        showToast('Minimum quorum must be at least 1.', 'error');
        return;
    }

    storage.saveGCSettings({ quorumPercentage: percentage, quorumMinimum: minimum });
    showToast('GC settings saved successfully!', 'success');
}

function loadGCSettings() {
    const settings = storage.getGCSettings();
    const percentageInput = document.getElementById('quorum-percentage');
    const minimumInput = document.getElementById('quorum-minimum');

    if (percentageInput) percentageInput.value = settings.quorumPercentage;
    if (minimumInput) minimumInput.value = settings.quorumMinimum;
}

// ========== FEATURE 3: Enhanced Action Items & Follow-Up Tracking ==========
function handleActionItemSubmit() {
    const editId = document.getElementById('action-item-edit-id').value;
    if (editId) {
        updateActionItem(editId);
    } else {
        addActionItem();
    }
}

function addActionItem() {
    const description = document.getElementById('action-item-description').value.trim();
    const assignee = document.getElementById('action-item-assignee').value;
    const dueDate = document.getElementById('action-item-due-date').value;
    const priority = document.getElementById('action-item-priority').value;
    const relatedGCId = document.getElementById('action-item-related-gc').value;
    const dependenciesSelect = document.getElementById('action-item-dependencies');
    const dependencies = Array.from(dependenciesSelect.selectedOptions)
        .map(opt => opt.value)
        .filter(v => v !== '');

    if (!description || !assignee || !dueDate) {
        showToast('Please fill in all required fields.', 'error');
        return;
    }

    const actions = storage.getGCActionItems();
    const newAction = {
        id: genId(),
        description,
        assignee,
        dueDate,
        priority,
        relatedGCId,
        dependencies,
        status: 'pending',
        progress: 0,
        createdDate: new Date().toISOString().split('T')[0],
        completedDate: null,
        updates: [],
        reminders: {
            sent7Days: false,
            sent3Days: false,
            sent1Day: false,
            sentOverdue: false
        }
    };

    actions.push(newAction);
    storage.saveGCActionItems(actions);

    // Add audit log entry
    addAuditLog('CREATE', 'action-item', newAction.id, assignee, null,
        `Created action item: ${description.substring(0, 50)}`, null);

    showToast('Action item added with automatic reminders enabled!', 'success');
    cancelActionItemEdit();
    updateActionItemsTable();
}

function updateActionItem(id) {
    const actions = storage.getGCActionItems();
    const index = actions.findIndex(a => a.id === id);
    if (index === -1) return;

    const description = document.getElementById('action-item-description').value.trim();
    const assignee = document.getElementById('action-item-assignee').value;
    const dueDate = document.getElementById('action-item-due-date').value;
    const priority = document.getElementById('action-item-priority').value;
    const relatedGCId = document.getElementById('action-item-related-gc').value;
    const dependenciesSelect = document.getElementById('action-item-dependencies');
    const dependencies = Array.from(dependenciesSelect.selectedOptions)
        .map(opt => opt.value)
        .filter(v => v !== '');

    if (!description || !assignee || !dueDate) {
        showToast('Please fill in all required fields.', 'error');
        return;
    }

    const oldAction = {...actions[index]};
    actions[index] = {
        ...actions[index],
        description,
        assignee,
        dueDate,
        priority,
        relatedGCId,
        dependencies
    };

    storage.saveGCActionItems(actions);

    // Add audit log entry
    addAuditLog('EDIT', 'action-item', id, assignee, oldAction,
        `Updated action item: ${description.substring(0, 50)}`, null);

    showToast('Action item updated!', 'success');
    cancelActionItemEdit();
    updateActionItemsTable();
}

function cancelActionItemEdit() {
    document.getElementById('action-item-edit-id').value = '';
    document.getElementById('action-item-description').value = '';
    document.getElementById('action-item-assignee').value = '';
    document.getElementById('action-item-due-date').value = '';
    document.getElementById('action-item-priority').value = 'medium';
    document.getElementById('action-item-related-gc').value = '';
    const depsSelect = document.getElementById('action-item-dependencies');
    Array.from(depsSelect.options).forEach(opt => opt.selected = false);

    document.getElementById('action-item-btn').textContent = 'Add Action Item';
    document.getElementById('action-item-cancel-btn').style.display = 'none';
}

function updateActionItemsTable() {
    const tbody = document.getElementById('action-items-body');
    if (!tbody) return;
    tbody.innerHTML = '';

    const showCompleted = document.getElementById('action-item-show-completed')?.checked || false;
    const filterAssignee = document.getElementById('action-item-filter-assignee')?.value || '';

    let actions = storage.getGCActionItems();

    // Apply filters
    if (!showCompleted) {
        actions = actions.filter(a => a.status !== 'completed');
    }
    if (filterAssignee) {
        actions = actions.filter(a => a.assignee === filterAssignee);
    }

    // Sort by priority, then due date
    const priorityOrder = { urgent: 0, high: 1, medium: 2, low: 3 };
    actions.sort((a, b) => {
        const priorityA = priorityOrder[a.priority || 'medium'];
        const priorityB = priorityOrder[b.priority || 'medium'];
        if (priorityA !== priorityB) return priorityA - priorityB;
        return new Date(a.dueDate) - new Date(b.dueDate);
    });

    actions.forEach(action => {
        const tr = document.createElement('tr');
        const today = new Date().toISOString().split('T')[0];
        const isOverdue = action.dueDate < today && action.status !== 'completed';
        const dueDateColor = isOverdue ? '#e74c3c' : '#ecf0f1';

        // Priority badge
        const priorityColors = {
            urgent: '#e74c3c',
            high: '#f39c12',
            medium: '#3498db',
            low: '#95a5a6'
        };
        const priorityColor = priorityColors[action.priority || 'medium'];
        const priorityBadge = `<span style="display: inline-block; padding: 0.25rem 0.5rem; background: ${priorityColor}; border-radius: 4px; font-size: 0.75rem; font-weight: bold;">${(action.priority || 'medium').toUpperCase()}</span>`;

        // Progress bar
        const progress = action.progress || 0;
        const progressBar = `
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <div style="flex: 1; background: #2c3e50; border-radius: 10px; height: 20px; overflow: hidden;">
                    <div style="background: ${progress === 100 ? '#2ecc71' : '#3498db'}; width: ${progress}%; height: 100%; transition: width 0.3s;"></div>
                </div>
                <span style="font-size: 0.85rem; min-width: 35px;">${progress}%</span>
            </div>
        `;

        // Status dropdown
        const statusOptions = ['pending', 'in-progress', 'blocked', 'completed']
            .map(s => `<option value="${s}" ${s === action.status ? 'selected' : ''}>${s.charAt(0).toUpperCase() + s.slice(1).replace('-', ' ')}</option>`)
            .join('');

        // Check for dependency blocking
        const isBlocked = checkActionItemBlocked(action);
        const blockedWarning = isBlocked ? '<span style="color: #e74c3c; font-size: 0.8rem;"> (Blocked by dependencies)</span>' : '';

        tr.innerHTML = `
            <td>${priorityBadge}</td>
            <td>
                <div style="font-weight: 500;">${escapeHtml(action.description.substring(0, 50))}${action.description.length > 50 ? '...' : ''}</div>
                ${blockedWarning}
                ${action.dependencies && action.dependencies.length > 0 ? `<div style="font-size: 0.75rem; opacity: 0.7; margin-top: 0.25rem;"><i class="fas fa-link"></i> ${action.dependencies.length} dependency/ies</div>` : ''}
            </td>
            <td>${escapeHtml(action.assignee)}</td>
            <td style="color: ${dueDateColor}; font-weight: ${isOverdue ? 'bold' : 'normal'};">
                ${new Date(action.dueDate).toLocaleDateString()}
                ${isOverdue ? '<br><span style="font-size: 0.8rem;">(OVERDUE)</span>' : ''}
            </td>
            <td onclick="updateActionItemProgress('${escapeAttribute(action.id)}')" style="cursor: pointer;" title="Click to update progress">
                ${progressBar}
            </td>
            <td>
                <select onchange="handleActionItemStatusChange('${escapeAttribute(action.id)}', this.value)" style="background: #34495e; color: #ecf0f1; border: 1px solid #7f8c8d; border-radius: 4px; padding: 0.25rem;">
                    ${statusOptions}
                </select>
            </td>
            <td style="white-space: nowrap;">
                <button class="btn" data-action="view-action-details" data-id="${escapeAttribute(action.id)}" style="margin-right: 5px; font-size: 0.8rem; padding: 0.3rem 0.6rem;">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn" data-action="edit-action" data-id="${escapeAttribute(action.id)}" style="margin-right: 5px; font-size: 0.8rem; padding: 0.3rem 0.6rem;">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn secondary" data-action="delete-action" data-id="${escapeAttribute(action.id)}" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });

    if (actions.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 2rem; opacity: 0.7;">No action items match the current filters.</td></tr>`;
    }

    populateActionItemDropdowns();

    // Run automatic reminder check
    checkAndSendActionItemReminders();
}

function editActionItem(id) {
    const actions = storage.getGCActionItems();
    const action = actions.find(a => a.id === id);
    if (!action) return;

    document.getElementById('action-item-edit-id').value = action.id;
    document.getElementById('action-item-description').value = action.description;
    document.getElementById('action-item-assignee').value = action.assignee;
    document.getElementById('action-item-due-date').value = action.dueDate;
    document.getElementById('action-item-priority').value = action.priority || 'medium';
    document.getElementById('action-item-related-gc').value = action.relatedGCId || '';

    // Select dependencies
    const depsSelect = document.getElementById('action-item-dependencies');
    Array.from(depsSelect.options).forEach(opt => {
        opt.selected = action.dependencies && action.dependencies.includes(opt.value);
    });

    document.getElementById('action-item-btn').textContent = 'Update Action Item';
    document.getElementById('action-item-cancel-btn').style.display = 'inline-block';

    // Scroll to form
    document.getElementById('action-item-description').scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function handleActionItemStatusChange(id, newStatus) {
    if (newStatus === 'completed') {
        // Require completion verification
        openCompletionVerificationModal(id);
    } else {
        updateActionItemStatus(id, newStatus);
    }
}

function updateActionItemStatus(id, newStatus) {
    const actions = storage.getGCActionItems();
    const index = actions.findIndex(a => a.id === id);
    if (index === -1) return;

    const oldStatus = actions[index].status;
    actions[index].status = newStatus;

    if (newStatus === 'completed') {
        actions[index].completedDate = new Date().toISOString().split('T')[0];
        actions[index].progress = 100;
    }

    storage.saveGCActionItems(actions);

    // Add audit log
    addAuditLog('EDIT', 'action-item', id, actions[index].assignee, { status: oldStatus },
        `Status changed from ${oldStatus} to ${newStatus}`, null);

    showToast('Action item status updated!', 'success');
    updateActionItemsTable();
}

function deleteActionItem(id) {
    const actions = storage.getGCActionItems();
    const action = actions.find(a => a.id === id);

    if (!confirm(`Delete action item: "${action.description.substring(0, 50)}"?`)) return;

    const filtered = actions.filter(a => a.id !== id);
    storage.saveGCActionItems(filtered);

    // Add audit log
    addAuditLog('DELETE', 'action-item', id, action.assignee, action,
        `Deleted action item: ${action.description.substring(0, 50)}`, null);

    showToast('Action item deleted.', 'info');
    updateActionItemsTable();
}

function populateActionItemDropdowns() {
    const assigneeSelect = document.getElementById('action-item-assignee');
    const relatedGCSelect = document.getElementById('action-item-related-gc');
    const depsSelect = document.getElementById('action-item-dependencies');
    const filterSelect = document.getElementById('action-item-filter-assignee');

    if (assigneeSelect) {
        const currentValue = assigneeSelect.value;
        assigneeSelect.innerHTML = '<option value="">Select member...</option>';
        const members = storage.getMembers().sort((a, b) => a.name.localeCompare(b.name));
        members.forEach(m => {
            const option = document.createElement('option');
            option.value = m.name;
            option.textContent = m.name;
            assigneeSelect.appendChild(option);
        });
        if (currentValue) assigneeSelect.value = currentValue;
    }

    if (filterSelect) {
        const currentValue = filterSelect.value;
        filterSelect.innerHTML = '<option value="">All Assignees</option>';
        const members = storage.getMembers().sort((a, b) => a.name.localeCompare(b.name));
        members.forEach(m => {
            const option = document.createElement('option');
            option.value = m.name;
            option.textContent = m.name;
            filterSelect.appendChild(option);
        });
        if (currentValue) filterSelect.value = currentValue;
    }

    if (relatedGCSelect) {
        const currentValue = relatedGCSelect.value;
        relatedGCSelect.innerHTML = '<option value="">None</option>';
        const gcLogs = storage.getGroupConscienceLog().sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 20);
        gcLogs.forEach(log => {
            const option = document.createElement('option');
            option.value = log.id;
            option.textContent = `${new Date(log.date).toLocaleDateString()} - ${log.item.substring(0, 50)}`;
            relatedGCSelect.appendChild(option);
        });
        if (currentValue) relatedGCSelect.value = currentValue;
    }

    if (depsSelect) {
        const currentEditId = document.getElementById('action-item-edit-id').value;
        const currentValue = Array.from(depsSelect.selectedOptions).map(opt => opt.value);
        depsSelect.innerHTML = '<option value="">None - select other action items this depends on</option>';
        const actions = storage.getGCActionItems().filter(a => a.status !== 'completed' && a.id !== currentEditId);
        actions.forEach(action => {
            const option = document.createElement('option');
            option.value = action.id;
            option.textContent = `${action.description.substring(0, 60)} (${action.assignee})`;
            if (currentValue.includes(action.id)) option.selected = true;
            depsSelect.appendChild(option);
        });
    }
}

// ===== NEW ENHANCED ACTION ITEM FUNCTIONS =====

function checkActionItemBlocked(action) {
    if (!action.dependencies || action.dependencies.length === 0) return false;

    const actions = storage.getGCActionItems();
    const dependencyActions = actions.filter(a => action.dependencies.includes(a.id));

    // Blocked if any dependency is not completed
    return dependencyActions.some(dep => dep.status !== 'completed');
}

function updateActionItemProgress(id) {
    const actions = storage.getGCActionItems();
    const action = actions.find(a => a.id === id);
    if (!action) return;

    const currentProgress = action.progress || 0;
    const newProgress = prompt(`Update progress for:\n"${action.description}"\n\nEnter percentage (0-100):`, currentProgress);

    if (newProgress === null) return;

    const progress = parseInt(newProgress);
    if (isNaN(progress) || progress < 0 || progress > 100) {
        showToast('Please enter a valid percentage (0-100)', 'error');
        return;
    }

    const note = prompt('Add a progress note (optional):', '');

    const index = actions.findIndex(a => a.id === id);
    actions[index].progress = progress;

    // Add update to history
    if (!actions[index].updates) actions[index].updates = [];
    actions[index].updates.push({
        date: new Date().toISOString(),
        type: 'progress',
        progress: progress,
        note: note || ''
    });

    // Auto-update status based on progress
    if (progress === 0 && actions[index].status === 'pending') {
        // Keep as pending
    } else if (progress > 0 && progress < 100 && actions[index].status === 'pending') {
        actions[index].status = 'in-progress';
    } else if (progress === 100 && actions[index].status !== 'completed') {
        // Suggest completion
        if (confirm('Progress is 100%. Mark this action item as completed?')) {
            openCompletionVerificationModal(id);
            return;
        }
    }

    storage.saveGCActionItems(actions);
    showToast(`Progress updated to ${progress}%`, 'success');
    updateActionItemsTable();
}

function openCompletionVerificationModal(id) {
    const actions = storage.getGCActionItems();
    const action = actions.find(a => a.id === id);
    if (!action) return;

    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';
    modal.innerHTML = `
        <div style="background: #34495e; padding: 2rem; border-radius: 8px; max-width: 600px; width: 90%;">
            <h3 style="margin-top: 0;"><i class="fas fa-check-circle" style="color: #2ecc71;"></i> Complete Action Item</h3>
            <div style="background: #2c3e50; padding: 1rem; border-radius: 4px; margin: 1rem 0;">
                <div style="font-weight: bold; margin-bottom: 0.5rem;">${escapeHtml(action.description)}</div>
                <div style="font-size: 0.85rem; opacity: 0.7;">Assigned to: ${escapeHtml(action.assignee)} | Due: ${new Date(action.dueDate).toLocaleDateString()}</div>
            </div>

            <div style="margin: 1.5rem 0;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">
                    Completion Notes / Evidence *
                </label>
                <textarea id="completion-notes" rows="4" placeholder="Describe what was completed and any relevant details..." style="width: 100%; padding: 0.5rem; background: #2c3e50; border: 1px solid #7f8c8d; border-radius: 4px; color: #ecf0f1; font-family: inherit;"></textarea>
                <div style="font-size: 0.85rem; opacity: 0.7; margin-top: 0.25rem;">Required for accountability and future reference</div>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button onclick="this.closest('div[style*=fixed]').remove()" class="btn secondary">Cancel</button>
                <button onclick="completeActionItem('${escapeAttribute(id)}')" class="btn" style="background: #2ecc71;">
                    <i class="fas fa-check"></i> Mark Complete
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    document.getElementById('completion-notes').focus();
}

function completeActionItem(id) {
    const notes = document.getElementById('completion-notes').value.trim();

    if (!notes) {
        showToast('Please provide completion notes for accountability', 'error');
        return;
    }

    const actions = storage.getGCActionItems();
    const index = actions.findIndex(a => a.id === id);
    if (index === -1) return;

    actions[index].status = 'completed';
    actions[index].progress = 100;
    actions[index].completedDate = new Date().toISOString().split('T')[0];

    if (!actions[index].updates) actions[index].updates = [];
    actions[index].updates.push({
        date: new Date().toISOString(),
        type: 'completion',
        note: notes
    });

    storage.saveGCActionItems(actions);

    // Add audit log
    addAuditLog('EDIT', 'action-item', id, actions[index].assignee, { status: 'in-progress' },
        `Completed action item: ${actions[index].description.substring(0, 50)}`, notes);

    // Close modal
    document.querySelectorAll('div[style*="position: fixed"]').forEach(modal => modal.remove());

    showToast('Action item marked as complete!', 'success');
    updateActionItemsTable();
}

function viewActionItemDetails(id) {
    const actions = storage.getGCActionItems();
    const action = actions.find(a => a.id === id);
    if (!action) return;

    const today = new Date().toISOString().split('T')[0];
    const isOverdue = action.dueDate < today && action.status !== 'completed';
    const daysUntilDue = Math.ceil((new Date(action.dueDate) - new Date(today)) / (1000 * 60 * 60 * 24));

    // Get related GC motion if exists
    let relatedGCInfo = '';
    if (action.relatedGCId) {
        const gcLog = storage.getGroupConscienceLog().find(log => log.id === action.relatedGCId);
        if (gcLog) {
            relatedGCInfo = `
                <div style="background: #2c3e50; padding: 1rem; border-radius: 4px; margin-top: 1rem;">
                    <div style="font-weight: bold; margin-bottom: 0.5rem;"><i class="fas fa-link"></i> Related GC Motion</div>
                    <div>${escapeHtml(gcLog.item)}</div>
                    <div style="font-size: 0.85rem; opacity: 0.7; margin-top: 0.25rem;">
                        ${new Date(gcLog.date).toLocaleDateString()} - ${gcLog.outcome}
                    </div>
                </div>
            `;
        }
    }

    // Get dependencies info
    let depsInfo = '';
    if (action.dependencies && action.dependencies.length > 0) {
        const depActions = actions.filter(a => action.dependencies.includes(a.id));
        const depsList = depActions.map(dep => `
            <div style="padding: 0.5rem; background: ${dep.status === 'completed' ? '#27ae60' : '#e74c3c'}; border-radius: 4px; margin-bottom: 0.5rem;">
                <div style="font-weight: 500;">${escapeHtml(dep.description.substring(0, 60))}</div>
                <div style="font-size: 0.85rem; opacity: 0.9;">Status: ${dep.status} | ${dep.assignee}</div>
            </div>
        `).join('');

        depsInfo = `
            <div style="background: #2c3e50; padding: 1rem; border-radius: 4px; margin-top: 1rem;">
                <div style="font-weight: bold; margin-bottom: 0.5rem;"><i class="fas fa-project-diagram"></i> Dependencies (${depActions.length})</div>
                ${depsList}
            </div>
        `;
    }

    // Updates history
    let updatesInfo = '';
    if (action.updates && action.updates.length > 0) {
        const updatesList = action.updates.slice().reverse().map(update => `
            <div style="padding: 0.75rem; background: #2c3e50; border-left: 3px solid #3498db; margin-bottom: 0.5rem;">
                <div style="font-size: 0.85rem; opacity: 0.7;">${new Date(update.date).toLocaleString()}</div>
                <div style="margin-top: 0.25rem;">
                    ${update.type === 'progress' ? `<strong>Progress: ${update.progress}%</strong>` : '<strong>Completed</strong>'}
                </div>
                ${update.note ? `<div style="margin-top: 0.5rem;">${escapeHtml(update.note)}</div>` : ''}
            </div>
        `).join('');

        updatesInfo = `
            <div style="background: #2c3e50; padding: 1rem; border-radius: 4px; margin-top: 1rem;">
                <div style="font-weight: bold; margin-bottom: 0.5rem;"><i class="fas fa-history"></i> Update History (${action.updates.length})</div>
                ${updatesList}
            </div>
        `;
    }

    const priorityColors = { urgent: '#e74c3c', high: '#f39c12', medium: '#3498db', low: '#95a5a6' };
    const priorityColor = priorityColors[action.priority || 'medium'];

    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; overflow-y: auto;';
    modal.innerHTML = `
        <div style="background: #34495e; padding: 2rem; border-radius: 8px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; margin: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1.5rem;">
                <h3 style="margin: 0;"><i class="fas fa-tasks"></i> Action Item Details</h3>
                <button onclick="this.closest('div[style*=fixed]').remove()" class="btn secondary" style="padding: 0.25rem 0.75rem;">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Main Info -->
            <div style="background: #2c3e50; padding: 1.5rem; border-radius: 4px; border-left: 4px solid ${priorityColor};">
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                    <span style="display: inline-block; padding: 0.25rem 0.75rem; background: ${priorityColor}; border-radius: 4px; font-size: 0.85rem; font-weight: bold;">
                        ${(action.priority || 'medium').toUpperCase()}
                    </span>
                    <span style="display: inline-block; padding: 0.25rem 0.75rem; background: #7f8c8d; border-radius: 4px; font-size: 0.85rem; font-weight: bold;">
                        ${action.status.toUpperCase()}
                    </span>
                </div>
                <div style="font-size: 1.1rem; font-weight: bold; margin-bottom: 1rem;">${escapeHtml(action.description)}</div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.9rem;">
                    <div>
                        <div style="opacity: 0.7;">Assigned To:</div>
                        <div style="font-weight: bold;">${escapeHtml(action.assignee)}</div>
                    </div>
                    <div>
                        <div style="opacity: 0.7;">Due Date:</div>
                        <div style="font-weight: bold; color: ${isOverdue ? '#e74c3c' : '#ecf0f1'};">
                            ${new Date(action.dueDate).toLocaleDateString()}
                            ${isOverdue ? ' (OVERDUE)' : daysUntilDue >= 0 ? ` (${daysUntilDue} days)` : ''}
                        </div>
                    </div>
                    <div>
                        <div style="opacity: 0.7;">Created:</div>
                        <div>${new Date(action.createdDate).toLocaleDateString()}</div>
                    </div>
                    ${action.completedDate ? `
                    <div>
                        <div style="opacity: 0.7;">Completed:</div>
                        <div style="color: #2ecc71;">${new Date(action.completedDate).toLocaleDateString()}</div>
                    </div>
                    ` : ''}
                </div>

                <!-- Progress Bar -->
                <div style="margin-top: 1rem;">
                    <div style="opacity: 0.7; margin-bottom: 0.5rem;">Progress: ${action.progress || 0}%</div>
                    <div style="background: #1a252f; border-radius: 10px; height: 24px; overflow: hidden;">
                        <div style="background: ${action.progress === 100 ? '#2ecc71' : '#3498db'}; width: ${action.progress || 0}%; height: 100%; transition: width 0.3s;"></div>
                    </div>
                </div>
            </div>

            ${relatedGCInfo}
            ${depsInfo}
            ${updatesInfo}

            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                <button onclick="editActionItem('${escapeAttribute(action.id)}'); this.closest('div[style*=fixed]').remove();" class="btn">
                    <i class="fas fa-edit"></i> Edit
                </button>
                ${action.status !== 'completed' ? `
                <button onclick="updateActionItemProgress('${escapeAttribute(action.id)}'); this.closest('div[style*=fixed]').remove();" class="btn" style="background: #3498db;">
                    <i class="fas fa-tasks"></i> Update Progress
                </button>
                <button onclick="openCompletionVerificationModal('${escapeAttribute(action.id)}'); this.closest('div[style*=fixed]').remove();" class="btn" style="background: #2ecc71;">
                    <i class="fas fa-check"></i> Mark Complete
                </button>
                ` : ''}
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function checkAndSendActionItemReminders() {
    const actions = storage.getGCActionItems().filter(a => a.status !== 'completed');
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    actions.forEach(action => {
        const dueDate = new Date(action.dueDate);
        dueDate.setHours(0, 0, 0, 0);
        const daysUntilDue = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));

        // Initialize reminders object if missing
        if (!action.reminders) {
            action.reminders = {
                sent7Days: false,
                sent3Days: false,
                sent1Day: false,
                sentOverdue: false
            };
        }

        // 7 days reminder
        if (daysUntilDue === 7 && !action.reminders.sent7Days) {
            sendActionItemReminder(action, '7 days');
            action.reminders.sent7Days = true;
        }

        // 3 days reminder
        if (daysUntilDue === 3 && !action.reminders.sent3Days) {
            sendActionItemReminder(action, '3 days');
            action.reminders.sent3Days = true;
        }

        // 1 day reminder
        if (daysUntilDue === 1 && !action.reminders.sent1Day) {
            sendActionItemReminder(action, '1 day');
            action.reminders.sent1Day = true;
        }

        // Overdue reminder (send once per day while overdue)
        if (daysUntilDue < 0) {
            const lastSent = action.reminders.lastOverdueReminder;
            const shouldSend = !lastSent || (new Date().toISOString().split('T')[0] !== lastSent);
            if (shouldSend) {
                sendActionItemReminder(action, `${Math.abs(daysUntilDue)} days overdue`);
                action.reminders.lastOverdueReminder = new Date().toISOString().split('T')[0];
            }
        }
    });

    storage.saveGCActionItems(actions);
}

function sendActionItemReminder(action, timeframe) {
    const notification = {
        id: genId(),
        date: new Date().toISOString(),
        priority: timeframe.includes('overdue') ? 'urgent' : 'high',
        title: `Action Item Reminder: ${timeframe}`,
        message: `"${action.description}" assigned to ${action.assignee} - Due: ${new Date(action.dueDate).toLocaleDateString()}`,
        actionLink: 'gc-decisions-section',
        read: false
    };

    const notifications = storage.getNotifications();
    notifications.unshift(notification);
    storage.saveNotifications(notifications);
}

function viewActionItemReport() {
    const actions = storage.getGCActionItems();
    const members = storage.getMembers();

    // Calculate metrics by assignee
    const metrics = {};
    members.forEach(member => {
        const memberActions = actions.filter(a => a.assignee === member.name);
        const completed = memberActions.filter(a => a.status === 'completed');
        const overdue = memberActions.filter(a => {
            const today = new Date().toISOString().split('T')[0];
            return a.dueDate < today && a.status !== 'completed';
        });
        const inProgress = memberActions.filter(a => a.status === 'in-progress');

        metrics[member.name] = {
            total: memberActions.length,
            completed: completed.length,
            inProgress: inProgress.length,
            overdue: overdue.length,
            completionRate: memberActions.length > 0 ? ((completed.length / memberActions.length) * 100).toFixed(1) : 0
        };
    });

    // Overall statistics
    const totalActions = actions.length;
    const completedActions = actions.filter(a => a.status === 'completed').length;
    const overdueActions = actions.filter(a => {
        const today = new Date().toISOString().split('T')[0];
        return a.dueDate < today && a.status !== 'completed';
    }).length;

    const membersWithActions = Object.entries(metrics).filter(([_, m]) => m.total > 0);

    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; overflow-y: auto;';
    modal.innerHTML = `
        <div style="background: #34495e; padding: 2rem; border-radius: 8px; max-width: 1000px; width: 90%; max-height: 90vh; overflow-y: auto; margin: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="margin: 0;"><i class="fas fa-chart-bar"></i> Action Items Accountability Report</h3>
                <button onclick="this.closest('div[style*=fixed]').remove()" class="btn secondary">Close</button>
            </div>

            <!-- Overall Stats -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                <div style="background: #2c3e50; padding: 1rem; border-radius: 4px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; color: #3498db;">${totalActions}</div>
                    <div style="opacity: 0.7;">Total Action Items</div>
                </div>
                <div style="background: #2c3e50; padding: 1rem; border-radius: 4px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; color: #2ecc71;">${completedActions}</div>
                    <div style="opacity: 0.7;">Completed</div>
                </div>
                <div style="background: #2c3e50; padding: 1rem; border-radius: 4px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; color: #e74c3c;">${overdueActions}</div>
                    <div style="opacity: 0.7;">Overdue</div>
                </div>
                <div style="background: #2c3e50; padding: 1rem; border-radius: 4px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; color: #f39c12;">${totalActions > 0 ? ((completedActions / totalActions) * 100).toFixed(1) : 0}%</div>
                    <div style="opacity: 0.7;">Completion Rate</div>
                </div>
            </div>

            <!-- By Assignee Table -->
            <h4>Performance by Assignee</h4>
            <table style="width: 100%; margin-top: 1rem;">
                <thead>
                    <tr>
                        <th>Assignee</th>
                        <th>Total</th>
                        <th>Completed</th>
                        <th>In Progress</th>
                        <th>Overdue</th>
                        <th>Completion Rate</th>
                    </tr>
                </thead>
                <tbody>
                    ${membersWithActions.map(([name, m]) => `
                        <tr>
                            <td style="font-weight: bold;">${escapeHtml(name)}</td>
                            <td>${m.total}</td>
                            <td style="color: #2ecc71;">${m.completed}</td>
                            <td style="color: #3498db;">${m.inProgress}</td>
                            <td style="color: ${m.overdue > 0 ? '#e74c3c' : '#ecf0f1'}; font-weight: ${m.overdue > 0 ? 'bold' : 'normal'};">${m.overdue}</td>
                            <td>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <div style="flex: 1; background: #1a252f; border-radius: 10px; height: 20px; overflow: hidden;">
                                        <div style="background: #2ecc71; width: ${m.completionRate}%; height: 100%;"></div>
                                    </div>
                                    <span style="min-width: 45px;">${m.completionRate}%</span>
                                </div>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>

            <div style="margin-top: 2rem; padding: 1rem; background: #2c3e50; border-radius: 4px; font-size: 0.9rem; opacity: 0.8;">
                <i class="fas fa-info-circle"></i> This report shows action item completion metrics for accountability.
                Use this data during GC meetings to identify bottlenecks and recognize consistent performers.
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// ========== FEATURE 4: Discussion Threading & Comments ==========
let currentGCIdForComments = null;

function openGCDetailsModal(id) {
    currentGCIdForComments = id;
    const logs = storage.getGroupConscienceLog();
    const log = logs.find(l => l.id === id);
    if (!log) return;

    const votesFor = log.votesFor || 0;
    const votesAgainst = log.votesAgainst || 0;
    const votesAbstain = log.votesAbstain || 0;
    const totalVotes = votesFor + votesAgainst + votesAbstain;

    let votesDisplay = '';
    if (totalVotes > 0) {
        const percentFor = ((votesFor / totalVotes) * 100).toFixed(1);
        const percentAgainst = ((votesAgainst / totalVotes) * 100).toFixed(1);
        const percentAbstain = ((votesAbstain / totalVotes) * 100).toFixed(1);
        votesDisplay = `
            <div style="margin-top: 1rem;">
                <strong style="display: block; margin-bottom: 0.5rem;">Voting Results (Total: ${totalVotes})</strong>
                <div class="vote-progress-container">
                    <div class="vote-progress-item">
                        <div class="vote-progress-label">
                            <span><strong>For:</strong> ${votesFor}</span>
                            <span>${percentFor}%</span>
                        </div>
                        <div class="vote-progress-bar-bg">
                            <div class="vote-progress-bar-fill for" style="width: ${percentFor}%;"></div>
                        </div>
                    </div>
                    <div class="vote-progress-item">
                        <div class="vote-progress-label">
                            <span><strong>Against:</strong> ${votesAgainst}</span>
                            <span>${percentAgainst}%</span>
                        </div>
                        <div class="vote-progress-bar-bg">
                            <div class="vote-progress-bar-fill against" style="width: ${percentAgainst}%;"></div>
                        </div>
                    </div>
                    <div class="vote-progress-item">
                        <div class="vote-progress-label">
                            <span><strong>Abstain:</strong> ${votesAbstain}</span>
                            <span>${percentAbstain}%</span>
                        </div>
                        <div class="vote-progress-bar-bg">
                            <div class="vote-progress-bar-fill abstain" style="width: ${percentAbstain}%;"></div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else if (log.votes) {
        votesDisplay = `<div style="margin-top: 0.5rem;"><strong>Votes:</strong> ${log.votes}</div>`;
    }

    const attendeesList = Array.isArray(log.attendees) ? log.attendees.join(', ') : (log.attendees || 'N/A');
    const attendeeCount = Array.isArray(log.attendees) ? log.attendees.length : 0;

    // Calculate participation rate
    const totalMembers = storage.getMembers().length;
    const participationRate = totalMembers > 0 ? ((attendeeCount / totalMembers) * 100).toFixed(1) : 0;

    const detailsContent = document.getElementById('gc-details-content');
    detailsContent.innerHTML = `
        <div style="background: #34495e; padding: 1rem; border-radius: 6px;">
            <div><strong>Date:</strong> ${new Date(log.date).toLocaleDateString()}</div>
            <div style="margin-top: 0.5rem;"><strong>Motion:</strong> ${log.item}</div>
            <div style="margin-top: 0.5rem;"><strong>Submitted By:</strong> ${log.submittedBy || 'N/A'}</div>
            <div style="margin-top: 0.5rem;"><strong>Status:</strong> <span style="color: ${log.status === 'passed' ? '#2ecc71' : log.status === 'failed' ? '#e74c3c' : '#f39c12'};">${log.status.toUpperCase()}</span></div>
            ${votesDisplay}
            <div style="margin-top: 0.5rem;">
                <strong>Members Present:</strong> ${attendeeCount} of ${totalMembers} (${participationRate}% turnout)
                <div style="font-size: 0.85rem; opacity: 0.9; margin-top: 0.25rem;">${attendeesList}</div>
            </div>
        </div>
    `;

    loadGCComments(id);
    const modal = document.getElementById('gc-details-modal');
    if (modal) {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden'; // Prevent background scrolling
    }
}

function closeGCDetailsModal() {
    const modal = document.getElementById('gc-details-modal');
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = ''; // Restore scrolling
    }
    currentGCIdForComments = null;
    const commentText = document.getElementById('gc-comment-text');
    const commentAuthor = document.getElementById('gc-comment-author');
    if (commentText) commentText.value = '';
    if (commentAuthor) commentAuthor.value = '';
}

function loadGCComments(gcId) {
    const commentsList = document.getElementById('gc-comments-list');
    const allComments = storage.getGCComments();
    const comments = allComments.filter(c => c.gcId === gcId).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

    if (comments.length === 0) {
        commentsList.innerHTML = '<div style="text-align: center; opacity: 0.6; padding: 1rem;">No comments yet.</div>';
        return;
    }

    // Separate amendments from other comments
    const amendments = comments.filter(c => c.type === 'amendment');
    const otherComments = comments.filter(c => c.type !== 'amendment');

    let html = '';

    // Show Amendment Timeline if there are amendments
    if (amendments.length > 0) {
        html += '<div style="margin-bottom: 1.5rem;"><h4 style="color: #f39c12; margin-bottom: 0.75rem;">Amendment History</h4><div class="amendment-timeline">';
        amendments.forEach(amendment => {
            const statusClass = amendment.status || '';
            const statusBadge = amendment.status === 'adopted'
                ? '<span style="background: #2ecc71; color: white; padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.75rem; margin-left: 0.5rem;">ADOPTED</span>'
                : amendment.status === 'rejected'
                ? '<span style="background: #e74c3c; color: white; padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.75rem; margin-left: 0.5rem;">REJECTED</span>'
                : '';

            html += `
                <div class="amendment-item ${statusClass}">
                    <div style="margin-bottom: 0.5rem;">
                        <strong style="color: #f39c12;">${amendment.author}</strong>
                        <span style="font-size: 0.75rem; opacity: 0.7; margin-left: 0.5rem;">${new Date(amendment.timestamp).toLocaleString()}</span>
                        ${statusBadge}
                    </div>
                    <div style="margin-bottom: 0.5rem;">${escapeHtml(amendment.text)}</div>
                    ${!amendment.status ? `
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                            <button class="btn" style="font-size: 0.75rem; padding: 0.3rem 0.6rem;" data-action="update-amendment" data-id="${escapeAttribute(amendment.id)}" data-status="adopted">Mark Adopted</button>
                            <button class="btn secondary" style="font-size: 0.75rem; padding: 0.3rem 0.6rem;" data-action="update-amendment" data-id="${escapeAttribute(amendment.id)}" data-status="rejected">Mark Rejected</button>
                        </div>
                    ` : ''}
                    <button class="btn secondary" style="font-size: 0.75rem; padding: 0.3rem 0.6rem; margin-top: 0.5rem;" data-action="delete-comment" data-id="${escapeAttribute(amendment.id)}">Delete</button>
                </div>
            `;
        });
        html += '</div></div>';
    }

    // Show other comments
    if (otherComments.length > 0) {
        html += '<div><h4 style="color: #3498db; margin-bottom: 0.75rem;">Discussion & Comments</h4>';
        otherComments.forEach(comment => {
            const typeColors = {
                discussion: '#3498db',
                clarification: '#9b59b6',
                support: '#2ecc71',
                concern: '#e74c3c'
            };
            const typeColor = typeColors[comment.type] || '#7f8c8d';

            html += `
            <div style="background: #2c3e50; padding: 0.75rem; border-radius: 4px; margin-bottom: 0.5rem; border-left: 4px solid ${typeColor};">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                        <strong>${comment.author}</strong>
                        <span style="font-size: 0.8rem; opacity: 0.7; margin-left: 0.5rem;">${new Date(comment.timestamp).toLocaleString()}</span>
                        <span style="background: ${typeColor}; padding: 0.1rem 0.4rem; border-radius: 3px; font-size: 0.7rem; margin-left: 0.5rem;">${comment.type}</span>
                    </div>
                    <button data-action="delete-comment" data-id="${escapeAttribute(comment.id)}" style="background: none; border: none; color: #e74c3c; cursor: pointer; font-size: 1.2rem;">&times;</button>
                </div>
                <div style="margin-top: 0.5rem;">${escapeHtml(comment.text)}</div>
            </div>
        `;
        });
        html += '</div>';
    }

    commentsList.innerHTML = html;
}

function updateAmendmentStatus(amendmentId, status) {
    let comments = storage.getGCComments();
    const comment = comments.find(c => c.id === amendmentId);
    if (comment) {
        comment.status = status;
        storage.saveGCComments(comments);
        showToast(`Amendment marked as ${status}!`, 'success');
        loadGCComments(currentGCIdForComments);
    }
}

function addGCComment() {
    if (!currentGCIdForComments) return;

    const text = document.getElementById('gc-comment-text').value.trim();
    const author = document.getElementById('gc-comment-author').value.trim();
    const type = document.getElementById('gc-comment-type').value;

    if (!text || !author) {
        showToast('Please provide both comment text and your name.', 'error');
        return;
    }

    const comments = storage.getGCComments();
    comments.push({
        id: genId(),
        gcId: currentGCIdForComments,
        text,
        author,
        type,
        timestamp: new Date().toISOString()
    });

    storage.saveGCComments(comments);
    showToast('Comment added!', 'success');

    document.getElementById('gc-comment-text').value = '';
    document.getElementById('gc-comment-author').value = '';

    loadGCComments(currentGCIdForComments);
}

function deleteGCComment(id) {
    if (!confirm('Delete this comment?')) return;
    let comments = storage.getGCComments();
    comments = comments.filter(c => c.id !== id);
    storage.saveGCComments(comments);
    showToast('Comment deleted.', 'info');
    if (currentGCIdForComments) {
        loadGCComments(currentGCIdForComments);
    }
}

// ========== FEATURE 5: Historical Analysis & Search ==========
// Debounce timer for search
let searchGCHistoryTimer = null;

function searchGCHistory() {
    // Clear any pending search
    if (searchGCHistoryTimer) {
        clearTimeout(searchGCHistoryTimer);
    }

    // Debounce search by 300ms
    searchGCHistoryTimer = setTimeout(() => {
        performGCHistorySearch();
    }, 300);
}

function performGCHistorySearch() {
    const searchText = document.getElementById('gc-search')?.value.toLowerCase() || '';
    const filterStatus = document.getElementById('gc-filter-status')?.value || '';
    const dateFrom = document.getElementById('gc-filter-date-from')?.value || '';
    const dateTo = document.getElementById('gc-filter-date-to')?.value || '';

    let logs = storage.getGroupConscienceLog();

    if (searchText) {
        logs = logs.filter(log =>
            log.item.toLowerCase().includes(searchText) ||
            (log.submittedBy && log.submittedBy.toLowerCase().includes(searchText))
        );
    }

    if (filterStatus) {
        logs = logs.filter(log => log.status === filterStatus);
    }

    if (dateFrom) {
        logs = logs.filter(log => log.date >= dateFrom);
    }

    if (dateTo) {
        logs = logs.filter(log => log.date <= dateTo);
    }

    logs.sort((a, b) => new Date(b.date) - new Date(a.date));

    const tbody = document.getElementById('gc-history-search-body');
    if (!tbody) return;

    // Clear ALL existing rows - multiple methods to ensure it's cleared
    while (tbody.firstChild) {
        tbody.removeChild(tbody.firstChild);
    }
    tbody.innerHTML = '';

    if (logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5">No results found.</td></tr>';
        updateGCStatistics();
        return;
    }

    // Build all HTML first, then set once
    const rows = logs.map(log => {
        const votesFor = log.votesFor || 0;
        const votesAgainst = log.votesAgainst || 0;
        const votesAbstain = log.votesAbstain || 0;
        const votesDisplay = (votesFor || votesAgainst || votesAbstain)
            ? `${votesFor}-${votesAgainst}-${votesAbstain}`
            : (log.votes || 'N/A');

        return `
            <tr>
                <td>${new Date(log.date).toLocaleDateString()}</td>
                <td>${escapeHtml(log.item.substring(0, 60))}${log.item.length > 60 ? '...' : ''}</td>
                <td style="color: ${log.status === 'passed' ? '#2ecc71' : log.status === 'failed' ? '#e74c3c' : '#f39c12'};">${log.status.toUpperCase()}</td>
                <td>${votesDisplay}</td>
                <td>
                    <button class="btn" data-action="view-gc" data-id="${escapeAttribute(log.id)}">View Details</button>
                </td>
            </tr>
        `;
    }).join('');

    tbody.innerHTML = rows;
    updateGCStatistics();
}

function updateGCStatistics() {
    const logs = storage.getGroupConscienceLog();
    const total = logs.length;
    const passed = logs.filter(l => l.status === 'passed').length;
    const failed = logs.filter(l => l.status === 'failed').length;
    const tabled = logs.filter(l => l.status === 'tabled').length;
    const passRate = total > 0 ? ((passed / total) * 100).toFixed(1) : 0;

    document.getElementById('stat-total-motions').textContent = total;
    document.getElementById('stat-passed-motions').textContent = passed;
    document.getElementById('stat-failed-motions').textContent = failed;
    document.getElementById('stat-tabled-motions').textContent = tabled;
    document.getElementById('stat-pass-rate').textContent = passRate + '%';
}

// ========== FEATURE: GC Trends Dashboard ==========
let gcTrendsCharts = {
    monthly: null,
    status: null,
    participation: null
};

function refreshGCTrends() {
    renderMonthlyActivityChart();
    renderStatusDistributionChart();
    renderParticipationTrendChart();
    renderTopTopics();
    populateAnnualReportYears();
}

function renderMonthlyActivityChart() {
    const logs = storage.getGroupConscienceLog();
    const monthCounts = {};

    logs.forEach(log => {
        const date = new Date(log.date);
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        monthCounts[monthKey] = (monthCounts[monthKey] || 0) + 1;
    });

    const sortedMonths = Object.keys(monthCounts).sort();
    const last12Months = sortedMonths.slice(-12);
    const counts = last12Months.map(month => monthCounts[month]);

    const ctx = document.getElementById('gc-trends-monthly-chart');
    if (!ctx) return;

    if (gcTrendsCharts.monthly) {
        gcTrendsCharts.monthly.destroy();
    }

    gcTrendsCharts.monthly = new Chart(ctx, {
        type: 'line',
        data: {
            labels: last12Months.map(m => {
                const [year, month] = m.split('-');
                return new Date(year, month - 1).toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
            }),
            datasets: [{
                label: 'Motions per Month',
                data: counts,
                borderColor: '#3498db',
                backgroundColor: 'rgba(52, 152, 219, 0.2)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { color: '#ecf0f1', stepSize: 1 },
                    grid: { color: 'rgba(127, 140, 141, 0.2)' }
                },
                x: {
                    ticks: { color: '#ecf0f1' },
                    grid: { color: 'rgba(127, 140, 141, 0.2)' }
                }
            }
        }
    });
}

function renderStatusDistributionChart() {
    const logs = storage.getGroupConscienceLog();
    const passed = logs.filter(l => l.status === 'passed').length;
    const failed = logs.filter(l => l.status === 'failed').length;
    const tabled = logs.filter(l => l.status === 'tabled').length;

    const ctx = document.getElementById('gc-trends-status-chart');
    if (!ctx) return;

    if (gcTrendsCharts.status) {
        gcTrendsCharts.status.destroy();
    }

    gcTrendsCharts.status = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Passed', 'Failed', 'Tabled'],
            datasets: [{
                data: [passed, failed, tabled],
                backgroundColor: ['#2ecc71', '#e74c3c', '#f39c12'],
                borderWidth: 2,
                borderColor: '#2c3e50'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { color: '#ecf0f1' }
                }
            }
        }
    });
}

function renderParticipationTrendChart() {
    const logs = storage.getGroupConscienceLog().sort((a, b) => new Date(a.date) - new Date(b.date));
    const last10 = logs.slice(-10);

    const participationData = last10.map(log => {
        const totalVotes = (log.votesFor || 0) + (log.votesAgainst || 0) + (log.votesAbstain || 0);
        return totalVotes;
    });

    const labels = last10.map((log, idx) => `Motion ${idx + 1}`);

    const ctx = document.getElementById('gc-trends-participation-chart');
    if (!ctx) return;

    if (gcTrendsCharts.participation) {
        gcTrendsCharts.participation.destroy();
    }

    gcTrendsCharts.participation = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Total Votes Cast',
                data: participationData,
                backgroundColor: '#3498db',
                borderColor: '#2980b9',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { color: '#ecf0f1', stepSize: 1 },
                    grid: { color: 'rgba(127, 140, 141, 0.2)' }
                },
                x: {
                    ticks: { color: '#ecf0f1' },
                    grid: { color: 'rgba(127, 140, 141, 0.2)' }
                }
            }
        }
    });
}

function renderTopTopics() {
    const logs = storage.getGroupConscienceLog();
    const wordCounts = {};

    // Common words to exclude
    const stopWords = new Set(['the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by', 'from', 'is', 'was', 'are', 'were', 'be', 'been', 'being', 'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'should', 'could', 'may', 'might', 'can', 'that', 'this', 'these', 'those', 'we', 'us', 'our']);

    logs.forEach(log => {
        const words = log.item.toLowerCase().split(/\s+/);
        words.forEach(word => {
            const cleaned = word.replace(/[^a-z]/g, '');
            if (cleaned.length > 3 && !stopWords.has(cleaned)) {
                wordCounts[cleaned] = (wordCounts[cleaned] || 0) + 1;
            }
        });
    });

    const topWords = Object.entries(wordCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);

    const container = document.getElementById('gc-top-topics');
    if (!container) return;

    if (topWords.length === 0) {
        container.innerHTML = '<p style="opacity: 0.7;">No topic data available yet.</p>';
        return;
    }

    container.innerHTML = topWords.map(([word, count]) => `
        <div style="padding: 0.5rem; margin-bottom: 0.5rem; background: #2c3e50; border-radius: 4px; display: flex; justify-content: space-between;">
            <span style="text-transform: capitalize;">${word}</span>
            <span style="background: #3498db; padding: 0.2rem 0.6rem; border-radius: 3px; font-weight: bold;">${count}</span>
        </div>
    `).join('');
}

function populateAnnualReportYears() {
    const logs = storage.getGroupConscienceLog();
    const years = new Set();

    logs.forEach(log => {
        const year = new Date(log.date).getFullYear();
        years.add(year);
    });

    const currentYear = new Date().getFullYear();
    years.add(currentYear);

    const select = document.getElementById('annual-report-year');
    if (!select) return;

    select.innerHTML = Array.from(years)
        .sort((a, b) => b - a)
        .map(year => `<option value="${year}">${year}</option>`)
        .join('');
}

function generateAnnualReport() {
    const year = parseInt(document.getElementById('annual-report-year').value);
    if (!year) {
        showToast('Please select a year.', 'error');
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const logs = storage.getGroupConscienceLog().filter(log => {
        return new Date(log.date).getFullYear() === year;
    });

    if (logs.length === 0) {
        showToast(`No GC data found for ${year}.`, 'error');
        return;
    }

    // Title
    doc.setFontSize(20);
    doc.text(`Group Conscience Annual Report - ${year}`, 14, 22);

    // Summary Statistics
    doc.setFontSize(14);
    doc.text('Annual Summary', 14, 35);
    doc.setFontSize(11);

    const passed = logs.filter(l => l.status === 'passed').length;
    const failed = logs.filter(l => l.status === 'failed').length;
    const tabled = logs.filter(l => l.status === 'tabled').length;
    const passRate = logs.length > 0 ? ((passed / logs.length) * 100).toFixed(1) : 0;

    let yPos = 45;
    doc.text(`Total Motions: ${logs.length}`, 14, yPos);
    yPos += 7;
    doc.text(`Passed: ${passed}`, 14, yPos);
    yPos += 7;
    doc.text(`Failed: ${failed}`, 14, yPos);
    yPos += 7;
    doc.text(`Tabled: ${tabled}`, 14, yPos);
    yPos += 7;
    doc.text(`Pass Rate: ${passRate}%`, 14, yPos);
    yPos += 12;

    // Motion Details Table
    doc.setFontSize(14);
    doc.text('Motion Details', 14, yPos);
    yPos += 5;

    const tableData = logs.map(log => [
        new Date(log.date).toLocaleDateString(),
        log.item.substring(0, 50) + (log.item.length > 50 ? '...' : ''),
        log.status.toUpperCase(),
        `${log.votesFor || 0}-${log.votesAgainst || 0}-${log.votesAbstain || 0}`
    ]);

    doc.autoTable({
        startY: yPos,
        head: [['Date', 'Motion', 'Status', 'Votes (F-A-Ab)']],
        body: tableData,
        theme: 'grid',
        headStyles: { fillColor: [52, 152, 219] },
        styles: { fontSize: 9 }
    });

    // Footer
    const pageCount = doc.internal.getNumberOfPages();
    doc.setFontSize(10);
    for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.text(`Page ${i} of ${pageCount}`, doc.internal.pageSize.width / 2, doc.internal.pageSize.height - 10, { align: 'center' });
        doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, doc.internal.pageSize.height - 10);
    }

    doc.save(`GC_Annual_Report_${year}.pdf`);
    showToast(`Annual report for ${year} downloaded successfully!`, 'success');
}

// ========== FEATURE: Notification & Reminder System ==========
function checkUpcomingGCMeetings() {
    // Check localStorage for the last GC meeting date
    const logs = storage.getGroupConscienceLog();
    if (logs.length === 0) return;

    // Sort by date to get the most recent
    const sortedLogs = logs.sort((a, b) => new Date(b.date) - new Date(a.date));
    const lastGCDate = new Date(sortedLogs[0].date);
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    // Calculate days since last GC
    const daysSinceLastGC = Math.floor((today - lastGCDate) / (1000 * 60 * 60 * 24));

    // Assuming monthly GC meetings (30 days), warn at 25+ days
    if (daysSinceLastGC >= 25 && daysSinceLastGC < 40) {
        const daysUntilNext = 30 - daysSinceLastGC;
        if (daysUntilNext > 0) {
            showNotificationBanner(`Group Conscience meeting coming up in approximately ${daysUntilNext} days!`, 'info');
        } else {
            showNotificationBanner(`Group Conscience meeting may be overdue! Last meeting was ${daysSinceLastGC} days ago.`, 'warning');
        }
    }

    // Check for pending proposed agenda items
    const proposedItems = storage.getProposedAgendaItems().filter(item => item.status === 'pending');
    if (proposedItems.length > 0) {
        showNotificationBanner(`${proposedItems.length} proposed agenda item(s) pending for next GC meeting.`, 'info');
    }

    // Check for incomplete action items
    const actionItems = storage.getGCActionItems().filter(item => item.status !== 'completed');
    const overdueActions = actionItems.filter(item => {
        if (!item.dueDate) return false;
        return new Date(item.dueDate) < today;
    });

    if (overdueActions.length > 0) {
        showNotificationBanner(`${overdueActions.length} GC action item(s) are overdue!`, 'urgent');
    }
}

function showNotificationBanner(message, type = 'info') {
    // Check if we've already shown this notification in this session
    const sessionKey = `notification_shown_${message}`;
    if (sessionStorage.getItem(sessionKey)) {
        return; // Don't show duplicate notifications in same session
    }

    const banner = document.createElement('div');
    banner.style.cssText = `
        position: fixed;
        top: 60px;
        left: 50%;
        transform: translateX(-50%);
        background: ${type === 'urgent' ? '#e74c3c' : type === 'warning' ? '#f39c12' : '#3498db'};
        color: white;
        padding: 1rem 2rem;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 1000;
        max-width: 600px;
        text-align: center;
        animation: slideDown 0.3s ease;
    `;
    banner.innerHTML = `
        <div style="display: flex; align-items: center; gap: 1rem;">
            <i class="fas fa-bell" style="font-size: 1.2rem;"></i>
            <span>${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; margin-left: 1rem;">&times;</button>
        </div>
    `;

    document.body.appendChild(banner);

    // Mark as shown for this session
    sessionStorage.setItem(sessionKey, 'true');

    // Auto-remove after 10 seconds
    setTimeout(() => {
        if (banner.parentElement) {
            banner.style.animation = 'slideUp 0.3s ease';
            setTimeout(() => banner.remove(), 300);
        }
    }, 10000);
}

// Request browser notification permission
function requestNotificationPermission() {
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
                showToast('Browser notifications enabled!', 'success');
            }
        });
    }
}

// Show browser notification (if permission granted)
function showBrowserNotification(title, message) {
    if ('Notification' in window && Notification.permission === 'granted') {
        new Notification(title, {
            body: message,
            icon: 'logo.svg',
            badge: 'logo.svg'
        });
    }
}


function exportChairpersonLogToPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const log = storage.getChairpersonLog().sort((a, b) => new Date(a.date) - new Date(b.date));

    if (log.length === 0) {
        showToast('No log entries to export.', 'error');
        return;
    }

    doc.setFontSize(18);
    doc.text("Chairperson's Contribution Log", 14, 22);

    const tableColumn = ["Date", "Time", "Chairperson", "Head Count", "7th Tradition ($)", "Orange Can ($)"];
    const tableRows = [];

    log.forEach(entry => {
        const timeStr = entry.time ? new Date('1970-01-01T' + entry.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'N/A';
        const logData = [
            new Date(entry.date).toLocaleDateString(),
            timeStr,
            entry.chairperson || 'N/A',
            entry.headcount,
            entry.tradition.toFixed(2),
            entry.orangeCan.toFixed(2)
        ];
        tableRows.push(logData);
    });

    doc.autoTable({
        head: [tableColumn],
        body: tableRows,
        startY: 30,
    });

    doc.save('Chairperson_Log_Report.pdf');
    showToast('PDF export generated!', 'success');
}

function exportGroupConscienceLogToPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const logs = storage.getGroupConscienceLog().sort((a, b) => new Date(a.date) - new Date(b.date));

    if (logs.length === 0) {
        showToast('No Group Conscience entries to export.', 'error');
        return;
    }

    doc.setFontSize(18);
    doc.text("Group Conscience Log", 14, 22);

    let y = 30;

    logs.forEach((log, index) => {
        if (y > 260) {
            doc.addPage();
            y = 20;
        }

        doc.setFontSize(14);
        doc.text(`Date: ${new Date(log.date).toLocaleDateString()}`, 14, y);
        y += 7;

        doc.setFontSize(12);
        doc.text(`Motion/Item: ${log.item}`, 14, y);
        y += 7;

        doc.text(`Submitted By: ${log.submittedBy}`, 14, y);
        y += 7;

        doc.text(`Status: ${log.status}`, 14, y);
        y += 7;

        const votesDisplay = `Votes: For=${log.votesFor || 0}, Against=${log.votesAgainst || 0}, Abstain=${log.votesAbstain || 0}`;
        doc.text(votesDisplay, 14, y);
        y += 7;

        doc.text("Members Present:", 14, y);
        y += 7;
        const attendeesText = Array.isArray(log.attendees) ? log.attendees.join(', ') : (log.attendees || '');
        const attendees = doc.splitTextToSize(attendeesText, 180);
        doc.text(attendees, 14, y);
        y += attendees.length * 5;

        doc.text("Servant Reports:", 14, y);
        y += 7;

        let reportsText = '';
        if (log.servantReports && Array.isArray(log.servantReports) && log.servantReports.length > 0) {
            reportsText = log.servantReports.map(r => `${r.servantName}:\n${r.report}`).join('\n\n');
        } else if (log.servantReports && typeof log.servantReports === 'string') {
            reportsText = log.servantReports;
        } else {
            reportsText = 'No reports submitted.';
        }

        const reports = doc.splitTextToSize(reportsText, 180);
        doc.text(reports, 14, y);
        y += reports.length * 5;

        if (index < logs.length - 1) {
            doc.line(14, y, 200, y); // Separator line
            y += 10;
        }
    });

    doc.save('Group_Conscience_Log.pdf');
    showToast('PDF export generated!', 'success');
}

// Data Management
function exportData(dataType) {
    let data;
    let filename = 'rowlett_group_data.json';

    if (dataType === 'all') {
        // Export all application data
        data = {
            events: storage.getEvents(),
            members: storage.getMembers(),
            announcements: storage.getAnnouncements(),
            photos: storage.getPhotos(),
            chairpersonLog: storage.getChairpersonLog(),
            groupConscienceLog: storage.getGroupConscienceLog(),
            liveGCItems: storage.getLiveGCItems(),
            proposedAgendaItems: storage.getProposedAgendaItems(),
            gcComments: storage.getGCComments(),
            gcActionItems: storage.getGCActionItems(),
            gcSettings: storage.getGCSettings(),
            messages: storage.getMessages(),
            servicePositions: storage.getServicePositions(),
            nominations: storage.getNominations(),
            budgetCategories: storage.getBudgetCategories(),
            expenses: storage.getExpenses(),
            templates: storage.getTemplates(),
            // New High-Impact Features Data
            votingSettings: storage.getVotingSettings(),
            literatureInventory: storage.getLiteratureInventory(),
            literatureLoans: storage.getLiteratureLoans(),
            serviceElections: storage.getServiceElections(),
            electionBallots: storage.getElectionBallots(),
            speakingQueue: storage.getSpeakingQueue(),
            motionTemplates: storage.getMotionTemplates(),
            traditionChecks: storage.getTraditionChecks(),
            budgetProposals: storage.getBudgetProposals(),
            districtMotions: storage.getDistrictMotions(),
            groupPositions: storage.getGroupPositions(),
            // Enhanced Features Data
            quorumRules: storage.getQuorumRules(),
            meetingMinutes: storage.getMeetingMinutes(),
            inventorySchedules: storage.getInventorySchedules(),
            decisionImpacts: storage.getDecisionImpacts(),
            participationData: storage.getParticipationData(),
            userRole: storage.getUserRole(),
            educationalProgress: storage.getEducationalProgress(),
            // Privacy & Security Data
            privacySettings: storage.getPrivacySettings(),
            accessLevels: storage.getAccessLevels(),
            // AA-Specific Features Data
            traditionOfDay: storage.getTraditionOfDay(),
            spiritualPrinciples: storage.getSpiritualPrinciples(),
            unityChecks: storage.getUnityChecks(),
            minorityOpinions: storage.getMinorityOpinions(),
            serviceStructure: storage.getServiceStructure(),
            // High Priority GC Features
            standingAgendaItems: storage.getStandingAgendaItems(),
            tabledMotions: storage.getTabledMotions(),
            motionAmendments: storage.getMotionAmendments(),
            discussionThreads: storage.getDiscussionThreads(),
            emailSettings: storage.getEmailSettings(),
            emailHistory: storage.getEmailHistory(),
            memberVotingRecords: storage.getMemberVotingRecords(),
            implementationTracking: storage.getImplementationTracking(),
            consentAgendaItems: storage.getConsentAgendaItems(),
            consentHistory: storage.getConsentHistory(),
            // Medium Priority GC Features
            reconsiderationRequests: storage.getReconsiderationRequests(),
            calendarEvents: storage.getCalendarEvents(),
            roiCalculations: storage.getROICalculations(),
            proxyVotes: storage.getProxyVotes(),
            decisionReversals: storage.getDecisionReversals(),
            exportDate: new Date().toISOString(),
            version: '5.1'
        };
        const dateStr = new Date().toISOString().split('T')[0];
        filename = `rowlett-group-backup-${dateStr}.json`;
    } else {
        // Export specific data type
        const dataMap = {
            events: storage.getEvents,
            members: storage.getMembers,
            birthdays: storage.getMembers, // Members contain birthday info
            announcements: storage.getAnnouncements,
            photos: storage.getPhotos,
            chairpersonLog: storage.getChairpersonLog,
            groupConscienceLog: storage.getGroupConscienceLog
        };

        if (dataMap[dataType]) {
            data = { [dataType]: dataMap[dataType]() };
            filename = `rowlett_group_${dataType}.json`;
        } else {
            showToast('Invalid data type for export.', 'error');
            return;
        }
    }

    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
    showToast('Data exported successfully!', 'success');
}

function importData() {
    const fileInput = document.getElementById('import-file');
    const file = fileInput.files[0];
    if (!file) {
        showToast('Please select a file to import.', 'error');
        return;
    }

    // Validate file size (max 50MB to prevent memory issues)
    if (file.size > 50 * 1024 * 1024) {
        showToast('File is too large (max 50MB). Please contact support.', 'error');
        return;
    }

    // Validate file type
    if (!file.name.endsWith('.json')) {
        showToast('Please select a valid JSON backup file.', 'error');
        return;
    }

    if (!confirm('⚠️ IMPORTANT: This will overwrite ALL existing data!\n\nMake sure you have a current backup before proceeding.\n\nContinue with import?')) {
        return;
    }

    const reader = new FileReader();
    reader.onerror = function() {
        showToast('Failed to read file. Please try again.', 'error');
    };

    reader.onload = function(event) {
        try {
            const data = JSON.parse(event.target.result);

            // Validate backup format
            if (!data.version || !data.exportDate) {
                if (!confirm('This backup file may be from an older version or corrupted.\n\nAttempt to import anyway?')) {
                    return;
                }
            }
            let imported = false;

            // Import all data types
            if (data.events) { storage.saveEvents(data.events); imported = true; }
            if (data.members) { storage.saveMembers(data.members); imported = true; }
            if (data.birthdays) { storage.saveBirthdays(data.birthdays); imported = true; }
            if (data.announcements) { storage.saveAnnouncements(data.announcements); imported = true; }
            if (data.photos) { storage.savePhotos(data.photos); imported = true; }
            if (data.chairpersonLog) { storage.saveChairpersonLog(data.chairpersonLog); imported = true; }
            if (data.groupConscienceLog) { storage.saveGroupConscienceLog(data.groupConscienceLog); imported = true; }
            if (data.liveGCItems) { storage.saveLiveGCItems(data.liveGCItems); imported = true; }
            if (data.proposedAgendaItems) { storage.saveProposedAgendaItems(data.proposedAgendaItems); imported = true; }
            if (data.gcComments) { storage.saveGCComments(data.gcComments); imported = true; }
            if (data.gcActionItems) { storage.saveGCActionItems(data.gcActionItems); imported = true; }
            if (data.gcSettings) { storage.saveGCSettings(data.gcSettings); imported = true; }
            if (data.messages) { storage.saveMessages(data.messages); imported = true; }
            if (data.servicePositions) { storage.saveServicePositions(data.servicePositions); imported = true; }
            if (data.nominations) { storage.saveNominations(data.nominations); imported = true; }
            if (data.budgetCategories) { storage.saveBudgetCategories(data.budgetCategories); imported = true; }
            if (data.expenses) { storage.saveExpenses(data.expenses); imported = true; }
            if (data.templates) { storage.saveTemplates(data.templates); imported = true; }
            // Import new High-Impact Features data
            if (data.votingSettings) { storage.saveVotingSettings(data.votingSettings); imported = true; }
            if (data.literatureInventory) { storage.saveLiteratureInventory(data.literatureInventory); imported = true; }
            if (data.literatureLoans) { storage.saveLiteratureLoans(data.literatureLoans); imported = true; }
            if (data.serviceElections) { storage.saveServiceElections(data.serviceElections); imported = true; }
            if (data.electionBallots) { storage.saveElectionBallots(data.electionBallots); imported = true; }
            if (data.speakingQueue) { storage.saveSpeakingQueue(data.speakingQueue); imported = true; }
            if (data.motionTemplates) { storage.saveMotionTemplates(data.motionTemplates); imported = true; }
            if (data.traditionChecks) { storage.saveTraditionChecks(data.traditionChecks); imported = true; }
            if (data.budgetProposals) { storage.saveBudgetProposals(data.budgetProposals); imported = true; }
            if (data.districtMotions) { storage.saveDistrictMotions(data.districtMotions); imported = true; }
            if (data.groupPositions) { storage.saveGroupPositions(data.groupPositions); imported = true; }
            // Import Enhanced Features data
            if (data.quorumRules) { storage.saveQuorumRules(data.quorumRules); imported = true; }
            if (data.meetingMinutes) { storage.saveMeetingMinutes(data.meetingMinutes); imported = true; }
            if (data.inventorySchedules) { storage.saveInventorySchedules(data.inventorySchedules); imported = true; }
            if (data.decisionImpacts) { storage.saveDecisionImpacts(data.decisionImpacts); imported = true; }
            if (data.participationData) { storage.saveParticipationData(data.participationData); imported = true; }
            if (data.userRole) { storage.saveUserRole(data.userRole); imported = true; }
            if (data.educationalProgress) { storage.saveEducationalProgress(data.educationalProgress); imported = true; }
            // Import Privacy & Security data
            if (data.privacySettings) { storage.savePrivacySettings(data.privacySettings); imported = true; }
            if (data.accessLevels) { storage.saveAccessLevels(data.accessLevels); imported = true; }
            // Import AA-Specific Features data
            if (data.traditionOfDay) { storage.saveTraditionOfDay(data.traditionOfDay); imported = true; }
            if (data.spiritualPrinciples) { storage.saveSpiritualPrinciples(data.spiritualPrinciples); imported = true; }
            if (data.unityChecks) { storage.saveUnityChecks(data.unityChecks); imported = true; }
            if (data.minorityOpinions) { storage.saveMinorityOpinions(data.minorityOpinions); imported = true; }
            if (data.serviceStructure) { storage.saveServiceStructure(data.serviceStructure); imported = true; }
            // Import High Priority GC Features
            if (data.standingAgendaItems) { storage.saveStandingAgendaItems(data.standingAgendaItems); imported = true; }
            if (data.tabledMotions) { storage.saveTabledMotions(data.tabledMotions); imported = true; }
            if (data.motionAmendments) { storage.saveMotionAmendments(data.motionAmendments); imported = true; }
            if (data.discussionThreads) { storage.saveDiscussionThreads(data.discussionThreads); imported = true; }
            if (data.emailSettings) { storage.saveEmailSettings(data.emailSettings); imported = true; }
            if (data.emailHistory) { storage.saveEmailHistory(data.emailHistory); imported = true; }
            if (data.memberVotingRecords) { storage.saveMemberVotingRecords(data.memberVotingRecords); imported = true; }
            if (data.implementationTracking) { storage.saveImplementationTracking(data.implementationTracking); imported = true; }
            if (data.consentAgendaItems) { storage.saveConsentAgendaItems(data.consentAgendaItems); imported = true; }
            if (data.consentHistory) { storage.saveConsentHistory(data.consentHistory); imported = true; }
            // Import Medium Priority GC Features
            if (data.reconsiderationRequests) { storage.saveReconsiderationRequests(data.reconsiderationRequests); imported = true; }
            if (data.calendarEvents) { storage.saveCalendarEvents(data.calendarEvents); imported = true; }
            if (data.roiCalculations) { storage.saveROICalculations(data.roiCalculations); imported = true; }
            if (data.proxyVotes) { storage.saveProxyVotes(data.proxyVotes); imported = true; }
            if (data.decisionReversals) { storage.saveDecisionReversals(data.decisionReversals); imported = true; }

            if (imported) {
                // Store successful import timestamp
                localStorage.setItem('lastImportDate', new Date().toISOString());
                showToast('✓ Data imported successfully! The page will reload in 2 seconds...', 'success');
                setTimeout(() => location.reload(), 2000);
            } else {
                showToast('The selected file does not contain valid data to import.', 'error');
            }
        } catch (e) {
            showToast('❌ Failed to import: ' + (e.message || 'Invalid JSON format'), 'error');
            console.error('Import error:', e);
        }
    };
    reader.readAsText(file);
}

// ========== AUTO-BACKUP SYSTEM ==========
function checkAndPromptBackup() {
    try {
        const lastBackup = localStorage.getItem('lastBackupDate');
        const lastBackupDate = lastBackup ? new Date(lastBackup) : null;
        const now = new Date();

        // Prompt for backup every 7 days
        if (!lastBackupDate || (now - lastBackupDate) / (1000 * 60 * 60 * 24) >= 7) {
            const daysSinceBackup = lastBackupDate ?
                Math.floor((now - lastBackupDate) / (1000 * 60 * 60 * 24)) : 'never';

            if (confirm(`⚠️ BACKUP REMINDER\n\nLast backup: ${daysSinceBackup === 'never' ? 'Never' : daysSinceBackup + ' days ago'}\n\nWould you like to create a backup now?\n\nRecommended: Backup every 7 days to prevent data loss.`)) {
                quickBackup();
            }
        }
    } catch (e) {
        console.error('Backup check error:', e);
    }
}

function quickBackup() {
    try {
        exportData('all');
        localStorage.setItem('lastBackupDate', new Date().toISOString());
        showToast('✓ Backup created successfully! Keep this file safe.', 'success');
    } catch (e) {
        showToast('❌ Backup failed: ' + e.message, 'error');
        console.error('Backup error:', e);
    }
}

// Auto-save to sessionStorage for crash recovery
function autoSaveToSession() {
    try {
        const criticalData = {
            timestamp: new Date().toISOString(),
            members: storage.getMembers(),
            groupConscienceLog: storage.getGroupConscienceLog(),
            chairpersonLog: storage.getChairpersonLog()
        };
        sessionStorage.setItem('autoSaveBackup', JSON.stringify(criticalData));
    } catch (e) {
        console.warn('Auto-save failed:', e);
    }
}

// Check for crash recovery
function checkCrashRecovery() {
    try {
        const autoSave = sessionStorage.getItem('autoSaveBackup');
        if (autoSave) {
            const data = JSON.parse(autoSave);
            const saveTime = new Date(data.timestamp);
            const minutesAgo = (new Date() - saveTime) / 1000 / 60;

            // If auto-save is recent (within 1 hour), offer recovery
            if (minutesAgo < 60) {
                if (confirm(`🔄 CRASH RECOVERY AVAILABLE\n\nAuto-saved data found from ${minutesAgo.toFixed(0)} minutes ago.\n\nWould you like to restore it?`)) {
                    if (data.members) storage.saveMembers(data.members);
                    if (data.groupConscienceLog) storage.saveGroupConscienceLog(data.groupConscienceLog);
                    if (data.chairpersonLog) storage.saveChairpersonLog(data.chairpersonLog);
                    showToast('✓ Data restored from auto-save', 'success');
                    sessionStorage.removeItem('autoSaveBackup');
                    return true;
                }
            }
        }
    } catch (e) {
        console.error('Crash recovery check failed:', e);
    }
    return false;
}

function resetApplication() {
    // First confirmation
    if (!confirm('⚠️ WARNING: This will permanently delete ALL application data!\n\nThis includes:\n• All members and birthdays\n• All events and meetings\n• All financial records\n• All Group Conscience logs\n• All photos and announcements\n• ALL other data\n\nAre you absolutely sure you want to continue?')) {
        return;
    }

    // Second confirmation with typed verification
    const confirmText = prompt('This action CANNOT be undone!\n\nTo confirm, type "DELETE ALL DATA" exactly:');

    if (confirmText !== 'DELETE ALL DATA') {
        showToast('Reset cancelled.', 'info');
        return;
    }

    try {
        // Clear all localStorage data
        localStorage.clear();

        // Clear sessionStorage as well
        sessionStorage.clear();

        showToast('All application data has been deleted. The page will now reload.', 'success');

        // Reload the page after a short delay
        setTimeout(() => {
            location.reload();
        }, 2000);
    } catch (e) {
        showToast('Error resetting application: ' + e.message, 'error');
        console.error('Reset error:', e);
    }
}

// Update gallery display
function updateGallery() {
    const grid = document.getElementById('gallery-grid');
    const filterInput = document.getElementById('tag-filter');
    const filterValue = filterInput.value.toLowerCase().trim();
    grid.innerHTML = '';

    const photos = storage.getPhotos();
    const filteredPhotos = filterValue ? photos.filter(p => p.tags.some(tag => tag.toLowerCase().includes(filterValue))) : photos;

    filteredPhotos.forEach((photo, idx) => {
        const originalIndex = photos.findIndex(p => p.src === photo.src); // Find original index for deletion
        const wrapper = document.createElement('div');
        wrapper.style.position = 'relative';
        const img = document.createElement('img');
        img.src = photo.src;
        img.onclick = () => openModal(idx, filteredPhotos);
        wrapper.appendChild(img);
        const delBtn = document.createElement('button');
        delBtn.innerHTML = '<i class="fas fa-trash"></i>';
        delBtn.style.position = 'absolute';
        delBtn.style.top = '5px';
        delBtn.style.right = '5px';
        delBtn.style.background = 'rgba(0,0,0,0.7)';
        delBtn.style.color = 'white';
        delBtn.style.border = 'none';
        delBtn.style.borderRadius = '50%';
        delBtn.style.width = '30px';
        delBtn.style.height = '30px';
        delBtn.style.lineHeight = '30px';
        delBtn.style.textAlign = 'center';
        delBtn.style.cursor = 'pointer';
        delBtn.style.fontSize = '14px';
        delBtn.onclick = (e) => {
            e.stopPropagation(); // Prevent modal from opening
            deletePhoto(originalIndex);
        };
        wrapper.appendChild(delBtn);
        grid.appendChild(wrapper);
    });

    if (filteredPhotos.length === 0) {
        grid.innerHTML = '<p>No photos match the filter.</p>';
    }
    renderTagList();
}

function renderTagList() {
    const tagList = document.getElementById('tag-list');
    const photos = storage.getPhotos();
    const allTags = [...new Set(photos.flatMap(p => p.tags))]; // Get unique tags
    tagList.innerHTML = '';
    allTags.forEach(tag => {
        const tagEl = document.createElement('span');
        tagEl.className = 'btn secondary';
        tagEl.textContent = tag;
        tagEl.style.marginRight = '0.5rem';
        tagEl.style.marginBottom = '0.5rem';
        tagEl.style.cursor = 'pointer';
        tagEl.onclick = () => setTagFilter(tag);
        tagList.appendChild(tagEl);
    });
}

function setTagFilter(tag) {
    const filterInput = document.getElementById('tag-filter');
    filterInput.value = tag;
    updateGallery();
}
// Update home overview boxes
function updateHome() {
    const homeEvents = document.getElementById('home-upcoming-events');
    homeEvents.innerHTML = '';
    const occ = computeUpcomingOccurrences(30);
    occ.slice(0, 5).forEach(item => {
        const li = document.createElement('li');
        li.textContent = `${item.occurDate.toLocaleDateString()} ${item.occurDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} — ${item.event.title}`;
        homeEvents.appendChild(li);
    });
    if (occ.length === 0) {
        homeEvents.innerHTML = '<li>No upcoming events</li>';
    }
    const homeBirthdays = document.getElementById('home-upcoming-birthdays');
    homeBirthdays.innerHTML = '';
    const allMembers = storage.getMembers();
    const membersInWindow = getAnniversariesInWindow(allMembers, 15, 60);

    const now = new Date();
    now.setHours(0,0,0,0);

    if (membersInWindow.length > 0) {
        membersInWindow.forEach(m => {
            const li = document.createElement('li');
            const years = m.displayDate.getFullYear() - new Date(m.birthday).getFullYear();
            li.textContent = `${m.name} — ${m.displayDate.toLocaleDateString()} (${years} years)`;

            // Highlight past birthdays
            if (m.displayDate < now) {
                li.style.backgroundColor = '#6b5d2f'; // Muted yellow/gold
                li.style.padding = '2px 4px';
                li.style.borderRadius = '3px';
            }
            homeBirthdays.appendChild(li);
        });
    } else {
        homeBirthdays.innerHTML = '<li>No recent or upcoming birthdays.</li>';
    }
    const homeAnnouncements = document.getElementById('home-recent-announcements');
    homeAnnouncements.innerHTML = '';
    const activeAnnouncements = storage.getAnnouncements().filter(a => a.active).slice(0, 3);
    activeAnnouncements.forEach(a => {
        const li = document.createElement('li');
        const dateStr = new Date(a.dateCreated).toLocaleDateString();
        li.textContent = `${dateStr}: ${a.text}`;
        homeAnnouncements.appendChild(li);
    });
    if (activeAnnouncements.length === 0) {
        homeAnnouncements.innerHTML = '<li>No active announcements</li>';
    }
    const homePhotos = document.getElementById('home-latest-photos');
    homePhotos.innerHTML = '';
    const allPhotos = storage.getPhotos();
    const recentPhotos = allPhotos.slice(-Math.min(3, allPhotos.length)).reverse();
    recentPhotos.forEach(photo => {
        const img = document.createElement('img');
        img.src = photo.src;
        img.style.height = '60px';
        img.style.width = 'auto';
        img.style.borderRadius = '4px';
        img.style.cursor = 'pointer';
        const originalIndex = allPhotos.findIndex(p => p.src === photo.src);
        img.onclick = () => openModal(originalIndex, allPhotos);
        homePhotos.appendChild(img);
    });
    if (allPhotos.length === 0) {
        homePhotos.innerHTML = '<span>No photos yet</span>';
    }

    // P1: Update unified dashboard sections
    updateUnifiedDashboard();
}

// ========== P1: UNIFIED DASHBOARD FUNCTIONS ==========

function updateUnifiedDashboard() {
    updateAttentionItems();
    updateUpcomingTimeline();
    updateActivityFeed();
    updateGroupHealthMetrics();
}

function updateAttentionItems() {
    const attentionItems = [];
    const today = new Date();

    // Check service term expirations
    const positions = storage.getServicePositions();
    positions.forEach(pos => {
        if (!pos.startDate || !pos.termLength || !pos.currentHolder) return;
        const termMonths = pos.termLength === 'Indefinite' ? 0 : parseInt(pos.termLength.split(' ')[0]);
        if (termMonths === 0) return;

        const endDate = new Date(pos.startDate);
        endDate.setMonth(endDate.getMonth() + termMonths);
        const daysUntilEnd = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));

        if (daysUntilEnd > 0 && daysUntilEnd <= 30) {
            attentionItems.push({
                type: 'service-term',
                priority: daysUntilEnd <= 14 ? 'urgent' : 'high',
                title: `${pos.name} term expires in ${daysUntilEnd} days`,
                actionFn: 'goToSection(\'service-positions-section\')',
                actionText: 'Plan Succession'
            });
        }
    });

    // Check tabled motions
    const gcLogs = storage.getGroupConscienceLog();
    const tabledMotions = gcLogs.filter(log => log.status === 'tabled');
    if (tabledMotions.length > 0) {
        attentionItems.push({
            type: 'tabled-motion',
            priority: 'normal',
            title: `${tabledMotions.length} tabled motion(s) need resolution`,
            actionFn: 'goToSection(\'gc-decisions-section\')',
            actionText: 'Review Motions'
        });
    }

    // Check past-due action items
    const actionItems = storage.getGCActionItems();
    const pastDue = actionItems.filter(item => {
        return item.status !== 'completed' && new Date(item.dueDate) < today;
    });
    if (pastDue.length > 0) {
        attentionItems.push({
            type: 'action-item',
            priority: 'urgent',
            title: `${pastDue.length} action item(s) past due`,
            actionFn: 'goToSection(\'gc-decisions-section\')',
            actionText: 'Update Status'
        });
    }

    // Check prudent reserve
    const balance = parseFloat(localStorage.getItem('treasurerBalance')) || 0;
    const expenses = storage.getExpenses();
    const threeMonthsAgo = new Date();
    threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
    const recentExpenses = expenses.filter(e => new Date(e.date) >= threeMonthsAgo);
    const avgMonthlyExpenses = recentExpenses.reduce((sum, e) => sum + e.amount, 0) / 3;
    const prudentReserve = avgMonthlyExpenses * 3;

    if (balance < prudentReserve && prudentReserve > 0) {
        attentionItems.push({
            type: 'prudent-reserve',
            priority: 'high',
            title: `Prudent reserve below target ($${(prudentReserve - balance).toFixed(2)} short)`,
            actionFn: 'goToSection(\'prudent-reserve-section\')',
            actionText: 'View Details'
        });
    }

    // Check unapproved minutes
    const minutes = storage.getMeetingMinutes();
    const unapproved = minutes.filter(m => m.status !== 'approved');
    if (unapproved.length > 0) {
        attentionItems.push({
            type: 'minutes',
            priority: 'normal',
            title: `${unapproved.length} meeting minute(s) need approval`,
            actionFn: 'goToSection(\'meeting-minutes-section\')',
            actionText: 'Review & Approve'
        });
    }

    // Render attention items
    const container = document.getElementById('attention-items');
    if (attentionItems.length === 0) {
        container.innerHTML = '<p style="color: #2ecc71; padding: 1rem; text-align: center;"><i class="fas fa-check-circle"></i> All caught up! No items need immediate attention.</p>';
    } else {
        container.innerHTML = attentionItems.map(item => {
            const priorityColor = item.priority === 'urgent' ? '#e74c3c' : item.priority === 'high' ? '#f39c12' : '#3498db';
            return `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #2c3e50; border-radius: 4px; margin-bottom: 0.5rem; border-left: 4px solid ${priorityColor};">
                    <div style="flex: 1;">
                        <div style="font-weight: bold; color: ${priorityColor};">${escapeHtml(item.title)}</div>
                        <div style="font-size: 0.85rem; opacity: 0.7; margin-top: 0.25rem;">${escapeHtml(item.type.replace('-', ' ').toUpperCase())}</div>
                    </div>
                    <button class="btn" onclick="${item.actionFn}" style="background: ${priorityColor}; white-space: nowrap;">
                        ${escapeHtml(item.actionText)}
                    </button>
                </div>
            `;
        }).join('');
    }
}

function updateUpcomingTimeline() {
    const container = document.getElementById('upcoming-timeline');
    const timeline = [];
    const today = new Date();
    const thirtyDaysFromNow = new Date(today);
    thirtyDaysFromNow.setDate(today.getDate() + 30);

    // Upcoming events
    const events = storage.getEvents();
    events.forEach(event => {
        if (event.date) {
            const eventDate = new Date(event.date + 'T' + (event.time || '00:00'));
            if (eventDate >= today && eventDate <= thirtyDaysFromNow) {
                timeline.push({
                    date: eventDate,
                    type: 'Event',
                    icon: 'fa-calendar',
                    title: event.title,
                    color: '#3498db'
                });
            }
        }
    });

    // Service position elections
    const positions = storage.getServicePositions();
    positions.forEach(pos => {
        if (pos.startDate && pos.termLength && pos.termLength !== 'Indefinite') {
            const endDate = new Date(pos.startDate);
            const termMonths = parseInt(pos.termLength.split(' ')[0]);
            endDate.setMonth(endDate.getMonth() + termMonths);

            if (endDate >= today && endDate <= thirtyDaysFromNow) {
                timeline.push({
                    date: endDate,
                    type: 'Service Term End',
                    icon: 'fa-users-cog',
                    title: `${pos.name} term expires`,
                    color: '#e74c3c'
                });
            }
        }
    });

    // Sort by date
    timeline.sort((a, b) => a.date - b.date);

    if (timeline.length === 0) {
        container.innerHTML = '<p style="padding: 1rem; text-align: center; opacity: 0.7;">No upcoming events in the next 30 days</p>';
    } else {
        container.innerHTML = timeline.map(item => `
            <div style="display: flex; align-items: center; padding: 0.75rem; background: #2c3e50; border-radius: 4px; margin-bottom: 0.5rem; border-left: 3px solid ${item.color};">
                <i class="fas ${item.icon}" style="font-size: 1.5rem; color: ${item.color}; margin-right: 1rem;"></i>
                <div style="flex: 1;">
                    <div style="font-weight: bold;">${escapeHtml(item.title)}</div>
                    <div style="font-size: 0.85rem; opacity: 0.7;">${item.date.toLocaleDateString()} • ${item.type}</div>
                </div>
            </div>
        `).join('');
    }
}

function updateActivityFeed() {
    const container = document.getElementById('activity-feed');
    const activities = [];

    // Get recent audit entries (last 10)
    const auditEntries = getAuditHistory(null, null, 10);

    auditEntries.forEach(entry => {
        let icon = 'fa-circle';
        let color = '#3498db';

        if (entry.action === 'create') {
            icon = 'fa-plus-circle';
            color = '#2ecc71';
        } else if (entry.action === 'edit') {
            icon = 'fa-edit';
            color = '#f39c12';
        } else if (entry.action === 'delete') {
            icon = 'fa-trash';
            color = '#e74c3c';
        }

        activities.push({
            timestamp: new Date(entry.timestamp),
            icon: icon,
            color: color,
            text: `${entry.user} ${entry.action}d ${entry.entityType}`,
            details: entry.reason || ''
        });
    });

    if (activities.length === 0) {
        container.innerHTML = '<p style="padding: 1rem; text-align: center; opacity: 0.7;">No recent activity</p>';
    } else {
        container.innerHTML = activities.map(activity => `
            <div style="display: flex; align-items: start; padding: 0.5rem; margin-bottom: 0.5rem;">
                <i class="fas ${activity.icon}" style="font-size: 1rem; color: ${activity.color}; margin-right: 0.75rem; margin-top: 0.25rem;"></i>
                <div style="flex: 1;">
                    <div style="font-size: 0.95rem;">${escapeHtml(activity.text)}</div>
                    <div style="font-size: 0.8rem; opacity: 0.6;">${activity.timestamp.toLocaleString()}</div>
                </div>
            </div>
        `).join('');
    }
}

// ===== GROUP HEALTH METRICS DASHBOARD =====

function updateGroupHealthMetrics() {
    calculateParticipationRate();
    calculateConsensusRate();
    calculateActionCompletionRate();
    calculateServiceFilledRate();
    calculatePrudentReserveStatus();
    calculateAverageAttendance();
    updateHealthTrends();
}

function calculateParticipationRate() {
    const members = storage.getMembers();
    const gcLogs = storage.getGroupConscienceLog();

    // Last 3 months
    const threeMonthsAgo = new Date();
    threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);

    const recentGCs = gcLogs.filter(log => new Date(log.date) >= threeMonthsAgo);

    if (recentGCs.length === 0 || members.length === 0) {
        document.getElementById('participation-rate').textContent = 'N/A';
        return;
    }

    // Calculate unique members who participated
    const uniqueParticipants = new Set();
    recentGCs.forEach(log => {
        if (Array.isArray(log.attendees)) {
            log.attendees.forEach(name => uniqueParticipants.add(name));
        }
    });

    const participationRate = ((uniqueParticipants.size / members.length) * 100).toFixed(0);
    document.getElementById('participation-rate').textContent = participationRate + '%';
}

function calculateConsensusRate() {
    const gcLogs = storage.getGroupConscienceLog();

    // Last 3 months
    const threeMonthsAgo = new Date();
    threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);

    const recentDecisions = gcLogs.filter(log =>
        new Date(log.date) >= threeMonthsAgo && log.outcome === 'passed'
    );

    if (recentDecisions.length === 0) {
        document.getElementById('consensus-rate').textContent = 'N/A';
        return;
    }

    // Count how many achieved substantial unanimity (2/3 or more)
    const consensusDecisions = recentDecisions.filter(log => {
        const votesFor = log.votesFor || 0;
        const votesAgainst = log.votesAgainst || 0;
        const totalVotes = votesFor + votesAgainst;

        if (totalVotes === 0) return false;

        const percentFor = (votesFor / totalVotes) * 100;
        return percentFor >= 66.7; // Substantial unanimity (2/3)
    });

    const consensusRate = ((consensusDecisions.length / recentDecisions.length) * 100).toFixed(0);
    document.getElementById('consensus-rate').textContent = consensusRate + '%';
}

function calculateActionCompletionRate() {
    const actions = storage.getGCActionItems();

    // Actions created in last 3 months
    const threeMonthsAgo = new Date();
    threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);

    const recentActions = actions.filter(action =>
        new Date(action.createdDate) >= threeMonthsAgo
    );

    if (recentActions.length === 0) {
        document.getElementById('action-completion-rate').textContent = 'N/A';
        return;
    }

    // Count completed actions that were done on-time or early
    const completedOnTime = recentActions.filter(action => {
        if (action.status !== 'completed' || !action.completedDate) return false;

        const dueDate = new Date(action.dueDate);
        const completedDate = new Date(action.completedDate);

        return completedDate <= dueDate;
    });

    const completionRate = ((completedOnTime.length / recentActions.length) * 100).toFixed(0);
    document.getElementById('action-completion-rate').textContent = completionRate + '%';
}

function calculateServiceFilledRate() {
    const positions = storage.getServicePositions();

    if (positions.length === 0) {
        document.getElementById('service-filled-rate').textContent = 'N/A';
        return;
    }

    const filledPositions = positions.filter(pos => pos.currentHolder && pos.currentHolder.trim() !== '');
    const filledRate = ((filledPositions.length / positions.length) * 100).toFixed(0);

    document.getElementById('service-filled-rate').textContent = filledRate + '%';
}

function calculatePrudentReserveStatus() {
    const balance = parseFloat(localStorage.getItem('treasurerBalance')) || 0;
    const expenses = storage.getExpenses();

    // Calculate average monthly expenses (last 3 months)
    const threeMonthsAgo = new Date();
    threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);

    const recentExpenses = expenses.filter(exp => new Date(exp.date) >= threeMonthsAgo);
    const totalExpenses = recentExpenses.reduce((sum, exp) => sum + exp.amount, 0);
    const monthlyAverage = totalExpenses / 3;

    if (monthlyAverage === 0) {
        document.getElementById('prudent-reserve-status').textContent = 'N/A';
        return;
    }

    const monthsOfReserve = balance / monthlyAverage;
    const statusEl = document.getElementById('prudent-reserve-status');

    if (monthsOfReserve >= 3) {
        statusEl.textContent = 'Healthy';
        statusEl.style.color = '#2ecc71';
    } else if (monthsOfReserve >= 2) {
        statusEl.textContent = 'Fair';
        statusEl.style.color = '#f39c12';
    } else {
        statusEl.textContent = 'Low';
        statusEl.style.color = '#e74c3c';
    }
}

function calculateAverageAttendance() {
    const chairpersonLogs = storage.getChairpersonLog();

    // Last 3 months
    const threeMonthsAgo = new Date();
    threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);

    const recentLogs = chairpersonLogs.filter(log => new Date(log.date) >= threeMonthsAgo);

    if (recentLogs.length === 0) {
        document.getElementById('avg-attendance').textContent = 'N/A';
        return;
    }

    const totalAttendance = recentLogs.reduce((sum, log) => sum + (log.attendance || 0), 0);
    const average = Math.round(totalAttendance / recentLogs.length);

    document.getElementById('avg-attendance').textContent = average;
}

function updateHealthTrends() {
    const container = document.getElementById('health-trends');
    const trends = [];

    // Analyze trends
    const members = storage.getMembers().length;
    const gcLogs = storage.getGroupConscienceLog();
    const actions = storage.getGCActionItems();
    const positions = storage.getServicePositions();

    // GC Activity Trend
    const lastMonth = new Date();
    lastMonth.setMonth(lastMonth.getMonth() - 1);
    const recentGCs = gcLogs.filter(log => new Date(log.date) >= lastMonth).length;

    if (recentGCs === 0) {
        trends.push({
            icon: 'fa-exclamation-triangle',
            color: '#e74c3c',
            text: 'No GC meetings in the last month - Consider scheduling one',
            action: 'goToSection(\'gc-decisions-section\')',
            actionText: 'Schedule GC'
        });
    } else if (recentGCs >= 2) {
        trends.push({
            icon: 'fa-check-circle',
            color: '#2ecc71',
            text: `${recentGCs} GC meeting(s) held last month - Strong group conscience activity`,
            action: null,
            actionText: null
        });
    }

    // Overdue Action Items
    const today = new Date().toISOString().split('T')[0];
    const overdueActions = actions.filter(a => a.dueDate < today && a.status !== 'completed').length;

    if (overdueActions > 0) {
        trends.push({
            icon: 'fa-tasks',
            color: '#e74c3c',
            text: `${overdueActions} action item(s) overdue - Follow-through needed`,
            action: 'goToSection(\'gc-decisions-section\')',
            actionText: 'View Actions'
        });
    }

    // Service Position Vacancies
    const vacantPositions = positions.filter(p => !p.currentHolder || p.currentHolder.trim() === '');

    if (vacantPositions.length > 0) {
        trends.push({
            icon: 'fa-user-tie',
            color: '#f39c12',
            text: `${vacantPositions.length} service position(s) vacant - ${vacantPositions.map(p => p.name).join(', ')}`,
            action: 'goToSection(\'service-positions-section\')',
            actionText: 'Fill Positions'
        });
    }

    // Financial Health Check
    const balance = parseFloat(localStorage.getItem('treasurerBalance')) || 0;
    const expenses = storage.getExpenses();
    const threeMonthsAgo = new Date();
    threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
    const recentExpenses = expenses.filter(exp => new Date(exp.date) >= threeMonthsAgo);
    const totalExpenses = recentExpenses.reduce((sum, exp) => sum + exp.amount, 0);
    const monthlyAverage = totalExpenses / 3;
    const monthsOfReserve = monthlyAverage > 0 ? balance / monthlyAverage : 0;

    if (monthsOfReserve < 2) {
        trends.push({
            icon: 'fa-dollar-sign',
            color: '#e74c3c',
            text: `Prudent reserve below 2 months - Current: ${monthsOfReserve.toFixed(1)} months`,
            action: 'goToSection(\'finance-section\')',
            actionText: 'Review Finances'
        });
    }

    // Display trends
    if (trends.length === 0) {
        container.innerHTML = '<p style="padding: 1rem; text-align: center; color: #2ecc71;"><i class="fas fa-check-circle"></i> All health indicators looking good!</p>';
    } else {
        container.innerHTML = trends.map(trend => `
            <div style="display: flex; align-items: center; padding: 0.75rem; background: #2c3e50; border-radius: 4px; margin-bottom: 0.5rem; border-left: 4px solid ${trend.color};">
                <i class="fas ${trend.icon}" style="font-size: 1.2rem; color: ${trend.color}; margin-right: 1rem;"></i>
                <div style="flex: 1; font-size: 0.95rem;">${escapeHtml(trend.text)}</div>
                ${trend.action ? `<button class="btn" onclick="${trend.action}" style="background: ${trend.color}; white-space: nowrap; margin-left: 1rem; font-size: 0.85rem; padding: 0.4rem 0.8rem;">${trend.actionText}</button>` : ''}
            </div>
        `).join('');
    }
}

function viewDetailedHealthReport() {
    const members = storage.getMembers();
    const gcLogs = storage.getGroupConscienceLog();
    const actions = storage.getGCActionItems();
    const positions = storage.getServicePositions();
    const expenses = storage.getExpenses();
    const chairpersonLogs = storage.getChairpersonLog();

    // Calculate all metrics in detail
    const threeMonthsAgo = new Date();
    threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);

    // Participation details
    const recentGCs = gcLogs.filter(log => new Date(log.date) >= threeMonthsAgo);
    const uniqueParticipants = new Set();
    recentGCs.forEach(log => {
        if (Array.isArray(log.attendees)) {
            log.attendees.forEach(name => uniqueParticipants.add(name));
        }
    });

    // Inactive members
    const inactiveMembers = members.filter(m => !uniqueParticipants.has(m.name));

    // Financial trends
    const recentExpenses = expenses.filter(exp => new Date(exp.date) >= threeMonthsAgo);
    const totalExpenses = recentExpenses.reduce((sum, exp) => sum + exp.amount, 0);
    const monthlyAverage = totalExpenses / 3;
    const balance = parseFloat(localStorage.getItem('treasurerBalance')) || 0;

    // Attendance trends
    const recentAttendance = chairpersonLogs.filter(log => new Date(log.date) >= threeMonthsAgo);
    const avgAttendance = recentAttendance.length > 0 ?
        Math.round(recentAttendance.reduce((sum, log) => sum + (log.attendance || 0), 0) / recentAttendance.length) : 0;

    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; overflow-y: auto;';
    modal.innerHTML = `
        <div style="background: #34495e; padding: 2rem; border-radius: 8px; max-width: 1000px; width: 90%; max-height: 90vh; overflow-y: auto; margin: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="margin: 0;"><i class="fas fa-heartbeat"></i> Detailed Group Health Report</h3>
                <button onclick="this.closest('div[style*=fixed]').remove()" class="btn secondary">Close</button>
            </div>

            <!-- Executive Summary -->
            <div style="background: #2c3e50; padding: 1.5rem; border-radius: 4px; border-left: 4px solid #2ecc71; margin-bottom: 1.5rem;">
                <h4 style="margin-top: 0;">Executive Summary (Last 3 Months)</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <div style="opacity: 0.7; font-size: 0.85rem;">Total Members:</div>
                        <div style="font-size: 1.2rem; font-weight: bold;">${members.length}</div>
                    </div>
                    <div>
                        <div style="opacity: 0.7; font-size: 0.85rem;">GC Meetings Held:</div>
                        <div style="font-size: 1.2rem; font-weight: bold;">${recentGCs.length}</div>
                    </div>
                    <div>
                        <div style="opacity: 0.7; font-size: 0.85rem;">Active Participants:</div>
                        <div style="font-size: 1.2rem; font-weight: bold;">${uniqueParticipants.size} (${members.length > 0 ? ((uniqueParticipants.size / members.length) * 100).toFixed(0) : 0}%)</div>
                    </div>
                    <div>
                        <div style="opacity: 0.7; font-size: 0.85rem;">Avg. Attendance:</div>
                        <div style="font-size: 1.2rem; font-weight: bold;">${avgAttendance} members/meeting</div>
                    </div>
                    <div>
                        <div style="opacity: 0.7; font-size: 0.85rem;">Current Balance:</div>
                        <div style="font-size: 1.2rem; font-weight: bold;">$${balance.toFixed(2)}</div>
                    </div>
                    <div>
                        <div style="opacity: 0.7; font-size: 0.85rem;">Prudent Reserve:</div>
                        <div style="font-size: 1.2rem; font-weight: bold;">${monthlyAverage > 0 ? (balance / monthlyAverage).toFixed(1) : 'N/A'} months</div>
                    </div>
                </div>
            </div>

            <!-- Areas of Concern -->
            ${inactiveMembers.length > 0 ? `
            <div style="background: #2c3e50; padding: 1.5rem; border-radius: 4px; border-left: 4px solid #f39c12; margin-bottom: 1.5rem;">
                <h4 style="margin-top: 0;"><i class="fas fa-exclamation-triangle"></i> Inactive Members (${inactiveMembers.length})</h4>
                <div style="opacity: 0.9;">
                    ${inactiveMembers.slice(0, 10).map(m => `<span style="display: inline-block; padding: 0.25rem 0.5rem; background: #34495e; border-radius: 4px; margin: 0.25rem;">${escapeHtml(m.name)}</span>`).join('')}
                    ${inactiveMembers.length > 10 ? `<span style="opacity: 0.7;">... and ${inactiveMembers.length - 10} more</span>` : ''}
                </div>
                <div style="margin-top: 0.75rem; font-size: 0.9rem; opacity: 0.8;">
                    <i class="fas fa-info-circle"></i> Consider reaching out to these members to encourage participation
                </div>
            </div>
            ` : ''}

            <!-- Recommendations -->
            <div style="background: #2c3e50; padding: 1.5rem; border-radius: 4px; border-left: 4px solid #3498db;">
                <h4 style="margin-top: 0;"><i class="fas fa-lightbulb"></i> Recommendations</h4>
                <ul style="margin: 0; padding-left: 1.5rem;">
                    ${uniqueParticipants.size < members.length * 0.5 ? '<li>Participation below 50% - Consider more engaging topics or different meeting times</li>' : ''}
                    ${monthlyAverage > 0 && balance / monthlyAverage < 2 ? '<li>Prudent reserve below recommended 3 months - Increase 7th tradition emphasis</li>' : ''}
                    ${positions.filter(p => !p.currentHolder).length > 0 ? '<li>Fill vacant service positions to ensure group sustainability</li>' : ''}
                    ${recentGCs.length === 0 ? '<li>No GC meetings in last 3 months - Schedule regular group conscience</li>' : ''}
                    ${recentGCs.length > 0 && recentGCs.length < 3 ? '<li>Consider holding monthly GC meetings for better group health</li>' : ''}
                </ul>
            </div>

            <div style="margin-top: 1.5rem; padding: 1rem; background: #2c3e50; border-radius: 4px; font-size: 0.9rem; opacity: 0.8;">
                <i class="fas fa-info-circle"></i> This report analyzes the last 3 months of group data.
                Regular review of these metrics helps maintain a healthy, functioning group.
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// History display: show selected timeline and hide others
function showHistory(id) {
    document.querySelectorAll('.history-content').forEach(sec => sec.classList.remove('active'));
    const target = document.getElementById(id);
    if (target) target.classList.add('active');
    document.querySelectorAll('.history-nav button').forEach(btn => btn.classList.remove('active'));
    if (id === 'genesis-history') document.getElementById('genesis-btn').classList.add('active');
    if (id === 'dfw-history') document.getElementById('dfw-btn').classList.add('active');
    if (id === 'rowlett-history') document.getElementById('rowlett-btn').classList.add('active');
}
// Calendar: state for current month
const categoryColors = {
    "General": "#7f8c8d",
    "Open Discussion": "#2ecc71",
    "Closed Discussion": "#e74c3c",
    "Big Book Study": "#f1c40f",
    "12x12 Study": "#9b59b6",
    "Personal Story": "#1abc9c",
    "Foundations Speaker": "#d35400",
    "Birthday Night": "#e67e22"
};
let currentMonthDate = new Date();
currentMonthDate.setDate(1);
function renderCalendar() {
    const grid = document.getElementById('calendar-grid');
    if (!grid) return;
    grid.innerHTML = '';
    const year = currentMonthDate.getFullYear();
    const month = currentMonthDate.getMonth();
    const monthName = currentMonthDate.toLocaleString('default', { month: 'long', year: 'numeric' });
    document.getElementById('calendar-month-year').textContent = monthName;
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    dayNames.forEach(name => {
        const div = document.createElement('div');
        div.className = 'calendar-day-name';
        div.textContent = name;
        grid.appendChild(div);
    });
    for (let i = 0; i < firstDay; i++) {
        const blank = document.createElement('div');
        blank.className = 'calendar-day';
        blank.style.visibility = 'hidden';
        grid.appendChild(blank);
    }
    for (let d = 1; d <= daysInMonth; d++) {
        const date = new Date(year, month, d);
        const cell = document.createElement('div');
        cell.className = 'calendar-day';
        const num = document.createElement('div');
        num.className = 'calendar-day-number';
        num.textContent = d;
        cell.appendChild(num);
        const events = storage.getEvents();
        events.forEach(ev => {
            let occurs = false;
            if (ev.date) {
                if (ev.date === date.toISOString().substring(0,10)) occurs = true;
            } else if (ev.dayOfWeek !== null && ev.dayOfWeek !== undefined) {
                if (date.getDay() === ev.dayOfWeek) occurs = true;
            }
            if (occurs) {
                const evEl = document.createElement('div');
                evEl.className = 'calendar-event';
                evEl.textContent = ev.title;
                evEl.style.borderLeftColor = categoryColors[ev.category] || categoryColors['General'];

                const tooltip = document.createElement('div');
                tooltip.className = 'tooltip';
                let tooltipContent = `<strong>${escapeHtml(ev.title)}</strong><br>`;
                try {
                    const eventTime = new Date('1970-01-01T' + (ev.time || '00:00'));
                    tooltipContent += `Time: ${eventTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}<br>`;
                } catch(e) { /* Ignore invalid time format */ }
                if (ev.speaker) tooltipContent += `Speaker: ${escapeHtml(ev.speaker)}<br>`;
                if (ev.chair) tooltipContent += `Chair: ${escapeHtml(ev.chair)}<br>`;
                if (ev.description) tooltipContent += `Description: ${escapeHtml(ev.description)}`;
                tooltip.innerHTML = tooltipContent;
                evEl.appendChild(tooltip);

                cell.appendChild(evEl);
            }
        });
        grid.appendChild(cell);
    }
    const totalCells = dayNames.length + firstDay + daysInMonth;
    const remainder = totalCells % 7;
    if (remainder !== 0) {
        for (let i = 0; i < 7 - remainder; i++) {
            const blank = document.createElement('div');
            blank.className = 'calendar-day';
            blank.style.visibility = 'hidden';
            grid.appendChild(blank);
        }
    }
}
// Track if event listeners have been initialized to prevent duplicates
let calendarNavInitialized = false;
let mainNavInitialized = false;
let dictionaryInitialized = false;

function initCalendarNav() {
    if (calendarNavInitialized) return;

    const prevBtn = document.getElementById('prev-month-btn');
    const nextBtn = document.getElementById('next-month-btn');
    if (prevBtn) {
        prevBtn.addEventListener('click', () => {
            currentMonthDate.setMonth(currentMonthDate.getMonth() - 1);
            renderCalendar();
        });
    }
    if (nextBtn) {
        nextBtn.addEventListener('click', () => {
            currentMonthDate.setMonth(currentMonthDate.getMonth() + 1);
            renderCalendar();
        });
    }
    calendarNavInitialized = true;
}
// Navigation click handlers
function initNav() {
    if (mainNavInitialized) return;

    // Handle clicks on menu items with sections
    document.querySelectorAll('nav li[data-section]').forEach(li => {
        li.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent event bubbling to parent dropdown
            const target = li.getAttribute('data-section');
            if (target) {
                goToSection(target);
                // Close all dropdowns after navigation
                document.querySelectorAll('nav li.has-dropdown').forEach(dd => {
                    dd.classList.remove('dropdown-open');
                });
            }
        });
    });

    // Handle clicks on dropdown parent items to toggle open/close
    document.querySelectorAll('nav li.has-dropdown').forEach(parent => {
        parent.addEventListener('click', (e) => {
            // Only toggle if clicking on the parent itself, not dropdown children
            if (e.target === parent || (!e.target.hasAttribute('data-section') && e.target.closest('.has-dropdown') === parent)) {
                e.stopPropagation();
                // Close other dropdowns
                document.querySelectorAll('nav li.has-dropdown').forEach(dd => {
                    if (dd !== parent) {
                        dd.classList.remove('dropdown-open');
                    }
                });
                // Toggle this dropdown
                parent.classList.toggle('dropdown-open');
            }
        });
    });

    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
        if (!e.target.closest('nav')) {
            document.querySelectorAll('nav li.has-dropdown').forEach(dd => {
                dd.classList.remove('dropdown-open');
            });
        }
    });

    mainNavInitialized = true;
}

function initDictionary() {
    if (dictionaryInitialized) return;

    const searchBtn = document.getElementById('dictionary-search-btn');
    const searchInput = document.getElementById('dictionary-search-word');
    if (searchBtn) {
        searchBtn.addEventListener('click', searchDictionary);
    }
    if (searchInput) {
        searchInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                searchDictionary();
            }
        });
    }
    dictionaryInitialized = true;
}
// Meeting Companion: format data and display logic
const contentData = {
    'open-discussion': {
        title: 'Open Discussion Meeting',
        content: [
            { type: 'p', text: '<strong>Chairperson opens the meeting:</strong> "Welcome to the Rowlett Group of Alcoholics Anonymous. My name is ___, and I am an alcoholic."' },
            { type: 'p', text: 'Moment of silence, followed by the Serenity Prayer.' },
            { type: 'p', text: 'Read "How It Works" from Chapter 5 of the Big Book.' },
            { type: 'p', text: 'Acknowledge newcomers and visitors.' },
            { type: 'p', text: 'Introduce the topic for discussion. (e.g., a Step, a Tradition, a reading from AA literature, or a general topic related to recovery).' },
            { type: 'p', text: 'Facilitate sharing, ensuring everyone who wants to share has the opportunity.' },
            { type: 'p', text: 'Close with the Lord\'s Prayer or the Responsibility Declaration.' }
        ]
    },
    'closed-discussion': {
        title: 'Closed Discussion Meeting (for alcoholics only)',
        content: [
            { type: 'p', text: '<strong>Chairperson opens the meeting:</strong> "Welcome to the Rowlett Group of Alcoholics Anonymous. This is a closed meeting, for alcoholics or those who have a desire to stop drinking. My name is ___, and I am an alcoholic."' },
            { type: 'p', text: 'Moment of silence, followed by the Serenity Prayer.' },
            { type: 'p', text: 'Read "How It Works" and the Twelve Traditions.' },
            { type: 'p', text: 'Acknowledge newcomers.' },
            { type: 'p', text: 'Introduce the topic, often focusing on more in-depth aspects of the Steps, Traditions, or personal recovery challenges.' },
            { type: 'p', text: 'Facilitate sharing in a safe, closed environment.' },
            { type: 'p', text: 'Close with the Lord\'s Prayer or the Responsibility Declaration.' }
        ]
    },
    'big-book': {
        title: 'Big Book Study',
        content: [
            { type: 'p', text: '<strong>Chairperson opens the meeting:</strong> "Welcome to the Big Book study of the Rowlett Group. My name is ___, and I am an alcoholic."' },
            { type: 'p', text: 'Moment of silence, followed by the Serenity Prayer.' },
            { type: 'p', text: 'Read a chapter or section from the book "Alcoholics Anonymous."' },
            { type: 'p', text: 'The reader or chairperson may pause to allow for comments or questions, or discussion may follow the reading.' },
            { type: 'p', text: 'Focus is on understanding the text and applying it to personal recovery.' },
            { type: 'p', text: 'Close with the Lord\'s Prayer or the Responsibility Declaration.' }
        ]
    },
    '12x12': {
        title: '12 Steps and 12 Traditions Study',
        content: [
            { type: 'p', text: '<strong>Chairperson opens the meeting:</strong> "Welcome to the 12 & 12 study of the Rowlett Group. My name is ___, and I am an alcoholic."' },
            { type: 'p', text: 'Moment of silence, followed by the Serenity Prayer.' },
            { type: 'p', text: 'Read a Step or Tradition from the book "Twelve Steps and Twelve Traditions."' },
            { type: 'p', text: 'Discussion focuses on the selected Step or Tradition, its meaning, and its application in members\' lives.' },
            { type: 'p', text: 'Close with the Lord\'s Prayer or the Responsibility Declaration.' }
        ]
    },
    'personal-story': {
        title: 'Personal Story Speaker Meeting',
        content: [
            { type: 'p', text: '<strong>Chairperson opens the meeting:</strong> "Welcome to the Rowlett Group of Alcoholics Anonymous. My name is ___, and I am an alcoholic."' },
            { type: 'p', text: 'Moment of silence and Serenity Prayer.' },
            { type: 'p', text: 'Read "How It Works."' },
            { type: 'p', text: 'Introduce the speaker. The speaker shares their experience, strength, and hope: what it was like, what happened, and what it\'s like now.' },
            { type: 'p', text: 'Sharing is typically for a set amount of time (e.g., 20-30 minutes).' },
            { type: 'p', text: 'After the speaker, the meeting may open for brief sharing or proceed to closing.' },
            { type: 'p', text: 'Close with the Lord\'s Prayer or the Responsibility Declaration.' }
        ]
    },
    'foundations': {
        title: 'Foundations Speaker Meeting',
        content: [
            { type: 'p', text: '<strong>Chairperson opens the meeting:</strong> "Welcome to the Foundations meeting of the Rowlett Group. My name is ___, and I am an alcoholic."' },
            { type: 'p', text: 'Moment of silence and Serenity Prayer.' },
            { type: 'p', text: 'Introduce the speaker, who will share on a foundational aspect of AA recovery (e.g., Sponsorship, Service, Home Group, a specific Step).' },
            { type: 'p', text: 'The speaker\'s share is the main focus of the meeting.' },
            { type: 'p', text: 'Close with the Lord\'s Prayer or the Responsibility Declaration.' }
        ]
    },
    'birthday': {
        title: 'Birthday Night Meeting',
        content: [
            { type: 'p', text: '<strong>Chairperson opens the meeting:</strong> "Welcome to the Birthday Night celebration of the Rowlett Group. My name is ___, and I am an alcoholic."' },
            { type: 'p', text: 'Moment of silence and Serenity Prayer.' },
            { type: 'p', text: 'Acknowledge members celebrating a sobriety anniversary this month.' },
            { type: 'p', text: 'Invite each person up to receive a chip. They may share briefly on their recovery.' },
            { type: 'p', text: 'The group celebrates their milestones.' },
            { type: 'p', text: 'Close with the Serenity Prayer, often holding hands in a circle.' }
        ]
    },
    'how-it-works': {
        title: 'How It Works',
        content: [
            { type: 'p', text: 'RARELY HAVE we seen a person fail who has thoroughly followed our path. Those who do not recover are people who cannot or will not completely give themselves to this simple program, usually men and women who are constitutionally incapable of being honest with themselves. There are such unfortunates. They are not at fault; they seem to have been born that way. They are naturally incapable of grasping and developing a manner of living which demands rigorous honesty. Their chances are less than average. There are those, too, who suffer from grave emotional and mental disorders, but many of them do recover if they have the capacity to be honest.' },
            { type: 'p', text: 'Our stories disclose in a general way what we used to be like, what happened, and what we are like now. If you have decided you want what we have and are willing to go to any length to get it-then you are ready to take certain steps.' },
            { type: 'p', text: 'At some of these we balked. We thought we could find an easier, softer way. But we could not. With all the earnestness at our command, we beg of you to be fearless and thorough from the very start. Some of us have tried to hold on to our old ideas and the result was nil until we let go absolutely.' },
            { type: 'p', text: 'Remember that we deal with alcohol - cunning, baffling, powerful! Without help it is too much for us. But there is One who has all power-that One is God. May you find Him now!' },
            { type: 'p', text: 'Half measures availed us nothing. We stood at the turning point. We asked His protection and care with complete abandon.' },
            { type: 'p', text: 'Here are the steps we took, which are suggested as a program of recovery:' },
            { type: 'ol', items: [
                'We admitted we were powerless over alcohol - that our lives had become unmanageable.',
                'Came to believe that a Power greater than ourselves could restore us to sanity.',
                'Made a decision to turn our will and our lives over to the care of God as we understood Him.',
                'Made a searching and fearless moral inventory of ourselves.',
                'Admitted to God, to ourselves and to another human being the exact nature of our wrongs.',
                'Were entirely ready to have God remove all these defects of character.',
                'Humbly asked Him to remove our shortcomings.',
                'Made a list of all persons we had harmed, and became willing to make amends to them all.',
                'Made direct amends to such people wherever possible, except when to do so would injure them or others.',
                'Continued to take personal inventory and when we were wrong promptly admitted it.',
                'Sought through prayer and meditation to improve our conscious contact with God as we understood Him, praying only for knowledge of His will for us and the power to carry that out.',
                'Having had a spiritual awakening as the result of these steps, we tried to carry this message to alcoholics and to practice these principles in all our affairs.'
            ]},
            { type: 'p', text: 'Many of us exclaimed, "What an order! I can\'t go through with it." Do not be discouraged. No one among us has been able to maintain anything like perfect adherence to these principles. We are not saints. The point is, that we are willing to grow along spiritual lines. The principles we have set down are guides to progress. We claim spiritual progress rather than spiritual perfection.' },
            { type: 'p', text: 'Our description of the alcoholic, the chapter to the agnostic, and our personal adventures before and after make clear three pertinent ideas:' },
            { type: 'ul', items: [
                'a. That we were alcoholic and could not manage our own lives.',
                'b. That probably no human power could have relieved our alcoholism.',
                'c. That God could and would if He were sought.'
            ]}
        ]
    },
    'traditions': {
        title: 'The Twelve Traditions',
        content: [
            { type: 'ol', items: [
                'Our common welfare should come first; personal recovery depends upon A.A. unity.',
                'For our group purpose there is but one ultimate authority — a loving God as He may express Himself in our group conscience. Our leaders are but trusted servants; they do not govern.',
                'The only requirement for A.A. membership is a desire to stop drinking.',
                'Each group should be autonomous except in matters affecting other groups or A.A. as a whole.',
                'Each group has but one primary purpose — to carry its message to the alcoholic who still suffers.',
                'An A.A. group ought never endorse, finance, or lend the A.A. name to any related facility or outside enterprise, lest problems of money, property, and prestige divert us from our primary purpose.',
                'Every A.A. group ought to be fully self-supporting, declining outside contributions.',
                'Alcoholics Anonymous should remain forever non-professional, but our service centers may employ special workers.',
                'A.A., as such, ought never be organized; but we may create service boards or committees directly responsible to those they serve.',
                'Alcoholics Anonymous has no opinion on outside issues; hence the A.A. name ought never be drawn into public controversy.',
                'Our public relations policy is based on attraction rather than promotion; we need always maintain personal anonymity at the level of press, radio, and films.',
                'Anonymity is the spiritual foundation of all our traditions, ever reminding us to place principles before personalities.'
            ]}
        ]
    },
    'promises': {
        title: 'The 9th Step Promises',
        content: [
            { type: 'p', text: 'If we are painstaking about this phase of our development, we will be amazed before we are halfway through. We are going to know a new freedom and a new happiness. We will not regret the past nor wish to shut the door on it. We will comprehend the word serenity and we will know peace. No matter how far down the scale we have gone, we will see how our experience can benefit others. That feeling of uselessness and self pity will disappear. We will lose interest in selfish things and gain interest in our fellows. Self seeking will slip away. Our whole attitude and outlook upon life will change. Fear of a Meda and of economic insecurity will leave us. We will intuitively know how to handle situations which used to baffle us. We will suddenly realize that God is doing for us what we could not do for ourselves.' },
            { type: 'p', text: 'Are these extravagant promises? We think not! They are being fulfilled among us – Sometimes quickly, sometimes slowly. They will always materialize if we work for them.' }
        ]
    }
};

function renderMeetingFormat(data) {
    if (!data) return '';
    let html = `<h3>${data.title}</h3>`;
    data.content.forEach(item => {
        if (item.type === 'p') {
            html += `<p>${item.text}</p>`;
        } else if (item.type === 'ol' || item.type === 'ul') {
            const listTag = item.type;
            html += `<${listTag} style="list-style-position: inside;">`;
            item.items.forEach(li => {
                html += `<li>${li}</li>`;
            });
            html += `</${listTag}>`;
        }
    });
    return html;
}

function showMeetingFormat(format) {
    const display = document.getElementById('meeting-format-display');
    const data = contentData[format];
    if (data) {
        display.innerHTML = renderMeetingFormat(data);
        display.style.display = 'block';
    }
}

// Dictionary functions
async function searchDictionary() {
    const word = document.getElementById('dictionary-search-word').value.trim();
    const resultsContainer = document.getElementById('dictionary-results');
    if (!word) {
        showToast('Please enter a word to search.', 'error');
        return;
    }
    resultsContainer.innerHTML = '<p>Searching...</p>';

    // Create abort controller for timeout
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout

    try {
        const response = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word)}`, {
            signal: controller.signal
        });
        clearTimeout(timeoutId);

        if (!response.ok) {
            throw new Error('Word not found. Please check your spelling.');
        }
        const data = await response.json();
        displayDictionaryResults(data);
    } catch (error) {
        clearTimeout(timeoutId);
        let errorMsg = 'An error occurred while searching.';
        if (error.name === 'AbortError') {
            errorMsg = 'Search timed out. Please check your internet connection and try again.';
        } else if (error.message) {
            errorMsg = error.message;
        }
        resultsContainer.innerHTML = `<p style="color: #e74c3c;">${escapeHtml(errorMsg)}</p>`;
        showToast(errorMsg, 'error');
    }
}

function displayDictionaryResults(data) {
    const resultsContainer = document.getElementById('dictionary-results');
    resultsContainer.innerHTML = ''; // Clear previous results or "Searching..." text

    if (!data || data.length === 0) {
        resultsContainer.innerHTML = '<p>No definitions found.</p>';
        return;
    }

    const entry = data[0]; // Displaying the first entry found
    let html = `<h3>${escapeHtml(entry.word)} <span style="font-size: 1rem; color: #bdc3c7;">${escapeHtml(entry.phonetic || '')}</span></h3>`;

    if (entry.meanings && Array.isArray(entry.meanings)) {
        entry.meanings.forEach(meaning => {
            html += `<h4 style="color: #3498db; margin-top: 1rem;">${escapeHtml(meaning.partOfSpeech)}</h4>`;
            html += '<ul style="list-style-type: disc; padding-left: 20px;">';
            if (meaning.definitions && Array.isArray(meaning.definitions)) {
                meaning.definitions.forEach(def => {
                    html += `<li>${escapeHtml(def.definition)}`;
                    if (def.example) {
                        html += `<br><em style="color: #95a5a6;">Example: "${escapeHtml(def.example)}"</em>`;
                    }
                    html += '</li>';
                });
            }
            html += '</ul>';
        });
    }

    // Add audio for pronunciation if available (sanitize URL)
    if (entry.phonetics && Array.isArray(entry.phonetics)) {
        const phoneticWithAudio = entry.phonetics.find(p => p.audio);
        if (phoneticWithAudio && phoneticWithAudio.audio) {
            // Validate that audio URL is from trusted domain
            try {
                const audioUrl = new URL(phoneticWithAudio.audio);
                if (audioUrl.protocol === 'https:' && audioUrl.hostname.endsWith('dictionaryapi.dev')) {
                    html += `<div style="margin-top: 1rem;">
                                <p>Pronunciation:</p>
                                <audio controls src="${escapeAttribute(phoneticWithAudio.audio)}" style="width: 100%;">
                                    Your browser does not support the audio element.
                                </audio>
                             </div>`;
                }
            } catch (e) {
                // Invalid URL, skip audio
            }
        }
    }

    resultsContainer.innerHTML = html;
}


// Chairperson's Corner Roster Modal Logic
let rosterSortColumn = 'name';
let rosterSortDirection = 'asc';

function openRosterModal() {
    const modal = document.getElementById('roster-modal');
    if (modal) {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden'; // Prevent background scrolling
        renderRosterTable();
    }
}

function closeRosterModal() {
    const modal = document.getElementById('roster-modal');
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = ''; // Restore scrolling
    }
}

function sortRosterBy(column) {
    if (rosterSortColumn === column) {
        rosterSortDirection = rosterSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        rosterSortColumn = column;
        rosterSortDirection = 'asc';
    }
    // Update header indicators
    document.querySelectorAll('#roster-table th').forEach(th => {
        th.textContent = th.textContent.replace(/ [↑↓]/, '');
    });
    const header = Array.from(document.querySelectorAll('#roster-table th')).find(th => th.textContent.toLowerCase().startsWith(column));
    if (header) {
        header.textContent += rosterSortDirection === 'asc' ? ' ↓' : ' ↑';
    }
    renderRosterTable();
}

function renderRosterTable() {
    const tbody = document.getElementById('roster-table-body');
    if (!tbody) return;
    const searchTerm = document.getElementById('roster-search').value.toLowerCase();
    tbody.innerHTML = '';

    let members = storage.getMembers();

    // 1. Filter
    if (searchTerm) {
        members = members.filter(m => {
            return m.name.toLowerCase().includes(searchTerm) ||
                   (m.email && m.email.toLowerCase().includes(searchTerm)) ||
                   (m.phone && m.phone.includes(searchTerm)) ||
                   (m.homegroup && m.homegroup.toLowerCase().includes(searchTerm)) ||
                   (m.city && m.city.toLowerCase().includes(searchTerm));
        });
    }

    // 2. Sort
    members.sort((a, b) => {
        let valA = a[rosterSortColumn] === undefined ? '' : a[rosterSortColumn];
        let valB = b[rosterSortColumn] === undefined ? '' : b[rosterSortColumn];

        if (typeof valA === 'boolean') {
            valA = valA ? 1 : 0;
            valB = valB ? 1 : 0;
        } else if (typeof valA === 'string') {
            valA = valA.toLowerCase();
            valB = valB.toLowerCase();
        }

        if (valA < valB) return rosterSortDirection === 'asc' ? -1 : 1;
        if (valA > valB) return rosterSortDirection === 'asc' ? 1 : -1;
        return 0;
    });

    // 3. Render
    if(members.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7">No members found.</td></tr>';
        return;
    }

    members.forEach(member => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${member.name}</td>
            <td>${member.city || ''}</td>
            <td>${member.homegroup || ''}</td>
            <td>${member.phone || ''}</td>
            <td>${member.email || ''}</td>
            <td>${member.isServant ? 'Yes' : 'No'}</td>
            <td>
                <button class="btn" data-action="edit-member-roster" data-id="${escapeAttribute(member.id)}">Edit</button>
                <button class="btn secondary" data-action="delete-member-roster" data-id="${escapeAttribute(member.id)}">Delete</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function editMemberFromRoster(id) {
    closeRosterModal();
    editMember(id);
}

function deleteMemberAndRefreshRoster(id) {
    deleteMember(id);
    renderRosterTable();
}

function openMemberFormFromModal() {
    closeRosterModal();
    const form = document.getElementById('add-member-form');
    form.style.display = 'block';
    goToSection('birthdays-section');
    form.scrollIntoView({ behavior: 'smooth' });
}

function populateAttendeeDropdown() {
    const select = document.getElementById('gc-attendees');
    if (!select) return;
    const members = storage.getMembers().sort((a, b) => a.name.localeCompare(b.name));

    // Preserve selected values if they exist, useful if the list is refreshed while form is open
    const selectedValues = Array.from(select.selectedOptions).map(opt => opt.value);

    select.innerHTML = ''; // Clear existing options
    members.forEach(member => {
        const option = document.createElement('option');
        option.value = member.name;
        option.textContent = member.name;
        if (selectedValues.includes(member.name)) {
            option.selected = true;
        }
        select.appendChild(option);
    });
}

function populateMemberDropdowns() {
    const allMembers = storage.getMembers().sort((a, b) => a.name.localeCompare(b.name));
    const servantMembers = allMembers.filter(m => m.isServant);

    const dropdowns = [
        { id: 'log-chairperson', placeholder: 'Select Chairperson', members: servantMembers, optional: false },
        { id: 'event-speaker', placeholder: 'Select Speaker (optional)', members: allMembers, optional: true },
        { id: 'event-chair', placeholder: 'Select Chairperson (optional)', members: servantMembers, optional: true }
    ];

    dropdowns.forEach(dd_info => {
        const select = document.getElementById(dd_info.id);
        if (!select) return;

        const currentValue = select.value;
        select.innerHTML = '';

        const placeholderOption = document.createElement('option');
        placeholderOption.value = '';
        placeholderOption.textContent = dd_info.placeholder;
        select.appendChild(placeholderOption);

        if (dd_info.optional) {
            const noneOption = document.createElement('option');
            noneOption.value = 'None';
            noneOption.textContent = 'None';
            select.appendChild(noneOption);
        }

        dd_info.members.forEach(member => {
            const option = document.createElement('option');
            option.value = member.name;
            option.textContent = member.name;
            select.appendChild(option);
        });

        select.value = currentValue;
    });
}

// Populate dropdowns for new GC features
function populateNewFeatureDropdowns() {
    const allMembers = storage.getMembers().sort((a, b) => a.name.localeCompare(b.name));
    const gcLog = storage.getGroupConscienceLog();

    // Populate member dropdowns
    const memberDropdownIds = [
        'reconsider-requested-by',
        'proxy-member',
        'proxy-designated-voter',
        'voting-history-member',
        'standing-item-assignee'
    ];

    memberDropdownIds.forEach(dropdownId => {
        const select = document.getElementById(dropdownId);
        if (!select) return;

        const currentValue = select.value;
        select.innerHTML = '<option value="">Select member...</option>';

        allMembers.forEach(member => {
            const option = document.createElement('option');
            option.value = member.id || member.name;
            option.textContent = member.name;
            select.appendChild(option);
        });

        if (currentValue) select.value = currentValue;
    });

    // Populate GC decision dropdowns
    const decisionDropdownIds = [
        'reconsider-original-decision',
        'reversal-original-decision',
        'reversal-new-decision',
        'impl-decision'
    ];

    decisionDropdownIds.forEach(dropdownId => {
        const select = document.getElementById(dropdownId);
        if (!select) return;

        const currentValue = select.value;
        select.innerHTML = '<option value="">Select a decision...</option>';

        gcLog.slice().reverse().forEach(decision => {
            const option = document.createElement('option');
            option.value = decision.id;
            option.textContent = `${decision.date} - ${decision.item.substring(0, 60)}${decision.item.length > 60 ? '...' : ''}`;
            select.appendChild(option);
        });

        if (currentValue) select.value = currentValue;
    });
}

function renderServantReportInputs() {
    const container = document.getElementById('gc-servant-reports-container');
    if (!container) return;
    container.innerHTML = '';
    const servants = storage.getMembers().filter(m => m.isServant).sort((a, b) => (a.servantPosition || a.name).localeCompare(b.servantPosition || b.name));

    if (servants.length === 0) {
        container.innerHTML = '<p class="text-sm opacity-75">No servants found. Add servants with positions in the Member Roster to see report fields here.</p>';
        return;
    }

    servants.forEach(s => {
        const servantName = s.servantPosition ? `${s.name} (${s.servantPosition})` : s.name;
        const div = document.createElement('div');
        div.className = 'form-group';
        div.innerHTML = `
            <label for="servant-report-${s.id}">${servantName}</label>
            <textarea id="servant-report-${s.id}" data-servant-id="${s.id}" data-servant-name="${servantName}" class="servant-report-input" rows="2" placeholder="Report for ${servantName}..."></textarea>
        `;
        container.appendChild(div);
    });
}

function setupAudioRecorder() {
    const recordBtn = document.getElementById('record-btn');
    const stopBtn = document.getElementById('stop-btn');
    const audioPlayer = document.getElementById('audio-player');
    const downloadLink = document.getElementById('download-link');
    const playerContainer = document.getElementById('audio-player-container');

    if (!recordBtn) return; // Exit if the recorder elements aren't on the page

    const descriptionP = recordBtn.parentElement.previousElementSibling;

    // Allow audio recording when served from file:// or a secure context.
    if (!window.isSecureContext && location.protocol !== 'file:') {
        showToast('Audio recording requires a secure connection (HTTPS or localhost).', 'error');
        recordBtn.disabled = true;
        descriptionP.innerHTML = '<b>Audio recording is disabled.</b> This feature requires a secure connection (HTTPS or localhost). If you are developing locally, please serve the page via a local web server.';
        return;
    }
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia || !window.MediaRecorder) {
        showToast('Audio recording is not supported on this browser.', 'error');
        recordBtn.disabled = true;
        if (descriptionP && descriptionP.tagName === 'P') {
            descriptionP.innerHTML = '<b>Audio recording is not supported on this browser.</b> Please try a modern browser like Chrome or Firefox.';
            descriptionP.style.opacity = 1;
        }
        return;
    }

    let mediaRecorder;
    let chunks = [];

    async function startRecording() {
        try {
            // Request microphone access
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);

            // Event handler for when data is available
            mediaRecorder.ondataavailable = e => {
                chunks.push(e.data);
            };

            // Event handler for when recording stops
            mediaRecorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'audio/webm' });
                chunks = [];
                const audioURL = window.URL.createObjectURL(blob);
                audioPlayer.src = audioURL;
                downloadLink.href = audioURL;

                // Create a filename with a timestamp
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[-:T]/g, '').replace(/ /g, '_');
                downloadLink.download = `meeting-audio-${timestamp}.webm`;

                // Make the player and download link visible
                playerContainer.style.display = 'block';
                downloadLink.style.display = 'inline-block';

                // Stop the microphone track to turn off the browser's recording indicator
                stream.getTracks().forEach(track => track.stop());
            };

            // Start recording and update UI
            mediaRecorder.start();
            recordBtn.disabled = true;
            stopBtn.disabled = false;
            playerContainer.style.display = 'none';
            downloadLink.style.display = 'none';
            showToast('Recording started...', 'info');

        } catch (err) {
            console.error("Error starting recording:", err);
            if (err.name === "NotAllowedError" || err.name === "PermissionDeniedError") {
                showToast('Microphone permission denied. Please allow access in your browser settings.', 'error');
            } else {
                showToast('Could not start recording. No microphone found or an error occurred.', 'error');
            }
        }
    }

    function stopRecording() {
        if (mediaRecorder && mediaRecorder.state !== "inactive") {
            mediaRecorder.stop();
            recordBtn.disabled = false;
            stopBtn.disabled = true;
            showToast('Recording stopped.', 'info');
        }
    }

    recordBtn.addEventListener('click', startRecording);
    stopBtn.addEventListener('click', stopRecording);
}

// ==================== NEW FEATURES ====================

// Mark announcement as read
function markAnnouncementAsRead(announcementId) {
    const ann = storage.getAnnouncements();
    const announcement = ann.find(a => a.id === announcementId);
    if (announcement) {
        const currentUser = storage.getCurrentUser();
        if (!announcement.readBy) announcement.readBy = [];
        if (!announcement.readBy.includes(currentUser)) {
            announcement.readBy.push(currentUser);
            storage.saveAnnouncements(ann);
            updateAnnouncementsList();
            showToast('Marked as read', 'success');
        }
    }
}

// ========== MEMBER MESSAGING FUNCTIONS ==========

function sendMessage() {
    const recipientId = document.getElementById('message-recipient').value;
    const subject = document.getElementById('message-subject').value.trim();
    const text = document.getElementById('message-text').value.trim();

    if (!recipientId || !subject || !text) {
        showToast('Please fill in all fields', 'error');
        return;
    }

    const currentUser = storage.getCurrentUser();
    const messages = storage.getMessages();

    messages.push({
        id: genId(),
        from: currentUser,
        to: recipientId,
        subject: subject,
        message: text,
        date: new Date().toISOString(),
        read: false
    });

    storage.saveMessages(messages);
    showToast('Message sent!', 'success');

    document.getElementById('message-recipient').value = '';
    document.getElementById('message-subject').value = '';
    document.getElementById('message-text').value = '';

    showMessages('sent');
}

function showMessages(type) {
    const container = document.getElementById('messages-container');
    const messages = storage.getMessages();
    const currentUser = storage.getCurrentUser();

    // Update button states
    document.getElementById('inbox-btn').classList.toggle('active', type === 'inbox');
    document.getElementById('sent-btn').classList.toggle('active', type === 'sent');

    const filteredMessages = type === 'inbox'
        ? messages.filter(m => m.to === currentUser)
        : messages.filter(m => m.from === currentUser);

    container.innerHTML = '';

    if (filteredMessages.length === 0) {
        container.innerHTML = `<p>No ${type} messages</p>`;
        return;
    }

    filteredMessages.sort((a, b) => new Date(b.date) - new Date(a.date));

    filteredMessages.forEach(msg => {
        const div = document.createElement('div');
        div.className = `message-item ${!msg.read && type === 'inbox' ? 'unread' : ''}`;

        const header = document.createElement('div');
        header.className = 'message-header';

        const subj = document.createElement('div');
        subj.className = 'message-subject';
        subj.textContent = msg.subject;

        const date = document.createElement('div');
        date.className = 'message-date';
        date.textContent = new Date(msg.date).toLocaleString();

        header.appendChild(subj);
        header.appendChild(date);

        const fromTo = document.createElement('div');
        fromTo.style.fontSize = '0.85rem';
        fromTo.style.marginBottom = '8px';
        fromTo.textContent = type === 'inbox' ? `From: ${msg.from}` : `To: ${msg.to}`;

        const msgText = document.createElement('div');
        msgText.textContent = msg.message;

        div.appendChild(header);
        div.appendChild(fromTo);
        div.appendChild(msgText);

        if (type === 'inbox' && !msg.read) {
            const markReadBtn = document.createElement('button');
            markReadBtn.className = 'btn';
            markReadBtn.style.marginTop = '8px';
            markReadBtn.textContent = 'Mark as Read';
            markReadBtn.onclick = () => markMessageAsRead(msg.id);
            div.appendChild(markReadBtn);
        }

        container.appendChild(div);
    });
}

function markMessageAsRead(messageId) {
    const messages = storage.getMessages();
    const message = messages.find(m => m.id === messageId);
    if (message) {
        message.read = true;
        storage.saveMessages(messages);
        showMessages('inbox');
        showToast('Marked as read', 'success');
    }
}

function populateMessageRecipients() {
    const select = document.getElementById('message-recipient');
    const members = storage.getMembers();
    const currentUser = storage.getCurrentUser();

    select.innerHTML = '<option value="">Select a member...</option>';

    members.forEach(m => {
        if (m.name !== currentUser) {
            const option = document.createElement('option');
            option.value = m.name;
            option.textContent = m.name;
            select.appendChild(option);
        }
    });
}

// ========== SERVICE POSITION FUNCTIONS ==========

function addServicePosition() {
    const name = document.getElementById('position-name').value.trim();
    const description = document.getElementById('position-description').value.trim();
    const termLength = parseInt(document.getElementById('position-term-length').value);
    const currentHolder = document.getElementById('position-current-holder').value;
    const startDate = document.getElementById('position-start-date').value;

    if (!name || !termLength) {
        showToast('Please enter position name and term length', 'error');
        return;
    }

    const positions = storage.getServicePositions();

    positions.push({
        id: genId(),
        name: name,
        description: description,
        termLength: termLength,
        currentHolder: currentHolder,
        startDate: startDate,
        history: [],

        // P1-1: Service Position Transition Package
        transitionPackage: {
            checklist: getPositionTransitionChecklist(name),
            currentProjects: [],
            keyContacts: [],
            accessInfo: [],
            documents: [],
            completionPercentage: 0,
            transitionStartDate: null,
            transitionCompleteDate: null,
            outgoingNotes: null,
            incomingNotes: null
        },

        // P1: Term tracking enhancements
        notificationsSent: {
            days90: false,
            days60: false,
            days30: false
        },
        successorIdentified: false,
        potentialSuccessors: []
    });

    storage.saveServicePositions(positions);
    showToast('Service position added!', 'success');

    document.getElementById('position-name').value = '';
    document.getElementById('position-description').value = '';
    document.getElementById('position-term-length').value = '';
    document.getElementById('position-current-holder').value = '';
    document.getElementById('position-start-date').value = '';

    updateServicePositionsTable();
    updateRotationCalendar();
    populateNominationPositions();
}

function updateServicePositionsTable() {
    const tbody = document.getElementById('service-positions-table');
    const positions = storage.getServicePositions();

    tbody.innerHTML = '';

    positions.forEach(pos => {
        const tr = document.createElement('tr');

        const endDate = pos.startDate ? calculateEndDate(pos.startDate, pos.termLength) : 'N/A';
        const daysRemaining = pos.startDate ? calculateDaysRemaining(pos.startDate, pos.termLength) : null;

        let termStatus = '';
        if (daysRemaining !== null) {
            if (daysRemaining < 0) {
                termStatus = `<span class="term-expired">EXPIRED</span>`;
            } else if (daysRemaining < 60) {
                termStatus = `<span class="term-warning">${daysRemaining} days left</span>`;
            }
        }

        tr.innerHTML = `
            <td>${pos.name}</td>
            <td>${pos.currentHolder || 'Vacant'}</td>
            <td>${pos.startDate ? new Date(pos.startDate).toLocaleDateString() : 'N/A'}</td>
            <td>${endDate} ${termStatus}</td>
            <td>
                <button class="btn secondary" data-action="delete-position" data-id="${escapeAttribute(pos.id)}">Delete</button>
            </td>
        `;

        tbody.appendChild(tr);
    });

    if (positions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5">No service positions defined</td></tr>';
    }
}

function deleteServicePosition(id) {
    if (!confirm('Delete this service position?')) return;
    let positions = storage.getServicePositions();
    positions = positions.filter(p => p.id !== id);
    storage.saveServicePositions(positions);
    updateServicePositionsTable();
    updateRotationCalendar();
    populateNominationPositions();
    showToast('Position deleted', 'success');
}

function calculateEndDate(startDate, termMonths) {
    const start = new Date(startDate);
    // Safe date math: add months by calculating total months then reconstructing date
    const startYear = start.getFullYear();
    const startMonth = start.getMonth();
    const startDay = start.getDate();

    const totalMonths = startYear * 12 + startMonth + termMonths;
    const endYear = Math.floor(totalMonths / 12);
    const endMonth = totalMonths % 12;

    // Create end date, handling month-end overflow (e.g., Jan 31 + 1 month = Feb 28/29)
    const end = new Date(endYear, endMonth, 1);
    const maxDay = new Date(endYear, endMonth + 1, 0).getDate();
    end.setDate(Math.min(startDay, maxDay));

    return end.toLocaleDateString();
}

function calculateDaysRemaining(startDate, termMonths) {
    const start = new Date(startDate);
    // Safe date math: add months by calculating total months then reconstructing date
    const startYear = start.getFullYear();
    const startMonth = start.getMonth();
    const startDay = start.getDate();

    const totalMonths = startYear * 12 + startMonth + termMonths;
    const endYear = Math.floor(totalMonths / 12);
    const endMonth = totalMonths % 12;

    // Create end date, handling month-end overflow
    const end = new Date(endYear, endMonth, 1);
    const maxDay = new Date(endYear, endMonth + 1, 0).getDate();
    end.setDate(Math.min(startDay, maxDay));

    const today = new Date();
    const diffTime = end - today;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    return diffDays;
}

function updateRotationCalendar() {
    const container = document.getElementById('rotation-calendar');
    const positions = storage.getServicePositions();

    const upcomingElections = positions.filter(pos => {
        if (!pos.startDate) return false;
        const days = calculateDaysRemaining(pos.startDate, pos.termLength);
        return days !== null && days >= 0 && days <= 60;
    });

    container.innerHTML = '';

    if (upcomingElections.length === 0) {
        container.innerHTML = '<p>No elections coming up in the next 60 days</p>';
        return;
    }

    upcomingElections.sort((a, b) => {
        const daysA = calculateDaysRemaining(a.startDate, a.termLength);
        const daysB = calculateDaysRemaining(b.startDate, b.termLength);
        return daysA - daysB;
    });

    upcomingElections.forEach(pos => {
        const days = calculateDaysRemaining(pos.startDate, pos.termLength);
        const endDate = calculateEndDate(pos.startDate, pos.termLength);

        const card = document.createElement('div');
        card.className = 'position-card';
        card.innerHTML = `
            <h4>${pos.name}</h4>
            <p><strong>Current:</strong> ${pos.currentHolder || 'Vacant'}</p>
            <p><strong>Term ends:</strong> ${endDate}</p>
            <p class="term-warning">${days} days remaining</p>
        `;
        container.appendChild(card);
    });
}

function addNomination() {
    const positionId = document.getElementById('nomination-position').value;
    const nominee = document.getElementById('nomination-nominee').value;

    if (!positionId || !nominee) {
        showToast('Please select position and nominee', 'error');
        return;
    }

    const nominations = storage.getNominations();
    const positions = storage.getServicePositions();
    const position = positions.find(p => p.id === positionId);

    nominations.push({
        id: genId(),
        positionId: positionId,
        positionName: position.name,
        nominee: nominee,
        nominatedBy: storage.getCurrentUser(),
        date: new Date().toISOString()
    });

    storage.saveNominations(nominations);
    showToast('Nomination submitted!', 'success');

    document.getElementById('nomination-position').value = '';
    document.getElementById('nomination-nominee').value = '';

    updateNominationsList();
}

function updateNominationsList() {
    const container = document.getElementById('nominations-list');
    const nominations = storage.getNominations();

    container.innerHTML = '';

    if (nominations.length === 0) {
        container.innerHTML = '<p>No nominations yet</p>';
        return;
    }

    nominations.forEach(nom => {
        const card = document.createElement('div');
        card.className = 'nomination-card';
        card.innerHTML = `
            <h4>${nom.positionName}</h4>
            <p><strong>Nominee:</strong> ${nom.nominee}</p>
            <p><strong>Nominated by:</strong> ${nom.nominatedBy}</p>
            <p><strong>Date:</strong> ${new Date(nom.date).toLocaleDateString()}</p>
            <button class="btn secondary" data-action="delete-nomination" data-id="${escapeAttribute(nom.id)}">Remove</button>
        `;
        container.appendChild(card);
    });
}

function deleteNomination(id) {
    if (!confirm('Remove this nomination?')) return;
    let nominations = storage.getNominations();
    nominations = nominations.filter(n => n.id !== id);
    storage.saveNominations(nominations);
    updateNominationsList();
    showToast('Nomination removed', 'success');
}

function populateNominationPositions() {
    const select = document.getElementById('nomination-position');
    const positions = storage.getServicePositions();

    select.innerHTML = '<option value="">Select position...</option>';

    positions.forEach(pos => {
        const option = document.createElement('option');
        option.value = pos.id;
        option.textContent = pos.name;
        select.appendChild(option);
    });
}

function populateServicePositionHolders() {
    const select = document.getElementById('position-current-holder');
    const nomineeSelect = document.getElementById('nomination-nominee');
    const members = storage.getMembers();

    select.innerHTML = '<option value="">Vacant</option>';
    nomineeSelect.innerHTML = '<option value="">Select member...</option>';

    members.forEach(m => {
        const option1 = document.createElement('option');
        option1.value = m.name;
        option1.textContent = m.name;
        select.appendChild(option1);

        const option2 = document.createElement('option');
        option2.value = m.name;
        option2.textContent = m.name;
        nomineeSelect.appendChild(option2);
    });
}

// ========== P1-1: SERVICE POSITION TRANSITION PACKAGE ==========

function getPositionTransitionChecklist(positionName) {
    // Default checklists for common positions
    const checklists = {
        'Treasurer': [
            {item: 'Review current bank balance and accounts', completed: false},
            {item: 'Transfer bank account access/signatures', completed: false},
            {item: 'Provide all financial records (last 12 months)', completed: false},
            {item: 'Explain budget categories and tracking system', completed: false},
            {item: 'Show prudent reserve calculation', completed: false},
            {item: 'Review bill payment schedule and vendors', completed: false},
            {item: 'Explain 7th Tradition counting procedure', completed: false},
            {item: 'Provide GSR contact for district contributions', completed: false},
            {item: 'Review IRS tax filing requirements', completed: false}
        ],
        'Secretary': [
            {item: 'Transfer meeting minutes archive', completed: false},
            {item: 'Provide templates for minutes and reports', completed: false},
            {item: 'Explain GC motion tracking system', completed: false},
            {item: 'Share attendance tracking procedure', completed: false},
            {item: 'Provide group contact list', completed: false},
            {item: 'Review document filing system', completed: false}
        ],
        'GSR': [
            {item: 'Provide District/Area contact information', completed: false},
            {item: 'Share district meeting schedule', completed: false},
            {item: 'Transfer district voting records', completed: false},
            {item: 'Explain how to submit group contributions', completed: false},
            {item: 'Review group\'s hot topics and concerns', completed: false},
            {item: 'Provide access to GSR email/communications', completed: false}
        ],
        'Chairperson': [
            {item: 'Review meeting format and structure', completed: false},
            {item: 'Provide reading materials and meeting supplies location', completed: false},
            {item: 'Explain GC meeting facilitation process', completed: false},
            {item: 'Share contact list for all servants', completed: false},
            {item: 'Review traditions and concepts application', completed: false},
            {item: 'Explain facility coordination (keys, setup, etc.)', completed: false}
        ]
    };

    return checklists[positionName] || [
        {item: 'Review position responsibilities', completed: false},
        {item: 'Transfer any documents or materials', completed: false},
        {item: 'Introduce to key contacts', completed: false},
        {item: 'Answer questions about role', completed: false}
    ];
}

function startTransition(positionId) {
    const positions = storage.getServicePositions();
    const position = positions.find(p => p.id === positionId);

    if (!position) {
        showToast('Position not found', 'error');
        return;
    }

    if (!position.transitionPackage) {
        position.transitionPackage = {
            checklist: getPositionTransitionChecklist(position.name),
            currentProjects: [],
            keyContacts: [],
            accessInfo: [],
            documents: [],
            completionPercentage: 0,
            transitionStartDate: null,
            transitionCompleteDate: null,
            outgoingNotes: null,
            incomingNotes: null
        };
    }

    position.transitionPackage.transitionStartDate = new Date().toISOString().split('T')[0];
    storage.saveServicePositions(positions);

    showToast(`Transition started for ${position.name}. Please complete the transition checklist.`, 'success');
    // Open transition interface
    openTransitionModal(positionId);
}

function updateTransitionChecklist(positionId, itemIndex, completed) {
    const positions = storage.getServicePositions();
    const position = positions.find(p => p.id === positionId);

    if (!position || !position.transitionPackage) return;

    position.transitionPackage.checklist[itemIndex].completed = completed;

    // Calculate completion percentage
    const total = position.transitionPackage.checklist.length;
    const done = position.transitionPackage.checklist.filter(i => i.completed).length;
    position.transitionPackage.completionPercentage = Math.round((done / total) * 100);

    // If 100%, mark transition complete
    if (position.transitionPackage.completionPercentage === 100 && !position.transitionPackage.transitionCompleteDate) {
        position.transitionPackage.transitionCompleteDate = new Date().toISOString().split('T')[0];
        showToast(`Transition for ${position.name} is complete! Well done on a smooth handoff.`, 'success');
    }

    storage.saveServicePositions(positions);
}

function addTransitionProject(positionId, projectName, status, notes) {
    const positions = storage.getServicePositions();
    const position = positions.find(p => p.id === positionId);

    if (!position || !position.transitionPackage) return;

    position.transitionPackage.currentProjects.push({
        id: genId(),
        name: projectName,
        status: status,
        notes: notes,
        addedDate: new Date().toISOString()
    });

    storage.saveServicePositions(positions);
    showToast('Project added to transition package', 'success');
}

function addTransitionContact(positionId, name, role, contact, notes) {
    const positions = storage.getServicePositions();
    const position = positions.find(p => p.id === positionId);

    if (!position || !position.transitionPackage) return;

    position.transitionPackage.keyContacts.push({
        id: genId(),
        name: name,
        role: role,
        contact: contact,
        notes: notes
    });

    storage.saveServicePositions(positions);
    showToast('Contact added to transition package', 'success');
}

function addTransitionAccessInfo(positionId, system, username, notes) {
    const positions = storage.getServicePositions();
    const position = positions.find(p => p.id === positionId);

    if (!position || !position.transitionPackage) return;

    position.transitionPackage.accessInfo.push({
        id: genId(),
        system: system,
        username: username,
        notes: notes, // Password should be shared securely offline
        addedDate: new Date().toISOString()
    });

    storage.saveServicePositions(positions);
    showToast('Access info added (share passwords offline)', 'success');
}

function openTransitionModal(positionId) {
    // This would open a modal/page to manage the transition
    // For now, we'll just navigate to service positions section
    goToSection('service-positions-section');
    showToast('View transition package in Service Positions section', 'info');
}

// ========== P2-2: NOTIFICATION SYSTEM ==========

function createNotification(notification) {
    const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');

    const newNotification = {
        id: genId(),
        type: notification.type || 'general',
        title: notification.title,
        message: notification.message,
        priority: notification.priority || 'normal', // normal, high, urgent
        createdDate: new Date().toISOString(),
        read: false,
        dismissed: false,
        actionLink: notification.actionLink || null,
        actionData: notification.actionData || null
    };

    notifications.push(newNotification);
    localStorage.setItem('notifications', JSON.stringify(notifications));

    // Update notification badge count
    updateNotificationBadge();

    // Show toast for urgent notifications
    if (notification.priority === 'urgent') {
        showToast(notification.title, 'warning');
    }

    return newNotification.id;
}

function getUnreadNotifications() {
    const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
    return notifications.filter(n => !n.read && !n.dismissed);
}

function markNotificationRead(notificationId) {
    const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
    const notification = notifications.find(n => n.id === notificationId);

    if (notification) {
        notification.read = true;
        localStorage.setItem('notifications', JSON.stringify(notifications));
        updateNotificationBadge();
        refreshNotificationList();
    }
}

function dismissNotification(notificationId) {
    const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
    const notification = notifications.find(n => n.id === notificationId);

    if (notification) {
        notification.dismissed = true;
        localStorage.setItem('notifications', JSON.stringify(notifications));
        updateNotificationBadge();
        refreshNotificationList();
    }
}

function updateNotificationBadge() {
    const unread = getUnreadNotifications();
    const badge = document.getElementById('notification-badge');
    const homeBadge = document.getElementById('home-notification-badge');

    if (badge) {
        if (unread.length > 0) {
            badge.textContent = unread.length > 99 ? '99+' : unread.length;
            badge.style.display = 'inline-block';
        } else {
            badge.style.display = 'none';
        }
    }

    if (homeBadge) {
        if (unread.length > 0) {
            homeBadge.textContent = unread.length > 99 ? '99+' : unread.length;
            homeBadge.style.display = 'inline';
        } else {
            homeBadge.style.display = 'none';
        }
    }
}

// ===== ENHANCED SMART NOTIFICATION SYSTEM =====

function showNotificationCenter() {
    const modal = document.createElement('div');
    modal.id = 'notification-modal';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';

    const content = document.createElement('div');
    content.style.cssText = 'background: #34495e; padding: 2rem; border-radius: 8px; max-width: 700px; max-height: 85vh; overflow-y: auto; width: 90%;';

    content.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="color: #3498db; margin: 0;"><i class="fas fa-bell"></i> Smart Notifications</h2>
            <div style="display: flex; gap: 0.5rem;">
                <button onclick="clearAllNotifications()" class="btn secondary" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                    <i class="fas fa-trash-alt"></i> Clear All
                </button>
                <button onclick="closeNotificationCenter()" class="btn secondary" style="padding: 0.5rem 1rem;">Close</button>
            </div>
        </div>

        <!-- Filter Tabs -->
        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; border-bottom: 2px solid #2c3e50; padding-bottom: 0.5rem;">
            <button id="filter-all" onclick="filterNotifications('all')" class="btn" style="font-size: 0.85rem; padding: 0.4rem 0.8rem; background: #3498db;">
                All <span id="count-all" style="background: rgba(255,255,255,0.2); padding: 0.1rem 0.4rem; border-radius: 10px; margin-left: 0.25rem;">0</span>
            </button>
            <button id="filter-urgent" onclick="filterNotifications('urgent')" class="btn secondary" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                Urgent <span id="count-urgent" style="background: rgba(255,255,255,0.2); padding: 0.1rem 0.4rem; border-radius: 10px; margin-left: 0.25rem;">0</span>
            </button>
            <button id="filter-high" onclick="filterNotifications('high')" class="btn secondary" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                High <span id="count-high" style="background: rgba(255,255,255,0.2); padding: 0.1rem 0.4rem; border-radius: 10px; margin-left: 0.25rem;">0</span>
            </button>
            <button id="filter-unread" onclick="filterNotifications('unread')" class="btn secondary" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                Unread <span id="count-unread" style="background: rgba(255,255,255,0.2); padding: 0.1rem 0.4rem; border-radius: 10px; margin-left: 0.25rem;">0</span>
            </button>
        </div>

        <div id="notification-list">
            <!-- Notifications will be rendered here -->
        </div>
    `;

    modal.appendChild(content);
    document.body.appendChild(modal);

    modal.onclick = (e) => {
        if (e.target === modal) closeNotificationCenter();
    };

    // Initial render of notifications
    window.currentNotificationFilter = 'all';
    refreshNotificationList();
}

function filterNotifications(filter) {
    window.currentNotificationFilter = filter;

    // Update active button
    document.querySelectorAll('#notification-modal button[id^="filter-"]').forEach(btn => {
        btn.classList.remove('btn');
        btn.classList.add('btn', 'secondary');
        btn.style.background = '';
    });

    const activeBtn = document.getElementById('filter-' + filter);
    if (activeBtn) {
        activeBtn.classList.remove('secondary');
        activeBtn.style.background = '#3498db';
    }

    refreshNotificationList();
}

function refreshNotificationList() {
    const listDiv = document.getElementById('notification-list');
    if (!listDiv) return; // Modal is not open

    let notifications = storage.getNotifications()
        .filter(n => !n.dismissed); // Only show non-dismissed notifications

    // Apply filter
    const filter = window.currentNotificationFilter || 'all';
    if (filter === 'urgent') {
        notifications = notifications.filter(n => n.priority === 'urgent');
    } else if (filter === 'high') {
        notifications = notifications.filter(n => n.priority === 'high');
    } else if (filter === 'unread') {
        notifications = notifications.filter(n => !n.read);
    }

    // Sort by priority then date
    const priorityOrder = { urgent: 0, high: 1, medium: 2, low: 3 };
    notifications.sort((a, b) => {
        const priorityA = priorityOrder[a.priority || 'medium'];
        const priorityB = priorityOrder[b.priority || 'medium'];
        if (priorityA !== priorityB) return priorityA - priorityB;
        return new Date(b.date) - new Date(a.date);
    });

    // Update counts
    const allNotifications = storage.getNotifications().filter(n => !n.dismissed);
    document.getElementById('count-all').textContent = allNotifications.length;
    document.getElementById('count-urgent').textContent = allNotifications.filter(n => n.priority === 'urgent').length;
    document.getElementById('count-high').textContent = allNotifications.filter(n => n.priority === 'high').length;
    document.getElementById('count-unread').textContent = allNotifications.filter(n => !n.read).length;

    if (notifications.length === 0) {
        listDiv.innerHTML = '<p style="color: #95a5a6; text-align: center; padding: 2rem;">No notifications in this category</p>';
        return;
    }

    listDiv.innerHTML = notifications.map(n => {
        const priorityColor = n.priority === 'urgent' ? '#e74c3c' : n.priority === 'high' ? '#f39c12' : '#3498db';
        const priorityIcon = n.priority === 'urgent' ? 'fa-exclamation-triangle' : n.priority === 'high' ? 'fa-exclamation-circle' : 'fa-info-circle';

        // Check if snoozed
        const now = new Date();
        const snoozedUntil = n.snoozedUntil ? new Date(n.snoozedUntil) : null;
        const isSnoozed = snoozedUntil && snoozedUntil > now;

        return `
            <div style="background: #2c3e50; padding: 1rem; border-radius: 6px; margin-bottom: 0.75rem; border-left: 4px solid ${priorityColor}; opacity: ${n.read ? '0.7' : '1'}; ${isSnoozed ? 'border: 2px dashed #95a5a6;' : ''}">
                <div style="display: flex; align-items: start; gap: 0.75rem;">
                    <i class="fas ${priorityIcon}" style="color: ${priorityColor}; font-size: 1.2rem; margin-top: 0.25rem;"></i>
                    <div style="flex: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                            <h4 style="color: ${priorityColor}; margin: 0; flex: 1;">${escapeHtml(n.title)}</h4>
                            ${!n.read ? '<span style="background: #e74c3c; color: white; padding: 0.15rem 0.4rem; border-radius: 10px; font-size: 0.7rem; font-weight: bold;">NEW</span>' : ''}
                        </div>
                        <p style="margin: 0 0 0.5rem 0; color: #ecf0f1; line-height: 1.5;">${escapeHtml(n.message)}</p>

                        ${isSnoozed ? `<div style="background: #34495e; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; font-size: 0.85rem;">
                            <i class="fas fa-clock"></i> Snoozed until ${snoozedUntil.toLocaleString()}
                        </div>` : ''}

                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <small style="color: #95a5a6;">
                                <i class="fas fa-clock"></i> ${new Date(n.date).toLocaleString()}
                            </small>
                            ${n.recurring ? '<span style="color: #f39c12; font-size: 0.75rem;"><i class="fas fa-redo"></i> Recurring</span>' : ''}
                        </div>

                        <div style="margin-top: 0.75rem; display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            ${!n.read ? `<button onclick="markNotificationRead('${escapeAttribute(n.id)}')" class="btn" style="font-size: 0.8rem; padding: 0.3rem 0.6rem; background: #3498db;">
                                <i class="fas fa-check"></i> Mark Read
                            </button>` : ''}

                            ${n.actionLink ? `<button onclick="dismissNotification('${escapeAttribute(n.id)}'); goToSection('${escapeAttribute(n.actionLink)}'); closeNotificationCenter();" class="btn" style="font-size: 0.8rem; padding: 0.3rem 0.6rem; background: #2ecc71;">
                                <i class="fas fa-external-link-alt"></i> Take Action
                            </button>` : ''}

                            ${!isSnoozed ? `<button onclick="snoozeNotification('${escapeAttribute(n.id)}')" class="btn secondary" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">
                                <i class="fas fa-clock"></i> Snooze
                            </button>` : `<button onclick="unsnoozeNotification('${escapeAttribute(n.id)}')" class="btn secondary" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">
                                <i class="fas fa-bell"></i> Unsnooze
                            </button>`}

                            <button onclick="dismissNotification('${escapeAttribute(n.id)}')" class="btn secondary" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">
                                <i class="fas fa-times"></i> Dismiss
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function snoozeNotification(id) {
    const duration = prompt('Snooze for how long?\n\n1. 1 hour\n2. 3 hours\n3. 1 day\n4. 3 days\n5. 1 week\n\nEnter number (1-5):', '1');

    if (!duration) return;

    const hours = { '1': 1, '2': 3, '3': 24, '4': 72, '5': 168 }[duration];
    if (!hours) {
        showToast('Invalid selection', 'error');
        return;
    }

    const notifications = storage.getNotifications();
    const notification = notifications.find(n => n.id === id);

    if (notification) {
        const snoozeUntil = new Date();
        snoozeUntil.setHours(snoozeUntil.getHours() + hours);
        notification.snoozedUntil = snoozeUntil.toISOString();
        notification.read = true; // Mark as read when snoozed

        storage.saveNotifications(notifications);
        refreshNotificationList();
        updateNotificationBadge();
        showToast(`Snoozed for ${hours} hour(s)`, 'success');
    }
}

function unsnoozeNotification(id) {
    const notifications = storage.getNotifications();
    const notification = notifications.find(n => n.id === id);

    if (notification) {
        delete notification.snoozedUntil;
        notification.read = false;

        storage.saveNotifications(notifications);
        refreshNotificationList();
        updateNotificationBadge();
        showToast('Notification unsnoozed', 'success');
    }
}

function clearAllNotifications() {
    if (!confirm('Clear all notifications? This cannot be undone.')) return;

    const notifications = storage.getNotifications();
    notifications.forEach(n => n.dismissed = true);
    storage.saveNotifications(notifications);

    refreshNotificationList();
    updateNotificationBadge();
    showToast('All notifications cleared', 'info');
}

function closeNotificationCenter() {
    const modal = document.getElementById('notification-modal');
    if (modal) modal.remove();
}

function markNotificationRead(id) {
    const notifications = storage.getNotifications();
    const notification = notifications.find(n => n.id === id);

    if (notification) {
        notification.read = true;
        storage.saveNotifications(notifications);
        refreshNotificationList();
        updateNotificationBadge();
    }
}

function dismissNotification(id) {
    const notifications = storage.getNotifications();
    const notification = notifications.find(n => n.id === id);

    if (notification) {
        notification.dismissed = true;
        storage.saveNotifications(notifications);
        refreshNotificationList();
        updateNotificationBadge();
    }
}

// ===== SMART NOTIFICATION PROCESSING =====

function processSnoozedNotifications() {
    const notifications = storage.getNotifications();
    const now = new Date();
    let updated = false;

    notifications.forEach(n => {
        if (n.snoozedUntil) {
            const snoozeUntil = new Date(n.snoozedUntil);
            if (snoozeUntil <= now) {
                // Snooze period expired
                delete n.snoozedUntil;
                n.read = false; // Make it unread again
                updated = true;
            }
        }
    });

    if (updated) {
        storage.saveNotifications(notifications);
        updateNotificationBadge();
    }
}

function autoDismissOldNotifications() {
    const notifications = storage.getNotifications();
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

    let updated = false;
    notifications.forEach(n => {
        const notificationDate = new Date(n.date);
        // Auto-dismiss read notifications older than 30 days
        if (n.read && notificationDate < thirtyDaysAgo && !n.dismissed) {
            n.dismissed = true;
            updated = true;
        }
    });

    if (updated) {
        storage.saveNotifications(notifications);
        updateNotificationBadge();
    }
}

function deduplicateNotifications() {
    const notifications = storage.getNotifications().filter(n => !n.dismissed);
    const seen = new Map();
    let hasDuplicates = false;

    notifications.forEach(n => {
        const key = `${n.title}-${n.message}`;
        const existing = seen.get(key);

        if (existing) {
            // Keep the newer one, dismiss the older one
            const olderNotification = new Date(existing.date) < new Date(n.date) ? existing : n;
            const newerNotification = new Date(existing.date) >= new Date(n.date) ? existing : n;

            olderNotification.dismissed = true;
            hasDuplicates = true;
        } else {
            seen.set(key, n);
        }
    });

    if (hasDuplicates) {
        storage.saveNotifications(notifications);
        updateNotificationBadge();
    }
}

function createSmartNotification(title, message, priority = 'medium', actionLink = null, category = null) {
    const notifications = storage.getNotifications();

    // Check for duplicates in last hour
    const oneHourAgo = new Date();
    oneHourAgo.setHours(oneHourAgo.getHours() - 1);

    const isDuplicate = notifications.some(n => {
        return !n.dismissed &&
               n.title === title &&
               n.message === message &&
               new Date(n.date) > oneHourAgo;
    });

    if (isDuplicate) {
        // Don't create duplicate notification
        return null;
    }

    const notification = {
        id: genId(),
        date: new Date().toISOString(),
        title,
        message,
        priority,
        actionLink,
        category,
        read: false,
        dismissed: false,
        recurring: false
    };

    notifications.unshift(notification);
    storage.saveNotifications(notifications);
    updateNotificationBadge();

    return notification;
}

function createRecurringNotification(title, message, priority, actionLink, intervalDays) {
    const notifications = storage.getNotifications();

    const notification = {
        id: genId(),
        date: new Date().toISOString(),
        title,
        message,
        priority,
        actionLink,
        recurring: true,
        recurringIntervalDays: intervalDays,
        lastShown: new Date().toISOString(),
        read: false,
        dismissed: false
    };

    notifications.unshift(notification);
    storage.saveNotifications(notifications);
    updateNotificationBadge();

    return notification;
}

function processRecurringNotifications() {
    const notifications = storage.getNotifications();
    const now = new Date();
    let updated = false;

    notifications.forEach(n => {
        if (n.recurring && n.recurringIntervalDays && n.lastShown) {
            const lastShownDate = new Date(n.lastShown);
            const daysSinceLastShown = Math.floor((now - lastShownDate) / (1000 * 60 * 60 * 24));

            if (daysSinceLastShown >= n.recurringIntervalDays) {
                // Time to show again
                if (n.dismissed || n.read) {
                    n.dismissed = false;
                    n.read = false;
                    n.lastShown = now.toISOString();
                    updated = true;
                }
            }
        }
    });

    if (updated) {
        storage.saveNotifications(notifications);
        updateNotificationBadge();
    }
}

// Run smart notification processing periodically
function initSmartNotificationSystem() {
    // Process immediately
    processSnoozedNotifications();
    autoDismissOldNotifications();
    deduplicateNotifications();
    processRecurringNotifications();

    // Then run every 5 minutes
    setInterval(() => {
        processSnoozedNotifications();
        autoDismissOldNotifications();
        deduplicateNotifications();
        processRecurringNotifications();
    }, 5 * 60 * 1000); // 5 minutes
}

// ========== P2-3: AUDIT TRAIL ==========

function logAuditEntry(action, entityType, entityId, changes, reason = null) {
    const auditLog = JSON.parse(localStorage.getItem('auditLog') || '[]');

    const entry = {
        id: genId(),
        timestamp: new Date().toISOString(),
        user: getCurrentUserName(),
        action: action, // 'create', 'update', 'delete', 'view'
        entityType: entityType, // 'gc-motion', 'member', 'expense', etc.
        entityId: entityId,
        changes: changes, // Object with before/after values
        reason: reason,
        ipAddress: null // Could add if server-side
    };

    auditLog.push(entry);

    // Keep only last 10,000 entries to prevent storage overflow
    if (auditLog.length > 10000) {
        auditLog.splice(0, auditLog.length - 10000);
    }

    localStorage.setItem('auditLog', JSON.stringify(auditLog));
}

function getAuditHistory(entityType = null, entityId = null, limit = 100) {
    const auditLog = JSON.parse(localStorage.getItem('auditLog') || '[]');

    let filtered = auditLog;

    if (entityType) {
        filtered = filtered.filter(e => e.entityType === entityType);
    }

    if (entityId) {
        filtered = filtered.filter(e => e.entityId === entityId);
    }

    // Sort by most recent first
    filtered.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

    return filtered.slice(0, limit);
}

function viewAuditLog() {
    const entries = getAuditHistory(null, null, 500);

    const modal = document.createElement('div');
    modal.id = 'audit-modal';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; overflow: auto; padding: 2rem;';

    const content = document.createElement('div');
    content.style.cssText = 'background: #34495e; padding: 2rem; border-radius: 8px; max-width: 1000px; width: 100%; max-height: 90vh; overflow-y: auto;';

    content.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="color: #3498db; margin: 0;">Audit Log</h2>
            <div style="display: flex; gap: 0.5rem;">
                <button onclick="exportAuditLogToCSV()" style="background: #2ecc71; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
                    <i class="fas fa-file-csv"></i> Export CSV
                </button>
                <button onclick="exportAuditLogToPDF()" style="background: #3498db; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
                    <i class="fas fa-file-pdf"></i> Export PDF
                </button>
                <button onclick="closeAuditLog()" style="background: #e74c3c; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Close</button>
            </div>
        </div>
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #2c3e50;">
                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #3498db;">Timestamp</th>
                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #3498db;">User</th>
                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #3498db;">Action</th>
                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #3498db;">Entity</th>
                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #3498db;">Changes</th>
                </tr>
            </thead>
            <tbody>
                ${entries.map(e => `
                    <tr style="border-bottom: 1px solid #7f8c8d;">
                        <td style="padding: 0.75rem; font-size: 0.85rem;">${new Date(e.timestamp).toLocaleString()}</td>
                        <td style="padding: 0.75rem;">${escapeHtml(e.user)}</td>
                        <td style="padding: 0.75rem;"><span style="background: ${e.action === 'delete' ? '#e74c3c' : e.action === 'create' ? '#2ecc71' : '#3498db'}; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.8rem;">${e.action.toUpperCase()}</span></td>
                        <td style="padding: 0.75rem; font-size: 0.85rem;">${escapeHtml(e.entityType)}</td>
                        <td style="padding: 0.75rem; font-size: 0.85rem;">${e.changes ? Object.keys(e.changes).length + ' field(s)' : '-'}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;

    modal.appendChild(content);
    document.body.appendChild(modal);

    modal.onclick = (e) => {
        if (e.target === modal) closeAuditLog();
    };
}

function closeAuditLog() {
    const modal = document.getElementById('audit-modal');
    if (modal) modal.remove();
}

function exportAuditLog() {
    const entries = getAuditHistory();
    const csv = [
        ['Timestamp', 'User', 'Action', 'Entity Type', 'Entity ID', 'Changes', 'Reason'].join(','),
        ...entries.map(e => [
            new Date(e.timestamp).toISOString(),
            e.user,
            e.action,
            e.entityType,
            e.entityId,
            e.changes ? JSON.stringify(e.changes) : '',
            e.reason || ''
        ].map(field => `"${String(field).replace(/"/g, '""')}"`).join(','))
    ].join('\n');

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `audit-log-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    URL.revokeObjectURL(url);

    showToast('Audit log exported to CSV', 'success');
}

// ========== P1-2: AUTOMATED BACKUP SYSTEM ==========

function createAutomatedBackup() {
    const backup = {
        id: genId(),
        timestamp: new Date().toISOString(),
        version: '1.0',
        data: {
            members: storage.getMembers(),
            events: storage.getEvents(),
            groupConscienceLog: storage.getGroupConscienceLog(),
            servicePositions: storage.getServicePositions(),
            budgetCategories: storage.getBudgetCategories(),
            expenses: storage.getExpenses(),
            chairpersonLog: storage.getChairpersonLog(),
            announcements: storage.getAnnouncements(),
            photos: storage.getPhotos(),
            messages: storage.getMessages(),
            nominations: storage.getNominations(),
            notifications: JSON.parse(localStorage.getItem('notifications') || '[]'),
            auditLog: JSON.parse(localStorage.getItem('auditLog') || '[]'),
            settings: {
                gcSettings: JSON.parse(localStorage.getItem('gcSettings') || '{}'),
                votingSettings: JSON.parse(localStorage.getItem('votingSettings') || '{}'),
                currentUser: localStorage.getItem('currentUser'),
                treasurerBalance: localStorage.getItem('treasurerBalance')
            }
        }
    };

    // Store in backup history
    const backups = JSON.parse(localStorage.getItem('backupHistory') || '[]');
    backups.push({
        id: backup.id,
        timestamp: backup.timestamp,
        size: JSON.stringify(backup).length
    });

    // Keep only last 30 backups in history
    if (backups.length > 30) {
        backups.splice(0, backups.length - 30);
    }

    localStorage.setItem('backupHistory', JSON.stringify(backups));
    localStorage.setItem(`backup_${backup.id}`, JSON.stringify(backup));

    return backup;
}

function exportBackupToFile() {
    const backup = createAutomatedBackup();
    const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `aa-group-backup-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);

    showToast('Backup exported successfully', 'success');
    logAuditEntry('export', 'full-backup', backup.id, null, 'Manual backup export');
}

function importBackupFromFile() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';

    input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const backup = JSON.parse(event.target.result);

                if (!backup.data || !backup.timestamp) {
                    throw new Error('Invalid backup file format');
                }

                const confirmed = confirm(
                    `This will restore data from backup created on ${new Date(backup.timestamp).toLocaleString()}.\n\n` +
                    `Current data will be overwritten. This cannot be undone.\n\n` +
                    `Create a backup of current data first?`
                );

                if (!confirmed) return;

                // Create backup of current data before restoring
                exportBackupToFile();

                // Wait a moment for backup to complete
                setTimeout(() => {
                    restoreFromBackup(backup);
                }, 1000);

            } catch (error) {
                showToast('Error importing backup: ' + error.message, 'error');
                console.error('Backup import error:', error);
            }
        };

        reader.readAsText(file);
    };

    input.click();
}

function restoreFromBackup(backup) {
    try {
        const data = backup.data;

        // Restore all data
        if (data.members) storage.saveMembers(data.members);
        if (data.events) storage.saveEvents(data.events);
        if (data.groupConscienceLog) storage.saveGroupConscienceLog(data.groupConscienceLog);
        if (data.servicePositions) storage.saveServicePositions(data.servicePositions);
        if (data.budgetCategories) storage.saveBudgetCategories(data.budgetCategories);
        if (data.expenses) storage.saveExpenses(data.expenses);
        if (data.chairpersonLog) storage.saveChairpersonLog(data.chairpersonLog);
        if (data.announcements) storage.saveAnnouncements(data.announcements);
        if (data.photos) storage.savePhotos(data.photos);
        if (data.messages) storage.saveMessages(data.messages);
        if (data.nominations) storage.saveNominations(data.nominations);
        if (data.notifications) localStorage.setItem('notifications', JSON.stringify(data.notifications));
        if (data.auditLog) localStorage.setItem('auditLog', JSON.stringify(data.auditLog));

        // Restore settings
        if (data.settings) {
            if (data.settings.gcSettings) localStorage.setItem('gcSettings', JSON.stringify(data.settings.gcSettings));
            if (data.settings.votingSettings) localStorage.setItem('votingSettings', JSON.stringify(data.settings.votingSettings));
            if (data.settings.currentUser) localStorage.setItem('currentUser', data.settings.currentUser);
            if (data.settings.treasurerBalance) localStorage.setItem('treasurerBalance', data.settings.treasurerBalance);
        }

        logAuditEntry('import', 'full-backup', backup.id, null, 'Restored from backup file');

        showToast('Backup restored successfully! Refreshing page...', 'success');

        // Refresh page to reload all data
        setTimeout(() => {
            window.location.reload();
        }, 2000);

    } catch (error) {
        showToast('Error restoring backup: ' + error.message, 'error');
        console.error('Backup restore error:', error);
    }
}

function scheduleAutomatedBackups() {
    // Check if automated backups are enabled
    const backupSettings = JSON.parse(localStorage.getItem('backupSettings') || '{"enabled": true, "frequency": "daily"}');

    if (!backupSettings.enabled) return;

    const lastBackup = localStorage.getItem('lastAutomatedBackup');
    const now = new Date();

    let shouldBackup = false;

    if (!lastBackup) {
        shouldBackup = true;
    } else {
        const lastBackupDate = new Date(lastBackup);
        const hoursSinceBackup = (now - lastBackupDate) / (1000 * 60 * 60);

        if (backupSettings.frequency === 'daily' && hoursSinceBackup >= 24) {
            shouldBackup = true;
        } else if (backupSettings.frequency === 'weekly' && hoursSinceBackup >= 168) {
            shouldBackup = true;
        }
    }

    if (shouldBackup) {
        createAutomatedBackup();
        localStorage.setItem('lastAutomatedBackup', now.toISOString());
        console.log('Automated backup created:', now.toISOString());

        createNotification({
            type: 'backup-created',
            title: 'Automatic Backup Created',
            message: 'Your data has been automatically backed up.',
            priority: 'normal'
        });
    }
}

function viewBackupHistory() {
    const backups = JSON.parse(localStorage.getItem('backupHistory') || '[]')
        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

    const modal = document.createElement('div');
    modal.id = 'backup-modal';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';

    const content = document.createElement('div');
    content.style.cssText = 'background: #34495e; padding: 2rem; border-radius: 8px; max-width: 600px; max-height: 80vh; overflow-y: auto; width: 90%;';

    content.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="color: #3498db; margin: 0;">Backup History</h2>
            <button onclick="closeBackupHistory()" style="background: #e74c3c; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Close</button>
        </div>
        <div style="margin-bottom: 1rem;">
            <button onclick="exportBackupToFile()" style="background: #2ecc71; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; margin-right: 0.5rem;">Create New Backup</button>
            <button onclick="importBackupFromFile()" style="background: #3498db; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Import Backup</button>
        </div>
        <div>
            ${backups.length === 0 ? '<p style="color: #95a5a6;">No backups yet</p>' :
                backups.map(b => `
                    <div style="background: #2c3e50; padding: 1rem; border-radius: 6px; margin-bottom: 0.75rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <p style="margin: 0; color: #ecf0f1;"><strong>${new Date(b.timestamp).toLocaleString()}</strong></p>
                                <small style="color: #95a5a6;">Size: ${(b.size / 1024).toFixed(2)} KB</small>
                            </div>
                            <button onclick="restoreBackupById('${b.id}')" style="background: #f39c12; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">Restore</button>
                        </div>
                    </div>
                `).join('')
            }
        </div>
    `;

    modal.appendChild(content);
    document.body.appendChild(modal);

    modal.onclick = (e) => {
        if (e.target === modal) closeBackupHistory();
    };
}

function closeBackupHistory() {
    const modal = document.getElementById('backup-modal');
    if (modal) modal.remove();
}

function restoreBackupById(backupId) {
    const backupData = localStorage.getItem(`backup_${backupId}`);
    if (!backupData) {
        showToast('Backup not found', 'error');
        return;
    }

    const backup = JSON.parse(backupData);
    restoreFromBackup(backup);
}

// ========== P2-1: MEMBER ENGAGEMENT SCORE ==========

function calculateMemberEngagementScore(memberId) {
    // Get member data
    const members = storage.getMembers();
    const member = members.find(m => m.id === memberId || m.name === memberId);

    if (!member) return 0;

    let score = 0;
    const weights = {
        attendance: 30,
        gcParticipation: 25,
        service: 25,
        sponsorship: 10,
        committees: 10
    };

    // 1. Meeting Attendance (30 points)
    const chairpersonLogs = storage.getChairpersonLog();
    const recentLogs = chairpersonLogs.filter(log => {
        const logDate = new Date(log.date);
        const monthsAgo = new Date();
        monthsAgo.setMonth(monthsAgo.getMonth() - 3);
        return logDate >= monthsAgo;
    });

    if (recentLogs.length > 0) {
        // Assume average attendance if member data not detailed
        score += weights.attendance * 0.75; // Default 75% attendance
    }

    // 2. GC Participation (25 points)
    const gcLogs = storage.getGroupConscienceLog();
    const recentGC = gcLogs.filter(log => {
        const logDate = new Date(log.date);
        const monthsAgo = new Date();
        monthsAgo.setMonth(monthsAgo.getMonth() - 6);
        return logDate >= monthsAgo;
    });

    const participationCount = recentGC.filter(log =>
        log.attendees && log.attendees.includes(member.name)
    ).length;

    if (recentGC.length > 0) {
        const participationRate = participationCount / recentGC.length;
        score += weights.gcParticipation * participationRate;
    }

    // 3. Service Position (25 points)
    const positions = storage.getServicePositions();
    const hasService = positions.some(p => p.currentHolder === member.name);

    if (hasService) {
        score += weights.service;
    }

    // 4. Sponsorship (10 points) - Check if has sponsor/sponsees
    if (member.sponsor) {
        score += weights.sponsorship * 0.5;
    }
    // Could add sponsee tracking later
    score += weights.sponsorship * 0.5; // Assume active in sponsorship

    // 5. Committee Participation (10 points)
    // Could be enhanced with committee tracking
    score += weights.committees * 0.5; // Default partial credit

    return Math.round(score);
}

function getGroupEngagementMetrics() {
    const members = storage.getMembers();

    if (members.length === 0) {
        return {
            averageScore: 0,
            totalMembers: 0,
            highEngagement: 0,
            mediumEngagement: 0,
            lowEngagement: 0,
            disengaged: 0
        };
    }

    const scores = members.map(m => calculateMemberEngagementScore(m.id || m.name));
    const averageScore = scores.reduce((a, b) => a + b, 0) / scores.length;

    return {
        averageScore: Math.round(averageScore),
        totalMembers: members.length,
        highEngagement: scores.filter(s => s >= 75).length,
        mediumEngagement: scores.filter(s => s >= 50 && s < 75).length,
        lowEngagement: scores.filter(s => s >= 25 && s < 50).length,
        disengaged: scores.filter(s => s < 25).length
    };
}

function displayEngagementDashboard() {
    const metrics = getGroupEngagementMetrics();

    const modal = document.createElement('div');
    modal.id = 'engagement-modal';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';

    const content = document.createElement('div');
    content.style.cssText = 'background: #34495e; padding: 2rem; border-radius: 8px; max-width: 800px; max-height: 80vh; overflow-y: auto; width: 90%;';

    content.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="color: #3498db; margin: 0;">Member Engagement Dashboard</h2>
            <button onclick="closeEngagementDashboard()" style="background: #e74c3c; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Close</button>
        </div>

        <div style="background: #2c3e50; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
            <h3 style="color: #3498db; margin: 0 0 1rem 0;">Group Overview</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div>
                    <p style="margin: 0.5rem 0;"><strong>Total Members:</strong> ${metrics.totalMembers}</p>
                    <p style="margin: 0.5rem 0;"><strong>Average Engagement:</strong> <span style="color: ${metrics.averageScore >= 75 ? '#2ecc71' : metrics.averageScore >= 50 ? '#f39c12' : '#e74c3c'}; font-size: 1.2rem; font-weight: bold;">${metrics.averageScore}%</span></p>
                </div>
                <div>
                    <p style="margin: 0.5rem 0; color: #2ecc71;"><strong>High (75%+):</strong> ${metrics.highEngagement}</p>
                    <p style="margin: 0.5rem 0; color: #f39c12;"><strong>Medium (50-74%):</strong> ${metrics.mediumEngagement}</p>
                    <p style="margin: 0.5rem 0; color: #e67e22;"><strong>Low (25-49%):</strong> ${metrics.lowEngagement}</p>
                    <p style="margin: 0.5rem 0; color: #e74c3c;"><strong>Disengaged (<25%):</strong> ${metrics.disengaged}</p>
                </div>
            </div>
        </div>

        ${metrics.averageScore < 60 ? `
            <div style="background: #e67e22; padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem;">
                <h4 style="margin: 0 0 0.5rem 0; color: white;"><i class="fas fa-exclamation-triangle"></i> Engagement Below Target</h4>
                <p style="margin: 0; color: white;">Group engagement is below the healthy threshold (60%). Consider:</p>
                <ul style="margin: 0.5rem 0; padding-left: 1.5rem; color: white;">
                    <li>Checking in with members who haven't attended recently</li>
                    <li>Creating opportunities for service</li>
                    <li>Hosting special events or workshops</li>
                </ul>
            </div>
        ` : ''}

        <div style="background: #2c3e50; padding: 1.5rem; border-radius: 8px;">
            <h3 style="color: #3498db; margin: 0 0 1rem 0;">Engagement Breakdown</h3>
            <p style="color: #ecf0f1; font-size: 0.9rem; margin-bottom: 1rem;">
                Engagement score is calculated from:<br>
                • Meeting Attendance (30%)<br>
                • GC Participation (25%)<br>
                • Service Positions (25%)<br>
                • Sponsorship Activity (10%)<br>
                • Committee Involvement (10%)
            </p>
        </div>
    `;

    modal.appendChild(content);
    document.body.appendChild(modal);

    modal.onclick = (e) => {
        if (e.target === modal) closeEngagementDashboard();
    };
}

function closeEngagementDashboard() {
    const modal = document.getElementById('engagement-modal');
    if (modal) modal.remove();
}

// Check for disengaged members and create notifications
function checkMemberEngagement() {
    const metrics = getGroupEngagementMetrics();

    if (metrics.disengaged > 0) {
        createNotification({
            type: 'low-engagement',
            title: `${metrics.disengaged} Member${metrics.disengaged > 1 ? 's' : ''} Showing Low Engagement`,
            message: `Some members may need outreach. Consider checking in with less active members.`,
            priority: 'normal',
            actionLink: 'birthdays-section'
        });
    }

    if (metrics.averageScore < 50) {
        createNotification({
            type: 'group-engagement-low',
            title: 'Group Engagement Below 50%',
            message: `Overall group participation is low. Group conscience may want to discuss ways to increase engagement.`,
            priority: 'high',
            actionLink: 'analytics-section'
        });
    }
}

// ========== P3-1: TRADITION OF THE MONTH FOCUS ==========

function getTraditionOfMonth() {
    const today = new Date();
    const month = today.getMonth(); // 0-11
    const tradition = (month % 12) + 1; // 1-12
    return tradition;
}

function getTraditionDetails(traditionNumber) {
    const traditions = {
        1: {
            title: "Our common welfare should come first; personal recovery depends upon A.A. unity.",
            description: "Unity is essential. Without it, we have nothing. Group unity must come before personal desires.",
            reflectionQuestions: [
                "How does our group practice unity?",
                "Are there any actions threatening group unity?",
                "How can we better support each other's recovery?"
            ]
        },
        2: {
            title: "For our group purpose there is but one ultimate authority—a loving God as He may express Himself in our group conscience. Our leaders are but trusted servants; they do not govern.",
            description: "Group conscience, not individuals, guides us. Leaders serve rather than govern.",
            reflectionQuestions: [
                "Do we truly seek group conscience or just majority vote?",
                "Are our trusted servants serving or governing?",
                "How do we listen for God's will in our decisions?"
            ]
        },
        3: {
            title: "The only requirement for A.A. membership is a desire to stop drinking.",
            description: "No barriers to membership. Anyone who wants to stop drinking is welcome.",
            reflectionQuestions: [
                "Do we make everyone feel welcome?",
                "Are there any unwritten requirements we've created?",
                "How do we receive newcomers?"
            ]
        },
        4: {
            title: "Each group should be autonomous except in matters affecting other groups or A.A. as a whole.",
            description: "Freedom to operate as we see fit, with responsibility to the fellowship.",
            reflectionQuestions: [
                "Are we exercising our autonomy responsibly?",
                "Do our actions affect other groups or AA as a whole?",
                "Are we following AA principles in our autonomy?"
            ]
        },
        5: {
            title: "Each group has but one primary purpose—to carry its message to the alcoholic who still suffers.",
            description: "Our primary purpose guides all decisions. Everything else is secondary.",
            reflectionQuestions: [
                "Is carrying the message our top priority?",
                "Are we diluting our primary purpose?",
                "How effectively are we reaching the suffering alcoholic?"
            ]
        },
        6: {
            title: "An A.A. group ought never endorse, finance, or lend the A.A. name to any related facility or outside enterprise.",
            description: "We maintain our independence and avoid outside affiliations.",
            reflectionQuestions: [
                "Are we keeping AA separate from other organizations?",
                "Do we avoid endorsements?",
                "Are our relationships with facilities appropriate?"
            ]
        },
        7: {
            title: "Every A.A. group ought to be fully self-supporting, declining outside contributions.",
            description: "We pay our own way. Self-support maintains our independence.",
            reflectionQuestions: [
                "Are we fully self-supporting?",
                "Do we meet our financial obligations?",
                "Are we generous with our contributions?"
            ]
        },
        8: {
            title: "Alcoholics Anonymous should remain forever nonprofessional, but our service centers may employ special workers.",
            description: "We carry the message freely. No payment for 12th step work.",
            reflectionQuestions: [
                "Do we maintain our nonprofessional status?",
                "Are there any conflicts of interest?",
                "Do we give freely what was freely given to us?"
            ]
        },
        9: {
            title: "A.A., as such, ought never be organized; but we may create service boards or committees directly responsible to those they serve.",
            description: "Minimal organization. Service structures serve, not govern.",
            reflectionQuestions: [
                "Are our service structures servant, not master?",
                "Do we avoid over-organization?",
                "Are committees responsible to the group?"
            ]
        },
        10: {
            title: "Alcoholics Anonymous has no opinion on outside issues; hence the A.A. name ought never be drawn into public controversy.",
            description: "We stay focused on our primary purpose and avoid controversy.",
            reflectionQuestions: [
                "Do we avoid outside issues?",
                "Have we drawn AA into any controversies?",
                "Do we maintain public neutrality?"
            ]
        },
        11: {
            title: "Our public relations policy is based on attraction rather than promotion; we need always maintain personal anonymity at the level of press, radio, and films.",
            description: "Attraction not promotion. Anonymity protects the fellowship.",
            reflectionQuestions: [
                "Do we practice attraction rather than promotion?",
                "Are we protecting anonymity in public?",
                "How is our group attractive to newcomers?"
            ]
        },
        12: {
            title: "Anonymity is the spiritual foundation of all our traditions, ever reminding us to place principles before personalities.",
            description: "Anonymity keeps us humble and focused on principles.",
            reflectionQuestions: [
                "Do we practice principles before personalities?",
                "How does anonymity protect our fellowship?",
                "Are we humble in our service?"
            ]
        }
    };

    return traditions[traditionNumber] || traditions[1];
}

function displayTraditionOfMonth() {
    const traditionNum = getTraditionOfMonth();
    const tradition = getTraditionDetails(traditionNum);

    const modal = document.createElement('div');
    modal.id = 'tradition-modal';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 1rem;';

    const content = document.createElement('div');
    content.style.cssText = 'background: #34495e; padding: 2rem; border-radius: 8px; max-width: 700px; max-height: 90vh; overflow-y: auto; width: 100%;';

    content.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="color: #3498db; margin: 0;">Tradition ${traditionNum} - ${new Date().toLocaleString('default', { month: 'long' })}</h2>
            <button onclick="closeTraditionModal()" style="background: #e74c3c; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Close</button>
        </div>

        <div style="background: #2c3e50; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid #3498db;">
            <p style="color: #ecf0f1; font-size: 1.1rem; font-style: italic; line-height: 1.6;">
                "${tradition.title}"
            </p>
        </div>

        <div style="background: #2c3e50; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
            <h3 style="color: #3498db; margin: 0 0 1rem 0;">Understanding This Tradition</h3>
            <p style="color: #ecf0f1; line-height: 1.6;">${tradition.description}</p>
        </div>

        <div style="background: #2c3e50; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
            <h3 style="color: #3498db; margin: 0 0 1rem 0;">Reflection Questions</h3>
            <ul style="color: #ecf0f1; line-height: 1.8; padding-left: 1.5rem;">
                ${tradition.reflectionQuestions.map(q => `<li style="margin-bottom: 0.5rem;">${q}</li>`).join('')}
            </ul>
        </div>

        <div style="margin-top: 1.5rem; text-align: center;">
            <button onclick="scheduleGroupInventory(${traditionNum})" style="background: #2ecc71; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer;">
                Schedule Group Inventory on This Tradition
            </button>
        </div>
    `;

    modal.appendChild(content);
    document.body.appendChild(modal);

    modal.onclick = (e) => {
        if (e.target === modal) closeTraditionModal();
    };
}

function closeTraditionModal() {
    const modal = document.getElementById('tradition-modal');
    if (modal) modal.remove();
}

// ========== P3-2: GROUP INVENTORY WORKFLOW ==========

function scheduleGroupInventory(traditionNumber = null) {
    const modal = document.createElement('div');
    modal.id = 'inventory-schedule-modal';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10001; display: flex; align-items: center; justify-content: center; padding: 1rem;';

    const content = document.createElement('div');
    content.style.cssText = 'background: #34495e; padding: 2rem; border-radius: 8px; max-width: 600px; width: 100%;';

    const inventoryTypes = [
        {value: 'traditions', label: '12 Traditions Inventory', duration: '2-3 hours'},
        {value: 'concepts', label: '12 Concepts Inventory', duration: '2-3 hours'},
        {value: 'format', label: 'Meeting Format Inventory', duration: '1-2 hours'},
        {value: 'service', label: 'Service Structure Inventory', duration: '1-2 hours'},
        {value: 'custom', label: 'Custom Group Inventory', duration: 'Varies'}
    ];

    content.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="color: #3498db; margin: 0;">Schedule Group Inventory</h2>
            <button onclick="closeInventoryScheduleModal()" style="background: #e74c3c; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Close</button>
        </div>

        <div class="form-group">
            <label>Inventory Type</label>
            <select id="inventory-type" onchange="updateInventoryPreview()">
                ${inventoryTypes.map(t => `
                    <option value="${t.value}" ${traditionNumber && t.value === 'traditions' ? 'selected' : ''}>
                        ${t.label} (${t.duration})
                    </option>
                `).join('')}
            </select>
        </div>

        <div class="form-group">
            <label>Scheduled Date</label>
            <input type="date" id="inventory-date" />
        </div>

        <div class="form-group">
            <label>Facilitator</label>
            <input type="text" id="inventory-facilitator" placeholder="Who will lead the inventory?" />
        </div>

        <div id="inventory-preview" style="background: #2c3e50; padding: 1rem; border-radius: 6px; margin: 1rem 0;">
            <h4 style="color: #3498db; margin: 0 0 0.5rem 0;">Inventory Preview</h4>
            <p style="color: #ecf0f1; font-size: 0.9rem;">Select a type to see details</p>
        </div>

        <div style="margin-top: 1.5rem; text-align: center;">
            <button onclick="createInventorySchedule()" style="background: #2ecc71; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer; margin-right: 0.5rem;">
                Schedule Inventory
            </button>
            <button onclick="closeInventoryScheduleModal()" style="background: #95a5a6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer;">
                Cancel
            </button>
        </div>
    `;

    modal.appendChild(content);
    document.body.appendChild(modal);

    const nextMonth = new Date();
    nextMonth.setMonth(nextMonth.getMonth() + 1);
    document.getElementById('inventory-date').value = nextMonth.toISOString().split('T')[0];

    updateInventoryPreview();
}

function updateInventoryPreview() {
    const type = document.getElementById('inventory-type')?.value;
    const preview = document.getElementById('inventory-preview');

    if (!type || !preview) return;

    const inventoryContent = {
        traditions: {
            title: '12 Traditions Inventory',
            description: 'A comprehensive review of how well the group follows each of the 12 Traditions.',
            questions: ['Are we unified as a group?', 'Do leaders serve or govern?', 'Is anyone excluded?', 'Are we autonomous responsibly?']
        },
        concepts: {
            title: '12 Concepts Inventory',
            description: 'Review of service structure and leadership principles.',
            questions: ['Is authority properly placed?', 'Do we respect the right of decision?', 'Is participation encouraged?']
        },
        format: {
            title: 'Meeting Format Inventory',
            description: 'Evaluate meeting structure, timing, and effectiveness.',
            questions: ['Is our format effective?', 'Do we follow the format consistently?', 'Is there time for everyone to share?']
        },
        service: {
            title: 'Service Structure Inventory',
            description: 'Review service positions, rotation, and effectiveness.',
            questions: ['Are all positions filled?', 'Is rotation happening?', 'Are servants supported?']
        },
        custom: {
            title: 'Custom Group Inventory',
            description: 'Create your own inventory questions based on group needs.',
            questions: ['Define your own questions', 'Address specific group concerns']
        }
    };

    const content = inventoryContent[type];

    preview.innerHTML = `
        <h4 style="color: #3498db; margin: 0 0 0.5rem 0;">${content.title}</h4>
        <p style="color: #ecf0f1; font-size: 0.9rem; margin-bottom: 0.75rem;">${content.description}</p>
        <p style="color: #95a5a6; font-size: 0.85rem;"><strong>Sample Questions:</strong></p>
        <ul style="color: #95a5a6; font-size: 0.85rem; padding-left: 1.5rem;">
            ${content.questions.map(q => `<li>${q}</li>`).join('')}
        </ul>
    `;
}

function createInventorySchedule() {
    const type = document.getElementById('inventory-type').value;
    const date = document.getElementById('inventory-date').value;
    const facilitator = document.getElementById('inventory-facilitator').value.trim();

    if (!date) {
        showToast('Please select a date', 'error');
        return;
    }

    const inventories = JSON.parse(localStorage.getItem('groupInventories') || '[]');

    const inventory = {
        id: genId(),
        type: type,
        date: date,
        facilitator: facilitator,
        status: 'scheduled',
        createdDate: new Date().toISOString(),
        results: null,
        actionItems: []
    };

    inventories.push(inventory);
    localStorage.setItem('groupInventories', JSON.stringify(inventories));

    createNotification({
        type: 'group-inventory',
        title: 'Group Inventory Scheduled',
        message: `${type.charAt(0).toUpperCase() + type.slice(1)} inventory scheduled for ${new Date(date).toLocaleDateString()}`,
        priority: 'high',
        actionLink: 'inventory-scheduler-section'
    });

    logAuditEntry('create', 'group-inventory', inventory.id, {type, date, facilitator}, 'Group inventory scheduled');

    showToast('Group inventory scheduled successfully!', 'success');
    closeInventoryScheduleModal();
    closeTraditionModal();
}

function closeInventoryScheduleModal() {
    const modal = document.getElementById('inventory-schedule-modal');
    if (modal) modal.remove();
}

// ========== P3-3: GSR/DCM COMMUNICATION TOOLS ==========

function openGSRDashboard() {
    const modal = document.createElement('div');
    modal.id = 'gsr-dashboard-modal';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 1rem;';

    const districtMotions = JSON.parse(localStorage.getItem('districtMotions') || '[]');
    const pendingMotions = districtMotions.filter(m => m.status === 'pending');

    const content = document.createElement('div');
    content.style.cssText = 'background: #34495e; padding: 2rem; border-radius: 8px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto;';

    content.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="color: #3498db; margin: 0;">GSR Dashboard</h2>
            <button onclick="closeGSRDashboard()" style="background: #e74c3c; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Close</button>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 2rem;">
            <div style="background: #2c3e50; padding: 1.5rem; border-radius: 8px; text-align: center;">
                <h3 style="color: #f39c12; margin: 0; font-size: 2rem;">${pendingMotions.length}</h3>
                <p style="color: #95a5a6; margin: 0.5rem 0 0 0; font-size: 0.9rem;">Pending District Motions</p>
            </div>
            <div style="background: #2c3e50; padding: 1.5rem; border-radius: 8px; text-align: center;">
                <h3 style="color: #3498db; margin: 0; font-size: 1.5rem;">${new Date().toLocaleDateString('default', {month: 'long'})}</h3>
                <p style="color: #95a5a6; margin: 0.5rem 0 0 0; font-size: 0.9rem;">District Meeting</p>
            </div>
            <div style="background: #2c3e50; padding: 1.5rem; border-radius: 8px; text-align: center;">
                <h3 style="color: #2ecc71; margin: 0; font-size: 2rem;">Active</h3>
                <p style="color: #95a5a6; margin: 0.5rem 0 0 0; font-size: 0.9rem;">GSR Status</p>
            </div>
        </div>

        <div style="background: #2c3e50; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
            <h3 style="color: #3498db; margin: 0 0 1rem 0;">Quick Actions</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <button onclick="generateGSRReport()" style="background: #2ecc71; color: white; border: none; padding: 0.75rem; border-radius: 4px; cursor: pointer;">
                    <i class="fas fa-file-alt"></i> Generate GSR Report
                </button>
                <button onclick="displayTraditionOfMonth()" style="background: #9b59b6; color: white; border: none; padding: 0.75rem; border-radius: 4px; cursor: pointer;">
                    <i class="fas fa-book"></i> Tradition of Month
                </button>
            </div>
        </div>

        <div style="background: #2c3e50; padding: 1.5rem; border-radius: 8px;">
            <h3 style="color: #3498db; margin: 0 0 1rem 0;">Pending District Motions</h3>
            ${pendingMotions.length === 0 ?
                '<p style="color: #95a5a6; text-align: center;">No pending motions</p>' :
                pendingMotions.map(m => `
                    <div style="background: #34495e; padding: 1rem; border-radius: 6px; margin-bottom: 0.75rem;">
                        <h4 style="color: #3498db; margin: 0 0 0.5rem 0;">${escapeHtml(m.title || 'District Motion')}</h4>
                        <p style="color: #ecf0f1; font-size: 0.9rem; margin: 0 0 0.5rem 0;">${escapeHtml(m.description || '')}</p>
                        <small style="color: #95a5a6;">Due: ${m.deadline ? new Date(m.deadline).toLocaleDateString() : 'TBD'}</small>
                    </div>
                `).join('')
            }
        </div>
    `;

    modal.appendChild(content);
    document.body.appendChild(modal);

    modal.onclick = (e) => {
        if (e.target === modal) closeGSRDashboard();
    };
}

function closeGSRDashboard() {
    const modal = document.getElementById('gsr-dashboard-modal');
    if (modal) modal.remove();
}

function generateGSRReport() {
    const gcLogs = storage.getGroupConscienceLog();
    const recentGC = gcLogs.filter(log => {
        const logDate = new Date(log.date);
        const monthsAgo = new Date();
        monthsAgo.setMonth(monthsAgo.getMonth() - 1);
        return logDate >= monthsAgo;
    });

    const chairpersonLogs = storage.getChairpersonLog();
    const recentMeetings = chairpersonLogs.filter(log => {
        const logDate = new Date(log.date);
        const monthsAgo = new Date();
        monthsAgo.setMonth(monthsAgo.getMonth() - 1);
        return logDate >= monthsAgo;
    });

    const totalContributions = recentMeetings.reduce((sum, log) => sum + (parseFloat(log.tradition) || 0), 0);
    const avgAttendance = recentMeetings.length > 0
        ? Math.round(recentMeetings.reduce((sum, log) => sum + (parseInt(log.headcount) || 0), 0) / recentMeetings.length)
        : 0;

    const report = `
GSR MONTHLY REPORT
${new Date().toLocaleDateString('default', { month: 'long', year: 'numeric' })}

GROUP INFORMATION:
- Meetings This Month: ${recentMeetings.length}
- Average Attendance: ${avgAttendance}
- Total 7th Tradition: $${totalContributions.toFixed(2)}

GROUP CONSCIENCE ACTIVITY:
- Motions Voted: ${recentGC.length}
- Passed: ${recentGC.filter(m => m.status === 'passed').length}
- Failed: ${recentGC.filter(m => m.status === 'failed').length}
- Tabled: ${recentGC.filter(m => m.status === 'tabled').length}

KEY DECISIONS:
${recentGC.slice(0, 5).map(m => `- ${m.item} (${m.status})`).join('\n')}

GROUP HEALTH:
Our group is ${avgAttendance >= 10 ? 'strong and growing' : 'stable'}.

Respectfully submitted,
[GSR Name]
${new Date().toLocaleDateString()}
    `;

    const blob = new Blob([report], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `gsr-report-${new Date().toISOString().split('T')[0]}.txt`;
    a.click();
    URL.revokeObjectURL(url);

    showToast('GSR report generated and downloaded', 'success');
    logAuditEntry('export', 'gsr-report', genId(), null, 'GSR report generated');
}

// ========== P4-1: EXECUTIVE DASHBOARD ==========

function displayExecutiveDashboard() {
    const members = storage.getMembers();
    const positions = storage.getServicePositions();
    const gcLogs = storage.getGroupConscienceLog();
    const expenses = storage.getExpenses();
    const chairpersonLogs = storage.getChairpersonLog();

    // Calculate metrics
    const filledPositions = positions.filter(p => p.currentHolder && p.currentHolder !== '').length;
    const totalPositions = positions.length;
    const positionFillRate = totalPositions > 0 ? Math.round((filledPositions / totalPositions) * 100) : 0;

    const recentGC = gcLogs.filter(log => {
        const logDate = new Date(log.date);
        const monthsAgo = new Date();
        monthsAgo.setMonth(monthsAgo.getMonth() - 1);
        return logDate >= monthsAgo;
    });

    const recentMeetings = chairpersonLogs.filter(log => {
        const logDate = new Date(log.date);
        const monthsAgo = new Date();
        monthsAgo.setMonth(monthsAgo.getMonth() - 1);
        return logDate >= monthsAgo;
    });

    const avgAttendance = recentMeetings.length > 0
        ? Math.round(recentMeetings.reduce((sum, log) => sum + (parseInt(log.headcount) || 0), 0) / recentMeetings.length)
        : 0;

    const totalIncome = recentMeetings.reduce((sum, log) => sum + (parseFloat(log.tradition) || 0), 0);

    const recentExpenses = expenses.filter(e => {
        const expDate = new Date(e.date);
        const monthsAgo = new Date();
        monthsAgo.setMonth(monthsAgo.getMonth() - 1);
        return expDate >= monthsAgo;
    });

    const totalExpenses = recentExpenses.reduce((sum, e) => sum + e.amount, 0);
    const currentBalance = parseFloat(localStorage.getItem('treasurerBalance') || 0);

    const engagementMetrics = getGroupEngagementMetrics();

    const unreadNotifications = getUnreadNotifications();

    const modal = document.createElement('div');
    modal.id = 'exec-dashboard-modal';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 1rem;';

    const content = document.createElement('div');
    content.style.cssText = 'background: #34495e; padding: 2rem; border-radius: 8px; max-width: 1200px; width: 100%; max-height: 90vh; overflow-y: auto;';

    content.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="color: #3498db; margin: 0;">Executive Dashboard</h2>
            <button onclick="closeExecutiveDashboard()" style="background: #e74c3c; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Close</button>
        </div>

        <!-- Key Metrics Grid -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
            <div style="background: #2c3e50; padding: 1.5rem; border-radius: 8px; text-align: center; border-left: 4px solid #3498db;">
                <h3 style="color: #3498db; margin: 0; font-size: 2rem;">${members.length}</h3>
                <p style="color: #95a5a6; margin: 0.5rem 0 0 0; font-size: 0.9rem;">Active Members</p>
            </div>
            <div style="background: #2c3e50; padding: 1.5rem; border-radius: 8px; text-align: center; border-left: 4px solid ${avgAttendance >= 10 ? '#2ecc71' : '#f39c12'};">
                <h3 style="color: ${avgAttendance >= 10 ? '#2ecc71' : '#f39c12'}; margin: 0; font-size: 2rem;">${avgAttendance}</h3>
                <p style="color: #95a5a6; margin: 0.5rem 0 0 0; font-size: 0.9rem;">Avg Attendance</p>
            </div>
            <div style="background: #2c3e50; padding: 1.5rem; border-radius: 8px; text-align: center; border-left: 4px solid ${positionFillRate >= 80 ? '#2ecc71' : '#e74c3c'};">
                <h3 style="color: ${positionFillRate >= 80 ? '#2ecc71' : '#e74c3c'}; margin: 0; font-size: 2rem;">${positionFillRate}%</h3>
                <p style="color: #95a5a6; margin: 0.5rem 0 0 0; font-size: 0.9rem;">Positions Filled</p>
            </div>
            <div style="background: #2c3e50; padding: 1.5rem; border-radius: 8px; text-align: center; border-left: 4px solid ${currentBalance > 0 ? '#2ecc71' : '#e74c3c'};">
                <h3 style="color: ${currentBalance > 0 ? '#2ecc71' : '#e74c3c'}; margin: 0; font-size: 2rem;">$${currentBalance.toFixed(0)}</h3>
                <p style="color: #95a5a6; margin: 0.5rem 0 0 0; font-size: 0.9rem;">Current Balance</p>
            </div>
            <div style="background: #2c3e50; padding: 1.5rem; border-radius: 8px; text-align: center; border-left: 4px solid ${engagementMetrics.averageScore >= 60 ? '#2ecc71' : '#e74c3c'};">
                <h3 style="color: ${engagementMetrics.averageScore >= 60 ? '#2ecc71' : '#e74c3c'}; margin: 0; font-size: 2rem;">${engagementMetrics.averageScore}%</h3>
                <p style="color: #95a5a6; margin: 0.5rem 0 0 0; font-size: 0.9rem;">Engagement Score</p>
            </div>
            <div style="background: #2c3e50; padding: 1.5rem; border-radius: 8px; text-align: center; border-left: 4px solid ${unreadNotifications.length > 0 ? '#f39c12' : '#95a5a6'};">
                <h3 style="color: ${unreadNotifications.length > 0 ? '#f39c12' : '#95a5a6'}; margin: 0; font-size: 2rem;">${unreadNotifications.length}</h3>
                <p style="color: #95a5a6; margin: 0.5rem 0 0 0; font-size: 0.9rem;">Pending Items</p>
            </div>
        </div>

        <!-- Financial Summary -->
        <div style="background: #2c3e50; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
            <h3 style="color: #3498db; margin: 0 0 1rem 0;">Financial Health (Last 30 Days)</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                <div>
                    <p style="margin: 0; color: #95a5a6; font-size: 0.9rem;">Income</p>
                    <p style="margin: 0.25rem 0 0 0; color: #2ecc71; font-size: 1.5rem; font-weight: bold;">$${totalIncome.toFixed(2)}</p>
                </div>
                <div>
                    <p style="margin: 0; color: #95a5a6; font-size: 0.9rem;">Expenses</p>
                    <p style="margin: 0.25rem 0 0 0; color: #e74c3c; font-size: 1.5rem; font-weight: bold;">$${totalExpenses.toFixed(2)}</p>
                </div>
                <div>
                    <p style="margin: 0; color: #95a5a6; font-size: 0.9rem;">Net</p>
                    <p style="margin: 0.25rem 0 0 0; color: ${(totalIncome - totalExpenses) >= 0 ? '#2ecc71' : '#e74c3c'}; font-size: 1.5rem; font-weight: bold;">
                        ${(totalIncome - totalExpenses) >= 0 ? '+' : ''}$${(totalIncome - totalExpenses).toFixed(2)}
                    </p>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div style="background: #2c3e50; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
            <h3 style="color: #3498db; margin: 0 0 1rem 0;">Recent Group Conscience</h3>
            ${recentGC.length === 0 ?
                '<p style="color: #95a5a6;">No recent GC activity</p>' :
                recentGC.slice(0, 3).map(gc => `
                    <div style="padding: 0.75rem 0; border-bottom: 1px solid #34495e;">
                        <p style="margin: 0; color: #ecf0f1;">${escapeHtml(gc.item.substring(0, 80))}${gc.item.length > 80 ? '...' : ''}</p>
                        <small style="color: ${gc.status === 'passed' ? '#2ecc71' : gc.status === 'failed' ? '#e74c3c' : '#f39c12'};">
                            ${gc.status.toUpperCase()} - ${new Date(gc.date).toLocaleDateString()}
                        </small>
                    </div>
                `).join('')
            }
        </div>

        <!-- Quick Actions -->
        <div style="background: #2c3e50; padding: 1.5rem; border-radius: 8px;">
            <h3 style="color: #3498db; margin: 0 0 1rem 0;">Quick Actions</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                <button onclick="displayTreasurerReport()" style="background: #2ecc71; color: white; border: none; padding: 0.75rem; border-radius: 4px; cursor: pointer;">
                    <i class="fas fa-file-invoice-dollar"></i><br>Treasurer Report
                </button>
                <button onclick="generateGSRReport()" style="background: #3498db; color: white; border: none; padding: 0.75rem; border-radius: 4px; cursor: pointer;">
                    <i class="fas fa-file-alt"></i><br>GSR Report
                </button>
                <button onclick="displayEngagementDashboard()" style="background: #9b59b6; color: white; border: none; padding: 0.75rem; border-radius: 4px; cursor: pointer;">
                    <i class="fas fa-chart-line"></i><br>Engagement
                </button>
                <button onclick="displayTraditionOfMonth()" style="background: #e67e22; color: white; border: none; padding: 0.75rem; border-radius: 4px; cursor: pointer;">
                    <i class="fas fa-book"></i><br>Tradition
                </button>
            </div>
        </div>
    `;

    modal.appendChild(content);
    document.body.appendChild(modal);

    modal.onclick = (e) => {
        if (e.target === modal) closeExecutiveDashboard();
    };
}

function closeExecutiveDashboard() {
    const modal = document.getElementById('exec-dashboard-modal');
    if (modal) modal.remove();
}

// ========== P4-2: UNIVERSAL SEARCH ==========

function performUniversalSearch(query) {
    if (!query || query.trim().length < 2) {
        return { results: [], totalCount: 0 };
    }

    const searchTerm = query.toLowerCase().trim();
    const results = [];

    // Search Members
    const members = storage.getMembers();
    members.forEach(m => {
        if (m.name?.toLowerCase().includes(searchTerm) ||
            m.email?.toLowerCase().includes(searchTerm) ||
            m.phone?.toLowerCase().includes(searchTerm)) {
            results.push({
                type: 'member',
                title: m.name,
                description: `${m.email || ''} ${m.phone || ''}`,
                section: 'birthdays-section',
                id: m.id
            });
        }
    });

    // Search GC Motions
    const gcLogs = storage.getGroupConscienceLog();
    gcLogs.forEach(gc => {
        if (gc.item?.toLowerCase().includes(searchTerm) ||
            gc.submittedBy?.toLowerCase().includes(searchTerm)) {
            results.push({
                type: 'gc-motion',
                title: gc.item.substring(0, 100),
                description: `${gc.status} - ${new Date(gc.date).toLocaleDateString()}`,
                section: 'home-section',
                id: gc.id
            });
        }
    });

    // Search Service Positions
    const positions = storage.getServicePositions();
    positions.forEach(p => {
        if (p.name?.toLowerCase().includes(searchTerm) ||
            p.currentHolder?.toLowerCase().includes(searchTerm) ||
            p.description?.toLowerCase().includes(searchTerm)) {
            results.push({
                type: 'service-position',
                title: p.name,
                description: `Held by: ${p.currentHolder || 'Vacant'}`,
                section: 'service-positions-section',
                id: p.id
            });
        }
    });

    // Search Events
    const events = storage.getEvents();
    events.forEach(e => {
        if (e.title?.toLowerCase().includes(searchTerm) ||
            e.description?.toLowerCase().includes(searchTerm) ||
            e.location?.toLowerCase().includes(searchTerm)) {
            results.push({
                type: 'event',
                title: e.title,
                description: `${new Date(e.date).toLocaleDateString()} - ${e.location || ''}`,
                section: 'schedule-section',
                id: e.id
            });
        }
    });

    // Search Expenses
    const expenses = storage.getExpenses();
    expenses.forEach(exp => {
        if (exp.description?.toLowerCase().includes(searchTerm) ||
            exp.category?.toLowerCase().includes(searchTerm)) {
            results.push({
                type: 'expense',
                title: exp.description,
                description: `$${exp.amount.toFixed(2)} - ${exp.category}`,
                section: 'finance-section',
                id: exp.id
            });
        }
    });

    return {
        results: results,
        totalCount: results.length
    };
}

function displayUniversalSearch() {
    const modal = document.createElement('div');
    modal.id = 'universal-search-modal';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: flex-start; justify-content: center; padding-top: 3rem;';

    const content = document.createElement('div');
    content.style.cssText = 'background: #34495e; padding: 2rem; border-radius: 8px; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto;';

    content.innerHTML = `
        <div style="margin-bottom: 1.5rem;">
            <input type="text" id="universal-search-input" placeholder="Search everything..."
                   style="width: 100%; padding: 1rem; font-size: 1.1rem; border: 2px solid #3498db; border-radius: 6px; background: #2c3e50; color: #ecf0f1;"
                   oninput="updateUniversalSearchResults()" />
        </div>
        <div id="universal-search-results" style="min-height: 200px;">
            <p style="color: #95a5a6; text-align: center;">Type to search across all data...</p>
        </div>
    `;

    modal.appendChild(content);
    document.body.appendChild(modal);

    // Focus input
    setTimeout(() => {
        document.getElementById('universal-search-input')?.focus();
    }, 100);

    modal.onclick = (e) => {
        if (e.target === modal) closeUniversalSearch();
    };

    // Close on Escape key
    document.addEventListener('keydown', function escapeHandler(e) {
        if (e.key === 'Escape') {
            closeUniversalSearch();
            document.removeEventListener('keydown', escapeHandler);
        }
    });
}

function updateUniversalSearchResults() {
    const query = document.getElementById('universal-search-input')?.value || '';
    const resultsDiv = document.getElementById('universal-search-results');

    if (!resultsDiv) return;

    if (query.trim().length < 2) {
        resultsDiv.innerHTML = '<p style="color: #95a5a6; text-align: center;">Type at least 2 characters to search...</p>';
        return;
    }

    const searchResults = performUniversalSearch(query);

    if (searchResults.totalCount === 0) {
        resultsDiv.innerHTML = '<p style="color: #95a5a6; text-align: center;">No results found</p>';
        return;
    }

    const typeColors = {
        'member': '#2ecc71',
        'gc-motion': '#3498db',
        'service-position': '#9b59b6',
        'event': '#f39c12',
        'expense': '#e74c3c'
    };

    resultsDiv.innerHTML = `
        <p style="color: #95a5a6; margin-bottom: 1rem;">${searchResults.totalCount} result${searchResults.totalCount !== 1 ? 's' : ''} found</p>
        ${searchResults.results.map(r => `
            <div onclick="goToSection('${r.section}'); closeUniversalSearch();"
                 style="background: #2c3e50; padding: 1rem; border-radius: 6px; margin-bottom: 0.75rem; cursor: pointer; border-left: 4px solid ${typeColors[r.type]};"
                 onmouseover="this.style.background='#34495e'" onmouseout="this.style.background='#2c3e50'">
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <span style="background: ${typeColors[r.type]}; color: white; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.75rem;">
                        ${r.type.toUpperCase()}
                    </span>
                    <div style="flex: 1;">
                        <h4 style="color: #ecf0f1; margin: 0; font-size: 0.95rem;">${escapeHtml(r.title)}</h4>
                        <p style="color: #95a5a6; margin: 0.25rem 0 0 0; font-size: 0.85rem;">${escapeHtml(r.description)}</p>
                    </div>
                </div>
            </div>
        `).join('')}
    `;
}

function closeUniversalSearch() {
    const modal = document.getElementById('universal-search-modal');
    if (modal) modal.remove();
}

// ========== FINANCE FUNCTIONS ==========

function showFinanceTab(tab) {
    document.querySelectorAll('.finance-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.history-nav button').forEach(b => b.classList.remove('active'));

    document.getElementById(`${tab}-content`).classList.add('active');
    document.getElementById(`${tab}-tab`).classList.add('active');

    if (tab === 'budget') updateBudgetTable();
    if (tab === 'expenses') updateExpensesTable();
    if (tab === 'reports') {
        // Set default month to current
        const today = new Date();
        const month = today.toISOString().substring(0, 7);
        document.getElementById('report-month').value = month;
    }
}

function addBudgetCategory() {
    const category = document.getElementById('budget-category').value.trim();
    const amount = parseFloat(document.getElementById('budget-amount').value);

    if (!category || isNaN(amount) || amount < 0) {
        showToast('Please enter valid category and amount', 'error');
        return;
    }

    const categories = storage.getBudgetCategories();

    categories.push({
        id: genId(),
        category: category,
        monthlyBudget: amount
    });

    storage.saveBudgetCategories(categories);
    showToast('Budget category added!', 'success');

    document.getElementById('budget-category').value = '';
    document.getElementById('budget-amount').value = '';

    updateBudgetTable();
    populateExpenseCategories();
}

function updateBudgetTable() {
    const tbody = document.getElementById('budget-table');
    const categories = storage.getBudgetCategories();
    const expenses = storage.getExpenses();

    // Get current month
    const today = new Date();
    const currentMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;

    tbody.innerHTML = '';

    categories.forEach(cat => {
        // Calculate spent this month
        const monthExpenses = expenses.filter(e => {
            const expenseMonth = e.date.substring(0, 7);
            return e.category === cat.category && expenseMonth === currentMonth;
        });

        const spent = monthExpenses.reduce((sum, e) => sum + e.amount, 0);
        const remaining = cat.monthlyBudget - spent;

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${cat.category}</td>
            <td>$${cat.monthlyBudget.toFixed(2)}</td>
            <td>$${spent.toFixed(2)}</td>
            <td style="color: ${remaining < 0 ? '#e74c3c' : '#2ecc71'}">$${remaining.toFixed(2)}</td>
            <td>
                <button class="btn secondary" data-action="delete-budget-category" data-id="${escapeAttribute(cat.id)}">Delete</button>
            </td>
        `;

        tbody.appendChild(tr);
    });

    if (categories.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5">No budget categories defined</td></tr>';
    }
}

function deleteBudgetCategory(id) {
    if (!confirm('Delete this budget category?')) return;
    let categories = storage.getBudgetCategories();
    categories = categories.filter(c => c.id !== id);
    storage.saveBudgetCategories(categories);
    updateBudgetTable();
    populateExpenseCategories();
    showToast('Category deleted', 'success');
}

// ========== P0-3: MONTHLY TREASURER REPORT AUTOMATION ==========

function generateMonthlyTreasurerReport(month) {
    // month format: YYYY-MM
    const targetMonth = month || new Date().toISOString().substring(0, 7);
    const [year, monthNum] = targetMonth.split('-');
    const monthName = new Date(year, parseInt(monthNum) - 1, 1).toLocaleString('default', { month: 'long' });

    // Get all financial data
    const expenses = storage.getExpenses();
    const categories = storage.getBudgetCategories();
    const chairpersonLogs = storage.getChairpersonLog();

    // Filter data for target month
    const monthExpenses = expenses.filter(e => e.date.substring(0, 7) === targetMonth);
    const monthLogs = chairpersonLogs.filter(log => log.date.substring(0, 7) === targetMonth);

    // Calculate 7th Tradition contributions
    const contributions = monthLogs.reduce((sum, log) => sum + (parseFloat(log.tradition) || 0), 0);
    const orangeCan = monthLogs.reduce((sum, log) => sum + (parseFloat(log.orangeCan) || 0), 0);
    const totalIncome = contributions + orangeCan;

    // Calculate expenses by category
    const expensesByCategory = {};
    let totalExpenses = 0;

    categories.forEach(cat => {
        const catExpenses = monthExpenses.filter(e => e.category === cat.category);
        const spent = catExpenses.reduce((sum, e) => sum + e.amount, 0);
        expensesByCategory[cat.category] = {
            budgeted: cat.monthlyBudget,
            spent: spent,
            remaining: cat.monthlyBudget - spent
        };
        totalExpenses += spent;
    });

    // Calculate net (income - expenses)
    const netChange = totalIncome - totalExpenses;

    // Get previous month balance (from settings or calculate)
    const prevMonthBalance = parseFloat(localStorage.getItem('treasurerBalance')) || 0;
    const currentBalance = prevMonthBalance + netChange;

    // Calculate prudent reserve status
    const avgMonthlyExpenses = totalExpenses || calculateAvgMonthlyExpenses(3); // Use 3-month average
    const prudentReserve = avgMonthlyExpenses * 3; // 3 months operating expenses
    const reserveStatus = currentBalance >= prudentReserve ? 'Healthy' : 'Below Target';
    const reserveMonths = avgMonthlyExpenses > 0 ? (currentBalance / avgMonthlyExpenses).toFixed(1) : 'N/A';

    // Generate report HTML
    const report = `
<div style="padding: 2rem; background: #2c3e50; color: #ecf0f1; font-family: Arial, sans-serif;">
    <h1 style="color: #3498db; border-bottom: 2px solid #3498db; padding-bottom: 1rem;">
        Treasurer's Report - ${monthName} ${year}
    </h1>

    <!-- Summary Section -->
    <div style="background: #34495e; padding: 1.5rem; border-radius: 8px; margin: 2rem 0;">
        <h2 style="color: #3498db; margin-bottom: 1rem;">Financial Summary</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div>
                <p style="margin: 0.5rem 0;"><strong>Beginning Balance:</strong> $${prevMonthBalance.toFixed(2)}</p>
                <p style="margin: 0.5rem 0; color: #2ecc71;"><strong>Total Income:</strong> $${totalIncome.toFixed(2)}</p>
                <p style="margin: 0.5rem 0; color: #e74c3c;"><strong>Total Expenses:</strong> $${totalExpenses.toFixed(2)}</p>
                <p style="margin: 0.5rem 0; border-top: 1px solid #7f8c8d; padding-top: 0.5rem;">
                    <strong>Net Change:</strong>
                    <span style="color: ${netChange >= 0 ? '#2ecc71' : '#e74c3c'}">
                        ${netChange >= 0 ? '+' : ''}$${netChange.toFixed(2)}
                    </span>
                </p>
                <p style="margin: 0.5rem 0; font-size: 1.2rem; font-weight: bold; color: #3498db;">
                    <strong>Ending Balance:</strong> $${currentBalance.toFixed(2)}
                </p>
            </div>
            <div>
                <p style="margin: 0.5rem 0;"><strong>7th Tradition:</strong> $${contributions.toFixed(2)}</p>
                <p style="margin: 0.5rem 0;"><strong>Orange Can:</strong> $${orangeCan.toFixed(2)}</p>
                <p style="margin: 0.5rem 0;"><strong>Meetings This Month:</strong> ${monthLogs.length}</p>
                <p style="margin: 0.5rem 0;"><strong>Avg per Meeting:</strong> $${monthLogs.length > 0 ? (contributions / monthLogs.length).toFixed(2) : '0.00'}</p>
            </div>
        </div>
    </div>

    <!-- Prudent Reserve Status -->
    <div style="background: ${reserveStatus === 'Healthy' ? '#27ae60' : '#e67e22'}; padding: 1.5rem; border-radius: 8px; margin: 2rem 0;">
        <h3 style="margin: 0; color: white;">Prudent Reserve Status: ${reserveStatus}</h3>
        <p style="margin: 0.5rem 0 0 0; color: white;">
            Current balance covers <strong>${reserveMonths} months</strong> of operating expenses
            (Target: 3 months = $${prudentReserve.toFixed(2)})
        </p>
    </div>

    <!-- Budget vs Actual -->
    <div style="background: #34495e; padding: 1.5rem; border-radius: 8px; margin: 2rem 0;">
        <h2 style="color: #3498db; margin-bottom: 1rem;">Budget vs. Actual</h2>
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #2c3e50;">
                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #3498db;">Category</th>
                    <th style="padding: 0.75rem; text-align: right; border-bottom: 2px solid #3498db;">Budgeted</th>
                    <th style="padding: 0.75rem; text-align: right; border-bottom: 2px solid #3498db;">Spent</th>
                    <th style="padding: 0.75rem; text-align: right; border-bottom: 2px solid #3498db;">Remaining</th>
                    <th style="padding: 0.75rem; text-align: right; border-bottom: 2px solid #3498db;">% Used</th>
                </tr>
            </thead>
            <tbody>
                ${Object.entries(expensesByCategory).map(([cat, data]) => {
                    const pctUsed = data.budgeted > 0 ? ((data.spent / data.budgeted) * 100) : 0;
                    const statusColor = pctUsed > 100 ? '#e74c3c' : pctUsed > 80 ? '#f39c12' : '#2ecc71';
                    return `
                    <tr style="border-bottom: 1px solid #7f8c8d;">
                        <td style="padding: 0.75rem;">${cat}</td>
                        <td style="padding: 0.75rem; text-align: right;">$${data.budgeted.toFixed(2)}</td>
                        <td style="padding: 0.75rem; text-align: right;">$${data.spent.toFixed(2)}</td>
                        <td style="padding: 0.75rem; text-align: right; color: ${data.remaining < 0 ? '#e74c3c' : '#2ecc71'};">
                            $${data.remaining.toFixed(2)}
                        </td>
                        <td style="padding: 0.75rem; text-align: right; color: ${statusColor}; font-weight: bold;">
                            ${pctUsed.toFixed(0)}%
                        </td>
                    </tr>`;
                }).join('')}
            </tbody>
        </table>
    </div>

    <!-- Concerns & Recommendations -->
    ${generateTreasurerConcerns(expensesByCategory, currentBalance, prudentReserve, contributions, prevMonthBalance)}

    <!-- Footer -->
    <div style="margin-top: 3rem; padding-top: 1rem; border-top: 1px solid #7f8c8d; text-align: center; color: #95a5a6;">
        <p>Generated by AA Group Conscience Management System</p>
        <p>Report Date: ${new Date().toLocaleDateString()}</p>
    </div>
</div>`;

    // Save current balance for next month
    localStorage.setItem('treasurerBalance', currentBalance.toString());

    return report;
}

function generateTreasurerConcerns(expensesByCategory, currentBalance, prudentReserve, contributions, prevMonthBalance) {
    const concerns = [];

    // Check reserve status
    if (currentBalance < prudentReserve) {
        const shortfall = prudentReserve - currentBalance;
        concerns.push(`<li><strong>Low Reserve:</strong> Current balance is $${shortfall.toFixed(2)} below the prudent reserve target.</li>`);
    }

    // Check overbudget categories
    const overbudget = Object.entries(expensesByCategory).filter(([cat, data]) => data.remaining < 0);
    if (overbudget.length > 0) {
        concerns.push(`<li><strong>Over Budget:</strong> ${overbudget.length} categor${overbudget.length === 1 ? 'y is' : 'ies are'} over budget: ${overbudget.map(([cat]) => cat).join(', ')}</li>`);
    }

    // Check declining contributions
    if (prevMonthBalance > 0 && contributions < (prevMonthBalance * 0.1)) {
        concerns.push(`<li><strong>Low Contributions:</strong> This month's contributions are significantly lower than expected based on previous balance.</li>`);
    }

    if (concerns.length === 0) {
        return `
        <div style="background: #27ae60; padding: 1.5rem; border-radius: 8px; margin: 2rem 0;">
            <h3 style="margin: 0; color: white;"><i class="fas fa-check-circle"></i> No Concerns</h3>
            <p style="margin: 0.5rem 0 0 0; color: white;">Financial health is good. All categories within budget and prudent reserve is maintained.</p>
        </div>`;
    }

    return `
    <div style="background: #e67e22; padding: 1.5rem; border-radius: 8px; margin: 2rem 0;">
        <h3 style="margin: 0 0 1rem 0; color: white;"><i class="fas fa-exclamation-triangle"></i> Concerns & Recommendations</h3>
        <ul style="margin: 0; padding-left: 1.5rem; color: white;">
            ${concerns.join('')}
        </ul>
    </div>`;
}

function calculateAvgMonthlyExpenses(months) {
    const expenses = storage.getExpenses();
    const today = new Date();
    const cutoffDate = new Date(today.getFullYear(), today.getMonth() - months, 1);

    const recentExpenses = expenses.filter(e => new Date(e.date) >= cutoffDate);
    const total = recentExpenses.reduce((sum, e) => sum + e.amount, 0);

    return total / months;
}

function displayTreasurerReport() {
    const month = prompt('Enter month (YYYY-MM) or leave blank for current month:', new Date().toISOString().substring(0, 7));
    if (month === null) return; // Cancelled

    const report = generateMonthlyTreasurerReport(month || undefined);

    // Display in modal or new window
    const reportWindow = window.open('', 'Treasurer Report', 'width=800,height=600');
    reportWindow.document.write(report);
    reportWindow.document.close();
}

function exportTreasurerReportPDF() {
    const month = prompt('Enter month (YYYY-MM) or leave blank for current month:', new Date().toISOString().substring(0, 7));
    if (month === null) return;

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Get raw data instead of HTML
    const targetMonth = month || new Date().toISOString().substring(0, 7);
    const [year, monthNum] = targetMonth.split('-');
    const monthName = new Date(year, parseInt(monthNum) - 1, 1).toLocaleString('default', { month: 'long' });

    const expenses = storage.getExpenses();
    const categories = storage.getBudgetCategories();
    const chairpersonLogs = storage.getChairpersonLog();

    const monthExpenses = expenses.filter(e => e.date.substring(0, 7) === targetMonth);
    const monthLogs = chairpersonLogs.filter(log => log.date.substring(0, 7) === targetMonth);

    const contributions = monthLogs.reduce((sum, log) => sum + (parseFloat(log.tradition) || 0), 0);
    const orangeCan = monthLogs.reduce((sum, log) => sum + (parseFloat(log.orangeCan) || 0), 0);
    const totalIncome = contributions + orangeCan;

    const expensesByCategory = {};
    let totalExpenses = 0;

    categories.forEach(cat => {
        const catExpenses = monthExpenses.filter(e => e.category === cat.category);
        const spent = catExpenses.reduce((sum, e) => sum + e.amount, 0);
        expensesByCategory[cat.category] = {
            budgeted: cat.monthlyBudget,
            spent: spent,
            remaining: cat.monthlyBudget - spent,
            pctUsed: cat.monthlyBudget > 0 ? ((spent / cat.monthlyBudget) * 100) : 0
        };
        totalExpenses += spent;
    });

    const netChange = totalIncome - totalExpenses;
    const prevMonthBalance = parseFloat(localStorage.getItem('treasurerBalance')) || 0;
    const currentBalance = prevMonthBalance + netChange;
    const avgMonthlyExpenses = totalExpenses || 0;
    const prudentReserve = avgMonthlyExpenses * 3;
    const reserveStatus = currentBalance >= prudentReserve ? 'Healthy' : 'Below Target';

    // Build PDF
    let yPos = 20;

    // Title
    doc.setFontSize(20);
    doc.setTextColor(52, 152, 219);
    doc.text(`Treasurer's Report - ${monthName} ${year}`, 14, yPos);
    yPos += 15;

    // Financial Summary
    doc.setFontSize(14);
    doc.setTextColor(52, 152, 219);
    doc.text('Financial Summary', 14, yPos);
    yPos += 8;

    doc.setFontSize(11);
    doc.setTextColor(0, 0, 0);
    doc.text(`Beginning Balance: $${prevMonthBalance.toFixed(2)}`, 14, yPos);
    yPos += 6;
    doc.text(`Total Income: $${totalIncome.toFixed(2)}`, 14, yPos);
    yPos += 6;
    doc.text(`Total Expenses: $${totalExpenses.toFixed(2)}`, 14, yPos);
    yPos += 6;
    doc.text(`Net Change: ${netChange >= 0 ? '+' : ''}$${netChange.toFixed(2)}`, 14, yPos);
    yPos += 6;
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text(`Ending Balance: $${currentBalance.toFixed(2)}`, 14, yPos);
    doc.setFont(undefined, 'normal');
    yPos += 10;

    // Income Details
    doc.setFontSize(11);
    doc.text(`7th Tradition: $${contributions.toFixed(2)}`, 110, yPos - 30);
    doc.text(`Orange Can: $${orangeCan.toFixed(2)}`, 110, yPos - 24);
    doc.text(`Meetings This Month: ${monthLogs.length}`, 110, yPos - 18);
    doc.text(`Avg per Meeting: $${monthLogs.length > 0 ? (contributions / monthLogs.length).toFixed(2) : '0.00'}`, 110, yPos - 12);

    // Prudent Reserve Status
    doc.setFontSize(12);
    doc.setTextColor(reserveStatus === 'Healthy' ? 39 : 230, reserveStatus === 'Healthy' ? 174 : 126, reserveStatus === 'Healthy' ? 96 : 34);
    doc.text(`Prudent Reserve Status: ${reserveStatus}`, 14, yPos);
    yPos += 6;
    doc.setFontSize(10);
    const reserveMonths = avgMonthlyExpenses > 0 ? (currentBalance / avgMonthlyExpenses).toFixed(1) : 'N/A';
    doc.text(`Current balance covers ${reserveMonths} months (Target: 3 months = $${prudentReserve.toFixed(2)})`, 14, yPos);
    yPos += 12;

    // Budget vs Actual Table
    doc.setFontSize(14);
    doc.setTextColor(52, 152, 219);
    doc.text('Budget vs. Actual', 14, yPos);
    yPos += 5;

    const tableData = Object.entries(expensesByCategory).map(([cat, data]) => [
        cat,
        `$${data.budgeted.toFixed(2)}`,
        `$${data.spent.toFixed(2)}`,
        `$${data.remaining.toFixed(2)}`,
        `${data.pctUsed.toFixed(0)}%`
    ]);

    doc.autoTable({
        startY: yPos,
        head: [['Category', 'Budgeted', 'Spent', 'Remaining', '% Used']],
        body: tableData,
        theme: 'grid',
        headStyles: { fillColor: [52, 152, 219], textColor: 255 },
        styles: { fontSize: 10 },
        columnStyles: {
            1: { halign: 'right' },
            2: { halign: 'right' },
            3: { halign: 'right' },
            4: { halign: 'right' }
        }
    });

    // Footer
    const pageCount = doc.internal.getNumberOfPages();
    doc.setFontSize(9);
    doc.setTextColor(100, 100, 100);
    for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, doc.internal.pageSize.height - 10);
        doc.text(`Page ${i} of ${pageCount}`, doc.internal.pageSize.width - 30, doc.internal.pageSize.height - 10);
    }

    const filename = `treasurer-report-${month || new Date().toISOString().substring(0, 7)}.pdf`;
    doc.save(filename);

    showToast('Treasurer report exported to PDF', 'success');
}

// ========== END P0-3 ==========

// ========== QUICK WINS ENHANCEMENTS ==========

// Quick Win #2: Prudent Reserve Progress Bar
function updatePrudentReserveProgressBar() {
    const totalBalance = parseFloat(localStorage.getItem('treasurerBalance')) || 0;
    const reserveTarget = parseFloat(localStorage.getItem('reserveTarget')) || 0;
    const monthlyExpenses = parseFloat(localStorage.getItem('monthlyExpenses')) || 0;
    const targetMonths = parseInt(localStorage.getItem('reserveMonths')) || 3;

    const progressBar = document.getElementById('reserve-progress-bar');
    const progressText = document.getElementById('reserve-progress-text');
    const percentageSpan = document.getElementById('reserve-percentage');
    const targetMonthsSpan = document.getElementById('reserve-target-months');

    if (!progressBar || !progressText || !percentageSpan) return;

    // Calculate percentage
    const targetAmount = reserveTarget || (monthlyExpenses * targetMonths);
    const percentage = targetAmount > 0 ? Math.min((totalBalance / targetAmount) * 100, 100) : 0;
    const months = monthlyExpenses > 0 ? (totalBalance / monthlyExpenses).toFixed(1) : 0;

    // Update UI
    progressBar.style.width = percentage + '%';
    progressText.textContent = months + ' mo';
    percentageSpan.textContent = percentage.toFixed(0) + '%';
    if (targetMonthsSpan) targetMonthsSpan.textContent = targetMonths;

    // Color coding based on status
    if (percentage >= 100) {
        progressBar.style.background = '#2ecc71'; // Green - Excellent
    } else if (percentage >= 75) {
        progressBar.style.background = 'linear-gradient(90deg, #f1c40f, #2ecc71)'; // Yellow to Green - Good
    } else if (percentage >= 50) {
        progressBar.style.background = 'linear-gradient(90deg, #f39c12, #f1c40f)'; // Orange to Yellow - Caution
    } else {
        progressBar.style.background = 'linear-gradient(90deg, #e74c3c, #f39c12)'; // Red to Orange - Critical
    }
}

// Quick Win #3: Enhanced Service Term Expiration Alerts
function checkUpcomingTermExpirations() {
    const positions = storage.getServicePositions();
    const today = new Date();
    const notifications = [];

    positions.forEach(pos => {
        if (!pos.startDate || !pos.termLength || !pos.currentHolder) return;

        const startDate = new Date(pos.startDate);
        const termMonths = pos.termLength === 'Indefinite' ? 0 : parseInt(pos.termLength.split(' ')[0]);
        if (termMonths === 0) return; // Skip indefinite terms

        const endDate = new Date(startDate);
        endDate.setMonth(endDate.getMonth() + termMonths);

        const daysUntilEnd = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));

        // Create notifications at 90, 60, 30, 14, 7 days
        if (daysUntilEnd === 90 && !pos.notificationsSent?.days90) {
            notifications.push({
                type: 'service-term',
                title: `${pos.name} Term Ending in 90 Days`,
                message: `${pos.currentHolder}'s term as ${pos.name} will end on ${endDate.toLocaleDateString()}. Begin succession planning.`,
                priority: 'normal',
                actionLink: 'service-positions-section'
            });
            if (!pos.notificationsSent) pos.notificationsSent = {};
            pos.notificationsSent.days90 = true;
        } else if (daysUntilEnd === 60 && !pos.notificationsSent?.days60) {
            notifications.push({
                type: 'service-term',
                title: `${pos.name} Term Ending in 60 Days`,
                message: `${pos.currentHolder}'s term as ${pos.name} will end on ${endDate.toLocaleDateString()}. Identify potential successors.`,
                priority: 'high',
                actionLink: 'service-positions-section'
            });
            if (!pos.notificationsSent) pos.notificationsSent = {};
            pos.notificationsSent.days60 = true;
        } else if (daysUntilEnd === 30 && !pos.notificationsSent?.days30) {
            notifications.push({
                type: 'service-term',
                title: `${pos.name} Term Ending in 30 Days`,
                message: `${pos.currentHolder}'s term as ${pos.name} will end on ${endDate.toLocaleDateString()}. Begin transition process.`,
                priority: 'urgent',
                actionLink: 'service-positions-section'
            });
            if (!pos.notificationsSent) pos.notificationsSent = {};
            pos.notificationsSent.days30 = true;
        } else if (daysUntilEnd === 14 && !pos.notificationsSent?.days14) {
            notifications.push({
                type: 'service-term',
                title: `${pos.name} Term Ending in 14 Days`,
                message: `URGENT: ${pos.currentHolder}'s term as ${pos.name} will end on ${endDate.toLocaleDateString()}. Ensure transition is underway.`,
                priority: 'urgent',
                actionLink: 'service-positions-section'
            });
            if (!pos.notificationsSent) pos.notificationsSent = {};
            pos.notificationsSent.days14 = true;
        } else if (daysUntilEnd === 7 && !pos.notificationsSent?.days7) {
            notifications.push({
                type: 'service-term',
                title: `${pos.name} Term Ending in 7 Days`,
                message: `CRITICAL: ${pos.currentHolder}'s term as ${pos.name} will end on ${endDate.toLocaleDateString()}. Complete transition immediately.`,
                priority: 'urgent',
                actionLink: 'service-positions-section'
            });
            if (!pos.notificationsSent) pos.notificationsSent = {};
            pos.notificationsSent.days7 = true;
        }
    });

    // Create all notifications
    notifications.forEach(n => createNotification(n));

    // Save updated positions with notification flags
    storage.saveServicePositions(positions);
}

// Quick Win #4: GC Motion Tradition Score Badge
function getMotionTraditionAlignment(motionText) {
    // Score each motion based on tradition keywords and principles
    const traditionKeywords = {
        1: ['unity', 'common welfare', 'together', 'group', 'whole'],
        2: ['god', 'higher power', 'spiritual', 'conscience', 'guidance'],
        3: ['desire to stop drinking', 'membership', 'requirements'],
        4: ['autonomy', 'autonomous', 'independent', 'self-governing'],
        5: ['primary purpose', 'carry the message', 'alcoholic', 'recovery'],
        6: ['endorse', 'finance', 'lend name', 'outside', 'enterprise'],
        7: ['self-supporting', 'contributions', 'decline', 'outside'],
        8: ['non-professional', 'special workers', 'service', 'never'],
        9: ['organization', 'board', 'committee', 'service'],
        10: ['outside issues', 'opinion', 'controversy', 'public'],
        11: ['attraction', 'promotion', 'anonymous', 'personal'],
        12: ['anonymity', 'principles', 'personalities', 'spiritual']
    };

    const text = motionText.toLowerCase();
    const scores = [];

    for (let tradition in traditionKeywords) {
        const keywords = traditionKeywords[tradition];
        const matchCount = keywords.filter(keyword => text.includes(keyword)).length;
        if (matchCount > 0) {
            scores.push({
                tradition: parseInt(tradition),
                score: matchCount,
                keywords: keywords.filter(keyword => text.includes(keyword))
            });
        }
    }

    // Sort by score descending
    scores.sort((a, b) => b.score - a.score);

    return scores.length > 0 ? scores[0] : null;
}

function addTraditionBadgeToMotion(motionId) {
    const logs = storage.getGroupConscienceLog();
    const motion = logs.find(l => l.id === motionId);

    if (!motion) return '';

    const alignment = getMotionTraditionAlignment(motion.item);

    if (!alignment) return '';

    const tradition = alignment.tradition;
    const traditionShort = getTraditionDetails(tradition)?.title.substring(0, 30) || `Tradition ${tradition}`;

    return `<span style="background: #9b59b6; color: white; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.75rem; margin-left: 0.5rem;" title="${traditionShort}...">
        <i class="fas fa-book"></i> T${tradition}
    </span>`;
}

// Quick Win #6: Automated Birthday/Anniversary Notifications
function checkUpcomingBirthdaysAndAnniversaries() {
    const members = storage.getMembers();
    const today = new Date();
    const notifications = [];

    members.forEach(member => {
        // Birthday check (7 days advance notice)
        if (member.birthday) {
            const birthday = new Date(today.getFullYear(),
                new Date(member.birthday).getMonth(),
                new Date(member.birthday).getDate());

            if (birthday < today) {
                birthday.setFullYear(today.getFullYear() + 1);
            }

            const daysUntil = Math.ceil((birthday - today) / (1000 * 60 * 60 * 24));

            if (daysUntil === 7 || daysUntil === 3 || daysUntil === 1) {
                notifications.push({
                    type: 'birthday',
                    title: `Upcoming Birthday: ${member.name}`,
                    message: `${member.name}'s birthday is in ${daysUntil} day${daysUntil !== 1 ? 's' : ''} (${birthday.toLocaleDateString()})`,
                    priority: daysUntil === 1 ? 'high' : 'normal',
                    actionLink: 'birthdays-section'
                });
            }
        }

        // Sobriety Anniversary check (14 days advance notice)
        if (member.sobrietyDate) {
            const sobrietyDate = new Date(member.sobrietyDate);
            const anniversary = new Date(today.getFullYear(),
                sobrietyDate.getMonth(),
                sobrietyDate.getDate());

            if (anniversary < today) {
                anniversary.setFullYear(today.getFullYear() + 1);
            }

            const daysUntil = Math.ceil((anniversary - today) / (1000 * 60 * 60 * 24));
            const years = today.getFullYear() - sobrietyDate.getFullYear();

            if (daysUntil === 14 || daysUntil === 7 || daysUntil === 3 || daysUntil === 1) {
                notifications.push({
                    type: 'anniversary',
                    title: `Sobriety Anniversary: ${member.name}`,
                    message: `${member.name} will celebrate ${years} year${years !== 1 ? 's' : ''} of sobriety in ${daysUntil} day${daysUntil !== 1 ? 's' : ''} (${anniversary.toLocaleDateString()})`,
                    priority: daysUntil <= 3 ? 'high' : 'normal',
                    actionLink: 'birthdays-section'
                });
            }
        }
    });

    // Create all notifications
    notifications.forEach(n => {
        // Check if notification already exists to avoid duplicates
        const existing = JSON.parse(localStorage.getItem('notifications') || '[]');
        const isDuplicate = existing.some(e =>
            e.type === n.type &&
            e.title === n.title &&
            new Date(e.createdDate).toDateString() === today.toDateString()
        );

        if (!isDuplicate) {
            createNotification(n);
        }
    });
}

// Quick Win #7: Action Item Reminder System
function checkActionItemReminders() {
    const logs = storage.getGroupConscienceLog();
    const today = new Date();
    const notifications = [];

    logs.forEach(log => {
        // Check for tabled items that need follow-up
        if (log.status === 'tabled' && log.followUpDate) {
            const followUp = new Date(log.followUpDate);
            const daysUntil = Math.ceil((followUp - today) / (1000 * 60 * 60 * 24));

            if (daysUntil === 7 || daysUntil === 3 || daysUntil === 0) {
                notifications.push({
                    type: 'action-item',
                    title: `Tabled Motion Needs Review`,
                    message: `Motion "${log.item.substring(0, 50)}..." scheduled for follow-up ${daysUntil === 0 ? 'today' : 'in ' + daysUntil + ' days'}`,
                    priority: daysUntil === 0 ? 'urgent' : 'high',
                    actionLink: 'gc-log-section'
                });
            }
        }

        // Check for minority opinion follow-ups
        if (log.requiresFollowUp && log.followUpDate) {
            const followUp = new Date(log.followUpDate);
            const daysUntil = Math.ceil((followUp - today) / (1000 * 60 * 60 * 24));

            if (daysUntil === 30 || daysUntil === 14 || daysUntil === 7) {
                notifications.push({
                    type: 'action-item',
                    title: `Minority Opinion Follow-Up Due`,
                    message: `Motion "${log.item.substring(0, 50)}..." with significant minority opinion needs review in ${daysUntil} days`,
                    priority: 'high',
                    actionLink: 'gc-log-section'
                });
            }
        }

        // Check for research period ending
        if (log.workflowStatus === 'research' && log.researchPeriodEnd) {
            const endDate = new Date(log.researchPeriodEnd);
            const daysUntil = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));

            if (daysUntil === 7 || daysUntil === 3 || daysUntil === 1) {
                notifications.push({
                    type: 'action-item',
                    title: `Research Period Ending Soon`,
                    message: `Research for "${log.item.substring(0, 50)}..." ends in ${daysUntil} day${daysUntil !== 1 ? 's' : ''}`,
                    priority: daysUntil === 1 ? 'urgent' : 'high',
                    actionLink: 'gc-log-section'
                });
            }
        }
    });

    // Create all notifications (avoiding duplicates)
    notifications.forEach(n => {
        const existing = JSON.parse(localStorage.getItem('notifications') || '[]');
        const isDuplicate = existing.some(e =>
            e.type === n.type &&
            e.title === n.title &&
            new Date(e.createdDate).toDateString() === today.toDateString()
        );

        if (!isDuplicate) {
            createNotification(n);
        }
    });
}

// Quick Win #8: Duplicate Member Check
function checkForDuplicateMembers(newMember) {
    const members = storage.getMembers();
    const duplicates = [];

    members.forEach(existing => {
        if (existing.id === newMember.id) return; // Skip self

        let matchScore = 0;
        const reasons = [];

        // Exact name match
        if (existing.name.toLowerCase() === newMember.name.toLowerCase()) {
            matchScore += 50;
            reasons.push('Exact name match');
        }

        // Similar name (Levenshtein-like)
        const nameSimilarity = calculateStringSimilarity(
            existing.name.toLowerCase(),
            newMember.name.toLowerCase()
        );
        if (nameSimilarity > 0.8 && matchScore < 50) {
            matchScore += 30;
            reasons.push('Very similar name');
        }

        // Email match
        if (existing.email && newMember.email &&
            existing.email.toLowerCase() === newMember.email.toLowerCase()) {
            matchScore += 40;
            reasons.push('Same email');
        }

        // Phone match
        if (existing.phone && newMember.phone) {
            const phone1 = existing.phone.replace(/\D/g, '');
            const phone2 = newMember.phone.replace(/\D/g, '');
            if (phone1 === phone2) {
                matchScore += 40;
                reasons.push('Same phone number');
            }
        }

        // Birthday match (suspicious)
        if (existing.birthday && newMember.birthday &&
            existing.birthday === newMember.birthday) {
            matchScore += 10;
            reasons.push('Same birthday');
        }

        if (matchScore >= 50) {
            duplicates.push({
                member: existing,
                score: matchScore,
                reasons: reasons
            });
        }
    });

    return duplicates;
}

function calculateStringSimilarity(str1, str2) {
    const longer = str1.length > str2.length ? str1 : str2;
    const shorter = str1.length > str2.length ? str2 : str1;

    if (longer.length === 0) return 1.0;

    const editDistance = (s1, s2) => {
        s1 = s1.toLowerCase();
        s2 = s2.toLowerCase();

        const costs = [];
        for (let i = 0; i <= s1.length; i++) {
            let lastValue = i;
            for (let j = 0; j <= s2.length; j++) {
                if (i === 0) {
                    costs[j] = j;
                } else if (j > 0) {
                    let newValue = costs[j - 1];
                    if (s1.charAt(i - 1) !== s2.charAt(j - 1)) {
                        newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                    }
                    costs[j - 1] = lastValue;
                    lastValue = newValue;
                }
            }
            if (i > 0) costs[s2.length] = lastValue;
        }
        return costs[s2.length];
    };

    return (longer.length - editDistance(longer, shorter)) / longer.length;
}

// Quick Win #9: Export Audit Log Feature
function exportAuditLogToCSV() {
    const entries = getAuditHistory(null, null, 10000); // Get all entries

    if (entries.length === 0) {
        showToast('No audit entries to export', 'error');
        return;
    }

    // CSV Header
    let csv = 'Timestamp,User,Action,Entity Type,Entity ID,Changes,Reason\n';

    // Add rows
    entries.forEach(entry => {
        const timestamp = new Date(entry.timestamp).toLocaleString();
        const changes = entry.changes ? JSON.stringify(entry.changes).replace(/"/g, '""') : '';
        const reason = entry.reason || '';

        csv += `"${timestamp}","${entry.user}","${entry.action}","${entry.entityType}","${entry.entityId}","${changes}","${reason}"\n`;
    });

    // Download
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `audit-log-${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);

    showToast('Audit log exported to CSV', 'success');
}

function exportAuditLogToPDF() {
    const entries = getAuditHistory(null, null, 500); // Last 500 entries

    if (entries.length === 0) {
        showToast('No audit entries to export', 'error');
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('landscape'); // Use landscape for wider table

    let yPos = 20;

    // Title
    doc.setFontSize(18);
    doc.setTextColor(52, 152, 219);
    doc.text('Audit Log Report', 14, yPos);
    yPos += 10;

    // Summary
    doc.setFontSize(11);
    doc.setTextColor(0, 0, 0);
    doc.text(`Generated: ${new Date().toLocaleString()}`, 14, yPos);
    yPos += 6;
    doc.text(`Total Entries: ${entries.length} (showing first ${Math.min(entries.length, 100)})`, 14, yPos);
    yPos += 10;

    // Create table data
    const tableData = entries.slice(0, 100).map(entry => {
        const timestamp = new Date(entry.timestamp).toLocaleString('en-US', {
            month: '2-digit',
            day: '2-digit',
            year: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });

        let changes = '';
        if (entry.changes && typeof entry.changes === 'object') {
            const changedFields = Object.keys(entry.changes);
            changes = changedFields.length > 0 ? changedFields.slice(0, 3).join(', ') : 'N/A';
            if (changedFields.length > 3) changes += '...';
        }

        return [
            timestamp,
            entry.user || 'System',
            entry.action.toUpperCase(),
            entry.entityType,
            entry.entityId ? entry.entityId.substring(0, 12) : 'N/A',
            changes || 'N/A',
            entry.reason ? entry.reason.substring(0, 30) : ''
        ];
    });

    // Generate table
    doc.autoTable({
        startY: yPos,
        head: [['Date/Time', 'User', 'Action', 'Type', 'Entity ID', 'Changed Fields', 'Reason']],
        body: tableData,
        theme: 'grid',
        headStyles: {
            fillColor: [52, 152, 219],
            textColor: 255,
            fontSize: 9,
            fontStyle: 'bold'
        },
        styles: {
            fontSize: 8,
            cellPadding: 2
        },
        columnStyles: {
            0: { cellWidth: 35 }, // Date/Time
            1: { cellWidth: 30 }, // User
            2: { cellWidth: 25 }, // Action
            3: { cellWidth: 35 }, // Type
            4: { cellWidth: 30 }, // Entity ID
            5: { cellWidth: 50 }, // Changed Fields
            6: { cellWidth: 50 }  // Reason
        },
        didDrawCell: (data) => {
            // Color code actions
            if (data.column.index === 2 && data.cell.section === 'body') {
                const action = data.cell.raw;
                if (action === 'DELETE') {
                    doc.setTextColor(231, 76, 60); // Red
                } else if (action === 'CREATE') {
                    doc.setTextColor(46, 204, 113); // Green
                } else if (action === 'EDIT') {
                    doc.setTextColor(52, 152, 219); // Blue
                }
            }
        }
    });

    // Note if there are more entries
    if (entries.length > 100) {
        const finalY = doc.lastAutoTable.finalY + 10;
        doc.setFontSize(10);
        doc.setTextColor(150, 150, 150);
        doc.text(`Note: Showing first 100 of ${entries.length} total entries. Use filters in the app to view specific entries.`, 14, finalY);
    }

    // Footer with page numbers
    const pageCount = doc.internal.getNumberOfPages();
    doc.setFontSize(9);
    doc.setTextColor(100, 100, 100);
    for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.text(`Audit Log - ${new Date().toLocaleDateString()}`, 14, doc.internal.pageSize.height - 10);
        doc.text(`Page ${i} of ${pageCount}`, doc.internal.pageSize.width - 30, doc.internal.pageSize.height - 10);
    }

    doc.save(`audit-log-${new Date().toISOString().split('T')[0]}.pdf`);
    showToast('Audit log exported to PDF successfully!', 'success');
}

// Quick Win #10: Meeting Feedback Survey
function openMeetingFeedbackSurvey() {
    const modal = document.createElement('div');
    modal.id = 'feedback-survey-modal';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10001; display: flex; align-items: center; justify-content: center; padding: 1rem; overflow-y: auto;';

    const content = document.createElement('div');
    content.style.cssText = 'background: #34495e; padding: 2rem; border-radius: 8px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto;';

    content.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="color: #3498db; margin: 0;">Meeting Feedback Survey</h2>
            <button onclick="closeFeedbackSurvey()" style="background: #e74c3c; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Close</button>
        </div>

        <p style="color: #ecf0f1; margin-bottom: 1.5rem;">
            Your feedback helps us improve our meetings. Please rate the following aspects (1-5 scale):
        </p>

        <div class="form-group">
            <label>1. How welcoming was today's meeting atmosphere?</label>
            <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                ${[1,2,3,4,5].map(n => `
                    <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                        <input type="radio" name="q1" value="${n}" required />
                        <span style="color: #ecf0f1;">${n}</span>
                    </label>
                `).join('')}
            </div>
            <small style="color: #95a5a6;">1 = Not welcoming, 5 = Very welcoming</small>
        </div>

        <div class="form-group">
            <label>2. How valuable was the meeting content?</label>
            <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                ${[1,2,3,4,5].map(n => `
                    <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                        <input type="radio" name="q2" value="${n}" required />
                        <span style="color: #ecf0f1;">${n}</span>
                    </label>
                `).join('')}
            </div>
            <small style="color: #95a5a6;">1 = Not valuable, 5 = Very valuable</small>
        </div>

        <div class="form-group">
            <label>3. How inclusive was the meeting (everyone had opportunity to share)?</label>
            <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                ${[1,2,3,4,5].map(n => `
                    <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                        <input type="radio" name="q3" value="${n}" required />
                        <span style="color: #ecf0f1;">${n}</span>
                    </label>
                `).join('')}
            </div>
            <small style="color: #95a5a6;">1 = Not inclusive, 5 = Very inclusive</small>
        </div>

        <div class="form-group">
            <label>4. How would you rate the meeting format?</label>
            <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                ${[1,2,3,4,5].map(n => `
                    <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                        <input type="radio" name="q4" value="${n}" required />
                        <span style="color: #ecf0f1;">${n}</span>
                    </label>
                `).join('')}
            </div>
            <small style="color: #95a5a6;">1 = Needs improvement, 5 = Excellent</small>
        </div>

        <div class="form-group">
            <label>5. How likely are you to return or recommend this meeting?</label>
            <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                ${[1,2,3,4,5].map(n => `
                    <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                        <input type="radio" name="q5" value="${n}" required />
                        <span style="color: #ecf0f1;">${n}</span>
                    </label>
                `).join('')}
            </div>
            <small style="color: #95a5a6;">1 = Not likely, 5 = Very likely</small>
        </div>

        <div class="form-group">
            <label>Additional Comments (Optional)</label>
            <textarea id="feedback-comments" rows="4" placeholder="Any suggestions or comments?" style="width: 100%; padding: 0.5rem; background: #2c3e50; color: #ecf0f1; border: 1px solid #7f8c8d; border-radius: 4px;"></textarea>
        </div>

        <div style="margin-top: 1.5rem; text-align: center;">
            <button onclick="submitMeetingFeedback()" style="background: #2ecc71; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer; margin-right: 0.5rem;">
                Submit Feedback
            </button>
            <button onclick="closeFeedbackSurvey()" style="background: #95a5a6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer;">
                Cancel
            </button>
        </div>
    `;

    modal.appendChild(content);
    document.body.appendChild(modal);
}

function submitMeetingFeedback() {
    const q1 = document.querySelector('input[name="q1"]:checked')?.value;
    const q2 = document.querySelector('input[name="q2"]:checked')?.value;
    const q3 = document.querySelector('input[name="q3"]:checked')?.value;
    const q4 = document.querySelector('input[name="q4"]:checked')?.value;
    const q5 = document.querySelector('input[name="q5"]:checked')?.value;

    if (!q1 || !q2 || !q3 || !q4 || !q5) {
        showToast('Please answer all questions', 'error');
        return;
    }

    const comments = document.getElementById('feedback-comments')?.value || '';

    const feedback = {
        id: genId(),
        date: new Date().toISOString(),
        scores: {
            welcoming: parseInt(q1),
            valuable: parseInt(q2),
            inclusive: parseInt(q3),
            format: parseInt(q4),
            recommend: parseInt(q5)
        },
        average: ((parseInt(q1) + parseInt(q2) + parseInt(q3) + parseInt(q4) + parseInt(q5)) / 5).toFixed(1),
        comments: comments,
        submittedBy: getCurrentUserName()
    };

    // Save feedback
    const allFeedback = JSON.parse(localStorage.getItem('meetingFeedback') || '[]');
    allFeedback.push(feedback);
    localStorage.setItem('meetingFeedback', JSON.stringify(allFeedback));

    // Log to audit trail
    logAuditEntry('create', 'meeting-feedback', feedback.id, feedback);

    showToast('Thank you for your feedback!', 'success');
    closeFeedbackSurvey();
}

function closeFeedbackSurvey() {
    const modal = document.getElementById('feedback-survey-modal');
    if (modal) modal.remove();
}

function viewMeetingFeedbackResults() {
    const allFeedback = JSON.parse(localStorage.getItem('meetingFeedback') || '[]');

    if (allFeedback.length === 0) {
        showToast('No feedback submissions yet', 'info');
        return;
    }

    // Calculate averages
    const totals = {
        welcoming: 0,
        valuable: 0,
        inclusive: 0,
        format: 0,
        recommend: 0
    };

    allFeedback.forEach(f => {
        totals.welcoming += f.scores.welcoming;
        totals.valuable += f.scores.valuable;
        totals.inclusive += f.scores.inclusive;
        totals.format += f.scores.format;
        totals.recommend += f.scores.recommend;
    });

    const count = allFeedback.length;
    const averages = {
        welcoming: (totals.welcoming / count).toFixed(2),
        valuable: (totals.valuable / count).toFixed(2),
        inclusive: (totals.inclusive / count).toFixed(2),
        format: (totals.format / count).toFixed(2),
        recommend: (totals.recommend / count).toFixed(2),
        overall: ((totals.welcoming + totals.valuable + totals.inclusive + totals.format + totals.recommend) / (count * 5)).toFixed(2)
    };

    const modal = document.createElement('div');
    modal.id = 'feedback-results-modal';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10001; display: flex; align-items: center; justify-content: center; padding: 1rem; overflow-y: auto;';

    const content = document.createElement('div');
    content.style.cssText = 'background: #34495e; padding: 2rem; border-radius: 8px; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto;';

    content.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="color: #3498db; margin: 0;">Meeting Feedback Results</h2>
            <button onclick="closeFeedbackResults()" style="background: #e74c3c; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Close</button>
        </div>

        <div style="background: #2c3e50; padding: 1.5rem; border-radius: 6px; margin-bottom: 1rem;">
            <h3 style="color: #3498db; margin: 0 0 1rem 0;">Overall Score</h3>
            <div style="font-size: 2rem; font-weight: bold; color: #2ecc71; text-align: center;">
                ${averages.overall} / 5.0
            </div>
            <div style="text-align: center; color: #95a5a6; margin-top: 0.5rem;">
                Based on ${count} response${count !== 1 ? 's' : ''}
            </div>
        </div>

        <div style="background: #2c3e50; padding: 1.5rem; border-radius: 6px; margin-bottom: 1rem;">
            <h3 style="color: #3498db; margin: 0 0 1rem 0;">Category Scores</h3>

            <div style="margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                    <span style="color: #ecf0f1;">Welcoming Atmosphere</span>
                    <span style="color: #3498db; font-weight: bold;">${averages.welcoming}</span>
                </div>
                <div style="background: #34495e; height: 8px; border-radius: 4px; overflow: hidden;">
                    <div style="background: #2ecc71; height: 100%; width: ${averages.welcoming * 20}%;"></div>
                </div>
            </div>

            <div style="margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                    <span style="color: #ecf0f1;">Content Value</span>
                    <span style="color: #3498db; font-weight: bold;">${averages.valuable}</span>
                </div>
                <div style="background: #34495e; height: 8px; border-radius: 4px; overflow: hidden;">
                    <div style="background: #2ecc71; height: 100%; width: ${averages.valuable * 20}%;"></div>
                </div>
            </div>

            <div style="margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                    <span style="color: #ecf0f1;">Inclusivity</span>
                    <span style="color: #3498db; font-weight: bold;">${averages.inclusive}</span>
                </div>
                <div style="background: #34495e; height: 8px; border-radius: 4px; overflow: hidden;">
                    <div style="background: #2ecc71; height: 100%; width: ${averages.inclusive * 20}%;"></div>
                </div>
            </div>

            <div style="margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                    <span style="color: #ecf0f1;">Meeting Format</span>
                    <span style="color: #3498db; font-weight: bold;">${averages.format}</span>
                </div>
                <div style="background: #34495e; height: 8px; border-radius: 4px; overflow: hidden;">
                    <div style="background: #2ecc71; height: 100%; width: ${averages.format * 20}%;"></div>
                </div>
            </div>

            <div style="margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                    <span style="color: #ecf0f1;">Likelihood to Recommend</span>
                    <span style="color: #3498db; font-weight: bold;">${averages.recommend}</span>
                </div>
                <div style="background: #34495e; height: 8px; border-radius: 4px; overflow: hidden;">
                    <div style="background: #2ecc71; height: 100%; width: ${averages.recommend * 20}%;"></div>
                </div>
            </div>
        </div>

        <div style="background: #2c3e50; padding: 1.5rem; border-radius: 6px;">
            <h3 style="color: #3498db; margin: 0 0 1rem 0;">Recent Comments</h3>
            ${allFeedback.filter(f => f.comments).slice(-5).reverse().map(f => `
                <div style="background: #34495e; padding: 1rem; border-radius: 4px; margin-bottom: 0.75rem;">
                    <p style="color: #ecf0f1; margin: 0 0 0.5rem 0;">${escapeHtml(f.comments)}</p>
                    <small style="color: #95a5a6;">${new Date(f.date).toLocaleDateString()} - Score: ${f.average}/5.0</small>
                </div>
            `).join('') || '<p style="color: #95a5a6; text-align: center;">No comments yet</p>'}
        </div>

        <div style="margin-top: 1.5rem; text-align: center;">
            <button onclick="exportFeedbackReport()" style="background: #3498db; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer; margin-right: 0.5rem;">
                <i class="fas fa-download"></i> Export Report
            </button>
        </div>
    `;

    modal.appendChild(content);
    document.body.appendChild(modal);
}

function closeFeedbackResults() {
    const modal = document.getElementById('feedback-results-modal');
    if (modal) modal.remove();
}

function exportFeedbackReport() {
    const allFeedback = JSON.parse(localStorage.getItem('meetingFeedback') || '[]');

    let csv = 'Date,Welcoming,Valuable,Inclusive,Format,Recommend,Average,Comments,Submitted By\n';

    allFeedback.forEach(f => {
        const date = new Date(f.date).toLocaleDateString();
        const comments = (f.comments || '').replace(/"/g, '""');
        csv += `"${date}",${f.scores.welcoming},${f.scores.valuable},${f.scores.inclusive},${f.scores.format},${f.scores.recommend},${f.average},"${comments}","${f.submittedBy}"\n`;
    });

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `meeting-feedback-${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);

    showToast('Feedback report exported', 'success');
}

// Quick Win #5: Group Health Dashboard Widget (Enhancement to existing dashboard)
function getGroupHealthMetrics() {
    const members = storage.getMembers();
    const positions = storage.getServicePositions();
    const gcLogs = storage.getGroupConscienceLog();
    const chairpersonLogs = storage.getChairpersonLog();
    const today = new Date();
    const thirtyDaysAgo = new Date(today - 30 * 24 * 60 * 60 * 1000);

    // Calculate metrics
    const activeMembers = members.filter(m => m.status === 'Active').length;
    const filledPositions = positions.filter(p => p.currentHolder).length;
    const totalPositions = positions.length;
    const positionsFillRate = totalPositions > 0 ? (filledPositions / totalPositions * 100).toFixed(0) : 0;

    // Recent GC activity
    const recentGC = gcLogs.filter(log => new Date(log.date) >= thirtyDaysAgo);
    const passedMotions = recentGC.filter(log => log.status === 'passed').length;
    const totalMotions = recentGC.length;

    // Attendance trend (last 8 weeks)
    const recentLogs = chairpersonLogs
        .filter(log => new Date(log.date) >= new Date(today - 56 * 24 * 60 * 60 * 1000))
        .sort((a, b) => new Date(a.date) - new Date(b.date));

    const avgAttendance = recentLogs.length > 0
        ? (recentLogs.reduce((sum, log) => sum + (log.headCount || 0), 0) / recentLogs.length).toFixed(1)
        : 0;

    // Financial health
    const balance = parseFloat(localStorage.getItem('treasurerBalance')) || 0;
    const monthlyExpenses = parseFloat(localStorage.getItem('monthlyExpenses')) || 0;
    const monthsOfReserve = monthlyExpenses > 0 ? (balance / monthlyExpenses).toFixed(1) : 0;

    // Overall health score (0-100)
    let healthScore = 0;
    healthScore += positionsFillRate * 0.25; // 25% weight
    healthScore += Math.min((avgAttendance / 20) * 100, 100) * 0.25; // 25% weight (assuming target of 20)
    healthScore += (totalMotions > 0 ? (passedMotions / totalMotions * 100) : 50) * 0.25; // 25% weight
    healthScore += Math.min((monthsOfReserve / 3) * 100, 100) * 0.25; // 25% weight

    return {
        activeMembers,
        positionsFillRate,
        filledPositions,
        totalPositions,
        avgAttendance,
        recentGCActivity: totalMotions,
        gcPassRate: totalMotions > 0 ? ((passedMotions / totalMotions) * 100).toFixed(0) : 0,
        monthsOfReserve,
        healthScore: Math.round(healthScore),
        healthStatus: healthScore >= 80 ? 'Excellent' : healthScore >= 60 ? 'Good' : healthScore >= 40 ? 'Fair' : 'Needs Attention',
        healthColor: healthScore >= 80 ? '#2ecc71' : healthScore >= 60 ? '#f1c40f' : healthScore >= 40 ? '#f39c12' : '#e74c3c'
    };
}

// ========== END QUICK WINS ==========

// ========== UNIFIED BACKUP & RESTORE SYSTEM ==========

// Get all application data for backup
function getAllApplicationData() {
    return {
        // Core Data
        events: storage.getEvents(),
        members: storage.getMembers(),
        announcements: storage.getAnnouncements(),
        photos: storage.getPhotos(),

        // Group Conscience
        chairpersonLog: storage.getChairpersonLog(),
        groupConscienceLog: storage.getGroupConscienceLog(),
        liveGCItems: storage.getLiveGCItems(),
        proposedAgendaItems: storage.getProposedAgendaItems(),
        gcComments: storage.getGCComments(),
        gcActionItems: storage.getGCActionItems(),
        gcSettings: storage.getGCSettings(),

        // Service & Leadership
        servicePositions: storage.getServicePositions(),
        nominations: storage.getNominations(),
        messages: storage.getMessages(),

        // Financial
        budgetCategories: storage.getBudgetCategories(),
        expenses: storage.getExpenses(),

        // Templates & Resources
        templates: storage.getTemplates(),

        // Advanced Features
        votingSettings: storage.getVotingSettings(),
        literatureInventory: storage.getLiteratureInventory(),
        literatureLoans: storage.getLiteratureLoans(),
        serviceElections: storage.getServiceElections(),
        electionBallots: storage.getElectionBallots(),
        speakingQueue: storage.getSpeakingQueue(),
        motionTemplates: storage.getMotionTemplates(),
        traditionChecks: storage.getTraditionChecks(),
        budgetProposals: storage.getBudgetProposals(),
        districtMotions: storage.getDistrictMotions(),
        groupPositions: storage.getGroupPositions(),

        // Enhanced Features
        quorumRules: storage.getQuorumRules(),
        meetingMinutes: storage.getMeetingMinutes(),
        inventorySchedules: storage.getInventorySchedules(),
        decisionImpacts: storage.getDecisionImpacts(),
        participationData: storage.getParticipationData(),
        userRole: storage.getUserRole(),
        educationalProgress: storage.getEducationalProgress(),

        // Privacy & Settings
        privacySettings: storage.getPrivacySettings(),
        accessLevels: storage.getAccessLevels(),

        // AA-Specific Features
        traditionOfDay: storage.getTraditionOfDay(),
        spiritualPrinciples: storage.getSpiritualPrinciples(),
        unityChecks: storage.getUnityChecks(),
        minorityOpinions: storage.getMinorityOpinions(),
        serviceStructure: storage.getServiceStructure(),

        // System Data
        notifications: JSON.parse(localStorage.getItem('notifications') || '[]'),
        auditLog: JSON.parse(localStorage.getItem('auditLog') || '[]'),
        meetingFeedback: JSON.parse(localStorage.getItem('meetingFeedback') || '[]'),
        groupInventories: JSON.parse(localStorage.getItem('groupInventories') || '[]'),
        backupSettings: JSON.parse(localStorage.getItem('backupSettings') || '{"enabled": true, "frequency": "daily"}'),

        // Settings
        currentUser: localStorage.getItem('currentUser'),
        treasurerBalance: localStorage.getItem('treasurerBalance'),
        reserveTarget: localStorage.getItem('reserveTarget'),
        monthlyExpenses: localStorage.getItem('monthlyExpenses'),
        reserveMonths: localStorage.getItem('reserveMonths'),

        // Metadata
        exportDate: new Date().toISOString(),
        version: '6.0',
        backupType: 'full'
    };
}

// JSON BACKUP & RESTORE

function exportFullBackupJSON() {
    try {
        const data = getAllApplicationData();
        const dateStr = new Date().toISOString().split('T')[0];
        const timeStr = new Date().toISOString().split('T')[1].split('.')[0].replace(/:/g, '-');
        const filename = `aa-group-backup-${dateStr}_${timeStr}.json`;

        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showToast('✅ JSON backup exported successfully!', 'success');
        logAuditEntry('export', 'full-backup-json', 'system', { filename, size: blob.size }, 'Full JSON backup exported');
    } catch (error) {
        showToast('❌ Error exporting JSON backup: ' + error.message, 'error');
        console.error('JSON export error:', error);
    }
}

function importFullBackupJSON() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';

    input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        if (!confirm('⚠️ IMPORTANT WARNING ⚠️\n\nThis will COMPLETELY REPLACE all current data with the backup data.\n\n✓ Current data will be lost\n✓ This action cannot be undone\n✓ It is recommended to export current data first\n\nDo you want to continue?')) {
            return;
        }

        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const data = JSON.parse(event.target.result);

                // Validate backup format
                if (!data.version || !data.exportDate) {
                    if (!confirm('⚠️ This file may be from an older version or corrupted.\n\nAttempt to import anyway?')) {
                        return;
                    }
                }

                // Restore all data
                restoreAllApplicationData(data);

                showToast('✅ JSON backup restored successfully! Refreshing page...', 'success');
                logAuditEntry('import', 'full-backup-json', 'system', { filename: file.name, size: file.size }, 'Full JSON backup restored');

                // Refresh page after short delay
                setTimeout(() => {
                    window.location.reload();
                }, 2000);

            } catch (error) {
                showToast('❌ Error importing JSON backup: ' + error.message, 'error');
                console.error('JSON import error:', error);
            }
        };

        reader.readAsText(file);
    };

    input.click();
}

// CSV BACKUP & RESTORE

function arrayToCSV(data, fields) {
    if (!data || data.length === 0) return '';

    // Header row with pipe delimiter
    let csv = fields.join('|') + '\n';

    // Data rows
    data.forEach(item => {
        const row = fields.map(field => {
            let value = item[field];

            // Handle nested objects and arrays
            if (typeof value === 'object' && value !== null) {
                value = JSON.stringify(value).replace(/\|/g, '¦'); // Replace pipes to avoid breaking delimiter
            }

            // Handle null/undefined
            if (value === null || value === undefined) {
                value = '';
            }

            // Convert to string and escape special characters
            value = String(value).replace(/\n/g, ' ').replace(/\r/g, '');

            return value;
        });
        csv += row.join('|') + '\n';
    });

    return csv;
}

function exportFullBackupCSV() {
    try {
        const data = getAllApplicationData();
        const dateStr = new Date().toISOString().split('T')[0];
        const timeStr = new Date().toISOString().split('T')[1].split('.')[0].replace(/:/g, '-');

        // Create CSV files for each data type
        const csvFiles = [];

        // Members
        if (data.members && data.members.length > 0) {
            const csv = arrayToCSV(data.members, ['id', 'name', 'birthday', 'phone', 'email', 'homegroup', 'sponsor', 'city', 'isServant', 'servantPosition', 'servantSince']);
            csvFiles.push({ name: 'members.csv', content: csv });
        }

        // Events
        if (data.events && data.events.length > 0) {
            const csv = arrayToCSV(data.events, ['id', 'title', 'date', 'time', 'location', 'description', 'type']);
            csvFiles.push({ name: 'events.csv', content: csv });
        }

        // Group Conscience Log
        if (data.groupConscienceLog && data.groupConscienceLog.length > 0) {
            const csv = arrayToCSV(data.groupConscienceLog, ['id', 'date', 'item', 'submittedBy', 'status', 'votesFor', 'votesAgainst', 'votesAbstain', 'workflowStatus', 'researchPeriodStart', 'researchPeriodEnd', 'minorityPercentage', 'requiresFollowUp']);
            csvFiles.push({ name: 'group_conscience_log.csv', content: csv });
        }

        // Chairperson Log
        if (data.chairpersonLog && data.chairpersonLog.length > 0) {
            const csv = arrayToCSV(data.chairpersonLog, ['id', 'date', 'time', 'chairperson', 'headCount', 'tradition', 'orangeCan']);
            csvFiles.push({ name: 'chairperson_log.csv', content: csv });
        }

        // Service Positions
        if (data.servicePositions && data.servicePositions.length > 0) {
            const csv = arrayToCSV(data.servicePositions, ['id', 'name', 'description', 'termLength', 'currentHolder', 'startDate']);
            csvFiles.push({ name: 'service_positions.csv', content: csv });
        }

        // Budget Categories
        if (data.budgetCategories && data.budgetCategories.length > 0) {
            const csv = arrayToCSV(data.budgetCategories, ['id', 'category', 'monthlyBudget']);
            csvFiles.push({ name: 'budget_categories.csv', content: csv });
        }

        // Expenses
        if (data.expenses && data.expenses.length > 0) {
            const csv = arrayToCSV(data.expenses, ['id', 'date', 'category', 'description', 'amount']);
            csvFiles.push({ name: 'expenses.csv', content: csv });
        }

        // Announcements
        if (data.announcements && data.announcements.length > 0) {
            const csv = arrayToCSV(data.announcements, ['id', 'date', 'text']);
            csvFiles.push({ name: 'announcements.csv', content: csv });
        }

        // Meeting Minutes
        if (data.meetingMinutes && data.meetingMinutes.length > 0) {
            const csv = arrayToCSV(data.meetingMinutes, ['id', 'date', 'title', 'attendees', 'facilitator', 'notes']);
            csvFiles.push({ name: 'meeting_minutes.csv', content: csv });
        }

        // Literature Inventory
        if (data.literatureInventory && data.literatureInventory.length > 0) {
            const csv = arrayToCSV(data.literatureInventory, ['id', 'title', 'type', 'quantity', 'price', 'lowStockThreshold']);
            csvFiles.push({ name: 'literature_inventory.csv', content: csv });
        }

        // Audit Log (last 1000 entries)
        if (data.auditLog && data.auditLog.length > 0) {
            const recentAudit = data.auditLog.slice(-1000);
            const csv = arrayToCSV(recentAudit, ['timestamp', 'user', 'action', 'entityType', 'entityId']);
            csvFiles.push({ name: 'audit_log.csv', content: csv });
        }

        // Meeting Feedback
        if (data.meetingFeedback && data.meetingFeedback.length > 0) {
            const csv = arrayToCSV(data.meetingFeedback, ['id', 'date', 'average', 'comments', 'submittedBy']);
            csvFiles.push({ name: 'meeting_feedback.csv', content: csv });
        }

        // Create metadata file
        const metadata = {
            exportDate: data.exportDate,
            version: data.version,
            backupType: 'full-csv',
            filesCount: csvFiles.length,
            instructions: 'To restore: Import this backup using the CSV Import button in Settings'
        };
        csvFiles.push({
            name: '_backup_metadata.json',
            content: JSON.stringify(metadata, null, 2)
        });

        // Since we can't create a real ZIP file in browser without external library,
        // we'll create a single combined CSV file with section markers
        let combinedCSV = `AA Group Backup - Pipe-Delimited CSV\nExport Date: ${data.exportDate}\nVersion: ${data.version}\n\n`;

        csvFiles.forEach(file => {
            combinedCSV += `\n${'='.repeat(80)}\n`;
            combinedCSV += `FILE: ${file.name}\n`;
            combinedCSV += `${'='.repeat(80)}\n`;
            combinedCSV += file.content;
            combinedCSV += `\n`;
        });

        // Download combined file
        const blob = new Blob([combinedCSV], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `aa-group-backup-${dateStr}_${timeStr}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showToast(`✅ CSV backup exported! ${csvFiles.length} files included.`, 'success');
        logAuditEntry('export', 'full-backup-csv', 'system', { filesCount: csvFiles.length, size: blob.size }, 'Full CSV backup exported');

    } catch (error) {
        showToast('❌ Error exporting CSV backup: ' + error.message, 'error');
        console.error('CSV export error:', error);
    }
}

function importFullBackupCSV() {
    showToast('⚠️ CSV import requires the JSON backup file. Please use JSON Import for full restore, or manually import CSV files into a spreadsheet to review data.', 'info');

    // CSV import is complex because we'd need to parse multiple CSV sections
    // and convert them back to JSON format. For now, we recommend:
    // 1. Use JSON for full backup/restore
    // 2. Use CSV for viewing/analyzing data in Excel/Sheets
    // 3. If needed, manually copy data from CSV back into the application
}

// Restore all application data
function restoreAllApplicationData(data) {
    // Core Data
    if (data.events) storage.saveEvents(data.events);
    if (data.members) storage.saveMembers(data.members);
    if (data.announcements) storage.saveAnnouncements(data.announcements);
    if (data.photos) storage.savePhotos(data.photos);

    // Group Conscience
    if (data.chairpersonLog) storage.saveChairpersonLog(data.chairpersonLog);
    if (data.groupConscienceLog) storage.saveGroupConscienceLog(data.groupConscienceLog);
    if (data.liveGCItems) storage.saveLiveGCItems(data.liveGCItems);
    if (data.proposedAgendaItems) storage.saveProposedAgendaItems(data.proposedAgendaItems);
    if (data.gcComments) storage.saveGCComments(data.gcComments);
    if (data.gcActionItems) storage.saveGCActionItems(data.gcActionItems);
    if (data.gcSettings) storage.saveGCSettings(data.gcSettings);

    // Service & Leadership
    if (data.servicePositions) storage.saveServicePositions(data.servicePositions);
    if (data.nominations) storage.saveNominations(data.nominations);
    if (data.messages) storage.saveMessages(data.messages);

    // Financial
    if (data.budgetCategories) storage.saveBudgetCategories(data.budgetCategories);
    if (data.expenses) storage.saveExpenses(data.expenses);

    // Templates & Resources
    if (data.templates) storage.saveTemplates(data.templates);

    // Advanced Features
    if (data.votingSettings) storage.saveVotingSettings(data.votingSettings);
    if (data.literatureInventory) storage.saveLiteratureInventory(data.literatureInventory);
    if (data.literatureLoans) storage.saveLiteratureLoans(data.literatureLoans);
    if (data.serviceElections) storage.saveServiceElections(data.serviceElections);
    if (data.electionBallots) storage.saveElectionBallots(data.electionBallots);
    if (data.speakingQueue) storage.saveSpeakingQueue(data.speakingQueue);
    if (data.motionTemplates) storage.saveMotionTemplates(data.motionTemplates);
    if (data.traditionChecks) storage.saveTraditionChecks(data.traditionChecks);
    if (data.budgetProposals) storage.saveBudgetProposals(data.budgetProposals);
    if (data.districtMotions) storage.saveDistrictMotions(data.districtMotions);
    if (data.groupPositions) storage.saveGroupPositions(data.groupPositions);

    // Enhanced Features
    if (data.quorumRules) storage.saveQuorumRules(data.quorumRules);
    if (data.meetingMinutes) storage.saveMeetingMinutes(data.meetingMinutes);
    if (data.inventorySchedules) storage.saveInventorySchedules(data.inventorySchedules);
    if (data.decisionImpacts) storage.saveDecisionImpacts(data.decisionImpacts);
    if (data.participationData) storage.saveParticipationData(data.participationData);
    if (data.userRole) storage.saveUserRole(data.userRole);
    if (data.educationalProgress) storage.saveEducationalProgress(data.educationalProgress);

    // Privacy & Settings
    if (data.privacySettings) storage.savePrivacySettings(data.privacySettings);
    if (data.accessLevels) storage.saveAccessLevels(data.accessLevels);

    // AA-Specific Features
    if (data.traditionOfDay) storage.saveTraditionOfDay(data.traditionOfDay);
    if (data.spiritualPrinciples) storage.saveSpiritualPrinciples(data.spiritualPrinciples);
    if (data.unityChecks) storage.saveUnityChecks(data.unityChecks);
    if (data.minorityOpinions) storage.saveMinorityOpinions(data.minorityOpinions);
    if (data.serviceStructure) storage.saveServiceStructure(data.serviceStructure);

    // System Data
    if (data.notifications) localStorage.setItem('notifications', JSON.stringify(data.notifications));
    if (data.auditLog) localStorage.setItem('auditLog', JSON.stringify(data.auditLog));
    if (data.meetingFeedback) localStorage.setItem('meetingFeedback', JSON.stringify(data.meetingFeedback));
    if (data.groupInventories) localStorage.setItem('groupInventories', JSON.stringify(data.groupInventories));
    if (data.backupSettings) localStorage.setItem('backupSettings', JSON.stringify(data.backupSettings));

    // Settings
    if (data.currentUser) localStorage.setItem('currentUser', data.currentUser);
    if (data.treasurerBalance) localStorage.setItem('treasurerBalance', data.treasurerBalance);
    if (data.reserveTarget) localStorage.setItem('reserveTarget', data.reserveTarget);
    if (data.monthlyExpenses) localStorage.setItem('monthlyExpenses', data.monthlyExpenses);
    if (data.reserveMonths) localStorage.setItem('reserveMonths', data.reserveMonths);
}

// ========== END UNIFIED BACKUP & RESTORE ==========

function addExpense() {
    const date = document.getElementById('expense-date').value;
    const category = document.getElementById('expense-category').value;
    const description = document.getElementById('expense-description').value.trim();
    const amount = parseFloat(document.getElementById('expense-amount').value);

    if (!date || !category || !description || isNaN(amount) || amount < 0) {
        showToast('Please fill in all fields with valid data', 'error');
        return;
    }

    const expenses = storage.getExpenses();

    expenses.push({
        id: genId(),
        date: date,
        category: category,
        description: description,
        amount: amount
    });

    storage.saveExpenses(expenses);
    showToast('Expense logged!', 'success');

    document.getElementById('expense-date').value = '';
    document.getElementById('expense-category').value = '';
    document.getElementById('expense-description').value = '';
    document.getElementById('expense-amount').value = '';

    updateExpensesTable();
    updateBudgetTable();
}

function updateExpensesTable() {
    const tbody = document.getElementById('expenses-table');
    const expenses = storage.getExpenses();

    tbody.innerHTML = '';

    // Sort by date descending
    expenses.sort((a, b) => new Date(b.date) - new Date(a.date));

    // Show last 20 expenses
    expenses.slice(0, 20).forEach(exp => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${new Date(exp.date).toLocaleDateString()}</td>
            <td>${exp.category}</td>
            <td>${exp.description}</td>
            <td>$${exp.amount.toFixed(2)}</td>
            <td>
                <button class="btn secondary" data-action="delete-expense" data-id="${escapeAttribute(exp.id)}">Delete</button>
            </td>
        `;

        tbody.appendChild(tr);
    });

    if (expenses.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5">No expenses logged</td></tr>';
    }
}

function deleteExpense(id) {
    if (!confirm('Delete this expense?')) return;
    let expenses = storage.getExpenses();
    expenses = expenses.filter(e => e.id !== id);
    storage.saveExpenses(expenses);
    updateExpensesTable();
    updateBudgetTable();
    showToast('Expense deleted', 'success');
}

function populateExpenseCategories() {
    const select = document.getElementById('expense-category');
    const categories = storage.getBudgetCategories();

    select.innerHTML = '<option value="">Select category...</option>';

    categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.category;
        option.textContent = cat.category;
        select.appendChild(option);
    });
}

function generateMonthlyReport() {
    const month = document.getElementById('report-month').value;
    if (!month) {
        showToast('Please select a month', 'error');
        return;
    }

    const expenses = storage.getExpenses();
    const categories = storage.getBudgetCategories();
    const reportDiv = document.getElementById('monthly-report');

    const monthExpenses = expenses.filter(e => e.date.startsWith(month));

    let totalSpent = 0;
    let totalBudget = 0;

    let reportHTML = `<h4>Financial Report for ${month}</h4>`;
    reportHTML += '<table style="width: 100%; margin-top: 1rem;"><thead><tr><th>Category</th><th>Budget</th><th>Spent</th><th>Variance</th></tr></thead><tbody>';

    categories.forEach(cat => {
        const catExpenses = monthExpenses.filter(e => e.category === cat.category);
        const spent = catExpenses.reduce((sum, e) => sum + e.amount, 0);
        const variance = cat.monthlyBudget - spent;

        totalBudget += cat.monthlyBudget;
        totalSpent += spent;

        reportHTML += `
            <tr>
                <td>${cat.category}</td>
                <td>$${cat.monthlyBudget.toFixed(2)}</td>
                <td>$${spent.toFixed(2)}</td>
                <td style="color: ${variance < 0 ? '#e74c3c' : '#2ecc71'}">$${variance.toFixed(2)}</td>
            </tr>
        `;
    });

    const totalVariance = totalBudget - totalSpent;

    reportHTML += `
        <tr style="font-weight: bold; border-top: 2px solid #3498db;">
            <td>TOTAL</td>
            <td>$${totalBudget.toFixed(2)}</td>
            <td>$${totalSpent.toFixed(2)}</td>
            <td style="color: ${totalVariance < 0 ? '#e74c3c' : '#2ecc71'}">$${totalVariance.toFixed(2)}</td>
        </tr>
    `;

    reportHTML += '</tbody></table>';

    reportHTML += `<p style="margin-top: 1rem;"><strong>Total Expenses:</strong> ${monthExpenses.length}</p>`;

    reportDiv.innerHTML = reportHTML;

    generateYoYChart();
}

function generateYoYChart() {
    const expenses = storage.getExpenses();
    const chartDiv = document.getElementById('yoy-chart');

    // Group expenses by month
    const monthlyTotals = {};

    expenses.forEach(exp => {
        const month = exp.date.substring(0, 7);
        if (!monthlyTotals[month]) monthlyTotals[month] = 0;
        monthlyTotals[month] += exp.amount;
    });

    // Get last 12 months
    const months = Object.keys(monthlyTotals).sort().slice(-12);

    if (months.length === 0) {
        chartDiv.innerHTML = '<p>Not enough data for chart</p>';
        return;
    }

    // Simple text-based chart
    let chartHTML = '<h4>Last 12 Months Spending</h4>';
    chartHTML += '<div style="margin-top: 1rem;">';

    const maxAmount = Math.max(...months.map(m => monthlyTotals[m]));

    months.forEach(month => {
        const amount = monthlyTotals[month];
        const barWidth = (amount / maxAmount) * 100;

        chartHTML += `
            <div style="margin-bottom: 0.5rem;">
                <div style="font-size: 0.85rem; margin-bottom: 2px;">${month}: $${amount.toFixed(2)}</div>
                <div style="background: #3498db; height: 20px; width: ${barWidth}%; border-radius: 3px;"></div>
            </div>
        `;
    });

    chartHTML += '</div>';

    chartDiv.innerHTML = chartHTML;
}

// ========== BACKUP & SYNC FUNCTIONS ==========

// Group Settings Functions
function saveGroupSettings() {
    const settings = {
        qrCodeUrl: document.getElementById('group-qr-code-url').value.trim(),
        zoomLink: document.getElementById('group-zoom-link').value.trim(),
        contactName: document.getElementById('group-contact-name').value.trim(),
        contactPhone: document.getElementById('group-contact-phone').value.trim()
    };
    localStorage.setItem('groupSettings', JSON.stringify(settings));
    applyGroupSettings();
    showToast('Group settings saved!', 'success');
}

function loadGroupSettings() {
    const settings = JSON.parse(localStorage.getItem('groupSettings') || '{}');
    const qrInput = document.getElementById('group-qr-code-url');
    const zoomInput = document.getElementById('group-zoom-link');
    const nameInput = document.getElementById('group-contact-name');
    const phoneInput = document.getElementById('group-contact-phone');

    if (qrInput) qrInput.value = settings.qrCodeUrl || '';
    if (zoomInput) zoomInput.value = settings.zoomLink || '';
    if (nameInput) nameInput.value = settings.contactName || '';
    if (phoneInput) phoneInput.value = settings.contactPhone || '';

    applyGroupSettings();
}

function applyGroupSettings() {
    const settings = JSON.parse(localStorage.getItem('groupSettings') || '{}');

    // Update QR Code
    const qrBox = document.getElementById('qr-code-box');
    const qrImg = document.getElementById('qr-code-img');
    const qrContact = document.getElementById('qr-code-contact');

    if (settings.qrCodeUrl) {
        qrImg.src = settings.qrCodeUrl;
        qrBox.style.display = 'block';

        // Update contact info
        if (settings.contactName && settings.contactPhone) {
            qrContact.textContent = `For questions, please contact ${settings.contactName} at ${settings.contactPhone}.`;
        } else if (settings.contactName) {
            qrContact.textContent = `For questions, please contact ${settings.contactName}.`;
        } else {
            qrContact.textContent = '';
        }
    } else {
        qrBox.style.display = 'none';
    }

    // Update Zoom Button
    const zoomBtn = document.getElementById('zoom-meeting-btn');
    const zoomNote = document.getElementById('zoom-meeting-note');

    if (settings.zoomLink) {
        zoomBtn.href = settings.zoomLink;
        zoomBtn.style.display = 'block';
        zoomNote.style.display = 'block';
    } else {
        zoomBtn.style.display = 'none';
        zoomNote.style.display = 'none';
    }
}

function saveCurrentUser() {
    const name = document.getElementById('current-user-name').value.trim();
    if (!name) {
        showToast('Please enter your name', 'error');
        return;
    }
    storage.saveCurrentUser(name);
    showToast('Name saved!', 'success');
}

function loadCurrentUser() {
    const name = storage.getCurrentUser();
    const input = document.getElementById('current-user-name');
    if (input) {
        input.value = name;
    }
}

// Storage Usage Monitoring
function checkStorageUsage() {
    try {
        // Calculate total size of localStorage
        let totalSize = 0;
        for (let key in localStorage) {
            if (localStorage.hasOwnProperty(key)) {
                totalSize += localStorage[key].length + key.length;
            }
        }

        // Convert to KB
        const sizeInKB = (totalSize / 1024).toFixed(2);
        const estimatedLimit = 5120; // Most browsers allow ~5MB (5120 KB)
        const percentage = (totalSize / (estimatedLimit * 1024)) * 100;

        // Update UI
        document.getElementById('storage-used').textContent = sizeInKB;
        const progressBar = document.getElementById('storage-progress-bar');
        progressBar.style.width = Math.min(percentage, 100) + '%';

        // Change color based on usage
        const warningDiv = document.getElementById('storage-warning');
        const criticalDiv = document.getElementById('storage-critical');

        warningDiv.style.display = 'none';
        criticalDiv.style.display = 'none';

        if (percentage > 90) {
            progressBar.style.background = 'linear-gradient(90deg, #c0392b, #e74c3c)';
            criticalDiv.style.display = 'block';
        } else if (percentage > 80) {
            progressBar.style.background = 'linear-gradient(90deg, #d68910, #f39c12)';
            warningDiv.style.display = 'block';
        } else {
            progressBar.style.background = 'linear-gradient(90deg, #27ae60, #2ecc71)';
        }

        progressBar.textContent = percentage.toFixed(1) + '%';

        return {sizeInKB, percentage};
    } catch (e) {
        console.error('Error checking storage:', e);
        return null;
    }
}


// ========== TEMPLATE FUNCTIONS ==========

function saveTemplate() {
    const name = document.getElementById('template-name').value.trim();
    const type = document.getElementById('template-type').value;
    const content = document.getElementById('template-content').value.trim();

    if (!name || !content) {
        showToast('Please enter template name and content', 'error');
        return;
    }

    const templates = storage.getTemplates();

    templates.push({
        id: genId(),
        name: name,
        type: type,
        content: content,
        created: new Date().toISOString()
    });

    storage.saveTemplates(templates);
    showToast('Template saved!', 'success');

    document.getElementById('template-name').value = '';
    document.getElementById('template-type').value = 'meeting-format';
    document.getElementById('template-content').value = '';

    filterTemplates('all');
}

function filterTemplates(type) {
    const templates = storage.getTemplates();
    const container = document.getElementById('templates-list');

    // Update button states
    document.getElementById('all-templates-btn').classList.toggle('active', type === 'all');
    document.getElementById('meeting-templates-btn').classList.toggle('active', type === 'meeting-format');
    document.getElementById('speaker-templates-btn').classList.toggle('active', type === 'speaker-checklist');
    document.getElementById('event-templates-btn').classList.toggle('active', type === 'event-planning');

    const filtered = type === 'all' ? templates : templates.filter(t => t.type === type);

    container.innerHTML = '';

    if (filtered.length === 0) {
        container.innerHTML = '<p>No templates saved</p>';
        return;
    }

    filtered.forEach(tmpl => {
        const card = document.createElement('div');
        card.className = 'template-card';

        const header = document.createElement('div');
        header.className = 'template-header';

        const title = document.createElement('h4');
        title.textContent = tmpl.name;

        const badge = document.createElement('span');
        badge.className = 'template-type-badge';
        badge.textContent = tmpl.type.replace('-', ' ').toUpperCase();

        header.appendChild(title);
        header.appendChild(badge);

        const content = document.createElement('pre');
        content.style.whiteSpace = 'pre-wrap';
        content.style.fontSize = '0.9rem';
        content.style.marginTop = '10px';
        content.textContent = tmpl.content;

        const btnContainer = document.createElement('div');
        btnContainer.style.marginTop = '10px';

        const useBtn = document.createElement('button');
        useBtn.className = 'btn';
        useBtn.textContent = 'Use Template';
        useBtn.onclick = () => useTemplate(tmpl.id);

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn secondary';
        deleteBtn.style.marginLeft = '8px';
        deleteBtn.textContent = 'Delete';
        deleteBtn.onclick = () => deleteTemplate(tmpl.id);

        btnContainer.appendChild(useBtn);
        btnContainer.appendChild(deleteBtn);

        card.appendChild(header);
        card.appendChild(content);
        card.appendChild(btnContainer);

        container.appendChild(card);
    });
}

function useTemplate(id) {
    const templates = storage.getTemplates();
    const template = templates.find(t => t.id === id);

    if (template) {
        // Copy to clipboard
        navigator.clipboard.writeText(template.content).then(() => {
            showToast('Template copied to clipboard!', 'success');
        }).catch(() => {
            showToast('Could not copy template', 'error');
        });
    }
}

function deleteTemplate(id) {
    if (!confirm('Delete this template?')) return;
    let templates = storage.getTemplates();
    templates = templates.filter(t => t.id !== id);
    storage.saveTemplates(templates);
    filterTemplates('all');
    showToast('Template deleted', 'success');
}


// Initialize the application
function init() {
    initDefaults();
    initNav();
    initDictionary();
    initCalendarNav();
    updateEventsTable();
    updateBirthdaysTable();
    updateAnnouncementsList();
    updateGallery();
    updateHome();
    renderCalendar();
    showHistory('genesis-history');
    updateChairpersonLogTable();
    updateGCLogTable();
    updateLiveGCTable();
    updateChairpersonAnnouncements();
    populateAttendeeDropdown();
    populateMemberDropdowns();
    renderServantReportInputs();
    setupAudioRecorder();

    // Initialize new GC features
    updateProposedAgendaTable();
    loadGCSettings();
    updateActionItemsTable();
    performGCHistorySearch(); // Call direct function to avoid debounce on init
    updateGCStatistics();
    refreshGCTrends();

    // Initialize high priority GC features
    populateNewFeatureDropdowns();
    refreshStandingItems();
    refreshConsentAgenda();
    refreshEmailHistory();

    // Initialize medium priority GC features
    refreshReconsiderationRequests();
    refreshProxyVotes();
    refreshDecisionReversals();

    // Initialize new features
    loadGroupSettings();
    loadCurrentUser();
    populateMessageRecipients();
    showMessages('inbox');
    populateServicePositionHolders();
    updateServicePositionsTable();
    updateRotationCalendar();
    populateNominationPositions();
    updateNominationsList();
    populateExpenseCategories();
    updateBudgetTable();
    updateExpensesTable();
    filterTemplates('all');

    // Initialize backup and recovery systems
    checkCrashRecovery();
    setTimeout(() => checkAndPromptBackup(), 3000); // Check backup after 3 seconds

    // Setup auto-save every 5 minutes
    setInterval(autoSaveToSession, 5 * 60 * 1000);

    // Initial auto-save
    autoSaveToSession();

    // Set default date for expense logging to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('expense-date').value = today;

    // Initialize new nice-to-have features
    refreshAnalytics();
    loadAccessibilitySettings();
    checkStorageUsage();

    // Check for upcoming GC meetings and show notifications
    setTimeout(() => checkUpcomingGCMeetings(), 2000); // Delay 2 seconds for better UX

    // P1/P2: Initialize new systems
    updateNotificationBadge();
    scheduleAutomatedBackups();
    checkUpcomingTermExpirations();
    checkMemberEngagement();

    // Initialize smart notification system
    initSmartNotificationSystem();

    // Quick Wins: Initialize periodic checks
    checkUpcomingBirthdaysAndAnniversaries();
    checkActionItemReminders();
    updatePrudentReserveProgressBar();

    // Initialize Decision Impact & Institutional Memory features
    renderDecisionImpacts();
    populateImpactGCMotions();
    searchLessonsLearned();

    // Add event listener for projection revenue type
    const projRevenueType = document.getElementById('projection-revenue-type');
    if (projRevenueType) {
        projRevenueType.addEventListener('change', function() {
            const amountGroup = document.getElementById('projection-revenue-amount-group');
            if (this.value === 'none') {
                amountGroup.style.display = 'none';
            } else {
                amountGroup.style.display = 'block';
            }
        });
    }

    // Run periodic checks
    setInterval(() => {
        checkUpcomingTermExpirations();
        checkMemberEngagement();
        scheduleAutomatedBackups();
        checkUpcomingBirthdaysAndAnniversaries();
        checkActionItemReminders();
        updatePrudentReserveProgressBar();
    }, 3600000); // Check hourly

    // Back to Top button logic
    const mainEl = document.querySelector('main');
    const backToTopBtn = document.getElementById('back-to-top-btn');

    mainEl.addEventListener('scroll', () => {
        const historySection = document.getElementById('history-section');
        if (historySection.classList.contains('active') && mainEl.scrollTop > 100) {
            backToTopBtn.style.display = 'block';
        } else {
            backToTopBtn.style.display = 'none';
        }
    });

    backToTopBtn.addEventListener('click', () => {
        mainEl.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // Initialize new sections
    initNewSections();

    // Initialize High-Impact Features
    loadVotingSettings();
    renderMotionTemplates();
    renderSpeakingQueue();
    renderCurrentPositions();
    renderElectionHistory();
    renderBudgetProposals();
    renderLiteratureInventory();
    renderLiteratureLoans();
    renderDistrictMotions();

    // Populate new dropdowns
    populateElectionPositions();
    populateSpeakersDropdown();
    populateLiteratureLoanMembers();

    // Initialize Enhanced Features
    renderQuorumRules();
    renderMinutesArchive();
    populateMinutesGCSelect();
    renderParticipationAnalytics();
    renderDecisionImpacts();
    renderFinancialHealth();
    renderInventorySchedules();
    populateImpactGCMotions();
    updateRoleView();

    // Initialize Privacy & Security Features
    loadPrivacySettings();

    // Initialize AA-Specific Features
    displayTraditionOfDay();
    renderPrincipleTaggedList();
    populatePrincipleMotionSelect();
    renderMinorityOpinions();
    populateMinorityMotionSelect();
    loadServiceStructure();

    // P2: Initialize quorum display
    updateQuorumDisplay();

    // P6: Setup keyboard shortcuts
    setupKeyboardShortcuts();
}

// ========== P6: UI/UX IMPROVEMENTS ==========

function setupKeyboardShortcuts() {
    document.addEventListener('keydown', (e) => {
        // Only trigger if not in an input field
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
            return;
        }

        // Alt + H = Home
        if (e.altKey && e.key.toLowerCase() === 'h') {
            e.preventDefault();
            goToSection('home-section');
            showToast('Navigated to Home (Alt+H)', 'info');
        }

        // Alt + G = Group Conscience
        if (e.altKey && e.key.toLowerCase() === 'g') {
            e.preventDefault();
            goToSection('gc-decisions-section');
            showToast('Navigated to Group Conscience (Alt+G)', 'info');
        }

        // Alt + F = Finance
        if (e.altKey && e.key.toLowerCase() === 'f') {
            e.preventDefault();
            goToSection('finance-section');
            showToast('Navigated to Finance (Alt+F)', 'info');
        }

        // Alt + S = Search
        if (e.altKey && e.key.toLowerCase() === 's') {
            e.preventDefault();
            displayUniversalSearch();
            showToast('Universal Search (Alt+S)', 'info');
        }

        // Alt + N = Notifications
        if (e.altKey && e.key.toLowerCase() === 'n') {
            e.preventDefault();
            showNotificationCenter();
            showToast('Notification Center (Alt+N)', 'info');
        }

        // Alt + P = Parliamentary Procedure
        if (e.altKey && e.key.toLowerCase() === 'p') {
            e.preventDefault();
            goToSection('parliamentary-section');
            showToast('Navigated to Parliamentary Procedure (Alt+P)', 'info');
        }

        // Alt + M = Members
        if (e.altKey && e.key.toLowerCase() === 'm') {
            e.preventDefault();
            goToSection('birthdays-section');
            showToast('Navigated to Members (Alt+M)', 'info');
        }

        // ? = Show keyboard shortcuts
        if (e.key === '?' && !e.shiftKey) {
            e.preventDefault();
            showKeyboardShortcuts();
        }
    });
}

function showKeyboardShortcuts() {
    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';

    modal.innerHTML = `
        <div style="background: #34495e; padding: 2rem; border-radius: 8px; max-width: 600px; width: 90%;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2 style="color: #3498db; margin: 0;"><i class="fas fa-keyboard"></i> Keyboard Shortcuts</h2>
                <button onclick="this.closest('div[style*=fixed]').remove()" style="background: none; border: none; color: #e74c3c; font-size: 2rem; cursor: pointer;">&times;</button>
            </div>

            <div class="box" style="margin-bottom: 1rem;">
                <h3>Navigation</h3>
                <div style="display: grid; gap: 0.5rem;">
                    <div style="display: flex; justify-content: space-between;">
                        <span><kbd>Alt + H</kbd></span>
                        <span>Home</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span><kbd>Alt + G</kbd></span>
                        <span>Group Conscience</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span><kbd>Alt + F</kbd></span>
                        <span>Finance</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span><kbd>Alt + P</kbd></span>
                        <span>Parliamentary Procedure</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span><kbd>Alt + M</kbd></span>
                        <span>Members</span>
                    </div>
                </div>
            </div>

            <div class="box">
                <h3>Actions</h3>
                <div style="display: grid; gap: 0.5rem;">
                    <div style="display: flex; justify-content: space-between;">
                        <span><kbd>Alt + S</kbd></span>
                        <span>Universal Search</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span><kbd>Alt + N</kbd></span>
                        <span>Notifications</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span><kbd>?</kbd></span>
                        <span>Show this help</span>
                    </div>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
}

// ============================================
// ANALYTICS DASHBOARD FUNCTIONS
// ============================================

let attendanceChart = null;
let gcParticipationChart = null;

function refreshAnalytics() {
    renderAttendanceTrends();
    renderEngagementMetrics();
    renderGCParticipation();
    renderServiceEngagement();
    renderActivitySummary();
}

function renderAttendanceTrends() {
    const days = parseInt(document.getElementById('analytics-time-range').value);
    const events = JSON.parse(localStorage.getItem('events') || '[]');

    // Calculate date range
    const endDate = new Date();
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - days);

    // Filter events in date range
    const relevantEvents = events.filter(e => {
        const eventDate = new Date(e.date);
        return eventDate >= startDate && eventDate <= endDate;
    });

    // Group by week
    const weeklyData = {};
    relevantEvents.forEach(event => {
        const eventDate = new Date(event.date);
        const weekStart = new Date(eventDate);
        weekStart.setDate(eventDate.getDate() - eventDate.getDay());
        const weekKey = weekStart.toISOString().split('T')[0];

        if (!weeklyData[weekKey]) {
            weeklyData[weekKey] = { count: 0, totalAttendance: 0 };
        }
        weeklyData[weekKey].count++;
        weeklyData[weekKey].totalAttendance += (event.attendees || []).length;
    });

    const labels = Object.keys(weeklyData).sort();
    const attendanceData = labels.map(key => weeklyData[key].totalAttendance);
    const eventCounts = labels.map(key => weeklyData[key].count);

    const ctx = document.getElementById('attendance-chart').getContext('2d');

    if (attendanceChart) {
        attendanceChart.destroy();
    }

    attendanceChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels.map(date => new Date(date).toLocaleDateString()),
            datasets: [{
                label: 'Total Attendance',
                data: attendanceData,
                borderColor: '#3498db',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    labels: { color: '#ecf0f1' }
                }
            },
            scales: {
                x: {
                    ticks: { color: '#ecf0f1' },
                    grid: { color: 'rgba(236, 240, 241, 0.1)' }
                },
                y: {
                    ticks: { color: '#ecf0f1' },
                    grid: { color: 'rgba(236, 240, 241, 0.1)' },
                    beginAtZero: true
                }
            }
        }
    });
}

function renderEngagementMetrics() {
    const members = JSON.parse(localStorage.getItem('members') || '[]');
    const events = JSON.parse(localStorage.getItem('events') || '[]');
    const messages = JSON.parse(localStorage.getItem('messages') || '[]');
    const gcMotions = JSON.parse(localStorage.getItem('groupConscienceMotions') || '[]');

    const totalMembers = members.length;
    const activeMembers = members.filter(m => m.isServant ||
        events.some(e => (e.attendees || []).includes(m.id))).length;
    const engagementRate = totalMembers > 0 ?
        ((activeMembers / totalMembers) * 100).toFixed(1) : 0;

    const recentMessages = messages.filter(m => {
        const msgDate = new Date(m.timestamp);
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        return msgDate >= thirtyDaysAgo;
    }).length;

    const html = `
        <div style="background: #34495e; padding: 1rem; border-radius: 6px; text-align: center;">
            <div style="font-size: 2rem; color: #3498db; font-weight: bold;">${totalMembers}</div>
            <div style="color: #95a5a6;">Total Members</div>
        </div>
        <div style="background: #34495e; padding: 1rem; border-radius: 6px; text-align: center;">
            <div style="font-size: 2rem; color: #2ecc71; font-weight: bold;">${activeMembers}</div>
            <div style="color: #95a5a6;">Active Members</div>
        </div>
        <div style="background: #34495e; padding: 1rem; border-radius: 6px; text-align: center;">
            <div style="font-size: 2rem; color: #e74c3c; font-weight: bold;">${engagementRate}%</div>
            <div style="color: #95a5a6;">Engagement Rate</div>
        </div>
        <div style="background: #34495e; padding: 1rem; border-radius: 6px; text-align: center;">
            <div style="font-size: 2rem; color: #f39c12; font-weight: bold;">${recentMessages}</div>
            <div style="color: #95a5a6;">Messages (30d)</div>
        </div>
    `;

    document.getElementById('engagement-metrics').innerHTML = html;
}

function renderGCParticipation() {
    const gcMotions = JSON.parse(localStorage.getItem('groupConscienceMotions') || '[]');
    const members = JSON.parse(localStorage.getItem('members') || '[]');

    const totalMotions = gcMotions.length;
    const votedMotions = gcMotions.filter(m => m.status === 'approved' || m.status === 'rejected').length;
    const pendingMotions = gcMotions.filter(m => m.status === 'open').length;

    // Calculate participation
    let totalVotes = 0;
    let totalPossibleVotes = 0;

    gcMotions.forEach(motion => {
        if (motion.votes) {
            totalVotes += motion.votes.yes + motion.votes.no + motion.votes.abstain;
            totalPossibleVotes += members.length;
        }
    });

    const participationRate = totalPossibleVotes > 0 ?
        ((totalVotes / totalPossibleVotes) * 100).toFixed(1) : 0;

    const statsHtml = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
            <div style="background: #34495e; padding: 1rem; border-radius: 6px; text-align: center;">
                <div style="font-size: 1.5rem; color: #3498db; font-weight: bold;">${totalMotions}</div>
                <div style="color: #95a5a6; font-size: 0.9rem;">Total Motions</div>
            </div>
            <div style="background: #34495e; padding: 1rem; border-radius: 6px; text-align: center;">
                <div style="font-size: 1.5rem; color: #2ecc71; font-weight: bold;">${votedMotions}</div>
                <div style="color: #95a5a6; font-size: 0.9rem;">Voted On</div>
            </div>
            <div style="background: #34495e; padding: 1rem; border-radius: 6px; text-align: center;">
                <div style="font-size: 1.5rem; color: #f39c12; font-weight: bold;">${pendingMotions}</div>
                <div style="color: #95a5a6; font-size: 0.9rem;">Pending</div>
            </div>
            <div style="background: #34495e; padding: 1rem; border-radius: 6px; text-align: center;">
                <div style="font-size: 1.5rem; color: #e74c3c; font-weight: bold;">${participationRate}%</div>
                <div style="color: #95a5a6; font-size: 0.9rem;">Participation</div>
            </div>
        </div>
    `;

    document.getElementById('gc-participation-stats').innerHTML = statsHtml;

    // Create chart
    const ctx = document.getElementById('gc-participation-chart').getContext('2d');

    if (gcParticipationChart) {
        gcParticipationChart.destroy();
    }

    const approved = gcMotions.filter(m => m.status === 'approved').length;
    const rejected = gcMotions.filter(m => m.status === 'rejected').length;
    const open = gcMotions.filter(m => m.status === 'open').length;

    gcParticipationChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Approved', 'Rejected', 'Open'],
            datasets: [{
                data: [approved, rejected, open],
                backgroundColor: ['#2ecc71', '#e74c3c', '#f39c12']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    labels: { color: '#ecf0f1' }
                }
            }
        }
    });
}

function renderServiceEngagement() {
    const positions = JSON.parse(localStorage.getItem('servicePositions') || '[]');

    const filled = positions.filter(p => p.holder && p.holder.trim() !== '').length;
    const vacant = positions.length - filled;
    const fillRate = positions.length > 0 ?
        ((filled / positions.length) * 100).toFixed(1) : 0;

    const html = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
            <div style="background: #34495e; padding: 1rem; border-radius: 6px; text-align: center;">
                <div style="font-size: 1.5rem; color: #3498db; font-weight: bold;">${positions.length}</div>
                <div style="color: #95a5a6; font-size: 0.9rem;">Total Positions</div>
            </div>
            <div style="background: #34495e; padding: 1rem; border-radius: 6px; text-align: center;">
                <div style="font-size: 1.5rem; color: #2ecc71; font-weight: bold;">${filled}</div>
                <div style="color: #95a5a6; font-size: 0.9rem;">Filled</div>
            </div>
            <div style="background: #34495e; padding: 1rem; border-radius: 6px; text-align: center;">
                <div style="font-size: 1.5rem; color: #e74c3c; font-weight: bold;">${vacant}</div>
                <div style="color: #95a5a6; font-size: 0.9rem;">Vacant</div>
            </div>
            <div style="background: #34495e; padding: 1rem; border-radius: 6px; text-align: center;">
                <div style="font-size: 1.5rem; color: #f39c12; font-weight: bold;">${fillRate}%</div>
                <div style="color: #95a5a6; font-size: 0.9rem;">Fill Rate</div>
            </div>
        </div>
    `;

    document.getElementById('service-engagement-stats').innerHTML = html;
}

function renderActivitySummary() {
    const events = JSON.parse(localStorage.getItem('events') || '[]');
    const messages = JSON.parse(localStorage.getItem('messages') || '[]');
    const announcements = JSON.parse(localStorage.getItem('announcements') || '[]');
    const gcMotions = JSON.parse(localStorage.getItem('groupConscienceMotions') || '[]');

    const now = new Date();
    const sevenDaysAgo = new Date();
    sevenDaysAgo.setDate(now.getDate() - 7);

    const recentEvents = events.filter(e => new Date(e.date) >= sevenDaysAgo).length;
    const recentMessages = messages.filter(m => new Date(m.timestamp) >= sevenDaysAgo).length;
    const recentAnnouncements = announcements.filter(a => new Date(a.timestamp) >= sevenDaysAgo).length;
    const recentMotions = gcMotions.filter(m => m.createdAt && new Date(m.createdAt) >= sevenDaysAgo).length;

    const html = `
        <div style="background: #34495e; padding: 1rem; border-radius: 6px;">
            <h4 style="color: #3498db; margin-bottom: 0.75rem;">Last 7 Days</h4>
            <ul style="list-style: none; padding: 0;">
                <li style="padding: 0.5rem 0; border-bottom: 1px solid #2c3e50;">
                    <i class="fas fa-calendar-alt" style="color: #3498db; margin-right: 0.5rem;"></i>
                    <strong>${recentEvents}</strong> events scheduled
                </li>
                <li style="padding: 0.5rem 0; border-bottom: 1px solid #2c3e50;">
                    <i class="fas fa-comment" style="color: #2ecc71; margin-right: 0.5rem;"></i>
                    <strong>${recentMessages}</strong> messages sent
                </li>
                <li style="padding: 0.5rem 0; border-bottom: 1px solid #2c3e50;">
                    <i class="fas fa-bullhorn" style="color: #f39c12; margin-right: 0.5rem;"></i>
                    <strong>${recentAnnouncements}</strong> announcements posted
                </li>
                <li style="padding: 0.5rem 0;">
                    <i class="fas fa-vote-yea" style="color: #e74c3c; margin-right: 0.5rem;"></i>
                    <strong>${recentMotions}</strong> GC motions created
                </li>
            </ul>
        </div>
    `;

    document.getElementById('activity-summary').innerHTML = html;
}

// ============================================
// ACCESSIBILITY FUNCTIONS
// ============================================

function changeTheme() {
    const theme = document.getElementById('theme-mode').value;
    const body = document.body;
    const nav = document.querySelector('nav');
    const boxes = document.querySelectorAll('.box');

    // Remove existing theme classes
    body.classList.remove('light-theme', 'high-contrast-theme');

    if (theme === 'light') {
        body.style.background = '#ecf0f1';
        body.style.color = '#2c3e50';
        if (nav) {
            nav.style.background = '#bdc3c7';
            nav.style.color = '#2c3e50';
        }
        document.querySelectorAll('h1, h2, h3').forEach(h => {
            h.style.color = '#2980b9';
        });
        boxes.forEach(box => {
            box.style.background = '#ffffff';
            box.style.color = '#2c3e50';
        });
    } else if (theme === 'high-contrast') {
        body.style.background = '#000000';
        body.style.color = '#ffffff';
        if (nav) {
            nav.style.background = '#1a1a1a';
            nav.style.color = '#ffffff';
        }
        document.querySelectorAll('h1, h2, h3').forEach(h => {
            h.style.color = '#ffff00';
        });
        boxes.forEach(box => {
            box.style.background = '#1a1a1a';
            box.style.color = '#ffffff';
        });
    } else {
        // Default dark theme
        body.style.background = '#2c3e50';
        body.style.color = '#ecf0f1';
        if (nav) {
            nav.style.background = '#34495e';
            nav.style.color = '#ecf0f1';
        }
        document.querySelectorAll('h1, h2, h3').forEach(h => {
            h.style.color = '#3498db';
        });
        boxes.forEach(box => {
            box.style.background = '#34495e';
            box.style.color = '#ecf0f1';
        });
    }

    localStorage.setItem('theme', theme);
    showToast('Theme changed', 'success');
}

function changeFontSize(size) {
    document.documentElement.style.fontSize = size + '%';
    document.getElementById('font-size-slider').value = size;
    document.getElementById('font-size-display').textContent = size + '%';
    localStorage.setItem('fontSize', size);
    showToast('Font size updated', 'success');
}

function toggleScreenReaderMode() {
    const enabled = document.getElementById('screen-reader-mode').checked;

    if (enabled) {
        // Add skip navigation link
        const skipNav = document.createElement('a');
        skipNav.href = '#main-content';
        skipNav.textContent = 'Skip to main content';
        skipNav.id = 'skip-nav';
        skipNav.style.cssText = 'position: absolute; left: -9999px; z-index: 999; padding: 1em; background: #3498db; color: white; text-decoration: none;';
        skipNav.addEventListener('focus', function() {
            this.style.left = '0';
        });
        skipNav.addEventListener('blur', function() {
            this.style.left = '-9999px';
        });
        document.body.insertBefore(skipNav, document.body.firstChild);

        // Add main content ID
        const main = document.querySelector('main');
        if (main) main.id = 'main-content';

        // Add ARIA labels to navigation
        const navItems = document.querySelectorAll('nav li');
        navItems.forEach(item => {
            const section = item.getAttribute('data-section');
            if (section) {
                item.setAttribute('role', 'button');
                item.setAttribute('aria-label', `Navigate to ${item.textContent}`);
                item.setAttribute('tabindex', '0');
            }
        });

        showToast('Screen reader optimizations enabled', 'success');
    } else {
        // Remove skip nav
        const skipNav = document.getElementById('skip-nav');
        if (skipNav) skipNav.remove();

        showToast('Screen reader optimizations disabled', 'success');
    }

    localStorage.setItem('screenReaderMode', enabled);
}

function toggleReduceAnimations() {
    const enabled = document.getElementById('reduce-animations').checked;

    if (enabled) {
        const style = document.createElement('style');
        style.id = 'reduce-animations-style';
        style.textContent = `
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        `;
        document.head.appendChild(style);
    } else {
        const style = document.getElementById('reduce-animations-style');
        if (style) style.remove();
    }

    localStorage.setItem('reduceAnimations', enabled);
    showToast(`Animations ${enabled ? 'reduced' : 'restored'}`, 'success');
}

function toggleFocusIndicators() {
    const enabled = document.getElementById('focus-indicators').checked;

    if (enabled) {
        const style = document.createElement('style');
        style.id = 'focus-indicators-style';
        style.textContent = `
            *:focus {
                outline: 3px solid #3498db !important;
                outline-offset: 2px !important;
            }
        `;
        document.head.appendChild(style);
    } else {
        const style = document.getElementById('focus-indicators-style');
        if (style) style.remove();
    }

    localStorage.setItem('focusIndicators', enabled);
    showToast(`Focus indicators ${enabled ? 'enhanced' : 'normal'}`, 'success');
}

function toggleDyslexiaFont() {
    const enabled = document.getElementById('dyslexia-font').checked;

    if (enabled) {
        // Use Comic Sans as a more dyslexia-friendly alternative
        document.body.style.fontFamily = 'Comic Sans MS, Verdana, sans-serif';
    } else {
        document.body.style.fontFamily = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
    }

    localStorage.setItem('dyslexiaFont', enabled);
    showToast(`Dyslexia-friendly font ${enabled ? 'enabled' : 'disabled'}`, 'success');
}

function loadAccessibilitySettings() {
    // Load theme
    const theme = localStorage.getItem('theme') || 'dark';
    document.getElementById('theme-mode').value = theme;
    changeTheme();

    // Load font size
    const fontSize = localStorage.getItem('fontSize') || '100';
    changeFontSize(parseInt(fontSize));

    // Load screen reader mode
    const screenReaderMode = localStorage.getItem('screenReaderMode') === 'true';
    document.getElementById('screen-reader-mode').checked = screenReaderMode;
    if (screenReaderMode) toggleScreenReaderMode();

    // Load reduce animations
    const reduceAnimations = localStorage.getItem('reduceAnimations') === 'true';
    document.getElementById('reduce-animations').checked = reduceAnimations;
    if (reduceAnimations) toggleReduceAnimations();

    // Load focus indicators
    const focusIndicators = localStorage.getItem('focusIndicators') === 'true';
    document.getElementById('focus-indicators').checked = focusIndicators;
    if (focusIndicators) toggleFocusIndicators();

    // Load dyslexia font
    const dyslexiaFont = localStorage.getItem('dyslexiaFont') === 'true';
    document.getElementById('dyslexia-font').checked = dyslexiaFont;
    if (dyslexiaFont) toggleDyslexiaFont();
}

document.addEventListener('DOMContentLoaded', init);

// Event delegation for data-action buttons (prevents template literal injection)
document.addEventListener('click', function(e) {
    const btn = e.target.closest('[data-action]');
    if (!btn) return;

    const action = btn.dataset.action;
    const id = btn.dataset.id;
    const status = btn.dataset.status; // For actions that need additional data

    switch(action) {
        // Group Conscience
        case 'view-gc': openGCDetailsModal(id); break;
        case 'edit-gc': editGCLog(id); break;
        case 'delete-gc': deleteGCLog(id); break;
        case 'delete-live-gc': deleteLiveGCItem(id); break;
        case 'view-proposed': viewProposedAgendaItem(id); break;
        case 'delete-proposed': deleteProposedAgendaItem(id); break;
        case 'edit-action': editActionItem(id); break;
        case 'delete-action': deleteActionItem(id); break;
        case 'view-action-details': viewActionItemDetails(id); break;
        case 'update-amendment': updateAmendmentStatus(id, status); break;
        case 'delete-comment': deleteGCComment(id); break;
        case 'view-chain': viewMotionChain(id); break;
        case 'update-gc-status': updateGCItemStatus(id, status); break;
        case 'remove-gc-item': removeGCItem(id); break;

        // Events & Members
        case 'edit-event': editEvent(id); break;
        case 'delete-event': deleteEvent(id); break;
        case 'edit-member': editMember(id); break;
        case 'delete-member': deleteMember(id); break;
        case 'edit-member-roster': editMemberFromRoster(id); break;
        case 'delete-member-roster': deleteMemberAndRefreshRoster(id); break;

        // Chairperson
        case 'edit-chairperson': editChairpersonLog(id); break;
        case 'delete-chairperson': deleteChairpersonLog(id); break;

        // Service & Nominations
        case 'delete-position': deleteServicePosition(id); break;
        case 'delete-nomination': deleteNomination(id); break;

        // Budget & Expenses
        case 'delete-budget-category': deleteBudgetCategory(id); break;
        case 'delete-expense': deleteExpense(id); break;

        // Format & Commitments
        case 'edit-format': editFormat(id); break;
        case 'delete-format': deleteFormat(id); break;
        case 'edit-commitment': editCommitment(id); break;
        case 'delete-commitment': deleteCommitment(id); break;

        // Attendance
        case 'delete-attendance': deleteAttendance(id); break;

        // Bylaws
        case 'view-bylaw': viewByLaw(id); break;

        // Sponsorships
        case 'delete-sponsorship': deleteSponsorship(id); break;

        // Motion Templates
        case 'use-template': useMotionTemplate(id); break;
        case 'edit-template': editMotionTemplate(id); break;
        case 'delete-template': deleteMotionTemplate(id); break;

        // Literature Inventory
        case 'edit-lit-item': editLiteratureItem(id); break;
        case 'delete-lit-item': deleteLiteratureItem(id); break;
    }
});

// ========================================
// NEW FEATURES - JavaScript Functions
// ========================================

// FORMAT ROTATION FUNCTIONS
function handleFormatSubmit() {
    const name = document.getElementById('format-name').value.trim();
    const description = document.getElementById('format-description').value.trim();
    const order = parseInt(document.getElementById('format-order').value);
    const editId = document.getElementById('format-edit-id').value;

    if (!name || !order) {
        showToast('Please fill all required fields', 'error');
        return;
    }

    let formats = JSON.parse(localStorage.getItem('meetingFormats') || '[]');

    if (editId) {
        const index = formats.findIndex(f => f.id === editId);
        formats[index] = { ...formats[index], name, description, order };
        showToast('Format updated successfully', 'success');
    } else {
        const newFormat = { id: Date.now().toString(), name, description, order };
        formats.push(newFormat);
        showToast('Format added successfully', 'success');
    }

    localStorage.setItem('meetingFormats', JSON.stringify(formats));
    loadFormatRotationTable();
    loadUpcomingFormats();
    updateCurrentWeekFormat();
    resetFormatForm();
}

function cancelFormatEdit() {
    resetFormatForm();
}

function resetFormatForm() {
    document.getElementById('format-name').value = '';
    document.getElementById('format-description').value = '';
    document.getElementById('format-order').value = '';
    document.getElementById('format-edit-id').value = '';
    document.getElementById('format-form-btn').textContent = 'Add Format';
    document.getElementById('format-form-cancel-btn').style.display = 'none';
}

function loadFormatRotationTable() {
    const formats = JSON.parse(localStorage.getItem('meetingFormats') || '[]').sort((a, b) => a.order - b.order);
    const tbody = document.getElementById('format-rotation-body');
    tbody.innerHTML = '';

    formats.forEach(format => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${format.order}</td>
            <td>${DOMPurify.sanitize(format.name)}</td>
            <td>${DOMPurify.sanitize(format.description)}</td>
            <td>
                <button class="btn secondary" data-action="edit-format" data-id="${escapeAttribute(format.id)}" style="padding: 0.25rem 0.5rem; font-size: 0.85rem;">Edit</button>
                <button class="btn secondary" data-action="delete-format" data-id="${escapeAttribute(format.id)}" style="padding: 0.25rem 0.5rem; font-size: 0.85rem; margin-left: 0.25rem;">Delete</button>
            </td>
        `;
    });
}

function editFormat(id) {
    const formats = JSON.parse(localStorage.getItem('meetingFormats') || '[]');
    const format = formats.find(f => f.id === id);
    if (format) {
        document.getElementById('format-name').value = format.name;
        document.getElementById('format-description').value = format.description;
        document.getElementById('format-order').value = format.order;
        document.getElementById('format-edit-id').value = id;
        document.getElementById('format-form-btn').textContent = 'Update Format';
        document.getElementById('format-form-cancel-btn').style.display = 'inline-block';
    }
}

function deleteFormat(id) {
    if (!confirm('Delete this format?')) return;
    let formats = JSON.parse(localStorage.getItem('meetingFormats') || '[]');
    formats = formats.filter(f => f.id !== id);
    localStorage.setItem('meetingFormats', JSON.stringify(formats));
    loadFormatRotationTable();
    loadUpcomingFormats();
    showToast('Format deleted', 'success');
}

function loadUpcomingFormats() {
    const formats = JSON.parse(localStorage.getItem('meetingFormats') || '[]').sort((a, b) => a.order - b.order);
    const container = document.getElementById('upcoming-formats-list');
    if (formats.length === 0) {
        container.innerHTML = '<p>No formats configured</p>';
        return;
    }

    const today = new Date();
    let html = '<ul style="list-style: none; padding: 0;">';

    for (let i = 0; i < 8; i++) {
        const weekDate = new Date(today);
        weekDate.setDate(today.getDate() + (i * 7));
        const formatIndex = i % formats.length;
        const format = formats[formatIndex];
        html += `<li style="padding: 0.5rem; border-bottom: 1px solid #7f8c8d;">
            <strong>${weekDate.toLocaleDateString()}</strong>: ${DOMPurify.sanitize(format.name)}
        </li>`;
    }

    html += '</ul>';
    container.innerHTML = html;
}

function updateCurrentWeekFormat() {
    const formats = JSON.parse(localStorage.getItem('meetingFormats') || '[]').sort((a, b) => a.order - b.order);
    if (formats.length === 0) {
        document.getElementById('current-format-name').textContent = 'No Format Set';
        document.getElementById('current-week-date').textContent = '';
        return;
    }

    const today = new Date();
    const weekNumber = Math.floor((today - new Date(today.getFullYear(), 0, 1)) / (7 * 24 * 60 * 60 * 1000));
    const formatIndex = weekNumber % formats.length;
    const currentFormat = formats[formatIndex];

    document.getElementById('current-format-name').textContent = currentFormat.name;
    document.getElementById('current-week-date').textContent = today.toLocaleDateString();
}

// COMMITMENT BOARD FUNCTIONS
function handleCommitmentSubmit() {
    const date = document.getElementById('commitment-date').value;
    const role = document.getElementById('commitment-role').value;
    const member = document.getElementById('commitment-member').value;
    const reminder = document.getElementById('commitment-reminder').checked;
    const editId = document.getElementById('commitment-edit-id').value;

    if (!date || !role || !member) {
        showToast('Please fill all required fields', 'error');
        return;
    }

    let commitments = JSON.parse(localStorage.getItem('meetingCommitments') || '[]');

    if (editId) {
        const index = commitments.findIndex(c => c.id === editId);
        commitments[index] = { ...commitments[index], date, role, member, reminder };
        showToast('Commitment updated successfully', 'success');
    } else {
        const newCommitment = { id: Date.now().toString(), date, role, member, reminder };
        commitments.push(newCommitment);
        showToast('Commitment added successfully', 'success');
    }

    localStorage.setItem('meetingCommitments', JSON.stringify(commitments));
    loadCommitmentTable();
    loadCurrentWeekCommitments();
    resetCommitmentForm();
}

function cancelCommitmentEdit() {
    resetCommitmentForm();
}

function resetCommitmentForm() {
    document.getElementById('commitment-date').value = '';
    document.getElementById('commitment-role').selectedIndex = 0;
    document.getElementById('commitment-member').selectedIndex = 0;
    document.getElementById('commitment-reminder').checked = true;
    document.getElementById('commitment-edit-id').value = '';
    document.getElementById('commitment-form-btn').textContent = 'Sign Up';
    document.getElementById('commitment-form-cancel-btn').style.display = 'none';
}

function loadCommitmentTable() {
    const commitments = JSON.parse(localStorage.getItem('meetingCommitments') || '[]').sort((a, b) => new Date(a.date) - new Date(b.date));
    const tbody = document.getElementById('commitment-body');
    tbody.innerHTML = '';

    commitments.forEach(commitment => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${new Date(commitment.date).toLocaleDateString()}</td>
            <td>${DOMPurify.sanitize(commitment.role)}</td>
            <td>${DOMPurify.sanitize(commitment.member)}</td>
            <td>
                <button class="btn secondary" data-action="edit-commitment" data-id="${escapeAttribute(commitment.id)}" style="padding: 0.25rem 0.5rem; font-size: 0.85rem;">Edit</button>
                <button class="btn secondary" data-action="delete-commitment" data-id="${escapeAttribute(commitment.id)}" style="padding: 0.25rem 0.5rem; font-size: 0.85rem; margin-left: 0.25rem;">Delete</button>
            </td>
        `;
    });
}

function editCommitment(id) {
    const commitments = JSON.parse(localStorage.getItem('meetingCommitments') || '[]');
    const commitment = commitments.find(c => c.id === id);
    if (commitment) {
        document.getElementById('commitment-date').value = commitment.date;
        document.getElementById('commitment-role').value = commitment.role;
        document.getElementById('commitment-member').value = commitment.member;
        document.getElementById('commitment-reminder').checked = commitment.reminder;
        document.getElementById('commitment-edit-id').value = id;
        document.getElementById('commitment-form-btn').textContent = 'Update';
        document.getElementById('commitment-form-cancel-btn').style.display = 'inline-block';
    }
}

function deleteCommitment(id) {
    if (!confirm('Delete this commitment?')) return;
    let commitments = JSON.parse(localStorage.getItem('meetingCommitments') || '[]');
    commitments = commitments.filter(c => c.id !== id);
    localStorage.setItem('meetingCommitments', JSON.stringify(commitments));
    loadCommitmentTable();
    loadCurrentWeekCommitments();
    showToast('Commitment deleted', 'success');
}

function loadCurrentWeekCommitments() {
    const container = document.getElementById('current-week-commitments');
    const commitments = JSON.parse(localStorage.getItem('meetingCommitments') || '[]');
    const today = new Date();
    const weekStart = new Date(today.setDate(today.getDate() - today.getDay()));
    const weekEnd = new Date(weekStart);
    weekEnd.setDate(weekEnd.getDate() + 7);

    const thisWeek = commitments.filter(c => {
        const commitDate = new Date(c.date);
        return commitDate >= weekStart && commitDate < weekEnd;
    });

    if (thisWeek.length === 0) {
        container.innerHTML = '<p>No commitments this week</p>';
        return;
    }

    let html = '<ul style="list-style: none; padding: 0;">';
    thisWeek.forEach(c => {
        html += `<li style="padding: 0.5rem; border-bottom: 1px solid #7f8c8d;">
            <strong>${c.role}:</strong> ${DOMPurify.sanitize(c.member)} (${new Date(c.date).toLocaleDateString()})
        </li>`;
    });
    html += '</ul>';
    container.innerHTML = html;
}

// SECRETARY FUNCTIONS
function handleAttendanceSubmit() {
    const date = document.getElementById('attendance-date').value;
    const memberSelect = document.getElementById('attendance-members');
    const selectedMembers = Array.from(memberSelect.selectedOptions).map(opt => opt.value);
    const visitors = parseInt(document.getElementById('attendance-visitors').value) || 0;

    if (!date || selectedMembers.length === 0) {
        showToast('Please select date and at least one member', 'error');
        return;
    }

    const attendance = {
        id: Date.now().toString(),
        date,
        members: selectedMembers,
        visitors,
        total: selectedMembers.length + visitors
    };

    let attendanceLog = JSON.parse(localStorage.getItem('attendanceLog') || '[]');
    attendanceLog.push(attendance);
    localStorage.setItem('attendanceLog', JSON.stringify(attendanceLog));

    showToast('Attendance saved successfully', 'success');
    loadAttendanceHistory();
    updateAttendanceStats();
    document.getElementById('attendance-date').value = '';
    document.getElementById('attendance-visitors').value = '0';
    memberSelect.selectedIndex = -1;
}

function loadAttendanceHistory() {
    const log = JSON.parse(localStorage.getItem('attendanceLog') || '[]').reverse();
    const tbody = document.getElementById('attendance-history-body');
    tbody.innerHTML = '';

    log.slice(0, 10).forEach(entry => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${new Date(entry.date).toLocaleDateString()}</td>
            <td>${entry.members.length}</td>
            <td>${entry.visitors}</td>
            <td>${entry.total}</td>
            <td>
                <button class="btn secondary" data-action="delete-attendance" data-id="${escapeAttribute(entry.id)}" style="padding: 0.25rem 0.5rem; font-size: 0.85rem;">Delete</button>
            </td>
        `;
    });
}

function deleteAttendance(id) {
    if (!confirm('Delete this attendance record?')) return;
    let log = JSON.parse(localStorage.getItem('attendanceLog') || '[]');
    log = log.filter(a => a.id !== id);
    localStorage.setItem('attendanceLog', JSON.stringify(log));
    loadAttendanceHistory();
    updateAttendanceStats();
    showToast('Attendance record deleted', 'success');
}

function updateAttendanceStats() {
    const log = JSON.parse(localStorage.getItem('attendanceLog') || '[]');
    if (log.length === 0) return;

    const avgAttendance = Math.round(log.reduce((sum, a) => sum + a.total, 0) / log.length);
    const uniqueMembers = new Set(log.flatMap(a => a.members)).size;

    const thisMonth = new Date().getMonth();
    const monthlyVisitors = log.filter(a => new Date(a.date).getMonth() === thisMonth)
        .reduce((sum, a) => sum + a.visitors, 0);

    document.getElementById('avg-attendance').textContent = avgAttendance;
    document.getElementById('regular-members').textContent = uniqueMembers;
    document.getElementById('monthly-visitors').textContent = monthlyVisitors;
}

// GC DECISION HISTORY FUNCTIONS
function searchGCDecisions() {
    const searchTerm = document.getElementById('gc-search').value.toLowerCase();
    const status = document.getElementById('gc-filter-status').value;
    const year = document.getElementById('gc-filter-year').value;

    let decisions = JSON.parse(localStorage.getItem('gcLog') || '[]');

    if (searchTerm) {
        decisions = decisions.filter(d =>
            d.item.toLowerCase().includes(searchTerm) ||
            d.submittedBy.toLowerCase().includes(searchTerm)
        );
    }

    if (status !== 'all') {
        decisions = decisions.filter(d => d.status === status);
    }

    if (year !== 'all') {
        decisions = decisions.filter(d => new Date(d.date).getFullYear().toString() === year);
    }

    displayGCDecisions(decisions);
}

function displayGCDecisions(decisions) {
    const container = document.getElementById('gc-decisions-list');
    if (decisions.length === 0) {
        container.innerHTML = '<p>No decisions found</p>';
        return;
    }

    let html = '';
    decisions.forEach(d => {
        html += `
            <div class="box mb-2" style="cursor: pointer;" data-action="view-chain" data-id="${escapeAttribute(d.id)}">
                <div><strong>${new Date(d.date).toLocaleDateString()}</strong></div>
                <div>${DOMPurify.sanitize(d.item)}</div>
                <div style="font-size: 0.85rem; color: #95a5a6;">
                    Status: ${d.status} | Submitted by: ${DOMPurify.sanitize(d.submittedBy)}
                </div>
            </div>
        `;
    });
    container.innerHTML = html;
}

function linkGCMotions() {
    const primaryId = document.getElementById('gc-link-primary').value;
    const relatedId = document.getElementById('gc-link-related').value;
    const linkType = document.getElementById('gc-link-type').value;

    if (!primaryId || !relatedId) {
        showToast('Please select both motions', 'error');
        return;
    }

    let links = JSON.parse(localStorage.getItem('gcMotionLinks') || '[]');
    links.push({ primaryId, relatedId, linkType, timestamp: Date.now() });
    localStorage.setItem('gcMotionLinks', JSON.stringify(links));

    showToast('Motions linked successfully', 'success');
}

function viewMotionChain(motionId) {
    const decisions = JSON.parse(localStorage.getItem('gcLog') || '[]');
    const links = JSON.parse(localStorage.getItem('gcMotionLinks') || '[]');

    const motion = decisions.find(d => d.id === motionId);
    if (!motion) return;

    let html = `<h4>Primary Motion</h4>
        <div class="box mb-2">
            <div><strong>${new Date(motion.date).toLocaleDateString()}</strong></div>
            <div>${DOMPurify.sanitize(motion.item)}</div>
            <div>Status: ${motion.status}</div>
        </div>`;

    const relatedLinks = links.filter(l => l.primaryId === motionId || l.relatedId === motionId);
    if (relatedLinks.length > 0) {
        html += '<h4 class="mt-2">Related Motions</h4>';
        relatedLinks.forEach(link => {
            const relatedId = link.primaryId === motionId ? link.relatedId : link.primaryId;
            const related = decisions.find(d => d.id === relatedId);
            if (related) {
                html += `
                    <div class="box mb-2">
                        <div style="font-size: 0.75rem; color: #3498db;">${link.linkType.toUpperCase()}</div>
                        <div><strong>${new Date(related.date).toLocaleDateString()}</strong></div>
                        <div>${DOMPurify.sanitize(related.item)}</div>
                    </div>
                `;
            }
        });
    }

    document.getElementById('motion-chain-display').innerHTML = html;
}

// GC INVENTORY FUNCTIONS
function loadInventoryTemplate() {
    const type = document.getElementById('inventory-type').value;
    const container = document.getElementById('inventory-questions-container');

    if (!type) {
        container.innerHTML = '';
        return;
    }

    const templates = {
        'traditions': [
            'Does our group place principles before personalities?',
            'Is our group self-supporting through our own contributions?',
            'Does our group have any outside affiliations?',
            'Is our group autonomous except in matters affecting other groups?',
            'Do we practice attraction rather than promotion?'
        ],
        'concepts': [
            'Does our group understand the concept of ultimate responsibility?',
            'How does our group practice the concept of delegation of authority?',
            'Are we providing adequate support to our GSR?',
            'Does our group participate in the Conference process?'
        ],
        'group-health': [
            'Are newcomers made to feel welcome?',
            'Is there regular attendance and participation?',
            'Are service positions filled regularly?',
            'Is there healthy rotation of service positions?',
            'Are we meeting our financial obligations?'
        ],
        'annual': [
            'How has our group grown this year?',
            'What challenges has our group faced?',
            'Are we fulfilling our primary purpose?',
            'What can we improve next year?'
        ]
    };

    const questions = templates[type] || [];
    let html = '<div class="box">';
    questions.forEach((q, i) => {
        html += `
            <div class="form-group">
                <label>${i + 1}. ${q}</label>
                <textarea id="inventory-q${i}" rows="2" placeholder="Group response..."></textarea>
            </div>
        `;
    });
    html += '</div>';
    container.innerHTML = html;
}

function exportInventoryResults() {
    const type = document.getElementById('inventory-type').value;
    if (!type) {
        showToast('Please select an inventory type first', 'error');
        return;
    }

    showToast('Inventory results exported', 'success');
}

function submitAnonymousFeedback() {
    const feedback = document.getElementById('anonymous-feedback-text').value.trim();
    if (!feedback) {
        showToast('Please enter feedback', 'error');
        return;
    }

    let feedbackList = JSON.parse(localStorage.getItem('anonymousFeedback') || '[]');
    feedbackList.push({
        id: Date.now().toString(),
        feedback,
        timestamp: new Date().toISOString()
    });
    localStorage.setItem('anonymousFeedback', JSON.stringify(feedbackList));

    document.getElementById('anonymous-feedback-text').value = '';
    loadAnonymousFeedback();
    showToast('Feedback submitted anonymously', 'success');
}

function loadAnonymousFeedback() {
    const feedbackList = JSON.parse(localStorage.getItem('anonymousFeedback') || '[]').reverse();
    const container = document.getElementById('anonymous-feedback-list');

    if (feedbackList.length === 0) {
        container.innerHTML = '<p>No feedback submitted yet</p>';
        return;
    }

    let html = '';
    feedbackList.forEach(f => {
        html += `
            <div class="box mb-2">
                <div style="font-size: 0.75rem; color: #95a5a6;">${new Date(f.timestamp).toLocaleDateString()}</div>
                <div>${DOMPurify.sanitize(f.feedback)}</div>
            </div>
        `;
    });
    container.innerHTML = html;
}

// BY-LAWS FUNCTIONS
function handleByLawSubmit() {
    const title = document.getElementById('bylaw-title').value.trim();
    const version = document.getElementById('bylaw-version').value.trim();
    const content = document.getElementById('bylaw-content').value.trim();
    const notes = document.getElementById('bylaw-amendment-notes').value.trim();
    const date = document.getElementById('bylaw-effective-date').value;

    if (!title || !version || !content || !date) {
        showToast('Please fill all required fields', 'error');
        return;
    }

    let bylaws = JSON.parse(localStorage.getItem('groupByLaws') || '[]');
    const newByLaw = {
        id: Date.now().toString(),
        title,
        version,
        content,
        notes,
        effectiveDate: date,
        timestamp: new Date().toISOString()
    };

    bylaws.push(newByLaw);
    localStorage.setItem('groupByLaws', JSON.stringify(bylaws));

    showToast('Document saved successfully', 'success');
    loadByLawsHistory();
    loadCurrentByLaws();
    resetByLawForm();
}

function cancelByLawEdit() {
    resetByLawForm();
}

function resetByLawForm() {
    document.getElementById('bylaw-title').value = '';
    document.getElementById('bylaw-version').value = '';
    document.getElementById('bylaw-content').value = '';
    document.getElementById('bylaw-amendment-notes').value = '';
    document.getElementById('bylaw-effective-date').value = '';
    document.getElementById('bylaw-edit-id').value = '';
}

function loadByLawsHistory() {
    const bylaws = JSON.parse(localStorage.getItem('groupByLaws') || '[]').reverse();
    const tbody = document.getElementById('bylaws-history-body');
    tbody.innerHTML = '';

    bylaws.forEach(bylaw => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${DOMPurify.sanitize(bylaw.title)}</td>
            <td>${DOMPurify.sanitize(bylaw.version)}</td>
            <td>${new Date(bylaw.effectiveDate).toLocaleDateString()}</td>
            <td>
                <button class="btn secondary" data-action="view-bylaw" data-id="${escapeAttribute(bylaw.id)}" style="padding: 0.25rem 0.5rem; font-size: 0.85rem;">View</button>
            </td>
        `;
    });
}

function loadCurrentByLaws() {
    const bylaws = JSON.parse(localStorage.getItem('groupByLaws') || '[]');
    const container = document.getElementById('bylaws-current-list');

    // Get latest version of each document
    const latest = {};
    bylaws.forEach(b => {
        if (!latest[b.title] || new Date(b.effectiveDate) > new Date(latest[b.title].effectiveDate)) {
            latest[b.title] = b;
        }
    });

    if (Object.keys(latest).length === 0) {
        container.innerHTML = '<p>No documents available</p>';
        return;
    }

    let html = '';
    Object.values(latest).forEach(b => {
        html += `
            <div class="box mb-2">
                <h4>${DOMPurify.sanitize(b.title)}</h4>
                <div style="font-size: 0.85rem; color: #95a5a6;">Version ${DOMPurify.sanitize(b.version)} - Effective ${new Date(b.effectiveDate).toLocaleDateString()}</div>
                <button class="btn secondary mt-2" data-action="view-bylaw" data-id="${escapeAttribute(b.id)}" style="padding: 0.25rem 0.5rem; font-size: 0.85rem;">View Full Document</button>
            </div>
        `;
    });
    container.innerHTML = html;
}

function viewByLaw(id) {
    const bylaws = JSON.parse(localStorage.getItem('groupByLaws') || '[]');
    const bylaw = bylaws.find(b => b.id === id);
    if (bylaw) {
        alert(`${bylaw.title}\nVersion: ${bylaw.version}\n\n${bylaw.content}`);
    }
}

function generateByLawPDF() {
    const selectId = document.getElementById('pdf-document-select').value;

    if (!selectId) {
        showToast('Please select a document to export', 'error');
        return;
    }

    const bylaws = JSON.parse(localStorage.getItem('groupByLaws') || '[]');
    const bylaw = bylaws.find(b => b.id === selectId);

    if (!bylaw) {
        showToast('Document not found', 'error');
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    let yPos = 20;

    // Title
    doc.setFontSize(18);
    doc.setFont(undefined, 'bold');
    doc.text(bylaw.title, doc.internal.pageSize.width / 2, yPos, { align: 'center' });
    yPos += 10;

    // Version and Date
    doc.setFontSize(12);
    doc.setFont(undefined, 'normal');
    doc.text(`Version ${bylaw.version}`, doc.internal.pageSize.width / 2, yPos, { align: 'center' });
    yPos += 6;
    doc.setFontSize(10);
    doc.text(`Effective Date: ${new Date(bylaw.effectiveDate).toLocaleDateString()}`, doc.internal.pageSize.width / 2, yPos, { align: 'center' });
    yPos += 15;

    // Content
    doc.setFontSize(11);
    doc.setFont(undefined, 'normal');

    // Split content into paragraphs and lines
    const paragraphs = bylaw.content.split('\n\n');

    paragraphs.forEach(paragraph => {
        if (yPos > 270) {
            doc.addPage();
            yPos = 20;
        }

        const lines = doc.splitTextToSize(paragraph.trim(), 180);
        doc.text(lines, 14, yPos);
        yPos += lines.length * 5 + 5; // Add spacing between paragraphs
    });

    // Amendment Notes (if any)
    if (bylaw.notes && bylaw.notes.trim()) {
        if (yPos > 240) {
            doc.addPage();
            yPos = 20;
        }

        yPos += 10;
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text('Amendment Notes:', 14, yPos);
        yPos += 7;

        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        const notesLines = doc.splitTextToSize(bylaw.notes, 180);
        doc.text(notesLines, 14, yPos);
        yPos += notesLines.length * 5;
    }

    // Footer with page numbers
    const pageCount = doc.internal.getNumberOfPages();
    doc.setFontSize(9);
    doc.setTextColor(100, 100, 100);
    for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, doc.internal.pageSize.height - 10);
        doc.text(`Page ${i} of ${pageCount}`, doc.internal.pageSize.width - 30, doc.internal.pageSize.height - 10);
    }

    const filename = `${bylaw.title.replace(/[^a-z0-9]/gi, '_')}_v${bylaw.version}.pdf`;
    doc.save(filename);

    showToast('Bylaws document exported to PDF successfully!', 'success');
}

// SPONSORSHIP FUNCTIONS
function handleSponsorshipSubmit() {
    const sponsor = document.getElementById('sponsor-name').value;
    const sponsee = document.getElementById('sponsee-name').value;
    const type = document.getElementById('sponsorship-type').value;
    const startDate = document.getElementById('sponsorship-start-date').value;
    const currentStep = document.getElementById('current-step').value;

    if (!sponsor || !sponsee || !startDate) {
        showToast('Please fill all required fields', 'error');
        return;
    }

    let sponsorships = JSON.parse(localStorage.getItem('sponsorships') || '[]');
    const newSponsorship = {
        id: Date.now().toString(),
        sponsor,
        sponsee,
        type,
        startDate,
        currentStep: currentStep || null
    };

    sponsorships.push(newSponsorship);
    localStorage.setItem('sponsorships', JSON.stringify(sponsorships));

    showToast('Sponsorship relationship added', 'success');
    loadSponsorshipTable();
    loadSponsorshipTree();
    resetSponsorshipForm();
}

function cancelSponsorshipEdit() {
    resetSponsorshipForm();
}

function resetSponsorshipForm() {
    document.getElementById('sponsor-name').selectedIndex = 0;
    document.getElementById('sponsee-name').selectedIndex = 0;
    document.getElementById('sponsorship-type').selectedIndex = 0;
    document.getElementById('sponsorship-start-date').value = '';
    document.getElementById('current-step').selectedIndex = 0;
    document.getElementById('sponsorship-edit-id').value = '';
}

function loadSponsorshipTable() {
    const sponsorships = JSON.parse(localStorage.getItem('sponsorships') || '[]');
    const tbody = document.getElementById('sponsorship-body');
    tbody.innerHTML = '';

    sponsorships.forEach(s => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${DOMPurify.sanitize(s.sponsor)}</td>
            <td>${DOMPurify.sanitize(s.sponsee)}</td>
            <td>${s.type}</td>
            <td>${new Date(s.startDate).toLocaleDateString()}</td>
            <td>${s.currentStep ? 'Step ' + s.currentStep : 'N/A'}</td>
            <td>
                <button class="btn secondary" data-action="delete-sponsorship" data-id="${escapeAttribute(s.id)}" style="padding: 0.25rem 0.5rem; font-size: 0.85rem;">Delete</button>
            </td>
        `;
    });
}

function deleteSponsorship(id) {
    if (!confirm('Delete this sponsorship relationship?')) return;
    let sponsorships = JSON.parse(localStorage.getItem('sponsorships') || '[]');
    sponsorships = sponsorships.filter(s => s.id !== id);
    localStorage.setItem('sponsorships', JSON.stringify(sponsorships));
    loadSponsorshipTable();
    loadSponsorshipTree();
    showToast('Sponsorship relationship deleted', 'success');
}

function loadSponsorshipTree() {
    const container = document.getElementById('sponsorship-tree');
    container.innerHTML = '<p>Sponsorship tree visualization - Feature coming soon</p>';
}

// DISTRICT/AREA FUNCTIONS
function handleGSRReportSubmit() {
    const date = document.getElementById('gsr-report-date').value;
    const meetingType = document.getElementById('gsr-meeting-type').value;
    const content = document.getElementById('gsr-report-content').value.trim();
    const actionItems = document.getElementById('gsr-action-items').value.trim();

    if (!date || !content) {
        showToast('Please fill all required fields', 'error');
        return;
    }

    let reports = JSON.parse(localStorage.getItem('gsrReports') || '[]');
    reports.push({
        id: Date.now().toString(),
        date,
        meetingType,
        content,
        actionItems,
        timestamp: new Date().toISOString()
    });

    localStorage.setItem('gsrReports', JSON.stringify(reports));
    showToast('GSR report saved successfully', 'success');
    loadGSRReports();
    document.getElementById('gsr-report-date').value = '';
    document.getElementById('gsr-report-content').value = '';
    document.getElementById('gsr-action-items').value = '';
}

function cancelGSRReportEdit() {
    document.getElementById('gsr-report-date').value = '';
    document.getElementById('gsr-report-content').value = '';
    document.getElementById('gsr-action-items').value = '';
}

function loadGSRReports() {
    const reports = JSON.parse(localStorage.getItem('gsrReports') || '[]').reverse();
    const container = document.getElementById('gsr-reports-list');

    if (reports.length === 0) {
        container.innerHTML = '<p>No GSR reports yet</p>';
        return;
    }

    let html = '';
    reports.slice(0, 5).forEach(r => {
        html += `
            <div class="box mb-2">
                <div><strong>${new Date(r.date).toLocaleDateString()}</strong> - ${r.meetingType}</div>
                <div style="margin-top: 0.5rem;">${DOMPurify.sanitize(r.content)}</div>
                ${r.actionItems ? `<div style="margin-top: 0.5rem; color: #f39c12;"><strong>Action Items:</strong> ${DOMPurify.sanitize(r.actionItems)}</div>` : ''}
            </div>
        `;
    });
    container.innerHTML = html;
}

function addDistrictMeeting() {
    const date = document.getElementById('district-schedule-date').value;
    const time = document.getElementById('district-schedule-time').value;
    const location = document.getElementById('district-schedule-location').value;

    if (!date || !time || !location) {
        showToast('Please fill all fields', 'error');
        return;
    }

    let meetings = JSON.parse(localStorage.getItem('districtMeetings') || '[]');
    meetings.push({
        id: Date.now().toString(),
        date,
        time,
        location
    });

    localStorage.setItem('districtMeetings', JSON.stringify(meetings));
    showToast('Meeting added to schedule', 'success');
    loadDistrictMeetings();
    document.getElementById('district-schedule-date').value = '';
    document.getElementById('district-schedule-time').value = '';
    document.getElementById('district-schedule-location').value = '';
}

function loadDistrictMeetings() {
    const meetings = JSON.parse(localStorage.getItem('districtMeetings') || '[]')
        .filter(m => new Date(m.date) >= new Date())
        .sort((a, b) => new Date(a.date) - new Date(b.date));

    const container = document.getElementById('district-meetings-list');

    if (meetings.length === 0) {
        container.innerHTML = '<p>No upcoming meetings</p>';
        return;
    }

    let html = '<ul style="list-style: none; padding: 0;">';
    meetings.forEach(m => {
        html += `
            <li style="padding: 0.5rem; border-bottom: 1px solid #7f8c8d;">
                <strong>${new Date(m.date).toLocaleDateString()}</strong> at ${m.time}<br>
                Location: ${DOMPurify.sanitize(m.location)}
            </li>
        `;
    });
    html += '</ul>';
    container.innerHTML = html;
}

function addDCMCommunication() {
    const date = document.getElementById('dcm-comm-date').value;
    const content = document.getElementById('dcm-comm-content').value.trim();

    if (!date || !content) {
        showToast('Please fill all fields', 'error');
        return;
    }

    let communications = JSON.parse(localStorage.getItem('dcmCommunications') || '[]');
    communications.push({
        id: Date.now().toString(),
        date,
        content
    });

    localStorage.setItem('dcmCommunications', JSON.stringify(communications));
    showToast('Communication logged', 'success');
    loadDCMCommunications();
    document.getElementById('dcm-comm-date').value = '';
    document.getElementById('dcm-comm-content').value = '';
}

function loadDCMCommunications() {
    const communications = JSON.parse(localStorage.getItem('dcmCommunications') || '[]').reverse();
    const container = document.getElementById('dcm-comm-history');

    if (communications.length === 0) {
        container.innerHTML = '<p>No communications logged</p>';
        return;
    }

    let html = '';
    communications.slice(0, 5).forEach(c => {
        html += `
            <div class="box mb-2">
                <div><strong>${new Date(c.date).toLocaleDateString()}</strong></div>
                <div>${DOMPurify.sanitize(c.content)}</div>
            </div>
        `;
    });
    container.innerHTML = html;
}

// PRUDENT RESERVE FUNCTIONS
function calculateReserveTarget() {
    const monthlyExpenses = parseFloat(document.getElementById('monthly-expenses').value) || 0;
    const months = parseInt(document.getElementById('reserve-months').value) || 3;
    const target = monthlyExpenses * months;
    document.getElementById('reserve-target').value = target.toFixed(2);
    showToast(`Reserve target calculated: $${target.toFixed(2)}`, 'success');
}

function saveReserveSettings() {
    const target = parseFloat(document.getElementById('reserve-target').value) || 0;
    const monthlyExpenses = parseFloat(document.getElementById('monthly-expenses').value) || 0;
    const months = parseInt(document.getElementById('reserve-months').value) || 3;

    localStorage.setItem('reserveTarget', target);
    localStorage.setItem('monthlyExpenses', monthlyExpenses);
    localStorage.setItem('reserveMonths', months);
    localStorage.setItem('reserveSettings', JSON.stringify({ target, monthlyExpenses, months }));
    showToast('Reserve settings saved', 'success');
    updateReserveStatus();
    updatePrudentReserveProgressBar(); // Quick Win #2
}

function updateReserveStatus() {
    const settings = JSON.parse(localStorage.getItem('reserveSettings') || '{}');
    document.getElementById('display-reserve-target').textContent = (settings.target || 0).toFixed(2);
    updatePrudentReserveProgressBar(); // Quick Win #2
    // Additional logic to calculate current balances from financial data would go here
}

function load7thTraditionPeriod(period) {
    showToast(`Loading ${period} view`, 'success');
}

function saveContributionGoal() {
    const goal = parseFloat(document.getElementById('contribution-goal').value) || 0;
    localStorage.setItem('contributionGoal', goal);
    showToast('Contribution goal saved', 'success');
}

// CHIP INVENTORY FUNCTIONS
function updateChipInventory() {
    const type = document.getElementById('chip-type').value;
    const quantity = parseInt(document.getElementById('chip-quantity').value) || 0;
    const threshold = parseInt(document.getElementById('chip-low-threshold').value) || 5;

    let inventory = JSON.parse(localStorage.getItem('chipInventory') || '{}');
    inventory[type] = { quantity, threshold };
    localStorage.setItem('chipInventory', JSON.stringify(inventory));

    showToast('Chip inventory updated', 'success');
    loadChipInventory();
    checkChipAlerts();
}

function loadChipInventory() {
    const inventory = JSON.parse(localStorage.getItem('chipInventory') || '{}');
    const tbody = document.getElementById('chip-inventory-body');
    tbody.innerHTML = '';

    const chipTypes = ['24-hour', '30-day', '60-day', '90-day', '6-month', '9-month', '1-year', '18-month', 'multi-year'];

    chipTypes.forEach(type => {
        const data = inventory[type] || { quantity: 0, threshold: 5 };
        const status = data.quantity <= data.threshold ? 'LOW STOCK' : 'OK';
        const statusColor = data.quantity <= data.threshold ? '#e74c3c' : '#2ecc71';

        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${type}</td>
            <td>${data.quantity}</td>
            <td style="color: ${statusColor};">${status}</td>
            <td>${data.threshold}</td>
        `;
    });
}

function checkChipAlerts() {
    const inventory = JSON.parse(localStorage.getItem('chipInventory') || '{}');
    const container = document.getElementById('chip-alerts');

    const lowStock = Object.entries(inventory).filter(([type, data]) => data.quantity <= data.threshold);

    if (lowStock.length === 0) {
        container.innerHTML = '<p style="color: #2ecc71;">All chip levels are good</p>';
        return;
    }

    let html = '<ul style="list-style: none; padding: 0; color: #e74c3c;">';
    lowStock.forEach(([type, data]) => {
        html += `<li style="padding: 0.25rem;"><i class="fas fa-exclamation-triangle"></i> ${type}: ${data.quantity} remaining</li>`;
    });
    html += '</ul>';
    container.innerHTML = html;
}

function logChipDistribution() {
    const type = document.getElementById('dist-chip-type').value;
    const recipient = document.getElementById('dist-recipient').value.trim();
    const date = document.getElementById('dist-date').value;

    if (!date) {
        showToast('Please select a date', 'error');
        return;
    }

    let distributions = JSON.parse(localStorage.getItem('chipDistributions') || '[]');
    distributions.push({
        id: Date.now().toString(),
        type,
        recipient,
        date
    });

    localStorage.setItem('chipDistributions', JSON.stringify(distributions));

    // Decrement inventory
    let inventory = JSON.parse(localStorage.getItem('chipInventory') || '{}');
    if (inventory[type] && inventory[type].quantity > 0) {
        inventory[type].quantity--;
        localStorage.setItem('chipInventory', JSON.stringify(inventory));
        loadChipInventory();
        checkChipAlerts();
    }

    showToast('Chip distribution logged', 'success');
    loadChipDistributions();
    document.getElementById('dist-recipient').value = '';
    document.getElementById('dist-date').value = '';
}

function loadChipDistributions() {
    const distributions = JSON.parse(localStorage.getItem('chipDistributions') || '[]').reverse();
    const tbody = document.getElementById('chip-distribution-body');
    tbody.innerHTML = '';

    distributions.slice(0, 10).forEach(d => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${new Date(d.date).toLocaleDateString()}</td>
            <td>${d.type}</td>
            <td>${DOMPurify.sanitize(d.recipient) || 'Anonymous'}</td>
        `;
    });
}

// LIVE GC FUNCTIONS
function addLiveGCItem() {
    const item = document.getElementById('live-gc-new-item').value.trim();
    if (!item) {
        showToast('Please enter an item', 'error');
        return;
    }

    let queue = JSON.parse(localStorage.getItem('liveGCQueue') || '[]');
    queue.push({
        id: Date.now().toString(),
        item,
        status: 'pending',
        timestamp: new Date().toISOString()
    });

    localStorage.setItem('liveGCQueue', JSON.stringify(queue));
    showToast('Item added to queue', 'success');
    loadLiveGCQueue();
    document.getElementById('live-gc-new-item').value = '';
}

function loadLiveGCQueue() {
    const queue = JSON.parse(localStorage.getItem('liveGCQueue') || '[]');
    const tbody = document.getElementById('live-gc-queue-body');
    tbody.innerHTML = '';

    queue.forEach(item => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${DOMPurify.sanitize(item.item)}</td>
            <td>${item.status}</td>
            <td>
                <button class="btn secondary" data-action="update-gc-status" data-id="${escapeAttribute(item.id)}" data-status="discussed" style="padding: 0.25rem 0.5rem; font-size: 0.85rem;">Mark Discussed</button>
                <button class="btn secondary" data-action="remove-gc-item" data-id="${escapeAttribute(item.id)}" style="padding: 0.25rem 0.5rem; font-size: 0.85rem; margin-left: 0.25rem;">Remove</button>
            </td>
        `;
    });
}

function updateGCItemStatus(id, status) {
    let queue = JSON.parse(localStorage.getItem('liveGCQueue') || '[]');
    const item = queue.find(i => i.id === id);
    if (item) {
        item.status = status;
        localStorage.setItem('liveGCQueue', JSON.stringify(queue));
        loadLiveGCQueue();
        showToast('Status updated', 'success');
    }
}

// ===== EMERGENCY GC PROTOCOL FUNCTIONS =====

function initiateEmergencyGC() {
    // Show confirmation dialog
    const confirmed = confirm('⚠️ EMERGENCY GC PROTOCOL ⚠️\n\nThis should only be used for crisis situations requiring immediate group conscience decision.\n\nExamples: Venue loss, safety concerns, financial crisis, legal issues.\n\nProceed with Emergency GC Protocol?');

    if (!confirmed) return;

    // Navigate to emergency GC section
    document.querySelectorAll('section').forEach(sec => sec.classList.remove('active'));
    document.getElementById('emergency-gc-section').classList.add('active');
    document.getElementById('emergency-gc-section').style.display = 'block';

    // Update navigation
    document.querySelectorAll('nav li').forEach(li => li.classList.remove('active'));

    // Populate facilitator dropdown
    const facilitatorSelect = document.getElementById('emergency-facilitator');
    facilitatorSelect.innerHTML = '<option value="">Select facilitator...</option>';
    const members = storage.getMembers();
    members.forEach(m => {
        const option = document.createElement('option');
        option.value = m.name;
        option.textContent = m.name;
        facilitatorSelect.appendChild(option);
    });

    // Set current date/time
    const now = new Date();
    const dateTimeLocal = now.toISOString().slice(0, 16);
    document.getElementById('emergency-date').value = dateTimeLocal;

    // Load emergency history
    loadEmergencyGCHistory();

    // Send urgent notification
    createSmartNotification(
        'Emergency GC Protocol Initiated',
        'An emergency group conscience protocol has been started. Check the Emergency GC section for details.',
        'urgent',
        'emergency-gc-section'
    );

    showToast('Emergency GC Protocol initiated', 'warning');
}

const emergencyProtocols = {
    'venue-loss': {
        title: 'Venue Loss / Location Crisis',
        checklist: [
            'Confirm venue is no longer available',
            'Document reason for venue loss',
            'Identify alternate meeting locations',
            'Check availability and cost of alternatives',
            'Confirm meeting schedule compatibility',
            'Notify all members of situation',
            'Arrange transportation/accessibility for new location',
            'Update meeting schedules (AA.org, local directories)',
            'Notify intergroup/central office of change'
        ]
    },
    'safety-concern': {
        title: 'Safety/Security Concern',
        checklist: [
            'Document the safety concern in detail',
            'Assess immediate threat level',
            'Contact appropriate authorities if needed',
            'Ensure member safety is prioritized',
            'Determine if meeting can continue safely',
            'Implement temporary safety measures',
            'Notify members of the situation',
            'Consult with area/district for guidance',
            'Document all actions taken'
        ]
    },
    'financial-crisis': {
        title: 'Financial Crisis',
        checklist: [
            'Document the financial emergency',
            'Review current balance and obligations',
            'Identify immediate financial needs',
            'Determine shortfall amount',
            'Review prudent reserve status',
            'Consider immediate cost reductions',
            'Notify treasurer and trusted servants',
            'Prepare emergency budget proposal',
            'Plan for special 7th tradition appeal if needed'
        ]
    },
    'member-conduct': {
        title: 'Serious Member Conduct Issue',
        checklist: [
            'Document the conduct issue objectively',
            'Review AA Tradition 1 (group welfare)',
            'Consult AA guidelines on disruptive behavior',
            'Consider safety of all members',
            'Determine if immediate action required',
            'Review group\'s existing conduct policies',
            'Consult with experienced members/sponsors',
            'Consider temporary measures if needed',
            'Plan for fair group conscience process'
        ]
    },
    'legal-issue': {
        title: 'Legal/Liability Issue',
        checklist: [
            'Document the legal issue in detail',
            'Determine if immediate legal counsel needed',
            'Contact AA General Service Office if appropriate',
            'Notify group insurance provider if applicable',
            'Preserve all relevant documentation',
            'Do not admit fault or make statements',
            'Consult with district/area for guidance',
            'Consider group\'s liability coverage',
            'Follow AA\'s suggested legal protocols'
        ]
    },
    'service-disruption': {
        title: 'Critical Service Disruption',
        checklist: [
            'Identify which critical service is disrupted',
            'Assess impact on group function',
            'Determine cause of disruption',
            'Identify immediate alternatives',
            'Notify affected members',
            'Implement temporary solutions',
            'Contact service providers if applicable',
            'Document disruption timeline',
            'Plan for service restoration'
        ]
    },
    'other': {
        title: 'Other Emergency',
        checklist: [
            'Clearly define the emergency situation',
            'Assess urgency and impact',
            'Determine why regular GC process won\'t work',
            'Identify immediate actions needed',
            'Consider member safety first',
            'Review relevant AA traditions and concepts',
            'Consult with experienced members if time allows',
            'Document all circumstances',
            'Plan for regular GC review of decision'
        ]
    }
};

function loadEmergencyProtocol(type) {
    if (!type) {
        document.getElementById('emergency-protocol-container').style.display = 'none';
        return;
    }

    const protocol = emergencyProtocols[type];
    if (!protocol) return;

    document.getElementById('emergency-protocol-container').style.display = 'block';

    const checklistDiv = document.getElementById('emergency-checklist');
    checklistDiv.innerHTML = `
        <h4 style="color: #f39c12; margin-bottom: 1rem;">${protocol.title}</h4>
        <div style="background: #2c3e50; padding: 1rem; border-radius: 4px;">
            ${protocol.checklist.map((item, idx) => `
                <div style="display: flex; align-items: start; gap: 0.75rem; padding: 0.5rem; margin-bottom: 0.5rem; background: #34495e; border-radius: 4px;">
                    <input type="checkbox" id="checklist-${idx}" style="margin-top: 0.25rem; width: 18px; height: 18px; cursor: pointer;">
                    <label for="checklist-${idx}" style="flex: 1; cursor: pointer; user-select: none;">${escapeHtml(item)}</label>
                </div>
            `).join('')}
        </div>
    `;

    // Scroll to protocol
    document.getElementById('emergency-protocol-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function submitEmergencyGC() {
    // Validate required fields
    const facilitator = document.getElementById('emergency-facilitator').value;
    const date = document.getElementById('emergency-date').value;
    const situation = document.getElementById('emergency-situation').value.trim();
    const decision = document.getElementById('emergency-decision').value.trim();
    const rationale = document.getElementById('emergency-rationale').value.trim();
    const type = document.getElementById('emergency-type').value;
    const notificationMethod = document.getElementById('emergency-notification-method').value;

    if (!facilitator || !date || !situation || !decision || !rationale || !type) {
        showToast('Please fill in all required fields (*)', 'error');
        return;
    }

    // Get vote results
    const votesFor = parseInt(document.getElementById('emergency-votes-for').value) || 0;
    const votesAgainst = parseInt(document.getElementById('emergency-votes-against').value) || 0;
    const votesAbstain = parseInt(document.getElementById('emergency-votes-abstain').value) || 0;
    const totalVotes = votesFor + votesAgainst;

    if (totalVotes === 0) {
        if (!confirm('No votes recorded. Continue anyway?')) return;
    }

    // Determine outcome
    let outcome = 'unknown';
    if (totalVotes > 0) {
        const percentFor = (votesFor / totalVotes) * 100;
        outcome = percentFor >= 66.7 ? 'passed' : 'failed';
    }

    const membersReached = parseInt(document.getElementById('emergency-members-reached').value) || 0;
    const quorumMet = document.getElementById('emergency-quorum-met').value;
    const followUp = document.getElementById('emergency-follow-up').value.trim();

    // Create emergency GC record
    const emergencyGC = {
        id: genId(),
        type: 'emergency',
        emergencyType: type,
        facilitator,
        date,
        situation,
        decision,
        rationale,
        notificationMethod,
        membersReached,
        quorumMet,
        votesFor,
        votesAgainst,
        votesAbstain,
        outcome,
        followUp,
        requiresRatification: true,
        ratified: false,
        submittedDate: new Date().toISOString()
    };

    // Save to special emergency GC storage
    let emergencyGCs = JSON.parse(localStorage.getItem('emergencyGCs') || '[]');
    emergencyGCs.unshift(emergencyGC);
    localStorage.setItem('emergencyGCs', JSON.stringify(emergencyGCs));

    // Also add to regular GC log with emergency flag
    const gcLog = storage.getGroupConscienceLog();
    gcLog.unshift({
        id: emergencyGC.id,
        date: emergencyGC.date,
        item: `[EMERGENCY] ${emergencyGC.decision}`,
        outcome: emergencyGC.outcome,
        votesFor,
        votesAgainst,
        votesAbstain,
        discussionNotes: `EMERGENCY GC PROTOCOL - ${protocol.title}\n\nSituation: ${situation}\n\nRationale: ${rationale}\n\nNotification: ${notificationMethod}\nMembers Reached: ${membersReached}\nQuorum: ${quorumMet}\n\nFollow-up: ${followUp || 'None specified'}`,
        submittedBy: facilitator,
        isEmergency: true,
        emergencyType: type
    });
    storage.saveGroupConscienceLog(gcLog);

    // Add audit log
    addAuditLog('CREATE', 'emergency-gc', emergencyGC.id, facilitator, null,
        `Emergency GC: ${type} - ${decision.substring(0, 50)}`, rationale);

    // Send notifications to all members
    createSmartNotification(
        `Emergency GC Decision: ${outcome.toUpperCase()}`,
        `Emergency decision regarding ${type.replace('-', ' ')}. Decision: ${decision.substring(0, 100)}... Requires ratification at next regular GC.`,
        'urgent',
        'emergency-gc-section'
    );

    // Create automatic action item for ratification
    const actions = storage.getGCActionItems();
    const nextGCDate = new Date();
    nextGCDate.setDate(nextGCDate.getDate() + 30); // 30 days from now

    actions.push({
        id: genId(),
        description: `Ratify Emergency GC Decision: ${decision.substring(0, 60)}`,
        assignee: facilitator,
        dueDate: nextGCDate.toISOString().split('T')[0],
        priority: 'high',
        relatedGCId: emergencyGC.id,
        dependencies: [],
        status: 'pending',
        progress: 0,
        createdDate: new Date().toISOString().split('T')[0],
        completedDate: null,
        updates: [],
        reminders: {
            sent7Days: false,
            sent3Days: false,
            sent1Day: false,
            sentOverdue: false
        }
    });
    storage.saveGCActionItems(actions);

    showToast('Emergency GC logged successfully. Auto-created ratification action item.', 'success');

    // Clear form
    cancelEmergencyGC();

    // Reload history
    loadEmergencyGCHistory();
}

function cancelEmergencyGC() {
    // Clear form
    document.getElementById('emergency-type').value = '';
    document.getElementById('emergency-facilitator').value = '';
    document.getElementById('emergency-date').value = '';
    document.getElementById('emergency-situation').value = '';
    document.getElementById('emergency-decision').value = '';
    document.getElementById('emergency-rationale').value = '';
    document.getElementById('emergency-notification-method').value = 'phone-tree';
    document.getElementById('emergency-members-reached').value = '';
    document.getElementById('emergency-quorum-met').value = 'yes';
    document.getElementById('emergency-votes-for').value = '0';
    document.getElementById('emergency-votes-against').value = '0';
    document.getElementById('emergency-votes-abstain').value = '0';
    document.getElementById('emergency-follow-up').value = '';
    document.getElementById('emergency-vote-result').textContent = 'Enter votes to see result';

    // Hide protocol container
    document.getElementById('emergency-protocol-container').style.display = 'none';

    // Optionally go back to home
    goToSection('home-section');
}

function loadEmergencyGCHistory() {
    const emergencyGCs = JSON.parse(localStorage.getItem('emergencyGCs') || '[]');
    const container = document.getElementById('emergency-gc-history');

    if (emergencyGCs.length === 0) {
        container.innerHTML = '<p style="text-align: center; padding: 2rem; opacity: 0.7;">No emergency GCs recorded</p>';
        return;
    }

    container.innerHTML = emergencyGCs.slice(0, 10).map(egc => {
        const outcomeColor = egc.outcome === 'passed' ? '#2ecc71' : egc.outcome === 'failed' ? '#e74c3c' : '#f39c12';
        const protocol = emergencyProtocols[egc.emergencyType];

        return `
            <div style="background: #2c3e50; padding: 1rem; border-radius: 4px; margin-bottom: 0.75rem; border-left: 4px solid ${outcomeColor};">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <div style="font-weight: bold; color: #e74c3c; margin-bottom: 0.5rem;">
                            <i class="fas fa-exclamation-triangle"></i> ${escapeHtml(protocol ? protocol.title : egc.emergencyType)}
                        </div>
                        <div style="font-size: 0.95rem; margin-bottom: 0.5rem;">${escapeHtml(egc.decision)}</div>
                        <div style="font-size: 0.85rem; opacity: 0.8;">
                            <div><strong>Date:</strong> ${new Date(egc.date).toLocaleString()}</div>
                            <div><strong>Facilitator:</strong> ${escapeHtml(egc.facilitator)}</div>
                            <div><strong>Votes:</strong> For=${egc.votesFor}, Against=${egc.votesAgainst}, Abstain=${egc.votesAbstain}</div>
                            <div><strong>Outcome:</strong> <span style="color: ${outcomeColor}; font-weight: bold;">${egc.outcome.toUpperCase()}</span></div>
                            ${egc.requiresRatification && !egc.ratified ? '<div style="color: #f39c12; margin-top: 0.5rem;"><i class="fas fa-hourglass-half"></i> Awaiting ratification at next regular GC</div>' : ''}
                            ${egc.ratified ? '<div style="color: #2ecc71; margin-top: 0.5rem;"><i class="fas fa-check-circle"></i> Ratified</div>' : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// Add event listener for emergency vote calculation
document.addEventListener('DOMContentLoaded', function() {
    const voteInputs = ['emergency-votes-for', 'emergency-votes-against', 'emergency-votes-abstain'];
    voteInputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
            input.addEventListener('input', calculateEmergencyVoteResult);
        }
    });
});

function calculateEmergencyVoteResult() {
    const votesFor = parseInt(document.getElementById('emergency-votes-for').value) || 0;
    const votesAgainst = parseInt(document.getElementById('emergency-votes-against').value) || 0;
    const totalVotes = votesFor + votesAgainst;

    const resultDiv = document.getElementById('emergency-vote-result');

    if (totalVotes === 0) {
        resultDiv.textContent = 'Enter votes to see result';
        resultDiv.style.background = '#34495e';
        resultDiv.style.color = '#ecf0f1';
        return;
    }

    const percentFor = (votesFor / totalVotes) * 100;
    const passed = percentFor >= 66.7; // Substantial unanimity

    resultDiv.textContent = passed ? '✓ MOTION PASSED' : '✗ MOTION FAILED';
    resultDiv.style.background = passed ? '#2ecc71' : '#e74c3c';
    resultDiv.style.color = 'white';
    resultDiv.innerHTML = `
        ${passed ? '✓ MOTION PASSED' : '✗ MOTION FAILED'}<br>
        <span style="font-size: 0.9rem;">${percentFor.toFixed(1)}% in favor (${votesFor}/${totalVotes})</span>
    `;
}

function removeGCItem(id) {
    let queue = JSON.parse(localStorage.getItem('liveGCQueue') || '[]');
    queue = queue.filter(i => i.id !== id);
    localStorage.setItem('liveGCQueue', JSON.stringify(queue));
    loadLiveGCQueue();
    showToast('Item removed', 'success');
}

// Initialize new sections on load
function initNewSections() {
    // Populate member dropdowns
    const members = JSON.parse(localStorage.getItem('members') || '[]');
    const memberSelects = [
        'commitment-member',
        'sponsor-name',
        'sponsee-name',
        'attendance-members'
    ];

    memberSelects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select) {
            select.innerHTML = '<option value="">-- Select Member --</option>';
            members.forEach(m => {
                const option = document.createElement('option');
                option.value = m.name;
                option.textContent = m.name;
                select.appendChild(option);
            });
        }
    });

    // Initialize all tables and displays
    if (document.getElementById('format-rotation-section')) {
        loadFormatRotationTable();
        loadUpcomingFormats();
        updateCurrentWeekFormat();
    }

    if (document.getElementById('commitment-board-section')) {
        loadCommitmentTable();
        loadCurrentWeekCommitments();
    }

    if (document.getElementById('secretary-section')) {
        loadAttendanceHistory();
        updateAttendanceStats();
    }

    if (document.getElementById('gc-decisions-section')) {
        const gcLog = JSON.parse(localStorage.getItem('gcLog') || '[]');
        displayGCDecisions(gcLog);

        // Populate year filter
        const years = [...new Set(gcLog.map(d => new Date(d.date).getFullYear()))];
        const yearSelect = document.getElementById('gc-filter-year');
        if (yearSelect) {
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            });
        }

        // Populate motion link dropdowns
        const linkSelects = ['gc-link-primary', 'gc-link-related'];
        linkSelects.forEach(selectId => {
            const select = document.getElementById(selectId);
            if (select) {
                select.innerHTML = '<option value="">-- Select Motion --</option>';
                gcLog.forEach(d => {
                    const option = document.createElement('option');
                    option.value = d.id;
                    option.textContent = `${new Date(d.date).toLocaleDateString()} - ${d.item.substring(0, 50)}...`;
                    select.appendChild(option);
                });
            }
        });
    }

    if (document.getElementById('gc-inventory-section')) {
        loadAnonymousFeedback();
    }

    if (document.getElementById('gc-bylaws-section')) {
        loadByLawsHistory();
        loadCurrentByLaws();
    }

    if (document.getElementById('sponsorship-section')) {
        loadSponsorshipTable();
        loadSponsorshipTree();
    }

    if (document.getElementById('district-area-section')) {
        loadGSRReports();
        loadDistrictMeetings();
        loadDCMCommunications();
    }

    if (document.getElementById('prudent-reserve-section')) {
        updateReserveStatus();
    }

    if (document.getElementById('chip-inventory-section')) {
        loadChipInventory();
        checkChipAlerts();
        loadChipDistributions();
    }

    if (document.getElementById('gc-live-section')) {
        loadLiveGCQueue();
    }

    // Show step progress group when program sponsorship is selected
    const sponsorshipType = document.getElementById('sponsorship-type');
    if (sponsorshipType) {
        sponsorshipType.addEventListener('change', function() {
            const stepGroup = document.getElementById('step-progress-group');
            if (stepGroup) {
                stepGroup.style.display = this.value === 'program' ? 'block' : 'none';
            }
        });
    }

    // Initialize notifications and reminders
    requestNotificationPermission();
    checkUpcomingReminders();
}

// ========================================
// BROWSER NOTIFICATIONS
// ========================================
function sendNotification(title, body, icon = null) {
    if ('Notification' in window && Notification.permission === 'granted') {
        const options = {
            body: body,
            icon: icon || 'logo.svg',
            badge: 'logo.svg',
            vibrate: [200, 100, 200],
            tag: 'rowlett-group-notification'
        };

        const notification = new Notification(title, options);

        notification.onclick = function() {
            window.focus();
            notification.close();
        };
    }
}

// Track reminder timeout to allow cancellation
let reminderTimeoutId = null;

function checkUpcomingReminders() {
    try {
        // Check for upcoming meetings
        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);

        let events = [];
        try {
            events = JSON.parse(localStorage.getItem('events') || '[]');
        } catch(e) {
            console.error('Error parsing events for reminders:', e);
        }

        const upcomingEvents = events.filter(e => {
            if (!e.date) return false;
            const eventDate = new Date(e.date);
            return eventDate.toDateString() === tomorrow.toDateString();
        });

        if (upcomingEvents.length > 0) {
            upcomingEvents.forEach(event => {
                sendNotification('Upcoming Meeting Tomorrow', event.title + ' at ' + event.time);
            });
        }

        // Check for upcoming birthdays (7 days ahead)
        const weekAhead = new Date(today);
        weekAhead.setDate(weekAhead.getDate() + 7);

        let members = [];
        try {
            members = JSON.parse(localStorage.getItem('members') || '[]');
        } catch(e) {
            console.error('Error parsing members for reminders:', e);
        }

        members.forEach(member => {
            if (member.birthday) {
                const birthday = new Date(member.birthday);
                birthday.setFullYear(today.getFullYear());

                if (birthday.toDateString() === weekAhead.toDateString()) {
                    sendNotification('Upcoming Birthday', member.name + '\'s birthday is in one week!');
                }
            }
        });

        // Check for commitment reminders (2 days ahead)
        const twoDaysAhead = new Date(today);
        twoDaysAhead.setDate(twoDaysAhead.getDate() + 2);

        let commitments = [];
        try {
            commitments = JSON.parse(localStorage.getItem('meetingCommitments') || '[]');
        } catch(e) {
            console.error('Error parsing commitments for reminders:', e);
        }

        const upcomingCommitments = commitments.filter(c => {
            if (!c.date) return false;
            const commitDate = new Date(c.date);
            return c.reminder && commitDate.toDateString() === twoDaysAhead.toDateString();
        });

        upcomingCommitments.forEach(commitment => {
            sendNotification('Meeting Commitment Reminder',
                'You are signed up for ' + commitment.role + ' in 2 days on ' + new Date(commitment.date).toLocaleDateString());
        });

        // Check again in 1 hour (clear previous timeout to prevent duplicates)
        if (reminderTimeoutId) {
            clearTimeout(reminderTimeoutId);
        }
        reminderTimeoutId = setTimeout(checkUpcomingReminders, 60 * 60 * 1000);
    } catch(e) {
        console.error('Error in checkUpcomingReminders:', e);
    }
}

// Function to stop reminder checks (useful for cleanup)
function stopReminderChecks() {
    if (reminderTimeoutId) {
        clearTimeout(reminderTimeoutId);
        reminderTimeoutId = null;
    }
}

// ========================================
// PWA MANIFEST INJECTION
// ========================================
function injectPWAManifest() {
    const manifest = {
        "name": "Rowlett Group - AA Group Conscience",
        "short_name": "Rowlett Group",
        "description": "Internal AA Group Conscience application for meeting management",
        "start_url": "./index.html",
        "display": "standalone",
        "background_color": "#2c3e50",
        "theme_color": "#3498db",
        "orientation": "any",
        "icons": [
            {
                "src": "logo.svg",
                "sizes": "any",
                "type": "image/svg+xml",
                "purpose": "any maskable"
            }
        ],
        "categories": ["productivity", "lifestyle"],
        "screenshots": []
    };

    const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
    const manifestURL = URL.createObjectURL(manifestBlob);

    const link = document.createElement('link');
    link.rel = 'manifest';
    link.href = manifestURL;
    document.head.appendChild(link);

    // Revoke the object URL after a short delay to free memory
    // (link element should have processed it by then)
    setTimeout(() => {
        URL.revokeObjectURL(manifestURL);
    }, 100);
}

// ========== HIGH-IMPACT FEATURES: VOTING SETTINGS ==========
function updateVotingMethodDisplay() {
    const method = document.getElementById('voting-method').value;
    const customGroup = document.getElementById('custom-threshold-group');

    if (method === 'custom') {
        customGroup.style.display = 'block';
    } else {
        customGroup.style.display = 'none';
    }
}

function saveVotingSettings() {
    const method = document.getElementById('voting-method').value;
    const allowAbstain = document.getElementById('allow-abstain').checked;
    let threshold = 66.67;

    switch(method) {
        case 'substantialUnanimity':
            threshold = 66.67;
            break;
        case 'simpleMajority':
            threshold = 50.01;
            break;
        case 'unanimousConsent':
            threshold = 100;
            break;
        case 'senseOfMeeting':
            threshold = 0; // No specific threshold for consensus
            break;
        case 'custom':
            threshold = parseFloat(document.getElementById('custom-threshold').value) || 66.67;
            break;
    }

    storage.saveVotingSettings({ method, threshold, allowAbstain });
    showToast('Voting settings saved!', 'success');
    loadVotingSettings();
}

function loadVotingSettings() {
    const settings = storage.getVotingSettings();
    document.getElementById('voting-method').value = settings.method;
    document.getElementById('allow-abstain').checked = settings.allowAbstain;
    document.getElementById('custom-threshold').value = settings.threshold;

    updateVotingMethodDisplay();

    // Update display
    const methodNames = {
        substantialUnanimity: 'Substantial Unanimity',
        simpleMajority: 'Simple Majority',
        unanimousConsent: 'Unanimous Consent',
        senseOfMeeting: 'Sense of the Meeting',
        custom: 'Custom Threshold'
    };

    const methodDescs = {
        substantialUnanimity: 'Requires 2/3 majority (66.67%)',
        simpleMajority: 'Requires 50% + 1',
        unanimousConsent: 'Requires 100% agreement',
        senseOfMeeting: 'Informal consensus',
        custom: `Requires ${settings.threshold}%`
    };

    document.getElementById('current-method-name').textContent = methodNames[settings.method] || 'Substantial Unanimity';
    document.getElementById('current-method-desc').textContent = methodDescs[settings.method] || 'Requires 2/3 majority (66.67%)';
}

function checkVotePasses(votesFor, votesAgainst, votesAbstain) {
    const settings = storage.getVotingSettings();

    if (settings.method === 'senseOfMeeting') {
        return { passes: true, type: 'consensus' };
    }

    const totalVotes = settings.allowAbstain
        ? votesFor + votesAgainst
        : votesFor + votesAgainst + votesAbstain;

    if (totalVotes === 0) return { passes: false, type: 'no-votes' };

    const percentage = (votesFor / totalVotes) * 100;
    const passes = percentage >= settings.threshold;

    return { passes, percentage: percentage.toFixed(2), threshold: settings.threshold };
}

// ========== MOTION TEMPLATES ==========
function saveMotionTemplate() {
    const editId = document.getElementById('template-edit-id').value;
    if (editId) {
        updateMotionTemplate();
        return;
    }

    const name = document.getElementById('template-name').value.trim();
    const category = document.getElementById('template-category').value;
    const template = document.getElementById('template-text').value.trim();

    if (!name || !template) {
        showToast('Please provide template name and text', 'error');
        return;
    }

    const templates = storage.getMotionTemplates();
    templates.push({
        id: genId(),
        name,
        category,
        template,
        createdDate: new Date().toISOString()
    });

    storage.saveMotionTemplates(templates);
    showToast('Template saved!', 'success');

    document.getElementById('template-name').value = '';
    document.getElementById('template-text').value = '';
    renderMotionTemplates();
}

function renderMotionTemplates() {
    const templates = storage.getMotionTemplates();
    const filter = document.getElementById('template-filter-category').value;
    const filtered = filter === 'all' ? templates : templates.filter(t => t.category === filter);

    const list = document.getElementById('motion-templates-list');
    if (filtered.length === 0) {
        list.innerHTML = '<p style="opacity: 0.7;">No templates found.</p>';
        return;
    }

    list.innerHTML = filtered.map(t => `
        <div style="padding: 1rem; margin-bottom: 0.5rem; background: #2c3e50; border-radius: 4px; border-left: 4px solid #3498db;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div style="flex: 1;">
                    <strong style="color: #3498db;">${escapeHtml(t.name)}</strong>
                    <span style="background: #34495e; padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.75rem; margin-left: 0.5rem;">${escapeHtml(t.category)}</span>
                    <p style="margin-top: 0.5rem; font-size: 0.9rem; opacity: 0.9;">${escapeHtml(t.template)}</p>
                </div>
                <div style="display: flex; gap: 0.5rem; margin-left: 1rem;">
                    <button class="btn secondary" data-action="use-template" data-id="${escapeAttribute(t.id)}" style="font-size: 0.85rem;">Use</button>
                    <button class="btn secondary" data-action="edit-template" data-id="${escapeAttribute(t.id)}" style="font-size: 0.85rem;">Edit</button>
                    <button class="btn secondary" data-action="delete-template" data-id="${escapeAttribute(t.id)}" style="font-size: 0.85rem; background: #e74c3c;">Delete</button>
                </div>
            </div>
        </div>
    `).join('');
}

function useMotionTemplate(id) {
    const templates = storage.getMotionTemplates();
    const template = templates.find(t => t.id === id);
    if (!template) return;

    // Try to find the GC item text area and populate it
    const gcItemField = document.getElementById('gc-item');
    if (gcItemField) {
        gcItemField.value = template.template;
        showToast('Template loaded into motion field!', 'success');
        goToSection('chairperson-section');
    } else {
        // Copy to clipboard as fallback
        navigator.clipboard.writeText(template.template).then(() => {
            showToast('Template copied to clipboard!', 'success');
        });
    }
}

function editMotionTemplate(id) {
    const templates = storage.getMotionTemplates();
    const template = templates.find(t => t.id === id);
    if (!template) return;

    document.getElementById('template-edit-id').value = template.id;
    document.getElementById('template-name').value = template.name;
    document.getElementById('template-category').value = template.category;
    document.getElementById('template-text').value = template.template;

    document.getElementById('template-form-btn').textContent = 'Update Template';
    document.getElementById('template-form-cancel-btn').style.display = 'inline-block';
}

function updateMotionTemplate() {
    const id = document.getElementById('template-edit-id').value;
    const name = document.getElementById('template-name').value.trim();
    const category = document.getElementById('template-category').value;
    const template = document.getElementById('template-text').value.trim();

    if (!name || !template) {
        showToast('Please provide template name and text', 'error');
        return;
    }

    let templates = storage.getMotionTemplates();
    const index = templates.findIndex(t => t.id === id);
    if (index > -1) {
        templates[index] = { ...templates[index], name, category, template };
        storage.saveMotionTemplates(templates);
        showToast('Template updated!', 'success');
        cancelTemplateEdit();
        renderMotionTemplates();
    }
}

function cancelTemplateEdit() {
    document.getElementById('template-edit-id').value = '';
    document.getElementById('template-name').value = '';
    document.getElementById('template-text').value = '';
    document.getElementById('template-form-btn').textContent = 'Add Template';
    document.getElementById('template-form-cancel-btn').style.display = 'none';
}

function deleteMotionTemplate(id) {
    if (!confirm('Delete this template?')) return;
    let templates = storage.getMotionTemplates();
    templates = templates.filter(t => t.id !== id);
    storage.saveMotionTemplates(templates);
    showToast('Template deleted', 'info');
    renderMotionTemplates();
}

// ========== TRADITION & CONCEPT CHECKER ==========
function checkTraditionsAndConcepts() {
    const motionText = document.getElementById('check-motion-text').value.trim().toLowerCase();
    if (!motionText) {
        showToast('Please enter a motion to check', 'error');
        return;
    }

    const warnings = [];
    const relevantTraditions = [];
    const relevantConcepts = [];
    const questions = [];

    // Check for tradition violations (keyword-based analysis)
    const traditionChecks = [
        { tradition: 1, keywords: ['outside', 'non-aa', 'affiliate', 'merge'], warning: 'May affect group autonomy or unity', questions: ['Does this keep our group focused on AA\'s primary purpose?'] },
        { tradition: 2, keywords: ['leader', 'boss', 'control', 'authority'], warning: 'May create authority issues', questions: ['Are we empowering a trusted servant or creating a leader?'] },
        { tradition: 3, keywords: ['require', 'must be', 'mandatory'], warning: 'May restrict membership', questions: ['Is our only requirement a desire to stop drinking?'] },
        { tradition: 4, keywords: ['interfere', 'tell', 'dictate'], warning: 'May affect group autonomy', questions: ['Does this interfere with other groups?'] },
        { tradition: 5, keywords: ['purpose', 'mission', 'goal'], warning: 'Check alignment with primary purpose', questions: ['Does this help us carry the message to the alcoholic who still suffers?'] },
        { tradition: 6, keywords: ['endorse', 'sponsor', 'partner', 'facility', 'property'], warning: 'Possible outside issue or endorsement', questions: ['Are we lending the AA name to any outside enterprise?'] },
        { tradition: 7, keywords: ['donation', 'contribution', 'outside', 'fund'], warning: 'Self-support concern', questions: ['Are we remaining self-supporting?', 'Are we accepting contributions from non-members?'] },
        { tradition: 8, keywords: ['pay', 'salary', 'hire', 'employee'], warning: 'Professional vs. non-professional distinction', questions: ['Should this remain non-professional or require special workers?'] },
        { tradition: 9, keywords: ['organization', 'structure', 'board'], warning: 'Check organization complexity', questions: ['Are we creating unnecessary organization?'] },
        { tradition: 10, keywords: ['opinion', 'position', 'stance', 'political'], warning: 'Possible outside controversy', questions: ['Does this involve AA in public controversy?'] },
        { tradition: 11, keywords: ['publicity', 'promote', 'advertise', 'media'], warning: 'Attraction vs. promotion', questions: ['Are we practicing attraction rather than promotion?'] },
        { tradition: 12, keywords: ['name', 'credit', 'recognition', 'fame'], warning: 'Anonymity concern', questions: ['Are we placing principles before personalities?'] }
    ];

    traditionChecks.forEach(check => {
        if (check.keywords.some(kw => motionText.includes(kw))) {
            relevantTraditions.push({ num: check.tradition, warning: check.warning });
            questions.push(...check.questions);
        }
    });

    // Relevant concepts (simplified)
    if (motionText.includes('servant') || motionText.includes('service') || motionText.includes('position')) {
        relevantConcepts.push({ num: 1, text: 'Final responsibility and ultimate authority for AA world services should always reside in the collective conscience of our whole Fellowship.' });
        relevantConcepts.push({ num: 9, text: 'Good service leadership at all levels is indispensable for our future functioning and safety.' });
    }
    if (motionText.includes('money') || motionText.includes('budget') || motionText.includes('financial')) {
        relevantConcepts.push({ num: 8, text: 'The trustees are the principal planners and administrators of overall policy and finance.' });
    }

    // General questions
    questions.push('Does this promote unity within our group?');
    questions.push('Is this decision made in the spirit of love and service?');
    questions.push('Have we sought guidance through group discussion and prayer?');

    // Display results
    document.getElementById('tradition-check-results').style.display = 'block';

    const warningsEl = document.getElementById('tradition-warnings');
    if (relevantTraditions.length > 0) {
        warningsEl.innerHTML = relevantTraditions.map(t => `
            <div style="padding: 0.75rem; background: #2c3e50; border-radius: 4px; margin-bottom: 0.5rem;">
                <strong style="color: #f39c12;">Tradition ${t.num}:</strong> ${escapeHtml(t.warning)}
            </div>
        `).join('');
    } else {
        warningsEl.innerHTML = '<p style="color: #2ecc71;">No obvious tradition concerns detected.</p>';
    }

    const traditionsEl = document.getElementById('relevant-traditions');
    traditionsEl.innerHTML = `
        <p style="font-size: 0.9rem; margin-bottom: 0.5rem;">Consider reviewing these traditions:</p>
        ${relevantTraditions.length > 0 ? relevantTraditions.map(t => `<div style="padding: 0.5rem; background: #2c3e50; border-radius: 4px; margin-bottom: 0.25rem;">Tradition ${t.num}</div>`).join('') : '<p style="opacity: 0.7;">All 12 Traditions are always relevant to group decisions.</p>'}
    `;

    const conceptsEl = document.getElementById('relevant-concepts');
    if (relevantConcepts.length > 0) {
        conceptsEl.innerHTML = relevantConcepts.map(c => `
            <div style="padding: 0.75rem; background: #2c3e50; border-radius: 4px; margin-bottom: 0.5rem;">
                <strong style="color: #9b59b6;">Concept ${c.num}:</strong> ${escapeHtml(c.text)}
            </div>
        `).join('');
    } else {
        conceptsEl.innerHTML = '<p style="opacity: 0.7;">Review the 12 Concepts for World Service as needed.</p>';
    }

    const questionsEl = document.getElementById('guided-questions');
    questionsEl.innerHTML = [...new Set(questions)].map(q => `
        <div style="padding: 0.5rem 0.5rem 0.5rem 1.5rem; margin-bottom: 0.25rem; position: relative;">
            <span style="position: absolute; left: 0.5rem; color: #2ecc71;">•</span>
            ${escapeHtml(q)}
        </div>
    `).join('');

    // Save check to history
    const checks = storage.getTraditionChecks();
    checks.push({
        id: genId(),
        motionText: document.getElementById('check-motion-text').value,
        timestamp: new Date().toISOString(),
        warnings: relevantTraditions
    });
    storage.saveTraditionChecks(checks);
}

function showTraditionsReference() {
    alert('View the 12 Traditions in the Literature Inventory section or visit aa.org');
}

function showConceptsReference() {
    alert('View the 12 Concepts in the Literature Inventory section or visit aa.org');
}

// ========== PARLIAMENTARY PROCEDURE ==========
let currentWorkflowStep = 0;
let speakerTimerInterval = null;
let speakerTimeRemaining = 180; // 3 minutes default

function advanceMotionWorkflow() {
    currentWorkflowStep = (currentWorkflowStep + 1) % 4;
    updateWorkflowDisplay();
}

function resetMotionWorkflow() {
    currentWorkflowStep = 0;
    updateWorkflowDisplay();
}

function updateWorkflowDisplay() {
    const steps = ['step-motion', 'step-second', 'step-discussion', 'step-vote'];
    steps.forEach((step, idx) => {
        const el = document.getElementById(step);
        if (idx === currentWorkflowStep) {
            el.style.background = '#3498db';
            el.style.color = '#fff';
        } else if (idx < currentWorkflowStep) {
            el.style.background = '#27ae60';
            el.style.color = '#fff';
        } else {
            el.style.background = '#34495e';
            el.style.color = '#ecf0f1';
        }
    });

    if (currentWorkflowStep === 2) {
        document.getElementById('discussion-timer-display').style.display = 'block';
    }
}

function addToSpeakingQueue() {
    const speakerName = document.getElementById('speaker-name').value;
    if (!speakerName) {
        showToast('Please select a member', 'error');
        return;
    }

    const queue = storage.getSpeakingQueue();
    queue.push({
        id: genId(),
        name: speakerName,
        timestamp: new Date().toISOString(),
        status: 'waiting'
    });
    storage.saveSpeakingQueue(queue);
    renderSpeakingQueue();
    document.getElementById('speaker-name').value = '';
}

function renderSpeakingQueue() {
    const queue = storage.getSpeakingQueue().filter(s => s.status !== 'done');
    const list = document.getElementById('speaking-queue-list');

    if (queue.length === 0) {
        list.innerHTML = '<p style="opacity: 0.7; text-align: center; padding: 2rem;">No speakers in queue</p>';
        return;
    }

    list.innerHTML = queue.map((speaker, idx) => `
        <div style="padding: 0.75rem; margin-bottom: 0.5rem; background: ${idx === 0 ? '#27ae60' : '#2c3e50'}; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <strong>${idx + 1}. ${escapeHtml(speaker.name)}</strong>
                ${idx === 0 ? '<span style="margin-left: 0.5rem; color: #f1c40f;">● Speaking Now</span>' : ''}
            </div>
            <div style="display: flex; gap: 0.5rem;">
                ${idx === 0 ? '<button class="btn secondary" onclick="markSpeakerDone(\'' + speaker.id + '\')" style="font-size: 0.85rem;">Done</button>' : ''}
                <button class="btn secondary" onclick="removeSpeaker(\'' + speaker.id + '\')" style="font-size: 0.85rem; background: #e74c3c;">Remove</button>
            </div>
        </div>
    `).join('');
}

function markSpeakerDone(id) {
    let queue = storage.getSpeakingQueue();
    const speaker = queue.find(s => s.id === id);
    if (speaker) {
        speaker.status = 'done';
        storage.saveSpeakingQueue(queue);
        renderSpeakingQueue();
        resetSpeakerTimer();
    }
}

function removeSpeaker(id) {
    let queue = storage.getSpeakingQueue();
    queue = queue.filter(s => s.id !== id);
    storage.saveSpeakingQueue(queue);
    renderSpeakingQueue();
}

function startSpeakerTimer() {
    if (speakerTimerInterval) return;
    speakerTimerInterval = setInterval(() => {
        speakerTimeRemaining--;
        updateTimerDisplay();
        if (speakerTimeRemaining <= 0) {
            pauseSpeakerTimer();
            showToast('Time is up!', 'info');
        }
    }, 1000);
}

function pauseSpeakerTimer() {
    if (speakerTimerInterval) {
        clearInterval(speakerTimerInterval);
        speakerTimerInterval = null;
    }
}

function resetSpeakerTimer() {
    pauseSpeakerTimer();
    speakerTimeRemaining = 180;
    updateTimerDisplay();
}

function updateTimerDisplay() {
    const minutes = Math.floor(speakerTimeRemaining / 60);
    const seconds = speakerTimeRemaining % 60;
    document.getElementById('timer-display').textContent =
        `${minutes}:${seconds.toString().padStart(2, '0')}`;
}

function callForSecond() {
    showToast('Calling for a second to the motion...', 'info');
    advanceMotionWorkflow();
}

function openDiscussion() {
    showToast('Discussion is now open', 'info');
    currentWorkflowStep = 2;
    updateWorkflowDisplay();
}

function closeDiscussion() {
    showToast('Discussion is closed', 'info');
}

function callTheQuestion() {
    if (confirm('Are you ready to vote on this motion?')) {
        currentWorkflowStep = 3;
        updateWorkflowDisplay();
        showToast('Ready to vote!', 'success');
    }
}

function tableMotion() {
    if (confirm('Table this motion until the next meeting?')) {
        showToast('Motion has been tabled', 'info');
        resetMotionWorkflow();
        storage.saveSpeakingQueue([]);
        renderSpeakingQueue();
    }
}

function pointOfInformation() {
    showToast('Point of Information recognized', 'info');
}

function pointOfOrder() {
    showToast('Point of Order recognized', 'info');
}

function pointOfPrivilege() {
    showToast('Point of Personal Privilege recognized', 'info');
}

function proposeAmendment() {
    const text = document.getElementById('amendment-text').value.trim();
    const type = document.querySelector('input[name="amendment-type"]:checked').value;

    if (!text) {
        showToast('Please enter amendment text', 'error');
        return;
    }

    showToast(`${type === 'friendly' ? 'Friendly' : 'Unfriendly'} amendment proposed`, 'success');
    document.getElementById('amendment-text').value = '';

    // Could save amendments to a list for tracking
    const list = document.getElementById('active-amendments-list');
    const amendDiv = document.createElement('div');
    amendDiv.style.cssText = 'padding: 0.5rem; background: #2c3e50; border-radius: 4px; margin-top: 0.5rem;';
    amendDiv.innerHTML = `<strong>${type === 'friendly' ? 'Friendly' : 'Unfriendly'}:</strong> ${escapeHtml(text)}`;
    list.appendChild(amendDiv);
}

// ========== P2: ENHANCED ROBERT'S RULES FUNCTIONS ==========

const MotionTypes = {
    MAIN: { precedence: 0, debatable: true, amendable: true, voteRequired: 'majority', displayName: 'Main Motion' },
    AMEND: { precedence: 1, debatable: true, amendable: true, voteRequired: 'majority', displayName: 'Amendment' },
    REFER: { precedence: 2, debatable: true, amendable: true, voteRequired: 'majority', displayName: 'Refer to Committee' },
    POSTPONE: { precedence: 3, debatable: true, amendable: true, voteRequired: 'majority', displayName: 'Postpone' },
    LIMIT_DEBATE: { precedence: 4, debatable: false, amendable: true, voteRequired: '2/3', displayName: 'Limit Debate' },
    PREVIOUS_QUESTION: { precedence: 5, debatable: false, amendable: false, voteRequired: '2/3', displayName: 'Previous Question' },
    TABLE: { precedence: 6, debatable: false, amendable: false, voteRequired: 'majority', displayName: 'Table Motion' },
    POINT_OF_ORDER: { precedence: 99, debatable: false, amendable: false, voteRequired: 'chair', displayName: 'Point of Order' }
};

function updateVotingMethod() {
    const method = document.getElementById('voting-method').value;
    const voteCounter = document.getElementById('vote-counter');

    if (method === 'voice') {
        voteCounter.style.display = 'none';
        showToast('Voice vote selected - Chair will call for ayes and nays', 'info');
    } else {
        voteCounter.style.display = 'block';
        showToast(`${method.replace('-', ' ')} voting method selected`, 'info');
    }
}

function calculateVoteResult() {
    const votesFor = parseInt(document.getElementById('votes-for-input').value) || 0;
    const votesAgainst = parseInt(document.getElementById('votes-against-input').value) || 0;
    const votesAbstain = parseInt(document.getElementById('votes-abstain-input').value) || 0;
    const totalVotes = votesFor + votesAgainst;
    const votingMethod = document.getElementById('voting-method').value;

    // Check quorum
    const gcSettings = storage.getGCSettings();
    const members = storage.getMembers().length;
    const quorumMin = Math.max(gcSettings.quorumMinimum || 5, Math.ceil(members * ((gcSettings.quorumPercentage || 40) / 100)));

    if (totalVotes < quorumMin) {
        showToast(`Quorum not met! Need ${quorumMin} voting members, only ${totalVotes} voted.`, 'error');
        document.getElementById('vote-result').style.display = 'block';
        document.getElementById('vote-result-text').innerHTML = '<span style="color: #e74c3c;">QUORUM NOT MET</span>';
        document.getElementById('vote-result-details').textContent = `Required: ${quorumMin} | Present: ${totalVotes}`;
        return;
    }

    // Determine pass/fail
    let passed = false;
    let requiredVotes = 0;
    let passThreshold = '';

    if (votingMethod === 'consensus') {
        // AA substantial unanimity (2/3)
        requiredVotes = Math.ceil(totalVotes * 0.667);
        passed = votesFor >= requiredVotes;
        passThreshold = '2/3 (Substantial Unanimity)';
    } else {
        // Simple majority
        passed = votesFor > votesAgainst;
        passThreshold = 'Simple Majority';
    }

    // Calculate percentages
    const forPercentage = ((votesFor / totalVotes) * 100).toFixed(1);
    const againstPercentage = ((votesAgainst / totalVotes) * 100).toFixed(1);
    const minorityPercentage = parseFloat(againstPercentage);

    // Display result
    document.getElementById('vote-result').style.display = 'block';
    const resultColor = passed ? '#2ecc71' : '#e74c3c';
    document.getElementById('vote-result-text').innerHTML = `<span style="color: ${resultColor};">${passed ? 'MOTION PASSED' : 'MOTION FAILED'}</span>`;
    document.getElementById('vote-result-details').innerHTML = `
        For: ${votesFor} (${forPercentage}%) | Against: ${votesAgainst} (${againstPercentage}%) | Abstain: ${votesAbstain}<br>
        Threshold: ${passThreshold} | Total Voting: ${totalVotes}
    `;

    // Check for minority report
    if (passed && minorityPercentage >= 33) {
        document.getElementById('minority-report-section').style.display = 'block';
        document.getElementById('minority-not-needed').style.display = 'none';
        showToast('Significant minority (&gt;33%) - minority may record concerns per AA Tradition', 'warning');
    } else {
        document.getElementById('minority-report-section').style.display = 'none';
        document.getElementById('minority-not-needed').style.display = 'block';
    }

    // Update quorum display
    document.getElementById('quorum-required').textContent = quorumMin;
    document.getElementById('quorum-present').textContent = totalVotes;
    const quorumStatus = document.getElementById('quorum-status');
    quorumStatus.style.background = '#2ecc71';
    quorumStatus.style.color = 'white';
    quorumStatus.innerHTML = '<i class="fas fa-check-circle"></i> Quorum Met';

    showToast(passed ? 'Motion passed!' : 'Motion failed', passed ? 'success' : 'error');
}

function saveMinorityReport() {
    const concerns = document.getElementById('minority-concerns').value.trim();

    if (!concerns) {
        showToast('Please enter minority concerns', 'error');
        return;
    }

    // Save to current GC log or create entry
    showToast('Minority report saved and will be included in meeting minutes', 'success');
    logAuditEntry('create', 'minority-report', storage.getCurrentUser(), { concerns }, 'Minority opinion recorded');

    // Clear form
    document.getElementById('minority-concerns').value = '';
    document.getElementById('minority-report-section').style.display = 'none';
    document.getElementById('minority-not-needed').style.display = 'block';
}

function updateQuorumDisplay() {
    const gcSettings = storage.getGCSettings();
    const members = storage.getMembers().length;
    const quorumMin = Math.max(gcSettings.quorumMinimum || 5, Math.ceil(members * ((gcSettings.quorumPercentage || 40) / 100)));

    document.getElementById('quorum-required').textContent = quorumMin;
    document.getElementById('quorum-status').innerHTML = '<i class="fas fa-info-circle"></i> Enter attendance to check quorum';
    document.getElementById('quorum-status').style.background = '#34495e';
    document.getElementById('quorum-status').style.color = '#ecf0f1';
}

// ========== P3: CROSS-MODULE LINKING FUNCTIONS ==========

function getMotionImpactLinks(gcLogId) {
    const log = storage.getGroupConscienceLog().find(l => l.id === gcLogId);
    if (!log) return [];

    const impacts = [];

    // Check if it affects budget
    if (log.item.toLowerCase().includes('budget') || log.item.toLowerCase().includes('expense') || log.item.toLowerCase().includes('$')) {
        const budgetCategories = storage.getBudgetCategories();
        const relatedCategories = budgetCategories.filter(cat =>
            log.item.toLowerCase().includes(cat.category.toLowerCase())
        );

        if (relatedCategories.length > 0) {
            impacts.push({
                module: 'Budget',
                icon: 'fa-dollar-sign',
                description: `May affect ${relatedCategories.map(c => c.category).join(', ')} budget`,
                actionFn: 'goToSection(\'finance-section\')',
                actionText: 'View Budget'
            });
        }
    }

    // Check if it affects service positions
    const positions = storage.getServicePositions();
    const mentionedPositions = positions.filter(pos =>
        log.item.toLowerCase().includes(pos.name.toLowerCase())
    );

    if (mentionedPositions.length > 0) {
        impacts.push({
            module: 'Service',
            icon: 'fa-users-cog',
            description: `Related to ${mentionedPositions.map(p => p.name).join(', ')}`,
            actionFn: 'goToSection(\'service-positions-section\')',
            actionText: 'View Positions'
        });
    }

    // Check if creates action items
    const actionItems = storage.getGCActionItems().filter(item => item.gcId === gcLogId);
    if (actionItems.length > 0) {
        impacts.push({
            module: 'Action Items',
            icon: 'fa-tasks',
            description: `${actionItems.length} action item(s) created`,
            actionFn: 'goToSection(\'gc-decisions-section\')',
            actionText: 'View Tasks'
        });
    }

    // Check for related traditions
    const traditionAlignment = getMotionTraditionAlignment(log.item);
    if (traditionAlignment) {
        impacts.push({
            module: 'AA Traditions',
            icon: 'fa-book',
            description: `Aligns with Tradition #${traditionAlignment.tradition}`,
            actionFn: 'showTraditionsReference()',
            actionText: 'View Tradition'
        });
    }

    return impacts;
}

function openMember360View(memberId) {
    const member = storage.getMembers().find(m => m.id === memberId);
    if (!member) {
        showToast('Member not found', 'error');
        return;
    }

    const positions = storage.getServicePositions().filter(p => p.currentHolder === member.name);
    const gcParticipation = storage.getGroupConscienceLog().filter(log =>
        (Array.isArray(log.attendees) && log.attendees.includes(member.name)) ||
        log.submittedBy === member.name
    );
    const messages = storage.getMessages().filter(m => m.from === member.name || m.to === member.name);

    // Create modal
    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; overflow-y: auto;';

    modal.innerHTML = `
        <div style="background: #34495e; padding: 2rem; border-radius: 8px; max-width: 900px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2 style="color: #3498db; margin: 0;">${escapeHtml(member.name)} - Complete Profile</h2>
                <button onclick="this.closest('div[style*=fixed]').remove()" style="background: none; border: none; color: #e74c3c; font-size: 2rem; cursor: pointer;">&times;</button>
            </div>

            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                <div class="box">
                    <h3>Contact Information</h3>
                    <p><strong>Email:</strong> ${escapeHtml(member.email || 'Not provided')}</p>
                    <p><strong>Phone:</strong> ${escapeHtml(member.phone || 'Not provided')}</p>
                    <p><strong>Home Group:</strong> ${escapeHtml(member.homegroup || 'This group')}</p>
                    <p><strong>Sponsor:</strong> ${escapeHtml(member.sponsor || 'Not listed')}</p>
                    <p><strong>Clean Date:</strong> ${member.birthday ? new Date(member.birthday).toLocaleDateString() : 'Not provided'}</p>
                </div>

                <div class="box">
                    <h3>Group Participation</h3>
                    <p><strong>GC Meetings Attended:</strong> ${gcParticipation.length}</p>
                    <p><strong>Motions Submitted:</strong> ${gcParticipation.filter(log => log.submittedBy === member.name).length}</p>
                    <p><strong>Messages:</strong> ${messages.length}</p>
                    <button class="btn mt-2" onclick="goToSection('messaging-section')">Send Message</button>
                </div>
            </div>

            <div class="box mb-4">
                <h3><i class="fas fa-users-cog"></i> Service Positions (${positions.length})</h3>
                ${positions.length > 0 ? `
                    <table>
                        <thead><tr><th>Position</th><th>Start Date</th><th>Term Ends</th></tr></thead>
                        <tbody>
                            ${positions.map(pos => {
                                const endDate = pos.startDate && pos.termLength !== 'Indefinite' ? new Date(new Date(pos.startDate).setMonth(new Date(pos.startDate).getMonth() + parseInt(pos.termLength))) : null;
                                return `
                                    <tr>
                                        <td>${escapeHtml(pos.name)}</td>
                                        <td>${pos.startDate ? new Date(pos.startDate).toLocaleDateString() : 'N/A'}</td>
                                        <td>${endDate ? endDate.toLocaleDateString() : 'Indefinite'}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                ` : '<p style="opacity: 0.7;">No current service positions</p>'}
                <button class="btn mt-2" onclick="goToSection('service-positions-section')">View All Positions</button>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
}

// ========== P4: LIVE MEETING MODE (Basic Implementation) ==========

let liveMeetingData = null;
let meetingTimer = null;

function startLiveMeeting() {
    liveMeetingData = {
        id: genId(),
        startTime: new Date().toISOString(),
        attendees: [],
        motions: [],
        speakers: [],
        actionItems: []
    };

    showToast('Live GC session started! All actions will be recorded automatically.', 'success');
    logAuditEntry('create', 'live-meeting', storage.getCurrentUser(), liveMeetingData, 'Started live GC session');
}

function endLiveMeeting() {
    if (!liveMeetingData) return;

    liveMeetingData.endTime = new Date().toISOString();
    showToast('Meeting ended! Review and save meeting minutes.', 'success');
    logAuditEntry('create', 'meeting-end', storage.getCurrentUser(), liveMeetingData, 'Ended live GC session');

    liveMeetingData = null;
}

// ========== SERVICE ELECTIONS ==========
let currentElection = null;

function startElection() {
    const positionId = document.getElementById('election-position').value;
    const date = document.getElementById('election-date').value;
    const anonymous = document.getElementById('election-anonymous').checked;
    const method = document.getElementById('election-method').value;

    if (!positionId || !date) {
        showToast('Please select position and date', 'error');
        return;
    }

    const positions = storage.getGroupPositions();
    const position = positions.find(p => p.id === positionId);

    currentElection = {
        id: genId(),
        positionId,
        positionTitle: position.title,
        date,
        anonymous,
        method,
        status: 'nominating',
        nominees: [],
        ballots: []
    };

    document.getElementById('current-election-info').style.display = 'block';
    document.getElementById('current-election-position').textContent = position.title;

    showToast(`Election started for ${position.title}`, 'success');
    renderNominees();
}

function nominateMember() {
    if (!currentElection) {
        showToast('Please start an election first', 'error');
        return;
    }

    const memberId = document.getElementById('nominee-select').value;
    if (!memberId) {
        showToast('Please select a member', 'error');
        return;
    }

    const members = storage.getMembers();
    const member = members.find(m => m.id === memberId);

    // Check if already nominated
    if (currentElection.nominees.find(n => n.memberId === memberId)) {
        showToast('This member is already nominated', 'error');
        return;
    }

    currentElection.nominees.push({
        memberId,
        memberName: member.name,
        timestamp: new Date().toISOString()
    });

    showToast(`${member.name} nominated`, 'success');
    renderNominees();
}

function renderNominees() {
    if (!currentElection) return;

    const list = document.getElementById('nominees-list');
    if (currentElection.nominees.length === 0) {
        list.innerHTML = '<p style="opacity: 0.7;">No nominees yet</p>';
        return;
    }

    list.innerHTML = currentElection.nominees.map(n => `
        <div style="padding: 0.75rem; background: #2c3e50; border-radius: 4px; margin-top: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
            <strong>${escapeHtml(n.memberName)}</strong>
            <button class="btn secondary" onclick="removeNominee('${escapeAttribute(n.memberId)}')" style="font-size: 0.85rem; background: #e74c3c;">Remove</button>
        </div>
    `).join('');

    renderBallotInterface();
}

function removeNominee(memberId) {
    if (!currentElection) return;
    currentElection.nominees = currentElection.nominees.filter(n => n.memberId !== memberId);
    renderNominees();
}

function renderBallotInterface() {
    if (!currentElection || currentElection.nominees.length === 0) {
        document.getElementById('ballot-interface').innerHTML = '<p style="opacity: 0.7;">Add nominees to begin voting</p>';
        return;
    }

    const ballot = document.getElementById('ballot-interface');
    ballot.innerHTML = `
        <p class="mb-2"><strong>Cast your vote:</strong></p>
        ${currentElection.nominees.map(n => `
            <div style="padding: 0.5rem; background: #2c3e50; border-radius: 4px; margin-bottom: 0.5rem;">
                <label style="cursor: pointer; display: flex; align-items: center;">
                    <input type="radio" name="ballot-vote" value="${escapeAttribute(n.memberId)}" style="margin-right: 0.5rem;">
                    ${escapeHtml(n.memberName)}
                </label>
            </div>
        `).join('')}
        <button class="btn mt-2" onclick="castBallot()">Cast Ballot</button>
        <button class="btn secondary mt-2 ml-2" onclick="finalizeElection()">Finalize Election</button>
    `;
}

function castBallot() {
    if (!currentElection) return;

    const selected = document.querySelector('input[name="ballot-vote"]:checked');
    if (!selected) {
        showToast('Please select a nominee', 'error');
        return;
    }

    currentElection.ballots.push({
        vote: selected.value,
        timestamp: new Date().toISOString()
    });

    showToast('Ballot cast!', 'success');

    // Reset selection
    document.querySelectorAll('input[name="ballot-vote"]').forEach(r => r.checked = false);

    // Show current tally if not anonymous
    if (!currentElection.anonymous) {
        const tallies = {};
        currentElection.ballots.forEach(b => {
            tallies[b.vote] = (tallies[b.vote] || 0) + 1;
        });

        console.log('Current tallies:', tallies);
    }
}

function finalizeElection() {
    if (!currentElection || currentElection.ballots.length === 0) {
        showToast('No ballots have been cast', 'error');
        return;
    }

    // Count votes
    const tallies = {};
    currentElection.ballots.forEach(b => {
        tallies[b.vote] = (tallies[b.vote] || 0) + 1;
    });

    // Find winner
    const sortedCandidates = Object.entries(tallies).sort((a, b) => b[1] - a[1]);
    const winnerId = sortedCandidates[0][0];
    const winnerVotes = sortedCandidates[0][1];
    const totalVotes = currentElection.ballots.length;

    const winner = currentElection.nominees.find(n => n.memberId === winnerId);

    currentElection.status = 'completed';
    currentElection.winner = winner;
    currentElection.finalTally = tallies;
    currentElection.completedDate = new Date().toISOString();

    // Save election
    const elections = storage.getServiceElections();
    elections.push(currentElection);
    storage.saveServiceElections(elections);

    showToast(`${winner.memberName} elected with ${winnerVotes}/${totalVotes} votes!`, 'success');

    // Update service position
    updateServicePositionHolder(currentElection.positionId, winnerId, winner.memberName);

    // Reset
    currentElection = null;
    document.getElementById('current-election-info').style.display = 'none';
    document.getElementById('ballot-interface').innerHTML = '';
    document.getElementById('nominees-list').innerHTML = '';

    renderElectionHistory();
    renderCurrentPositions();
}

function updateServicePositionHolder(positionId, memberId, memberName) {
    const positions = storage.getGroupPositions();
    const position = positions.find(p => p.id === positionId);
    if (position) {
        const termEnd = new Date();
        termEnd.setMonth(termEnd.getMonth() + position.term);

        position.currentHolder = memberName;
        position.currentHolderId = memberId;
        position.termStart = new Date().toISOString();
        position.termEnd = termEnd.toISOString();

        storage.saveGroupPositions(positions);
    }
}

function renderCurrentPositions() {
    const positions = storage.getGroupPositions();
    const tbody = document.getElementById('current-positions-body');

    tbody.innerHTML = positions.map(p => {
        const termEnd = p.termEnd ? new Date(p.termEnd) : null;
        const now = new Date();
        const daysRemaining = termEnd ? Math.floor((termEnd - now) / (1000 * 60 * 60 * 24)) : null;

        let status = 'Vacant';
        let statusColor = '#95a5a6';

        if (p.currentHolder) {
            if (daysRemaining > 90) {
                status = 'Active';
                statusColor = '#2ecc71';
            } else if (daysRemaining > 30) {
                status = 'Expiring Soon';
                statusColor = '#f39c12';
            } else if (daysRemaining > 0) {
                status = 'Expiring Very Soon';
                statusColor = '#e67e22';
            } else {
                status = 'Expired';
                statusColor = '#e74c3c';
            }
        }

        return `
            <tr>
                <td>${escapeHtml(p.title)}</td>
                <td>${p.currentHolder ? escapeHtml(p.currentHolder) : 'Vacant'}</td>
                <td>${termEnd ? termEnd.toLocaleDateString() : 'N/A'}</td>
                <td style="color: ${statusColor};">${status}</td>
            </tr>
        `;
    }).join('');
}

function renderElectionHistory() {
    const elections = storage.getServiceElections().sort((a, b) => new Date(b.completedDate) - new Date(a.completedDate));
    const list = document.getElementById('election-history-list');

    if (elections.length === 0) {
        list.innerHTML = '<p style="opacity: 0.7;">No elections recorded yet</p>';
        return;
    }

    list.innerHTML = elections.map(e => `
        <div style="padding: 0.75rem; background: #2c3e50; border-radius: 4px; margin-bottom: 0.5rem;">
            <strong>${escapeHtml(e.positionTitle)}</strong><br>
            <span style="font-size: 0.85rem; opacity: 0.8;">Winner: ${escapeHtml(e.winner.memberName)}</span><br>
            <span style="font-size: 0.85rem; opacity: 0.8;">Date: ${new Date(e.completedDate).toLocaleDateString()}</span>
        </div>
    `).join('');
}

function updateElectionEligibility() {
    const positionId = document.getElementById('election-position').value;
    if (!positionId) {
        document.getElementById('position-requirements').style.display = 'none';
        return;
    }

    const positions = storage.getGroupPositions();
    const position = positions.find(p => p.id === positionId);

    if (position) {
        document.getElementById('position-requirements').style.display = 'block';
        document.getElementById('position-req-details').innerHTML = `
            <div style="margin-top: 0.5rem;">
                <div>Term: ${position.term} months</div>
                <div>Min. Sobriety: ${position.minSobriety} months</div>
                <div>${escapeHtml(position.description)}</div>
            </div>
        `;
    }
}

// ========== BUDGET APPROVAL ==========
let budgetLineItemCounter = 0;

function addBudgetLineItem() {
    const container = document.getElementById('budget-line-items');
    const id = budgetLineItemCounter++;

    const item = document.createElement('div');
    item.className = 'budget-line-item';
    item.style.cssText = 'padding: 0.75rem; background: #2c3e50; border-radius: 4px; margin-bottom: 0.5rem;';
    item.innerHTML = `
        <div style="display: flex; gap: 0.5rem; align-items: center;">
            <input type="text" placeholder="Category" id="budget-cat-${id}" style="flex: 2;">
            <input type="number" step="0.01" placeholder="Amount" id="budget-amt-${id}" onchange="updateBudgetTotal()" style="flex: 1;">
            <button class="btn secondary" onclick="this.parentElement.parentElement.remove(); updateBudgetTotal();" style="font-size: 0.85rem;">Remove</button>
        </div>
    `;
    container.appendChild(item);
}

function updateBudgetTotal() {
    const items = document.querySelectorAll('.budget-line-item');
    let total = 0;
    items.forEach(item => {
        const amtInput = item.querySelector('input[type="number"]');
        if (amtInput) {
            total += parseFloat(amtInput.value) || 0;
        }
    });
    document.getElementById('total-proposed-budget').textContent = total.toFixed(2);
}

function submitBudgetProposal() {
    const year = parseInt(document.getElementById('budget-year').value);
    const type = document.getElementById('budget-type').value;

    if (!year) {
        showToast('Please enter fiscal year', 'error');
        return;
    }

    const items = [];
    document.querySelectorAll('.budget-line-item').forEach(item => {
        const cat = item.querySelector('input[type="text"]').value.trim();
        const amt = parseFloat(item.querySelector('input[type="number"]').value) || 0;
        if (cat && amt > 0) {
            items.push({ category: cat, amount: amt });
        }
    });

    if (items.length === 0) {
        showToast('Please add at least one budget line item', 'error');
        return;
    }

    const total = items.reduce((sum, item) => sum + item.amount, 0);

    const proposals = storage.getBudgetProposals();
    proposals.push({
        id: genId(),
        year,
        type,
        items,
        total,
        status: 'pending',
        submittedDate: new Date().toISOString()
    });

    storage.saveBudgetProposals(proposals);
    showToast('Budget proposal submitted for Group Conscience approval!', 'success');

    // Reset form
    document.getElementById('budget-line-items').innerHTML = '';
    document.getElementById('budget-year').value = '';
    updateBudgetTotal();

    renderBudgetProposals();
}

function renderBudgetProposals() {
    const proposals = storage.getBudgetProposals();
    const pending = proposals.filter(p => p.status === 'pending');
    const approved = proposals.filter(p => p.status === 'approved');

    const pendingList = document.getElementById('pending-budgets-list');
    if (pending.length === 0) {
        pendingList.innerHTML = '<p style="opacity: 0.7;">No pending budget proposals</p>';
    } else {
        pendingList.innerHTML = pending.map(p => `
            <div style="padding: 1rem; background: #2c3e50; border-radius: 4px; margin-bottom: 0.5rem;">
                <strong>${p.type === 'annual' ? 'Annual Budget' : p.type === 'amendment' ? 'Budget Amendment' : 'Special Project'} - FY ${p.year}</strong><br>
                <span style="font-size: 0.9rem;">Total: $${p.total.toFixed(2)}</span><br>
                <span style="font-size: 0.85rem; opacity: 0.8;">Submitted: ${new Date(p.submittedDate).toLocaleDateString()}</span>
                <div style="margin-top: 0.5rem;">
                    <button class="btn secondary" onclick="approveBudget('${p.id}')" style="font-size: 0.85rem;">Approve</button>
                    <button class="btn secondary" onclick="rejectBudget('${p.id}')" style="font-size: 0.85rem; background: #e74c3c; margin-left: 0.5rem;">Reject</button>
                </div>
            </div>
        `).join('');
    }

    const approvedList = document.getElementById('approved-budgets-list');
    if (approved.length === 0) {
        approvedList.innerHTML = '<p style="opacity: 0.7;">No approved budgets</p>';
    } else {
        approvedList.innerHTML = approved.map(p => `
            <div style="padding: 1rem; background: #27ae60; border-radius: 4px; margin-bottom: 0.5rem;">
                <strong>${p.type === 'annual' ? 'Annual Budget' : p.type === 'amendment' ? 'Budget Amendment' : 'Special Project'} - FY ${p.year}</strong><br>
                <span style="font-size: 0.9rem;">Total: $${p.total.toFixed(2)}</span>
            </div>
        `).join('');
    }
}

function approveBudget(id) {
    let proposals = storage.getBudgetProposals();
    const proposal = proposals.find(p => p.id === id);
    if (proposal) {
        proposal.status = 'approved';
        proposal.approvedDate = new Date().toISOString();
        storage.saveBudgetProposals(proposals);
        showToast('Budget approved!', 'success');
        renderBudgetProposals();
    }
}

function rejectBudget(id) {
    if (!confirm('Reject this budget proposal?')) return;
    let proposals = storage.getBudgetProposals();
    proposals = proposals.filter(p => p.id !== id);
    storage.saveBudgetProposals(proposals);
    showToast('Budget proposal rejected', 'info');
    renderBudgetProposals();
}

// ========== LITERATURE INVENTORY ==========
function saveLiteratureItem() {
    const editId = document.getElementById('lit-edit-id').value;
    if (editId) {
        updateLiteratureItem();
        return;
    }

    const name = document.getElementById('lit-item-name').value.trim();
    const type = document.getElementById('lit-item-type').value;
    const quantity = parseInt(document.getElementById('lit-quantity').value) || 0;
    const minQuantity = parseInt(document.getElementById('lit-min-quantity').value) || 0;
    const cost = parseFloat(document.getElementById('lit-cost').value) || 0;
    const loanable = document.getElementById('lit-loanable').checked;

    if (!name) {
        showToast('Please enter item name', 'error');
        return;
    }

    const inventory = storage.getLiteratureInventory();
    inventory.push({
        id: genId(),
        name,
        type,
        quantity,
        minQuantity,
        cost,
        loanable
    });

    storage.saveLiteratureInventory(inventory);
    showToast('Literature item added!', 'success');

    document.getElementById('lit-item-name').value = '';
    document.getElementById('lit-quantity').value = '';
    document.getElementById('lit-min-quantity').value = '';
    document.getElementById('lit-cost').value = '';
    document.getElementById('lit-loanable').checked = false;

    renderLiteratureInventory();
}

function renderLiteratureInventory() {
    const inventory = storage.getLiteratureInventory();
    const tbody = document.getElementById('literature-inventory-body');
    const alertsDiv = document.getElementById('lit-low-stock-alerts');

    if (inventory.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5">No items in inventory</td></tr>';
        alertsDiv.innerHTML = '<p style="opacity: 0.7;">No alerts</p>';
        return;
    }

    const lowStock = inventory.filter(item => item.quantity <= item.minQuantity);

    tbody.innerHTML = inventory.map(item => {
        const isLow = item.quantity <= item.minQuantity;
        const status = isLow ? 'Low Stock' : 'OK';
        const statusColor = isLow ? '#e74c3c' : '#2ecc71';

        return `
            <tr>
                <td>${escapeHtml(item.name)}</td>
                <td>${escapeHtml(item.type)}</td>
                <td>${item.quantity}</td>
                <td style="color: ${statusColor};">${status}</td>
                <td>
                    <button class="btn secondary" data-action="edit-lit-item" data-id="${escapeAttribute(item.id)}" style="font-size: 0.85rem;">Edit</button>
                    <button class="btn secondary" data-action="delete-lit-item" data-id="${escapeAttribute(item.id)}" style="font-size: 0.85rem; background: #e74c3c;">Delete</button>
                </td>
            </tr>
        `;
    }).join('');

    if (lowStock.length > 0) {
        alertsDiv.innerHTML = lowStock.map(item => `
            <div style="padding: 0.75rem; background: #e74c3c; border-radius: 4px; margin-bottom: 0.5rem;">
                <strong>${escapeHtml(item.name)}</strong> - Only ${item.quantity} left (min: ${item.minQuantity})
            </div>
        `).join('');
    } else {
        alertsDiv.innerHTML = '<p style="color: #2ecc71;">All items adequately stocked</p>';
    }

    // Update loan dropdowns
    updateLiteratureLoanDropdowns();
}

function updateLiteratureLoanDropdowns() {
    const inventory = storage.getLiteratureInventory().filter(item => item.loanable && item.quantity > 0);
    const loanItemSelect = document.getElementById('loan-item');

    loanItemSelect.innerHTML = '<option value="">-- Select Item --</option>' +
        inventory.map(item => `<option value="${escapeAttribute(item.id)}">${escapeHtml(item.name)} (${item.quantity} available)</option>`).join('');
}

function checkOutLiterature() {
    const memberId = document.getElementById('loan-member').value;
    const itemId = document.getElementById('loan-item').value;
    const dueDate = document.getElementById('loan-due-date').value;

    if (!memberId || !itemId || !dueDate) {
        showToast('Please fill all fields', 'error');
        return;
    }

    const members = storage.getMembers();
    const member = members.find(m => m.id === memberId);
    const inventory = storage.getLiteratureInventory();
    const item = inventory.find(i => i.id === itemId);

    if (!item || item.quantity < 1) {
        showToast('Item not available', 'error');
        return;
    }

    // Update inventory
    item.quantity--;
    storage.saveLiteratureInventory(inventory);

    // Create loan
    const loans = storage.getLiteratureLoans();
    loans.push({
        id: genId(),
        memberId,
        memberName: member.name,
        itemId,
        itemName: item.name,
        dueDate,
        checkoutDate: new Date().toISOString(),
        status: 'active'
    });

    storage.saveLiteratureLoans(loans);
    showToast(`Checked out to ${member.name}`, 'success');

    document.getElementById('loan-member').value = '';
    document.getElementById('loan-item').value = '';
    document.getElementById('loan-due-date').value = '';

    renderLiteratureLoans();
    renderLiteratureInventory();
}

function renderLiteratureLoans() {
    const loans = storage.getLiteratureLoans().filter(l => l.status === 'active');
    const tbody = document.getElementById('literature-loans-body');

    if (loans.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5">No active loans</td></tr>';
        return;
    }

    const now = new Date();
    tbody.innerHTML = loans.map(loan => {
        const dueDate = new Date(loan.dueDate);
        const isOverdue = dueDate < now;
        const status = isOverdue ? 'Overdue' : 'Active';
        const statusColor = isOverdue ? '#e74c3c' : '#2ecc71';

        return `
            <tr>
                <td>${escapeHtml(loan.memberName)}</td>
                <td>${escapeHtml(loan.itemName)}</td>
                <td>${dueDate.toLocaleDateString()}</td>
                <td style="color: ${statusColor};">${status}</td>
                <td>
                    <button class="btn secondary" onclick="returnLiterature('${escapeAttribute(loan.id)}')" style="font-size: 0.85rem;">Return</button>
                </td>
            </tr>
        `;
    }).join('');
}

function returnLiterature(loanId) {
    let loans = storage.getLiteratureLoans();
    const loan = loans.find(l => l.id === loanId);

    if (loan) {
        // Update inventory
        const inventory = storage.getLiteratureInventory();
        const item = inventory.find(i => i.id === loan.itemId);
        if (item) {
            item.quantity++;
            storage.saveLiteratureInventory(inventory);
        }

        // Mark loan as returned
        loan.status = 'returned';
        loan.returnDate = new Date().toISOString();
        storage.saveLiteratureLoans(loans);

        showToast('Literature returned', 'success');
        renderLiteratureLoans();
        renderLiteratureInventory();
    }
}

function submitLiteraturePurchaseRequest() {
    const items = document.getElementById('purchase-items').value.trim();
    const cost = parseFloat(document.getElementById('purchase-estimated-cost').value) || 0;

    if (!items) {
        showToast('Please describe items to purchase', 'error');
        return;
    }

    // Create a GC motion for literature purchase
    const logs = storage.getGroupConscienceLog();
    logs.push({
        id: genId(),
        date: new Date().toISOString().split('T')[0],
        item: `Motion to purchase literature: ${items} (Estimated cost: $${cost.toFixed(2)})`,
        submittedBy: storage.getCurrentUser(),
        status: 'pending',
        votesFor: 0,
        votesAgainst: 0,
        votesAbstain: 0,
        attendees: [],
        servantReports: []
    });

    storage.saveGroupConscienceLog(logs);
    showToast('Purchase request submitted to Group Conscience!', 'success');

    document.getElementById('purchase-items').value = '';
    document.getElementById('purchase-estimated-cost').value = '';
}

function editLiteratureItem(id) {
    const inventory = storage.getLiteratureInventory();
    const item = inventory.find(i => i.id === id);
    if (!item) return;

    document.getElementById('lit-edit-id').value = item.id;
    document.getElementById('lit-item-name').value = item.name;
    document.getElementById('lit-item-type').value = item.type;
    document.getElementById('lit-quantity').value = item.quantity;
    document.getElementById('lit-min-quantity').value = item.minQuantity;
    document.getElementById('lit-cost').value = item.cost;
    document.getElementById('lit-loanable').checked = item.loanable;

    document.getElementById('lit-form-btn').textContent = 'Update Item';
    document.getElementById('lit-form-cancel-btn').style.display = 'inline-block';
}

function updateLiteratureItem() {
    const id = document.getElementById('lit-edit-id').value;
    const name = document.getElementById('lit-item-name').value.trim();
    const type = document.getElementById('lit-item-type').value;
    const quantity = parseInt(document.getElementById('lit-quantity').value) || 0;
    const minQuantity = parseInt(document.getElementById('lit-min-quantity').value) || 0;
    const cost = parseFloat(document.getElementById('lit-cost').value) || 0;
    const loanable = document.getElementById('lit-loanable').checked;

    let inventory = storage.getLiteratureInventory();
    const index = inventory.findIndex(i => i.id === id);

    if (index > -1) {
        inventory[index] = { id, name, type, quantity, minQuantity, cost, loanable };
        storage.saveLiteratureInventory(inventory);
        showToast('Item updated!', 'success');
        cancelLitEdit();
        renderLiteratureInventory();
    }
}

function cancelLitEdit() {
    document.getElementById('lit-edit-id').value = '';
    document.getElementById('lit-item-name').value = '';
    document.getElementById('lit-quantity').value = '';
    document.getElementById('lit-min-quantity').value = '';
    document.getElementById('lit-cost').value = '';
    document.getElementById('lit-loanable').checked = false;
    document.getElementById('lit-form-btn').textContent = 'Add Item';
    document.getElementById('lit-form-cancel-btn').style.display = 'none';
}

function deleteLiteratureItem(id) {
    if (!confirm('Delete this item?')) return;
    let inventory = storage.getLiteratureInventory();
    inventory = inventory.filter(i => i.id !== id);
    storage.saveLiteratureInventory(inventory);
    showToast('Item deleted', 'info');
    renderLiteratureInventory();
}

// ========== DISTRICT MOTIONS ==========
function saveDistrictMotion() {
    const editId = document.getElementById('district-motion-edit-id').value;
    if (editId) {
        updateDistrictMotion();
        return;
    }

    const source = document.getElementById('district-motion-source').value;
    const title = document.getElementById('district-motion-title').value.trim();
    const text = document.getElementById('district-motion-text').value.trim();
    const deadline = document.getElementById('district-motion-deadline').value;
    const background = document.getElementById('district-motion-background').value.trim();

    if (!title || !text) {
        showToast('Please provide title and motion text', 'error');
        return;
    }

    const motions = storage.getDistrictMotions();
    motions.push({
        id: genId(),
        source,
        title,
        text,
        deadline,
        background,
        status: 'pending',
        createdDate: new Date().toISOString()
    });

    storage.saveDistrictMotions(motions);
    showToast('District/Area motion added!', 'success');

    document.getElementById('district-motion-title').value = '';
    document.getElementById('district-motion-text').value = '';
    document.getElementById('district-motion-deadline').value = '';
    document.getElementById('district-motion-background').value = '';

    renderDistrictMotions();
}

function renderDistrictMotions() {
    const motions = storage.getDistrictMotions();
    const pending = motions.filter(m => m.status === 'pending');
    const responded = motions.filter(m => m.status !== 'pending');

    const pendingList = document.getElementById('pending-district-motions-list');
    if (pending.length === 0) {
        pendingList.innerHTML = '<p style="opacity: 0.7;">No pending district/area motions</p>';
    } else {
        pendingList.innerHTML = pending.map(m => {
            const deadline = m.deadline ? new Date(m.deadline) : null;
            const isUrgent = deadline && (deadline - new Date()) < (7 * 24 * 60 * 60 * 1000);

            return `
                <div style="padding: 1rem; background: #2c3e50; border-radius: 4px; margin-bottom: 0.5rem; border-left: 4px solid ${isUrgent ? '#e74c3c' : '#3498db'};">
                    <strong style="color: ${isUrgent ? '#e74c3c' : '#3498db'};">${escapeHtml(m.title)}</strong>
                    <span style="background: #34495e; padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.75rem; margin-left: 0.5rem;">${escapeHtml(m.source)}</span>
                    <p style="margin-top: 0.5rem; font-size: 0.9rem;">${escapeHtml(m.text)}</p>
                    ${m.deadline ? `<div style="margin-top: 0.5rem; font-size: 0.85rem; opacity: 0.8;">Deadline: ${deadline.toLocaleDateString()}</div>` : ''}
                    ${m.background ? `<div style="margin-top: 0.5rem; font-size: 0.85rem; opacity: 0.8;">Background: ${escapeHtml(m.background)}</div>` : ''}
                </div>
            `;
        }).join('');
    }

    const historyList = document.getElementById('district-motions-history-list');
    if (responded.length === 0) {
        historyList.innerHTML = '<p style="opacity: 0.7;">No position history</p>';
    } else {
        historyList.innerHTML = responded.map(m => `
            <div style="padding: 0.75rem; background: #2c3e50; border-radius: 4px; margin-bottom: 0.5rem;">
                <strong>${escapeHtml(m.title)}</strong><br>
                <span style="font-size: 0.85rem; opacity: 0.8;">Position: ${escapeHtml(m.groupPosition || 'Unknown')}</span><br>
                <span style="font-size: 0.85rem; opacity: 0.8;">Date: ${new Date(m.positionDate).toLocaleDateString()}</span>
            </div>
        `).join('');
    }

    // Update position select dropdown
    const select = document.getElementById('position-motion-select');
    select.innerHTML = '<option value="">-- Select Motion --</option>' +
        pending.map(m => `<option value="${escapeAttribute(m.id)}">${escapeHtml(m.title)}</option>`).join('');
}

function recordGroupPosition() {
    const motionId = document.getElementById('position-motion-select').value;
    const position = document.getElementById('group-position').value;
    const rationale = document.getElementById('position-rationale').value.trim();
    const voteCount = document.getElementById('position-vote-count').value.trim();

    if (!motionId) {
        showToast('Please select a motion', 'error');
        return;
    }

    let motions = storage.getDistrictMotions();
    const motion = motions.find(m => m.id === motionId);

    if (motion) {
        motion.status = 'responded';
        motion.groupPosition = position;
        motion.rationale = rationale;
        motion.voteCount = voteCount;
        motion.positionDate = new Date().toISOString();

        storage.saveDistrictMotions(motions);
        showToast('Group position recorded!', 'success');

        // Reset form
        document.getElementById('position-motion-select').value = '';
        document.getElementById('position-rationale').value = '';
        document.getElementById('position-vote-count').value = '';

        renderDistrictMotions();
    }
}

function updateDistrictMotion() {
    const id = document.getElementById('district-motion-edit-id').value;
    const source = document.getElementById('district-motion-source').value;
    const title = document.getElementById('district-motion-title').value.trim();
    const text = document.getElementById('district-motion-text').value.trim();
    const deadline = document.getElementById('district-motion-deadline').value;
    const background = document.getElementById('district-motion-background').value.trim();

    let motions = storage.getDistrictMotions();
    const index = motions.findIndex(m => m.id === id);

    if (index > -1) {
        motions[index] = { ...motions[index], source, title, text, deadline, background };
        storage.saveDistrictMotions(motions);
        showToast('Motion updated!', 'success');
        cancelDistrictMotionEdit();
        renderDistrictMotions();
    }
}

function cancelDistrictMotionEdit() {
    document.getElementById('district-motion-edit-id').value = '';
    document.getElementById('district-motion-title').value = '';
    document.getElementById('district-motion-text').value = '';
    document.getElementById('district-motion-deadline').value = '';
    document.getElementById('district-motion-background').value = '';
    document.getElementById('district-motion-form-btn').textContent = 'Add Motion';
    document.getElementById('district-motion-cancel-btn').style.display = 'none';
}

// ========== ENHANCED FEATURES: QUORUM MANAGEMENT ==========
function saveQuorumRule() {
    const editId = document.getElementById('quorum-edit-id').value;
    if (editId) {
        updateQuorumRule();
        return;
    }

    const category = document.getElementById('quorum-category').value.trim();
    const percent = parseInt(document.getElementById('quorum-percent').value) || 50;
    const minCount = parseInt(document.getElementById('quorum-min-count').value) || 5;
    const description = document.getElementById('quorum-desc').value.trim();
    const allowProxy = document.getElementById('quorum-allow-proxy').checked;

    if (!category) {
        showToast('Please enter a category name', 'error');
        return;
    }

    const rules = storage.getQuorumRules();
    rules.push({
        id: genId(),
        category,
        quorumPercent: percent,
        quorumMin: minCount,
        description,
        allowProxy
    });

    storage.saveQuorumRules(rules);
    showToast('Quorum rule added!', 'success');

    document.getElementById('quorum-category').value = '';
    document.getElementById('quorum-percent').value = '';
    document.getElementById('quorum-min-count').value = '';
    document.getElementById('quorum-desc').value = '';
    document.getElementById('quorum-allow-proxy').checked = false;

    renderQuorumRules();
}

function renderQuorumRules() {
    const rules = storage.getQuorumRules();
    const tbody = document.getElementById('quorum-rules-body');
    const categorySelect = document.getElementById('live-quorum-category');

    if (rules.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4">No quorum rules defined</td></tr>';
        return;
    }

    tbody.innerHTML = rules.map(r => `
        <tr>
            <td><strong>${escapeHtml(r.category)}</strong><br><span style="font-size: 0.85rem; opacity: 0.8;">${escapeHtml(r.description)}</span></td>
            <td>${r.quorumPercent}% or ${r.quorumMin} min</td>
            <td>${r.allowProxy ? '<span style="color: #2ecc71;">✓ Yes</span>' : '<span style="opacity: 0.5;">No</span>'}</td>
            <td>
                <button class="btn secondary" onclick="editQuorumRule('${escapeAttribute(r.id)}')" style="font-size: 0.85rem;">Edit</button>
                <button class="btn secondary" onclick="deleteQuorumRule('${escapeAttribute(r.id)}')" style="font-size: 0.85rem; background: #e74c3c;">Delete</button>
            </td>
        </tr>
    `).join('');

    // Update category dropdown
    if (categorySelect) {
        categorySelect.innerHTML = '<option value="">-- Select Category --</option>' +
            rules.map(r => `<option value="${escapeAttribute(r.id)}">${escapeHtml(r.category)}</option>`).join('');
    }
}

function checkLiveQuorum() {
    const attendees = parseInt(document.getElementById('live-quorum-attendees').value) || 0;
    const ruleId = document.getElementById('live-quorum-category').value;
    const totalMembers = storage.getMembers().length;

    if (!ruleId || !attendees) {
        showToast('Please fill all fields', 'error');
        return;
    }

    const rules = storage.getQuorumRules();
    const rule = rules.find(r => r.id === ruleId);

    if (!rule) return;

    const requiredByPercent = Math.ceil((totalMembers * rule.quorumPercent) / 100);
    const required = Math.max(requiredByPercent, rule.quorumMin);
    const hasMet = attendees >= required;

    const resultDiv = document.getElementById('live-quorum-result');
    resultDiv.style.display = 'block';
    resultDiv.style.padding = '1rem';
    resultDiv.style.borderRadius = '6px';
    resultDiv.style.background = hasMet ? '#27ae60' : '#e74c3c';

    resultDiv.innerHTML = `
        <h4 style="margin-bottom: 0.5rem;">${hasMet ? '✓ Quorum MET' : '✗ Quorum NOT MET'}</h4>
        <p><strong>Category:</strong> ${escapeHtml(rule.category)}</p>
        <p><strong>Present:</strong> ${attendees} of ${totalMembers} members</p>
        <p><strong>Required:</strong> ${required} (${rule.quorumPercent}% or ${rule.quorumMin} minimum)</p>
        ${rule.allowProxy ? '<p style="color: #f1c40f;"><strong>Note:</strong> Proxy voting is allowed for this category</p>' : ''}
    `;
}

function editQuorumRule(id) {
    const rules = storage.getQuorumRules();
    const rule = rules.find(r => r.id === id);
    if (!rule) return;

    document.getElementById('quorum-edit-id').value = rule.id;
    document.getElementById('quorum-category').value = rule.category;
    document.getElementById('quorum-percent').value = rule.quorumPercent;
    document.getElementById('quorum-min-count').value = rule.quorumMin;
    document.getElementById('quorum-desc').value = rule.description;
    document.getElementById('quorum-allow-proxy').checked = rule.allowProxy;

    document.getElementById('quorum-form-btn').textContent = 'Update Rule';
    document.getElementById('quorum-cancel-btn').style.display = 'inline-block';
}

function updateQuorumRule() {
    const id = document.getElementById('quorum-edit-id').value;
    const category = document.getElementById('quorum-category').value.trim();
    const percent = parseInt(document.getElementById('quorum-percent').value) || 50;
    const minCount = parseInt(document.getElementById('quorum-min-count').value) || 5;
    const description = document.getElementById('quorum-desc').value.trim();
    const allowProxy = document.getElementById('quorum-allow-proxy').checked;

    let rules = storage.getQuorumRules();
    const index = rules.findIndex(r => r.id === id);

    if (index > -1) {
        rules[index] = { id, category, quorumPercent: percent, quorumMin: minCount, description, allowProxy };
        storage.saveQuorumRules(rules);
        showToast('Quorum rule updated!', 'success');
        cancelQuorumEdit();
        renderQuorumRules();
    }
}

function cancelQuorumEdit() {
    document.getElementById('quorum-edit-id').value = '';
    document.getElementById('quorum-category').value = '';
    document.getElementById('quorum-percent').value = '';
    document.getElementById('quorum-min-count').value = '';
    document.getElementById('quorum-desc').value = '';
    document.getElementById('quorum-allow-proxy').checked = false;
    document.getElementById('quorum-form-btn').textContent = 'Add Rule';
    document.getElementById('quorum-cancel-btn').style.display = 'none';
}

function deleteQuorumRule(id) {
    if (!confirm('Delete this quorum rule?')) return;
    let rules = storage.getQuorumRules();
    rules = rules.filter(r => r.id !== id);
    storage.saveQuorumRules(rules);
    showToast('Quorum rule deleted', 'info');
    renderQuorumRules();
}

// ========== MEETING MINUTES AUTO-GENERATION ==========
let currentMinutesData = null;

function generateMinutesFromGC() {
    const gcId = document.getElementById('minutes-gc-select').value;
    if (!gcId) {
        showToast('Please select a meeting', 'error');
        return;
    }

    const logs = storage.getGroupConscienceLog();
    const gc = logs.find(l => l.id === gcId);
    if (!gc) return;

    const secretary = document.getElementById('secretary-name').value || 'Secretary';

    // Auto-generate formatted minutes
    const minutes = {
        id: genId(),
        gcId: gc.id,
        date: gc.date,
        generatedDate: new Date().toISOString(),
        status: 'draft',
        content: {
            opening: `The ${new Date(gc.date).toLocaleDateString()} Group Conscience meeting was called to order.`,
            attendees: gc.attendees || [],
            attendeeCount: (gc.attendees || []).length,
            motions: [{
                item: gc.item,
                submittedBy: gc.submittedBy,
                votesFor: gc.votesFor || 0,
                votesAgainst: gc.votesAgainst || 0,
                votesAbstain: gc.votesAbstain || 0,
                status: gc.status,
                discussion: gc.discussion || ''
            }],
            servantReports: gc.servantReports || [],
            actionItems: [],
            closing: 'Meeting adjourned.',
            secretary
        }
    };

    currentMinutesData = minutes;
    renderMinutesPreview(minutes);
}

function renderMinutesPreview(minutes) {
    const preview = document.getElementById('minutes-preview');
    const date = new Date(minutes.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

    preview.innerHTML = `
        <div style="font-family: 'Times New Roman', serif; line-height: 1.6;">
            <h2 style="text-align: center; margin-bottom: 1.5rem;">MEETING MINUTES</h2>
            <h3 style="text-align: center; margin-bottom: 2rem;">${date}</h3>

            <p><strong>Opening:</strong> ${escapeHtml(minutes.content.opening)}</p>

            <h4 style="margin-top: 1.5rem;">Attendance</h4>
            <p>Members Present: ${minutes.content.attendeeCount}</p>

            <h4 style="margin-top: 1.5rem;">Motions & Decisions</h4>
            ${minutes.content.motions.map((m, idx) => `
                <div style="margin: 1rem 0; padding-left: 1rem; border-left: 3px solid #3498db;">
                    <p><strong>Motion ${idx + 1}:</strong> ${escapeHtml(m.item)}</p>
                    <p><strong>Submitted by:</strong> ${escapeHtml(m.submittedBy || 'Unknown')}</p>
                    <p><strong>Voting:</strong> For: ${m.votesFor}, Against: ${m.votesAgainst}, Abstain: ${m.votesAbstain}</p>
                    <p><strong>Result:</strong> <span style="color: ${m.status === 'approved' ? '#2ecc71' : m.status === 'rejected' ? '#e74c3c' : '#f39c12'};">${escapeHtml(m.status || 'Pending').toUpperCase()}</span></p>
                    ${m.discussion ? `<p><strong>Discussion:</strong> ${escapeHtml(m.discussion)}</p>` : ''}
                </div>
            `).join('')}

            ${minutes.content.servantReports && minutes.content.servantReports.length > 0 ? `
                <h4 style="margin-top: 1.5rem;">Trusted Servant Reports</h4>
                ${minutes.content.servantReports.map(r => `
                    <p><strong>${escapeHtml(r.position)}:</strong> ${escapeHtml(r.report)}</p>
                `).join('')}
            ` : ''}

            <p style="margin-top: 2rem;"><strong>Closing:</strong> ${escapeHtml(minutes.content.closing)}</p>

            <div style="margin-top: 3rem; border-top: 1px solid #95a5a6; padding-top: 1rem;">
                <p><strong>Minutes prepared by:</strong> ${escapeHtml(minutes.content.secretary)}</p>
                <p><strong>Status:</strong> ${minutes.status === 'approved' ? '<span style="color: #2ecc71;">APPROVED</span>' : '<span style="color: #f39c12;">DRAFT</span>'}</p>
                <p><strong>Generated:</strong> ${new Date(minutes.generatedDate).toLocaleString()}</p>
            </div>
        </div>
    `;
}

function saveMinutes() {
    if (!currentMinutesData) {
        showToast('No minutes to save', 'error');
        return;
    }

    const minutes = storage.getMeetingMinutes();
    minutes.push(currentMinutesData);
    storage.saveMeetingMinutes(minutes);

    showToast('Minutes saved as draft!', 'success');
    renderMinutesArchive();
}

function approveMinutes() {
    if (!currentMinutesData) {
        showToast('No minutes to approve', 'error');
        return;
    }

    if (!confirm('Mark these minutes as approved?')) return;

    currentMinutesData.status = 'approved';
    currentMinutesData.approvedDate = new Date().toISOString();

    const minutes = storage.getMeetingMinutes();
    const existingIndex = minutes.findIndex(m => m.id === currentMinutesData.id);

    if (existingIndex > -1) {
        minutes[existingIndex] = currentMinutesData;
    } else {
        minutes.push(currentMinutesData);
    }

    storage.saveMeetingMinutes(minutes);
    showToast('Minutes approved!', 'success');
    renderMinutesPreview(currentMinutesData);
    renderMinutesArchive();
}

function exportMinutesPDF() {
    if (!currentMinutesData) {
        showToast('No minutes to export', 'error');
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const minutes = currentMinutesData;
    const date = new Date(minutes.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

    let yPos = 20;

    // Title
    doc.setFontSize(18);
    doc.setFont(undefined, 'bold');
    doc.text('MEETING MINUTES', doc.internal.pageSize.width / 2, yPos, { align: 'center' });
    doc.setFont(undefined, 'normal');
    yPos += 15;

    // Meeting Info
    doc.setFontSize(12);
    doc.text(`Date: ${date}`, 14, yPos);
    yPos += 7;
    doc.text(`Group: ${minutes.content.groupName || 'AA Group'}`, 14, yPos);
    yPos += 7;
    doc.text(`Facilitator: ${minutes.content.facilitator || 'N/A'}`, 14, yPos);
    yPos += 10;

    // Opening
    doc.setFontSize(11);
    doc.setFont(undefined, 'bold');
    doc.text('Opening:', 14, yPos);
    doc.setFont(undefined, 'normal');
    yPos += 6;
    const openingLines = doc.splitTextToSize(minutes.content.opening, 180);
    doc.text(openingLines, 14, yPos);
    yPos += openingLines.length * 5 + 5;

    // Attendance
    doc.setFont(undefined, 'bold');
    doc.text('Attendance:', 14, yPos);
    doc.setFont(undefined, 'normal');
    yPos += 6;
    doc.text(`Members Present: ${minutes.content.attendeeCount}`, 14, yPos);
    yPos += 10;

    // Check if we need a new page
    if (yPos > 240) {
        doc.addPage();
        yPos = 20;
    }

    // Motions/Decisions
    if (minutes.content.motions && minutes.content.motions.length > 0) {
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text('Motions & Decisions:', 14, yPos);
        doc.setFont(undefined, 'normal');
        yPos += 8;

        const motionTableData = minutes.content.motions.map((m, idx) => [
            `${idx + 1}`,
            m.item.substring(0, 60) + (m.item.length > 60 ? '...' : ''),
            m.status.toUpperCase(),
            m.votes || 'N/A'
        ]);

        doc.autoTable({
            startY: yPos,
            head: [['#', 'Motion', 'Status', 'Votes']],
            body: motionTableData,
            theme: 'grid',
            headStyles: { fillColor: [52, 152, 219], textColor: 255 },
            styles: { fontSize: 9 },
            columnStyles: {
                0: { cellWidth: 10 },
                1: { cellWidth: 110 },
                2: { cellWidth: 30 },
                3: { cellWidth: 35 }
            }
        });

        yPos = doc.lastAutoTable.finalY + 10;
    }

    // Check if we need a new page
    if (yPos > 240) {
        doc.addPage();
        yPos = 20;
    }

    // Servant Reports
    if (minutes.content.servantReports && minutes.content.servantReports.length > 0) {
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text('Servant Reports:', 14, yPos);
        doc.setFont(undefined, 'normal');
        yPos += 8;

        minutes.content.servantReports.forEach(report => {
            if (yPos > 260) {
                doc.addPage();
                yPos = 20;
            }

            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text(`${report.position}:`, 14, yPos);
            doc.setFont(undefined, 'normal');
            yPos += 5;

            const reportLines = doc.splitTextToSize(report.report, 180);
            doc.text(reportLines, 14, yPos);
            yPos += reportLines.length * 4 + 5;
        });

        yPos += 5;
    }

    // Check if we need a new page
    if (yPos > 250) {
        doc.addPage();
        yPos = 20;
    }

    // Closing
    doc.setFontSize(11);
    doc.setFont(undefined, 'bold');
    doc.text('Closing:', 14, yPos);
    doc.setFont(undefined, 'normal');
    yPos += 6;
    const closingLines = doc.splitTextToSize(minutes.content.closing, 180);
    doc.text(closingLines, 14, yPos);
    yPos += closingLines.length * 5 + 10;

    // Footer info
    if (yPos > 240) {
        doc.addPage();
        yPos = 20;
    }

    doc.setFontSize(9);
    doc.text(`Minutes prepared by: ${minutes.content.secretary || 'N/A'}`, 14, yPos);
    yPos += 5;
    doc.text(`Status: ${minutes.status === 'approved' ? 'APPROVED' : 'DRAFT'}`, 14, yPos);
    yPos += 5;
    doc.text(`Generated: ${new Date(minutes.generatedDate).toLocaleString()}`, 14, yPos);

    // Page numbers
    const pageCount = doc.internal.getNumberOfPages();
    doc.setFontSize(9);
    doc.setTextColor(100, 100, 100);
    for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.text(`Page ${i} of ${pageCount}`, doc.internal.pageSize.width / 2, doc.internal.pageSize.height - 10, { align: 'center' });
    }

    const filename = `meeting-minutes-${new Date(minutes.date).toISOString().split('T')[0]}.pdf`;
    doc.save(filename);

    showToast('Meeting minutes exported to PDF successfully!', 'success');
}

function renderMinutesArchive() {
    const minutes = storage.getMeetingMinutes().sort((a, b) => new Date(b.date) - new Date(a.date));
    const list = document.getElementById('minutes-archive-list');

    if (minutes.length === 0) {
        list.innerHTML = '<p style="opacity: 0.7;">No minutes archived yet</p>';
        return;
    }

    list.innerHTML = minutes.map(m => `
        <div style="padding: 0.75rem; background: #2c3e50; border-radius: 4px; margin-bottom: 0.5rem; cursor: pointer;" onclick="loadMinutes('${escapeAttribute(m.id)}')">
            <strong>${new Date(m.date).toLocaleDateString()}</strong>
            <span style="background: ${m.status === 'approved' ? '#27ae60' : '#f39c12'}; padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.75rem; margin-left: 0.5rem;">${escapeHtml(m.status)}</span>
        </div>
    `).join('');
}

function loadMinutes(id) {
    const minutes = storage.getMeetingMinutes();
    const min = minutes.find(m => m.id === id);
    if (min) {
        currentMinutesData = min;
        renderMinutesPreview(min);
    }
}

function saveSecretarySettings() {
    const name = document.getElementById('secretary-name').value;
    const autoGen = document.getElementById('auto-generate-minutes').checked;

    localStorage.setItem('secretaryName', name);
    localStorage.setItem('autoGenerateMinutes', autoGen);

    showToast('Secretary settings saved!', 'success');
}

function populateMinutesGCSelect() {
    const logs = storage.getGroupConscienceLog().sort((a, b) => new Date(b.date) - new Date(a.date));
    const select = document.getElementById('minutes-gc-select');

    if (select) {
        select.innerHTML = '<option value="">-- Select Meeting --</option>' +
            logs.map(l => `<option value="${escapeAttribute(l.id)}">${new Date(l.date).toLocaleDateString()} - ${escapeHtml(l.item.substring(0, 50))}...</option>`).join('');
    }
}

// ========== PARTICIPATION ANALYTICS ==========
function renderParticipationAnalytics() {
    const logs = storage.getGroupConscienceLog();
    const members = storage.getMembers();

    // Calculate average GC attendance
    const recentLogs = logs.slice(-6);
    const avgAttendance = recentLogs.length > 0
        ? Math.round(recentLogs.reduce((sum, l) => sum + (l.attendees || []).length, 0) / recentLogs.length)
        : 0;

    // Calculate voting participation
    const totalVotes = logs.reduce((sum, l) => sum + (l.votesFor || 0) + (l.votesAgainst || 0) + (l.votesAbstain || 0), 0);
    const potentialVotes = logs.length * members.length;
    const votingParticipation = potentialVotes > 0 ? ((totalVotes / potentialVotes) * 100).toFixed(1) : 0;

    // Engagement score (simplified)
    const engagementScore = Math.min(100, Math.round((avgAttendance / Math.max(members.length, 1)) * 100));

    document.getElementById('avg-attendance').textContent = avgAttendance;
    document.getElementById('voting-participation').textContent = votingParticipation + '%';
    document.getElementById('avg-meeting-length').textContent = '90'; // Placeholder
    document.getElementById('engagement-score').textContent = engagementScore + '%';
}

// ========== DECISION IMPACT TRACKING ==========
function saveDecisionImpact() {
    const gcId = document.getElementById('impact-gc-motion').value;
    const months = parseInt(document.getElementById('impact-months').value) || 0;
    const achieved = document.getElementById('impact-achieved').value;
    const rating = parseInt(document.getElementById('impact-rating').value) || 3;
    const lessons = document.getElementById('impact-lessons').value.trim();

    if (!gcId) {
        showToast('Please select a motion', 'error');
        return;
    }

    const logs = storage.getGroupConscienceLog();
    const motion = logs.find(l => l.id === gcId);

    // Auto-categorize based on motion text
    const category = categorizeLesson(motion ? motion.item : '');

    const impacts = storage.getDecisionImpacts();
    impacts.push({
        id: genId(),
        gcId,
        motionText: motion ? motion.item : '',
        months,
        achieved,
        rating,
        lessons,
        category: category,
        assessmentDate: new Date().toISOString()
    });

    storage.saveDecisionImpacts(impacts);
    showToast('Impact assessment saved!', 'success');

    document.getElementById('impact-lessons').value = '';
    renderDecisionImpacts();
    searchLessonsLearned(); // Update institutional memory
}

function renderDecisionImpacts() {
    const impacts = storage.getDecisionImpacts().sort((a, b) => new Date(b.assessmentDate) - new Date(a.assessmentDate));
    const list = document.getElementById('impact-list');
    const insightsDiv = document.getElementById('decision-insights');

    // Safety check: ensure DOM elements exist
    if (!list || !insightsDiv) {
        return;
    }

    if (impacts.length === 0) {
        list.innerHTML = '<p style="opacity: 0.7;">No impact assessments yet</p>';
        return;
    }

    list.innerHTML = impacts.map(i => `
        <div style="padding: 1rem; background: #2c3e50; border-radius: 4px; margin-bottom: 0.5rem;">
            <p style="font-size: 0.9rem;"><strong>${escapeHtml(i.motionText)}</strong></p>
            <div style="margin-top: 0.5rem; font-size: 0.85rem;">
                <span style="color: ${i.achieved === 'yes' ? '#2ecc71' : i.achieved === 'no' ? '#e74c3c' : '#f39c12'};">
                    Goal: ${i.achieved === 'yes' ? '✓ Achieved' : i.achieved === 'no' ? '✗ Not Achieved' : '⊙ Partial'}
                </span>
                <span style="margin-left: 1rem;">Rating: ${'★'.repeat(i.rating)}${'☆'.repeat(5 - i.rating)}</span>
            </div>
            <p style="margin-top: 0.5rem; font-size: 0.85rem; opacity: 0.8;">${escapeHtml(i.lessons)}</p>
        </div>
    `).join('');

    // Calculate insights
    const avgRating = impacts.length > 0
        ? (impacts.reduce((sum, i) => sum + i.rating, 0) / impacts.length).toFixed(1)
        : 0;

    const achievedCount = impacts.filter(i => i.achieved === 'yes').length;

    insightsDiv.innerHTML = `
        <p><strong>Average Decision Rating:</strong> ${avgRating}/5 ★</p>
        <p><strong>Goals Fully Achieved:</strong> ${achievedCount} of ${impacts.length} (${impacts.length > 0 ? Math.round((achievedCount / impacts.length) * 100) : 0}%)</p>
        <p style="margin-top: 1rem; font-size: 0.9rem; opacity: 0.8;">Groups that track decision impacts tend to make better decisions over time.</p>
    `;
}

function populateImpactGCMotions() {
    const logs = storage.getGroupConscienceLog();
    const select = document.getElementById('impact-gc-motion');
    if (select) {
        select.innerHTML = '<option value="">-- Select Motion --</option>' +
            logs.map(l => {
                const date = new Date(l.date).toLocaleDateString();
                const preview = l.item.substring(0, 60) + (l.item.length > 60 ? '...' : '');
                return `<option value="${escapeAttribute(l.id)}" data-text="${escapeAttribute(l.item)}">${escapeHtml(date)} - ${escapeHtml(preview)}</option>`;
            }).join('');
    }
}

// ========== FINANCIAL HEALTH DASHBOARD ==========
function renderFinancialHealth() {
    // Calculate actual balance from financial data
    const balance = calculateCurrentBalance();
    const reserve = calculatePrudentReserveAmount();
    const health = calculateContributionHealth();

    document.getElementById('current-balance').textContent = '$' + balance.toFixed(2);
    document.getElementById('prudent-reserve').textContent = '$' + reserve.toFixed(2);
    document.getElementById('contribution-health').textContent = health.toFixed(0) + '%';
}

// Helper function to calculate current balance
function calculateCurrentBalance() {
    const expenses = storage.getExpenses();
    const chairpersonLogs = storage.getChairpersonLog();

    // Calculate total income from 7th tradition and orange can
    const totalIncome = chairpersonLogs.reduce((sum, log) => {
        return sum + (parseFloat(log.tradition) || 0) + (parseFloat(log.orangeCan) || 0);
    }, 0);

    // Calculate total expenses
    const totalExpenses = expenses.reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);

    // Return balance (income - expenses)
    return totalIncome - totalExpenses;
}

// Helper function to calculate prudent reserve amount (3 months of expenses)
function calculatePrudentReserveAmount() {
    const expenses = storage.getExpenses();
    const threeMonthsAgo = new Date();
    threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);

    const recentExpenses = expenses.filter(e => new Date(e.date) >= threeMonthsAgo);
    const avgMonthlyExpenses = recentExpenses.reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0) / 3;

    return avgMonthlyExpenses * 3; // 3 months prudent reserve
}

// Helper function to calculate contribution health percentage
function calculateContributionHealth() {
    const chairpersonLogs = storage.getChairpersonLog();
    if (chairpersonLogs.length === 0) return 0;

    // Get last 6 months of logs
    const sixMonthsAgo = new Date();
    sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
    const recentLogs = chairpersonLogs.filter(log => new Date(log.date) >= sixMonthsAgo);

    if (recentLogs.length === 0) return 0;

    // Calculate average contribution per meeting
    const avgContribution = recentLogs.reduce((sum, log) => {
        return sum + (parseFloat(log.tradition) || 0);
    }, 0) / recentLogs.length;

    // Assume healthy is $100 per meeting, calculate percentage
    const healthyTarget = 100;
    return Math.min(100, (avgContribution / healthyTarget) * 100);
}

function calculateAffordability() {
    const amount = parseFloat(document.getElementById('afford-amount').value) || 0;
    const category = document.getElementById('afford-category').value;
    const balance = calculateCurrentBalance();
    const reserve = calculatePrudentReserveAmount();

    let annualizedCost = amount;
    if (category === 'monthly') annualizedCost = amount * 12;
    if (category === 'annual') annualizedCost = amount;

    const afterExpense = balance - amount;
    const canAfford = afterExpense >= reserve;

    const result = document.getElementById('affordability-result');
    result.style.display = 'block';
    result.style.padding = '1rem';
    result.style.borderRadius = '6px';
    result.style.background = canAfford ? '#27ae60' : '#e74c3c';

    result.innerHTML = `
        <h4>${canAfford ? '✓ We CAN afford this' : '✗ We CANNOT afford this'}</h4>
        <p><strong>Current Balance:</strong> $${balance.toFixed(2)}</p>
        <p><strong>After Expense:</strong> $${afterExpense.toFixed(2)}</p>
        <p><strong>Prudent Reserve:</strong> $${reserve.toFixed(2)}</p>
        <p><strong>Remaining Above Reserve:</strong> $${Math.max(0, afterExpense - reserve).toFixed(2)}</p>
        ${!canAfford ? '<p style="color: #f1c40f; margin-top: 0.5rem;"><strong>Warning:</strong> This would put us below prudent reserve!</p>' : ''}
    `;
}

// ========== FINANCIAL PROJECTION SIMULATOR ==========
let projectionChart = null;

function runFinancialProjection() {
    const amount = parseFloat(document.getElementById('projection-amount').value) || 0;
    const type = document.getElementById('projection-type').value;
    const period = parseInt(document.getElementById('projection-period').value);
    const revenueType = document.getElementById('projection-revenue-type').value;
    const revenueAmount = parseFloat(document.getElementById('projection-revenue-amount').value) || 0;

    if (amount <= 0) {
        showToast('Please enter a valid amount', 'error');
        return;
    }

    // Get financial data from chairperson logs
    const logs = storage.getChairpersonLog();
    const recentLogs = logs.slice(-6); // Last 6 entries

    const avgContribution = recentLogs.length > 0
        ? recentLogs.reduce((sum, l) => sum + (parseFloat(l.seventhTradition) || 0), 0) / recentLogs.length
        : 100; // Default $100/meeting

    // Assume 4 meetings per month
    const monthlyIncome = avgContribution * 4;

    // Get current balance from actual financial data
    let currentBalance = calculateCurrentBalance();

    // Calculate projections
    const projections = [];
    let balance = currentBalance;

    for (let month = 0; month <= period; month++) {
        let monthlyExpense = 0;

        if (type === 'oneTime' && month === 0) {
            monthlyExpense = amount;
        } else if (type === 'monthly') {
            monthlyExpense = amount;
        } else if (type === 'annual') {
            monthlyExpense = month % 12 === 0 ? amount : 0;
        }

        // Calculate revenue change
        let monthlyRevenue = monthlyIncome;
        if (revenueType === 'increase') {
            monthlyRevenue += revenueAmount;
        } else if (revenueType === 'decrease') {
            monthlyRevenue -= revenueAmount;
        }

        balance = balance + monthlyRevenue - monthlyExpense;

        projections.push({
            month: month,
            balance: balance,
            revenue: monthlyRevenue,
            expense: monthlyExpense
        });
    }

    // Display summary
    const finalBalance = projections[projections.length - 1].balance;
    const totalExpense = projections.reduce((sum, p) => sum + p.expense, 0);
    const totalRevenue = projections.reduce((sum, p) => sum + p.revenue, 0);
    const prudentReserve = monthlyIncome * 3; // 3 months operating

    const summaryDiv = document.getElementById('projection-summary');
    summaryDiv.style.display = 'block';

    const belowReserve = finalBalance < prudentReserve;
    summaryDiv.style.borderLeft = `4px solid ${belowReserve ? '#e74c3c' : '#2ecc71'}`;

    summaryDiv.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; text-align: center;">
            <div>
                <div style="font-size: 1.5rem; font-weight: bold; color: ${finalBalance > currentBalance ? '#2ecc71' : '#e74c3c'};">
                    $${finalBalance.toFixed(2)}
                </div>
                <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.25rem;">Final Balance</div>
            </div>
            <div>
                <div style="font-size: 1.5rem; font-weight: bold; color: #3498db;">
                    $${totalRevenue.toFixed(2)}
                </div>
                <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.25rem;">Total Revenue</div>
            </div>
            <div>
                <div style="font-size: 1.5rem; font-weight: bold; color: #e74c3c;">
                    $${totalExpense.toFixed(2)}
                </div>
                <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.25rem;">Total Expense</div>
            </div>
            <div>
                <div style="font-size: 1.5rem; font-weight: bold; color: ${!belowReserve ? '#2ecc71' : '#f39c12'};">
                    ${!belowReserve ? '✓' : '⚠'}
                </div>
                <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.25rem;">Reserve Status</div>
            </div>
        </div>
        ${belowReserve ? `<p style="color: #f39c12; margin-top: 0.75rem; font-size: 0.85rem;"><strong>⚠ Warning:</strong> This decision would put the group below prudent reserve ($${prudentReserve.toFixed(2)}) by month ${projections.findIndex(p => p.balance < prudentReserve)}.</p>` : ''}
    `;

    // Render chart
    const chartCanvas = document.getElementById('projection-chart');
    chartCanvas.style.display = 'block';

    if (projectionChart) {
        projectionChart.destroy();
    }

    const ctx = chartCanvas.getContext('2d');
    projectionChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: projections.map(p => `Month ${p.month}`),
            datasets: [
                {
                    label: 'Projected Balance',
                    data: projections.map(p => p.balance),
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    tension: 0.3,
                    fill: true
                },
                {
                    label: 'Prudent Reserve',
                    data: projections.map(() => prudentReserve),
                    borderColor: '#2ecc71',
                    borderDash: [5, 5],
                    fill: false,
                    pointRadius: 0
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    labels: { color: '#ecf0f1' }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': $' + context.parsed.y.toFixed(2);
                        }
                    }
                }
            },
            scales: {
                x: {
                    ticks: { color: '#ecf0f1' },
                    grid: { color: 'rgba(127, 140, 141, 0.2)' }
                },
                y: {
                    ticks: {
                        color: '#ecf0f1',
                        callback: function(value) {
                            return '$' + value.toFixed(0);
                        }
                    },
                    grid: { color: 'rgba(127, 140, 141, 0.2)' }
                }
            }
        }
    });

    // Generate insights
    const insightsDiv = document.getElementById('projection-insights');
    const netChange = finalBalance - currentBalance;

    insightsDiv.innerHTML = `
        <h4 style="margin-bottom: 0.5rem;">Key Insights</h4>
        <ul style="list-style: none; padding: 0;">
            <li style="padding: 0.5rem; background: #34495e; margin-bottom: 0.5rem; border-radius: 4px;">
                <strong>Net Change:</strong> ${netChange >= 0 ? '+' : ''}$${netChange.toFixed(2)} over ${period} months
            </li>
            <li style="padding: 0.5rem; background: #34495e; margin-bottom: 0.5rem; border-radius: 4px;">
                <strong>Monthly Impact:</strong> ${type === 'monthly' ? `Ongoing -$${amount.toFixed(2)}/month` : type === 'oneTime' ? 'One-time expense' : `-$${amount.toFixed(2)}/year`}
            </li>
            <li style="padding: 0.5rem; background: #34495e; margin-bottom: 0.5rem; border-radius: 4px;">
                <strong>Reserve Cushion:</strong> ${!belowReserve ? `Maintains $${(finalBalance - prudentReserve).toFixed(2)} above reserve` : `Falls below reserve`}
            </li>
            ${revenueType !== 'none' ? `
            <li style="padding: 0.5rem; background: #34495e; margin-bottom: 0.5rem; border-radius: 4px;">
                <strong>Revenue Assumption:</strong> ${revenueType === 'increase' ? 'Increases' : 'Decreases'} by $${revenueAmount.toFixed(2)}/month
            </li>
            ` : ''}
        </ul>
        <p style="margin-top: 1rem; font-size: 0.85rem; opacity: 0.7; font-style: italic;">
            💡 These projections assume current contribution levels remain stable. Actual results may vary.
        </p>
    `;
}

// ========== INSTITUTIONAL MEMORY & LEARNING SYSTEM ==========
function categorizeLesson(motionText) {
    const text = motionText.toLowerCase();

    if (text.includes('budget') || text.includes('money') || text.includes('expense') || text.includes('contribution') || text.includes('financial') || text.includes('$')) {
        return 'financial';
    } else if (text.includes('service') || text.includes('gsr') || text.includes('secretary') || text.includes('treasurer') || text.includes('position')) {
        return 'service';
    } else if (text.includes('meeting') || text.includes('format') || text.includes('schedule') || text.includes('time')) {
        return 'meeting';
    } else if (text.includes('tradition') || text.includes('concept') || text.includes('warranty')) {
        return 'traditions';
    } else if (text.includes('fellowship') || text.includes('social') || text.includes('event')) {
        return 'fellowship';
    } else {
        return 'other';
    }
}

function searchLessonsLearned() {
    // Safety check: ensure DOM elements exist
    const searchInput = document.getElementById('memory-search');
    const categorySelect = document.getElementById('memory-category-filter');
    const ratingSelect = document.getElementById('memory-rating-filter');

    if (!searchInput || !categorySelect || !ratingSelect) {
        // DOM not ready yet, skip this call
        return;
    }

    const searchTerm = searchInput.value.toLowerCase();
    const categoryFilter = categorySelect.value;
    const ratingFilter = ratingSelect.value;

    let impacts = storage.getDecisionImpacts();

    // Apply filters
    if (searchTerm) {
        impacts = impacts.filter(i =>
            (i.motionText && i.motionText.toLowerCase().includes(searchTerm)) ||
            (i.lessons && i.lessons.toLowerCase().includes(searchTerm))
        );
    }

    if (categoryFilter) {
        impacts = impacts.filter(i => i.category === categoryFilter);
    }

    if (ratingFilter) {
        impacts = impacts.filter(i => i.rating === parseInt(ratingFilter));
    }

    // Sort by date (newest first)
    impacts.sort((a, b) => new Date(b.assessmentDate) - new Date(a.assessmentDate));

    // Render lessons list
    const listDiv = document.getElementById('lessons-list');

    // Safety check: ensure DOM element exists
    if (!listDiv) {
        return;
    }

    if (impacts.length === 0) {
        listDiv.innerHTML = '<p style="opacity: 0.7; text-align: center; padding: 2rem;">No lessons match your search criteria.</p>';
    } else {
        listDiv.innerHTML = impacts.map(i => {
            const date = new Date(i.assessmentDate).toLocaleDateString();
            const categoryColors = {
                financial: '#f39c12',
                service: '#3498db',
                meeting: '#9b59b6',
                fellowship: '#e74c3c',
                traditions: '#2ecc71',
                other: '#95a5a6'
            };

            return `
                <div style="padding: 1rem; background: #2c3e50; border-radius: 4px; margin-bottom: 0.75rem; border-left: 4px solid ${categoryColors[i.category] || '#95a5a6'};">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                        <span style="font-size: 0.75rem; background: ${categoryColors[i.category] || '#95a5a6'}; padding: 0.2rem 0.5rem; border-radius: 3px;">
                            ${i.category ? i.category.charAt(0).toUpperCase() + i.category.slice(1) : 'Other'}
                        </span>
                        <span style="font-size: 0.75rem; opacity: 0.7;">${date}</span>
                    </div>
                    <p style="font-size: 0.9rem; font-weight: bold; margin-bottom: 0.5rem;">${escapeHtml(i.motionText)}</p>
                    <div style="margin-bottom: 0.5rem;">
                        <span style="font-size: 0.85rem;">Rating: ${'★'.repeat(i.rating)}${'☆'.repeat(5 - i.rating)}</span>
                        <span style="margin-left: 1rem; font-size: 0.85rem; color: ${i.achieved === 'yes' ? '#2ecc71' : i.achieved === 'no' ? '#e74c3c' : '#f39c12'};">
                            ${i.achieved === 'yes' ? '✓ Achieved' : i.achieved === 'no' ? '✗ Not Achieved' : '⊙ Partial'}
                        </span>
                    </div>
                    <p style="font-size: 0.85rem; opacity: 0.9; font-style: italic; background: #34495e; padding: 0.5rem; border-radius: 3px; margin-top: 0.5rem;">
                        "${escapeHtml(i.lessons)}"
                    </p>
                </div>
            `;
        }).join('');
    }

    // Update stats
    updateMemoryStats();
    generatePatternInsights();
}

function updateMemoryStats() {
    // Safety check: ensure DOM elements exist
    const totalLessonsEl = document.getElementById('total-lessons');
    const avgRatingEl = document.getElementById('avg-lesson-rating');
    const commonCategoryEl = document.getElementById('common-category');

    if (!totalLessonsEl || !avgRatingEl || !commonCategoryEl) {
        // DOM not ready yet, skip this call
        return;
    }

    const impacts = storage.getDecisionImpacts();

    totalLessonsEl.textContent = impacts.length;

    const avgRating = impacts.length > 0
        ? (impacts.reduce((sum, i) => sum + i.rating, 0) / impacts.length).toFixed(1)
        : '--';
    avgRatingEl.textContent = avgRating;

    // Find most common category
    const categoryCounts = {};
    impacts.forEach(i => {
        const cat = i.category || 'other';
        categoryCounts[cat] = (categoryCounts[cat] || 0) + 1;
    });

    const mostCommon = Object.entries(categoryCounts).sort((a, b) => b[1] - a[1])[0];
    commonCategoryEl.textContent = mostCommon
        ? `${mostCommon[0].charAt(0).toUpperCase() + mostCommon[0].slice(1)} (${mostCommon[1]})`
        : '--';
}

function generatePatternInsights() {
    const impacts = storage.getDecisionImpacts();
    const insightsDiv = document.getElementById('pattern-insights');

    // Safety check: ensure DOM element exists
    if (!insightsDiv) {
        return;
    }

    if (impacts.length < 3) {
        insightsDiv.innerHTML = '<p style="opacity: 0.7;">Patterns will appear here once you have 3 or more lessons logged.</p>';
        return;
    }

    const patterns = [];

    // Pattern 1: Financial decision success rate
    const financialDecisions = impacts.filter(i => i.category === 'financial');
    if (financialDecisions.length >= 2) {
        const successRate = (financialDecisions.filter(i => i.achieved === 'yes').length / financialDecisions.length) * 100;
        patterns.push(`💰 Financial decisions have a ${successRate.toFixed(0)}% success rate (${financialDecisions.length} decisions tracked)`);
    }

    // Pattern 2: Service structure insights
    const serviceDecisions = impacts.filter(i => i.category === 'service');
    if (serviceDecisions.length >= 2) {
        const avgRating = serviceDecisions.reduce((sum, i) => sum + i.rating, 0) / serviceDecisions.length;
        patterns.push(`🤝 Service structure decisions average ${avgRating.toFixed(1)}/5 stars (${serviceDecisions.length} decisions)`);
    }

    // Pattern 3: High-rated decisions
    const highRatedDecisions = impacts.filter(i => i.rating >= 4);
    if (highRatedDecisions.length >= 2) {
        patterns.push(`⭐ ${highRatedDecisions.length} decisions rated 4+ stars - review their lessons for best practices`);
    }

    // Pattern 4: Low-rated decisions
    const lowRatedDecisions = impacts.filter(i => i.rating <= 2);
    if (lowRatedDecisions.length >= 1) {
        patterns.push(`⚠️ ${lowRatedDecisions.length} decision(s) rated 2 stars or lower - consider reviewing or reversing`);
    }

    // Pattern 5: Recent trend
    const recentDecisions = impacts.slice(-5);
    const recentAvgRating = recentDecisions.reduce((sum, i) => sum + i.rating, 0) / recentDecisions.length;
    const olderDecisions = impacts.slice(0, -5);
    if (olderDecisions.length > 0) {
        const olderAvgRating = olderDecisions.reduce((sum, i) => sum + i.rating, 0) / olderDecisions.length;
        if (recentAvgRating > olderAvgRating + 0.5) {
            patterns.push(`📈 Decision quality is improving! Recent avg: ${recentAvgRating.toFixed(1)} vs historical: ${olderAvgRating.toFixed(1)}`);
        } else if (recentAvgRating < olderAvgRating - 0.5) {
            patterns.push(`📉 Decision quality declining. Recent avg: ${recentAvgRating.toFixed(1)} vs historical: ${olderAvgRating.toFixed(1)}`);
        }
    }

    insightsDiv.innerHTML = patterns.length > 0
        ? '<ul style="list-style: none; padding: 0;">' +
          patterns.map(p => `<li style="padding: 0.5rem 0; border-bottom: 1px solid #34495e;">${p}</li>`).join('') +
          '</ul>'
        : '<p style="opacity: 0.7;">No significant patterns detected yet. Keep logging lessons to discover insights!</p>';
}

// ========== GROUP INVENTORY SCHEDULER ==========
function scheduleInventory() {
    const type = document.getElementById('inventory-type').value;
    const customName = document.getElementById('inventory-custom-name').value.trim();
    const date = document.getElementById('inventory-scheduled-date').value;
    const frequency = document.getElementById('inventory-frequency').value;
    const notes = document.getElementById('inventory-notes').value.trim();

    if (!date) {
        showToast('Please select a date', 'error');
        return;
    }

    const name = type === 'custom' ? customName : type;

    const schedules = storage.getInventorySchedules();
    schedules.push({
        id: genId(),
        type,
        name,
        scheduledDate: date,
        frequency,
        notes,
        status: 'scheduled',
        createdDate: new Date().toISOString()
    });

    storage.saveInventorySchedules(schedules);
    showToast('Inventory scheduled!', 'success');

    document.getElementById('inventory-notes').value = '';
    renderInventorySchedules();
}

function renderInventorySchedules() {
    const schedules = storage.getInventorySchedules();
    const upcoming = schedules.filter(s => s.status === 'scheduled' && new Date(s.scheduledDate) >= new Date());
    const completed = schedules.filter(s => s.status === 'completed');

    const upcomingList = document.getElementById('upcoming-inventories-list');
    const completedList = document.getElementById('completed-inventories-list');

    upcomingList.innerHTML = upcoming.length > 0
        ? upcoming.map(s => `
            <div style="padding: 0.75rem; background: #2c3e50; border-radius: 4px; margin-bottom: 0.5rem;">
                <strong>${escapeHtml(s.name)}</strong><br>
                <span style="font-size: 0.85rem;">Date: ${new Date(s.scheduledDate).toLocaleDateString()}</span><br>
                <span style="font-size: 0.85rem;">Frequency: ${escapeHtml(s.frequency)}</span>
                <div style="margin-top: 0.5rem;">
                    <button class="btn secondary" onclick="completeInventory('${escapeAttribute(s.id)}')" style="font-size: 0.85rem;">Mark Complete</button>
                </div>
            </div>
        `).join('')
        : '<p style="opacity: 0.7;">No upcoming inventories</p>';

    completedList.innerHTML = completed.length > 0
        ? completed.map(s => `
            <div style="padding: 0.75rem; background: #27ae60; border-radius: 4px; margin-bottom: 0.5rem;">
                <strong>${escapeHtml(s.name)}</strong><br>
                <span style="font-size: 0.85rem;">Completed: ${s.completedDate ? new Date(s.completedDate).toLocaleDateString() : 'N/A'}</span>
            </div>
        `).join('')
        : '<p style="opacity: 0.7;">No completed inventories</p>';
}

function completeInventory(id) {
    let schedules = storage.getInventorySchedules();
    const schedule = schedules.find(s => s.id === id);

    if (schedule) {
        schedule.status = 'completed';
        schedule.completedDate = new Date().toISOString();

        // If recurring, create next occurrence
        if (schedule.frequency !== 'once') {
            const nextDate = new Date(schedule.scheduledDate);
            switch (schedule.frequency) {
                case 'quarterly': nextDate.setMonth(nextDate.getMonth() + 3); break;
                case 'semiannual': nextDate.setMonth(nextDate.getMonth() + 6); break;
                case 'annual': nextDate.setFullYear(nextDate.getFullYear() + 1); break;
            }

            schedules.push({
                ...schedule,
                id: genId(),
                scheduledDate: nextDate.toISOString().split('T')[0],
                status: 'scheduled',
                createdDate: new Date().toISOString()
            });
        }

        storage.saveInventorySchedules(schedules);
        showToast('Inventory marked complete!', 'success');
        renderInventorySchedules();
    }
}

// ========== ROLE-BASED VIEWS ==========
function updateRoleView() {
    const role = document.getElementById('user-role-select').value;

    const benefits = {
        member: 'Standard view with all features',
        gsr: 'Prioritized district motions, GSR reports, and area information',
        treasurer: 'Financial dashboard, expense tracking, and budget tools highlighted',
        secretary: 'Quick access to minutes, attendance, and meeting logs',
        chairperson: 'Meeting management tools, parliamentary procedure, and agenda building',
        literature: 'Literature inventory, loans, and purchase requests prioritized'
    };

    document.getElementById('role-benefits').innerHTML = `<p>${benefits[role]}</p>`;
}

function saveUserRole() {
    const role = document.getElementById('user-role-select').value;
    storage.saveUserRole(role);
    showToast(`Role set to ${role}!`, 'success');
}

function showDashboard(role) {
    const dashboardDiv = document.getElementById('role-dashboard');
    const titleEl = document.getElementById('dashboard-title');
    const contentEl = document.getElementById('dashboard-content');

    dashboardDiv.style.display = 'block';

    const dashboards = {
        gsr: {
            title: 'GSR Dashboard',
            content: `
                <h4>District Motions Pending Response</h4>
                <div id="gsr-district-motions"></div>
                <h4 class="mt-3">Upcoming Area Events</h4>
                <p>Area Assembly: [Date TBD]</p>
                <h4 class="mt-3">Quick Actions</h4>
                <button class="btn" onclick="goToSection('district-motions-section')">Manage District Motions</button>
            `
        },
        treasurer: {
            title: 'Treasurer Dashboard',
            content: `
                <h4>Financial Summary</h4>
                <p><strong>Current Balance:</strong> $[Amount]</p>
                <p><strong>Prudent Reserve:</strong> $[Amount]</p>
                <h4 class="mt-3">Pending Expenses</h4>
                <p>Review pending expenses in Finance section</p>
                <h4 class="mt-3">Quick Actions</h4>
                <button class="btn" onclick="goToSection('finance-section')">View Finances</button>
                <button class="btn secondary ml-2" onclick="goToSection('financial-health-section')">Financial Health</button>
            `
        },
        secretary: {
            title: 'Secretary Dashboard',
            content: `
                <h4>Recent Meetings</h4>
                <p>Last GC: [Date]</p>
                <p>Draft Minutes: [Count]</p>
                <h4 class="mt-3">Quick Actions</h4>
                <button class="btn" onclick="goToSection('meeting-minutes-section')">Manage Minutes</button>
                <button class="btn secondary ml-2" onclick="goToSection('chairperson-section')">Attendance Logs</button>
            `
        },
        chairperson: {
            title: 'Chairperson Dashboard',
            content: `
                <h4>Next Meeting Preparation</h4>
                <p>Tabled items: [Count]</p>
                <p>Proposed agenda items: [Count]</p>
                <h4 class="mt-3">Quick Actions</h4>
                <button class="btn" onclick="goToSection('parliamentary-section')">Parliamentary Tools</button>
                <button class="btn secondary ml-2" onclick="goToSection('gc-live-section')">Live GC Session</button>
            `
        }
    };

    const dashboard = dashboards[role] || { title: 'Dashboard', content: '<p>Select a role to view dashboard</p>' };
    titleEl.textContent = dashboard.title;
    contentEl.innerHTML = dashboard.content;
}

// ========== PRIVACY & ANONYMITY PROTECTION ==========
function savePrivacySettings() {
    const anonymousVoting = document.getElementById('privacy-anonymous-voting');
    const hideNames = document.getElementById('privacy-hide-names-export');
    const encryptSensitive = document.getElementById('privacy-encrypt-sensitive');
    const redactLastnames = document.getElementById('privacy-redact-lastnames');

    const settings = {
        anonymousVoting: anonymousVoting ? anonymousVoting.checked : false,
        hideNamesInExports: hideNames ? hideNames.checked : false,
        encryptSensitive: encryptSensitive ? encryptSensitive.checked : false,
        autoRedactLastNames: redactLastnames ? redactLastnames.checked : false
    };
    storage.savePrivacySettings(settings);
    showToast('Privacy settings saved!', 'success');
}

function loadPrivacySettings() {
    const settings = storage.getPrivacySettings();

    const anonymousVoting = document.getElementById('privacy-anonymous-voting');
    if (anonymousVoting) anonymousVoting.checked = settings.anonymousVoting || false;

    const hideNames = document.getElementById('privacy-hide-names-export');
    if (hideNames) hideNames.checked = settings.hideNamesInExports || false;

    const encryptSensitive = document.getElementById('privacy-encrypt-sensitive');
    if (encryptSensitive) encryptSensitive.checked = settings.encryptSensitive || false;

    const redactLastnames = document.getElementById('privacy-redact-lastnames');
    if (redactLastnames) redactLastnames.checked = settings.autoRedactLastNames || false;
}

function redactName(fullName) {
    const settings = storage.getPrivacySettings();
    if (!settings.autoRedactLastNames) return fullName;

    const parts = fullName.trim().split(' ');
    if (parts.length === 1) return fullName;

    const firstName = parts[0];
    const lastInitial = parts[parts.length - 1].charAt(0);
    return `${firstName} ${lastInitial}.`;
}

// ========== TRADITION MOMENTS ==========
const traditions = [
    { num: 1, text: "Our common welfare should come first; personal recovery depends upon A.A. unity." },
    { num: 2, text: "For our group purpose there is but one ultimate authority—a loving God as He may express Himself in our group conscience. Our leaders are but trusted servants; they do not govern." },
    { num: 3, text: "The only requirement for A.A. membership is a desire to stop drinking." },
    { num: 4, text: "Each group should be autonomous except in matters affecting other groups or A.A. as a whole." },
    { num: 5, text: "Each group has but one primary purpose—to carry its message to the alcoholic who still suffers." },
    { num: 6, text: "An A.A. group ought never endorse, finance, or lend the A.A. name to any related facility or outside enterprise, lest problems of money, property, and prestige divert us from our primary purpose." },
    { num: 7, text: "Every A.A. group ought to be fully self-supporting, declining outside contributions." },
    { num: 8, text: "Alcoholics Anonymous should remain forever nonprofessional, but our service centers may employ special workers." },
    { num: 9, text: "A.A., as such, ought never be organized; but we may create service boards or committees directly responsible to those they serve." },
    { num: 10, text: "Alcoholics Anonymous has no opinion on outside issues; hence the A.A. name ought never be drawn into public controversy." },
    { num: 11, text: "Our public relations policy is based on attraction rather than promotion; we need always maintain personal anonymity at the level of press, radio, and films." },
    { num: 12, text: "Anonymity is the spiritual foundation of all our Traditions, ever reminding us to place principles before personalities." }
];

function displayTraditionOfDay() {
    const element = document.getElementById('tradition-of-day-display');
    if (!element) return;

    const todayData = storage.getTraditionOfDay();
    const today = new Date().toDateString();

    let traditionNum;
    if (todayData.date !== today) {
        // New day - pick random tradition
        traditionNum = Math.floor(Math.random() * 12) + 1;
        storage.saveTraditionOfDay({ tradition: traditionNum, date: today });
    } else {
        traditionNum = todayData.tradition;
    }

    const tradition = traditions[traditionNum - 1];
    element.innerHTML = `
        <h4 style="color: white; font-size: 1.5rem;">Tradition ${tradition.num}</h4>
        <p style="margin-top: 1rem; line-height: 1.6;">${tradition.text}</p>
    `;
}

function randomizeTradition() {
    const element = document.getElementById('tradition-of-day-display');
    if (!element) return;

    const randomNum = Math.floor(Math.random() * 12) + 1;
    const tradition = traditions[randomNum - 1];
    element.innerHTML = `
        <h4 style="color: white; font-size: 1.5rem;">Tradition ${tradition.num}</h4>
        <p style="margin-top: 1rem; line-height: 1.6;">${tradition.text}</p>
    `;
}

function checkTraditionViolations(motionText) {
    const warnings = [];
    const lowerText = motionText.toLowerCase();

    // Tradition 6 - Outside enterprises
    if (lowerText.match(/endorse|endorsement|affiliation|affiliate|lend.*name|partnership/)) {
        warnings.push({
            tradition: 6,
            severity: 'high',
            message: 'This motion may involve endorsement or affiliation with an outside entity (Tradition 6)'
        });
    }

    // Tradition 7 - Self-supporting
    if (lowerText.match(/outside contribution|outside donation|accept.*from|grant|sponsor(ship)?.*from/)) {
        warnings.push({
            tradition: 7,
            severity: 'high',
            message: 'This motion may involve accepting outside contributions (Tradition 7)'
        });
    }

    // Tradition 10 - Outside issues
    if (lowerText.match(/politic|religious|controversial|public.*issue|government/)) {
        warnings.push({
            tradition: 10,
            severity: 'medium',
            message: 'This motion may involve outside issues or public controversy (Tradition 10)'
        });
    }

    // Tradition 12 - Anonymity
    if (lowerText.match(/public.*announcement|press release|media|newspaper|full name.*public/)) {
        warnings.push({
            tradition: 12,
            severity: 'medium',
            message: 'This motion may compromise member anonymity (Tradition 12)'
        });
    }

    return warnings;
}

// ========== SPIRITUAL PRINCIPLES INTEGRATION ==========
function saveSpiritualPrincipleTags() {
    const motionSelect = document.getElementById('principle-motion-select');
    if (!motionSelect) return;

    const motionId = motionSelect.value;
    if (!motionId) {
        showToast('Please select a motion', 'error');
        return;
    }

    const checkboxes = document.querySelectorAll('.principle-checkbox:checked');
    const principles = Array.from(checkboxes).map(cb => cb.value);

    if (principles.length === 0) {
        showToast('Please select at least one principle', 'error');
        return;
    }

    const logs = storage.getGroupConscienceLog();
    const motion = logs.find(l => l.id === motionId);

    const principleData = storage.getSpiritualPrinciples();
    principleData.push({
        id: genId(),
        motionId,
        motionText: motion ? motion.item : '',
        principles,
        date: new Date().toISOString()
    });

    storage.saveSpiritualPrinciples(principleData);
    showToast('Spiritual principles tagged!', 'success');

    // Clear checkboxes
    checkboxes.forEach(cb => cb.checked = false);
    renderPrincipleTaggedList();
}

function renderPrincipleTaggedList() {
    const list = document.getElementById('principle-tagged-list');
    if (!list) return;

    const principleData = storage.getSpiritualPrinciples().sort((a, b) => new Date(b.date) - new Date(a.date));

    if (principleData.length === 0) {
        list.innerHTML = '<p style="opacity: 0.7;">No tagged motions yet</p>';
        return;
    }

    list.innerHTML = principleData.map(p => `
        <div style="padding: 1rem; background: #34495e; border-radius: 4px; margin-bottom: 0.5rem;">
            <p style="font-size: 0.9rem;"><strong>${escapeHtml(p.motionText.substring(0, 80))}${p.motionText.length > 80 ? '...' : ''}</strong></p>
            <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                ${p.principles.map(pr => `<span style="background: #3498db; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem;">${pr}</span>`).join('')}
            </div>
        </div>
    `).join('');
}

function populatePrincipleMotionSelect() {
    const logs = storage.getGroupConscienceLog();
    const select = document.getElementById('principle-motion-select');
    if (select) {
        select.innerHTML = '<option value="">-- Select Motion --</option>' +
            logs.map(l => {
                const date = new Date(l.date).toLocaleDateString();
                const preview = l.item.substring(0, 60) + (l.item.length > 60 ? '...' : '');
                return `<option value="${escapeAttribute(l.id)}">${escapeHtml(date)} - ${escapeHtml(preview)}</option>`;
            }).join('');
    }
}

function startGroupInventory() {
    const questionsDiv = document.getElementById('group-inventory-questions');
    if (!questionsDiv) return;

    if (questionsDiv.style.display === 'none') {
        questionsDiv.style.display = 'block';
    } else {
        questionsDiv.style.display = 'none';
    }
}

// ========== UNITY CHECKER ==========
function saveMinorityOpinion() {
    const motionSelect = document.getElementById('minority-motion-select');
    const opinionTextEl = document.getElementById('minority-opinion-text');
    const voteCountEl = document.getElementById('minority-vote-count');

    if (!motionSelect || !opinionTextEl || !voteCountEl) return;

    const motionId = motionSelect.value;
    const opinionText = opinionTextEl.value.trim();
    const voteCount = parseInt(voteCountEl.value) || 0;

    if (!motionId || !opinionText) {
        showToast('Please select a motion and enter the minority opinion', 'error');
        return;
    }

    const logs = storage.getGroupConscienceLog();
    const motion = logs.find(l => l.id === motionId);

    const opinions = storage.getMinorityOpinions();
    opinions.push({
        id: genId(),
        motionId,
        motionText: motion ? motion.item : '',
        opinion: opinionText,
        voteCount,
        date: new Date().toISOString()
    });

    storage.saveMinorityOpinions(opinions);
    showToast('Minority opinion recorded!', 'success');

    opinionTextEl.value = '';
    voteCountEl.value = '';
    renderMinorityOpinions();
}

function renderMinorityOpinions() {
    const list = document.getElementById('minority-opinions-list');
    if (!list) return;

    const opinions = storage.getMinorityOpinions().sort((a, b) => new Date(b.date) - new Date(a.date));

    if (opinions.length === 0) {
        list.innerHTML = '<p style="opacity: 0.7;">No minority opinions recorded yet</p>';
        return;
    }

    list.innerHTML = opinions.map(o => `
        <div style="padding: 1rem; background: #34495e; border-radius: 4px; margin-bottom: 0.5rem; border-left: 3px solid #f39c12;">
            <p style="font-size: 0.85rem; opacity: 0.8;">${new Date(o.date).toLocaleDateString()}</p>
            <p style="font-size: 0.9rem; margin-top: 0.5rem;"><strong>${escapeHtml(o.motionText.substring(0, 60))}${o.motionText.length > 60 ? '...' : ''}</strong></p>
            <p style="font-size: 0.9rem; margin-top: 0.5rem;">${escapeHtml(o.opinion)}</p>
            <p style="font-size: 0.85rem; margin-top: 0.5rem; opacity: 0.8;">Minority count: ${o.voteCount}</p>
        </div>
    `).join('');
}

function populateMinorityMotionSelect() {
    const logs = storage.getGroupConscienceLog();
    const select = document.getElementById('minority-motion-select');
    if (select) {
        select.innerHTML = '<option value="">-- Select Motion --</option>' +
            logs.map(l => {
                const date = new Date(l.date).toLocaleDateString();
                const preview = l.item.substring(0, 60) + (l.item.length > 60 ? '...' : '');
                return `<option value="${escapeAttribute(l.id)}">${escapeHtml(date)} - ${escapeHtml(preview)}</option>`;
            }).join('');
    }
}

function tableCurrentMotion() {
    const liveItems = storage.getLiveGCItems();
    if (liveItems.length === 0) {
        showToast('No current motion to table', 'info');
        return;
    }

    const currentItem = liveItems[0];
    if (confirm(`Table this motion for future discussion?\n\n"${currentItem.item}"`)) {
        // Move to proposed agenda for next meeting
        const proposedItems = storage.getProposedAgendaItems();
        proposedItems.push({
            id: genId(),
            item: currentItem.item + ' (Tabled for further discussion)',
            proposedBy: 'Group',
            date: new Date().toISOString(),
            priority: 'high'
        });
        storage.saveProposedAgendaItems(proposedItems);

        // Remove from live items
        liveItems.shift();
        storage.saveLiveGCItems(liveItems);

        showToast('Motion tabled - added to next meeting agenda', 'success');
        updateLiveGCTable();
        updateProposedAgendaTable();
    }
}

function formCommittee() {
    const committeeName = prompt('Enter committee name/purpose:');
    if (!committeeName) return;

    showToast(`Ad hoc committee formed: ${committeeName}\nAdd members via Service Positions section`, 'success');
}

function openCommonGroundDialog() {
    alert('Common Ground Exercise:\n\n1. What do we all agree on?\n2. What is our shared goal?\n3. What are we trying to accomplish?\n4. Can we find a middle path?\n\nDiscuss these questions to find unity.');
}

// ========== SERVICE STRUCTURE VISUALIZER ==========
function saveServiceStructure() {
    const groupName = document.getElementById('structure-group-name');
    const district = document.getElementById('structure-district');
    const area = document.getElementById('structure-area');
    const gsrName = document.getElementById('structure-gsr-name');

    const structure = {
        group: {
            name: groupName ? groupName.value.trim() : '',
            district: district ? district.value.trim() : '',
            area: area ? area.value.trim() : '',
            gsrName: gsrName ? gsrName.value.trim() : ''
        }
    };

    storage.saveServiceStructure(structure);
    showToast('Service structure information saved!', 'success');
}

function loadServiceStructure() {
    const structure = storage.getServiceStructure();
    if (structure.group) {
        if (document.getElementById('structure-group-name')) {
            document.getElementById('structure-group-name').value = structure.group.name || '';
        }
        if (document.getElementById('structure-district')) {
            document.getElementById('structure-district').value = structure.group.district || '';
        }
        if (document.getElementById('structure-area')) {
            document.getElementById('structure-area').value = structure.group.area || '';
        }
        if (document.getElementById('structure-gsr-name')) {
            document.getElementById('structure-gsr-name').value = structure.group.gsrName || '';
        }
    }
}

// ========== HELPER FUNCTIONS FOR DROPDOWNS ==========
function populateElectionPositions() {
    const positions = storage.getGroupPositions();
    const select = document.getElementById('election-position');
    if (select) {
        select.innerHTML = '<option value="">-- Select Position --</option>' +
            positions.map(p => `<option value="${escapeAttribute(p.id)}">${escapeHtml(p.title)}</option>`).join('');
    }

    const nomineeSelect = document.getElementById('nominee-select');
    if (nomineeSelect) {
        const members = storage.getMembers();
        nomineeSelect.innerHTML = '<option value="">-- Select Member --</option>' +
            members.map(m => `<option value="${escapeAttribute(m.id)}">${escapeHtml(m.name)}</option>`).join('');
    }
}

function populateSpeakersDropdown() {
    const members = storage.getMembers();
    const select = document.getElementById('speaker-name');
    if (select) {
        select.innerHTML = '<option value="">-- Select Member --</option>' +
            members.map(m => `<option value="${escapeHtml(m.name)}">${escapeHtml(m.name)}</option>`).join('');
    }
}

function populateLiteratureLoanMembers() {
    const members = storage.getMembers();
    const select = document.getElementById('loan-member');
    if (select) {
        select.innerHTML = '<option value="">-- Select Member --</option>' +
            members.map(m => `<option value="${escapeAttribute(m.id)}">${escapeHtml(m.name)}</option>`).join('');
    }
}

// ========== NEW FEATURES: 10 HIGH-PRIORITY GC ENHANCEMENTS ==========

// FEATURE 1: Standing/Recurring Agenda Items
function addStandingAgendaItem() {
    const title = document.getElementById('standing-item-title').value.trim();
    const frequency = document.getElementById('standing-item-frequency').value;
    const time = parseInt(document.getElementById('standing-item-time').value) || 10;
    const assignee = document.getElementById('standing-item-assignee').value;
    const consent = document.getElementById('standing-item-consent').value;
    const description = document.getElementById('standing-item-description').value.trim();

    if (!title) {
        showToast('Please enter item title', 'error');
        return;
    }

    const items = storage.getStandingAgendaItems();
    items.push({
        id: genId(),
        title,
        frequency,
        time,
        assignee,
        consent,
        description,
        active: true,
        created: new Date().toISOString()
    });

    storage.saveStandingAgendaItems(items);
    document.getElementById('standing-item-title').value = '';
    document.getElementById('standing-item-description').value = '';
    refreshStandingItems();
    showToast('Standing item added successfully', 'success');
}

function refreshStandingItems() {
    const items = storage.getStandingAgendaItems();
    const tbody = document.getElementById('standing-items-body');
    if (!tbody) return;

    tbody.innerHTML = items.map(item => `
        <tr>
            <td>${escapeHtml(item.title)}</td>
            <td>${escapeHtml(item.frequency)}</td>
            <td>${escapeHtml(item.assignee || 'None')}</td>
            <td>${item.time} min</td>
            <td>${item.consent === 'yes' ? '<span style="color: #2ecc71;">Yes</span>' : 'No'}</td>
            <td><span style="color: ${item.active ? '#2ecc71' : '#95a5a6'};">${item.active ? 'Active' : 'Inactive'}</span></td>
            <td>
                <button class="btn small" onclick="toggleStandingItem('${item.id}')" style="background: #3498db;">
                    ${item.active ? 'Deactivate' : 'Activate'}
                </button>
                <button class="btn small" onclick="deleteStandingItem('${item.id}')" style="background: #e74c3c;">Delete</button>
            </td>
        </tr>
    `).join('');
}

function toggleStandingItem(id) {
    const items = storage.getStandingAgendaItems();
    const item = items.find(i => i.id === id);
    if (item) {
        item.active = !item.active;
        storage.saveStandingAgendaItems(items);
        refreshStandingItems();
    }
}

function deleteStandingItem(id) {
    if (!confirm('Delete this standing item?')) return;
    const items = storage.getStandingAgendaItems().filter(i => i.id !== id);
    storage.saveStandingAgendaItems(items);
    refreshStandingItems();
    showToast('Standing item deleted', 'success');
}

// FEATURE 2 & 3: Motion Amendments and Tabling
let currentAmendments = [];

function addAmendment() {
    const text = document.getElementById('amendment-text').value.trim();
    const type = document.getElementById('amendment-type').value;
    const proposer = document.getElementById('amendment-proposer').value.trim();
    const status = document.getElementById('amendment-status').value;

    if (!text) {
        showToast('Please enter amendment text', 'error');
        return;
    }

    currentAmendments.push({
        id: genId(),
        text,
        type,
        proposer,
        status,
        timestamp: new Date().toISOString()
    });

    document.getElementById('amendment-text').value = '';
    updateAmendmentsList();
    showToast('Amendment added', 'success');
}

function updateAmendmentsList() {
    const list = document.getElementById('amendments-list');
    if (!list) return;

    list.innerHTML = currentAmendments.map((a, idx) => `
        <div style="padding: 0.75rem; background: #2c3e50; border-radius: 4px; margin-bottom: 0.5rem; border-left: 3px solid ${a.type === 'friendly' ? '#2ecc71' : '#e74c3c'};">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div style="flex: 1;">
                    <div style="font-size: 0.85rem; opacity: 0.7; margin-bottom: 0.25rem;">
                        Amendment #${idx + 1} - ${a.type === 'friendly' ? 'Friendly' : 'Unfriendly'} - ${a.status}
                    </div>
                    <div>${escapeHtml(a.text)}</div>
                    <div style="font-size: 0.75rem; opacity: 0.7; margin-top: 0.25rem;">
                        Proposed by: ${escapeHtml(a.proposer || 'Unknown')}
                    </div>
                </div>
                <button class="btn small" onclick="removeAmendment(${idx})" style="background: #e74c3c; margin-left: 1rem;">Remove</button>
            </div>
        </div>
    `).join('');

    document.getElementById('gc-amendments-data').value = JSON.stringify(currentAmendments);
}

function removeAmendment(index) {
    currentAmendments.splice(index, 1);
    updateAmendmentsList();
}

// FEATURE 5: Discussion Thread System
let currentDiscussions = [];

function addDiscussionComment() {
    const comment = document.getElementById('discussion-comment').value.trim();
    const author = document.getElementById('discussion-author').value;
    const type = document.getElementById('discussion-type').value;

    if (!comment || !author) {
        showToast('Please fill in all fields', 'error');
        return;
    }

    currentDiscussions.push({
        id: genId(),
        comment,
        author,
        type,
        timestamp: new Date().toISOString()
    });

    document.getElementById('discussion-comment').value = '';
    updateDiscussionThread();
    showToast('Comment added', 'success');
}

function updateDiscussionThread() {
    const thread = document.getElementById('discussion-thread');
    if (!thread) return;

    const typeColors = {
        question: '#3498db',
        comment: '#95a5a6',
        concern: '#e74c3c',
        support: '#2ecc71'
    };

    thread.innerHTML = currentDiscussions.map((d, idx) => `
        <div style="padding: 0.75rem; background: #2c3e50; border-radius: 4px; margin-bottom: 0.5rem; border-left: 3px solid ${typeColors[d.type]};">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div style="flex: 1;">
                    <div style="font-size: 0.85rem; opacity: 0.7; margin-bottom: 0.25rem;">
                        <strong>${escapeHtml(d.author)}</strong> - ${d.type} - ${new Date(d.timestamp).toLocaleString()}
                    </div>
                    <div>${escapeHtml(d.comment)}</div>
                </div>
                <button class="btn small" onclick="removeDiscussion(${idx})" style="background: #e74c3c; margin-left: 1rem;">Remove</button>
            </div>
        </div>
    `).join('');

    document.getElementById('gc-discussion-data').value = JSON.stringify(currentDiscussions);
}

function removeDiscussion(index) {
    currentDiscussions.splice(index, 1);
    updateDiscussionThread();
}

// FEATURE 6: Enhanced Decision Search
function clearGCSearch() {
    document.getElementById('gc-search').value = '';
    document.getElementById('gc-filter-status').value = '';
    document.getElementById('gc-filter-category').value = '';
    document.getElementById('gc-filter-date-from').value = '';
    document.getElementById('gc-filter-date-to').value = '';
    document.getElementById('gc-filter-submitter').value = '';
    searchGCHistory();
}

function showRelatedDecisions() {
    const searchTerm = document.getElementById('gc-search').value.toLowerCase();
    if (!searchTerm) {
        showToast('Enter a search term to find related decisions', 'error');
        return;
    }

    const gcLog = storage.getGroupConscienceLog();
    const related = gcLog.filter(item => {
        const itemText = (item.item || '').toLowerCase();
        const words = searchTerm.split(' ');
        return words.some(word => itemText.includes(word));
    });

    const suggestions = document.getElementById('search-suggestions');
    const suggestionsList = document.getElementById('suggestions-list');

    if (related.length > 0) {
        suggestions.style.display = 'block';
        suggestionsList.innerHTML = related.slice(0, 5).map(item => `
            <div style="padding: 0.5rem; background: #2c3e50; border-radius: 4px; margin-top: 0.5rem;">
                <strong>${item.date}</strong>: ${escapeHtml(item.item).substring(0, 100)}...
            </div>
        `).join('');
    } else {
        suggestions.style.display = 'none';
    }
}

function exportSearchResults() {
    const gcLog = storage.getGroupConscienceLog();
    showToast('Exporting search results...', 'success');
    // Implementation would export filtered results to CSV/PDF
}

// FEATURE 7: Email Integration
function saveEmailSettings() {
    const settings = {
        fromAddress: document.getElementById('email-from-address').value.trim(),
        fromName: document.getElementById('email-from-name').value.trim(),
        recipientList: document.getElementById('email-recipient-list').value.trim()
    };

    storage.saveEmailSettings(settings);
    showToast('Email settings saved', 'success');
}

function generateAndEmailAgenda() {
    const meetingDate = document.getElementById('agenda-meeting-date').value;
    const includeStanding = document.getElementById('agenda-include-standing').checked;
    const includeTabled = document.getElementById('agenda-include-tabled').checked;

    if (!meetingDate) {
        showToast('Please select meeting date', 'error');
        return;
    }

    const settings = storage.getEmailSettings();
    const proposedItems = storage.getProposedAgendaItems();
    const standingItems = includeStanding ? storage.getStandingAgendaItems().filter(i => i.active) : [];
    const tabledMotions = includeTabled ? storage.getTabledMotions() : [];

    let agendaText = `GROUP CONSCIENCE MEETING AGENDA\nDate: ${meetingDate}\n\n`;

    if (standingItems.length > 0) {
        agendaText += `STANDING ITEMS:\n`;
        standingItems.forEach((item, i) => {
            agendaText += `${i + 1}. ${item.title} (${item.time} min) - ${item.assignee || 'Unassigned'}\n`;
        });
        agendaText += `\n`;
    }

    if (tabledMotions.length > 0) {
        agendaText += `TABLED MOTIONS:\n`;
        tabledMotions.forEach((item, i) => {
            agendaText += `${i + 1}. ${item.motion}\n`;
        });
        agendaText += `\n`;
    }

    if (proposedItems.length > 0) {
        agendaText += `PROPOSED ITEMS:\n`;
        proposedItems.forEach((item, i) => {
            agendaText += `${i + 1}. ${item.title} (${item.estimatedTime || 15} min) - ${item.submitter}\n`;
        });
    }

    const preview = document.getElementById('agenda-preview');
    preview.style.display = 'block';
    preview.innerHTML = `<pre>${escapeHtml(agendaText)}</pre>`;

    const mailto = `mailto:${settings.recipientList}?subject=GC Agenda - ${meetingDate}&body=${encodeURIComponent(agendaText)}`;
    window.location.href = mailto;

    const history = storage.getEmailHistory();
    history.push({
        id: genId(),
        type: 'agenda',
        meetingDate,
        dateSent: new Date().toISOString(),
        recipients: settings.recipientList
    });
    storage.saveEmailHistory(history);
    refreshEmailHistory();
}

function generateAndEmailMinutes() {
    const meetingDate = document.getElementById('minutes-meeting-date').value;
    const includeDiscussion = document.getElementById('minutes-include-discussion').checked;
    const includeAmendments = document.getElementById('minutes-include-amendments').checked;

    if (!meetingDate) {
        showToast('Please select meeting date', 'error');
        return;
    }

    const settings = storage.getEmailSettings();
    const gcLog = storage.getGroupConscienceLog().filter(item => item.date === meetingDate);

    let minutesText = `GROUP CONSCIENCE MEETING MINUTES\nDate: ${meetingDate}\n\n`;

    gcLog.forEach((item, i) => {
        minutesText += `${i + 1}. ${item.item}\n`;
        minutesText += `   Result: ${item.status}\n`;
        minutesText += `   Votes: ${item.votesFor || 0} For, ${item.votesAgainst || 0} Against, ${item.votesAbstain || 0} Abstain\n\n`;
    });

    const preview = document.getElementById('minutes-preview');
    preview.style.display = 'block';
    preview.innerHTML = `<pre>${escapeHtml(minutesText)}</pre>`;

    const mailto = `mailto:${settings.recipientList}?subject=GC Minutes - ${meetingDate}&body=${encodeURIComponent(minutesText)}`;
    window.location.href = mailto;

    const history = storage.getEmailHistory();
    history.push({
        id: genId(),
        type: 'minutes',
        meetingDate,
        dateSent: new Date().toISOString(),
        recipients: settings.recipientList
    });
    storage.saveEmailHistory(history);
    refreshEmailHistory();
}

function refreshEmailHistory() {
    const history = storage.getEmailHistory();
    const tbody = document.getElementById('email-history-body');
    if (!tbody) return;

    tbody.innerHTML = history.slice(-10).reverse().map(item => `
        <tr>
            <td>${new Date(item.dateSent).toLocaleString()}</td>
            <td><span style="text-transform: capitalize;">${item.type}</span></td>
            <td>${item.meetingDate}</td>
            <td>${item.recipients.split(',').length} recipients</td>
            <td><button class="btn small" onclick="viewEmailDetails('${item.id}')">View</button></td>
        </tr>
    `).join('');
}

function viewEmailDetails(emailId) {
    const history = storage.getEmailHistory();
    const email = history.find(e => e.id === emailId);

    if (!email) {
        showToast('Email record not found', 'error');
        return;
    }

    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 2rem;';

    modal.innerHTML = `
        <div style="background: #2c3e50; border-radius: 8px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; padding: 2rem; position: relative;">
            <button onclick="this.closest('div[style*=fixed]').remove()" style="position: absolute; top: 1rem; right: 1rem; background: #e74c3c; border: none; color: white; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
                <i class="fas fa-times"></i> Close
            </button>

            <h2 style="color: #e67e22; margin-bottom: 1.5rem;"><i class="fas fa-envelope"></i> Email Details</h2>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                <div>
                    <strong>Type:</strong> <span style="text-transform: capitalize;">${email.type}</span>
                </div>
                <div>
                    <strong>Meeting Date:</strong> ${email.meetingDate}
                </div>
                <div>
                    <strong>Date Sent:</strong> ${new Date(email.dateSent).toLocaleString()}
                </div>
                <div>
                    <strong>Recipients:</strong> ${email.recipients.split(',').length} people
                </div>
            </div>

            <div style="margin-bottom: 1.5rem;">
                <h4 style="margin-bottom: 0.5rem;">Recipients List</h4>
                <div style="padding: 1rem; background: #34495e; border-radius: 4px; font-size: 0.9rem;">
                    ${email.recipients.split(',').map(r => r.trim()).join(', ')}
                </div>
            </div>

            <div style="padding: 1.5rem; background: #34495e; border-radius: 4px;">
                <h4 style="margin-bottom: 1rem;">Email Preview</h4>
                <div style="background: white; color: #2c3e50; padding: 1.5rem; border-radius: 4px; font-family: Arial, sans-serif; white-space: pre-wrap;">
                    ${email.content || 'No content preview available'}
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
}

// FEATURE 8: Member Voting History
function loadMemberVotingHistory() {
    const memberId = document.getElementById('voting-history-member').value;
    const period = document.getElementById('voting-history-period').value;

    if (!memberId) {
        document.getElementById('member-voting-stats').style.display = 'none';
        return;
    }

    const gcLog = storage.getGroupConscienceLog();
    const records = storage.getMemberVotingRecords();

    // Filter by time period
    const cutoffDate = new Date();
    if (period !== 'all') {
        cutoffDate.setDate(cutoffDate.getDate() - parseInt(period));
    }

    const memberVotes = records[memberId] || [];
    const filteredVotes = memberVotes.filter(v => {
        if (period === 'all') return true;
        return new Date(v.date) >= cutoffDate;
    });

    // Calculate stats
    const participated = filteredVotes.length;
    const votedFor = filteredVotes.filter(v => v.vote === 'for').length;
    const votedAgainst = filteredVotes.filter(v => v.vote === 'against').length;
    const abstained = filteredVotes.filter(v => v.vote === 'abstain').length;

    const totalDecisions = gcLog.filter(item => {
        if (period === 'all') return true;
        return new Date(item.date) >= cutoffDate;
    }).length;

    const participationRate = totalDecisions > 0 ? ((participated / totalDecisions) * 100).toFixed(1) : 0;

    // Update UI
    document.getElementById('member-voting-stats').style.display = 'block';
    document.getElementById('votes-participated').textContent = participated;
    document.getElementById('votes-for-total').textContent = votedFor;
    document.getElementById('votes-against-total').textContent = votedAgainst;
    document.getElementById('votes-abstain-total').textContent = abstained;
    document.getElementById('participation-rate').textContent = `${participationRate}%`;

    // Update voting record table
    const tbody = document.getElementById('member-voting-history-body');
    if (!tbody) return;

    tbody.innerHTML = filteredVotes.map(v => `
        <tr>
            <td>${v.date}</td>
            <td>${escapeHtml(v.motion).substring(0, 50)}...</td>
            <td><span style="color: ${v.vote === 'for' ? '#2ecc71' : v.vote === 'against' ? '#e74c3c' : '#95a5a6'};">${v.vote}</span></td>
            <td>${v.result}</td>
            <td>${v.consensus ? 'Yes' : 'No'}</td>
        </tr>
    `).join('');
}

// FEATURE 9: Decision Implementation Tracking
function saveDecisionImplementation() {
    const decisionId = document.getElementById('impl-decision').value;
    const status = document.getElementById('impl-status').value;
    const startDate = document.getElementById('impl-start-date').value;
    const targetDate = document.getElementById('impl-target-date').value;
    const actualDate = document.getElementById('impl-actual-date').value;
    const progress = parseInt(document.getElementById('impl-progress').value);
    const milestones = document.getElementById('impl-milestones').value.trim();
    const challenges = document.getElementById('impl-challenges').value.trim();
    const outcome = document.getElementById('impl-outcome').value;
    const owner = document.getElementById('impl-owner').value;

    if (!decisionId) {
        showToast('Please select a decision to track', 'error');
        return;
    }

    const tracking = storage.getImplementationTracking();
    const existing = tracking.find(t => t.decisionId === decisionId);

    const data = {
        decisionId,
        status,
        startDate,
        targetDate,
        actualDate,
        progress,
        milestones,
        challenges,
        outcome,
        owner,
        lastUpdated: new Date().toISOString()
    };

    if (existing) {
        Object.assign(existing, data);
    } else {
        data.id = genId();
        tracking.push(data);
    }

    storage.saveImplementationTracking(tracking);
    refreshImplementationTracking();
    showToast('Implementation tracking saved', 'success');
}

function refreshImplementationTracking() {
    const tracking = storage.getImplementationTracking();
    const gcLog = storage.getGroupConscienceLog();
    const tbody = document.getElementById('implementation-tracking-body');
    if (!tbody) return;

    tbody.innerHTML = tracking.map(t => {
        const decision = gcLog.find(d => d.id === t.decisionId);
        const decisionText = decision ? decision.item : 'Unknown';

        return `
            <tr>
                <td>${escapeHtml(decisionText).substring(0, 40)}...</td>
                <td><span style="color: ${getStatusColor(t.status)};">${t.status}</span></td>
                <td>${t.progress}%</td>
                <td>${t.owner || 'Unassigned'}</td>
                <td>${t.targetDate || 'Not set'}</td>
                <td>${t.outcome || 'Not assessed'}</td>
                <td><button class="btn small" onclick="editImplementation('${t.id}')">Edit</button></td>
            </tr>
        `;
    }).join('');
}

function getStatusColor(status) {
    const colors = {
        'planned': '#3498db',
        'in-progress': '#f39c12',
        'completed': '#2ecc71',
        'delayed': '#e67e22',
        'blocked': '#e74c3c',
        'abandoned': '#95a5a6'
    };
    return colors[status] || '#95a5a6';
}

// FEATURE 10: Consent Agenda
function refreshConsentAgenda() {
    const proposedItems = storage.getProposedAgendaItems();
    const standingItems = storage.getStandingAgendaItems().filter(i => i.active && i.consent === 'yes');

    const consentItems = [
        ...standingItems.map(i => ({...i, type: 'Standing', isStanding: true})),
        ...proposedItems.filter(i => i.consent).map(i => ({...i, type: 'Proposed', isStanding: false}))
    ];

    const tbody = document.getElementById('consent-agenda-body');
    if (!tbody) return;

    tbody.innerHTML = consentItems.map(item => `
        <tr>
            <td><input type="checkbox" class="consent-item-check" data-id="${item.id}"></td>
            <td>${escapeHtml(item.title || item.item)}</td>
            <td>${item.type}</td>
            <td>${escapeHtml(item.submitter || item.assignee || 'N/A')}</td>
            <td><button class="btn small" onclick="pullFromConsent('${item.id}')" style="background: #f39c12;">Pull</button></td>
        </tr>
    `).join('');
}

function toggleAllConsentItems() {
    const selectAll = document.getElementById('consent-select-all').checked;
    document.querySelectorAll('.consent-item-check').forEach(cb => cb.checked = selectAll);
}

function approveConsentAgenda() {
    const checkedIds = Array.from(document.querySelectorAll('.consent-item-check:checked')).map(cb => cb.dataset.id);

    if (checkedIds.length === 0) {
        showToast('No items selected', 'error');
        return;
    }

    if (!confirm(`Approve ${checkedIds.length} consent items?`)) return;

    const history = storage.getConsentHistory();
    history.push({
        id: genId(),
        date: new Date().toISOString(),
        itemCount: checkedIds.length,
        items: checkedIds
    });
    storage.saveConsentHistory(history);

    showToast(`${checkedIds.length} items approved via consent`, 'success');
    refreshConsentAgenda();
    updateConsentHistory();
}

function pullConsentItems() {
    const checkedIds = Array.from(document.querySelectorAll('.consent-item-check:checked')).map(cb => cb.dataset.id);

    if (checkedIds.length === 0) {
        showToast('No items selected to pull', 'error');
        return;
    }

    showToast(`${checkedIds.length} items pulled for full discussion`, 'success');
    // Items would be moved to regular GC agenda
}

function pullFromConsent(itemId) {
    const proposedItems = storage.getProposedAgendaItems();
    const standingItems = storage.getStandingAgendaItems();

    // Check if it's a proposed item
    const proposedItem = proposedItems.find(i => i.id === itemId);
    if (proposedItem) {
        proposedItem.consent = false;
        storage.saveProposedAgendaItems(proposedItems);
        showToast('Item pulled from consent agenda for full discussion', 'success');
        refreshConsentAgenda();
        updateProposedAgendaTable();
        return;
    }

    // Check if it's a standing item
    const standingItem = standingItems.find(i => i.id === itemId);
    if (standingItem) {
        standingItem.consent = 'no';
        storage.saveStandingAgendaItems(standingItems);
        showToast('Standing item pulled from consent agenda for full discussion', 'success');
        refreshConsentAgenda();
        refreshStandingItems();
        return;
    }

    showToast('Item not found', 'error');
}

function updateConsentHistory() {
    const history = storage.getConsentHistory();
    const div = document.getElementById('consent-history');
    if (!div) return;

    div.innerHTML = history.slice(-5).reverse().map(h => `
        <div style="padding: 0.5rem; background: #2c3e50; border-radius: 4px; margin-bottom: 0.5rem;">
            <strong>${new Date(h.date).toLocaleDateString()}</strong>: ${h.itemCount} items approved
        </div>
    `).join('') || '<em>No consent items approved yet</em>';
}

// FEATURE 4: Automated Workflow Status Updates
function checkAndUpdateWorkflowStatuses() {
    const gcLog = storage.getGroupConscienceLog();
    const today = new Date();
    let updated = 0;

    gcLog.forEach(item => {
        if (item.workflowStatus === 'research' && item.researchEndDate) {
            const endDate = new Date(item.researchEndDate);
            if (today >= endDate) {
                item.workflowStatus = 'voting';
                updated++;
            }
        }

        if (item.workflowStatus === 'tabled' && item.tableUntilDate) {
            const untilDate = new Date(item.tableUntilDate);
            if (today >= untilDate) {
                item.workflowStatus = 'voting';
                updated++;
            }
        }
    });

    if (updated > 0) {
        storage.saveGroupConscienceLog(gcLog);
        console.log(`Auto-updated ${updated} GC item workflow statuses`);
    }
}

// Run workflow check every hour
setInterval(checkAndUpdateWorkflowStatuses, 3600000);

// ========== MEDIUM PRIORITY FEATURES: 5 ENHANCEMENTS ==========

// FEATURE 11: Motion Reconsideration Workflow
function loadOriginalDecision() {
    const decisionId = document.getElementById('reconsider-original-decision').value;
    if (!decisionId) {
        document.getElementById('original-decision-summary').style.display = 'none';
        return;
    }

    const gcLog = storage.getGroupConscienceLog();
    const decision = gcLog.find(d => d.id === decisionId);

    if (decision) {
        const summary = document.getElementById('original-decision-summary');
        summary.style.display = 'block';

        const details = document.getElementById('original-decision-details');
        details.innerHTML = `
            <div style="margin-bottom: 0.5rem;"><strong>Date:</strong> ${decision.date}</div>
            <div style="margin-bottom: 0.5rem;"><strong>Motion:</strong> ${escapeHtml(decision.item)}</div>
            <div style="margin-bottom: 0.5rem;"><strong>Result:</strong> ${decision.status}</div>
            <div><strong>Votes:</strong> ${decision.votesFor || 0} For, ${decision.votesAgainst || 0} Against, ${decision.votesAbstain || 0} Abstain</div>
        `;
    }
}

function submitReconsiderationRequest() {
    const decisionId = document.getElementById('reconsider-original-decision').value;
    const requestedBy = document.getElementById('reconsider-requested-by').value;
    const reason = document.getElementById('reconsider-reason').value;
    const justification = document.getElementById('reconsider-justification').value.trim();
    const proposedDate = document.getElementById('reconsider-proposed-date').value;
    const researchPeriod = parseInt(document.getElementById('reconsider-research-period').value);
    const proposedChange = document.getElementById('reconsider-proposed-change').value.trim();

    if (!decisionId || !requestedBy || !justification) {
        showToast('Please fill in all required fields', 'error');
        return;
    }

    const requests = storage.getReconsiderationRequests();
    const gcLog = storage.getGroupConscienceLog();
    const originalDecision = gcLog.find(d => d.id === decisionId);

    requests.push({
        id: genId(),
        decisionId,
        originalMotion: originalDecision ? originalDecision.item : 'Unknown',
        requestedBy,
        reason,
        justification,
        proposedDate,
        researchPeriod,
        proposedChange,
        status: 'pending',
        submittedDate: new Date().toISOString()
    });

    storage.saveReconsiderationRequests(requests);
    refreshReconsiderationRequests();
    showToast('Reconsideration request submitted', 'success');

    // Clear form
    document.getElementById('reconsider-original-decision').value = '';
    document.getElementById('reconsider-justification').value = '';
    document.getElementById('reconsider-proposed-change').value = '';
    document.getElementById('original-decision-summary').style.display = 'none';
}

function refreshReconsiderationRequests() {
    const requests = storage.getReconsiderationRequests();
    const tbody = document.getElementById('reconsideration-requests-body');
    if (!tbody) return;

    tbody.innerHTML = requests.filter(r => r.status === 'pending').map(req => `
        <tr>
            <td>${escapeHtml(req.originalMotion).substring(0, 50)}...</td>
            <td>${escapeHtml(req.requestedBy)}</td>
            <td>${escapeHtml(req.reason)}</td>
            <td>${req.proposedDate || 'TBD'}</td>
            <td><span style="color: #f39c12;">${req.status}</span></td>
            <td>
                <button class="btn small" onclick="approveReconsideration('${req.id}')" style="background: #2ecc71;">Approve</button>
                <button class="btn small" onclick="denyReconsideration('${req.id}')" style="background: #e74c3c;">Deny</button>
            </td>
        </tr>
    `).join('') || '<tr><td colspan="6" style="text-align: center; opacity: 0.7;">No pending requests</td></tr>';
}

function approveReconsideration(requestId) {
    const requests = storage.getReconsiderationRequests();
    const request = requests.find(r => r.id === requestId);
    if (request) {
        request.status = 'approved';
        storage.saveReconsiderationRequests(requests);
        refreshReconsiderationRequests();
        showToast('Reconsideration request approved', 'success');
    }
}

function denyReconsideration(requestId) {
    if (!confirm('Deny this reconsideration request?')) return;
    const requests = storage.getReconsiderationRequests();
    const request = requests.find(r => r.id === requestId);
    if (request) {
        request.status = 'denied';
        storage.saveReconsiderationRequests(requests);
        refreshReconsiderationRequests();
        showToast('Reconsideration request denied', 'success');
    }
}

// FEATURE 12: Calendar Integration
function exportToGoogleCalendar() {
    const date = document.getElementById('cal-meeting-date').value;
    const time = document.getElementById('cal-meeting-time').value;
    const duration = parseFloat(document.getElementById('cal-duration').value);
    const location = document.getElementById('cal-location').value;

    if (!date) {
        showToast('Please select a meeting date', 'error');
        return;
    }

    const startDateTime = `${date}T${time || '18:00'}:00`;
    const endTime = new Date(`${date}T${time || '18:00'}:00`);
    endTime.setHours(endTime.getHours() + (duration || 1.5));
    const endDateTime = endTime.toISOString().slice(0, 19);

    const googleUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent('Group Conscience Meeting')}&dates=${startDateTime.replace(/[-:]/g, '')}/${endDateTime.replace(/[-:]/g, '')}&details=${encodeURIComponent('Group Conscience Meeting')}&location=${encodeURIComponent(location || '')}`;

    window.open(googleUrl, '_blank');
    saveCalendarEvent('GC Meeting', date, time, 'google');
}

function exportToOutlook() {
    const date = document.getElementById('cal-meeting-date').value;
    const time = document.getElementById('cal-meeting-time').value;
    const duration = parseFloat(document.getElementById('cal-duration').value);
    const location = document.getElementById('cal-location').value;

    if (!date) {
        showToast('Please select a meeting date', 'error');
        return;
    }

    const startDateTime = `${date}T${time || '18:00'}:00`;
    const endTime = new Date(`${date}T${time || '18:00'}:00`);
    endTime.setHours(endTime.getHours() + (duration || 1.5));
    const endDateTime = endTime.toISOString().slice(0, 19);

    const outlookUrl = `https://outlook.live.com/calendar/0/deeplink/compose?subject=${encodeURIComponent('Group Conscience Meeting')}&startdt=${startDateTime}&enddt=${endDateTime}&location=${encodeURIComponent(location || '')}`;

    window.open(outlookUrl, '_blank');
    saveCalendarEvent('GC Meeting', date, time, 'outlook');
}

function exportToICS() {
    const date = document.getElementById('cal-meeting-date').value;
    const time = document.getElementById('cal-meeting-time').value;
    const duration = parseFloat(document.getElementById('cal-duration').value);
    const location = document.getElementById('cal-location').value;

    if (!date) {
        showToast('Please select a meeting date', 'error');
        return;
    }

    const startDateTime = new Date(`${date}T${time || '18:00'}:00`);
    const endTime = new Date(startDateTime);
    endTime.setHours(endTime.getHours() + (duration || 1.5));

    const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
BEGIN:VEVENT
DTSTART:${startDateTime.toISOString().replace(/[-:]/g, '').split('.')[0]}Z
DTEND:${endTime.toISOString().replace(/[-:]/g, '').split('.')[0]}Z
SUMMARY:Group Conscience Meeting
LOCATION:${location || ''}
DESCRIPTION:Group Conscience Meeting
END:VEVENT
END:VCALENDAR`;

    const blob = new Blob([icsContent], { type: 'text/calendar' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `gc-meeting-${date}.ics`;
    a.click();
    URL.revokeObjectURL(url);

    saveCalendarEvent('GC Meeting', date, time, 'ics');
    showToast('Calendar file downloaded', 'success');
}

function exportDeadlineToGoogleCalendar() {
    const title = document.getElementById('cal-decision-title').value.trim();
    const date = document.getElementById('cal-deadline-date').value;
    const reminder = document.getElementById('cal-reminder').value;

    if (!title || !date) {
        showToast('Please fill in required fields', 'error');
        return;
    }

    const googleUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title + ' - Deadline')}&dates=${date.replace(/-/g, '')}/${date.replace(/-/g, '')}&details=${encodeURIComponent('Decision deadline: ' + title)}`;

    window.open(googleUrl, '_blank');
    saveCalendarEvent(title, date, null, 'google');
}

function exportDeadlineToOutlook() {
    const title = document.getElementById('cal-decision-title').value.trim();
    const date = document.getElementById('cal-deadline-date').value;

    if (!title || !date) {
        showToast('Please fill in required fields', 'error');
        return;
    }

    const outlookUrl = `https://outlook.live.com/calendar/0/deeplink/compose?subject=${encodeURIComponent(title + ' - Deadline')}&startdt=${date}T09:00:00&enddt=${date}T10:00:00&allday=true`;

    window.open(outlookUrl, '_blank');
    saveCalendarEvent(title, date, null, 'outlook');
}

function exportDeadlineToICS() {
    const title = document.getElementById('cal-decision-title').value.trim();
    const date = document.getElementById('cal-deadline-date').value;

    if (!title || !date) {
        showToast('Please fill in required fields', 'error');
        return;
    }

    const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
BEGIN:VEVENT
DTSTART;VALUE=DATE:${date.replace(/-/g, '')}
SUMMARY:${title} - Deadline
DESCRIPTION:Decision deadline: ${title}
END:VEVENT
END:VCALENDAR`;

    const blob = new Blob([icsContent], { type: 'text/calendar' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `decision-deadline-${date}.ics`;
    a.click();
    URL.revokeObjectURL(url);

    saveCalendarEvent(title, date, null, 'ics');
    showToast('Calendar file downloaded', 'success');
}

function saveCalendarEvent(title, date, time, platform) {
    const events = storage.getCalendarEvents();
    events.push({
        id: genId(),
        title,
        date,
        time,
        platform,
        exported: new Date().toISOString()
    });
    storage.saveCalendarEvents(events);
}

// FEATURE 13: Decision ROI/Impact Calculator
let roiChart;

function calculateROI() {
    const title = document.getElementById('roi-decision-title').value.trim();
    const initialCost = parseFloat(document.getElementById('roi-initial-cost').value) || 0;
    const ongoingCost = parseFloat(document.getElementById('roi-ongoing-cost').value) || 0;
    const revenueImpact = parseFloat(document.getElementById('roi-revenue-impact').value) || 0;
    const expenseSavings = parseFloat(document.getElementById('roi-expense-savings').value) || 0;
    const timeframe = parseInt(document.getElementById('roi-timeframe').value) || 12;

    if (!title || initialCost === 0) {
        showToast('Please enter decision title and initial cost', 'error');
        return;
    }

    const monthlyBenefit = revenueImpact + expenseSavings - ongoingCost;
    const totalCost = initialCost + (ongoingCost * timeframe);
    const totalBenefit = monthlyBenefit * timeframe;
    const netImpact = totalBenefit - totalCost;
    const roiPercentage = totalCost > 0 ? ((netImpact / totalCost) * 100) : 0;
    const paybackMonths = monthlyBenefit > 0 ? Math.ceil(initialCost / monthlyBenefit) : null;

    // Update display
    document.getElementById('roi-results').style.display = 'block';
    document.getElementById('roi-total-cost-display').textContent = `$${totalCost.toFixed(2)}`;
    document.getElementById('roi-net-impact-display').textContent = `$${netImpact.toFixed(2)}`;
    document.getElementById('roi-net-impact-display').style.color = netImpact >= 0 ? '#2ecc71' : '#e74c3c';
    document.getElementById('roi-payback-display').textContent = paybackMonths ? `${paybackMonths} months` : 'N/A';
    document.getElementById('roi-percentage-display').textContent = `${roiPercentage.toFixed(1)}%`;
    document.getElementById('roi-percentage-display').style.color = roiPercentage >= 0 ? '#2ecc71' : '#e74c3c';

    // Recommendation
    const recommendation = document.getElementById('roi-recommendation');
    if (netImpact > 0) {
        recommendation.style.background = '#2ecc71';
        recommendation.innerHTML = `<strong>✓ Recommended:</strong> Positive financial impact of $${netImpact.toFixed(2)} over ${timeframe} months`;
    } else if (netImpact === 0) {
        recommendation.style.background = '#f39c12';
        recommendation.innerHTML = `<strong>⚠ Neutral:</strong> Break-even decision with no financial gain or loss`;
    } else {
        recommendation.style.background = '#e74c3c';
        recommendation.innerHTML = `<strong>✗ Not Recommended:</strong> Negative financial impact of $${Math.abs(netImpact).toFixed(2)} over ${timeframe} months`;
    }

    // Budget impact
    const currentBalance = calculateCurrentBalance();
    const budgetImpact = document.getElementById('budget-impact-details');
    budgetImpact.innerHTML = `
        <div style="margin-bottom: 0.5rem;"><strong>Current Balance:</strong> $${currentBalance.toFixed(2)}</div>
        <div style="margin-bottom: 0.5rem;"><strong>After Initial Purchase:</strong> $${(currentBalance - initialCost).toFixed(2)}</div>
        <div style="margin-bottom: 0.5rem;"><strong>Monthly Cash Flow Impact:</strong> ${monthlyBenefit >= 0 ? '+' : ''}$${monthlyBenefit.toFixed(2)}</div>
        <div><strong>Balance after ${timeframe} months:</strong> $${(currentBalance - initialCost + (monthlyBenefit * timeframe)).toFixed(2)}</div>
    `;

    // Create chart
    renderROIChart(timeframe, initialCost, monthlyBenefit, currentBalance);

    // Save calculation
    const calculations = storage.getROICalculations();
    calculations.push({
        id: genId(),
        title,
        initialCost,
        ongoingCost,
        revenueImpact,
        expenseSavings,
        timeframe,
        netImpact,
        roiPercentage,
        calculatedDate: new Date().toISOString()
    });
    storage.saveROICalculations(calculations);
}

function renderROIChart(timeframe, initialCost, monthlyBenefit, currentBalance) {
    const ctx = document.getElementById('roi-chart');
    if (!ctx) return;

    const labels = [];
    const balanceData = [];
    let balance = currentBalance - initialCost;

    for (let i = 0; i <= timeframe; i++) {
        labels.push(`Month ${i}`);
        balanceData.push(balance);
        if (i < timeframe) balance += monthlyBenefit;
    }

    if (roiChart) roiChart.destroy();

    roiChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels,
            datasets: [{
                label: 'Projected Balance',
                data: balanceData,
                borderColor: monthlyBenefit >= 0 ? '#2ecc71' : '#e74c3c',
                backgroundColor: monthlyBenefit >= 0 ? 'rgba(46, 204, 113, 0.1)' : 'rgba(231, 76, 60, 0.1)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: true },
                title: { display: true, text: 'Financial Impact Over Time' }
            }
        }
    });
}

// FEATURE 14: Proxy Voting System
function toggleProxyInstructions() {
    const scope = document.getElementById('proxy-scope').value;
    const instructionsDiv = document.getElementById('proxy-directed-instructions');
    instructionsDiv.style.display = scope === 'directed' ? 'block' : 'none';
}

function submitProxyDesignation() {
    const member = document.getElementById('proxy-member').value;
    const designatedVoter = document.getElementById('proxy-designated-voter').value;
    const meetingDate = document.getElementById('proxy-meeting-date').value;
    const scope = document.getElementById('proxy-scope').value;
    const instructions = document.getElementById('proxy-instructions').value.trim();
    const reason = document.getElementById('proxy-reason').value;

    if (!member || !designatedVoter || !meetingDate) {
        showToast('Please fill in all required fields', 'error');
        return;
    }

    if (member === designatedVoter) {
        showToast('Cannot designate yourself as proxy', 'error');
        return;
    }

    const proxies = storage.getProxyVotes();
    proxies.push({
        id: genId(),
        member,
        designatedVoter,
        meetingDate,
        scope,
        instructions: scope === 'directed' ? instructions : '',
        reason,
        status: 'active',
        createdDate: new Date().toISOString()
    });

    storage.saveProxyVotes(proxies);
    refreshProxyVotes();
    showToast('Proxy designation submitted', 'success');

    // Clear form
    document.getElementById('proxy-meeting-date').value = '';
    document.getElementById('proxy-instructions').value = '';
}

function refreshProxyVotes() {
    const proxies = storage.getProxyVotes();
    const members = storage.getMembers();
    const tbody = document.getElementById('active-proxies-body');
    if (!tbody) return;

    const activeTodayProxies = proxies.filter(p => p.status === 'active' && new Date(p.meetingDate) >= new Date());

    tbody.innerHTML = activeTodayProxies.map(proxy => {
        const memberName = members.find(m => m.id === proxy.member)?.name || proxy.member;
        const voterName = members.find(m => m.id === proxy.designatedVoter)?.name || proxy.designatedVoter;

        return `
            <tr>
                <td>${escapeHtml(memberName)}</td>
                <td>${escapeHtml(voterName)}</td>
                <td>${proxy.meetingDate}</td>
                <td>${proxy.scope === 'general' ? 'General' : 'Directed'}</td>
                <td><button class="btn small" onclick="revokeProxy('${proxy.id}')" style="background: #e74c3c;">Revoke</button></td>
            </tr>
        `;
    }).join('') || '<tr><td colspan="5" style="text-align: center; opacity: 0.7;">No active proxies</td></tr>';
}

function revokeProxy(proxyId) {
    if (!confirm('Revoke this proxy designation?')) return;
    const proxies = storage.getProxyVotes();
    const proxy = proxies.find(p => p.id === proxyId);
    if (proxy) {
        proxy.status = 'revoked';
        storage.saveProxyVotes(proxies);
        refreshProxyVotes();
        showToast('Proxy revoked', 'success');
    }
}

// FEATURE 15: Decision Reversal Tracking
function loadReversalDecision() {
    const decisionId = document.getElementById('reversal-original-decision').value;
    if (!decisionId) {
        document.getElementById('reversal-original-summary').style.display = 'none';
        return;
    }

    const gcLog = storage.getGroupConscienceLog();
    const decision = gcLog.find(d => d.id === decisionId);

    if (decision) {
        const summary = document.getElementById('reversal-original-summary');
        summary.style.display = 'block';

        const details = document.getElementById('reversal-original-details');
        details.innerHTML = `
            <div style="margin-bottom: 0.5rem;"><strong>Date:</strong> ${decision.date}</div>
            <div style="margin-bottom: 0.5rem;"><strong>Motion:</strong> ${escapeHtml(decision.item)}</div>
            <div style="margin-bottom: 0.5rem;"><strong>Result:</strong> ${decision.status}</div>
        `;

        // Calculate months elapsed
        const originalDate = new Date(decision.date);
        const today = new Date();
        const monthsElapsed = Math.floor((today - originalDate) / (1000 * 60 * 60 * 24 * 30));
        document.getElementById('reversal-months-elapsed').value = monthsElapsed;
    }
}

function saveDecisionReversal() {
    const originalId = document.getElementById('reversal-original-decision').value;
    const newId = document.getElementById('reversal-new-decision').value;
    const reason = document.getElementById('reversal-reason-category').value;
    const explanation = document.getElementById('reversal-explanation').value.trim();
    const reversalDate = document.getElementById('reversal-date').value;
    const monthsElapsed = parseInt(document.getElementById('reversal-months-elapsed').value);
    const lessonsLearned = document.getElementById('reversal-lessons-learned').value.trim();

    if (!originalId || !newId || !explanation || !lessonsLearned) {
        showToast('Please fill in all required fields', 'error');
        return;
    }

    const gcLog = storage.getGroupConscienceLog();
    const originalDecision = gcLog.find(d => d.id === originalId);
    const newDecision = gcLog.find(d => d.id === newId);

    const reversals = storage.getDecisionReversals();
    reversals.push({
        id: genId(),
        originalId,
        newId,
        originalMotion: originalDecision ? originalDecision.item : 'Unknown',
        newMotion: newDecision ? newDecision.item : 'Unknown',
        reason,
        explanation,
        reversalDate: reversalDate || new Date().toISOString().split('T')[0],
        monthsElapsed,
        lessonsLearned,
        recordedDate: new Date().toISOString()
    });

    storage.saveDecisionReversals(reversals);
    refreshDecisionReversals();
    showToast('Decision reversal recorded', 'success');

    // Clear form
    document.getElementById('reversal-explanation').value = '';
    document.getElementById('reversal-lessons-learned').value = '';
    document.getElementById('reversal-original-summary').style.display = 'none';
}

function refreshDecisionReversals() {
    const reversals = storage.getDecisionReversals();
    const tbody = document.getElementById('decision-reversals-body');
    if (!tbody) return;

    tbody.innerHTML = reversals.map(rev => `
        <tr>
            <td>${escapeHtml(rev.originalMotion).substring(0, 40)}...</td>
            <td>${escapeHtml(rev.newMotion).substring(0, 40)}...</td>
            <td>${escapeHtml(rev.reason)}</td>
            <td>${rev.monthsElapsed} months</td>
            <td>${escapeHtml(rev.lessonsLearned).substring(0, 50)}...</td>
            <td><button class="btn small" onclick="viewReversalDetails('${rev.id}')">View</button></td>
        </tr>
    `).join('') || '<tr><td colspan="6" style="text-align: center; opacity: 0.7;">No reversals recorded</td></tr>';

    // Update stats
    document.getElementById('total-reversals-count').textContent = reversals.length;

    if (reversals.length > 0) {
        const avgTime = reversals.reduce((sum, r) => sum + r.monthsElapsed, 0) / reversals.length;
        document.getElementById('avg-reversal-time').textContent = `${avgTime.toFixed(1)} mo`;

        const reasonCounts = {};
        reversals.forEach(r => {
            reasonCounts[r.reason] = (reasonCounts[r.reason] || 0) + 1;
        });
        const mostCommon = Object.keys(reasonCounts).reduce((a, b) => reasonCounts[a] > reasonCounts[b] ? a : b, '');
        document.getElementById('most-common-reason').textContent = mostCommon;

        // Render reversal reasons chart
        renderReversalReasonsChart(reasonCounts);
    }
}

function viewReversalDetails(reversalId) {
    const reversals = storage.getDecisionReversals();
    const reversal = reversals.find(r => r.id === reversalId);

    if (!reversal) {
        showToast('Reversal not found', 'error');
        return;
    }

    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 2rem;';

    modal.innerHTML = `
        <div style="background: #2c3e50; border-radius: 8px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; padding: 2rem; position: relative;">
            <button onclick="this.closest('div[style*=fixed]').remove()" style="position: absolute; top: 1rem; right: 1rem; background: #e74c3c; border: none; color: white; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
                <i class="fas fa-times"></i> Close
            </button>

            <h2 style="color: #e74c3c; margin-bottom: 1.5rem;"><i class="fas fa-exchange-alt"></i> Decision Reversal Details</h2>

            <div style="margin-bottom: 1.5rem; padding: 1rem; background: #34495e; border-radius: 4px;">
                <h3 style="color: #f39c12; margin-bottom: 1rem;">Original Decision</h3>
                <p style="font-size: 1.1rem; margin-bottom: 0.5rem;">${escapeHtml(reversal.originalMotion)}</p>
            </div>

            <div style="margin-bottom: 1.5rem; padding: 1rem; background: #34495e; border-radius: 4px;">
                <h3 style="color: #2ecc71; margin-bottom: 1rem;">New Decision</h3>
                <p style="font-size: 1.1rem; margin-bottom: 0.5rem;">${escapeHtml(reversal.newMotion)}</p>
            </div>

            <div style="margin-bottom: 1rem;">
                <strong>Reversal Date:</strong> ${reversal.reversalDate}
            </div>
            <div style="margin-bottom: 1rem;">
                <strong>Time Elapsed:</strong> ${reversal.monthsElapsed} months
            </div>
            <div style="margin-bottom: 1rem;">
                <strong>Reason Category:</strong> <span style="color: #f39c12;">${reversal.reason.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase())}</span>
            </div>

            <div style="margin-bottom: 1.5rem; padding: 1rem; background: #34495e; border-radius: 4px;">
                <h4 style="margin-bottom: 0.5rem;">Detailed Explanation</h4>
                <p style="white-space: pre-wrap;">${escapeHtml(reversal.explanation)}</p>
            </div>

            <div style="padding: 1rem; background: #16a085; border-radius: 4px;">
                <h4 style="margin-bottom: 0.5rem;"><i class="fas fa-lightbulb"></i> Lessons Learned</h4>
                <p style="white-space: pre-wrap;">${escapeHtml(reversal.lessonsLearned)}</p>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
}

let reversalReasonsChart;

function renderReversalReasonsChart(reasonCounts) {
    const ctx = document.getElementById('reversal-reasons-chart');
    if (!ctx) return;

    const labels = Object.keys(reasonCounts);
    const data = Object.values(reasonCounts);
    const colors = ['#e74c3c', '#f39c12', '#3498db', '#2ecc71', '#9b59b6', '#1abc9c', '#e67e22', '#95a5a6', '#34495e'];

    if (reversalReasonsChart) reversalReasonsChart.destroy();

    reversalReasonsChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels.map(l => l.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase())),
            datasets: [{
                data: data,
                backgroundColor: colors.slice(0, labels.length),
                borderWidth: 2,
                borderColor: '#2c3e50'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'bottom'
                },
                title: {
                    display: true,
                    text: 'Reversal Reasons Distribution',
                    color: '#ecf0f1'
                }
            }
        }
    });
}

// Initialize PWA
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', injectPWAManifest);
} else {
    injectPWAManifest();
}

    </script>
</body>
</html>