<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="description" content="HomeGroup - Complete Home Group Management Portal for AA Groups">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; font-src 'self' https://cdnjs.cloudflare.com; img-src 'self' data: blob:; connect-src 'self' https://api.dictionaryapi.dev;">
    <title>HomeGroup</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"></script>
    <link rel="icon" type="image/svg+xml" href="logo.svg">
    <style>
        /* Basic reset and typography */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        /* WCAG Accessibility: Skip Link */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: #3498db;
            color: white;
            padding: 8px;
            text-decoration: none;
            z-index: 10000;
            border-radius: 0 0 4px 0;
            font-weight: bold;
        }
        .skip-link:focus {
            top: 0;
        }
        /* WCAG Accessibility: Enhanced Focus Indicators */
        *:focus {
            outline: 3px solid #3498db;
            outline-offset: 2px;
        }
        button:focus-visible, a:focus-visible, input:focus-visible,
        select:focus-visible, textarea:focus-visible {
            outline: 3px solid #3498db;
            outline-offset: 2px;
            box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.3);
        }
        /* Remove focus for mouse users, keep for keyboard users */
        *:focus:not(:focus-visible) {
            outline: none;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #2c3e50; /* Dark Slate Gray */
            color: #ecf0f1; /* Silver */
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-y: scroll; /* Persistent vertical scrollbar */
            overflow-x: hidden; /* Prevent horizontal scrollbar */
        }
        h1, h2, h3 {
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: #3498db; /* Metallic Blue */
        }
        /* Navigation bar */
        nav {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            background: #34495e; /* Wet Asphalt */
            color: #ecf0f1;
            padding: 0.5rem 1rem;
            border-bottom: 2px solid #3498db; /* Metallic Blue */
        }
        nav .logo {
            display: flex;
            align-items: center;
            font-size: 1.25rem;
        }
        nav .logo svg {
            width: 32px;
            height: 32px;
            margin-right: 0.5rem;
        }
        nav ul {
            list-style: none;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-right: 1rem;
        }
        @media (min-width: 768px) {
            nav ul {
                margin-right: 4rem;
            }
        }
        nav li {
            cursor: pointer;
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            transition: background 0.2s;
            position: relative;
        }
        nav li:hover, nav li.active {
            background: #3498db; /* Metallic Blue */
            color: #ffffff;
        }
        /* Dropdown menu styles */
        nav li.has-dropdown {
            padding-right: 1.5rem;
        }
        nav li.has-dropdown::after {
            content: '\f107'; /* Font Awesome down arrow */
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.75rem;
            transition: transform 0.2s;
        }
        nav li.has-dropdown:hover::after {
            transform: translateY(-50%) rotate(180deg);
        }
        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            min-width: 200px;
            background: #2c3e50;
            border: 1px solid #3498db;
            border-radius: 4px;
            margin-top: 0.25rem;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        nav li:hover .dropdown-menu,
        nav li.dropdown-open .dropdown-menu {
            display: block;
        }
        .dropdown-menu li {
            padding: 0.5rem 1rem;
            border-radius: 0;
            border-bottom: 1px solid #34495e;
        }
        .dropdown-menu li:last-child {
            border-bottom: none;
        }
        .dropdown-menu li:hover {
            background: #34495e;
        }
        .dropdown-menu li.active {
            background: #2980b9;
        }
        /* Right-align the last dropdown (settings) */
        nav ul li.has-dropdown:last-child .dropdown-menu {
            left: auto;
            right: 0;
        }
        /* Main content area */
        main {
            flex: 1;
            padding: 1rem;
            width: 100%;
            max-width: none;
            margin: 0;
            overflow-y: auto;
        }
        section {
            display: none;
        }
        section.active {
            display: block;
        }
        /* Home overview boxes */
        .grid {
            display: grid;
            gap: 1rem;
        }
        .grid-cols-2 {
            grid-template-columns: 1fr;
        }
        @media (min-width: 640px) {
            .grid-cols-2 {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
        }
        .box {
            background: #34495e; /* Wet Asphalt */
            border: 1px solid #7f8c8d; /* Silver-Gray */
            border-radius: 6px;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            color: #ecf0f1; /* Silver */
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
            display: block;
            overflow-x: auto;
            white-space: nowrap;
        }
        @media (min-width: 768px) {
            table {
                display: table;
                white-space: normal;
            }
        }
        th, td {
            padding: 0.5rem;
            border-bottom: 1px solid #7f8c8d; /* Silver-Gray */
            text-align: left;
            min-width: 80px;
        }
        @media (max-width: 640px) {
            th, td {
                padding: 0.3rem;
                font-size: 0.85rem;
            }
        }
        th {
            background: #2c3e50; /* Dark Slate Gray */
            color: #3498db; /* Metallic Blue */
        }
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 4px;
            background: #3498db; /* Metallic Blue */
            color: #fff;
            border: 1px solid #2980b9; /* Darker Blue */
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
            font-size: 0.9rem;
            min-height: 44px;
            min-width: 44px;
            touch-action: manipulation;
        }
        @media (max-width: 640px) {
            .btn {
                padding: 0.6rem 0.8rem;
                font-size: 0.85rem;
            }
        }
        .btn:hover {
            background: #2980b9;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .btn.secondary {
            background: #7f8c8d; /* Silver-Gray */
            border-color: #95a5a6;
        }
        .btn.secondary:hover {
            background: #95a5a6;
        }
        /* Form styling */
        .form-group {
            margin-bottom: 0.75rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.25rem;
            font-weight: 500;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #7f8c8d; /* Silver-Gray */
            border-radius: 4px;
            background: #34495e; /* Wet Asphalt */
            color: #ecf0f1; /* Silver */
            font-size: 16px;
            min-height: 44px;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: 2px solid #3498db;
            outline-offset: 2px;
        }
        /* Specific style for the roster search input to ensure visibility */
        #roster-search {
            padding: 0.5rem;
            border: 1px solid #7f8c8d; /* Silver-Gray */
            border-radius: 4px;
            background: #34495e; /* Wet Asphalt */
            color: #ecf0f1; /* Silver */
        }
        /* Gallery */
        #gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
        }
        #gallery-grid img {
            width: 100%;
            height: auto;
            border-radius: 6px;
            object-fit: cover;
            cursor: pointer;
        }
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
        .modal-content {
            max-width: 95%;
            max-height: 90%;
            width: 100%;
        }
        @media (min-width: 768px) {
            .modal-content {
                max-width: 80%;
                max-height: 80%;
            }
        }
        .modal-close {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #fff;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 101;
        }
        /* Next & previous buttons */
        .prev, .next {
            cursor: pointer;
            position: absolute;
            top: 50%;
            width: auto;
            padding: 16px;
            margin-top: -22px;
            color: white;
            font-weight: bold;
            font-size: 20px;
            transition: 0.6s ease;
            border-radius: 0 3px 3px 0;
            user-select: none;
            -webkit-user-select: none;
        }
        .next {
            right: 0;
            border-radius: 3px 0 0 3px;
        }
        .prev {
            left: 0;
        }
        .prev:hover, .next:hover {
            background-color: rgba(0,0,0,0.8);
        }
        /* History section */
        .history-nav {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .history-nav button {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #7f8c8d;
            border-radius: 4px;
            background: #34495e; /* Wet Asphalt */
            color: #ecf0f1; /* Silver */
            cursor: pointer;
            transition: background 0.2s;
        }
        .history-nav button.active {
            background: #3498db; /* Metallic Blue */
            border-color: #2980b9;
        }
        /* Timeline styles adapted from the original history pages.  */
        .timeline-container {
            position: relative;
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        .timeline-container::after {
            content: '';
            position: absolute;
            width: 6px;
            background-color: #7f8c8d; /* Silver-Gray */
            top: 0;
            bottom: 0;
            left: 50%;
            margin-left: -3px;
            border-radius: 3px;
        }
        .timeline-block {
            padding: 10px 40px;
            position: relative;
            background-color: inherit;
            width: 50%;
        }
        .timeline-block.left {
            left: 0;
        }
        .timeline-block.right {
            left: 50%;
        }
        .timeline-block::after {
            content: '';
            position: absolute;
            width: 25px;
            height: 25px;
            right: -14px;
            background-color: #34495e; /* Wet Asphalt */
            border: 4px solid #3498db; /* Metallic Blue */
            top: 25px;
            border-radius: 50%;
            z-index: 1;
            transition: all 0.3s ease;
        }
        .timeline-block.right::after {
            left: -12px;
            right: auto;
        }
        .timeline-content {
            padding: 20px 30px;
            background-color: #2c3e50; /* Dark Slate Gray */
            color: #ecf0f1; /* Silver */
            position: relative;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .timeline-content:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .timeline-block:hover::after {
            transform: scale(1.2);
            border-color: #FBBF24; /* amber-400 */
        }
        /* Info popups are hidden by default. They will appear on hover via timeline-content:hover .info-popup. */
        .info-popup {
            position: absolute;
            bottom: calc(100% + 15px);
            left: 50%;
            transform: translateX(-50%) scale(0.95);
            width: 90%;
            min-width: 250px;
            background-color: #34495e; /* Wet Asphalt */
            color: #ecf0f1; /* Silver */
            padding: 15px;
            border-radius: 8px;
            z-index: 10;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .timeline-content:hover .info-popup {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) scale(1);
        }
        /* History content sections */
        .history-content {
            display: none;
        }
        .history-content.active {
            display: block;
        }
        /* Calendar styles */
        #calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            border: 1px solid #7f8c8d; /* Silver-Gray */
            border-radius: 6px;
            overflow: hidden;
        }
        @media (max-width: 640px) {
            #calendar-grid {
                font-size: 0.7rem;
            }
        }
        .calendar-day {
            border-right: 1px solid #7f8c8d;
            border-bottom: 1px solid #7f8c8d;
            min-height: 110px;
            padding: 4px;
            font-size: 0.8rem;
            position: relative;
        }
        @media (max-width: 640px) {
            .calendar-day {
                min-height: 80px;
                padding: 2px;
                font-size: 0.7rem;
            }
        }
        .calendar-day:nth-child(7n) {
            border-right: none;
        }
        .calendar-day-name {
            font-weight: bold;
            background-color: #2c3e50; /* Dark Slate Gray */
            color: #3498db; /* Metallic Blue */
            text-align: center;
            padding: 4px 0;
            border-bottom: 1px solid #7f8c8d;
        }
        .calendar-day-number {
            font-weight: bold;
            margin-bottom: 4px;
        }
        .calendar-event {
            background-color: #3498db; /* Metallic Blue */
            color: white;
            border-radius: 3px;
            border-left: 5px solid #2980b9; /* Default category color */
            padding: 2px 4px;
            font-size: 0.7rem;
            margin-bottom: 2px;
            display: block;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            position: relative; /* For tooltip positioning */
            cursor: help;
        }
        /* Tooltip styles */
        .calendar-event .tooltip {
            visibility: hidden;
            width: 220px;
            background-color: #34495e;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 10;
            bottom: 110%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
            white-space: normal;
            font-size: 0.8rem;
            line-height: 1.4;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .calendar-event:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
        .calendar-event .tooltip strong {
            color: #3498db; /* Metallic Blue */
        }
        /* Toast Notification styles */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
        }
        .toast {
            background-color: #34495e; /* Wet Asphalt */
            color: #ecf0f1; /* Silver */
            padding: 15px 20px;
            border-radius: 6px;
            border-left: 5px solid #3498db; /* Default: info */
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.4s ease;
        }
        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        .toast.success { border-left-color: #2ecc71; /* Green */ }
        .toast.error { border-left-color: #e74c3c; /* Red */ }
        /* Back to Top Button */
        #back-to-top-btn {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 30px;
            z-index: 99;
            font-size: 18px;
            border: none;
            outline: none;
            background-color: #3498db;
            color: white;
            cursor: pointer;
            padding: 15px;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            line-height: 18px;
            text-align: center;
        }
        #back-to-top-btn:hover {
            background-color: #2980b9;
        }
        /* Finance tab styles */
        .finance-tab {
            display: none;
        }
        .finance-tab.active {
            display: block;
        }
        /* Announcement priority badges */
        .announcement-item {
            position: relative;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            background: #34495e;
            border-left: 5px solid #7f8c8d;
        }
        .announcement-item.urgent {
            border-left-color: #e74c3c;
            background: #3d2d2d;
        }
        .announcement-item.normal {
            border-left-color: #3498db;
        }
        .announcement-item.info {
            border-left-color: #95a5a6;
        }
        .priority-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 8px;
        }
        .priority-badge.urgent {
            background: #e74c3c;
            color: white;
        }
        .priority-badge.normal {
            background: #3498db;
            color: white;
        }
        .priority-badge.info {
            background: #95a5a6;
            color: white;
        }
        .read-receipt-indicator {
            font-size: 0.75rem;
            color: #95a5a6;
            margin-top: 5px;
        }
        .mark-as-read-btn {
            font-size: 0.75rem;
            padding: 4px 8px;
            margin-top: 5px;
        }
        /* Vote Progress Bars */
        .vote-progress-container {
            margin: 1rem 0;
        }
        .vote-progress-item {
            margin-bottom: 0.75rem;
        }
        .vote-progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }
        .vote-progress-bar-bg {
            background: #2c3e50;
            border-radius: 10px;
            overflow: hidden;
            height: 24px;
            border: 1px solid #7f8c8d;
            position: relative;
        }
        .vote-progress-bar-fill {
            height: 100%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        .vote-progress-bar-fill.for {
            background: linear-gradient(90deg, #27ae60, #2ecc71);
        }
        .vote-progress-bar-fill.against {
            background: linear-gradient(90deg, #c0392b, #e74c3c);
        }
        .vote-progress-bar-fill.abstain {
            background: linear-gradient(90deg, #d68910, #f39c12);
        }
        /* GC Trends Dashboard */
        .trends-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        .trend-chart-container {
            background: #34495e;
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid #7f8c8d;
        }
        .trend-chart-container h4 {
            color: #3498db;
            margin-bottom: 0.5rem;
        }
        /* Amendment Tracking */
        .amendment-timeline {
            border-left: 3px solid #3498db;
            padding-left: 1rem;
            margin: 1rem 0;
        }
        .amendment-item {
            position: relative;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: #34495e;
            border-radius: 6px;
        }
        .amendment-item::before {
            content: '';
            position: absolute;
            left: -1.5rem;
            top: 1rem;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #3498db;
            border: 2px solid #2c3e50;
        }
        .amendment-item.adopted::before {
            background: #2ecc71;
        }
        .amendment-item.rejected::before {
            background: #e74c3c;
        }
        /* Notification Badge */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
        }
        /* Notification Banner Animations */
        @keyframes slideDown {
            from {
                transform: translateX(-50%) translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }
        @keyframes slideUp {
            from {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
            to {
                transform: translateX(-50%) translateY(-100%);
                opacity: 0;
            }
        }
        /* Message styles */
        .message-item {
            background: #34495e;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            border-left: 4px solid #3498db;
        }
        .message-item.unread {
            background: #2d3e4e;
            border-left-color: #e74c3c;
        }
        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .message-subject {
            font-weight: bold;
            color: #3498db;
        }
        .message-date {
            font-size: 0.85rem;
            color: #95a5a6;
        }
        /* Template card styles */
        .template-card {
            background: #34495e;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            border-left: 4px solid #3498db;
        }
        .template-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .template-type-badge {
            font-size: 0.75rem;
            padding: 3px 8px;
            border-radius: 3px;
            background: #2980b9;
            color: white;
        }
        /* Service position card */
        .position-card {
            background: #34495e;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        .term-warning {
            color: #f39c12;
            font-weight: bold;
        }
        .term-expired {
            color: #e74c3c;
            font-weight: bold;
        }
        /* Nomination card */
        .nomination-card {
            background: #2c3e50;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 4px;
            border-left: 3px solid #3498db;
        }
        /* Chart container */
        #yoy-chart {
            min-height: 300px;
        }
        /* Utility classes */
        .mt-4 { margin-top: 1rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        /* ========================================
           PRINT STYLESHEETS
           ======================================== */
        @media print {
            /* Hide navigation and UI elements */
            nav, #toast-container, #back-to-top-btn, .btn, button {
                display: none !important;
            }
            /* Reset colors for printing */
            body {
                background: white;
                color: black;
            }
            .box, section {
                background: white !important;
                border: 1px solid #000;
                page-break-inside: avoid;
            }
            /* Optimize tables for printing */
            table {
                border-collapse: collapse;
                width: 100%;
                page-break-inside: avoid;
            }
            th, td {
                border: 1px solid #000;
                padding: 0.5rem;
                color: black !important;
                background: white !important;
            }
            th {
                background: #e0e0e0 !important;
                font-weight: bold;
            }
            /* Page breaks */
            h1, h2, h3 {
                page-break-after: avoid;
                color: black !important;
            }
            /* Show URLs for links */
            a[href]:after {
                content: " (" attr(href) ")";
            }
            /* Optimize charts for printing */
            canvas {
                max-width: 100%;
                page-break-inside: avoid;
            }
            /* Print-specific header */
            @page {
                margin: 2cm;
            }
            body::before {
                content: "HomeGroup - Printed: " attr(data-print-date);
                display: block;
                text-align: center;
                font-size: 0.8rem;
                padding-bottom: 1rem;
                border-bottom: 1px solid #000;
                margin-bottom: 1rem;
            }
        }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <div id="toast-container" role="status" aria-live="polite" aria-atomic="true"></div>
    <button id="back-to-top-btn" title="Go to top" aria-label="Back to top"><i class="fas fa-arrow-up" aria-hidden="true"></i></button>
    <nav role="navigation" aria-label="Main navigation">
        <div class="logo">
            <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <circle cx="50" cy="50" r="48" fill="#3498db"/>
                <text x="50" y="57" text-anchor="middle" font-size="32" fill="white" font-family="Verdana, sans-serif" font-weight="bold">HG</text>
            </svg>
            <span>HomeGroup</span>
        </div>
        <ul id="nav-menu">
            <li data-section="home-section" class="active">Home</li>
            <li data-section="help-section" style="color: #9b59b6;"><i class="fas fa-question-circle"></i> Help & Guide</li>
            <li class="has-dropdown">
                Meetings
                <ul class="dropdown-menu">
                    <li data-section="schedule-section">Schedule & Calendar</li>
                    <li data-section="format-rotation-section">Format Rotation</li>
                    <li data-section="companion-section">Meeting Companion</li>
                    <li data-section="commitment-board-section">Commitment Board</li>
                    <li data-section="commitment-tracking-section">Commitment Tracking</li>
                    <li data-section="secretary-section">Secretary Functions</li>
                    <li data-section="meeting-feedback-section" style="border-top: 1px solid #7f8c8d; margin-top: 0.5rem; padding-top: 0.5rem;">Meeting Format Feedback</li>
                    <li onclick="openMeetingFeedbackSurvey()"><i class="fas fa-comment-dots"></i> Meeting Feedback Survey</li>
                    <li onclick="viewMeetingFeedbackResults()"><i class="fas fa-chart-bar"></i> View Feedback Results</li>
                    <li data-section="speaker-booking-section" style="border-top: 1px solid #7f8c8d; margin-top: 0.5rem; padding-top: 0.5rem;">Speaker Meeting Booking</li>
                    <li data-section="chip-ceremony-section">Chip Ceremony Scheduler</li>
                    <li data-section="meeting-analytics-section">Meeting Attendance Analytics</li>
                    <li data-section="role-rotation-section">Meeting Role Rotation</li>
                    <li data-section="virtual-meeting-section">Virtual Meeting Integration</li>
                    <li data-section="qr-checkin-section">QR Code Check-in</li>
                </ul>
            </li>
            <li class="has-dropdown">
                Fellowship
                <ul class="dropdown-menu">
                    <li data-section="birthdays-section">Birthdays & Anniversaries</li>
                    <li data-section="attendance-streaks-section">Attendance Streaks</li>
                    <li data-section="member-wellness-section">Member Wellness Check</li>
                    <li data-section="newcomer-section">Newcomer Tracking</li>
                    <li data-section="sponsors-section">Available Sponsors</li>
                    <li data-section="sponsor-matching-section">Temporary Sponsor Matching</li>
                    <li data-section="topic-suggestions-section">Topic Suggestions</li>
                    <li data-section="call-roster-section">12-Step Call Roster</li>
                    <li data-section="emergency-contacts-section">Emergency Contacts</li>
                    <li data-section="problem-box-section">Problem Box</li>
                    <li data-section="announcements-section">Announcements</li>
                    <li data-section="messaging-section">Messages</li>
                    <li data-section="communication-lists-section">Text/Email Lists</li>
                    <li data-section="meeting-reminders-section">Meeting Reminders</li>
                    <li data-section="notifications-section">Birthday/Anniversary Notifications</li>
                    <li data-section="action-items-section">Action Item Assignments</li>
                    <li data-section="cancellation-alerts-section">Meeting Cancellation Alerts</li>
                    <li data-section="welcome-packet-section">Welcome Packet Generator</li>
                    <li data-section="gallery-section">Photo Gallery</li>
                    <li data-section="temperature-check-section" style="border-top: 1px solid #7f8c8d; margin-top: 0.5rem; padding-top: 0.5rem;">Group Temperature Check</li>
                    <li data-section="satisfaction-survey-section">Satisfaction Survey</li>
                </ul>
            </li>
            <li class="has-dropdown">
                Home Group
                <ul class="dropdown-menu">
                    <li data-section="inter-group-section">Inter-Group Connections</li>
                    <li data-section="hg-transfer-section">Home Group Transfer</li>
                    <li data-section="hg-benefits-section">Home Group Benefits Tracking</li>
                    <li data-section="hg-commitment-section">Home Group Commitment Level</li>
                    <li data-section="hg-census-section">Home Group Census</li>
                    <li data-section="hg-growth-section">Home Group Growth Metrics</li>
                </ul>
            </li>
            <li class="has-dropdown">
                Group Conscience
                <ul class="dropdown-menu">
                    <li data-section="gc-live-section">Live GC Session</li>
                    <li data-section="parliamentary-section">Parliamentary Procedure</li>
                    <li data-section="gc-decisions-section">Decision History</li>
                    <li data-section="motion-templates-section">Motion Templates</li>
                    <li data-section="tradition-checker-section">Tradition & Concept Checker</li>
                    <li data-section="tradition-moments-section">Tradition Moments</li>
                    <li data-section="spiritual-principles-section">Spiritual Principles</li>
                    <li data-section="unity-checker-section">Unity Checker</li>
                    <li data-section="gc-inventory-section">GC Inventory</li>
                    <li data-section="inventory-questions-section">Group Inventory Question Bank</li>
                    <li data-section="tradition-study-section">Tradition Study Curriculum</li>
                    <li data-section="concept-study-section">Concept Study Curriculum</li>
                    <li data-section="conflict-resolution-section">Conflict Resolution Tracker</li>
                    <li data-section="gc-bylaws-section">Guidelines & By-Laws</li>
                    <li data-section="group-vision-section">Group Vision Statement</li>
                    <li data-section="voting-settings-section">Voting Settings</li>
                </ul>
            </li>
            <li class="has-dropdown">
                Service
                <ul class="dropdown-menu">
                    <li data-section="service-positions-section">Service Positions</li>
                    <li data-section="service-elections-section">Service Elections</li>
                    <li data-section="service-opportunities-section">Service Opportunities</li>
                    <li data-section="sponsorship-section">Sponsorship Tracking</li>
                    <li data-section="sponsorship-tree-section">Sponsorship Tree Visualization</li>
                    <li data-section="hi-commitments-section">H&I Meeting Commitments</li>
                    <li data-section="service-hours-section">Service Hours Tracking</li>
                    <li data-section="special-events-mgmt-section" style="border-top: 1px solid #7f8c8d; margin-top: 0.5rem; padding-top: 0.5rem;">Group Special Events</li>
                </ul>
            </li>
            <li class="has-dropdown">
                District & Area
                <ul class="dropdown-menu">
                    <li data-section="district-area-section">District/Area Committee</li>
                    <li data-section="district-motions-section">District Motions</li>
                    <li data-section="service-structure-section">Service Structure</li>
                    <li data-section="area-assembly-section" style="border-top: 1px solid #7f8c8d; margin-top: 0.5rem; padding-top: 0.5rem;">Area Assembly Integration</li>
                    <li data-section="intergroup-section">Intergroup Representative</li>
                    <li data-section="hi-panel-section" style="border-top: 1px solid #7f8c8d; margin-top: 0.5rem; padding-top: 0.5rem;">H&I Panel Management</li>
                    <li data-section="cpc-section">CPC (Professional Community)</li>
                    <li data-section="pi-section">PI (Public Information)</li>
                    <li data-section="treatment-liaison-section">Treatment Facilities Liaison</li>
                    <li data-section="corrections-section">Corrections Committee</li>
                    <li data-section="language-access-section" style="border-top: 1px solid #7f8c8d; margin-top: 0.5rem; padding-top: 0.5rem;">Language Accessibility</li>
                </ul>
            </li>
            <li class="has-dropdown">
                Treasury
                <ul class="dropdown-menu">
                    <li data-section="finance-section">Financial Reports</li>
                    <li data-section="budget-approval-section">Budget Approval</li>
                    <li data-section="contribution-comparison-section">Contribution Comparison</li>
                    <li data-section="expense-approval-section">Expense Approval Workflow</li>
                    <li data-section="bill-reminders-section">Bill Payment Reminders</li>
                    <li data-section="contribution-calculator-section">Group Contribution Calculator</li>
                    <li data-section="financial-goals-section">Financial Goals Tracker</li>
                    <li data-section="expense-receipts-section">Expense Receipt Upload</li>
                    <li data-section="quarterly-reports-section">Quarterly Financial Reports</li>
                    <li data-section="seventh-tradition-section">7th Tradition Analysis</li>
                    <li data-section="prudent-reserve-section">Prudent Reserve</li>
                    <li data-section="chip-inventory-section">Chip Inventory</li>
                </ul>
            </li>
            <li class="has-dropdown">
                Reports
                <ul class="dropdown-menu">
                    <li data-section="chairperson-section">Chairperson Reports</li>
                    <li data-section="meeting-minutes-section">Meeting Minutes</li>
                    <li data-section="analytics-section">Group Analytics</li>
                    <li data-section="participation-analytics-section">Participation Analytics</li>
                    <li data-section="financial-health-section">Financial Health</li>
                    <li data-section="decision-impact-section">Decision Impact</li>
                    <li onclick="displayExecutiveDashboard()" style="border-top: 1px solid #7f8c8d; margin-top: 0.5rem; padding-top: 0.5rem;"><i class="fas fa-tachometer-alt"></i> Executive Dashboard</li>
                    <li onclick="openGSRDashboard()"><i class="fas fa-handshake"></i> GSR Dashboard</li>
                </ul>
            </li>
            <li class="has-dropdown">
                Resources
                <ul class="dropdown-menu">
                    <li data-section="daily-reflections-section">Daily Reflections</li>
                    <li data-section="step-tracker-section">Step Work Tracker</li>
                    <li data-section="bigbook-tracker-section">Big Book Study Tracker</li>
                    <li data-section="literature-inventory-section">Literature Inventory</li>
                    <li data-section="literature-loans-section">Literature Loan Library</li>
                    <li data-section="newcomer-packs-section">Newcomer Starter Packs</li>
                    <li data-section="literature-sales-section">Literature Sales Tracking</li>
                    <li data-section="digital-library-section">Digital Literature Library</li>
                    <li data-section="study-guide-section">Study Guide Generator</li>
                    <li data-section="history-section">Group History</li>
                    <li data-section="templates-section">Document Templates</li>
                    <li data-section="digital-archive-section" style="border-top: 1px solid #7f8c8d; margin-top: 0.5rem; padding-top: 0.5rem;">Group Archives</li>
                    <li data-section="oral-history-section">Oral History Collection</li>
                    <li data-section="milestones-section">Group Milestones</li>
                    <li data-section="member-legacy-section">Member Legacy</li>
                    <li data-section="historical-minutes-section">Historical Meeting Minutes</li>
                    <li onclick="displayTraditionOfMonth()" style="border-top: 1px solid #7f8c8d; margin-top: 0.5rem; padding-top: 0.5rem;"><i class="fas fa-book-open"></i> Tradition of the Month</li>
                    <li onclick="scheduleGroupInventory()"><i class="fas fa-tasks"></i> Schedule Group Inventory</li>
                </ul>
            </li>
            <li onclick="displayUniversalSearch()" style="cursor: pointer; position: relative;" title="Universal Search" role="button" tabindex="0" aria-label="Universal Search" onkeypress="if(event.key==='Enter'){displayUniversalSearch()}">
                <i class="fas fa-search" aria-hidden="true"></i>
            </li>
            <li onclick="showNotificationCenter()" style="cursor: pointer; position: relative;" role="button" tabindex="0" aria-label="Notifications" onkeypress="if(event.key==='Enter'){showNotificationCenter()}">
                <i class="fas fa-bell" aria-hidden="true"></i>
                <span id="notification-badge" style="display: none; position: absolute; top: -5px; right: -5px; background: #e74c3c; color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.7rem; font-weight: bold;" aria-label="unread notifications">0</span>
            </li>
            <li class="has-dropdown">
                <i class="fas fa-cog"></i>
                <ul class="dropdown-menu">
                    <li data-section="settings-section">General Settings</li>
                    <li data-section="privacy-section">Privacy & Anonymity</li>
                    <li data-section="quorum-management-section">Quorum Management</li>
                    <li data-section="inventory-scheduler-section">Group Inventory Scheduler</li>
                    <li data-section="role-settings-section">Role & View Settings</li>
                    <li onclick="viewBackupHistory()" style="border-top: 1px solid #7f8c8d; margin-top: 0.5rem; padding-top: 0.5rem; opacity: 0.7; font-size: 0.85rem; font-weight: 600; color: #95a5a6; pointer-events: none;"><i class="fas fa-server"></i> SYSTEM</li>
                    <li onclick="viewBackupHistory()"><i class="fas fa-database"></i> Backup & Restore</li>
                    <li onclick="viewAuditLog()"><i class="fas fa-history"></i> Audit Log</li>
                    <li onclick="displayEngagementDashboard()"><i class="fas fa-chart-line"></i> Engagement Metrics</li>
                    <li data-section="calendar-integration-section" style="border-top: 1px solid #7f8c8d; margin-top: 0.5rem; padding-top: 0.5rem; opacity: 0.7; font-size: 0.85rem; font-weight: 600; color: #95a5a6; pointer-events: none;"><i class="fas fa-plug"></i> INTEGRATIONS</li>
                    <li data-section="calendar-integration-section">Google Calendar Integration</li>
                    <li data-section="sms-integration-section">SMS Integration</li>
                    <li data-section="email-automation-section">Email Automation</li>
                    <li data-section="cloud-backup-section">Cloud Backup</li>
                    <li data-section="multi-group-section">Multi-Group Support</li>
                    <li data-section="aa-finder-section">AA Meeting Finder</li>
                    <li data-section="offline-mode-section" style="border-top: 1px solid #7f8c8d; margin-top: 0.5rem; padding-top: 0.5rem; opacity: 0.7; font-size: 0.85rem; font-weight: 600; color: #95a5a6; pointer-events: none;"><i class="fas fa-mobile-alt"></i> MOBILE & PWA</li>
                    <li data-section="offline-mode-section">Offline Mode</li>
                    <li data-section="mobile-features-section">Mobile Features</li>
                    <li data-section="touch-gestures-section">Touch Gestures</li>
                    <li data-section="pwa-install-section">Install as App</li>
                    <li data-section="accessibility-section" style="border-top: 1px solid #7f8c8d; margin-top: 0.5rem; padding-top: 0.5rem; opacity: 0.7; font-size: 0.85rem; font-weight: 600; color: #95a5a6; pointer-events: none;"><i class="fas fa-universal-access"></i> ACCESSIBILITY</li>
                    <li data-section="accessibility-section">Accessibility Settings</li>
                    <li data-section="multi-language-section">Multi-Language Support</li>
                    <li data-section="large-print-section">Large Print Mode</li>
                    <li data-section="screen-reader-section">Screen Reader Optimization</li>
                    <li data-section="captions-section">Closed Captioning</li>
                    <li data-section="accessibility-committee-section">Accessibility Committee</li>
                </ul>
            </li>
        </ul>
    </nav>
    <main id="main-content" role="main">
        <section id="home-section" class="active" style="border-left: 4px solid #3498db;">
            <h1><i class="fas fa-home"></i> Welcome to HomeGroup</h1>
            <p class="mb-4">Your complete Home Group management portal for meeting schedules, member tracking, Group Conscience decisions, and fellowship activities. All data is stored securely in your browser for privacy and anonymity.</p>
            <div class="grid grid-cols-2">
                <div class="box">
                    <h3>Upcoming Meetings</h3>
                    <a id="zoom-meeting-btn" href="#" class="btn" style="display: none; text-align: center; margin-bottom: 1rem;">
                        <i class="fas fa-video"></i> Start Zoom Meeting
                    </a>
                    <p id="zoom-meeting-note" style="font-size: 0.8rem; text-align: center; margin-bottom: 1rem; display: none;">(Requires Zoom to be installed)</p>
                    <ul id="home-upcoming-events" style="margin-bottom: 1rem; min-height: 60px;"></ul>
                    <button class="btn" onclick="goToSection('schedule-section')">View Full Schedule</button>
                </div>
                <div class="box">
                    <h3>Upcoming Birthdays</h3>
                    <ul id="home-upcoming-birthdays" style="margin-bottom: 1rem; min-height: 60px;"></ul>
                    <button class="btn" onclick="goToSection('birthdays-section')">Manage Birthdays</button>
                </div>
                <div class="box">
                    <h3>Recent Announcements</h3>
                    <ul id="home-recent-announcements" style="margin-bottom: 1rem; min-height: 60px;"></ul>
                    <button class="btn" onclick="goToSection('announcements-section')">View All Announcements</button>
                </div>
                <div class="box">
                    <h3>Latest Photos</h3>
                    <div id="home-latest-photos" style="display:flex; gap:0.5rem; overflow-x: auto; margin-bottom: 1rem; min-height: 60px;"></div>
                    <button class="btn" onclick="goToSection('gallery-section')">Browse Gallery</button>
                </div>
                <div id="qr-code-box" class="box" style="text-align: center; display: none;">
                    <h3>7th Tradition</h3>
                    <img id="qr-code-img" src="" alt="7th Tradition QR Code" style="width: 250px; height: 250px; margin: auto; border-radius: 8px;">
                    <p id="qr-code-contact" class="mt-2"></p>
                </div>
                <div class="box">
                    <h3>Leadership Tools</h3>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem; min-height: 60px;">
                        <button class="btn" onclick="displayExecutiveDashboard()" style="font-size: 0.9rem;">
                            <i class="fas fa-tachometer-alt"></i> Executive Dashboard
                        </button>
                        <button class="btn" onclick="openGSRDashboard()" style="font-size: 0.9rem;">
                            <i class="fas fa-handshake"></i> GSR Dashboard
                        </button>
                        <button class="btn" onclick="displayTraditionOfMonth()" style="font-size: 0.9rem;">
                            <i class="fas fa-book-open"></i> Tradition of the Month
                        </button>
                    </div>
                </div>
                <div class="box">
                    <h3>Quick Actions</h3>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem; min-height: 60px;">
                        <button class="btn" onclick="initiateEmergencyGC()" style="font-size: 0.9rem; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); font-weight: bold;">
                            <i class="fas fa-exclamation-triangle"></i> Emergency GC Protocol
                        </button>
                        <button class="btn" onclick="displayUniversalSearch()" style="font-size: 0.9rem;">
                            <i class="fas fa-search"></i> Universal Search
                        </button>
                        <button class="btn" onclick="scheduleGroupInventory()" style="font-size: 0.9rem;">
                            <i class="fas fa-tasks"></i> Schedule Group Inventory
                        </button>
                        <button class="btn" onclick="showNotificationCenter()" style="font-size: 0.9rem;">
                            <i class="fas fa-bell"></i> Notification Center
                            <span id="home-notification-badge" style="display: none; background: #e74c3c; color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.7rem; font-weight: bold; margin-left: 0.5rem;">0</span>
                        </button>
                    </div>
                </div>
            </div>
            <div style="margin-top: 2rem;">
                <h2 style="color: #3498db; border-bottom: 2px solid #3498db; padding-bottom: 0.5rem; margin-bottom: 1.5rem;">
                    <i class="fas fa-tachometer-alt"></i> Command Center
                </h2>
                <div class="box mb-4" style="border-left: 4px solid #e74c3c;">
                    <h3><i class="fas fa-exclamation-triangle"></i> Attention Required</h3>
                    <div id="attention-items" style="min-height: 60px;">
                    </div>
                </div>
                <div class="box mb-4" style="border-left: 4px solid #f39c12;">
                    <h3><i class="fas fa-calendar-check"></i> Upcoming Events (Next 30 Days)</h3>
                    <div id="upcoming-timeline" style="min-height: 60px;">
                    </div>
                </div>
                <div class="box mb-4" style="border-left: 4px solid #3498db;">
                    <h3><i class="fas fa-stream"></i> Recent Activity Feed</h3>
                    <div id="activity-feed" style="min-height: 60px;">
                    </div>
                </div>
            </div>
            <div style="margin-top: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="color: #2ecc71; border-bottom: 2px solid #2ecc71; padding-bottom: 0.5rem; margin: 0; flex: 1;">
                        <i class="fas fa-heartbeat"></i> Group Health Metrics
                    </h2>
                    <button class="btn" onclick="viewDetailedHealthReport()" style="background: #2ecc71; white-space: nowrap; margin-left: 1rem;">
                        <i class="fas fa-chart-line"></i> Detailed Report
                    </button>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                    <div class="box" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); text-align: center; padding: 1.5rem;">
                        <div style="font-size: 2rem; font-weight: bold;" id="participation-rate">--%</div>
                        <div style="font-size: 0.85rem; opacity: 0.9; margin-top: 0.5rem;">GC Participation</div>
                        <div style="font-size: 0.75rem; opacity: 0.7; margin-top: 0.25rem;">Last 3 months</div>
                    </div>
                    <div class="box" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); text-align: center; padding: 1.5rem;">
                        <div style="font-size: 2rem; font-weight: bold;" id="consensus-rate">--%</div>
                        <div style="font-size: 0.85rem; opacity: 0.9; margin-top: 0.5rem;">Consensus Rate</div>
                        <div style="font-size: 0.75rem; opacity: 0.7; margin-top: 0.25rem;">Substantial unanimity</div>
                    </div>
                    <div class="box" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); text-align: center; padding: 1.5rem;">
                        <div style="font-size: 2rem; font-weight: bold;" id="action-completion-rate">--%</div>
                        <div style="font-size: 0.85rem; opacity: 0.9; margin-top: 0.5rem;">Action Completion</div>
                        <div style="font-size: 0.75rem; opacity: 0.7; margin-top: 0.25rem;">On-time delivery</div>
                    </div>
                    <div class="box" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); text-align: center; padding: 1.5rem;">
                        <div style="font-size: 2rem; font-weight: bold;" id="service-filled-rate">--%</div>
                        <div style="font-size: 0.85rem; opacity: 0.9; margin-top: 0.5rem;">Service Positions</div>
                        <div style="font-size: 0.75rem; opacity: 0.7; margin-top: 0.25rem;">Filled vs vacant</div>
                    </div>
                    <div class="box" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); text-align: center; padding: 1.5rem;">
                        <div style="font-size: 2rem; font-weight: bold;" id="prudent-reserve-status">--</div>
                        <div style="font-size: 0.85rem; opacity: 0.9; margin-top: 0.5rem;">Prudent Reserve</div>
                        <div style="font-size: 0.75rem; opacity: 0.7; margin-top: 0.25rem;">3-month operating</div>
                    </div>
                    <div class="box" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); text-align: center; padding: 1.5rem; color: #2c3e50;">
                        <div style="font-size: 2rem; font-weight: bold;" id="avg-attendance">--</div>
                        <div style="font-size: 0.85rem; opacity: 0.9; margin-top: 0.5rem;">Avg. Attendance</div>
                        <div style="font-size: 0.75rem; opacity: 0.7; margin-top: 0.25rem;">Weekly meetings</div>
                    </div>
                </div>
                <div class="box" style="border-left: 4px solid #2ecc71;">
                    <h3><i class="fas fa-chart-line"></i> Health Trends</h3>
                    <div id="health-trends" style="min-height: 100px;">
                    </div>
                </div>
            </div>
        </section>
        <section id="help-section" style="border-left: 4px solid #9b59b6;">
            <h1><i class="fas fa-question-circle"></i> User Guide & Instructions</h1>
            <p class="mb-4">Complete guide to using the HomeGroup Management Portal for daily operations and Group Conscience meetings.</p>
            <div class="box mb-4" style="border-left: 4px solid #3498db;">
                <h2><i class="fas fa-info-circle"></i> Application Overview</h2>
                <p>This is a comprehensive Home Group Management System designed specifically for AA groups. All data is stored locally in your browser using localStorage, ensuring privacy and anonymity. The application works offline after the initial load and requires no server or external database.</p>
                <h3 style="margin-top: 1.5rem;">Complete Feature Set (100+ Features)</h3>
                <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin-top: 1rem;">
                    <div style="padding: 1rem; background: #34495e; border-left: 4px solid #3498db; border-radius: 6px;">
                        <h4 style="margin-bottom: 0.5rem;"><i class="fas fa-calendar-alt"></i> Meeting Management (13)</h4>
                        <p style="font-size: 0.85rem; line-height: 1.6;">Schedule & calendar, format rotation, commitment board, secretary functions, meeting companion, attendance analytics, role rotation, virtual meeting integration, QR check-in, feedback surveys, speaker booking, chip ceremonies</p>
                    </div>
                    <div style="padding: 1rem; background: #34495e; border-left: 4px solid #e67e22; border-radius: 6px;">
                        <h4 style="margin-bottom: 0.5rem;"><i class="fas fa-users"></i> Fellowship & Engagement (19)</h4>
                        <p style="font-size: 0.85rem; line-height: 1.6;">Birthdays & anniversaries, attendance streaks, wellness checks, newcomer tracking, sponsors, temp sponsor matching, emergency contacts, topic suggestions, 12-step calls, problem box, announcements, messaging, photo gallery, temperature check, satisfaction survey, communications lists, reminders, action items, welcome packets</p>
                    </div>
                    <div style="padding: 1rem; background: #34495e; border-left: 4px solid #9b59b6; border-radius: 6px;">
                        <h4 style="margin-bottom: 0.5rem;"><i class="fas fa-gavel"></i> Group Conscience (16)</h4>
                        <p style="font-size: 0.85rem; line-height: 1.6;">Live GC sessions, emergency GC, decision history, motion templates, parliamentary procedure, tradition checker, tradition moments, spiritual principles, unity checker, inventory, inventory questions, tradition study, concept study, conflict resolution, by-laws repository, voting settings</p>
                    </div>
                    <div style="padding: 1rem; background: #34495e; border-left: 4px solid #f1c40f; border-radius: 6px;">
                        <h4 style="margin-bottom: 0.5rem;"><i class="fas fa-money-bill-wave"></i> Financial Management (12)</h4>
                        <p style="font-size: 0.85rem; line-height: 1.6;">Financial reports, budget approval, contribution comparison, expense approval workflow, bill reminders, contribution calculator, financial goals tracker, receipt upload, quarterly reports, 7th tradition analysis, prudent reserve, chip inventory</p>
                    </div>
                    <div style="padding: 1rem; background: #34495e; border-left: 4px solid #2ecc71; border-radius: 6px;">
                        <h4 style="margin-bottom: 0.5rem;"><i class="fas fa-hands-helping"></i> Group Service (8)</h4>
                        <p style="font-size: 0.85rem; line-height: 1.6;">Service positions, elections, opportunities board, sponsorship tracking, sponsorship tree visualization, H&I meeting commitments, service hours tracking, group special events</p>
                    </div>
                    <div style="padding: 1rem; background: #34495e; border-left: 4px solid #8e44ad; border-radius: 6px;">
                        <h4 style="margin-bottom: 0.5rem;"><i class="fas fa-sitemap"></i> District & Area Service (11)</h4>
                        <p style="font-size: 0.85rem; line-height: 1.6;">District/Area committee, District motions, Service structure, Area Assembly integration, Intergroup representative, H&I panel management, CPC, PI, treatment facilities, corrections, language accessibility</p>
                    </div>
                    <div style="padding: 1rem; background: #34495e; border-left: 4px solid #16a085; border-radius: 6px;">
                        <h4 style="margin-bottom: 0.5rem;"><i class="fas fa-home"></i> Home Group Specific (6)</h4>
                        <p style="font-size: 0.85rem; line-height: 1.6;">Inter-group connections, home group transfers, benefits tracking, commitment levels, group census, growth metrics</p>
                    </div>
                    <div style="padding: 1rem; background: #34495e; border-left: 4px solid #95a5a6; border-radius: 6px;">
                        <h4 style="margin-bottom: 0.5rem;"><i class="fas fa-book"></i> Literature & Resources (11)</h4>
                        <p style="font-size: 0.85rem; line-height: 1.6;">Daily reflections, step tracker, Big Book study tracker, literature inventory, literature loans, newcomer packs, literature sales, digital library, study guide generator, document templates, group history</p>
                    </div>
                    <div style="padding: 1rem; background: #34495e; border-left: 4px solid #1abc9c; border-radius: 6px;">
                        <h4 style="margin-bottom: 0.5rem;"><i class="fas fa-chart-line"></i> Reports & Analytics (6)</h4>
                        <p style="font-size: 0.85rem; line-height: 1.6;">Chairperson reports, meeting minutes, group analytics, participation analytics, financial health, decision impact tracking</p>
                    </div>
                    <div style="padding: 1rem; background: #34495e; border-left: 4px solid #3498db; border-radius: 6px;">
                        <h4 style="margin-bottom: 0.5rem;"><i class="fas fa-plug"></i> Integration & Mobile (10)</h4>
                        <p style="font-size: 0.85rem; line-height: 1.6;">Google Calendar export, SMS integration, email automation, cloud backup, multi-group support, AA meeting finder, offline mode, mobile features, touch gestures, PWA app install</p>
                    </div>
                    <div style="padding: 1rem; background: #34495e; border-left: 4px solid #f39c12; border-radius: 6px;">
                        <h4 style="margin-bottom: 0.5rem;"><i class="fas fa-universal-access"></i> Accessibility (6)</h4>
                        <p style="font-size: 0.85rem; line-height: 1.6;">Accessibility settings, multi-language support, large print mode, screen reader optimization, closed captioning, accessibility committee</p>
                    </div>
                    <div style="padding: 1rem; background: #34495e; border-left: 4px solid #7f8c8d; border-radius: 6px;">
                        <h4 style="margin-bottom: 0.5rem;"><i class="fas fa-archive"></i> Archival & History (5)</h4>
                        <p style="font-size: 0.85rem; line-height: 1.6;">Digital archive, oral history collection, group milestones, member legacy tributes, historical minutes search</p>
                    </div>
                    <div style="padding: 1rem; background: #34495e; border-left: 4px solid #e67e22; border-radius: 6px;">
                        <h4 style="margin-bottom: 0.5rem;"><i class="fas fa-sitemap"></i> Area & District Service (10)</h4>
                        <p style="font-size: 0.85rem; line-height: 1.6;">Area Assembly integration, Intergroup representative, H&I panel management, CPC professional community, PI public information, treatment facilities liaison, corrections committee, special events management, archives management, language accessibility</p>
                    </div>
                </div>
                <h3 style="margin-top: 1.5rem;">Data Privacy & Security</h3>
                <p><strong style="color: #f39c12;"><i class="fas fa-shield-alt"></i> Your data never leaves your device.</strong> All information is stored in your browser's localStorage. Make regular backups using the Backup & Restore feature in Settings.</p>
            </div>
            <div class="box mb-4" style="border-left: 4px solid #f39c12;">
                <h2><i class="fas fa-palette"></i> Color Schema Guide</h2>
                <p>The application uses a consistent color-coding system to help you navigate quickly:</p>
                <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-top: 1rem;">
                    <div style="padding: 1rem; background: #3498db; border-radius: 6px;">
                        <h4 style="margin-bottom: 0.5rem;"><i class="fas fa-square" style="color: #3498db;"></i> Blue (#3498db)</h4>
                        <p style="font-size: 0.9rem;">General features, meetings, schedules, information sections</p>
                    </div>
                    <div style="padding: 1rem; background: #2c3e50; border-left: 4px solid #9b59b6; border-radius: 6px;">
                        <h4 style="margin-bottom: 0.5rem;"><i class="fas fa-square" style="color: #9b59b6;"></i> Purple (#9b59b6)</h4>
                        <p style="font-size: 0.9rem;">Group Conscience features, voting, decisions, parliamentary procedure</p>
                    </div>
                    <div style="padding: 1rem; background: #2c3e50; border-left: 4px solid #2ecc71; border-radius: 6px;">
                        <h4 style="margin-bottom: 0.5rem;"><i class="fas fa-square" style="color: #2ecc71;"></i> Green (#2ecc71)</h4>
                        <p style="font-size: 0.9rem;">Service positions, positive outcomes, consent agenda, approved items</p>
                    </div>
                    <div style="padding: 1rem; background: #2c3e50; border-left: 4px solid #f1c40f; border-radius: 6px;">
                        <h4 style="margin-bottom: 0.5rem;"><i class="fas fa-square" style="color: #f1c40f;"></i> Gold (#f1c40f)</h4>
                        <p style="font-size: 0.9rem;">Treasury, financial reports, budget, 7th tradition, prudent reserve</p>
                    </div>
                    <div style="padding: 1rem; background: #2c3e50; border-left: 4px solid #f39c12; border-radius: 6px;">
                        <h4 style="margin-bottom: 0.5rem;"><i class="fas fa-square" style="color: #f39c12;"></i> Orange (#f39c12)</h4>
                        <p style="font-size: 0.9rem;">Announcements, birthdays, warnings, amendments, ROI calculations</p>
                    </div>
                    <div style="padding: 1rem; background: #2c3e50; border-left: 4px solid #e74c3c; border-radius: 6px;">
                        <h4 style="margin-bottom: 0.5rem;"><i class="fas fa-square" style="color: #e74c3c;"></i> Red (#e74c3c)</h4>
                        <p style="font-size: 0.9rem;">Emergency GC, critical actions, tabled motions, decision reversals</p>
                    </div>
                    <div style="padding: 1rem; background: #2c3e50; border-left: 4px solid #1abc9c; border-radius: 6px;">
                        <h4 style="margin-bottom: 0.5rem;"><i class="fas fa-square" style="color: #1abc9c;"></i> Teal (#1abc9c)</h4>
                        <p style="font-size: 0.9rem;">Reports, analytics, chairperson functions, implementation tracking</p>
                    </div>
                    <div style="padding: 1rem; background: #2c3e50; border-left: 4px solid #95a5a6; border-radius: 6px;">
                        <h4 style="margin-bottom: 0.5rem;"><i class="fas fa-square" style="color: #95a5a6;"></i> Gray (#95a5a6)</h4>
                        <p style="font-size: 0.9rem;">Templates, resources, history, archived items, neutral information</p>
                    </div>
                </div>
            </div>
            <div class="box mb-4" style="border-left: 4px solid #2ecc71;">
                <h2><i class="fas fa-calendar-day"></i> Day-to-Day Operations Guide</h2>
                <h3 style="color: #3498db;"><i class="fas fa-tasks"></i> Daily Tasks</h3>
                <div style="padding: 1rem; background: #34495e; border-radius: 6px; margin: 1rem 0;">
                    <h4>1. Check Dashboard (Home Section)</h4>
                    <ul style="line-height: 1.8;">
                        <li>Review upcoming events and birthdays</li>
                        <li>Check active announcements</li>
                        <li>Monitor service position status</li>
                        <li>Review pending GC action items</li>
                    </ul>
                </div>
                <div style="padding: 1rem; background: #34495e; border-radius: 6px; margin: 1rem 0;">
                    <h4>2. Before Each Meeting (Schedule Section)</h4>
                    <ul style="line-height: 1.8;">
                        <li>Navigate to <strong>Meetings → Schedule & Calendar</strong></li>
                        <li>Verify meeting time and location</li>
                        <li>Check format rotation (Meetings → Format Rotation)</li>
                        <li>Review commitment board (Meetings → Commitment Board)</li>
                        <li>Prepare secretary notes if needed</li>
                    </ul>
                </div>
                <div style="padding: 1rem; background: #34495e; border-radius: 6px; margin: 1rem 0;">
                    <h4>3. During Meetings (Secretary Functions)</h4>
                    <ul style="line-height: 1.8;">
                        <li>Go to <strong>Meetings → Secretary Functions</strong></li>
                        <li>Record attendance using the attendance tracker</li>
                        <li>Take meeting minutes in real-time</li>
                        <li>Log 7th tradition contributions</li>
                        <li>Track who shares (if applicable)</li>
                    </ul>
                </div>
                <div style="padding: 1rem; background: #34495e; border-radius: 6px; margin: 1rem 0;">
                    <h4>4. Weekly Treasurer Tasks (Treasury Sections)</h4>
                    <ul style="line-height: 1.8;">
                        <li><strong>Finance → Financial Reports:</strong> Update income/expenses</li>
                        <li><strong>Finance → 7th Tradition Analysis:</strong> Review contribution trends</li>
                        <li><strong>Finance → Prudent Reserve:</strong> Monitor reserve target</li>
                        <li>Generate monthly financial reports when needed</li>
                    </ul>
                </div>
                <div style="padding: 1rem; background: #34495e; border-radius: 6px; margin: 1rem 0;">
                    <h4>5. Service Position Management (Service Section)</h4>
                    <ul style="line-height: 1.8;">
                        <li><strong>Service → Service Positions:</strong> Track current positions</li>
                        <li>Monitor term expiration dates</li>
                        <li>Prepare for elections 30 days before term ends</li>
                        <li>Update position holders after elections</li>
                    </ul>
                </div>
            </div>
            <div class="box mb-4" style="border-left: 4px solid #9b59b6;">
                <h2><i class="fas fa-gavel"></i> Group Conscience Meeting Workflow</h2>
                <p style="background: #8e44ad; padding: 1rem; border-radius: 6px;"><strong><i class="fas fa-info-circle"></i> Group Conscience meetings are the spiritual authority of the group.</strong> This application helps facilitate informed, organized, and spiritually principled decision-making.</p>
                <h3 style="color: #f39c12; margin-top: 1.5rem;"><i class="fas fa-clipboard-list"></i> BEFORE the GC Meeting (1-2 Weeks Prior)</h3>
                <div style="padding: 1.5rem; background: #34495e; border-radius: 6px; margin: 1rem 0; border-left: 4px solid #f39c12;">
                    <h4>Step 1: Collect Agenda Items</h4>
                    <ol style="line-height: 1.8;">
                        <li>Navigate to <strong>Group Conscience → Decision History</strong></li>
                        <li>Scroll to <strong>"Proposed Agenda Items"</strong> section</li>
                        <li>Members submit items they want to discuss</li>
                        <li>Include: Title, Description, Category, Financial Impact</li>
                        <li>Mark items for consent agenda if they're routine</li>
                    </ol>
                    <h4 style="margin-top: 1rem;">Step 2: Review Standing/Recurring Items</h4>
                    <ol style="line-height: 1.8;">
                        <li>Scroll to <strong>"Standing/Recurring Agenda Items"</strong></li>
                        <li>Review items that appear regularly (monthly, quarterly, etc.)</li>
                        <li>These automatically populate based on their frequency</li>
                    </ol>
                    <h4 style="margin-top: 1rem;">Step 3: Generate & Send Agenda</h4>
                    <ol style="line-height: 1.8;">
                        <li>Scroll to <strong>"Email Integration"</strong> section</li>
                        <li>Set meeting date and recipient list</li>
                        <li>Click <strong>"Generate & Email Agenda"</strong></li>
                        <li>Review items via your email client</li>
                    </ol>
                    <h4 style="margin-top: 1rem;">Step 4: Research Period (Optional but Recommended)</h4>
                    <ol style="line-height: 1.8;">
                        <li>For major decisions, set a research period</li>
                        <li>Members can ask questions and gather information</li>
                        <li>Use the Discussion Thread feature for each item</li>
                    </ol>
                </div>
                <h3 style="color: #3498db; margin-top: 1.5rem;"><i class="fas fa-play-circle"></i> DURING the GC Meeting</h3>
                <div style="padding: 1.5rem; background: #34495e; border-radius: 6px; margin: 1rem 0; border-left: 4px solid #3498db;">
                    <h4>Step 1: Start Live GC Session</h4>
                    <ol style="line-height: 1.8;">
                        <li>Navigate to <strong>Group Conscience → Live GC Session</strong></li>
                        <li>Click <strong>"Start Group Conscience Meeting"</strong></li>
                        <li>This activates the live session interface</li>
                    </ol>
                    <h4 style="margin-top: 1rem;">Step 2: Handle Consent Agenda (Optional)</h4>
                    <ol style="line-height: 1.8;">
                        <li>Scroll to <strong>"Consent Agenda"</strong></li>
                        <li>Items marked for consent are listed here</li>
                        <li>These can be approved in bulk without discussion</li>
                        <li>Any member can "pull" an item for full discussion</li>
                        <li>Click <strong>"Approve Consent Agenda"</strong> for remaining items</li>
                    </ol>
                    <h4 style="margin-top: 1rem;">Step 3: Process Regular Agenda Items</h4>
                    <ol style="line-height: 1.8;">
                        <li>Add each item to the live GC queue</li>
                        <li>For each motion:
                            <ul style="margin-top: 0.5rem;">
                                <li><strong>Motion made:</strong> Record who made it</li>
                                <li><strong>Second required:</strong> Click "Call for Second"</li>
                                <li><strong>Discussion:</strong> Add discussion comments</li>
                                <li><strong>Amendments:</strong> Use amendment feature if motion is modified</li>
                                <li><strong>Vote:</strong> Record votes (For/Against/Abstain)</li>
                            </ul>
                        </li>
                    </ol>
                    <h4 style="margin-top: 1rem;">Step 4: Parliamentary Procedures</h4>
                    <p style="margin-top: 0.5rem;">Use <strong>Group Conscience → Parliamentary Procedure</strong> for:</p>
                    <ul style="line-height: 1.8;">
                        <li><strong>Point of Order:</strong> Challenge procedural violations</li>
                        <li><strong>Point of Information:</strong> Ask clarifying questions</li>
                        <li><strong>Point of Privilege:</strong> Address immediate needs</li>
                        <li><strong>Table Motion:</strong> Postpone discussion (requires date)</li>
                        <li><strong>Call the Question:</strong> End discussion and vote</li>
                        <li><strong>Minority Opinion:</strong> Record dissenting views</li>
                    </ul>
                    <h4 style="margin-top: 1rem;">Step 5: Check Traditions & Concepts</h4>
                    <ol style="line-height: 1.8;">
                        <li>Go to <strong>Group Conscience → Tradition & Concept Checker</strong></li>
                        <li>Before voting, verify decision aligns with AA principles</li>
                        <li>System highlights potential conflicts</li>
                    </ol>
                    <h4 style="margin-top: 1rem;">Step 6: Record Final Decision</h4>
                    <ol style="line-height: 1.8;">
                        <li>After voting, decision is saved to Decision History</li>
                        <li>Record any action items created</li>
                        <li>Assign responsible parties and deadlines</li>
                    </ol>
                </div>
                <h3 style="color: #2ecc71; margin-top: 1.5rem;"><i class="fas fa-check-circle"></i> AFTER the GC Meeting</h3>
                <div style="padding: 1.5rem; background: #34495e; border-radius: 6px; margin: 1rem 0; border-left: 4px solid #2ecc71;">
                    <h4>Step 1: Generate Minutes</h4>
                    <ol style="line-height: 1.8;">
                        <li>Go to <strong>"Email Integration"</strong> section</li>
                        <li>Click <strong>"Generate & Email Minutes"</strong></li>
                        <li>Minutes include all decisions, votes, and action items</li>
                    </ol>
                    <h4 style="margin-top: 1rem;">Step 2: Track Implementation</h4>
                    <ol style="line-height: 1.8;">
                        <li>Scroll to <strong>"Decision Implementation Tracking"</strong></li>
                        <li>Select the decision to track</li>
                        <li>Update progress regularly (0-100%)</li>
                        <li>Mark milestones achieved</li>
                        <li>Change status as needed (Planned/In Progress/Completed/Blocked)</li>
                    </ol>
                    <h4 style="margin-top: 1rem;">Step 3: Monitor Action Items</h4>
                    <ol style="line-height: 1.8;">
                        <li>Check <strong>Home</strong> dashboard for pending action items</li>
                        <li>System sends reminders as deadlines approach</li>
                        <li>Update progress and mark complete when done</li>
                    </ol>
                    <h4 style="margin-top: 1rem;">Step 4: Member Voting History</h4>
                    <ol style="line-height: 1.8;">
                        <li>Go to <strong>"Member Voting History"</strong></li>
                        <li>Track participation rates</li>
                        <li>Identify patterns in voting</li>
                        <li>Useful for understanding group consciousness</li>
                    </ol>
                </div>
            </div>
            <div class="box mb-4" style="border-left: 4px solid #e74c3c;">
                <h2><i class="fas fa-exclamation-triangle"></i> Special GC Features</h2>
                <h3>Motion Reconsideration</h3>
                <p>To reconsider a past decision:</p>
                <ol style="line-height: 1.8;">
                    <li>Select the original decision from dropdown</li>
                    <li>Provide detailed justification with new information</li>
                    <li>Set research period if needed</li>
                    <li>Submit for group review</li>
                    <li><strong>Note:</strong> Reconsideration should be rare and only with substantial new information</li>
                </ol>
                <h3 style="margin-top: 1.5rem;">Proxy Voting</h3>
                <p><strong style="color: #f39c12;"><i class="fas fa-info-circle"></i> Check your group guidelines first!</strong> Not all groups allow proxy voting.</p>
                <ol style="line-height: 1.8;">
                    <li>Designate someone to vote on your behalf</li>
                    <li>Choose General (vote as they see fit) or Directed (specific instructions)</li>
                    <li>Valid only for the specified meeting date</li>
                    <li>Can be revoked anytime before the meeting</li>
                </ol>
                <h3 style="margin-top: 1.5rem;">Emergency Group Conscience</h3>
                <p>For urgent matters requiring immediate attention:</p>
                <ol style="line-height: 1.8;">
                    <li>Go to <strong>Group Conscience → Live GC Session</strong></li>
                    <li>Click <strong>"Initiate Emergency GC"</strong></li>
                    <li>Document the emergency situation</li>
                    <li>Notify members immediately</li>
                    <li>Follow expedited decision process</li>
                </ol>
                <h3 style="margin-top: 1.5rem;">Decision ROI Calculator</h3>
                <p>For financial decisions, calculate impact before voting:</p>
                <ol style="line-height: 1.8;">
                    <li>Enter initial cost and ongoing costs</li>
                    <li>Input expected revenue impact or expense savings</li>
                    <li>Set timeframe (months)</li>
                    <li>Review net impact and payback period</li>
                    <li>System provides recommendation (positive/neutral/negative)</li>
                </ol>
                <h3 style="margin-top: 1.5rem;">Decision Reversal Tracking</h3>
                <p>Learn from past changes to avoid future issues:</p>
                <ol style="line-height: 1.8;">
                    <li>Record when a decision is reversed</li>
                    <li>Document why it was reversed</li>
                    <li>Note lessons learned</li>
                    <li>Track patterns in reversal reasons</li>
                    <li>Use insights to improve future decisions</li>
                </ol>
            </div>
            <div class="box mb-4" style="border-left: 4px solid #1abc9c;">
                <h2><i class="fas fa-keyboard"></i> Keyboard Shortcuts</h2>
                <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                    <div style="padding: 0.75rem; background: #34495e; border-radius: 4px;">
                        <strong style="color: #3498db;">Alt + H</strong><br>
                        <span style="font-size: 0.9rem;">Go to Home</span>
                    </div>
                    <div style="padding: 0.75rem; background: #34495e; border-radius: 4px;">
                        <strong style="color: #3498db;">Alt + G</strong><br>
                        <span style="font-size: 0.9rem;">Go to Live GC</span>
                    </div>
                    <div style="padding: 0.75rem; background: #34495e; border-radius: 4px;">
                        <strong style="color: #3498db;">Alt + S</strong><br>
                        <span style="font-size: 0.9rem;">Go to Settings</span>
                    </div>
                    <div style="padding: 0.75rem; background: #34495e; border-radius: 4px;">
                        <strong style="color: #3498db;">Alt + B</strong><br>
                        <span style="font-size: 0.9rem;">Create Backup</span>
                    </div>
                </div>
            </div>
            <div class="box mb-4" style="border-left: 4px solid #f1c40f;">
                <h2><i class="fas fa-wrench"></i> Troubleshooting & Tips</h2>
                <h3>Data Backup (CRITICAL)</h3>
                <div style="padding: 1rem; background: #e74c3c; border-radius: 6px; margin: 1rem 0;">
                    <strong><i class="fas fa-exclamation-triangle"></i> IMPORTANT:</strong> Your data is stored locally in your browser. If you clear browser data or switch devices, you'll lose everything unless you have a backup!
                </div>
                <ul style="line-height: 1.8;">
                    <li>Go to <strong>Settings (gear icon) → Backup & Restore</strong></li>
                    <li>Click <strong>"Export Full Backup"</strong> weekly</li>
                    <li>Save the JSON file to a safe location</li>
                    <li>Test your backup by importing it on another device</li>
                </ul>
                <h3 style="margin-top: 1.5rem;">Browser Compatibility</h3>
                <ul style="line-height: 1.8;">
                    <li>Works best in Chrome, Edge, Firefox, Safari</li>
                    <li>Requires JavaScript enabled</li>
                    <li>Works offline after initial load</li>
                    <li>Mobile-friendly responsive design</li>
                </ul>
                <h3 style="margin-top: 1.5rem;">Common Issues</h3>
                <div style="padding: 1rem; background: #34495e; border-radius: 6px; margin: 1rem 0;">
                    <h4>Dropdowns are empty</h4>
                    <ul>
                        <li>Add members first in Fellowship → Birthdays & Anniversaries</li>
                        <li>Dropdowns auto-populate from member list</li>
                    </ul>
                    <h4 style="margin-top: 1rem;">Charts not displaying</h4>
                    <ul>
                        <li>Ensure you have data entered for that feature</li>
                        <li>Charts require Chart.js library (loaded automatically online)</li>
                    </ul>
                    <h4 style="margin-top: 1rem;">Lost data after clearing browser</h4>
                    <ul>
                        <li>Restore from your backup JSON file</li>
                        <li>Go to Settings → Backup & Restore → Import</li>
                    </ul>
                    <h4 style="margin-top: 1rem;">Slow performance</h4>
                    <ul>
                        <li>Check storage usage in Settings</li>
                        <li>Consider archiving old data</li>
                        <li>Export and clean up old photos</li>
                    </ul>
                </div>
            </div>
            <div class="box" style="border-left: 4px solid #2ecc71; background: #2c3e50;">
                <h2><i class="fas fa-book-open"></i> AA Principles Integration</h2>
                <p>This application is designed to support the 12 Traditions and 12 Concepts for World Service:</p>
                <h3>How This App Supports the Traditions</h3>
                <ul style="line-height: 1.8;">
                    <li><strong>Tradition 1 (Unity):</strong> Unity Checker helps identify divisive issues</li>
                    <li><strong>Tradition 2 (Group Conscience):</strong> Comprehensive GC tools ensure informed decisions</li>
                    <li><strong>Tradition 4 (Autonomy):</strong> Fully customizable to your group's needs</li>
                    <li><strong>Tradition 5 (Primary Purpose):</strong> Keeps focus on recovery through organized service</li>
                    <li><strong>Tradition 7 (Self-Supporting):</strong> 7th Tradition tracking and analysis</li>
                    <li><strong>Tradition 8 (Non-Professional):</strong> Tracks volunteer service, not employment</li>
                    <li><strong>Tradition 9 (Minimal Organization):</strong> Streamlined, non-bureaucratic structure</li>
                    <li><strong>Tradition 12 (Anonymity):</strong> All data stays on your device, no servers</li>
                </ul>
                <h3 style="margin-top: 1.5rem;">12 Concepts Integration</h3>
                <ul style="line-height: 1.8;">
                    <li><strong>Concept I (Final Responsibility):</strong> Group Conscience is the ultimate authority</li>
                    <li><strong>Concept II (Delegated Authority):</strong> Service position tracking with clear roles</li>
                    <li><strong>Concept III (Right of Decision):</strong> Trusted servants make decisions within scope</li>
                    <li><strong>Concept IV (Participation):</strong> Member voting history promotes engagement</li>
                    <li><strong>Concept V (Right of Appeal/Petition):</strong> Reconsideration workflow built-in</li>
                    <li><strong>Concept XII (Warranty of Conference):</strong> Tradition checker ensures adherence</li>
                </ul>
            </div>

            <div class="box mb-4" style="border-left: 4px solid #16a085;">
                <h2><i class="fas fa-book-open"></i> Complete Feature Guide</h2>
                <p style="background: #16a085; padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem;"><strong><i class="fas fa-compass"></i> Navigate to any feature easily!</strong> Use the navigation menu at the top to access these features.</p>

                <h3 style="color: #3498db; margin-top: 1.5rem;"><i class="fas fa-calendar-alt"></i> Meeting Management Features</h3>
                <div style="padding: 1rem; background: #34495e; border-radius: 6px; margin: 1rem 0;">
                    <ul style="line-height: 1.8;">
                        <li><strong>Meetings → Schedule & Calendar:</strong> Add recurring meetings, view calendar, manage meeting times and locations</li>
                        <li><strong>Meetings → Format Rotation:</strong> Automate meeting format rotation (Big Book, speaker, discussion, step study)</li>
                        <li><strong>Meetings → Commitment Board:</strong> Track meeting commitments (greeter, coffee, chair, speaker)</li>
                        <li><strong>Meetings → Secretary Functions:</strong> Take meeting minutes, track attendance, record 7th tradition</li>
                        <li><strong>Meetings → Meeting Companion:</strong> Quick access to prayers, formats, and readings during meetings</li>
                        <li><strong>Meetings → Attendance Analytics:</strong> View which meetings are most popular and identify trends</li>
                        <li><strong>Meetings → Role Rotation:</strong> Automatically rotate meeting roles to distribute responsibilities</li>
                        <li><strong>Meetings → Virtual Meeting Integration:</strong> Manage Zoom/hybrid meeting links and settings</li>
                        <li><strong>Meetings → QR Code Check-in:</strong> Generate QR codes for easy meeting check-in</li>
                        <li><strong>Meetings → Meeting Format Feedback:</strong> Collect feedback on different meeting formats</li>
                        <li><strong>Meetings → Speaker Meeting Booking:</strong> Schedule and coordinate speaker meetings</li>
                        <li><strong>Meetings → Chip Ceremony Scheduler:</strong> Plan and track sobriety milestone celebrations</li>
                    </ul>
                </div>

                <h3 style="color: #e67e22; margin-top: 1.5rem;"><i class="fas fa-users"></i> Fellowship & Communication Features</h3>
                <div style="padding: 1rem; background: #34495e; border-radius: 6px; margin: 1rem 0;">
                    <ul style="line-height: 1.8;">
                        <li><strong>Fellowship → Birthdays & Anniversaries:</strong> Add members, track clean dates and birthdays, view upcoming celebrations</li>
                        <li><strong>Fellowship → Attendance Streaks:</strong> Gamify meeting attendance with leaderboards and achievements</li>
                        <li><strong>Fellowship → Member Wellness Check:</strong> Track absent members and perform wellness outreach</li>
                        <li><strong>Fellowship → Newcomer Tracking:</strong> Welcome and monitor newcomer progress and attendance</li>
                        <li><strong>Fellowship → Available Sponsors:</strong> List members available to sponsor with gender and contact info</li>
                        <li><strong>Fellowship → Temporary Sponsor Matching:</strong> Match newcomers with temporary sponsors until permanent match</li>
                        <li><strong>Fellowship → Emergency Contacts:</strong> Store designated emergency contacts for members</li>
                        <li><strong>Fellowship → Topic Suggestions:</strong> Collect and vote on meeting discussion topics</li>
                        <li><strong>Fellowship → 12-Step Call Roster:</strong> Maintain list of members available for 12-step calls</li>
                        <li><strong>Fellowship → Problem Box:</strong> Anonymous suggestion box for group issues</li>
                        <li><strong>Fellowship → Announcements:</strong> Post group-wide announcements with categories and expiration</li>
                        <li><strong>Fellowship → Messages:</strong> Internal messaging system for group communication</li>
                        <li><strong>Fellowship → Text/Email Lists:</strong> Create and manage communication lists for targeted messaging</li>
                        <li><strong>Fellowship → Meeting Reminders:</strong> Automated reminders for upcoming meetings</li>
                        <li><strong>Fellowship → Birthday/Anniversary Notifications:</strong> Alert group about upcoming celebrations</li>
                        <li><strong>Fellowship → Action Item Assignments:</strong> Create and track action items with deadlines</li>
                        <li><strong>Fellowship → Meeting Cancellation Alerts:</strong> Quickly notify members of meeting cancellations</li>
                        <li><strong>Fellowship → Welcome Packet Generator:</strong> Automate newcomer welcome packet distribution</li>
                        <li><strong>Fellowship → Photo Gallery:</strong> Share and preserve group memories with photo uploads</li>
                        <li><strong>Fellowship → Group Temperature Check:</strong> Gauge overall group satisfaction anonymously</li>
                        <li><strong>Fellowship → Satisfaction Survey:</strong> Detailed feedback collection on group operations</li>
                    </ul>
                </div>

                <h3 style="color: #9b59b6; margin-top: 1.5rem;"><i class="fas fa-gavel"></i> Group Conscience Features</h3>
                <div style="padding: 1rem; background: #34495e; border-radius: 6px; margin: 1rem 0;">
                    <ul style="line-height: 1.8;">
                        <li><strong>Group Conscience → Live GC Session:</strong> Conduct real-time Group Conscience meetings with voting</li>
                        <li><strong>Group Conscience → Decision History:</strong> View all past decisions, track implementation, add agenda items</li>
                        <li><strong>Group Conscience → Motion Templates:</strong> Pre-written motion templates for common decisions</li>
                        <li><strong>Group Conscience → Parliamentary Procedure:</strong> Tools for points of order, tabling motions, minority opinion</li>
                        <li><strong>Group Conscience → Tradition & Concept Checker:</strong> Verify decisions align with AA principles</li>
                        <li><strong>Group Conscience → Tradition Moments:</strong> Share brief tradition reflections during meetings</li>
                        <li><strong>Group Conscience → Spiritual Principles:</strong> Reference guide for all 36 principles in AA</li>
                        <li><strong>Group Conscience → Unity Checker:</strong> Identify potentially divisive issues before voting</li>
                        <li><strong>Group Conscience → GC Inventory:</strong> Conduct group inventories with structured questions</li>
                        <li><strong>Group Conscience → Group Inventory Question Bank:</strong> Library of inventory questions organized by topic</li>
                        <li><strong>Group Conscience → Tradition Study Curriculum:</strong> 12-month tradition study plan</li>
                        <li><strong>Group Conscience → Concept Study Curriculum:</strong> 12-month concept study plan</li>
                        <li><strong>Group Conscience → Conflict Resolution Tracker:</strong> Document and track group conflicts to resolution</li>
                        <li><strong>Group Conscience → Guidelines & By-Laws:</strong> Store and version-control group guidelines</li>
                        <li><strong>Group Conscience → Group Vision Statement:</strong> Create and maintain group vision/mission</li>
                        <li><strong>Group Conscience → Voting Settings:</strong> Configure voting thresholds (substantial unanimity, majority, consensus)</li>
                    </ul>
                </div>

                <h3 style="color: #f1c40f; margin-top: 1.5rem;"><i class="fas fa-money-bill-wave"></i> Financial Management Features</h3>
                <div style="padding: 1rem; background: #34495e; border-radius: 6px; margin: 1rem 0;">
                    <ul style="line-height: 1.8;">
                        <li><strong>Treasury → Financial Reports:</strong> Track income, expenses, generate monthly reports</li>
                        <li><strong>Treasury → Budget Approval:</strong> Create and monitor budget categories</li>
                        <li><strong>Treasury → Contribution Comparison:</strong> Year-over-year contribution analysis with charts</li>
                        <li><strong>Treasury → Expense Approval Workflow:</strong> Multi-step approval process for major expenses</li>
                        <li><strong>Treasury → Bill Payment Reminders:</strong> Automated reminders for recurring bills (rent, utilities)</li>
                        <li><strong>Treasury → Group Contribution Calculator:</strong> Calculate suggested per-person contributions</li>
                        <li><strong>Treasury → Financial Goals Tracker:</strong> Set and track financial goals with progress monitoring</li>
                        <li><strong>Treasury → Expense Receipt Upload:</strong> Digital receipt management system</li>
                        <li><strong>Treasury → Quarterly Financial Reports:</strong> Generate comprehensive quarterly summaries</li>
                        <li><strong>Treasury → 7th Tradition Analysis:</strong> Analyze contribution trends over time</li>
                        <li><strong>Treasury → Prudent Reserve:</strong> Calculate and track recommended reserve amount</li>
                        <li><strong>Treasury → Chip Inventory:</strong> Manage sobriety chip stock levels and reordering</li>
                    </ul>
                </div>

                <h3 style="color: #2ecc71; margin-top: 1.5rem;"><i class="fas fa-hands-helping"></i> Group Service Features</h3>
                <div style="padding: 1rem; background: #34495e; border-radius: 6px; margin: 1rem 0;">
                    <ul style="line-height: 1.8;">
                        <li><strong>Service → Service Positions:</strong> Track all service positions with terms and rotation alerts</li>
                        <li><strong>Service → Service Elections:</strong> Conduct elections with multiple rounds if needed</li>
                        <li><strong>Service → Service Opportunities:</strong> Post and track service opportunities within the group</li>
                        <li><strong>Service → Sponsorship Tracking:</strong> Record sponsor relationships and track progress</li>
                        <li><strong>Service → Sponsorship Tree Visualization:</strong> Visual map of sponsorship chains in your group</li>
                        <li><strong>Service → H&I Meeting Commitments:</strong> Track basic Hospitals & Institutions meeting commitments (for full panel management, see District & Area menu)</li>
                        <li><strong>Service → Service Hours Tracking:</strong> Log service hours with leaderboard for recognition</li>
                        <li><strong>Service → Group Special Events:</strong> Plan and coordinate group-level events - manage event details, book speakers, coordinate volunteers, track budgets and ticket sales</li>
                    </ul>
                </div>

                <h3 style="color: #8e44ad; margin-top: 1.5rem;"><i class="fas fa-sitemap"></i> District & Area Service Features</h3>
                <div style="padding: 1rem; background: #34495e; border-radius: 6px; margin: 1rem 0;">
                    <ul style="line-height: 1.8;">
                        <li><strong>District & Area → District/Area Committee:</strong> Track district and area service involvement</li>
                        <li><strong>District & Area → District Motions:</strong> Monitor and vote on district/area motions</li>
                        <li><strong>District & Area → Service Structure:</strong> Visualize AA service structure from group to GSO</li>
                        <li><strong>District & Area → Area Assembly Integration:</strong> Track Area Assembly motions, record GSR voting instructions, log assembly reports, and monitor standing committee work</li>
                        <li><strong>District & Area → Intergroup Representative:</strong> Manage IR responsibilities including meeting notes, hotline scheduling, special event coordination, and group liaison activities</li>
                        <li><strong>District & Area → H&I Panel Management:</strong> Comprehensive Hospitals & Institutions panel coordination - track facilities, manage panel schedules, monitor orientations and certifications</li>
                        <li><strong>District & Area → CPC (Professional Community):</strong> Cooperation with Professional Community - maintain professional contacts, coordinate presentations, manage Bridge-the-Gap referrals</li>
                        <li><strong>District & Area → PI (Public Information):</strong> Public Information tools - manage media contacts, draft press releases, track outreach events, coordinate with local media</li>
                        <li><strong>District & Area → Treatment Facilities Liaison:</strong> Coordinate with treatment centers - schedule commitments, manage bridging program, track follow-up contacts with facility residents</li>
                        <li><strong>District & Area → Corrections Committee:</strong> Correctional facilities service - track facility clearances, manage pre-release contact program, maintain correspondence logs, coordinate reentry support</li>
                        <li><strong>District & Area → Language Accessibility:</strong> Multilingual support for area/district - manage translator registry, track translated materials, schedule interpreters, coordinate closed captioning services</li>
                    </ul>
                </div>

                <h3 style="color: #16a085; margin-top: 1.5rem;"><i class="fas fa-home"></i> Home Group Features</h3>
                <div style="padding: 1rem; background: #34495e; border-radius: 6px; margin: 1rem 0;">
                    <ul style="line-height: 1.8;">
                        <li><strong>Home Group → Inter-Group Connections:</strong> Track members' attendance at other groups</li>
                        <li><strong>Home Group → Home Group Transfer:</strong> Process incoming/outgoing home group transfers</li>
                        <li><strong>Home Group → Benefits Tracking:</strong> Track voting eligibility and home group benefits</li>
                        <li><strong>Home Group → Commitment Level:</strong> View statistics on home group commitment levels</li>
                        <li><strong>Home Group → Census:</strong> Detailed census by membership status (home group, regular, newcomer, visitor)</li>
                        <li><strong>Home Group → Growth Metrics:</strong> Chart membership growth trends over time</li>
                    </ul>
                </div>

                <h3 style="color: #95a5a6; margin-top: 1.5rem;"><i class="fas fa-book"></i> Literature & Resources Features</h3>
                <div style="padding: 1rem; background: #34495e; border-radius: 6px; margin: 1rem 0;">
                    <ul style="line-height: 1.8;">
                        <li><strong>Resources → Daily Reflections:</strong> View daily meditation for today's date</li>
                        <li><strong>Resources → Step Work Tracker:</strong> Track member progress through the 12 steps</li>
                        <li><strong>Resources → Big Book Study Tracker:</strong> Log Big Book study progress by chapter</li>
                        <li><strong>Resources → Literature Inventory:</strong> Manage literature stock levels and reorder alerts</li>
                        <li><strong>Resources → Literature Loan Library:</strong> Check out literature to members with due dates</li>
                        <li><strong>Resources → Newcomer Starter Packs:</strong> Distribute and track newcomer literature packages</li>
                        <li><strong>Resources → Literature Sales Tracking:</strong> Record literature sales and calculate totals</li>
                        <li><strong>Resources → Digital Literature Library:</strong> Links to approved online AA literature</li>
                        <li><strong>Resources → Study Guide Generator:</strong> Auto-generate study guides for steps and traditions</li>
                        <li><strong>Resources → Group History:</strong> Maintain group history with founding date and milestones</li>
                        <li><strong>Resources → Document Templates:</strong> Pre-formatted templates for agendas, minutes, etc.</li>
                        <li><strong>Resources → Group Archives:</strong> Upload and store important historical documents - main hub for group history preservation</li>
                        <li><strong>Resources → Oral History Collection:</strong> Record interviews with long-time members</li>
                        <li><strong>Resources → Group Milestones:</strong> Document significant group achievements and dates</li>
                        <li><strong>Resources → Member Legacy:</strong> Honor deceased members with tribute pages</li>
                        <li><strong>Resources → Historical Minutes Search:</strong> Search through archived meeting minutes</li>
                    </ul>
                </div>

                <h3 style="color: #1abc9c; margin-top: 1.5rem;"><i class="fas fa-chart-line"></i> Reports & Analytics Features</h3>
                <div style="padding: 1rem; background: #34495e; border-radius: 6px; margin: 1rem 0;">
                    <ul style="line-height: 1.8;">
                        <li><strong>Reports → Chairperson Reports:</strong> Generate comprehensive chairperson reports</li>
                        <li><strong>Reports → Meeting Minutes:</strong> View all meeting minutes with search functionality</li>
                        <li><strong>Reports → Group Analytics:</strong> Charts showing attendance, participation, and growth trends</li>
                        <li><strong>Reports → Participation Analytics:</strong> Member engagement metrics and insights</li>
                        <li><strong>Reports → Financial Health:</strong> Financial dashboard with health indicators</li>
                        <li><strong>Reports → Decision Impact:</strong> Track how GC decisions affected the group</li>
                        <li><strong>Reports → Executive Dashboard:</strong> High-level overview for GSR and trusted servants</li>
                        <li><strong>Reports → GSR Dashboard:</strong> Special dashboard for GSR reporting needs</li>
                    </ul>
                </div>

                <h3 style="color: #3498db; margin-top: 1.5rem;"><i class="fas fa-plug"></i> Integration & Mobile Features</h3>
                <div style="padding: 1rem; background: #34495e; border-radius: 6px; margin: 1rem 0;">
                    <ul style="line-height: 1.8;">
                        <li><strong>Settings → Google Calendar Integration:</strong> Export meetings to Google Calendar</li>
                        <li><strong>Settings → SMS Integration:</strong> Connect Twilio for SMS notifications (requires API setup)</li>
                        <li><strong>Settings → Email Automation:</strong> Configure automated email notifications</li>
                        <li><strong>Settings → Cloud Backup:</strong> Automated backups to Google Drive or Dropbox</li>
                        <li><strong>Settings → Multi-Group Support:</strong> Manage multiple groups in one interface</li>
                        <li><strong>Settings → AA Meeting Finder:</strong> Link to AA.org meeting finder for visitors</li>
                        <li><strong>Settings → Offline Mode:</strong> Indicator showing online/offline status</li>
                        <li><strong>Settings → Mobile Features:</strong> Quick access shortcuts optimized for mobile</li>
                        <li><strong>Settings → Touch Gestures:</strong> Swipe navigation on touch devices</li>
                        <li><strong>Settings → Install as App:</strong> Progressive Web App installation for mobile/desktop</li>
                    </ul>
                </div>

                <h3 style="color: #f39c12; margin-top: 1.5rem;"><i class="fas fa-universal-access"></i> Accessibility Features</h3>
                <div style="padding: 1rem; background: #34495e; border-radius: 6px; margin: 1rem 0;">
                    <ul style="line-height: 1.8;">
                        <li><strong>Settings → Accessibility Settings:</strong> Theme settings, dark/light mode, high contrast</li>
                        <li><strong>Settings → Multi-Language Support:</strong> Select from multiple languages (requires translation files)</li>
                        <li><strong>Settings → Large Print Mode:</strong> Increase font size for better readability</li>
                        <li><strong>Settings → Screen Reader Optimization:</strong> Enhanced ARIA labels for screen readers</li>
                        <li><strong>Settings → Closed Captioning:</strong> Virtual meeting captions (requires third-party service)</li>
                        <li><strong>Settings → Accessibility Committee:</strong> Submit and track accessibility concerns</li>
                    </ul>
                </div>

                <h3 style="color: #34495e; margin-top: 1.5rem;"><i class="fas fa-tools"></i> Settings & Management</h3>
                <div style="padding: 1rem; background: #34495e; border-radius: 6px; margin: 1rem 0;">
                    <ul style="line-height: 1.8;">
                        <li><strong>Settings → General Settings:</strong> Group name, meeting address, default settings</li>
                        <li><strong>Settings → Privacy & Anonymity:</strong> Configure data retention and privacy settings</li>
                        <li><strong>Settings → Quorum Management:</strong> Set quorum rules for voting (percentage, absolute minimum)</li>
                        <li><strong>Settings → Group Inventory Scheduler:</strong> Schedule recurring group inventories</li>
                        <li><strong>Settings → Role & View Settings:</strong> Customize visibility based on service positions</li>
                        <li><strong>Settings → Backup & Restore:</strong> Export/import all data, view backup history</li>
                        <li><strong>Settings → Audit Log:</strong> View all changes made in the system with timestamps</li>
                        <li><strong>Settings → Engagement Metrics:</strong> Track feature usage and member engagement</li>
                    </ul>
                </div>
            </div>

            <div class="box mb-4" style="border-left: 4px solid #e67e22;">
                <h2><i class="fas fa-sitemap"></i> Area & District Service Features - Detailed Usage Guide</h2>
                <p style="background: #e67e22; padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem;"><strong><i class="fas fa-lightbulb"></i> Comprehensive Service Work Tools</strong> These 10 features support your group's service structure work at the district, area, and local level.</p>

                <h3 style="color: #9b59b6; margin-top: 1.5rem;"><i class="fas fa-university"></i> Area Assembly Integration</h3>
                <div style="padding: 1rem; background: #34495e; border-radius: 6px; margin: 1rem 0;">
                    <p><strong>Purpose:</strong> Track Area Assembly activities, motions, and your GSR's voting instructions from the group.</p>
                    <h4 style="margin-top: 1rem;">How to Use:</h4>
                    <ul style="line-height: 1.8;">
                        <li><strong>Assembly Motions:</strong> Add motions that will be discussed at Area Assembly. Record title, description, financial impact, and your group's position.</li>
                        <li><strong>GSR Voting Instructions:</strong> Before each assembly, your group can provide specific voting instructions to the GSR on important motions.</li>
                        <li><strong>Assembly Reports:</strong> After each assembly, your GSR can log a detailed report including attendance, key decisions, and committee updates.</li>
                        <li><strong>Standing Committees:</strong> Track which standing committees (PI, CPC, Treatment, etc.) your members serve on and their contact information.</li>
                    </ul>
                    <p style="margin-top: 0.5rem;"><strong>Typical Workflow:</strong> Before assembly → Group discusses upcoming motions → Record group conscience position → GSR attends assembly → GSR logs report after assembly</p>
                </div>

                <h3 style="color: #16a085; margin-top: 1.5rem;"><i class="fas fa-handshake"></i> Intergroup Representative Functions</h3>
                <div style="padding: 1rem; background: #34495e; border-radius: 6px; margin: 1rem 0;">
                    <p><strong>Purpose:</strong> Manage Intergroup Representative (IR) duties including meetings, hotline, and special events.</p>
                    <h4 style="margin-top: 1rem;">How to Use:</h4>
                    <ul style="line-height: 1.8;">
                        <li><strong>Intergroup Notes:</strong> Log notes from monthly Intergroup meetings including date, key topics, decisions, and action items for your group.</li>
                        <li><strong>Hotline Scheduling:</strong> Coordinate AA hotline coverage by assigning volunteers to specific days/time slots. Track contact info and shift preferences.</li>
                        <li><strong>Special Events:</strong> Document Intergroup special events (conferences, workshops, speaker meetings) with dates, locations, and your group's participation.</li>
                        <li><strong>Group Liaison Activities:</strong> Track your group's relationship with Intergroup, financial contributions, and any group concerns to bring to Intergroup.</li>
                    </ul>
                    <p style="margin-top: 0.5rem;"><strong>Typical Workflow:</strong> IR attends monthly Intergroup → Logs meeting notes → Coordinates hotline volunteers → Reports back to home group → Tracks special events</p>
                </div>

                <h3 style="color: #e67e22; margin-top: 1.5rem;"><i class="fas fa-hospital"></i> H&I Panel Management</h3>
                <div style="padding: 1rem; background: #34495e; border-radius: 6px; margin: 1rem 0;">
                    <p><strong>Purpose:</strong> Comprehensive management of Hospitals & Institutions panel commitments and volunteers.</p>
                    <h4 style="margin-top: 1rem;">How to Use:</h4>
                    <ul style="line-height: 1.8;">
                        <li><strong>H&I Facilities:</strong> Add facilities your panel serves (hospitals, detox centers, rehabs). Include facility name, type, contact person, address, and meeting schedule.</li>
                        <li><strong>Panel Schedules:</strong> Create recurring panel commitments by selecting facility, lead member, backup, and meeting time. Track how many times each panel has met.</li>
                        <li><strong>Orientations:</strong> Log when members complete H&I orientation training. Required before members can participate in panels.</li>
                        <li><strong>Certifications:</strong> Track special certifications needed for certain facilities (background checks, facility-specific training, COVID vaccinations, etc.).</li>
                    </ul>
                    <p style="margin-top: 0.5rem;"><strong>Typical Workflow:</strong> New facility added → Schedule recurring panels → Members complete orientation → Assign to panels → Track certifications → Monitor panel attendance</p>
                </div>

                <h3 style="color: #3498db; margin-top: 1.5rem;"><i class="fas fa-user-md"></i> CPC (Cooperation with Professional Community)</h3>
                <div style="padding: 1rem; background: #34495e; border-radius: 6px; margin: 1rem 0;">
                    <p><strong>Purpose:</strong> Build relationships with professionals who encounter alcoholics (doctors, counselors, clergy, lawyers, employers).</p>
                    <h4 style="margin-top: 1rem;">How to Use:</h4>
                    <ul style="line-height: 1.8;">
                        <li><strong>Professional Contacts:</strong> Maintain database of professional contacts including name, profession, organization, contact info, and last contact date.</li>
                        <li><strong>Presentations:</strong> Schedule and track presentations to professional groups. Log presentation date, audience, location, attendees, and follow-up notes.</li>
                        <li><strong>BTG Referrals:</strong> Bridge-the-Gap program connects newcomers from treatment with AA members. Track referrals, assign volunteers, and monitor follow-up contacts.</li>
                        <li><strong>Literature Distribution:</strong> Track literature distributed to professionals (pamphlets like "AA for the Health Professional", "If You Are A Professional").</li>
                    </ul>
                    <p style="margin-top: 0.5rem;"><strong>Typical Workflow:</strong> Build professional relationships → Schedule presentations → Distribute literature → Manage BTG referrals → Follow up with both professionals and newcomers</p>
                </div>

                <h3 style="color: #1abc9c; margin-top: 1.5rem;"><i class="fas fa-bullhorn"></i> PI (Public Information)</h3>
                <div style="padding: 1rem; background: #34495e; border-radius: 6px; margin: 1rem 0;">
                    <p><strong>Purpose:</strong> Inform the general public about AA through media contacts, press releases, and community outreach.</p>
                    <h4 style="margin-top: 1rem;">How to Use:</h4>
                    <ul style="line-height: 1.8;">
                        <li><strong>Media Contacts:</strong> Maintain list of media contacts (reporters, editors, producers). Include outlet, contact info, beat/specialty, and relationship notes.</li>
                        <li><strong>Press Releases:</strong> Draft and track press releases for AA Awareness Month, National Recovery Month, or correcting misinformation. Save drafts and track which outlets received them.</li>
                        <li><strong>Outreach Events:</strong> Log community outreach activities (health fairs, resource expos, school presentations). Track what materials were distributed and estimated reach.</li>
                        <li><strong>Outreach Log:</strong> Detailed log of all PI activities including date, type, volunteers involved, materials used, and outcomes/follow-up needed.</li>
                    </ul>
                    <p style="margin-top: 0.5rem;"><strong>Typical Workflow:</strong> Build media relationships → Draft press releases when needed → Attend community events → Track all outreach → Report to group and area</p>
                </div>

                <h3 style="color: #e74c3c; margin-top: 1.5rem;"><i class="fas fa-clinic-medical"></i> Treatment Facilities Liaison</h3>
                <div style="padding: 1rem; background: #34495e; border-radius: 6px; margin: 1rem 0;">
                    <p><strong>Purpose:</strong> Coordinate with treatment centers to bring meetings to residents and support them as they transition out.</p>
                    <h4 style="margin-top: 1rem;">How to Use:</h4>
                    <ul style="line-height: 1.8;">
                        <li><strong>Treatment Facilities:</strong> Add treatment centers your group serves. Include facility name, type (inpatient/outpatient), address, contact person, and meeting schedule.</li>
                        <li><strong>Bridging Commitments:</strong> Schedule volunteers to meet with residents before discharge and help them connect with local AA. Track volunteer, facility, date, and how many residents met.</li>
                        <li><strong>Follow-Up Tracking:</strong> After discharge, track follow-up contacts with former residents. Did they attend meetings? Do they need temporary sponsor? Record outcomes.</li>
                        <li><strong>Literature for Facilities:</strong> Track what literature you provide to treatment centers and when it needs replenishing.</li>
                    </ul>
                    <p style="margin-top: 0.5rem;"><strong>Typical Workflow:</strong> Establish facility relationship → Schedule meetings at facility → Coordinate bridging volunteers → Meet residents before discharge → Follow up after discharge → Track outcomes</p>
                </div>

                <h3 style="color: #95a5a6; margin-top: 1.5rem;"><i class="fas fa-balance-scale"></i> Corrections Committee</h3>
                <div style="padding: 1rem; background: #34495e; border-radius: 6px; margin: 1rem 0;">
                    <p><strong>Purpose:</strong> Bring AA message to incarcerated individuals and support their reentry into the community.</p>
                    <h4 style="margin-top: 1rem;">How to Use:</h4>
                    <ul style="line-height: 1.8;">
                        <li><strong>Correctional Facilities:</strong> Add facilities your committee serves (jails, prisons). Include facility name, security level, address, contact, and meeting schedule.</li>
                        <li><strong>Facility Clearances:</strong> Track which members have clearance to enter facilities. Record member, facility, clearance date, expiration, and badge number. Most facilities require background checks.</li>
                        <li><strong>Pre-Release Contact Program:</strong> Connect inmates nearing release with outside AA members. Match inmate with contact person, record anticipated release date, and track actual release and follow-up.</li>
                        <li><strong>Correspondence Log:</strong> Some inmates can't attend meetings but want correspondence. Track pen-pal matches between inmates and outside members, ensuring anonymity is maintained.</li>
                    </ul>
                    <p style="margin-top: 0.5rem;"><strong>Typical Workflow:</strong> Members obtain clearances → Schedule facility meetings → Connect pre-release inmates with outside contacts → Maintain correspondence program → Support reentry</p>
                </div>

                <h3 style="color: #9b59b6; margin-top: 1.5rem;"><i class="fas fa-calendar-check"></i> Special Events Management</h3>
                <div style="padding: 1rem; background: #34495e; border-radius: 6px; margin: 1rem 0;">
                    <p><strong>Purpose:</strong> Plan and execute group special events like speaker meetings, anniversary celebrations, workshops, and conferences.</p>
                    <h4 style="margin-top: 1rem;">How to Use:</h4>
                    <ul style="line-height: 1.8;">
                        <li><strong>Event Management:</strong> Create events with title, type, date, location, expected attendance, and coordinator. Track event status (Planning/Confirmed/Completed/Cancelled).</li>
                        <li><strong>Speaker Booking:</strong> Track speakers for the event including name, topic, contact info, speaking fee (if any), and confirmation status. Schedule multiple speakers for larger events.</li>
                        <li><strong>Volunteer Coordination:</strong> Sign up volunteers for different roles (setup, registration, refreshments, cleanup, greeter, etc.). Assign each volunteer to specific tasks.</li>
                        <li><strong>Budget Tracking:</strong> Enter expected costs (venue, food, literature, speaker travel) and actual expenses. Track budget vs actual spending with variance reporting.</li>
                        <li><strong>Ticket Sales:</strong> If charging admission, track ticket price, quantity sold, and revenue. Monitor ticket sales progress and revenue vs expenses.</li>
                    </ul>
                    <p style="margin-top: 0.5rem;"><strong>Typical Workflow:</strong> Plan event → Book speakers → Recruit volunteers → Set budget → Sell tickets → Execute event → Track actual costs → Report to group</p>
                </div>

                <h3 style="color: #8e44ad; margin-top: 1.5rem;"><i class="fas fa-archive"></i> Archives Management</h3>
                <div style="padding: 1rem; background: #34495e; border-radius: 6px; margin: 1rem 0;">
                    <p><strong>Purpose:</strong> Preserve your group's history through document archiving and oral histories from long-time members.</p>
                    <h4 style="margin-top: 1rem;">How to Use:</h4>
                    <ul style="line-height: 1.8;">
                        <li><strong>Digital Archives:</strong> Index historical documents by title, date, category (meeting minutes, financial records, correspondence, photos, event materials). Add descriptions and search by decade or category.</li>
                        <li><strong>Old-Timer Interviews:</strong> Record oral history interviews with long-time members. Document interviewee name, clean date, years in group, interviewer, interview date, and key stories/highlights.</li>
                        <li><strong>Search & Filter:</strong> Use category and decade filters to quickly find specific types of historical documents. Search archives by title or description.</li>
                        <li><strong>Historical Timeline:</strong> Build a timeline of significant group events, founding date, major decisions, facility moves, and member milestones.</li>
                    </ul>
                    <p style="margin-top: 0.5rem;"><strong>Typical Workflow:</strong> Collect historical documents → Index and categorize → Interview old-timers → Record stories → Build searchable archive → Share history with group</p>
                </div>

                <h3 style="color: #27ae60; margin-top: 1.5rem;"><i class="fas fa-globe"></i> Language Accessibility</h3>
                <div style="padding: 1rem; background: #34495e; border-radius: 6px; margin: 1rem 0;">
                    <p><strong>Purpose:</strong> Make AA accessible to non-English speakers through translation, interpretation, and multilingual materials.</p>
                    <h4 style="margin-top: 1rem;">How to Use:</h4>
                    <ul style="line-height: 1.8;">
                        <li><strong>Translator Registry:</strong> Maintain list of bilingual members who can translate materials. Record member, languages they speak, fluency level (conversational/professional), and availability.</li>
                        <li><strong>Translated Materials:</strong> Track what AA literature and materials have been translated. Document material title, source language, target language, translator, completion date, and where copies are stored.</li>
                        <li><strong>Interpreter Scheduling:</strong> Schedule interpreters for specific meetings or events. Assign interpreter, date/time, meeting type, language pair, and special notes (technical topics, etc.).</li>
                        <li><strong>Closed Captioning:</strong> For virtual meetings, coordinate closed captioning services. Track which meetings offer captions, in what languages, and technical details.</li>
                    </ul>
                    <p style="margin-top: 0.5rem;"><strong>Typical Workflow:</strong> Identify language needs → Recruit bilingual members → Translate priority materials → Schedule interpreters for meetings → Offer captioning → Monitor accessibility</p>
                </div>
            </div>

            <div class="box mb-4" style="border-left: 4px solid #9b59b6;">
                <h2><i class="fas fa-gavel"></i> Step-by-Step: How to Conduct a Group Conscience Meeting</h2>
                <p style="background: #9b59b6; padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem;"><strong><i class="fas fa-info-circle"></i> Complete GC Meeting Workflow</strong> Follow this comprehensive guide to run a proper Group Conscience meeting using this application.</p>

                <h3 style="color: #f39c12; margin-top: 1.5rem;"><i class="fas fa-calendar-plus"></i> BEFORE THE MEETING (1-2 Weeks Prior)</h3>
                <div style="padding: 1.5rem; background: #34495e; border-radius: 6px; margin: 1rem 0; border-left: 4px solid #f39c12;">
                    <h4>Step 1: Collect Agenda Items</h4>
                    <ol style="line-height: 2;">
                        <li><strong>Open Proposed Agenda Items:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Navigate to <strong>Group Conscience → Live GC Session</strong></li>
                                <li>Scroll to "Proposed Agenda Items" section</li>
                                <li>Members can submit items they want discussed</li>
                                <li>Each item should have: Title, Description, Proposer, Category</li>
                            </ul>
                        </li>
                        <li><strong>Review Standing Items:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Check <strong>Group Conscience → GC Inventory</strong> for Standing Agenda Items</li>
                                <li>Standard items: Treasury Report, GSR Report, Committee Reports</li>
                                <li>These auto-appear on every GC agenda</li>
                            </ul>
                        </li>
                        <li><strong>Announce the Meeting:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Go to <strong>Fellowship → Announcements</strong></li>
                                <li>Create announcement with: Date, Time, Location, Proposed agenda items</li>
                                <li>Make announcement at regular meetings for 2 weeks prior</li>
                            </ul>
                        </li>
                    </ol>
                </div>

                <h3 style="color: #3498db; margin-top: 1.5rem;"><i class="fas fa-door-open"></i> OPENING THE MEETING (First 15 Minutes)</h3>
                <div style="padding: 1.5rem; background: #34495e; border-radius: 6px; margin: 1rem 0; border-left: 4px solid #3498db;">
                    <h4>Step 2: Start Live GC Session</h4>
                    <ol style="line-height: 2;">
                        <li><strong>Open the Live Session:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Navigate to <strong>Group Conscience → Live GC Session</strong></li>
                                <li>Click "Start New GC Session"</li>
                                <li>System shows: Attendance tracker, Quorum calculator, Motion workspace</li>
                            </ul>
                        </li>
                        <li><strong>Record Attendance:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Count all present members</li>
                                <li>Enter number in "Members Present" field</li>
                                <li>System automatically calculates if quorum is met</li>
                                <li>Quorum rules set in: <strong>Settings → Quorum Management</strong></li>
                                <li><em>Note:</em> No quorum = no official votes, but can discuss</li>
                            </ul>
                        </li>
                        <li><strong>Review Agenda:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Chairperson reads all proposed items aloud</li>
                                <li>Group votes to adopt the agenda (or modify)</li>
                                <li>Move adopted items to "Active GC Items"</li>
                            </ul>
                        </li>
                        <li><strong>Review Previous Minutes:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Go to <strong>Reports → Meeting Minutes</strong></li>
                                <li>Secretary reads minutes from last GC</li>
                                <li>Group votes to approve (or amend) minutes</li>
                            </ul>
                        </li>
                    </ol>
                </div>

                <h3 style="color: #2ecc71; margin-top: 1.5rem;"><i class="fas fa-comments"></i> PROCESSING MOTIONS (Main Meeting)</h3>
                <div style="padding: 1.5rem; background: #34495e; border-radius: 6px; margin: 1rem 0; border-left: 4px solid #2ecc71;">
                    <h4>Step 3: Process Each Motion Using Parliamentary Procedure</h4>
                    <ol style="line-height: 2;">
                        <li><strong>Present the Motion:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>In Live GC section, click "Add New Motion"</li>
                                <li>Enter: Motion text, Proposer name, Motion type (finance/service/policy)</li>
                                <li>Click "Submit Motion"</li>
                                <li>System displays motion on screen for all to see</li>
                            </ul>
                        </li>
                        <li><strong>Call for Second:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Chairperson asks: "Do we have a second?"</li>
                                <li>Click "Call for Second" button</li>
                                <li>If no second → Motion dies (record as "No Second")</li>
                                <li>If seconded → Enter seconder's name, move to discussion</li>
                            </ul>
                        </li>
                        <li><strong>Discussion Phase:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Navigate to <strong>Group Conscience → Parliamentary Procedure</strong> for Speaking Queue</li>
                                <li>Members raise hands to speak</li>
                                <li>Add each to speaking queue in order</li>
                                <li>Optional: Set 3-minute timer per speaker</li>
                                <li><em>During Discussion:</em> Members can use Points of Order:
                                    <ul style="margin-top: 0.25rem;">
                                        <li><strong>Point of Information:</strong> Ask clarifying question (doesn't interrupt)</li>
                                        <li><strong>Point of Order:</strong> Challenge procedural violation (interrupts)</li>
                                        <li><strong>Point of Privilege:</strong> Address immediate need (temp, noise, etc.)</li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                        <li><strong>Handle Amendments (If Proposed):</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Scroll to "Amendments" section in Live GC</li>
                                <li>Enter amendment text</li>
                                <li>Select type:
                                    <ul style="margin-top: 0.25rem;">
                                        <li><strong>Friendly Amendment:</strong> Proposer accepts → No vote needed</li>
                                        <li><strong>Unfriendly Amendment:</strong> Must be voted on before main motion</li>
                                    </ul>
                                </li>
                                <li>If unfriendly: Discuss and vote on amendment first</li>
                                <li>Then return to main motion (as amended or original)</li>
                            </ul>
                        </li>
                        <li><strong>Special Cases:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li><strong>Table Motion:</strong> Click "Table Motion" → Set date for revisit → Motion moves to Tabled Motions (view in GC Decisions)</li>
                                <li><strong>Research Period:</strong> If group needs more info, activate Research Period → Assign person to research → Set deadline → Continue at next GC</li>
                                <li><strong>Call the Question:</strong> Any member can move to end discussion and vote immediately → Requires 2/3 vote to pass → If passes, proceed to vote</li>
                            </ul>
                        </li>
                        <li><strong>Vote on Motion:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Select voting method (set in <strong>Group Conscience → Voting Settings</strong>):
                                    <ul style="margin-top: 0.25rem;">
                                        <li><strong>Substantial Unanimity (Default):</strong> 2/3 majority (AA standard)</li>
                                        <li><strong>Simple Majority:</strong> 50% + 1</li>
                                        <li><strong>Voice Vote:</strong> All say "Aye" or "Nay"</li>
                                        <li><strong>Show of Hands:</strong> Visual count</li>
                                        <li><strong>Written Ballot:</strong> Anonymous voting (for sensitive issues)</li>
                                    </ul>
                                </li>
                                <li>Enter vote counts: For / Against / Abstain</li>
                                <li>Click "Calculate Result"</li>
                                <li>System shows: Passed/Failed, Percentage, Whether substantial unanimity met</li>
                            </ul>
                        </li>
                        <li><strong>Minority Report (Automatic if needed):</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>If motion passes but opposition ≥33%, system auto-shows Minority Report section</li>
                                <li>Minority can state their concerns for the record</li>
                                <li>This protects minority voice per AA Tradition</li>
                                <li>Record minority concerns → Saved with decision</li>
                            </ul>
                        </li>
                        <li><strong>Record the Outcome:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>System auto-saves to <strong>Group Conscience → Decision History</strong></li>
                                <li>Includes: Motion text, votes, result, date, minority opinions</li>
                                <li>If motion requires action, create Action Item in Fellowship → Action Items</li>
                            </ul>
                        </li>
                    </ol>
                </div>

                <h3 style="color: #e74c3c; margin-top: 1.5rem;"><i class="fas fa-door-closed"></i> CLOSING THE MEETING (Final 10 Minutes)</h3>
                <div style="padding: 1.5rem; background: #34495e; border-radius: 6px; margin: 1rem 0; border-left: 4px solid #e74c3c;">
                    <h4>Step 4: Wrap Up & Documentation</h4>
                    <ol style="line-height: 2;">
                        <li><strong>Review Action Items:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>List all action items from decisions made</li>
                                <li>Go to <strong>Fellowship → Action Items</strong></li>
                                <li>Assign responsible person and deadline for each</li>
                            </ul>
                        </li>
                        <li><strong>Set Next GC Date:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Announce next GC meeting date</li>
                                <li>Add to <strong>Meetings → Schedule & Calendar</strong></li>
                            </ul>
                        </li>
                        <li><strong>Generate Meeting Minutes:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Go to <strong>Reports → Meeting Minutes</strong></li>
                                <li>Click "Generate Minutes from GC Session"</li>
                                <li>System auto-creates minutes from today's session including:
                                    <ul style="margin-top: 0.25rem;">
                                        <li>All motions and their outcomes</li>
                                        <li>Vote tallies</li>
                                        <li>Amendments</li>
                                        <li>Minority reports</li>
                                        <li>Action items assigned</li>
                                    </ul>
                                </li>
                                <li>Secretary reviews and can edit if needed</li>
                            </ul>
                        </li>
                        <li><strong>Close the GC Session:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Return to <strong>Group Conscience → Live GC Session</strong></li>
                                <li>Click "End GC Session"</li>
                                <li>All data is saved and archived</li>
                            </ul>
                        </li>
                    </ol>
                </div>

                <h3 style="color: #1abc9c; margin-top: 1.5rem;"><i class="fas fa-tasks"></i> AFTER THE MEETING (Follow-Up)</h3>
                <div style="padding: 1.5rem; background: #34495e; border-radius: 6px; margin: 1rem 0; border-left: 4px solid #1abc9c;">
                    <h4>Step 5: Implementation & Tracking</h4>
                    <ol style="line-height: 2;">
                        <li><strong>Track Implementation:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Go to <strong>Group Conscience → Decision Impact</strong></li>
                                <li>For each passed motion, track:
                                    <ul style="margin-top: 0.25rem;">
                                        <li>Has it been implemented? (Yes/No/In Progress)</li>
                                        <li>Who is responsible?</li>
                                        <li>Timeline</li>
                                        <li>Impact on group (positive/negative/neutral)</li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                        <li><strong>Monitor Action Items:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Check <strong>Fellowship → Action Items</strong> weekly</li>
                                <li>Follow up with assigned persons</li>
                                <li>Mark completed when done</li>
                            </ul>
                        </li>
                        <li><strong>Update Financial Records (if applicable):</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>If motion involved money, go to <strong>Treasury → Financial Reports</strong></li>
                                <li>Update budget or record expense/income</li>
                                <li>Treasurer tracks actual vs budgeted amounts</li>
                            </ul>
                        </li>
                        <li><strong>Backup Your Data:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Go to <strong>Settings</strong> (gear icon) → <strong>Backup & Restore</strong></li>
                                <li>Click "Export All Data"</li>
                                <li>Save backup file with date: <code>rowlett-group-backup-2024-01-15.json</code></li>
                                <li><em>Best Practice:</em> Backup after every GC meeting</li>
                            </ul>
                        </li>
                    </ol>
                </div>

                <div style="background: #e74c3c; padding: 1rem; border-radius: 6px; margin-top: 1.5rem;">
                    <h4 style="color: white;"><i class="fas fa-exclamation-triangle"></i> Emergency Group Conscience</h4>
                    <p style="color: white; margin-bottom: 0.5rem;">For urgent matters that can't wait for regular GC:</p>
                    <ol style="color: white; line-height: 1.8;">
                        <li>Navigate to <strong>Group Conscience → Live GC Session</strong></li>
                        <li>Click "Emergency GC" button (red button at top)</li>
                        <li>System opens emergency session with relaxed quorum rules</li>
                        <li>Follow same process as regular GC</li>
                        <li>Document reason for emergency in session notes</li>
                    </ol>
                </div>
            </div>

            <div class="box mb-4" style="border-left: 4px solid #3498db; background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);">
                <h2><i class="fas fa-rocket"></i> Getting Started: First-Time Setup</h2>
                <p style="background: #3498db; padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem;"><strong><i class="fas fa-info-circle"></i> New Group? Start Here!</strong> Follow these steps to set up your group management system from scratch.</p>

                <h3 style="color: #f39c12; margin-top: 1.5rem;"><i class="fas fa-list-ol"></i> WEEK 1: Initial Setup</h3>
                <div style="padding: 1.5rem; background: #34495e; border-radius: 6px; margin: 1rem 0; border-left: 4px solid #f39c12;">
                    <h4>Day 1-2: Add Members & Basic Info</h4>
                    <ol style="line-height: 2;">
                        <li><strong>Add all group members:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Go to <strong>Fellowship → Birthdays & Anniversaries</strong></li>
                                <li>Click "Add Member" for each person</li>
                                <li>Enter: Name, Clean Date, Birthday (optional), Phone (optional)</li>
                                <li>Mark if they're a "Servant" (hold service position)</li>
                                <li><em>Tip:</em> Start with 5-10 active members, add more later</li>
                            </ul>
                        </li>
                        <li><strong>Set up meeting schedule:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Go to <strong>Meetings → Schedule & Calendar</strong></li>
                                <li>Add all regular meeting times (weekly, daily, etc.)</li>
                                <li>Include: Day, Time, Location, Meeting Type, Format</li>
                                <li>Set recurring events (e.g., "Every Monday 7pm")</li>
                            </ul>
                        </li>
                        <li><strong>Create service positions:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Go to <strong>Service → Service Positions</strong></li>
                                <li>Click "Add Position" for each role</li>
                                <li>Standard positions: Chairperson, Secretary, Treasurer, GSR, Literature</li>
                                <li>Enter current holder, start date, term length (typically 6-12 months)</li>
                                <li>System will alert you 30 days before term expires</li>
                            </ul>
                        </li>
                    </ol>

                    <h4 style="margin-top: 1.5rem;">Day 3-4: Financial Setup</h4>
                    <ol style="line-height: 2;" start="4">
                        <li><strong>Set up treasury:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Go to <strong>Treasury → Financial Reports</strong></li>
                                <li>Enter current balance in "Starting Balance" field</li>
                                <li>Add all monthly expenses (rent, literature orders, etc.)</li>
                                <li>Add all income sources (7th tradition, donations)</li>
                            </ul>
                        </li>
                        <li><strong>Set prudent reserve:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Go to <strong>Treasury → Prudent Reserve</strong></li>
                                <li>Common formula: 3-6 months of regular expenses</li>
                                <li>Enter monthly rent, utilities, literature costs</li>
                                <li>System calculates recommended reserve target</li>
                                <li>Track progress toward goal</li>
                            </ul>
                        </li>
                        <li><strong>Create budget categories:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Go to <strong>Treasury → Budget Approval</strong></li>
                                <li>Add categories: Rent, Literature, GSO Contributions, District, Area, Supplies</li>
                                <li>Set monthly budget for each</li>
                                <li>System will alert when categories exceed budget</li>
                            </ul>
                        </li>
                    </ol>

                    <h4 style="margin-top: 1.5rem;">Day 5-7: Group Conscience Configuration</h4>
                    <ol style="line-height: 2;" start="7">
                        <li><strong>Set voting method:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Go to <strong>Group Conscience → Voting Settings</strong></li>
                                <li>Choose method: Substantial Unanimity (recommended), Simple Majority, or Consensus</li>
                                <li>Set threshold: 66.7% for substantial unanimity, 51% for majority</li>
                                <li>Decide if abstentions count in total</li>
                            </ul>
                        </li>
                        <li><strong>Configure quorum rules:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Go to <strong>Settings → Quorum Management</strong></li>
                                <li>Set minimum attendance percentage (typically 50%)</li>
                                <li>Set absolute minimum (e.g., 5 people)</li>
                                <li>Decide if you allow proxy voting</li>
                            </ul>
                        </li>
                        <li><strong>Create motion templates:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Go to <strong>Group Conscience → Motion Templates</strong></li>
                                <li>Add common motions your group uses</li>
                                <li>Examples: "Purchase new literature", "Change meeting time", "Elect service position"</li>
                                <li>Templates save time during GC meetings</li>
                            </ul>
                        </li>
                    </ol>
                </div>

                <h3 style="color: #2ecc71; margin-top: 1.5rem;"><i class="fas fa-check-circle"></i> WEEK 2: Test Run</h3>
                <div style="padding: 1.5rem; background: #34495e; border-radius: 6px; margin: 1rem 0; border-left: 4px solid #2ecc71;">
                    <ol style="line-height: 2;" start="10">
                        <li><strong>Practice with a test GC meeting:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Go to <strong>Group Conscience → Live GC Session</strong></li>
                                <li>Click "Start Group Conscience Meeting"</li>
                                <li>Add a test motion (e.g., "Approve starting balance")</li>
                                <li>Practice recording votes</li>
                                <li>View decision in Decision History</li>
                                <li><em>This is just practice - you can delete it later!</em></li>
                            </ul>
                        </li>
                        <li><strong>Create your first backup:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Go to <strong>Settings (gear icon) → Backup & Restore</strong></li>
                                <li>Click "Export Full Backup"</li>
                                <li>Save the JSON file to a safe location (USB drive, cloud storage)</li>
                                <li>Test the backup by importing it in a different browser</li>
                                <li><strong>CRITICAL:</strong> Schedule weekly backups - set a reminder!</li>
                            </ul>
                        </li>
                        <li><strong>Announce to the group:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Inform members the system is ready</li>
                                <li>Share the URL or file location</li>
                                <li>Explain it's stored locally (no servers, maintains anonymity)</li>
                                <li>Encourage members to view Help & Guide section</li>
                            </ul>
                        </li>
                    </ol>
                </div>
            </div>

            <div class="box mb-4" style="border-left: 4px solid #2ecc71;">
                <h2><i class="fas fa-calendar-check"></i> Complete Weekly Meeting Workflow</h2>
                <p style="background: #2ecc71; color: #2c3e50; padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem; font-weight: bold;"><i class="fas fa-lightbulb"></i> Use this workflow every week for consistent, organized meetings.</p>

                <h3 style="color: #3498db;">24 Hours BEFORE the Meeting</h3>
                <div style="padding: 1.5rem; background: #34495e; border-radius: 6px; margin: 1rem 0;">
                    <h4>Secretary/Chairperson Preparation</h4>
                    <ol style="line-height: 2;">
                        <li><strong>Review upcoming events:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Check <strong>Home</strong> dashboard for tomorrow's events</li>
                                <li>Verify birthdays and anniversaries</li>
                                <li>Note any announcements to read</li>
                            </ul>
                        </li>
                        <li><strong>Check format rotation:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Go to <strong>Meetings → Format Rotation</strong></li>
                                <li>Confirm which format is scheduled</li>
                                <li>Print or bookmark the reading if needed</li>
                            </ul>
                        </li>
                        <li><strong>Review commitment board:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Go to <strong>Meetings → Commitment Board</strong></li>
                                <li>Check who's scheduled to speak</li>
                                <li>Verify greeter, treasurer, coffee maker</li>
                                <li>Contact members if spots are unfilled</li>
                            </ul>
                        </li>
                        <li><strong>Prepare announcements:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Go to <strong>Fellowship → Announcements</strong></li>
                                <li>Review active announcements</li>
                                <li>Add any new ones (district events, group activities)</li>
                                <li>Mark inactive ones as "ended"</li>
                            </ul>
                        </li>
                    </ol>
                </div>

                <h3 style="color: #f39c12; margin-top: 1.5rem;">DURING the Meeting (Live Recording)</h3>
                <div style="padding: 1.5rem; background: #34495e; border-radius: 6px; margin: 1rem 0;">
                    <h4>Secretary's Realtime Tasks</h4>
                    <ol style="line-height: 2;">
                        <li><strong>Open secretary section:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Navigate to <strong>Meetings → Secretary Functions</strong></li>
                                <li>This section has all tools you need during meeting</li>
                            </ul>
                        </li>
                        <li><strong>Track attendance (as people arrive):</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Scroll to "Meeting Attendance Tracker"</li>
                                <li>Select today's date</li>
                                <li>Check boxes for each member present</li>
                                <li>Add guest count if applicable</li>
                                <li>System automatically calculates totals</li>
                            </ul>
                        </li>
                        <li><strong>Take meeting minutes (during meeting):</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Scroll to "Meeting Minutes"</li>
                                <li>Note: Opening (who chaired), Format used, Special events</li>
                                <li>Record any important discussions</li>
                                <li>Note who shared (if your group tracks this)</li>
                                <li>Record closing time</li>
                            </ul>
                        </li>
                        <li><strong>Log 7th tradition (after basket passes):</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Go to <strong>Treasury → 7th Tradition Analysis</strong></li>
                                <li>Click "Add Collection"</li>
                                <li>Enter amount collected</li>
                                <li>Note attendance (for per-person average)</li>
                                <li>System tracks trends over time</li>
                            </ul>
                        </li>
                        <li><strong>Record any decisions (if applicable):</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>If group conscience items were discussed</li>
                                <li>Go to <strong>Group Conscience → Live GC Session</strong></li>
                                <li>Follow GC workflow (see separate section)</li>
                            </ul>
                        </li>
                    </ol>

                    <h4 style="margin-top: 1.5rem;">Treasurer's Tasks During Meeting</h4>
                    <ol style="line-height: 2;" start="6">
                        <li><strong>Count 7th tradition:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Count cash immediately after basket passes</li>
                                <li>Have another person verify count (two-person accountability)</li>
                                <li>Enter into system (step 4 above)</li>
                            </ul>
                        </li>
                        <li><strong>Give brief treasurer report (if scheduled):</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Open <strong>Treasury → Financial Reports</strong> on phone/laptop</li>
                                <li>Report: Current balance, Recent expenses, Prudent reserve status</li>
                                <li>Keep it brief (2-3 minutes maximum)</li>
                            </ul>
                        </li>
                    </ol>
                </div>

                <h3 style="color: #9b59b6; margin-top: 1.5rem;">AFTER the Meeting (Within 24 Hours)</h3>
                <div style="padding: 1.5rem; background: #34495e; border-radius: 6px; margin: 1rem 0;">
                    <h4>Secretary Follow-Up</h4>
                    <ol style="line-height: 2;">
                        <li><strong>Finalize minutes:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Return to <strong>Meetings → Secretary Functions</strong></li>
                                <li>Review and clean up any typos</li>
                                <li>Save minutes</li>
                                <li>Optional: Export to PDF for email distribution</li>
                            </ul>
                        </li>
                        <li><strong>Send thank you messages:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Go to <strong>Fellowship → Messages</strong></li>
                                <li>Send quick thanks to speaker, greeter, coffee maker</li>
                                <li>Maintains good fellowship and encourages continued service</li>
                            </ul>
                        </li>
                        <li><strong>Update any action items:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>If tasks were assigned during meeting</li>
                                <li>Check <strong>Home</strong> dashboard "Pending Action Items"</li>
                                <li>Update progress or mark complete</li>
                            </ul>
                        </li>
                    </ol>

                    <h4 style="margin-top: 1.5rem;">Treasurer Follow-Up</h4>
                    <ol style="line-height: 2;" start="4">
                        <li><strong>Deposit funds (within 48 hours):</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Take 7th tradition to bank</li>
                                <li>Get deposit receipt</li>
                                <li>Update balance in system</li>
                            </ul>
                        </li>
                        <li><strong>Record transaction:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Go to <strong>Treasury → Financial Reports</strong></li>
                                <li>Click "Add Income"</li>
                                <li>Enter: Date, Amount, Source (7th Tradition), Receipt number</li>
                                <li>New balance updates automatically</li>
                            </ul>
                        </li>
                    </ol>
                </div>
            </div>

            <div class="box mb-4" style="border-left: 4px solid #f1c40f;">
                <h2><i class="fas fa-coins"></i> Monthly Treasurer Workflow (The Full Process)</h2>
                <p style="background: #f39c12; color: #2c3e50; padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem; font-weight: bold;"><i class="fas fa-calendar-alt"></i> Complete this workflow on the 1st-5th of every month.</p>

                <h3 style="color: #3498db;">Week 1: Month-End Reconciliation</h3>
                <div style="padding: 1.5rem; background: #34495e; border-radius: 6px; margin: 1rem 0;">
                    <ol style="line-height: 2;">
                        <li><strong>Reconcile bank statement:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Get bank statement (online or paper)</li>
                                <li>Compare bank balance to system balance</li>
                                <li>Go to <strong>Treasury → Financial Reports</strong></li>
                                <li>Click "Reconcile" button</li>
                                <li>If differences exist:
                                    <ul>
                                        <li>Check for missing deposits or expenses</li>
                                        <li>Add any bank fees not yet recorded</li>
                                        <li>Add any interest earned</li>
                                        <li>Verify all transactions match</li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                        <li><strong>Review 7th tradition trends:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Go to <strong>Treasury → 7th Tradition Analysis</strong></li>
                                <li>View charts for last 30/60/90 days</li>
                                <li>Note patterns:
                                    <ul>
                                        <li>Are contributions increasing or decreasing?</li>
                                        <li>Is per-person average healthy? (typically $2-5 per meeting)</li>
                                        <li>Any concerning trends to report to group?</li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                        <li><strong>Update prudent reserve tracking:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Go to <strong>Treasury → Prudent Reserve</strong></li>
                                <li>System auto-calculates current reserve status</li>
                                <li>If below target: Note how many months to reach goal at current rate</li>
                                <li>If above target: Consider contributions to GSO, District, Area</li>
                            </ul>
                        </li>
                        <li><strong>Review budget vs. actual:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Go to <strong>Treasury → Budget Approval</strong></li>
                                <li>Compare budgeted vs. actual spending for each category</li>
                                <li>Flag categories that exceeded budget</li>
                                <li>Note categories well under budget</li>
                                <li>This data helps inform next GC budget discussion</li>
                            </ul>
                        </li>
                    </ol>
                </div>

                <h3 style="color: #e74c3c; margin-top: 1.5rem;">Week 2: Required Contributions</h3>
                <div style="padding: 1.5rem; background: #34495e; border-radius: 6px; margin: 1rem 0;">
                    <ol style="line-height: 2;" start="5">
                        <li><strong>Calculate contributions (after prudent reserve):</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Amount available = Current Balance - Prudent Reserve Target</li>
                                <li>If amount is positive, you can contribute</li>
                                <li>Typical split: 50% GSO, 30% District, 20% Area</li>
                                <li><em>Note:</em> This is a suggestion, not a rule. Your group decides!</li>
                            </ul>
                        </li>
                        <li><strong>Prepare contribution checks/payments:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Write checks or prepare online transfers</li>
                                <li><strong>GSO:</strong> Mail to General Service Office, PO Box 459, Grand Central Station, New York, NY 10163</li>
                                <li><strong>District:</strong> Give to DCM at district meeting or mail per district instructions</li>
                                <li><strong>Area:</strong> Give to Area Treasurer or mail per area instructions</li>
                                <li>Include group number and location on all checks</li>
                            </ul>
                        </li>
                        <li><strong>Record contributions in system:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Go to <strong>Treasury → Financial Reports</strong></li>
                                <li>Click "Add Expense" for each contribution</li>
                                <li>Category: "GSO Contribution", "District Contribution", "Area Contribution"</li>
                                <li>Enter check numbers and amounts</li>
                                <li>System tracks total contributed over time</li>
                            </ul>
                        </li>
                    </ol>
                </div>

                <h3 style="color: #2ecc71; margin-top: 1.5rem;">Week 3: Monthly Report Preparation</h3>
                <div style="padding: 1.5rem; background: #34495e; border-radius: 6px; margin: 1rem 0;">
                    <ol style="line-height: 2;" start="8">
                        <li><strong>Generate monthly report:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Go to <strong>Treasury → Financial Reports</strong></li>
                                <li>Click "Generate Monthly Report"</li>
                                <li>Select last month from dropdown</li>
                                <li>Report includes:
                                    <ul>
                                        <li>Opening balance</li>
                                        <li>Total income (7th tradition, donations)</li>
                                        <li>Total expenses by category</li>
                                        <li>Closing balance</li>
                                        <li>Prudent reserve status</li>
                                        <li>Contributions made</li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                        <li><strong>Export report for distribution:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Click "Export to PDF"</li>
                                <li>Email to group or print for display at meetings</li>
                                <li>Or simply display on screen during meeting</li>
                            </ul>
                        </li>
                        <li><strong>Prepare verbal report for group:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Keep it simple and brief (3 minutes max)</li>
                                <li>Sample script: "Our opening balance was $X. We collected $Y in 7th tradition. We spent $Z on [major expenses]. Our closing balance is $A. Our prudent reserve target is $B, and we're at X% of that goal. We contributed $C to GSO/District/Area this month. Any questions?"</li>
                            </ul>
                        </li>
                    </ol>
                </div>

                <h3 style="color: #9b59b6; margin-top: 1.5rem;">Week 4: Maintenance & Planning</h3>
                <div style="padding: 1.5rem; background: #34495e; border-radius: 6px; margin: 1rem 0;">
                    <ol style="line-height: 2;" start="11">
                        <li><strong>Review upcoming expenses:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Check calendar for next month's known expenses</li>
                                <li>Rent due dates</li>
                                <li>Literature orders needed</li>
                                <li>Chips inventory low?</li>
                                <li>Any service position conferences/workshops</li>
                            </ul>
                        </li>
                        <li><strong>Create backup of financial data:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Go to <strong>Settings → Backup & Restore</strong></li>
                                <li>Export full backup</li>
                                <li>Save with date: "GroupBackup-YYYY-MM-DD.json"</li>
                                <li>Store in multiple locations (USB + cloud)</li>
                            </ul>
                        </li>
                        <li><strong>If needed, schedule budget GC:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>If expenses consistently exceed income</li>
                                <li>If major purchase needed</li>
                                <li>If prudent reserve not being reached</li>
                                <li>Propose GC agenda item to address financial situation</li>
                            </ul>
                        </li>
                    </ol>
                </div>
            </div>

            <div class="box mb-4" style="border-left: 4px solid #9b59b6;">
                <h2><i class="fas fa-users-cog"></i> Quarterly Service Rotation Workflow</h2>
                <p style="background: #8e44ad; padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem; font-weight: bold;"><i class="fas fa-sync"></i> Service positions typically rotate every 6-12 months. Use this workflow 30 days before rotation.</p>

                <h3 style="color: #f39c12;">30 Days Before Term Ends</h3>
                <div style="padding: 1.5rem; background: #34495e; border-radius: 6px; margin: 1rem 0;">
                    <h4>System Will Auto-Alert</h4>
                    <p style="margin-bottom: 1rem;">The system automatically checks term expiration dates and will show notification on Home dashboard.</p>

                    <ol style="line-height: 2;">
                        <li><strong>Review expiring positions:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Go to <strong>Service → Service Positions</strong></li>
                                <li>Click "View Expiring Soon"</li>
                                <li>Note which positions need elections</li>
                            </ul>
                        </li>
                        <li><strong>Announce upcoming elections:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>At business meeting, announce which positions will rotate</li>
                                <li>Explain qualifications for each position (per your bylaws)</li>
                                <li>Encourage members to consider service</li>
                                <li>Give 2-4 weeks notice before election</li>
                            </ul>
                        </li>
                        <li><strong>Create GC agenda item:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Go to <strong>Group Conscience → Decision History</strong></li>
                                <li>Scroll to "Proposed Agenda Items"</li>
                                <li>Add item: "Election for [Position Name]"</li>
                                <li>Include qualifications and responsibilities</li>
                                <li>Set for next scheduled GC meeting</li>
                            </ul>
                        </li>
                    </ol>
                </div>

                <h3 style="color: #3498db; margin-top: 1.5rem;">Election Day (At GC Meeting)</h3>
                <div style="padding: 1.5rem; background: #34495e; border-radius: 6px; margin: 1rem 0;">
                    <ol style="line-height: 2;" start="4">
                        <li><strong>Set up election in system:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Go to <strong>Service → Service Elections</strong></li>
                                <li>Click "Start New Election"</li>
                                <li>Select position from dropdown</li>
                                <li>Choose election method:
                                    <ul>
                                        <li><strong>Third Legacy:</strong> Requires 2/3 vote, multiple rounds if needed</li>
                                        <li><strong>Simple Vote:</strong> Highest vote total wins</li>
                                        <li><strong>Consensus:</strong> Must have unanimous agreement</li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                        <li><strong>Call for nominations:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Chairperson asks: "Are there any nominations for [Position]?"</li>
                                <li>Secretary enters each nomination in system</li>
                                <li>Enter nominee name from member dropdown</li>
                                <li>Note: Some groups require nominee acceptance before voting</li>
                                <li>Close nominations when no more are offered</li>
                            </ul>
                        </li>
                        <li><strong>Conduct voting:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Click "Begin Voting"</li>
                                <li>System displays all nominees</li>
                                <li>Record votes for each nominee</li>
                                <li>If using Third Legacy:
                                    <ul>
                                        <li>System calculates if anyone reached 2/3</li>
                                        <li>If not, proceed to second round</li>
                                        <li>Remove nominee(s) with fewest votes</li>
                                        <li>Re-vote until someone reaches threshold</li>
                                    </ul>
                                </li>
                                <li>System declares winner automatically</li>
                            </ul>
                        </li>
                        <li><strong>Record the election result:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Winner is automatically saved</li>
                                <li>System updates Service Positions with new holder</li>
                                <li>Start date set to today (or date specified)</li>
                                <li>Term expiration calculated automatically</li>
                                <li>You'll get reminder again when term approaches end</li>
                            </ul>
                        </li>
                    </ol>
                </div>

                <h3 style="color: #2ecc71; margin-top: 1.5rem;">After Election (Transition Period)</h3>
                <div style="padding: 1.5rem; background: #34495e; border-radius: 6px; margin: 1rem 0;">
                    <ol style="line-height: 2;" start="8">
                        <li><strong>Outgoing servant creates transition document:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Go to <strong>Resources → Document Templates</strong></li>
                                <li>Use "Service Position Transition" template</li>
                                <li>Include:
                                    <ul>
                                        <li>Key contacts (bank, landlord, suppliers, etc.)</li>
                                        <li>Account numbers and passwords</li>
                                        <li>Recurring tasks and their schedules</li>
                                        <li>Lessons learned and helpful tips</li>
                                        <li>Pending tasks to complete</li>
                                    </ul>
                                </li>
                                <li>Export to PDF and share with incoming servant</li>
                            </ul>
                        </li>
                        <li><strong>Schedule orientation meeting:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Outgoing and incoming servants meet in person</li>
                                <li>Review transition document together</li>
                                <li>Transfer any physical items (keys, checkbook, etc.)</li>
                                <li>Update bank signature cards if needed</li>
                                <li>Add incoming servant to relevant email lists</li>
                            </ul>
                        </li>
                        <li><strong>Update system access:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>If using role-based access control</li>
                                <li>Go to <strong>Settings → Role & View Settings</strong></li>
                                <li>Update permissions for new position holder</li>
                                <li>Remove old holder's extra permissions</li>
                            </ul>
                        </li>
                        <li><strong>Celebrate the service!</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>At next meeting, formally recognize outgoing servant</li>
                                <li>Optional: Give anniversary chip if they served full term</li>
                                <li>Welcome new servant publicly</li>
                                <li>This encourages continued service in the fellowship</li>
                            </ul>
                        </li>
                    </ol>
                </div>
            </div>

            <div class="box mb-4" style="border-left: 4px solid #e74c3c;">
                <h2><i class="fas fa-exclamation-circle"></i> Emergency & Crisis Scenarios</h2>
                <p style="background: #e74c3c; padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem; font-weight: bold;"><i class="fas fa-bell"></i> Sometimes urgent decisions must be made. Here's how to handle various crisis situations.</p>

                <h3 style="color: #f39c12;">Scenario 1: Sudden Loss of Meeting Space</h3>
                <div style="padding: 1.5rem; background: #34495e; border-radius: 6px; margin: 1rem 0; border-left: 4px solid #f39c12;">
                    <p style="margin-bottom: 1rem;"><strong>Situation:</strong> Your landlord just gave you 7-day notice that you can't meet there anymore.</p>

                    <h4>Immediate Actions (Day 1):</h4>
                    <ol style="line-height: 2;">
                        <li><strong>Call emergency GC:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Go to <strong>Group Conscience → Live GC Session</strong></li>
                                <li>Click "Initiate Emergency GC"</li>
                                <li>Document the situation in detail</li>
                                <li>Set emergency meeting date (within 48 hours)</li>
                            </ul>
                        </li>
                        <li><strong>Notify all members immediately:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Use <strong>Fellowship → Messages</strong> to send blast message</li>
                                <li>Text/call key members directly</li>
                                <li>Post announcement at meeting location</li>
                                <li>Include: Date/time of emergency GC, Situation summary, Urgency level</li>
                            </ul>
                        </li>
                        <li><strong>Research alternative locations:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Contact nearby churches, community centers, libraries</li>
                                <li>Check other AA groups for space-sharing possibilities</li>
                                <li>Document: Location, Cost, Availability, Contact person</li>
                                <li>Add findings to "Emergency GC" notes</li>
                            </ul>
                        </li>
                    </ol>

                    <h4 style="margin-top: 1rem;">Emergency GC Meeting (Within 48 Hours):</h4>
                    <ol style="line-height: 2;" start="4">
                        <li><strong>Present options:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Share all researched locations with pros/cons</li>
                                <li>Include cost comparison, accessibility, parking</li>
                                <li>Note immediate availability</li>
                            </ul>
                        </li>
                        <li><strong>Make quick decision:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Group votes on interim solution</li>
                                <li>Record decision in Emergency GC log</li>
                                <li>Assign action items: Contact new location, move supplies, update meeting list</li>
                            </ul>
                        </li>
                        <li><strong>Update all directories:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Update location in <strong>Meetings → Schedule</strong></li>
                                <li>Contact Area/District meeting list chair</li>
                                <li>Update aa.org meeting finder</li>
                                <li>Post notices at old location with new address</li>
                            </ul>
                        </li>
                    </ol>
                </div>

                <h3 style="color: #e74c3c; margin-top: 1.5rem;">Scenario 2: Treasury Emergency (Unauthorized Spending)</h3>
                <div style="padding: 1.5rem; background: #34495e; border-radius: 6px; margin: 1rem 0; border-left: 4px solid #e74c3c;">
                    <p style="margin-bottom: 1rem;"><strong>Situation:</strong> You discover the treasurer made large unauthorized purchases, balance is critically low.</p>

                    <h4>Immediate Actions:</h4>
                    <ol style="line-height: 2;">
                        <li><strong>Verify the situation:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Check bank statement against system records</li>
                                <li>Document all unauthorized transactions</li>
                                <li>Take screenshots/photos of evidence</li>
                                <li>Determine current actual balance</li>
                            </ul>
                        </li>
                        <li><strong>Protect the treasury immediately:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>If possible, freeze bank account temporarily</li>
                                <li>Remove treasurer from account access</li>
                                <li>Assign interim treasurer if needed</li>
                                <li>Change any online banking passwords</li>
                            </ul>
                        </li>
                        <li><strong>Call emergency GC:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Initiate emergency GC in system</li>
                                <li>Notify trusted servants immediately</li>
                                <li>Schedule meeting within 48 hours</li>
                                <li><strong>Important:</strong> Handle with love and compassion - addiction often plays a role</li>
                            </ul>
                        </li>
                        <li><strong>Document everything:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Go to <strong>Settings → Audit Log</strong></li>
                                <li>Export all treasury activity logs</li>
                                <li>Create timeline of events</li>
                                <li>This protects both group and individual</li>
                            </ul>
                        </li>
                    </ol>

                    <h4 style="margin-top: 1rem;">At Emergency GC:</h4>
                    <ol style="line-height: 2;" start="5">
                        <li><strong>Address the financial situation:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Present facts without judgment</li>
                                <li>Show bank statement vs. system records</li>
                                <li>Determine if theft or accounting error</li>
                                <li>If theft: Group decides whether to involve authorities (usually not, per traditions)</li>
                            </ul>
                        </li>
                        <li><strong>Implement new safeguards:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Require two signatures on checks over $X</li>
                                <li>Monthly treasurer reports to group (not optional)</li>
                                <li>Quarterly audit by non-treasurer member</li>
                                <li>Two-person count of 7th tradition</li>
                                <li>Regular backups of financial records</li>
                            </ul>
                        </li>
                        <li><strong>Elect new treasurer immediately:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Use <strong>Service → Service Elections</strong></li>
                                <li>Emergency election to fill position</li>
                                <li>New treasurer verifies all accounts day one</li>
                            </ul>
                        </li>
                        <li><strong>Create repayment plan (if applicable):</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>If member admits mistake and wants to make amends</li>
                                <li>Group can accept repayment plan</li>
                                <li>Track in system as special income category</li>
                                <li>Approach with compassion and support recovery</li>
                            </ul>
                        </li>
                    </ol>
                </div>

                <h3 style="color: #f39c12; margin-top: 1.5rem;">Scenario 3: Disruptive Member (Safety Issue)</h3>
                <div style="padding: 1.5rem; background: #34495e; border-radius: 6px; margin: 1rem 0; border-left: 4px solid #f39c12;">
                    <p style="margin-bottom: 1rem;"><strong>Situation:</strong> A member is repeatedly disruptive, threatening, or creating unsafe environment. Other members are staying away.</p>

                    <h4>Immediate Safety First:</h4>
                    <ol style="line-height: 2;">
                        <li><strong>At the moment of incident:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Chairperson calmly but firmly addresses behavior</li>
                                <li>"[Name], your behavior is disruptive. Please step outside to cool down."</li>
                                <li>If threatening: Call police, evacuate if necessary</li>
                                <li>Safety of group always comes first</li>
                            </ul>
                        </li>
                        <li><strong>Document the incident:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Go to <strong>Meetings → Secretary Functions</strong></li>
                                <li>In meeting minutes, factually describe what happened</li>
                                <li>Note: Date, time, specific behaviors, any threats made</li>
                                <li>List witnesses present</li>
                                <li>Keep emotions out of documentation</li>
                            </ul>
                        </li>
                    </ol>

                    <h4 style="margin-top: 1rem;">Schedule Group Conscience:</h4>
                    <ol style="line-height: 2;" start="3">
                        <li><strong>Create GC agenda item:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Go to <strong>Group Conscience → Decision History</strong></li>
                                <li>Add proposed item: "Address disruptive behavior and group safety"</li>
                                <li>Include summary of incidents</li>
                                <li>Set for next GC or call emergency GC if severe</li>
                            </ul>
                        </li>
                        <li><strong>Research AA's guidance:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Review Tradition 1 (Unity) and Tradition 4 (Autonomy)</li>
                                <li>Read "AA Guidelines on Safety in AA"</li>
                                <li>Consult with Area/District if needed</li>
                                <li>Remember: AA is not a refuge from consequences of bad behavior</li>
                            </ul>
                        </li>
                    </ol>

                    <h4 style="margin-top: 1rem;">At Group Conscience:</h4>
                    <ol style="line-height: 2;" start="5">
                        <li><strong>Present the situation:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Read documented incidents objectively</li>
                                <li>Discuss impact on group unity and safety</li>
                                <li>Share member feedback (anonymously)</li>
                            </ul>
                        </li>
                        <li><strong>Discuss options with compassion:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li><strong>Option 1:</strong> Have group members talk to person individually</li>
                                <li><strong>Option 2:</strong> Set behavioral expectations in writing</li>
                                <li><strong>Option 3:</strong> Ask person not to attend for 30/60/90 days</li>
                                <li><strong>Option 4:</strong> Permanently ban from this meeting (suggest other meetings)</li>
                                <li><strong>Remember:</strong> We can't ban from AA, only from our meeting</li>
                            </ul>
                        </li>
                        <li><strong>Vote and implement decision:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Record GC decision in system</li>
                                <li>Assign 2-3 trusted servants to communicate decision</li>
                                <li>Put in writing if person is asked to stay away</li>
                                <li>Include timeframe and conditions for return (if applicable)</li>
                                <li>Follow up: Check in with group regularly on safety</li>
                            </ul>
                        </li>
                    </ol>

                    <h4 style="margin-top: 1rem;">Important Reminders:</h4>
                    <ul style="line-height: 1.8;">
                        <li>Document everything for potential liability protection</li>
                        <li>Balance compassion with safety - both are important</li>
                        <li>Suggest other meetings if asking someone to leave</li>
                        <li>Consider if substance use is active factor</li>
                        <li>Consult Area/District chair or experienced groups</li>
                        <li>Never tolerate threats or violence - call police</li>
                    </ul>
                </div>
            </div>

            <div class="box" style="border-left: 4px solid #1abc9c; background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);">
                <h2><i class="fas fa-graduation-cap"></i> Advanced Features & Special Scenarios</h2>

                <h3 style="color: #3498db; margin-top: 1rem;">Using Decision ROI Calculator (Financial Decisions)</h3>
                <div style="padding: 1.5rem; background: #34495e; border-radius: 6px; margin: 1rem 0;">
                    <p style="margin-bottom: 1rem;"><strong>When to use:</strong> Any financial decision over $500 or recurring expense</p>
                    <p style="margin-bottom: 1rem;"><strong>Example:</strong> Group considering buying a coffee maker vs. continuing to make at home</p>

                    <h4>Step-by-Step Process:</h4>
                    <ol style="line-height: 2;">
                        <li>Go to <strong>Group Conscience → Decision History</strong>, scroll to "Decision ROI Calculator"</li>
                        <li>Enter decision title: "Purchase commercial coffee maker"</li>
                        <li>Initial cost: $450 (coffee maker cost)</li>
                        <li>Ongoing monthly cost: $40 (coffee, filters)</li>
                        <li>Monthly expense savings: $0 (we already make coffee)</li>
                        <li>Revenue impact: $30 (estimated additional donations from better coffee)</li>
                        <li>Timeframe: 24 months (expected lifespan)</li>
                        <li>Click "Calculate ROI"</li>
                        <li><strong>Result:</strong> System shows:
                            <ul style="margin-top: 0.5rem;">
                                <li>Total cost: $1410 over 24 months</li>
                                <li>Total benefit: $720 (additional donations)</li>
                                <li>Net impact: -$690 (negative)</li>
                                <li>Payback: Never breaks even</li>
                                <li><span style="color: #e74c3c;">Recommendation: Not recommended financially</span></li>
                            </ul>
                        </li>
                        <li>Present to group at GC: "The ROI calculator shows this would cost us $690 over 2 years with no financial benefit. However, there may be non-financial benefits like fellowship and member satisfaction. Let's discuss."</li>
                        <li>Group can still approve if non-financial benefits outweigh cost</li>
                        <li>Save calculation in system for future reference</li>
                    </ol>
                </div>

                <h3 style="color: #9b59b6; margin-top: 1.5rem;">Motion Reconsideration (Changing a Past Decision)</h3>
                <div style="padding: 1.5rem; background: #34495e; border-radius: 6px; margin: 1rem 0;">
                    <p style="margin-bottom: 1rem;"><strong>When appropriate:</strong> Significant new information emerged, circumstances changed drastically, original decision having unintended consequences</p>
                    <p style="background: #e74c3c; padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem;"><strong>Warning:</strong> Reconsideration should be RARE. Frequent reconsideration undermines group conscience authority.</p>

                    <h4>Proper Process:</h4>
                    <ol style="line-height: 2;">
                        <li><strong>Submit reconsideration request:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Go to "Motion Reconsideration Workflow" section</li>
                                <li>Select original decision from dropdown</li>
                                <li>Choose reason: "Significant new information" (most common valid reason)</li>
                                <li>Write detailed justification - what NEW information wasn't available before?</li>
                                <li>Submit request</li>
                            </ul>
                        </li>
                        <li><strong>Request goes to review:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Chairperson/secretary reviews request</li>
                                <li>Determines if justification is substantial enough</li>
                                <li>If yes: Add to next GC agenda</li>
                                <li>If no: Deny with explanation</li>
                            </ul>
                        </li>
                        <li><strong>At GC meeting:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Present original decision and circumstances</li>
                                <li>Present new information that changed situation</li>
                                <li>Allow discussion</li>
                                <li>Vote on whether to reconsider (requires 2/3 vote in most groups)</li>
                                <li>If passes: Proceed with new discussion and vote on revised motion</li>
                            </ul>
                        </li>
                        <li><strong>Track in system:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>New decision linked to original decision</li>
                                <li>Both show in Decision History</li>
                                <li>Analytics track reconsideration patterns</li>
                                <li>If you frequently reconsider: There's a deeper group issue to address</li>
                            </ul>
                        </li>
                    </ol>

                    <h4 style="margin-top: 1rem;">Example of VALID Reconsideration:</h4>
                    <p style="padding: 1rem; background: #2c3e50; border-left: 3px solid #2ecc71; border-radius: 4px;">
                        "In January, we voted to move meeting time to 7pm. We didn't know that the building closes at 8pm on weeknights. We've been locked out twice. New information: Building availability. Request to reconsider meeting time."
                    </p>

                    <h4 style="margin-top: 1rem;">Example of INVALID Reconsideration:</h4>
                    <p style="padding: 1rem; background: #2c3e50; border-left: 3px solid #e74c3c; border-radius: 4px;">
                        "We voted to buy new literature two months ago. I disagree with that decision and want to reconsider." <br><br>
                        <em>This is not new information - just disagreement. Reconsideration denied.</em>
                    </p>
                </div>

                <h3 style="color: #f39c12; margin-top: 1.5rem;">Proxy Voting (When Allowed)</h3>
                <div style="padding: 1.5rem; background: #34495e; border-radius: 6px; margin: 1rem 0;">
                    <p style="background: #e67e22; padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem;"><strong>Check Your Bylaws!</strong> Not all groups allow proxy voting. Verify before implementing.</p>

                    <h4>How to Set Up Proxy:</h4>
                    <ol style="line-height: 2;">
                        <li><strong>Member who will be absent:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Go to "Proxy Voting System"</li>
                                <li>Select your name from "Your Name" dropdown</li>
                                <li>Select trusted member from "Designate Proxy To"</li>
                                <li>Choose scope:
                                    <ul>
                                        <li><strong>General:</strong> They vote as they see fit</li>
                                        <li><strong>Directed:</strong> You specify exactly how to vote</li>
                                    </ul>
                                </li>
                                <li>If directed: Enter specific instructions</li>
                                <li>Enter meeting date (proxy only valid for that date)</li>
                                <li>Submit proxy designation</li>
                            </ul>
                        </li>
                        <li><strong>At GC meeting:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Secretary announces proxies: "[Name] has designated [Proxy holder] to vote on their behalf"</li>
                                <li>If general proxy: Holder votes their conscience</li>
                                <li>If directed proxy: Holder votes as instructed</li>
                                <li>System tracks proxy votes separately in voting records</li>
                            </ul>
                        </li>
                        <li><strong>Proxy expires:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Automatically expires after meeting date</li>
                                <li>Member can revoke anytime before meeting</li>
                                <li>Must be re-designated for each meeting</li>
                            </ul>
                        </li>
                    </ol>
                </div>

                <h3 style="color: #2ecc71; margin-top: 1.5rem;">Annual Group Inventory Process</h3>
                <div style="padding: 1.5rem; background: #34495e; border-radius: 6px; margin: 1rem 0;">
                    <p style="margin-bottom: 1rem;"><strong>When:</strong> Once per year, typically in January or on group anniversary</p>
                    <p style="margin-bottom: 1rem;"><strong>Purpose:</strong> Honest self-assessment of group health, effectiveness, and adherence to traditions</p>

                    <h4>6 Weeks Before Inventory:</h4>
                    <ol style="line-height: 2;">
                        <li><strong>Schedule inventory date:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Go to <strong>Settings → Group Inventory Scheduler</strong></li>
                                <li>Set date (typically 2-3 hour dedicated meeting)</li>
                                <li>System sends reminders to all members</li>
                            </ul>
                        </li>
                        <li><strong>Generate inventory questions:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>System provides template based on 12 Traditions</li>
                                <li>Add custom questions specific to your group</li>
                                <li>Examples:
                                    <ul>
                                        <li>"Are we attracting new members effectively?"</li>
                                        <li>"Is our 7th tradition meeting our needs?"</li>
                                        <li>"Are service positions filled and functioning?"</li>
                                        <li>"Do members feel heard in GC meetings?"</li>
                                        <li>"Are we carrying the message effectively?"</li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                        <li><strong>Send inventory survey:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Use <strong>Meetings → Meeting Feedback Survey</strong></li>
                                <li>Adapt questions for annual inventory</li>
                                <li>Allow anonymous responses</li>
                                <li>Give members 2 weeks to complete</li>
                            </ul>
                        </li>
                    </ol>

                    <h4 style="margin-top: 1rem;">At Inventory Meeting:</h4>
                    <ol style="line-height: 2;" start="4">
                        <li><strong>Review analytics:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Present data from <strong>Reports → Group Analytics</strong></li>
                                <li>Show attendance trends, financial health, decision patterns</li>
                                <li>Compare to previous year</li>
                            </ul>
                        </li>
                        <li><strong>Discuss each tradition:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Go through 12 Traditions one at a time</li>
                                <li>Ask: "How well are we practicing this tradition?"</li>
                                <li>Rate each tradition: Excellent / Good / Needs Attention / Poor</li>
                                <li>Use <strong>Unity Checker</strong> to identify specific issues</li>
                            </ul>
                        </li>
                        <li><strong>Create action items:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>For each "Needs Attention" area, create action item</li>
                                <li>Assign to specific member or committee</li>
                                <li>Set reasonable deadlines</li>
                                <li>Track in <strong>Home</strong> dashboard action items</li>
                            </ul>
                        </li>
                        <li><strong>Set goals for coming year:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Based on inventory findings</li>
                                <li>Make them specific and measurable</li>
                                <li>Example: "Increase average attendance by 10%"</li>
                                <li>Example: "Fill all service positions within 30 days"</li>
                                <li>Example: "Reach prudent reserve target by December"</li>
                            </ul>
                        </li>
                        <li><strong>Document everything:</strong>
                            <ul style="margin-top: 0.5rem;">
                                <li>Save inventory results in system</li>
                                <li>Export report for future reference</li>
                                <li>Compare next year to show progress</li>
                            </ul>
                        </li>
                    </ol>
                </div>
            </div>
        </section>
        <section id="chairperson-section" style="border-left: 4px solid #1abc9c;">
            <h2><i class="fas fa-user-tie"></i> Chairperson's Corner</h2>
            <p class="mb-4">Track meeting attendance, contributions, and manage group affairs efficiently.</p>
            <div style="display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 2rem; padding: 1rem; background: #2c3e50; border-radius: 6px;">
                <button class="btn" onclick="openRosterModal()">
                    <i class="fas fa-users"></i> Member Roster
                </button>
                <button class="btn" onclick="exportChairpersonLogToPDF()">
                    <i class="fas fa-file-pdf"></i> Export Report
                </button>
                <button class="btn" onclick="goToSection('gc-live-section')">
                    <i class="fas fa-gavel"></i> Live GC Session
                </button>
                <button class="btn" onclick="goToSection('gc-decisions-section')">
                    <i class="fas fa-history"></i> GC Decisions
                </button>
            </div>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box" style="border-left: 4px solid #3498db;">
                        <h3><i class="fas fa-clipboard-check"></i> <span id="chairperson-form-title">Log New Meeting</span></h3>
                        <p style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 1rem;">Record attendance and contributions for each meeting.</p>
                        <div class="form-group">
                            <label for="log-date">Meeting Date *</label>
                            <input type="date" id="log-date">
                        </div>
                        <div class="form-group">
                            <label for="log-time">Meeting Time</label>
                            <input type="time" id="log-time">
                        </div>
                        <div class="form-group">
                            <label for="log-chairperson">Chairperson's Name *</label>
                            <select id="log-chairperson"></select>
                        </div>
                        <div class="form-group">
                            <label for="log-headcount"><i class="fas fa-users"></i> Head Count</label>
                            <input type="number" id="log-headcount" placeholder="0" min="0">
                        </div>
                        <div class="form-group">
                            <label for="log-7th-tradition"><i class="fas fa-hand-holding-usd"></i> 7th Tradition ($)</label>
                            <input type="number" id="log-7th-tradition" step="0.01" placeholder="0.00" min="0">
                        </div>
                        <div class="form-group">
                            <label for="log-orange-can"><i class="fas fa-donate"></i> Orange Can ($)</label>
                            <input type="number" id="log-orange-can" step="0.01" placeholder="0.00" min="0">
                        </div>
                        <input type="hidden" id="log-edit-id">
                        <div style="display: flex; gap: 0.5rem;">
                            <button id="log-form-btn" class="btn" onclick="handleChairpersonLogSubmit()">
                                <i class="fas fa-save"></i> Save Entry
                            </button>
                            <button id="log-form-cancel-btn" class="btn secondary" onclick="cancelLogEdit()" style="display:none;">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </div>
                    <div class="box mt-4">
                        <h3><i class="fas fa-table"></i> Recent Meetings</h3>
                        <div style="overflow-x: auto; margin-top: 1rem;">
                            <table id="chairperson-log-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Time</th>
                                        <th>Chairperson</th>
                                        <th>Count</th>
                                        <th>7th Trad.</th>
                                        <th>Orange Can</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="chairperson-log-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div>
                    <div class="box" style="border-left: 4px solid #f39c12;">
                        <h3><i class="fas fa-bullhorn"></i> Active Announcements</h3>
                        <ul id="chairperson-announcements-list" style="min-height: 80px;"></ul>
                        <button class="btn" onclick="goToSection('announcements-section')" style="width: 100%; margin-top: 0.5rem;">
                            <i class="fas fa-edit"></i> Manage Announcements
                        </button>
                    </div>
                    <div class="box mt-4" style="border-left: 4px solid #e74c3c;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3><i class="fas fa-gavel"></i> Live GC Queue</h3>
                            <button class="btn secondary" onclick="toggleLiveGC()" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                                <i class="fas fa-eye"></i> Toggle
                            </button>
                        </div>
                        <div id="live-gc-module" style="display: none;">
                            <div class="form-group">
                                <label for="new-business-item">Quick Add Item</label>
                                <textarea id="new-business-item" rows="2" placeholder="Describe new business..."></textarea>
                            </div>
                            <button class="btn" onclick="addNewBusinessItem()" style="width: 100%; margin-bottom: 1rem;">
                                <i class="fas fa-plus"></i> Add Item
                            </button>
                            <div style="max-height: 250px; overflow-y: auto;">
                                <table id="live-gc-table">
                                    <thead>
                                        <tr>
                                            <th>Item</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="live-gc-body"></tbody>
                                </table>
                            </div>
                        </div>
                        <button class="btn" onclick="goToSection('gc-live-section')" style="width: 100%; margin-top: 0.5rem;">
                            <i class="fas fa-arrow-right"></i> Full GC Session
                        </button>
                    </div>
                    <div class="box mt-4" style="border-left: 4px solid #9b59b6;">
                        <h3><i class="fas fa-history"></i> Recent GC Decisions</h3>
                        <p style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 1rem;">Current month's decisions</p>
                        <div style="max-height: 300px; overflow-y: auto;">
                            <table id="gc-log-table-current" style="font-size: 0.85rem;">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Item</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="gc-log-body-current"></tbody>
                            </table>
                        </div>
                        <button class="btn" onclick="goToSection('gc-decisions-section')" style="width: 100%; margin-top: 1rem;">
                            <i class="fas fa-arrow-right"></i> View All GC Decisions
                        </button>
                    </div>
                </div>
            </div>
            <div class="box mt-4" style="background: #2c3e50; border-left: 4px solid #3498db;">
                <h4><i class="fas fa-info-circle"></i> Need to Log Group Conscience Decisions?</h4>
                <p style="margin-top: 0.5rem; margin-bottom: 1rem;">For detailed Group Conscience logging with workflow tracking, research periods, and complete voting records, please visit the dedicated GC sections.</p>
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button class="btn" onclick="goToSection('gc-live-section')">
                        <i class="fas fa-play"></i> Live GC Session
                    </button>
                    <button class="btn" onclick="goToSection('gc-decisions-section')">
                        <i class="fas fa-archive"></i> GC Decision History
                    </button>
                </div>
            </div>
            <div class="box mt-4" style="border-left: 4px solid #2ecc71;">
                <h3><i class="fas fa-microphone"></i> Record Meeting Audio</h3>
                <p class="mb-2 text-sm" style="font-size: 0.85rem; opacity: 0.8;">Record audio from your microphone and save it as a local file for meeting minutes.</p>
                <div id="audio-recorder-controls" class="flex items-center gap-2" style="display:flex; gap: 0.5rem; align-items: center;">
                    <button id="record-btn" class="btn"><i class="fas fa-microphone" style="margin-right: 0.5rem;"></i>Start Recording</button>
                    <button id="stop-btn" class="btn secondary" disabled><i class="fas fa-stop" style="margin-right: 0.5rem;"></i>Stop</button>
                </div>
                <div id="audio-player-container" class="mt-4" style="display: none;">
                    <audio id="audio-player" controls style="width: 100%;"></audio>
                    <a id="download-link" class="btn mt-2" style="display: none;"><i class="fas fa-download" style="margin-right: 0.5rem;"></i>Download Recording</a>
                </div>
            </div>
        </section>
        <div style="display: none;">
            <input type="hidden" id="gc-edit-id">
            <select id="gc-workflow-status"><option value="decided">Decided</option></select>
            <input type="date" id="gc-date">
            <textarea id="gc-item"></textarea>
            <input type="text" id="gc-submitted-by">
            <input type="date" id="gc-research-start">
            <input type="date" id="gc-research-end">
            <select id="gc-status"><option value="passed">Passed</option></select>
            <input type="number" id="gc-votes-for">
            <input type="number" id="gc-votes-against">
            <input type="number" id="gc-votes-abstain">
            <select multiple id="gc-attendees"></select>
            <div id="gc-servant-reports-container"></div>
            <div id="gc-servant-reports-legacy-container"></div>
            <textarea id="gc-servant-reports-legacy"></textarea>
            <button id="gc-form-btn"></button>
            <button id="gc-form-cancel-btn"></button>
            <div id="vote-summary">
                <span id="total-votes"></span><span id="votes-for-count"></span><span id="percent-for"></span>
                <div id="progress-bar-for"></div><span id="votes-against-count"></span><span id="percent-against"></span>
                <div id="progress-bar-against"></div><span id="votes-abstain-count"></span><span id="percent-abstain"></span>
                <div id="progress-bar-abstain"></div><div id="quorum-status"></div>
            </div>
            <table id="gc-log-table-previous"><thead><tr><th>Date</th></tr></thead><tbody id="gc-log-body-previous"></tbody></table>
            <input type="text" id="proposed-item-title">
            <select id="proposed-item-submitter"></select>
            <textarea id="proposed-item-description"></textarea>
            <input type="number" id="proposed-item-time">
            <select id="proposed-item-urgency"></select>
            <textarea id="proposed-item-background"></textarea>
            <input type="number" id="quorum-percentage">
            <input type="number" id="quorum-minimum">
            <textarea id="action-item-description"></textarea>
            <select id="action-item-assignee"></select>
            <input type="date" id="action-item-due-date">
            <select id="action-item-priority"></select>
            <select id="action-item-related-gc"></select>
            <select id="action-item-dependencies"></select>
            <input type="hidden" id="action-item-edit-id">
            <button id="action-item-btn"></button>
            <button id="action-item-cancel-btn"></button>
            <input type="text" id="gc-search">
            <select id="gc-filter-status"></select>
            <input type="date" id="gc-filter-date-from">
            <input type="date" id="gc-filter-date-to">
            <select id="annual-report-year"></select>
            <table id="proposed-agenda-table"><tbody id="proposed-agenda-body"></tbody></table>
            <table id="action-items-table"><tbody id="action-items-body"></tbody></table>
            <table id="gc-history-search-table"><tbody id="gc-history-search-body"></tbody></table>
            <div id="gc-stats"></div>
            <div id="stat-total-motions"></div>
            <div id="stat-passed-motions"></div>
            <div id="stat-failed-motions"></div>
            <div id="stat-tabled-motions"></div>
            <div id="stat-pass-rate"></div>
            <div id="gc-top-topics"></div>
            <canvas id="gc-trends-monthly-chart"></canvas>
            <canvas id="gc-trends-status-chart"></canvas>
            <canvas id="gc-trends-participation-chart"></canvas>
            <div id="agenda-submission-notice"><span id="agenda-notice-text"></span></div>
            <input type="checkbox" id="action-item-show-completed">
            <select id="action-item-filter-assignee"></select>
        </div>
        </section>
        <section id="companion-section" style="border-left: 4px solid #3498db;">
            <h2><i class="fas fa-book-open"></i> Meeting Companion</h2>
            <p class="mb-4">Select a meeting type to view the format and readings.</p>
            <div id="meeting-format-buttons" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                <button class="btn" onclick="showMeetingFormat('open-discussion')">Open Discussion</button>
                <button class="btn" onclick="showMeetingFormat('closed-discussion')">Closed Discussion</button>
                <button class="btn" onclick="showMeetingFormat('big-book')">Big Book Study</button>
                <button class="btn" onclick="showMeetingFormat('12x12')">12x12 Study</button>
                <button class="btn" onclick="showMeetingFormat('personal-story')">Personal Story</button>
                <button class="btn" onclick="showMeetingFormat('foundations')">Foundations Speaker</button>
                <button class="btn" onclick="showMeetingFormat('birthday')">Birthday Night</button>
            </div>
            <h3 class="mt-4">Readings</h3>
            <div id="reading-buttons" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                <button class="btn" onclick="showMeetingFormat('how-it-works')">How It Works</button>
                <button class="btn" onclick="showMeetingFormat('traditions')">The 12 Traditions</button>
                <button class="btn" onclick="showMeetingFormat('promises')">The 9th Step Promises</button>
            </div>
            <h3 class="mt-4">Dictionary</h3>
            <div class="box mt-4">
                <div class="form-group" style="display: flex; gap: 0.5rem;">
                    <input type="text" id="dictionary-search-word" placeholder="Enter a word..." style="flex-grow: 1;">
                    <button id="dictionary-search-btn" class="btn">Search</button>
                </div>
                <div id="dictionary-results" class="mt-4"></div>
            </div>
            <div id="meeting-format-display" class="box mt-4" style="display: none;">
            </div>
        </section>
        <section id="schedule-section" style="border-left: 4px solid #3498db;">
            <h2><i class="fas fa-calendar-alt"></i> Schedule of Meetings & Events</h2>
            <p class="mb-2">Add recurring weekly meetings or special one-time events. Use the calendar to browse by month. Upcoming events for the next 60 days are listed below.</p>
            <div id="calendar-controls" style="display:flex; align-items:center; justify-content: space-between; gap:0.5rem; margin-bottom:0.5rem;">
                <button class="btn secondary" id="prev-month-btn">&lt; Prev</button>
                <h3 id="calendar-month-year" style="flex:1; text-align:center;"></h3>
                <button class="btn secondary" id="next-month-btn">Next &gt;</button>
            </div>
            <div id="calendar-grid"></div>
            <button class="btn" onclick="toggleEventForm()" style="margin-top: 1rem;">Add New Event</button>
            <button class="btn secondary" onclick="exportToICalendar()" style="margin-top: 1rem; margin-left: 0.5rem;"><i class="fas fa-download"></i> Export to Calendar</button>
            <button class="btn secondary" onclick="generateMeetingQRCode()" style="margin-top: 1rem; margin-left: 0.5rem;"><i class="fas fa-qrcode"></i> Generate QR Code</button>
            <div id="add-event-form" class="box" style="display:none; margin-top: 1rem;">
                <div class="form-group">
                    <label for="event-title">Title</label>
                    <input type="text" id="event-title" placeholder="e.g. Big Book Study" />
                </div>
                <div class="form-group">
                    <label for="event-date">Date (leave blank for weekly)</label>
                    <input type="date" id="event-date" />
                </div>
                <div class="form-group">
                    <label for="event-day">Day of Week (for weekly meetings)</label>
                    <select id="event-day">
                        <option value="">--Select day--</option>
                        <option value="0">Sunday</option>
                        <option value="1">Monday</option>
                        <option value="2">Tuesday</option>
                        <option value="3">Wednesday</option>
                        <option value="4">Thursday</option>
                        <option value="5">Friday</option>
                        <option value="6">Saturday</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="event-time">Time</label>
                    <input type="time" id="event-time" />
                </div>
                <div class="form-group">
                    <label for="event-category">Category</label>
                    <select id="event-category">
                        <option value="General">General</option>
                        <option value="Open Discussion">Open Discussion</option>
                        <option value="Closed Discussion">Closed Discussion</option>
                        <option value="Big Book Study">Big Book Study</option>
                        <option value="12x12 Study">12x12 Study</option>
                        <option value="Personal Story">Personal Story</option>
                        <option value="Foundations Speaker">Foundations Speaker</option>
                        <option value="Birthday Night">Birthday Night</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="event-reading">Reading</label>
                    <input type="text" id="event-reading" placeholder="e.g. How It Works" />
                </div>
                <div class="form-group">
                    <label for="event-speaker">Speaker</label>
                    <select id="event-speaker"></select>
                </div>
                <div class="form-group">
                    <label for="event-chair">Chairperson</label>
                    <select id="event-chair"></select>
                </div>
                <div class="form-group">
                    <label for="event-description">Description</label>
                    <textarea id="event-description" rows="2" placeholder="Notes or description..."></textarea>
                </div>
                <input type="hidden" id="event-edit-id">
                <button id="event-form-btn" class="btn" onclick="handleEventSubmit()">Add Event</button>
                <button id="event-form-cancel-btn" class="btn secondary" onclick="cancelEventEdit()" style="display:none; margin-left: 0.5rem;">Cancel</button>
            </div>
            <h3 class="mt-4">Upcoming Events (Next 30 Days)</h3>
            <div class="form-group">
                <label for="category-filter">Filter by Category</label>
                <select id="category-filter" onchange="updateEventsTable()">
                    <option value="All">All Categories</option>
                    <option value="General">General</option>
                    <option value="Open Discussion">Open Discussion</option>
                    <option value="Closed Discussion">Closed Discussion</option>
                    <option value="Big Book Study">Big Book Study</option>
                    <option value="12x12 Study">12x12 Study</option>
                    <option value="Personal Story">Personal Story</option>
                    <option value="Foundations Speaker">Foundations Speaker</option>
                    <option value="Birthday Night">Birthday Night</option>
                </select>
            </div>
            <table id="events-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Title</th>
                        <th>Category</th>
                        <th>Time</th>
                        <th>Speaker</th>
                        <th>Chair</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="events-body"></tbody>
            </table>
        </section>
        <section id="birthdays-section" style="border-left: 4px solid #f39c12;">
            <h2><i class="fas fa-birthday-cake"></i> Member Roster & Birthdays</h2>
            <p class="mb-2">Add and manage member information and see upcoming sobriety birthdays.</p>
            <button class="btn" onclick="toggleMemberForm()">Add Member</button>
            <button class="btn secondary" onclick="generatePhoneList()" style="margin-left: 0.5rem;"><i class="fas fa-phone"></i> Generate Phone List</button>
            <div id="add-member-form" class="box" style="display:none; margin-top: 1rem;">
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <div class="form-group">
                            <label for="member-name">Name*</label>
                            <input type="text" id="member-name" placeholder="Member's name" />
                        </div>
                        <div class="form-group">
                            <label for="member-birthday">Sobriety Date*</label>
                            <input type="date" id="member-birthday" />
                        </div>
                        <div class="form-group">
                            <label for="member-phone">Phone Number</label>
                            <input type="tel" id="member-phone" placeholder="e.g., 123-456-7890" />
                        </div>
                        <div class="form-group">
                            <label for="member-email">Email</label>
                            <input type="email" id="member-email" placeholder="member@example.com" />
                        </div>
                    </div>
                    <div>
                        <div class="form-group">
                            <label for="member-city">City</label>
                            <input type="text" id="member-city" placeholder="e.g., Dallas" />
                        </div>
                        <div class="form-group">
                            <label for="member-homegroup">Homegroup</label>
                            <input type="text" id="member-homegroup" placeholder="e.g., Your Home Group" />
                        </div>
                        <div class="form-group">
                            <label for="member-sponsor">Sponsor</label>
                            <input type="text" id="member-sponsor" placeholder="Sponsor's name" />
                        </div>
                        <div class="form-group">
                            <label for="member-status">Membership Status*</label>
                            <select id="member-status" style="width: 100%; padding: 0.5rem; border: 1px solid #7f8c8d; border-radius: 4px; background: #34495e; color: #ecf0f1; min-height: 44px;">
                                <option value="home-group-member">Home Group Member</option>
                                <option value="regular-attendee">Regular Attendee</option>
                                <option value="guest">Guest</option>
                                <option value="newcomer">Newcomer (&lt;90 days)</option>
                            </select>
                            <small style="font-size: 0.75rem; opacity: 0.7; display: block; margin-top: 0.25rem;">
                                Home Group Members can vote and hold service positions
                            </small>
                        </div>
                    </div>
                </div>
                <div class="box" style="margin-top: 1rem; border-top: 1px solid #7f8c8d; padding-top: 1rem;">
                    <h4 class="font-bold">Service Position</h4>
                    <div class="form-group" style="display: flex; align-items: center; gap: 1rem;">
                        <input type="checkbox" id="member-is-servant" style="width: auto;"/>
                        <label for="member-is-servant">Is this member a current servant?</label>
                    </div>
                    <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="member-servant-position">Position</label>
                            <input type="text" id="member-servant-position" placeholder="e.g., Treasurer" />
                        </div>
                        <div class="form-group">
                            <label for="member-servant-since">Serving Since</label>
                            <input type="date" id="member-servant-since" />
                        </div>
                    </div>
                </div>
                <div class="box" style="margin-top: 1rem; border-top: 1px solid #7f8c8d; padding-top: 1rem;">
                    <h4 class="font-bold">Sponsorship Availability</h4>
                    <div class="form-group" style="display: flex; align-items: center; gap: 1rem;">
                        <input type="checkbox" id="member-available-sponsor" style="width: auto;"/>
                        <label for="member-available-sponsor">Available to sponsor?</label>
                    </div>
                    <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="member-gender">Gender</label>
                            <select id="member-gender" style="width: 100%; padding: 0.5rem; border: 1px solid #7f8c8d; border-radius: 4px; background: #34495e; color: #ecf0f1; min-height: 44px;">
                                <option value="">Prefer not to say</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="non-binary">Non-binary</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="member-sponsor-preference">Sponsor Preference</label>
                            <select id="member-sponsor-preference" style="width: 100%; padding: 0.5rem; border: 1px solid #7f8c8d; border-radius: 4px; background: #34495e; color: #ecf0f1; min-height: 44px;">
                                <option value="">No preference</option>
                                <option value="same-gender">Same gender only</option>
                                <option value="any">Any gender</option>
                            </select>
                        </div>
                    </div>
                </div>
                <input type="hidden" id="member-edit-id">
                <button id="member-form-btn" class="btn" onclick="handleMemberSubmit()">Add Member</button>
                <button id="member-form-cancel-btn" class="btn secondary" onclick="cancelMemberEdit()" style="display:none; margin-left: 0.5rem;">Cancel</button>
            </div>
            <h3 class="mt-4">Upcoming & Recent Birthdays</h3>
            <table id="birthdays-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Sobriety Date</th>
                        <th>Next Birthday</th>
                        <th>Years</th>
                        <th>Sober Time</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="birthdays-body"></tbody>
            </table>
        </section>

        <section id="attendance-streaks-section" style="border-left: 4px solid #2ecc71;">
            <h2><i class="fas fa-fire"></i> Attendance Streaks</h2>
            <p class="mb-4">Track consecutive meeting attendance and celebrate member dedication!</p>

            <div class="box mb-4">
                <h3>Streak Leaderboard</h3>
                <p style="font-size: 0.9rem; color: #95a5a6; margin-bottom: 1rem;">
                    Members with the longest current attendance streaks
                </p>
                <div id="streak-leaderboard"></div>
            </div>

            <div class="box mb-4">
                <h3>Achievement Badges</h3>
                <p style="font-size: 0.9rem; color: #95a5a6; margin-bottom: 1rem;">
                    Special recognition for attendance milestones
                </p>
                <div class="grid grid-cols-2">
                    <div class="box" style="text-align: center; background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); color: #333;">
                        <h4 style="color: #333; font-size: 1.5rem; margin-bottom: 0.5rem;">
                            <i class="fas fa-trophy"></i> 30 Days
                        </h4>
                        <p style="color: #666;">Commitment Builder</p>
                    </div>
                    <div class="box" style="text-align: center; background: linear-gradient(135deg, #cd7f32 0%, #e89a3c 100%); color: white;">
                        <h4 style="font-size: 1.5rem; margin-bottom: 0.5rem;">
                            <i class="fas fa-medal"></i> 90 Days
                        </h4>
                        <p>Foundation Setter</p>
                    </div>
                    <div class="box" style="text-align: center; background: linear-gradient(135deg, #c0c0c0 0%, #e0e0e0 100%); color: #333;">
                        <h4 style="color: #333; font-size: 1.5rem; margin-bottom: 0.5rem;">
                            <i class="fas fa-star"></i> 180 Days
                        </h4>
                        <p style="color: #666;">Rock Solid</p>
                    </div>
                    <div class="box" style="text-align: center; background: linear-gradient(135deg, #4169e1 0%, #6495ed 100%); color: white;">
                        <h4 style="font-size: 1.5rem; margin-bottom: 0.5rem;">
                            <i class="fas fa-crown"></i> 365 Days
                        </h4>
                        <p>Year of Dedication</p>
                    </div>
                </div>
            </div>

            <div class="box">
                <h3>All Member Streaks</h3>
                <table id="all-streaks-table">
                    <thead>
                        <tr>
                            <th>Member</th>
                            <th>Current Streak</th>
                            <th>Best Streak</th>
                            <th>Badges Earned</th>
                            <th>Last Attendance</th>
                        </tr>
                    </thead>
                    <tbody id="all-streaks-body"></tbody>
                </table>
            </div>
        </section>

        <section id="newcomer-section" style="border-left: 4px solid #e74c3c;">
            <h2><i class="fas fa-user-plus"></i> Newcomer Tracking & 90-in-90</h2>
            <p class="mb-4">Track newcomers' progress toward their first 90 meetings in 90 days. Support their recovery journey!</p>

            <div class="box mb-4" style="background: #e74c3c; color: white; padding: 1rem;">
                <h3><i class="fas fa-info-circle"></i> What is 90-in-90?</h3>
                <p style="margin-top: 0.5rem;">
                    A suggestion for newcomers to attend 90 AA meetings in 90 days. This helps build the foundation of recovery,
                    develop a support network, and make sobriety a daily priority.
                </p>
            </div>

            <h3 class="mb-2">Active Newcomers</h3>
            <div id="newcomers-list" class="grid grid-cols-2 mb-4"></div>

            <div class="box">
                <h3>Log Meeting Attendance</h3>
                <p class="mb-2" style="font-size: 0.9rem;">Select a newcomer and log their meeting attendance.</p>
                <div class="form-group">
                    <label for="newcomer-select">Select Newcomer</label>
                    <select id="newcomer-select" style="width: 100%; padding: 0.5rem; border: 1px solid #7f8c8d; border-radius: 4px; background: #34495e; color: #ecf0f1; min-height: 44px;">
                        <option value="">-- Select a newcomer --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="meeting-date">Meeting Date</label>
                    <input type="date" id="meeting-date" style="width: 100%;" />
                </div>
                <button class="btn" onclick="logNewcomerAttendance()"><i class="fas fa-check"></i> Log Attendance</button>
            </div>

            <div class="box" style="margin-top: 1rem;">
                <h3>Newcomer Attendance History</h3>
                <div class="form-group">
                    <label for="history-newcomer-select">View History For:</label>
                    <select id="history-newcomer-select" onchange="showNewcomerHistory()" style="width: 100%; padding: 0.5rem; border: 1px solid #7f8c8d; border-radius: 4px; background: #34495e; color: #ecf0f1; min-height: 44px;">
                        <option value="">-- Select a newcomer --</option>
                    </select>
                </div>
                <div id="newcomer-history-display"></div>
            </div>
        </section>
        <section id="sponsors-section" style="border-left: 4px solid #9b59b6;">
            <h2><i class="fas fa-hands-helping"></i> Available Sponsors</h2>
            <p class="mb-4">Find a sponsor from our Home Group. Sponsorship is a key part of AA recovery. Remember: sponsors are suggested to be the same gender as the sponsee.</p>

            <div class="box mb-4" style="background: #9b59b6; color: white; padding: 1rem;">
                <h3><i class="fas fa-info-circle"></i> About Sponsorship</h3>
                <p style="margin-top: 0.5rem;">
                    A sponsor is an AA member who has made progress in the recovery program and shares that experience with another member.
                    They guide you through the Twelve Steps, provide support, and help you navigate the challenges of sobriety.
                </p>
            </div>

            <div class="box mb-4">
                <h3>Filter Sponsors</h3>
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="filter-sponsor-gender">Gender</label>
                        <select id="filter-sponsor-gender" onchange="updateAvailableSponsors()" style="width: 100%; padding: 0.5rem; border: 1px solid #7f8c8d; border-radius: 4px; background: #34495e; color: #ecf0f1; min-height: 44px;">
                            <option value="">All</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="non-binary">Non-binary</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filter-min-years">Minimum Years Sober</label>
                        <input type="number" id="filter-min-years" min="0" value="1" onchange="updateAvailableSponsors()" style="width: 100%; padding: 0.5rem; border: 1px solid #7f8c8d; border-radius: 4px; background: #34495e; color: #ecf0f1;" />
                    </div>
                </div>
            </div>

            <h3 class="mb-2">Available Sponsors (<span id="sponsor-count">0</span>)</h3>
            <div id="sponsors-list" class="grid grid-cols-2"></div>

            <div class="box" style="margin-top: 1.5rem; background: #34495e; border-left: 4px solid #9b59b6;">
                <p style="font-size: 0.9rem; color: #ecf0f1;">
                    <strong>Note:</strong> To make yourself available as a sponsor, edit your member profile in the "Birthdays & Anniversaries" section
                    and check "Available to sponsor?" in the Sponsorship Availability section.
                </p>
            </div>
        </section>
        <section id="topic-suggestions-section" style="border-left: 4px solid #16a085;">
            <h2><i class="fas fa-lightbulb"></i> Topic Suggestions</h2>
            <p class="mb-4">Suggest discussion topics for upcoming meetings. The group can vote on suggested topics.</p>

            <div class="box mb-4">
                <h3>Submit a Topic Suggestion</h3>
                <div class="form-group">
                    <label for="topic-title">Topic Title*</label>
                    <input type="text" id="topic-title" placeholder="e.g., Dealing with Resentments" />
                </div>
                <div class="form-group">
                    <label for="topic-description">Description (Optional)</label>
                    <textarea id="topic-description" rows="3" placeholder="Why this topic would be helpful..."></textarea>
                </div>
                <div class="form-group">
                    <label for="topic-category">Category</label>
                    <select id="topic-category" style="width: 100%; padding: 0.5rem; border: 1px solid #7f8c8d; border-radius: 4px; background: #34495e; color: #ecf0f1; min-height: 44px;">
                        <option value="steps">Steps</option>
                        <option value="traditions">Traditions</option>
                        <option value="big-book">Big Book</option>
                        <option value="recovery">Recovery Topic</option>
                        <option value="sponsorship">Sponsorship</option>
                        <option value="service">Service</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <button class="btn" onclick="submitTopicSuggestion()"><i class="fas fa-paper-plane"></i> Submit Suggestion</button>
            </div>

            <h3 class="mb-2">Suggested Topics</h3>
            <div id="topics-list"></div>
        </section>
        <section id="call-roster-section" style="border-left: 4px solid #c0392b;">
            <h2><i class="fas fa-phone-volume"></i> 12-Step Call Roster</h2>
            <p class="mb-4">Members available for emergency 12-step calls. Available 24/7 to help those struggling with sobriety.</p>

            <div class="box mb-4" style="background: #c0392b; color: white; padding: 1rem;">
                <h3><i class="fas fa-info-circle"></i> What is a 12-Step Call?</h3>
                <p style="margin-top: 0.5rem;">
                    A 12-step call is when an AA member reaches out to help someone who is suffering from alcoholism -
                    whether they're new to the program, contemplating sobriety, or experiencing a crisis. It's one of the most
                    important services we provide.
                </p>
            </div>

            <div class="box mb-4">
                <h3>Update Your Availability</h3>
                <p class="mb-2" style="font-size: 0.9rem;">Check the box to make yourself available for 12-step calls.</p>
                <div class="form-group" style="display: flex; align-items: center; gap: 1rem;">
                    <input type="checkbox" id="call-available" style="width: auto;" onchange="updateCallRosterAvailability()"/>
                    <label for="call-available">I am available for 12-step calls</label>
                </div>
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                    <div class="form-group">
                        <label for="call-time-preference">Time Availability</label>
                        <select id="call-time-preference" style="width: 100%; padding: 0.5rem; border: 1px solid #7f8c8d; border-radius: 4px; background: #34495e; color: #ecf0f1; min-height: 44px;">
                            <option value="anytime">Anytime (24/7)</option>
                            <option value="daytime">Daytime only (8am-8pm)</option>
                            <option value="evening">Evening only (6pm-12am)</option>
                            <option value="weekends">Weekends only</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="call-preferred-contact">Preferred Contact Method</label>
                        <select id="call-preferred-contact" style="width: 100%; padding: 0.5rem; border: 1px solid #7f8c8d; border-radius: 4px; background: #34495e; color: #ecf0f1; min-height: 44px;">
                            <option value="phone">Phone Call</option>
                            <option value="text">Text Message</option>
                            <option value="both">Either</option>
                        </select>
                    </div>
                </div>
                <button class="btn" onclick="saveCallRosterPreferences()" style="margin-top: 1rem;"><i class="fas fa-save"></i> Save Preferences</button>
            </div>

            <h3 class="mb-2">Available for 12-Step Calls (<span id="call-roster-count">0</span>)</h3>
            <div id="call-roster-list" class="grid grid-cols-2"></div>
        </section>
        <section id="daily-reflections-section" style="border-left: 4px solid #8e44ad;">
            <h2><i class="fas fa-book-reader"></i> Daily Reflections</h2>
            <p class="mb-4">Daily readings and reflections for recovery. Take a moment each day for spiritual growth.</p>

            <div class="box mb-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem;">
                <h3 id="daily-reflection-date" style="color: white; margin-bottom: 1rem;"></h3>
                <div id="daily-reflection-content"></div>
            </div>

            <div class="box">
                <h3>Personal Reflection Notes</h3>
                <p style="font-size: 0.9rem; color: #95a5a6; margin-bottom: 1rem;">Write your thoughts about today's reading. Your notes are private and saved locally.</p>
                <textarea id="reflection-notes" rows="4" placeholder="What does this mean to me today? How can I apply this to my recovery?"></textarea>
                <button class="btn" onclick="saveReflectionNotes()" style="margin-top: 1rem;"><i class="fas fa-save"></i> Save Notes</button>
                <button class="btn secondary" onclick="viewReflectionHistory()" style="margin-top: 1rem; margin-left: 0.5rem;"><i class="fas fa-history"></i> View Past Reflections</button>
            </div>
        </section>
        <section id="step-tracker-section" style="border-left: 4px solid #2980b9;">
            <h2><i class="fas fa-shoe-prints"></i> Step Work Progress Tracker</h2>
            <p class="mb-4">Track your journey through the Twelve Steps of AA. Work with your sponsor to progress through recovery.</p>

            <div class="box mb-4" style="background: #2980b9; color: white; padding: 1rem;">
                <p style="margin: 0;">
                    <i class="fas fa-info-circle"></i> The Twelve Steps are the foundation of AA recovery. This tracker helps you
                    monitor your progress and identify where to focus your work with your sponsor.
                </p>
            </div>

            <div id="step-progress-display" class="mb-4"></div>

            <div class="box">
                <h3>Update Step Progress</h3>
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="step-select">Select Step</label>
                        <select id="step-select" style="width: 100%; padding: 0.5rem; border: 1px solid #7f8c8d; border-radius: 4px; background: #34495e; color: #ecf0f1; min-height: 44px;">
                            <option value="1">Step 1: Admitted powerlessness</option>
                            <option value="2">Step 2: Came to believe</option>
                            <option value="3">Step 3: Made a decision</option>
                            <option value="4">Step 4: Moral inventory</option>
                            <option value="5">Step 5: Admitted wrongs</option>
                            <option value="6">Step 6: Ready to remove defects</option>
                            <option value="7">Step 7: Asked God to remove defects</option>
                            <option value="8">Step 8: Made a list</option>
                            <option value="9">Step 9: Made amends</option>
                            <option value="10">Step 10: Continued inventory</option>
                            <option value="11">Step 11: Prayer and meditation</option>
                            <option value="12">Step 12: Spiritual awakening</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="step-status">Status</label>
                        <select id="step-status" style="width: 100%; padding: 0.5rem; border: 1px solid #7f8c8d; border-radius: 4px; background: #34495e; color: #ecf0f1; min-height: 44px;">
                            <option value="not-started">Not Started</option>
                            <option value="in-progress">In Progress</option>
                            <option value="completed">Completed</option>
                            <option value="practicing">Practicing Daily</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="step-notes">Notes (Optional)</label>
                    <textarea id="step-notes" rows="3" placeholder="Insights, challenges, or progress notes..."></textarea>
                </div>
                <button class="btn" onclick="updateStepProgress()"><i class="fas fa-check"></i> Update Progress</button>
            </div>
        </section>
        <section id="service-opportunities-section" style="border-left: 4px solid #27ae60;">
            <h2><i class="fas fa-hands-helping"></i> Service Opportunities Board</h2>
            <p class="mb-4">Non-position service work needed in the group. Service keeps us sober and helps the group thrive!</p>

            <div class="box mb-4">
                <h3>Post a Service Opportunity</h3>
                <div class="grid" style="grid-template-columns: 2fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="service-task">Service Task*</label>
                        <input type="text" id="service-task" placeholder="e.g., Set up chairs for meeting" />
                    </div>
                    <div class="form-group">
                        <label for="service-date">Date Needed</label>
                        <input type="date" id="service-date" />
                    </div>
                </div>
                <div class="form-group">
                    <label for="service-description">Description</label>
                    <textarea id="service-description" rows="2" placeholder="Additional details..."></textarea>
                </div>
                <button class="btn" onclick="postServiceOpportunity()"><i class="fas fa-plus"></i> Post Opportunity</button>
            </div>

            <h3 class="mb-2">Available Service Opportunities</h3>
            <div id="service-opportunities-list"></div>
        </section>
        <section id="temperature-check-section" style="border-left: 4px solid #e67e22;">
            <h2><i class="fas fa-thermometer-half"></i> Group Temperature Check</h2>
            <p class="mb-4">Anonymous survey to assess group health and unity. Your honest feedback helps improve the group.</p>

            <div class="box mb-4" style="background: #e67e22; color: white; padding: 1rem;">
                <p style="margin: 0;">
                    <i class="fas fa-user-secret"></i> <strong>100% Anonymous:</strong> Responses are not linked to your identity.
                    Be honest to help the group grow.
                </p>
            </div>

            <div class="box mb-4">
                <h3>Complete Temperature Check</h3>
                <div class="form-group">
                    <label>How would you rate the overall health of the group?</label>
                    <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="radio" name="overall-health" value="5" style="width: auto;"/> Excellent
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="radio" name="overall-health" value="4" style="width: auto;"/> Good
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="radio" name="overall-health" value="3" style="width: auto;"/> Fair
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="radio" name="overall-health" value="2" style="width: auto;"/> Poor
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="radio" name="overall-health" value="1" style="width: auto;"/> Very Poor
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label>I feel welcome and valued in this group</label>
                    <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="radio" name="feel-welcome" value="5" style="width: auto;"/> Strongly Agree
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="radio" name="feel-welcome" value="4" style="width: auto;"/> Agree
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="radio" name="feel-welcome" value="3" style="width: auto;"/> Neutral
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="radio" name="feel-welcome" value="2" style="width: auto;"/> Disagree
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="radio" name="feel-welcome" value="1" style="width: auto;"/> Strongly Disagree
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label>The group follows AA Traditions</label>
                    <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="radio" name="follows-traditions" value="5" style="width: auto;"/> Always
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="radio" name="follows-traditions" value="4" style="width: auto;"/> Usually
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="radio" name="follows-traditions" value="3" style="width: auto;"/> Sometimes
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="radio" name="follows-traditions" value="2" style="width: auto;"/> Rarely
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="radio" name="follows-traditions" value="1" style="width: auto;"/> Never
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Additional Comments (Optional)</label>
                    <textarea id="temp-check-comments" rows="3" placeholder="What could improve? What's working well?"></textarea>
                </div>
                <button class="btn" onclick="submitTemperatureCheck()"><i class="fas fa-paper-plane"></i> Submit Anonymously</button>
            </div>

            <div class="box">
                <h3>Group Temperature Results</h3>
                <p style="font-size: 0.9rem; color: #95a5a6; margin-bottom: 1rem;">Survey responses: <span id="temp-check-count">0</span></p>
                <div id="temperature-results"></div>
            </div>
        </section>
        <section id="group-vision-section" style="border-left: 4px solid #34495e;">
            <h2><i class="fas fa-mountain"></i> Group Vision Statement</h2>
            <p class="mb-4">Define your Home Group's mission, vision, and values. What makes your group unique?</p>

            <div class="box mb-4">
                <h3>Our Group Vision</h3>
                <div id="vision-display" style="min-height: 100px; padding: 1rem; background: #2c3e50; border-radius: 4px; margin-top: 1rem;"></div>
                <button class="btn" onclick="editGroupVision()" style="margin-top: 1rem;"><i class="fas fa-edit"></i> Edit Vision Statement</button>
            </div>

            <div id="vision-editor" class="box" style="display: none;">
                <h3>Edit Vision Statement</h3>
                <div class="form-group">
                    <label for="vision-mission">Mission Statement</label>
                    <textarea id="vision-mission" rows="3" placeholder="What is our group's primary purpose?"></textarea>
                </div>
                <div class="form-group">
                    <label for="vision-values">Core Values</label>
                    <textarea id="vision-values" rows="3" placeholder="What principles guide our group?"></textarea>
                </div>
                <div class="form-group">
                    <label for="vision-goals">Group Goals</label>
                    <textarea id="vision-goals" rows="3" placeholder="What do we hope to achieve?"></textarea>
                </div>
                <button class="btn" onclick="saveGroupVision()"><i class="fas fa-save"></i> Save Vision</button>
                <button class="btn secondary" onclick="cancelGroupVision()" style="margin-left: 0.5rem;">Cancel</button>
            </div>
        </section>

        <section id="member-wellness-section" style="border-left: 4px solid #27ae60;">
            <h2><i class="fas fa-heartbeat"></i> Member Wellness Check</h2>
            <p class="mb-4">Track member attendance and flag members who haven't been seen recently.</p>
            <button class="btn mb-3" onclick="exportMemberDirectoryPDF()" style="background: #27ae60;">
                <i class="fas fa-file-pdf"></i> Export Member Directory to PDF
            </button>

            <div class="box mb-4">
                <h3>Recent Attendance Summary</h3>
                <div id="wellness-summary" class="grid grid-cols-2" style="margin-top: 1rem;">
                </div>
            </div>

            <div class="box">
                <h3>Members Not Seen Recently</h3>
                <p style="font-size: 0.9rem; color: #95a5a6; margin-bottom: 1rem;">Members who haven't attended in the last 30 days</p>
                <table id="absent-members-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Last Seen</th>
                            <th>Days Absent</th>
                            <th>Contact</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="absent-members-body"></tbody>
                </table>
            </div>
        </section>

        <section id="sponsor-matching-section" style="border-left: 4px solid #8e44ad;">
            <h2><i class="fas fa-user-friends"></i> Temporary Sponsor Matching</h2>
            <p class="mb-4">Quick sponsor matching for newcomers until they find a permanent sponsor.</p>

            <div class="box mb-4">
                <h3>Request Temporary Sponsor</h3>
                <div class="form-group">
                    <label for="temp-sponsor-newcomer">Newcomer Name</label>
                    <select id="temp-sponsor-newcomer">
                        <option value="">Select newcomer...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="temp-sponsor-gender-pref">Gender Preference</label>
                    <select id="temp-sponsor-gender-pref">
                        <option value="">No preference</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="non-binary">Non-binary</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="temp-sponsor-duration">Estimated Duration (days)</label>
                    <input type="number" id="temp-sponsor-duration" value="30" min="7" max="90" />
                </div>
                <button class="btn" onclick="requestTemporarySponsor()"><i class="fas fa-handshake"></i> Find Temporary Sponsor</button>
            </div>

            <div class="box">
                <h3>Active Temporary Sponsorships</h3>
                <div id="temp-sponsor-list"></div>
            </div>
        </section>

        <section id="emergency-contacts-section" style="border-left: 4px solid #e74c3c;">
            <h2><i class="fas fa-phone-alt"></i> Emergency Contact Network</h2>
            <p class="mb-4">Tiered emergency contact system for members in crisis.</p>

            <div class="box mb-4">
                <h3>Emergency Contact Tiers</h3>
                <p style="font-size: 0.9rem; color: #95a5a6; margin-bottom: 1rem;">
                    Tier 1: First responders (call first) | Tier 2: Secondary contacts | Tier 3: General support
                </p>

                <div class="form-group">
                    <label for="emergency-contact-member">Select Member</label>
                    <select id="emergency-contact-member">
                        <option value="">Select member...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="emergency-contact-tier">Contact Tier</label>
                    <select id="emergency-contact-tier">
                        <option value="1">Tier 1 - First Responder (available 24/7)</option>
                        <option value="2">Tier 2 - Secondary Contact</option>
                        <option value="3">Tier 3 - General Support</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="emergency-contact-available-24-7" />
                        Available 24/7 for emergency calls
                    </label>
                </div>
                <button class="btn" onclick="saveEmergencyContact()"><i class="fas fa-plus"></i> Add to Emergency Network</button>
            </div>

            <div class="box">
                <h3>Emergency Contact Directory</h3>
                <div id="emergency-contact-tiers">
                    <div class="mb-4">
                        <h4 style="color: #e74c3c;"><i class="fas fa-star"></i> Tier 1 - First Responders</h4>
                        <div id="tier-1-contacts"></div>
                    </div>
                    <div class="mb-4">
                        <h4 style="color: #f39c12;"><i class="fas fa-star-half-alt"></i> Tier 2 - Secondary Contacts</h4>
                        <div id="tier-2-contacts"></div>
                    </div>
                    <div class="mb-4">
                        <h4 style="color: #3498db;"><i class="far fa-star"></i> Tier 3 - General Support</h4>
                        <div id="tier-3-contacts"></div>
                    </div>
                </div>
            </div>
        </section>

        <section id="problem-box-section" style="border-left: 4px solid #95a5a6;">
            <h2><i class="fas fa-box"></i> Problem Box</h2>
            <p class="mb-4">Anonymous suggestions and concerns for group improvement.</p>

            <div class="box mb-4">
                <h3>Submit Anonymous Suggestion</h3>
                <div class="form-group">
                    <label for="problem-box-category">Category</label>
                    <select id="problem-box-category">
                        <option value="meeting-format">Meeting Format</option>
                        <option value="fellowship">Fellowship</option>
                        <option value="service">Service Structure</option>
                        <option value="facility">Facility/Location</option>
                        <option value="traditions">Traditions Concern</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="problem-box-text">Suggestion or Concern</label>
                    <textarea id="problem-box-text" rows="4" placeholder="Your anonymous feedback..."></textarea>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="problem-box-urgent" />
                        Mark as urgent (requires immediate attention)
                    </label>
                </div>
                <button class="btn" onclick="submitProblemBoxItem()"><i class="fas fa-paper-plane"></i> Submit Anonymously</button>
            </div>

            <div class="box">
                <h3>Submitted Items</h3>
                <p style="font-size: 0.9rem; color: #95a5a6; margin-bottom: 1rem;">
                    These items will be reviewed at the next Group Conscience meeting.
                </p>
                <div id="problem-box-items"></div>
            </div>
        </section>

        <section id="satisfaction-survey-section" style="border-left: 4px solid #16a085;">
            <h2><i class="fas fa-poll"></i> Member Satisfaction Survey</h2>
            <p class="mb-4">Regular pulse checks on member satisfaction and group health.</p>

            <div class="box mb-4">
                <h3>Take Survey</h3>
                <p style="font-size: 0.9rem; color: #95a5a6; margin-bottom: 1rem;">
                    Your responses are anonymous and help improve our group.
                </p>

                <div class="form-group">
                    <label>How satisfied are you with our meeting formats?</label>
                    <select id="survey-meeting-satisfaction">
                        <option value="">Select...</option>
                        <option value="5">Very Satisfied</option>
                        <option value="4">Satisfied</option>
                        <option value="3">Neutral</option>
                        <option value="2">Dissatisfied</option>
                        <option value="1">Very Dissatisfied</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>How would you rate the fellowship atmosphere?</label>
                    <select id="survey-fellowship-rating">
                        <option value="">Select...</option>
                        <option value="5">Excellent</option>
                        <option value="4">Good</option>
                        <option value="3">Average</option>
                        <option value="2">Poor</option>
                        <option value="1">Very Poor</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Do you feel heard at Group Conscience meetings?</label>
                    <select id="survey-gc-participation">
                        <option value="">Select...</option>
                        <option value="5">Always</option>
                        <option value="4">Usually</option>
                        <option value="3">Sometimes</option>
                        <option value="2">Rarely</option>
                        <option value="1">Never</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Are newcomers welcomed effectively?</label>
                    <select id="survey-newcomer-welcome">
                        <option value="">Select...</option>
                        <option value="5">Very Effectively</option>
                        <option value="4">Effectively</option>
                        <option value="3">Adequately</option>
                        <option value="2">Poorly</option>
                        <option value="1">Very Poorly</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Additional Comments (Optional)</label>
                    <textarea id="survey-comments" rows="3" placeholder="Any additional feedback..."></textarea>
                </div>

                <button class="btn" onclick="submitSatisfactionSurvey()"><i class="fas fa-paper-plane"></i> Submit Survey</button>
            </div>

            <div class="box">
                <h3>Survey Results</h3>
                <p style="font-size: 0.9rem; color: #95a5a6; margin-bottom: 1rem;">
                    Total responses: <span id="survey-response-count">0</span>
                </p>
                <div id="survey-results"></div>
            </div>
        </section>

        <section id="announcements-section" style="border-left: 4px solid #f39c12;">
            <h2><i class="fas fa-bullhorn"></i> Announcements</h2>
            <div class="form-group">
                <label for="announcement-text">Announcement</label>
                <textarea id="announcement-text" rows="2" placeholder="Enter announcement..."></textarea>
            </div>
            <div class="form-group">
                <label for="announcement-priority">Priority Level</label>
                <select id="announcement-priority">
                    <option value="info">Info</option>
                    <option value="normal">Normal</option>
                    <option value="urgent">Urgent</option>
                </select>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="announcement-require-read-receipt" />
                    Require read receipt (for important announcements)
                </label>
            </div>
            <button class="btn" onclick="addAnnouncement()">Add Announcement</button>
            <h3 class="mt-4">Current Announcements</h3>
            <ul id="announcements-list"></ul>
        </section>
        <section id="messaging-section" style="border-left: 4px solid #f39c12;">
            <h2><i class="fas fa-comments"></i> Member Messaging</h2>
            <p>Send messages to other members for service work coordination.</p>
            <div class="form-group">
                <label for="message-recipient">Send to:</label>
                <select id="message-recipient">
                    <option value="">Select a member...</option>
                </select>
            </div>
            <div class="form-group">
                <label for="message-subject">Subject</label>
                <input type="text" id="message-subject" placeholder="Message subject..." />
            </div>
            <div class="form-group">
                <label for="message-text">Message</label>
                <textarea id="message-text" rows="4" placeholder="Your message..."></textarea>
            </div>
            <button class="btn" onclick="sendMessage()">Send Message</button>
            <h3 class="mt-4">Messages</h3>
            <div class="history-nav">
                <button onclick="showMessages('inbox')" class="active" id="inbox-btn">Inbox</button>
                <button onclick="showMessages('sent')" id="sent-btn">Sent</button>
            </div>
            <div id="messages-container"></div>
        </section>
        <section id="service-positions-section" style="border-left: 4px solid #2ecc71;">
            <h2><i class="fas fa-users-cog"></i> Service Position Management</h2>
            <button class="btn mb-3" onclick="exportServicePositionsPDF()" style="background: #2ecc71;">
                <i class="fas fa-file-pdf"></i> Export Positions to PDF
            </button>
            <h3>Add/Edit Service Position</h3>
            <div class="form-group">
                <label for="position-name">Position Name</label>
                <input type="text" id="position-name" placeholder="e.g., Chairperson, Secretary, Treasurer..." />
            </div>
            <div class="form-group">
                <label for="position-description">Description & Responsibilities</label>
                <textarea id="position-description" rows="4" placeholder="Enter position responsibilities..."></textarea>
            </div>
            <div class="form-group">
                <label for="position-term-length">Term Length (months)</label>
                <input type="number" id="position-term-length" placeholder="6" min="1" />
            </div>
            <div class="form-group">
                <label for="position-current-holder">Current Holder</label>
                <select id="position-current-holder">
                    <option value="">Vacant</option>
                </select>
            </div>
            <div class="form-group">
                <label for="position-start-date">Term Start Date</label>
                <input type="date" id="position-start-date" />
            </div>
            <button class="btn" onclick="addServicePosition()">Add Position</button>
            <h3 class="mt-4">Current Service Positions</h3>
            <table>
                <thead>
                    <tr>
                        <th>Position</th>
                        <th>Current Holder</th>
                        <th>Term Start</th>
                        <th>Term End</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="service-positions-table"></tbody>
            </table>
            <h3 class="mt-4">Rotation Calendar</h3>
            <p>Upcoming position elections (positions coming up in next 60 days)</p>
            <div id="rotation-calendar"></div>
            <h3 class="mt-4">Nomination System</h3>
            <div class="form-group">
                <label for="nomination-position">Position</label>
                <select id="nomination-position">
                    <option value="">Select position...</option>
                </select>
            </div>
            <div class="form-group">
                <label for="nomination-nominee">Nominee</label>
                <select id="nomination-nominee">
                    <option value="">Select member...</option>
                </select>
            </div>
            <button class="btn" onclick="addNomination()">Submit Nomination</button>
            <h3 class="mt-4">Current Nominations</h3>
            <div id="nominations-list"></div>
        </section>
        <section id="finance-section" style="border-left: 4px solid #f1c40f;">
            <h2><i class="fas fa-money-bill-wave"></i> Financial Tracking</h2>
            <button class="btn mb-3" onclick="exportFinancialAnalyticsPDF()" style="background: #f1c40f;">
                <i class="fas fa-file-pdf"></i> Export Financial Analytics to PDF
            </button>
            <div class="history-nav">
                <button onclick="showFinanceTab('budget')" class="active" id="budget-tab">Budget</button>
                <button onclick="showFinanceTab('expenses')" id="expenses-tab">Expenses</button>
                <button onclick="showFinanceTab('reports')" id="reports-tab">Reports</button>
            </div>
            <div id="budget-content" class="finance-tab active">
                <h3>Budget Management</h3>
                <div class="form-group">
                    <label for="budget-category">Category</label>
                    <input type="text" id="budget-category" placeholder="e.g., Rent, Literature, Refreshments..." />
                </div>
                <div class="form-group">
                    <label for="budget-amount">Monthly Budget Amount</label>
                    <input type="number" id="budget-amount" placeholder="0.00" step="0.01" min="0" />
                </div>
                <button class="btn" onclick="addBudgetCategory()">Add Budget Category</button>
                <h3 class="mt-4">Current Budget</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Monthly Budget</th>
                            <th>Spent This Month</th>
                            <th>Remaining</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="budget-table"></tbody>
                </table>
            </div>
            <div id="expenses-content" class="finance-tab">
                <h3>Log Expense</h3>
                <div class="form-group">
                    <label for="expense-date">Date</label>
                    <input type="date" id="expense-date" />
                </div>
                <div class="form-group">
                    <label for="expense-category">Category</label>
                    <select id="expense-category">
                        <option value="">Select category...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="expense-description">Description</label>
                    <input type="text" id="expense-description" placeholder="What was purchased..." />
                </div>
                <div class="form-group">
                    <label for="expense-amount">Amount</label>
                    <input type="number" id="expense-amount" placeholder="0.00" step="0.01" min="0" />
                </div>
                <button class="btn" onclick="addExpense()">Log Expense</button>
                <h3 class="mt-4">Recent Expenses</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Category</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="expenses-table"></tbody>
                </table>
            </div>
            <div id="reports-content" class="finance-tab">
                <h3>Financial Reports</h3>
                <div class="form-group">
                    <label for="report-month">Select Month</label>
                    <input type="month" id="report-month" />
                </div>
                <button class="btn" onclick="generateMonthlyReport()">Generate Report</button>
                <div class="box mt-4" style="background: #34495e; padding: 1rem; border-left: 4px solid #3498db;">
                    <h4 style="color: #3498db; margin: 0 0 0.5rem 0;">📋 Monthly Treasurer Report</h4>
                    <p style="color: #ecf0f1; font-size: 0.9rem; margin: 0 0 1rem 0;">
                        Generate comprehensive treasurer reports with budget analysis and prudent reserve status
                    </p>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn" onclick="displayTreasurerReport()" style="background: #3498db;">
                            <i class="fas fa-file-alt"></i> View Report
                        </button>
                        <button class="btn" onclick="exportTreasurerReportPDF()" style="background: #2ecc71;">
                            <i class="fas fa-file-pdf"></i> Export PDF
                        </button>
                    </div>
                </div>
                <div id="monthly-report" class="box mt-4"></div>
                <h3 class="mt-4">Year-over-Year Comparison</h3>
                <div id="yoy-chart" class="box"></div>
            </div>
        </section>

        <section id="contribution-comparison-section" style="border-left: 4px solid #27ae60;">
            <h2><i class="fas fa-chart-bar"></i> Contribution Comparison</h2>
            <p class="mb-4">Year-over-year contribution analysis.</p>
            <div class="box mb-4">
                <h3>Comparison Chart</h3>
                <canvas id="contribution-comparison-chart" style="max-height: 300px;"></canvas>
            </div>
            <div class="box">
                <h3>Statistics</h3>
                <div id="contribution-stats"></div>
            </div>
        </section>

        <section id="expense-approval-section" style="border-left: 4px solid #e67e22;">
            <h2><i class="fas fa-check-circle"></i> Expense Approval Workflow</h2>
            <p class="mb-4">Approval system for large expenses.</p>
            <div class="box mb-4">
                <h3>Submit Expense for Approval</h3>
                <div class="form-group">
                    <label for="approval-amount">Amount</label>
                    <input type="number" id="approval-amount" step="0.01" />
                </div>
                <div class="form-group">
                    <label for="approval-purpose">Purpose</label>
                    <textarea id="approval-purpose" rows="2"></textarea>
                </div>
                <button class="btn" onclick="submitExpenseApproval()"><i class="fas fa-paper-plane"></i> Submit</button>
            </div>
            <div class="box"><h3>Pending Approvals</h3><div id="pending-approvals"></div></div>
        </section>

        <section id="bill-reminders-section" style="border-left: 4px solid #c0392b;">
            <h2><i class="fas fa-calendar-check"></i> Bill Payment Reminders</h2>
            <div class="box mb-4">
                <h3>Add Recurring Bill</h3>
                <div class="form-group">
                    <label for="bill-name">Bill Name</label>
                    <input type="text" id="bill-name" placeholder="e.g., Rent, Utilities" />
                </div>
                <div class="form-group">
                    <label for="bill-amount">Amount</label>
                    <input type="number" id="bill-amount" step="0.01" />
                </div>
                <div class="form-group">
                    <label for="bill-due">Due Day of Month</label>
                    <input type="number" id="bill-due" min="1" max="31" />
                </div>
                <button class="btn" onclick="addBillReminder()"><i class="fas fa-plus"></i> Add Bill</button>
            </div>
            <div class="box"><h3>Upcoming Bills</h3><div id="upcoming-bills"></div></div>
        </section>

        <section id="contribution-calculator-section" style="border-left: 4px solid #16a085;">
            <h2><i class="fas fa-calculator"></i> Group Contribution Calculator</h2>
            <div class="box mb-4">
                <h3>Calculate Suggested Contribution</h3>
                <div class="form-group">
                    <label for="calc-attendees">Average Weekly Attendees</label>
                    <input type="number" id="calc-attendees" min="1" />
                </div>
                <div class="form-group">
                    <label for="calc-expenses">Monthly Expenses</label>
                    <input type="number" id="calc-expenses" step="0.01" />
                </div>
                <button class="btn" onclick="calculateSuggestedContribution()"><i class="fas fa-calculator"></i> Calculate</button>
            </div>
            <div class="box"><h3>Result</h3><div id="contribution-result"></div></div>
        </section>

        <section id="financial-goals-section" style="border-left: 4px solid #8e44ad;">
            <h2><i class="fas fa-bullseye"></i> Financial Goals Tracker</h2>
            <div class="box mb-4">
                <h3>Create Goal</h3>
                <div class="form-group">
                    <label for="goal-name">Goal Name</label>
                    <input type="text" id="goal-name" placeholder="e.g., Build Prudent Reserve" />
                </div>
                <div class="form-group">
                    <label for="goal-target">Target Amount</label>
                    <input type="number" id="goal-target" step="0.01" />
                </div>
                <div class="form-group">
                    <label for="goal-deadline">Target Date</label>
                    <input type="date" id="goal-deadline" />
                </div>
                <button class="btn" onclick="createFinancialGoal()"><i class="fas fa-plus"></i> Create Goal</button>
            </div>
            <div class="box"><h3>Active Goals</h3><div id="financial-goals-list"></div></div>
        </section>

        <section id="expense-receipts-section" style="border-left: 4px solid #d35400;">
            <h2><i class="fas fa-receipt"></i> Expense Receipt Upload</h2>
            <div class="box mb-4">
                <h3>Upload Receipt</h3>
                <div class="form-group">
                    <label for="receipt-file">Receipt Image</label>
                    <input type="file" id="receipt-file" accept="image/*" />
                </div>
                <div class="form-group">
                    <label for="receipt-amount">Amount</label>
                    <input type="number" id="receipt-amount" step="0.01" />
                </div>
                <div class="form-group">
                    <label for="receipt-desc">Description</label>
                    <input type="text" id="receipt-desc" />
                </div>
                <button class="btn" onclick="uploadReceipt()"><i class="fas fa-upload"></i> Upload</button>
            </div>
            <div class="box"><h3>Receipts</h3><div id="receipts-list"></div></div>
        </section>

        <section id="quarterly-reports-section" style="border-left: 4px solid #2980b9;">
            <h2><i class="fas fa-chart-pie"></i> Quarterly Financial Reports</h2>
            <button class="btn mb-3" onclick="exportQuarterlyReportPDF()" style="background: #2980b9;">
                <i class="fas fa-file-pdf"></i> Export Quarterly Report to PDF
            </button>
            <div class="box mb-4">
                <h3>Generate Quarterly Report</h3>
                <div class="form-group">
                    <label for="quarter-select">Select Quarter</label>
                    <select id="quarter-select">
                        <option>Q1 (Jan-Mar)</option>
                        <option>Q2 (Apr-Jun)</option>
                        <option>Q3 (Jul-Sep)</option>
                        <option>Q4 (Oct-Dec)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="quarter-year">Year</label>
                    <input type="number" id="quarter-year" value="2025" />
                </div>
                <button class="btn" onclick="generateQuarterlyReport()"><i class="fas fa-file-alt"></i> Generate</button>
            </div>
            <div class="box"><div id="quarterly-report-output"></div></div>
        </section>

        <section id="sponsorship-tree-section" style="border-left: 4px solid #1abc9c;">
            <h2><i class="fas fa-sitemap"></i> Sponsorship Tree Visualization</h2>
            <p class="mb-4">Visual representation of sponsorship relationships.</p>
            <button class="btn mb-3" onclick="exportSponsorshipReportPDF()" style="background: #1abc9c;">
                <i class="fas fa-file-pdf"></i> Export Sponsorship Report to PDF
            </button>
            <div class="box mb-4">
                <button class="btn" onclick="generateSponsorshipTree()"><i class="fas fa-project-diagram"></i> Generate Tree</button>
            </div>
            <div class="box">
                <div id="sponsorship-tree-display"></div>
            </div>
        </section>

        <section id="hi-commitments-section" style="border-left: 4px solid #34495e;">
            <h2><i class="fas fa-hospital"></i> H&I Commitments</h2>
            <p class="mb-4">Track Hospitals & Institutions service commitments.</p>
            <div class="box mb-4">
                <h3>Add H&I Commitment</h3>
                <div class="form-group">
                    <label for="hi-member">Member</label>
                    <select id="hi-member"></select>
                </div>
                <div class="form-group">
                    <label for="hi-facility">Facility</label>
                    <input type="text" id="hi-facility" placeholder="e.g., County Jail, Hospital" />
                </div>
                <div class="form-group">
                    <label for="hi-frequency">Frequency</label>
                    <select id="hi-frequency">
                        <option>Weekly</option>
                        <option>Bi-weekly</option>
                        <option>Monthly</option>
                    </select>
                </div>
                <button class="btn" onclick="addHICommitment()"><i class="fas fa-plus"></i> Add</button>
            </div>
            <div class="box"><h3>Active Commitments</h3><div id="hi-commitments-list"></div></div>
        </section>

        <section id="service-hours-section" style="border-left: 4px solid #f39c12;">
            <h2><i class="fas fa-clock"></i> Service Hours Tracking</h2>
            <button class="btn mb-3" onclick="exportServiceHoursReportPDF()" style="background: #f39c12;">
                <i class="fas fa-file-pdf"></i> Export Service Hours to PDF
            </button>
            <div class="box mb-4">
                <h3>Log Service Hours</h3>
                <div class="form-group">
                    <label for="service-member">Member</label>
                    <select id="service-member"></select>
                </div>
                <div class="form-group">
                    <label for="service-hours">Hours</label>
                    <input type="number" id="service-hours" step="0.5" min="0.5" />
                </div>
                <div class="form-group">
                    <label for="service-type">Service Type</label>
                    <input type="text" id="service-type" placeholder="e.g., Setup, Literature" />
                </div>
                <div class="form-group">
                    <label for="service-date">Date</label>
                    <input type="date" id="service-date" />
                </div>
                <button class="btn" onclick="logServiceHours()"><i class="fas fa-plus"></i> Log Hours</button>
            </div>
            <div class="box"><h3>Service Leaderboard</h3><div id="service-hours-leaderboard"></div></div>
        </section>

        <section id="conflict-resolution-section" style="border-left: 4px solid #e74c3c;">
            <h2><i class="fas fa-handshake"></i> Conflict Resolution Tracker</h2>
            <div class="box mb-4">
                <h3>Log Conflict</h3>
                <div class="form-group">
                    <label for="conflict-desc">Description</label>
                    <textarea id="conflict-desc" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="conflict-severity">Severity</label>
                    <select id="conflict-severity">
                        <option>Low</option>
                        <option>Medium</option>
                        <option>High</option>
                    </select>
                </div>
                <button class="btn" onclick="logConflict()"><i class="fas fa-plus"></i> Log</button>
            </div>
            <div class="box"><h3>Active Conflicts</h3><div id="conflicts-list"></div></div>
        </section>

        <section id="inventory-questions-section" style="border-left: 4px solid #9b59b6;">
            <h2><i class="fas fa-question-circle"></i> Group Inventory Question Bank</h2>
            <div class="box">
                <h3>Pre-loaded Questions</h3>
                <div id="inventory-questions-display"></div>
            </div>
        </section>

        <section id="tradition-study-section" style="border-left: 4px solid #3498db;">
            <h2><i class="fas fa-book-open"></i> Tradition Study Curriculum</h2>
            <div class="box">
                <h3>12-Month Rotation</h3>
                <div id="tradition-curriculum"></div>
            </div>
        </section>

        <section id="concept-study-section" style="border-left: 4px solid #1abc9c;">
            <h2><i class="fas fa-lightbulb"></i> Concept Study Curriculum</h2>
            <div class="box">
                <h3>12-Month Service Concepts</h3>
                <div id="concept-curriculum"></div>
            </div>
        </section>

        <section id="templates-section" style="border-left: 4px solid #95a5a6;">
            <h2><i class="fas fa-file-alt"></i> Meeting Format Templates</h2>
            <h3>Create/Edit Template</h3>
            <div class="form-group">
                <label for="template-name">Template Name</label>
                <input type="text" id="template-name" placeholder="e.g., Speaker Meeting, Step Study, Big Book..." />
            </div>
            <div class="form-group">
                <label for="template-type">Template Type</label>
                <select id="template-type">
                    <option value="meeting-format">Meeting Format</option>
                    <option value="speaker-checklist">Speaker Meeting Checklist</option>
                    <option value="event-planning">Event Planning</option>
                </select>
            </div>
            <div class="form-group">
                <label for="template-content">Template Content</label>
                <textarea id="template-content" rows="10" placeholder="Enter template content..."></textarea>
            </div>
            <button class="btn" onclick="saveTemplate()">Save Template</button>
            <h3 class="mt-4">Saved Templates</h3>
            <div class="history-nav">
                <button onclick="filterTemplates('all')" class="active" id="all-templates-btn">All</button>
                <button onclick="filterTemplates('meeting-format')" id="meeting-templates-btn">Meeting Formats</button>
                <button onclick="filterTemplates('speaker-checklist')" id="speaker-templates-btn">Speaker Checklists</button>
                <button onclick="filterTemplates('event-planning')" id="event-templates-btn">Event Planning</button>
            </div>
            <div id="templates-list"></div>
        </section>
        <section id="gallery-section" style="border-left: 4px solid #f39c12;">
            <h2><i class="fas fa-images"></i> Photo Gallery</h2>
            <p class="mb-2">Upload pictures of fliers or events. Add comma-separated tags to help organize them.</p>
            <div class="form-group">
                <label for="photo-upload">Select Photos</label>
                <input type="file" id="photo-upload" accept="image/*" multiple />
            </div>
            <div class="form-group">
                <label for="photo-tags">Tags (comma-separated)</label>
                <input type="text" id="photo-tags" placeholder="e.g. bbq, anniversary, 2024" />
            </div>
            <button id="upload-btn" class="btn" onclick="uploadPhotos()" disabled>Upload Selected</button>
            <h3 class="mt-4">Filter Photos</h3>
            <div class="form-group">
                <input type="text" id="tag-filter" onkeyup="updateGallery()" placeholder="Filter by tag..." />
            </div>
            <div id="tag-list" class="mb-4"></div>
            <h3 class="mt-4">Photos</h3>
            <div id="gallery-grid"></div>
        </section>
        <div id="photo-modal" class="modal">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <a class="prev" onclick="showPreviousPhoto()">&#10094;</a>
            <a class="next" onclick="showNextPhoto()">&#10095;</a>
            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; max-width: 90vw; max-height: 90vh;">
                <img class="modal-content" id="modal-image" style="max-height: 80vh; object-fit: contain;">
                <div id="modal-caption" style="text-align: center; color: #ccc; padding: 10px 0; font-size: 1rem; height: 2rem;"></div>
            </div>
        </div>
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const photoUpload = document.getElementById('photo-upload');
                const uploadBtn = document.getElementById('upload-btn');

                if (photoUpload && uploadBtn) {
                    photoUpload.addEventListener('change', () => {
                        console.log('File input changed');
                        if (photoUpload.files.length > 0) {
                            console.log('Files selected, enabling button');
                            uploadBtn.disabled = false;
                        } else {
                            console.log('No files selected, disabling button');
                            uploadBtn.disabled = true;
                        }
                    });
                } else {
                    console.log('Could not find photo-upload or upload-btn');
                }
            });
        </script>
        <section id="communication-lists-section" style="border-left: 4px solid #3498db;">
            <h2><i class="fas fa-envelope-open-text"></i> Text/Email Lists</h2>
            <p class="mb-4">Manage segmented communication lists.</p>
            <div class="box mb-4">
                <h3>Create List</h3>
                <div class="form-group">
                    <label for="comm-list-name">List Name</label>
                    <input type="text" id="comm-list-name" placeholder="e.g., Service Committee" />
                </div>
                <div class="form-group">
                    <label>Select Members</label>
                    <select multiple id="comm-list-members" style="height: 150px;"></select>
                </div>
                <button class="btn" onclick="saveCommList()"><i class="fas fa-save"></i> Save List</button>
            </div>
            <div class="box"><h3>Active Lists</h3><div id="comm-lists-display"></div></div>
        </section>

        <section id="meeting-reminders-section" style="border-left: 4px solid #f39c12;">
            <h2><i class="fas fa-bell"></i> Meeting Reminders</h2>
            <p class="mb-4">Set up automated meeting reminders.</p>
            <div class="box mb-4">
                <div class="form-group">
                    <label for="reminder-meeting">Select Meeting</label>
                    <select id="reminder-meeting"></select>
                </div>
                <div class="form-group">
                    <label for="reminder-hours">Hours Before</label>
                    <input type="number" id="reminder-hours" value="24" min="1" />
                </div>
                <button class="btn" onclick="saveReminderSettings()"><i class="fas fa-save"></i> Save</button>
            </div>
            <div class="box"><div id="reminders-list"></div></div>
        </section>

        <section id="notifications-section" style="border-left: 4px solid #9b59b6;">
            <h2><i class="fas fa-birthday-cake"></i> Birthday Notifications</h2>
            <div class="box mb-4">
                <div class="form-group">
                    <label for="notif-days-advance">Days in Advance</label>
                    <input type="number" id="notif-days-advance" value="7" min="1" />
                </div>
                <button class="btn" onclick="saveNotificationSettings()"><i class="fas fa-save"></i> Save</button>
            </div>
            <div class="box"><div id="upcoming-birthdays-list"></div></div>
        </section>

        <section id="action-items-section" style="border-left: 4px solid #e74c3c;">
            <h2><i class="fas fa-tasks"></i> Action Item Assignments</h2>
            <div class="box mb-4">
                <div class="form-group">
                    <label for="action-item-title">Task</label>
                    <input type="text" id="action-item-title" />
                </div>
                <div class="form-group">
                    <label for="action-item-assigned">Assigned To</label>
                    <select id="action-item-assigned"></select>
                </div>
                <div class="form-group">
                    <label for="action-item-due">Due Date</label>
                    <input type="date" id="action-item-due" />
                </div>
                <button class="btn" onclick="createActionItem()"><i class="fas fa-plus"></i> Create</button>
            </div>
            <div class="box"><div id="action-items-list"></div></div>
        </section>

        <section id="cancellation-alerts-section" style="border-left: 4px solid #e74c3c;">
            <h2><i class="fas fa-exclamation-triangle"></i> Meeting Cancellation Alerts</h2>
            <div class="box mb-4">
                <div class="form-group">
                    <label for="cancel-meeting">Meeting</label>
                    <select id="cancel-meeting"></select>
                </div>
                <div class="form-group">
                    <label for="cancel-reason">Reason</label>
                    <textarea id="cancel-reason" rows="2"></textarea>
                </div>
                <button class="btn" onclick="sendCancellationAlert()"><i class="fas fa-paper-plane"></i> Send Alert</button>
            </div>
            <div class="box"><div id="cancellation-history"></div></div>
        </section>

        <section id="welcome-packet-section" style="border-left: 4px solid #2ecc71;">
            <h2><i class="fas fa-gift"></i> Welcome Packet Generator</h2>
            <div class="box mb-4">
                <div class="form-group">
                    <label for="welcome-newcomer">Newcomer</label>
                    <select id="welcome-newcomer"></select>
                </div>
                <button class="btn" onclick="generateWelcomePacket()"><i class="fas fa-print"></i> Generate PDF</button>
            </div>
            <div class="box"><div id="welcome-packets-list"></div></div>
        </section>

        <section id="bigbook-tracker-section" style="border-left: 4px solid #8e44ad;">
            <h2><i class="fas fa-book"></i> Big Book Study Tracker</h2>
            <div class="box mb-4">
                <div class="form-group">
                    <label for="bb-chapter">Chapter</label>
                    <select id="bb-chapter">
                        <option>Chapter 1 - Bill's Story</option>
                        <option>Chapter 5 - How It Works</option>
                        <option>Chapter 6 - Into Action</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="bb-date">Date</label>
                    <input type="date" id="bb-date" />
                </div>
                <button class="btn" onclick="logBigBookStudy()"><i class="fas fa-check"></i> Log Study</button>
            </div>
            <div class="box"><div id="bigbook-progress"></div></div>
        </section>

        <section id="literature-loans-section" style="border-left: 4px solid #16a085;">
            <h2><i class="fas fa-book-reader"></i> Literature Loan Library</h2>
            <div class="box mb-4">
                <div class="form-group">
                    <label for="loan-member">Member</label>
                    <select id="loan-member"></select>
                </div>
                <div class="form-group">
                    <label for="loan-item">Item</label>
                    <input type="text" id="loan-item" />
                </div>
                <div class="form-group">
                    <label for="loan-due">Due Date</label>
                    <input type="date" id="loan-due" />
                </div>
                <button class="btn" onclick="loanLiterature()"><i class="fas fa-hand-holding"></i> Loan</button>
            </div>
            <div class="box"><div id="literature-loans-list"></div></div>
        </section>

        <section id="newcomer-packs-section" style="border-left: 4px solid #27ae60;">
            <h2><i class="fas fa-box-open"></i> Newcomer Starter Packs</h2>
            <div class="box mb-4">
                <div class="form-group">
                    <label for="pack-newcomer">Newcomer</label>
                    <select id="pack-newcomer"></select>
                </div>
                <button class="btn" onclick="distributeNewcomerPack()"><i class="fas fa-gift"></i> Distribute</button>
            </div>
            <div class="box"><div id="newcomer-packs-history"></div></div>
        </section>

        <section id="literature-sales-section" style="border-left: 4px solid #f39c12;">
            <h2><i class="fas fa-cash-register"></i> Literature Sales</h2>
            <div class="box mb-4">
                <div class="form-group">
                    <label for="sale-item">Item</label>
                    <input type="text" id="sale-item" />
                </div>
                <div class="form-group">
                    <label for="sale-price">Price</label>
                    <input type="number" id="sale-price" step="0.01" />
                </div>
                <button class="btn" onclick="recordLiteratureSale()"><i class="fas fa-dollar-sign"></i> Record</button>
            </div>
            <div class="box"><div id="literature-sales-summary"></div></div>
        </section>

        <section id="digital-library-section" style="border-left: 4px solid #3498db;">
            <h2><i class="fas fa-laptop"></i> Digital Literature Library</h2>
            <div class="box">
                <ul style="list-style: none;">
                    <li style="padding: 0.5rem;"><a href="https://www.aa.org/the-big-book" target="_blank"><i class="fas fa-external-link-alt"></i> The Big Book</a></li>
                    <li style="padding: 0.5rem;"><a href="https://www.aa.org/twelve-steps-and-twelve-traditions" target="_blank"><i class="fas fa-external-link-alt"></i> 12&12</a></li>
                    <li style="padding: 0.5rem;"><a href="https://www.aa.org/literature" target="_blank"><i class="fas fa-external-link-alt"></i> All Literature</a></li>
                </ul>
            </div>
        </section>

        <section id="study-guide-section" style="border-left: 4px solid #9b59b6;">
            <h2><i class="fas fa-clipboard-list"></i> Study Guide Generator</h2>
            <div class="box mb-4">
                <div class="form-group">
                    <label for="guide-topic">Topic</label>
                    <select id="guide-topic">
                        <option value="step">Step Study</option>
                        <option value="tradition">Tradition</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="guide-number">Number (1-12)</label>
                    <input type="number" id="guide-number" min="1" max="12" value="1" />
                </div>
                <button class="btn" onclick="generateStudyGuide()"><i class="fas fa-file-alt"></i> Generate</button>
            </div>
            <div class="box"><div id="study-guide-output"></div></div>
        </section>

        <section id="history-section" style="border-left: 4px solid #95a5a6;">
            <h2><i class="fas fa-history"></i> History &amp; Resources</h2>
            <div class="history-nav">
                <button id="genesis-btn" onclick="showHistory('genesis-history')">Genesis of AA</button>
                <button id="dfw-btn" onclick="showHistory('dfw-history')">Dallas/Fort Worth History</button>
                <button id="rowlett-btn" onclick="showHistory('rowlett-history')">Group History (Example)</button>
            </div>
            <div id="genesis-history" class="history-content">
                <h3 class="mb-4 font-bold text-xl">The Genesis of Alcoholics Anonymous</h3>
                <div class="timeline-wrapper">
                <div class="timeline-container">
                            <div class="timeline-block left">
                                <div class="timeline-content bg-blue-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-blue-400 pb-1 mb-2">William Griffith Wilson's Birth</h4>
                                        <p class="text-sm">Born in East Dorset, Vermont. His early life was marked by feelings of isolation and a strong drive for recognition, factors that would later influence his drinking and recovery.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-blue-800">Nov 26, 1895: Bill W. Born <i class="fa-solid fa-baby ml-2 text-blue-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Birth of William Griffith Wilson, co-founder of Alcoholics Anonymous.</p>
                                </div>
                            </div>
                            <div class="timeline-block right">
                                <div class="timeline-content bg-purple-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-purple-400 pb-1 mb-2">Robert Holbrook Smith's Birth</h4>
                                        <p class="text-sm">Born in St. Johnsbury, Vermont. He would later become a respected surgeon in Akron, Ohio, and co-founder of AA, despite his long struggle with alcoholism.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-purple-800">Aug 8, 1879: Dr. Bob Born <i class="fa-solid fa-baby ml-2 text-purple-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Birth of Robert Holbrook Smith, co-founder of Alcoholics Anonymous.</p>
                                </div>
                            </div>
                            <div class="timeline-block left">
                                <div class="timeline-content bg-green-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-green-400 pb-1 mb-2">Bill's Struggle & Lois Wilson</h4>
                                        <p class="text-sm">Bill's drinking progresses, leading to severe consequences. He marries Lois Burnham Wilson in 1918, who would become a steadfast supporter and co-founder of Al-Anon.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-green-800">1910s-30s: Bill's Descent & Lois <i class="fa-solid fa-ring ml-2 text-green-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Bill's alcoholism escalates, bringing financial ruin and repeated hospitalizations, deeply impacting his wife, Lois.</p>
                                </div>
                            </div>
                            <div class="timeline-block right">
                                <div class="timeline-content bg-teal-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-teal-400 pb-1 mb-2">Dr. Bob's Hidden Battle & Anne Smith</h4>
                                        <p class="text-sm">Dr. Bob's alcoholism becomes a decades-long struggle, hidden from many. He marries Anne Ripley Smith, who would become a crucial figure in early AA and Al-Anon, supporting his recovery efforts.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-teal-800">1910s-30s: Dr. Bob's Struggle & Anne <i class="fa-solid fa-house-medical-flag ml-2 text-teal-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Dr. Bob battles severe, often hidden, alcoholism despite his medical career, supported by his wife, Anne.</p>
                                </div>
                            </div>
                            <div class="timeline-block left">
                                <div class="timeline-content bg-cyan-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-cyan-400 pb-1 mb-2">The Spiritual Solution Introduced</h4>
                                        <p class="text-sm">Bill's old drinking friend, Ebby T., visits him, sober, and introduces the idea of a spiritual solution, learned from the Oxford Group. This plants the seed for Bill's own spiritual awakening.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-cyan-800">Nov 1934: Ebby T. & Bill's Shift <i class="fa-solid fa-hand-holding-heart ml-2 text-cyan-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Ebby T. visits Bill, sharing his newfound sobriety through a spiritual experience, igniting hope in Bill during his deepest despair.</p>
                                </div>
                            </div>
                            <div class="timeline-block right">
                                <div class="timeline-content bg-yellow-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-yellow-400 pb-1 mb-2">The "White Light" Experience</h4>
                                        <p class="text-sm">While hospitalized in Towns Hospital, Bill experiences a profound spiritual awakening after crying out to God in desperation. The obsession with alcohol is lifted, and he finds immediate sobriety.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-yellow-800">Dec 1934: Bill's Awakening <i class="fa-solid fa-lightbulb ml-2 text-yellow-500"></i></h2>
                                    <p class="mt-2 text-slate-700">In Towns Hospital, Bill W. has a powerful spiritual experience that removes his obsession to drink, marking his last drink.</p>
                                </div>
                            </div>
                            <div class="timeline-block left">
                                <div class="timeline-content bg-orange-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-orange-400 pb-1 mb-2">The Helper Therapy Principle</h4>
                                        <p class="text-sm">Bill's initial attempts to "convert" other alcoholics fail until he realizes he must share his experience with empathy, not preach. He discovers that helping others is crucial for his own sobriety.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-orange-800">Early 1935: The Paradox Discovered <i class="fa-solid fa-person-digging ml-2 text-orange-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Bill learns that helping other alcoholics is essential for maintaining his own sobriety, laying the groundwork for AA's core service principle.</p>
                                </div>
                            </div>
                            <div class="timeline-block right">
                                <div class="timeline-content bg-red-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-red-400 pb-1 mb-2">The Birth of AA</h4>
                                        <p class="text-sm">During a business trip to Akron, Bill, desperate to help another alcoholic to stay sober himself, is introduced to Dr. Bob by Henrietta Seiberling. Their shared experience and mutual need ignite the spark of Alcoholics Anonymous.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-red-800">May 1935: AA is Born <i class="fa-solid fa-handshake ml-2 text-red-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Bill W. meets Dr. Bob in Akron, Ohio. Their first conversation and shared experience mark the official founding of Alcoholics Anonymous.</p>
                                </div>
                            </div>
                            <div class="timeline-block left">
                                <div class="timeline-content bg-indigo-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-indigo-400 pb-1 mb-2">The Last Drink</h4>
                                        <p class="text-sm">After continued discussions with Bill and a final relapse, Dr. Bob takes his last drink on June 10, 1935, achieving continuous sobriety. This date is celebrated as AA's founding day.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-indigo-800">June 10, 1935: Dr. Bob Sober <i class="fa-solid fa-calendar-check ml-2 text-indigo-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Dr. Bob takes his last drink, achieving continuous sobriety and solidifying the foundation of the new fellowship.</p>
                                </div>
                            </div>
                            <div class="timeline-block right">
                                <div class="timeline-content bg-purple-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-purple-400 pb-1 mb-2">Working with Others</h4>
                                        <p class="text-sm">Bill and Dr. Bob begin working with other alcoholics, primarily at Akron City Hospital. They apply their principles of sharing experience, spiritual transformation, and mutual support, forming the nucleus of the first AA group.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-purple-800">June 1935+: Akron Group <i class="fa-solid fa-hospital ml-2 text-purple-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Bill and Dr. Bob begin intensive work with other alcoholics, particularly in hospitals, forming the first AA group in Akron.</p>
                                </div>
                            </div>
                            <div class="timeline-block left">
                                <div class="timeline-content bg-green-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-green-400 pb-1 mb-2">From Oxford Group to AA's Principles</h4>
                                        <p class="text-sm">The Twelve Steps evolved from the six principles of the Oxford Group, a spiritual movement that influenced early AA. Bill W. expanded and formalized these into the Twelve Steps, making them more specific to alcoholism and accessible to a wider audience, including those without a traditional religious background.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-green-800">Late 1930s: Steps Evolve <i class="fa-solid fa-scroll ml-2 text-green-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The Twelve Steps are developed and formalized by Bill W., building on earlier spiritual principles.</p>
                                </div>
                            </div>
                            <div class="timeline-block right">
                                <div class="timeline-content bg-teal-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-teal-400 pb-1 mb-2">Codifying the Program</h4>
                                        <p class="text-sm">Bill W., with input from Dr. Bob and early members, drafts the Twelve Steps, codifying the spiritual principles and actions necessary for recovery. These steps become the core program of AA.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-teal-800">1938-1939: Twelve Steps Drafted <i class="fa-solid fa-list-ol ml-2 text-teal-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The Twelve Steps are formally drafted, outlining the program of recovery for alcoholics.</p>
                                </div>
                            </div>
                            <div class="timeline-block left">
                                <div class="timeline-content bg-cyan-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-cyan-400 pb-1 mb-2">Carrying the Message to the World</h4>
                                        <p class="text-sm">The foundational text, "Alcoholics Anonymous" (the Big Book), is published. It details the problem of alcoholism, the spiritual solution, and the Twelve Steps, making the program accessible to a wider audience.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-cyan-800">Apr 1939: Big Book (1st Ed.) <i class="fa-solid fa-book-open ml-2 text-cyan-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The book "Alcoholics Anonymous" is published, providing the definitive text for the fellowship's program of recovery.</p>
                                </div>
                            </div>
                            <div class="timeline-block right">
                                <div class="timeline-content bg-yellow-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-yellow-400 pb-1 mb-2">Maintaining Unity</h4>
                                        <p class="text-sm">As AA grows rapidly, issues of group autonomy, money, and public relations arise. The Twelve Traditions emerge informally and are later codified to ensure the unity and survival of the fellowship.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-yellow-800">1930s-40s: Traditions Emerge <i class="fa-solid fa-users-line ml-2 text-yellow-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Rapid growth leads to the development of the Twelve Traditions, guiding AA's groups and preserving its unity.</p>
                                </div>
                            </div>
                            <div class="timeline-block left">
                                <div class="timeline-content bg-orange-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-orange-400 pb-1 mb-2">A Legacy of Service</h4>
                                        <p class="text-sm">Dr. Bob passes away in Akron, Ohio, having maintained continuous sobriety since June 10, 1935. His life of dedicated service, particularly in hospitals, leaves an enduring legacy as AA's co-founder.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-orange-800">Nov 16, 1950: Dr. Bob Passes <i class="fa-solid fa-cross ml-2 text-orange-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Dr. Bob, co-founder of AA, passes away, having achieved continuous sobriety and dedicated his life to helping others.</p>
                                </div>
                            </div>
                            <div class="timeline-block right">
                                <div class="timeline-content bg-red-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-red-400 pb-1 mb-2">Deeper Understanding & Guidance</h4>
                                        <p class="text-sm">Written by Bill W., this book provides detailed interpretations and historical context for both the Twelve Steps and the Twelve Traditions. It was created to offer members a deeper understanding of the spiritual principles and the guidelines for group unity, helping AA mature as a fellowship.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-red-800">1953: 12 & 12 Published <i class="fa-solid fa-book-bookmark ml-2 text-red-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The "Twelve Steps and Twelve Traditions" book is published, offering deeper insights into the program and guiding principles.</p>
                                </div>
                            </div>
                            <div class="timeline-block left">
                                <div class="timeline-content bg-indigo-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-indigo-400 pb-1 mb-2">Growth and Traditions</h4>
                                        <p class="text-sm">The second edition of the Big Book is published, reflecting AA's significant growth and including the formalized Twelve Traditions.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-indigo-800">1955: Big Book (2nd Ed.) <i class="fa-solid fa-book-reader ml-2 text-indigo-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The second edition of the Big Book is released, documenting AA's growth and formally including the Twelve Traditions.</p>
                                </div>
                            </div>
                            <div class="timeline-block right">
                                <div class="timeline-content bg-purple-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-purple-400 pb-1 mb-2">Guiding Global Service</h4>
                                        <p class="text-sm">Bill W. develops the Twelve Concepts for World Service to provide a framework for AA's growing global service structure, ensuring effective leadership and decision-making while maintaining group autonomy.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-purple-800">1950s: World Service Concepts <i class="fa-solid fa-globe ml-2 text-purple-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The Twelve Concepts for World Service are developed to guide AA's expanding global service structure.</p>
                                </div>
                            </div>
                            <div class="timeline-block left">
                                <div class="timeline-content bg-green-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-green-400 pb-1 mb-2">A Founder's Legacy</h4>
                                        <p class="text-sm">Bill W. passes away in Miami Beach, Florida. His vision and dedication led to the founding of AA and its global spread, leaving an immeasurable legacy for millions in recovery.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-green-800">Jan 24, 1971: Bill W. Passes <i class="fa-solid fa-person-praying ml-2 text-green-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Bill W., co-founder of AA, passes away, leaving behind a global fellowship dedicated to sobriety.</p>
                                </div>
                            </div>
                            <div class="timeline-block right">
                                <div class="timeline-content bg-teal-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-teal-400 pb-1 mb-2">Continued Expansion</h4>
                                        <p class="text-sm">The third edition of the Big Book is published, reflecting further growth in AA membership worldwide and reaffirming the unchanging core principles.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-teal-800">1976: Big Book (3rd Ed.) <i class="fa-solid fa-book-bookmark ml-2 text-teal-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The third edition of the Big Book is released, documenting AA's continued expansion.</p>
                                </div>
                            </div>
                            <div class="timeline-block left">
                                <div class="timeline-content bg-cyan-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-cyan-400 pb-1 mb-2">Into the New Millennium</h4>
                                        <p class="text-sm">The fourth edition of the Big Book is published, highlighting AA's global reach into the new millennium and the enduring power of its message.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-cyan-800">2001: Big Book (4th Ed.) <i class="fa-solid fa-book-atlas ml-2 text-cyan-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The fourth edition of the Big Book is released, marking AA's presence worldwide at the turn of the millennium.</p>
                                </div>
                            </div>
                        </div>
                </div>
            </div>
            <div id="dfw-history" class="history-content">
                <h3 class="mb-4 font-bold text-xl">Dallas/Fort Worth AA History</h3>
                <div class="timeline-wrapper">
                <div class="timeline-container">
                            <div class="timeline-block left">
                                <div class="timeline-content bg-blue-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-blue-400 pb-1 mb-2">Texas Roots</h4>
                                        <p class="text-sm">The first documented AA group in Texas forms in Houston with Larry Jewell. This is significant as Esther E., a key figure in Dallas AA, sobered up here before moving to Dallas.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-blue-800">1940: AA in Houston <i class="fa-solid fa-map-pin ml-2 text-blue-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The first AA group in Texas is established in Houston.</p>
                                </div>
                            </div>
                            <div class="timeline-block right">
                                <div class="timeline-content bg-purple-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-purple-400 pb-1 mb-2">First Dallas Outreach</h4>
                                        <p class="text-sm">Ruth T., a Dallas alcoholic, sends the first recorded letter from Dallas to Ruth Hock, Bill W.'s secretary in New York, inquiring about AA activity in the area. This marks the initial plea for help from Dallas.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-purple-800">Jun 14, 1941: Ruth T.'s Plea <i class="fa-solid fa-envelope ml-2 text-purple-500"></i></h2>
                                    <p class="mt-2 text-slate-700">First recorded outreach from Dallas to AA General Service Office.</p>
                                </div>
                            </div>
                            <div class="timeline-block left">
                                <div class="timeline-content bg-green-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-green-400 pb-1 mb-2">Fort Worth's Early Beginnings</h4>
                                        <p class="text-sm">George McL. is credited with starting the first AA group in Fort Worth. Early history is "hazy," but correspondence details an initial meeting with seven attendees.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-green-800">1941: Fort Worth's First Group <i class="fa-solid fa-users ml-2 text-green-500"></i></h2>
                                    <p class="mt-2 text-slate-700">George McL. is credited with starting the first AA group in Fort Worth.</p>
                                </div>
                            </div>
                            <div class="timeline-block right">
                                <div class="timeline-content bg-teal-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-teal-400 pb-1 mb-2">Energetic but Fleeting Efforts</h4>
                                        <p class="text-sm">Kent W., a sober AA member from Florida, moves to Dallas and eagerly begins promoting AA in local media, planning meetings, and even titled himself "Chief Sponsor" of Dallas AA.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-teal-800">Dec 1, 1941: Kent W. in Dallas <i class="fa-solid fa-bullhorn ml-2 text-teal-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Kent W. arrives in Dallas, eager to establish an AA group.</p>
                                </div>
                            </div>
                            <div class="timeline-block left">
                                <div class="timeline-content bg-cyan-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-cyan-400 pb-1 mb-2">Initial Surge and Disappearance</h4>
                                        <p class="text-sm">Kent W. holds the first recorded AA meeting in Dallas at the White Plaza Hotel, attended by 12 people. A Dallas Morning News story sparks 72 inquiries. Despite his efforts, Kent W. is "never heard from again," highlighting the fragility of early group formation.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-cyan-800">Jan 7, 1942: 1st Dallas Meeting <i class="fa-solid fa-hotel ml-2 text-cyan-500"></i></h2>
                                    <p class="mt-2 text-slate-700">First recorded AA meeting in Dallas held by Kent W. at the White Plaza Hotel.</p>
                                </div>
                            </div>
                            <div class="timeline-block right">
                                <div class="timeline-content bg-yellow-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-yellow-400 pb-1 mb-2">AA Takes Root in Dallas</h4>
                                        <p class="text-sm">Esther E. (whose story "A Flower of the South" is in the Big Book), having sobered up in Houston, moves to Dallas and starts "The Dallas Group" in her home. Ruth T. attends this inaugural meeting.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-yellow-800">Apr 2, 1943: "The Dallas Group" <i class="fa-solid fa-house-chimney ml-2 text-yellow-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Esther E. starts "The Dallas Group" in her home, marking AA truly taking root in Dallas.</p>
                                </div>
                            </div>
                            <div class="timeline-block left">
                                <div class="timeline-content bg-orange-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-orange-400 pb-1 mb-2">Establishing a Presence</h4>
                                        <p class="text-sm">Dallas AA secures its first permanent home at 912 ½ Main Street in downtown. By year-end, fewer than 20 people in the city are sober, but numbers are growing by word-of-mouth.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-orange-800">1945: Dallas AA Home <i class="fa-solid fa-building ml-2 text-orange-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Dallas AA establishes its first permanent home downtown.</p>
                                </div>
                            </div>
                            <div class="timeline-block right">
                                <div class="timeline-content bg-red-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-red-400 pb-1 mb-2">Post-War Expansion</h4>
                                        <p class="text-sm">Following World War II, AA membership surges. Searcy W. forms a second group, the Suburban Group, which remains active in Dallas today.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-red-800">1946: Suburban Group <i class="fa-solid fa-people-group ml-2 text-red-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Searcy W. forms the Suburban Group in Dallas.</p>
                                </div>
                            </div>
                            <div class="timeline-block left">
                                <div class="timeline-content bg-indigo-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-indigo-400 pb-1 mb-2">Organizational Foresight</h4>
                                        <p class="text-sm">The Dallas Central Office holds its first Board meeting and officially opens on Akard Street. Dick P. serves as the first Office Manager, despite suffering physically from Jamaica Ginger Poisoning, demonstrating profound commitment.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-indigo-800">Sep 18, 1947: Dallas Central Office <i class="fa-solid fa-phone ml-2 text-indigo-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The Dallas Central Office officially opens for business.</p>
                                </div>
                            </div>
                            <div class="timeline-block right">
                                <div class="timeline-content bg-purple-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-purple-400 pb-1 mb-2">A Pioneer's Legacy</h4>
                                        <p class="text-sm">Esther E. passes away with slightly more than 19 years of sobriety. Her personal copy of the Big Book, inscribed by Bill W., is displayed at the Dallas Intergroup Office, a tangible link to her foundational role.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-purple-800">1960: Esther E. Passes <i class="fa-solid fa-book-heart ml-2 text-purple-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Esther E., instrumental in establishing AA in Dallas, passes away.</p>
                                </div>
                            </div>
                            <div class="timeline-block left">
                                <div class="timeline-content bg-green-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-green-400 pb-1 mb-2">Maturation of Service</h4>
                                        <p class="text-sm">Dallas Intergroup reorganizes, and the Central Office begins operating more formally under the guidance of the then eight or nine AA groups. A member generously loans \$2,000 to stock AA literature.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-green-800">1968: Dallas Intergroup Reorg <i class="fa-solid fa-sitemap ml-2 text-green-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Dallas Intergroup reorganizes for more formal operations.</p>
                                </div>
                            </div>
                            <div class="timeline-block right">
                                <div class="timeline-content bg-teal-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-teal-400 pb-1 mb-2">Broadening Reach</h4>
                                        <p class="text-sm">The Dallas Central Office, then located in the Hudson & Hudson Building, publishes a comprehensive meeting directory that includes groups in jails, hospitals, and other facilities, reflecting the broadening reach of AA.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-teal-800">1971: Dallas Meeting Directory <i class="fa-solid fa-address-book ml-2 text-teal-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Dallas Central Office publishes a comprehensive meeting directory.</p>
                                </div>
                            </div>
                            <div class="timeline-block left">
                                <div class="timeline-content bg-cyan-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-cyan-400 pb-1 mb-2">Significant Growth</h4>
                                        <p class="text-sm">The Dallas fellowship experiences substantial growth, reaching 30 active groups, demonstrating the increasing demand for AA's message in the region.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-cyan-800">1973: 30 Dallas Groups <i class="fa-solid fa-chart-line ml-2 text-cyan-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The Dallas AA fellowship grows to 30 groups.</p>
                                </div>
                            </div>
                            <div class="timeline-block right">
                                <div class="timeline-content bg-yellow-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-yellow-400 pb-1 mb-2">Serving Diverse Communities</h4>
                                        <p class="text-sm">The Lambda Dallas Group is founded in Oak Lawn, Dallas' LGBTQ neighborhood. This group plays a vital role in carrying the AA message to thousands within this specific community, highlighting AA's adaptability.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-yellow-800">1978: Lambda Dallas Group <i class="fa-solid fa-rainbow ml-2 text-yellow-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The Lambda Dallas Group is founded, serving the LGBTQ community.</p>
                                </div>
                            </div>
                            <div class="timeline-block left">
                                <div class="timeline-content bg-orange-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-orange-400 pb-1 mb-2">Fort Worth Milestone</h4>
                                        <p class="text-sm">The Glass House group is founded on the west side of Fort Worth by a few members emphasizing spirituality. Its first meeting on Houghton Street notably coincides with AA's 48th anniversary. The podium built by founder Don A. is still in use today.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-orange-800">Jun 10, 1983: Glass House (FW) <i class="fa-solid fa-house-crack ml-2 text-orange-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The Glass House group is founded in Fort Worth.</p>
                                </div>
                            </div>
                            <div class="timeline-block right">
                                <div class="timeline-content bg-red-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-red-400 pb-1 mb-2">Rapid Growth & Incorporation</h4>
                                        <p class="text-sm">Within months, The Glass House outgrows its initial location, leading to the acquisition of its current facility at 6713 Hemsell Place. The move involves extensive volunteer effort, and the group is incorporated by Bryan H., Jim Williams, Kelly Y., and Massie T.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-red-800">1984: Glass House Relocates <i class="fa-solid fa-location-dot ml-2 text-red-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The Glass House group moves to its current Fort Worth facility.</p>
                                </div>
                            </div>
                            <div class="timeline-block left">
                                <div class="timeline-content bg-indigo-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-indigo-400 pb-1 mb-2">Formalizing Structure</h4>
                                        <p class="text-sm">The Dallas Intergroup formalizes its structure by incorporating and becoming the Dallas Intergroup Association (DIA), a non-profit organization, reflecting its maturation as a service entity.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-indigo-800">1989: Dallas Intergroup (DIA) <i class="fa-solid fa-building-columns ml-2 text-indigo-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Dallas Intergroup incorporates as the Dallas Intergroup Association (DIA).</p>
                                </div>
                            </div>
                            <div class="timeline-block right">
                                <div class="timeline-content bg-purple-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-purple-400 pb-1 mb-2">A Founder Remembered</h4>
                                        <p class="text-sm">Bryan Honts, a founder of The Glass House group in Fort Worth, passes away. His contributions were vital to the group's establishment and early growth.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-purple-800">Jun 1993: Bryan Honts Passes <i class="fa-solid fa-user-tie ml-2 text-purple-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Bryan Honts, a founder of The Glass House group, passes away.</p>
                                </div>
                            </div>
                            <div class="timeline-block left">
                                <div class="timeline-content bg-green-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-green-400 pb-1 mb-2">Speaker and Founder</h4>
                                        <p class="text-sm">Jim Williams, a founder of The Glass House group and a prolific AA speaker, passes away. His shares and service significantly impacted many members.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-green-800">Jan 1999: Jim Williams Passes <i class="fa-solid fa-microphone ml-2 text-green-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Jim Williams, a founder and speaker at The Glass House, passes away.</p>
                                </div>
                            </div>
                            <div class="timeline-block right">
                                <div class="timeline-content bg-teal-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-teal-400 pb-1 mb-2">Clarifying Identity</h4>
                                        <p class="text-sm">The Dallas Intergroup Association (DIA) reverts its name to the Dallas AA Central Office. This change was made to better describe its primary function to potential newcomers seeking help, emphasizing accessibility.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-teal-800">Apr 2000: Dallas Central Office <i class="fa-solid fa-retweet ml-2 text-teal-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Dallas Intergroup Association (DIA) reverts its name to Dallas AA Central Office.</p>
                                </div>
                            </div>
                            <div class="timeline-block left">
                                <div class="timeline-content bg-cyan-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-cyan-400 pb-1 mb-2">Another Founder's Departure</h4>
                                        <p class="text-sm">Dr. Rex Howard, another founder of The Glass House group, passes away. His contributions were integral to the early spiritual emphasis of the group.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-cyan-800">2002: Dr. Rex Howard Passes <i class="fa-solid fa-user-md ml-2 text-cyan-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Dr. Rex Howard, a founder of The Glass House group, passes away.</p>
                                </div>
                            </div>
                            <div class="timeline-block right">
                                <div class="timeline-content bg-yellow-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-yellow-400 pb-1 mb-2">Dallas's Oldest Member</h4>
                                        <p class="text-sm">Searcy W., founder of Dallas's Suburban Group and then Dallas's oldest AA member, passes away with 57 years of sobriety, leaving a long legacy of recovery and service.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-yellow-800">2003: Searcy W. Passes <i class="fa-solid fa-star-of-life ml-2 text-yellow-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Searcy W., founder of the Suburban Group and Dallas's oldest AA member, passes away.</p>
                                </div>
                            </div>
                            <div class="timeline-block left">
                                <div class="timeline-content bg-orange-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-orange-400 pb-1 mb-2">Spiritual Leadership</h4>
                                        <p class="text-sm">Kelly Young, a key figure at The Glass House group who served as Chairman of its Board for 24 years, passes away after 27 years of active service, leaving a lasting legacy of spiritual leadership.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-orange-800">Apr 2009: Kelly Young Passes <i class="fa-solid fa-hand-holding-medical ml-2 text-orange-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Kelly Young, a key figure at The Glass House group, passes away.</p>
                                </div>
                            </div>
                            <div class="timeline-block right">
                                <div class="timeline-content bg-red-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-red-400 pb-1 mb-2">Continuing Service</h4>
                                        <p class="text-sm">The Dallas Central Office/DIA supports over 160 AA groups, hosting over 1500 meetings. The Fort Worth AA Central Office serves a wide multi-county area, and NETA 65 serves over 500 AA groups, demonstrating ongoing growth and vital service.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-red-800">Present: DFW AA Today <i class="fa-solid fa-city ml-2 text-red-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Dallas and Fort Worth AA continue to thrive, supporting thousands of members.</p>
                                </div>
                            </div>
                        </div>
                </div>
            </div>
            <div id="rowlett-history" class="history-content">
                <h3 class="mb-4 font-bold text-xl">Your Home Group History (Example Template)</h3>
                <p class="mb-4" style="color: #e74c3c; font-style: italic;">The history below is an example. You can customize this section with your own Home Group's history.</p>
                <div class="timeline-wrapper">
                <div class="timeline-container">
                            <div class="timeline-block left">
                                <div class="timeline-content bg-sky-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-sky-400 pb-1 mb-2">The Backstory</h4>
                                        <p class="text-sm">The Sunshine Group was struggling financially. Knowing the end was near, members gave notice to their landlord, promising to somehow pay two months of back rent. After it folded, a new vision was born.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-sky-800">1995: A Leap of Faith <i class="fa-solid fa-seedling ml-2 text-sky-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Eight former Sunshine Group members founded a new, non-smoking group. On July 22, the first meeting was held at 4501 Rowlett Road in a tiny 10.5' x 14' room.</p>
                                </div>
                            </div>
                            <div class="timeline-block right">
                                <div class="timeline-content bg-teal-50">
                                     <div class="info-popup">
                                        <h4 class="font-bold border-b border-teal-400 pb-1 mb-2">Volunteer Spirit</h4>
                                        <p class="text-sm">Extensive remodeling and refinishing was mostly done by Group volunteers working nights and weekends, creating the group home for the next six years!</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-teal-800">1996: Building Our Home <i class="fa-solid fa-hammer ml-2 text-teal-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The 1st Anniversary BBQ was memorably rained out. That fall, the group room tripled in size, and the Open House featured speaker Searcy W., who held a fifty-year chip!</p>
                                </div>
                            </div>
                            <div class="timeline-block left">
                                 <div class="timeline-content bg-teal-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-teal-400 pb-1 mb-2">Meeting Growth</h4>
                                        <p class="text-sm">Monthly AA birthday meetings were combined with Al-Anon. The total weekly meeting count grew rapidly: from none to 12 in 1997, then to 17 by the end of 1998.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-teal-800">1997-1998: More Meetings! <i class="fa-solid fa-users ml-2 text-teal-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The group expanded its schedule, adding monthly birthday meetings, multiple noon meetings, and 6 PM meetings to better serve the growing community.</p>
                                 </div>
                            </div>
                            <div class="timeline-block right">
                                 <div class="timeline-content bg-teal-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-teal-400 pb-1 mb-2">Key Events</h4>
                                        <ul class="text-sm list-disc list-inside space-y-1">
                                            <li><b>May 1999:</b> $500 approved to double Al-Anon space with volunteer labor.</li>
                                            <li><b>Feb 2002:</b> Sponsorship workshop featured a four-member panel with a moderator.</li>
                                             <li><b>Aug 2002:</b> 7th Anniversary had ~100 members and guests.</li>
                                        </ul>
                                    </div>
                                    <h2 class="text-2xl font-bold text-teal-800">1999-2002: Service & Structure <i class="fa-solid fa-book-open ml-2 text-teal-500"></i></h2>
                                    <p class="mt-2 text-slate-700">This era focused on service, with a 4th Anniversary party, a Sponsorship Workshop, and the formal designation of the Rowlett Group Bylaws.</p>
                                 </div>
                            </div>
                            <div class="timeline-block left">
                                 <div class="timeline-content bg-amber-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-amber-400 pb-1 mb-2">The Big Move</h4>
                                        <p class="text-sm">Minimum requirements for a new space: affordable rent, 1,000 sq ft, kitchen, bathroom, and storage. The new Garland facility's 2nd birthday night celebrated 27 members representing over 140 years of sobriety.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-amber-800">2003: A Test of Unity <i class="fa-solid fa-truck-moving ml-2 text-amber-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Forced to move, the group relocated to Garland. In an amazing show of unity, 50-60 members moved everything in under an hour, ensuring no meetings were missed.</p>
                                 </div>
                            </div>
                            <div class="timeline-block right">
                                <div class="timeline-content bg-amber-50">
                                     <div class="info-popup">
                                        <h4 class="font-bold border-b border-amber-400 pb-1 mb-2">Lease & Name</h4>
                                        <p class="text-sm">In 2006, the lease was extended, with the Rowlett Group becoming the official signatory. In June 2007, the group reconsidered a name change but elected to keep the Rowlett Group name despite being in Garland.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-amber-800">2004-2007: Settling In <i class="fa-solid fa-anchor ml-2 text-amber-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The group held its 2nd inventory, created job descriptions, and hosted workshops. The 12th Anniversary theme was "Imagine Life Without Faith."</p>
                                </div>
                            </div>
                            <div class="timeline-block left">
                                <div class="timeline-content bg-amber-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-amber-400 pb-1 mb-2">Fellowship!</h4>
                                        <p class="text-sm">Members insisted on enjoying life: Friday Night Candlelight Meetings followed by Denny's, Starbucks after the Saturday 8 PM meeting with guitars and sing-alongs, July 4th at the lake, and Sober Celebrations with live music by Turning Point.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-amber-800">2008-2009: Thriving! <i class="fa-solid fa-star ml-2 text-amber-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The Chaha/Bass Pro location boomed. Birthday nights were Standing Room Only, and the "Luau" themed 14th Anniversary party was a huge success.</p>
                                </div>
                            </div>
                            <div class="timeline-block right">
                                <div class="timeline-content bg-amber-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-amber-400 pb-1 mb-2">A New Home</h4>
                                        <p class="text-sm">In July 2010, 48 members attended a Group Conscience to approve the move "Behind Denny's." Work commenced, and the group held an Open House in lieu of an anniversary party after moving on Oct 30.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-amber-800">2010-2014: Service & A New Move <i class="fa-solid fa-briefcase ml-2 text-amber-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Members carried the message to correctional facilities, providing Big Books. The group hosted workshops and remained active in District/Area service.</p>
                                </div>
                            </div>
                            <div class="timeline-block left">
                                <div class="timeline-content bg-red-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-red-400 pb-1 mb-2">A Fateful Year</h4>
                                        <p class="text-sm">The decision to find a new home was made at Denny's in June. The lease at 362 Oaks Trail commenced on August 15. The tornado hit on December 26, minutes after attendees had traveled past the heavily damaged I-30/190 interchange.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-red-800">2015: Resilience & Rebirth <i class="fa-solid fa-heart-pulse ml-2 text-red-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Facing decline, four members decided to stick together, finding a new home at Oaks Trail. The year ended with a tornado narrowly missing the group's birthday night.</p>
                                </div>
                            </div>
                            <div class="timeline-block right">
                                <div class="timeline-content bg-indigo-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-indigo-400 pb-1 mb-2">Holding Fast</h4>
                                        <p class="text-sm">Though many AAs came and went, the central core of the group held fast. In 2019, the group signed another three-year lease, bringing the total years at Oaks Trail to seven. Overhead remained low and reserves prudent.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-indigo-800">2016-2019: A New Home <i class="fa-solid fa-house-chimney-heart ml-2 text-indigo-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Slow, steady growth continued. A fresh crop of dedicated AAs took hold, and newcomers were getting and staying sober by way of the twelve steps.</p>
                                </div>
                            </div>
                            <div class="timeline-block left">
                                <div class="timeline-content bg-indigo-50">
                                     <div class="info-popup">
                                        <h4 class="font-bold border-b border-indigo-400 pb-1 mb-2">Digital Fellowship</h4>
                                        <p class="text-sm">To keep members informed during the pandemic lockdown, the "Rowlett Friends of Bill" private Facebook page was created in April.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-indigo-800">2020: The Pandemic Pivot <i class="fa-solid fa-laptop ml-2 text-indigo-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The COVID-19 pandemic led to our first Zoom meeting on April 1. In-person meetings resumed in May, and in June, Tuesday night became a dedicated Newcomer meeting.</p>
                                </div>
                            </div>
                            <div class="timeline-block right">
                                <div class="timeline-content bg-green-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-green-400 pb-1 mb-2">Anniversary Update</h4>
                                        <p class="text-sm">The 26th Anniversary Party was planned for August 2021, but once again COVID reared its ugly head, forcing the anniversary to be postponed until February 2022.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-green-800">2021-Present: Re-Energized! <i class="fa-solid fa-champagne-glasses ml-2 text-green-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Group unity is stronger than ever. Fellowship dinners are popular, and outdoor Birthday Nights are celebrated with enthusiasm by friends and family.</p>
                                </div>
                            </div>
                        </div>
                </div>
            </div>
        </section>
        <section id="analytics-section" style="border-left: 4px solid #1abc9c;">
            <h2><i class="fas fa-chart-bar"></i> Analytics Dashboard</h2>
            <p class="mb-4">Track group engagement, attendance trends, and participation metrics.</p>
            <button class="btn mb-3" onclick="exportAnalyticsDashboardPDF()" style="background: #1abc9c;">
                <i class="fas fa-file-pdf"></i> Export Dashboard to PDF
            </button>
            <div class="box mb-4">
                <h3>Attendance Trends Over Time</h3>
                <div class="form-group">
                    <label for="analytics-time-range">Time Range</label>
                    <select id="analytics-time-range" onchange="refreshAnalytics()">
                        <option value="30">Last 30 Days</option>
                        <option value="60">Last 60 Days</option>
                        <option value="90" selected>Last 90 Days</option>
                        <option value="180">Last 6 Months</option>
                        <option value="365">Last Year</option>
                    </select>
                </div>
                <canvas id="attendance-chart" style="max-height: 300px;"></canvas>
            </div>
            <div class="box mb-4">
                <h3>Active Member Engagement</h3>
                <div id="engagement-metrics" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                </div>
            </div>
            <div class="box mb-4">
                <h3>Group Conscience Participation Rates</h3>
                <div id="gc-participation-stats">
                </div>
                <canvas id="gc-participation-chart" style="max-height: 250px; margin-top: 1rem;"></canvas>
            </div>
            <div class="box mb-4">
                <h3>Service Position Engagement</h3>
                <div id="service-engagement-stats">
                </div>
            </div>
            <div class="box">
                <h3>Recent Activity Summary</h3>
                <div id="activity-summary">
                </div>
            </div>
        </section>
        <section id="accessibility-section" style="border-left: 4px solid #34495e;">
            <h2><i class="fas fa-universal-access"></i> Accessibility Settings</h2>
            <p class="mb-4">Customize your viewing experience for better accessibility.</p>
            <div class="box mb-4">
                <h3>Theme Settings</h3>
                <div class="form-group">
                    <label for="theme-mode">Color Theme</label>
                    <select id="theme-mode" onchange="changeTheme()">
                        <option value="dark">Dark Mode (Default)</option>
                        <option value="light">Light Mode</option>
                        <option value="high-contrast">High Contrast</option>
                    </select>
                </div>
                <p style="font-size: 0.9rem; color: #95a5a6; margin-top: 0.5rem;">
                    Choose a theme that works best for your eyes and environment.
                </p>
            </div>
            <div class="box mb-4">
                <h3>Font Size</h3>
                <div class="form-group">
                    <label for="font-size-slider">Text Size: <span id="font-size-display">100%</span></label>
                    <input type="range" id="font-size-slider" min="80" max="150" value="100" step="10"
                           style="width: 100%;" oninput="changeFontSize(this.value)" />
                </div>
                <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn secondary" onclick="changeFontSize(80)">Small</button>
                    <button class="btn secondary" onclick="changeFontSize(100)">Medium</button>
                    <button class="btn secondary" onclick="changeFontSize(120)">Large</button>
                    <button class="btn secondary" onclick="changeFontSize(150)">Extra Large</button>
                </div>
                <p style="font-size: 0.9rem; color: #95a5a6; margin-top: 1rem;">
                    Sample text: The quick brown fox jumps over the lazy dog. 0123456789
                </p>
            </div>
            <div class="box mb-4">
                <h3>Screen Reader Optimization</h3>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="screen-reader-mode" onchange="toggleScreenReaderMode()" />
                        Enable Screen Reader Optimizations
                    </label>
                </div>
                <p style="font-size: 0.9rem; color: #95a5a6; margin-top: 0.5rem;">
                    This mode adds enhanced ARIA labels, skip navigation links, and improved semantic structure for screen readers.
                </p>
            </div>
            <div class="box mb-4">
                <h3>Additional Options</h3>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="reduce-animations" onchange="toggleReduceAnimations()" />
                        Reduce Animations
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="focus-indicators" onchange="toggleFocusIndicators()" />
                        Enhanced Focus Indicators
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="dyslexia-font" onchange="toggleDyslexiaFont()" />
                        Use Dyslexia-Friendly Font
                    </label>
                </div>
            </div>
            <div class="box">
                <h3>Keyboard Shortcuts</h3>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th style="text-align: left; padding: 0.5rem; border-bottom: 1px solid #3498db;">Action</th>
                            <th style="text-align: left; padding: 0.5rem; border-bottom: 1px solid #3498db;">Shortcut</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="padding: 0.5rem;">Navigate sections</td>
                            <td style="padding: 0.5rem;"><kbd>Tab</kbd> / <kbd>Shift+Tab</kbd></td>
                        </tr>
                        <tr>
                            <td style="padding: 0.5rem;">Activate button/link</td>
                            <td style="padding: 0.5rem;"><kbd>Enter</kbd> or <kbd>Space</kbd></td>
                        </tr>
                        <tr>
                            <td style="padding: 0.5rem;">Close modal</td>
                            <td style="padding: 0.5rem;"><kbd>Esc</kbd></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
        <section id="settings-section" style="border-left: 4px solid #34495e;">
            <h2><i class="fas fa-cog"></i> Settings & Data Management</h2>
            <div class="box mb-4">
                <h3>Group Settings</h3>
                <p class="mb-2">Configure your group's information and meeting details.</p>
                <div class="form-group">
                    <label for="group-qr-code-url">7th Tradition QR Code URL</label>
                    <input type="text" id="group-qr-code-url" placeholder="Enter QR code image URL (Venmo/PayPal/CashApp QR code)" />
                    <small style="font-size: 0.75rem; opacity: 0.8;">Upload your QR code to an image hosting service and paste the URL here, or leave blank to hide.</small>
                </div>
                <div class="form-group">
                    <label for="group-zoom-link">Zoom Meeting Link</label>
                    <input type="text" id="group-zoom-link" placeholder="zoommtg://zoom.us/join?action=join&confno=XXXXX&pwd=XXXXX" />
                    <small style="font-size: 0.75rem; opacity: 0.8;">Your Zoom meeting link. Leave blank to hide the Zoom button.</small>
                </div>
                <div class="form-group">
                    <label for="group-contact-name">Treasurer/Contact Name</label>
                    <input type="text" id="group-contact-name" placeholder="e.g., Nathan D" />
                </div>
                <div class="form-group">
                    <label for="group-contact-phone">Treasurer/Contact Phone</label>
                    <input type="tel" id="group-contact-phone" placeholder="e.g., 214-555-1234" />
                </div>
                <button class="btn" onclick="saveGroupSettings()">Save Group Settings</button>
            </div>
            <div class="box mb-4">
                <h3>User Identity</h3>
                <p class="mb-2">Set your name for messages and read receipts.</p>
                <div class="form-group">
                    <label for="current-user-name">Your Name</label>
                    <input type="text" id="current-user-name" placeholder="Enter your name..." />
                </div>
                <button class="btn" onclick="saveCurrentUser()">Save Name</button>
            </div>
            <div class="box mb-4" style="border-left: 4px solid #3498db;">
                <h3><i class="fas fa-database"></i> Backup & Restore System</h3>
                <p class="mb-2" style="color: #ecf0f1;">Choose your preferred backup format. Both methods include <strong>ALL</strong> application data.</p>
                <div class="box mt-4" style="background: #2c3e50; padding: 1.5rem;">
                    <h4 style="color: #3498db; margin: 0 0 1rem 0;"><i class="fas fa-file-code"></i> Method 1: JSON Backup (Recommended)</h4>
                    <p style="color: #95a5a6; font-size: 0.9rem; margin-bottom: 1rem;">
                        <strong>Best for:</strong> Complete backups, restoring to same or different device<br>
                        <strong>Format:</strong> Single JSON file containing all data<br>
                        <strong>Size:</strong> Smallest file size, optimized for storage
                    </p>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button class="btn" onclick="exportFullBackupJSON()" style="background: #2ecc71;">
                            <i class="fas fa-download"></i> Export JSON Backup
                        </button>
                        <button class="btn" onclick="importFullBackupJSON()" style="background: #3498db;">
                            <i class="fas fa-upload"></i> Import JSON Backup
                        </button>
                    </div>
                </div>
                <div class="box mt-4" style="background: #2c3e50; padding: 1.5rem;">
                    <h4 style="color: #2ecc71; margin: 0 0 1rem 0;"><i class="fas fa-file-csv"></i> Method 2: CSV Backup (Human-Readable)</h4>
                    <p style="color: #95a5a6; font-size: 0.9rem; margin-bottom: 1rem;">
                        <strong>Best for:</strong> Viewing data in Excel/Sheets, data analysis, easy inspection<br>
                        <strong>Format:</strong> Multiple CSV files (pipe-delimited) in a ZIP archive<br>
                        <strong>Size:</strong> Larger file size, but readable in any spreadsheet program
                    </p>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button class="btn" onclick="exportFullBackupCSV()" style="background: #2ecc71;">
                            <i class="fas fa-download"></i> Export CSV Backup
                        </button>
                        <button class="btn" onclick="importFullBackupCSV()" style="background: #3498db;">
                            <i class="fas fa-upload"></i> Import CSV Backup
                        </button>
                    </div>
                    <p style="margin-top: 0.75rem; font-size: 0.8rem; color: #f39c12;">
                        <i class="fas fa-info-circle"></i> CSV files use pipe delimiter (|) for better compatibility with commas in data
                    </p>
                </div>
                <div class="mt-4" style="padding: 1rem; background: #34495e; border-radius: 6px; border-left: 4px solid #f39c12;">
                    <h4 style="color: #f39c12; margin: 0 0 0.5rem 0;"><i class="fas fa-lightbulb"></i> Backup Best Practices</h4>
                    <ul style="margin: 0; padding-left: 1.5rem; color: #ecf0f1;">
                        <li>Create backups regularly (weekly recommended)</li>
                        <li>Store backups in multiple locations (cloud + local)</li>
                        <li>Always export before making major changes</li>
                        <li>Test restore process periodically to ensure backups work</li>
                        <li>Keep at least 3 recent backups for safety</li>
                    </ul>
                </div>
            </div>
            <div class="box mb-4">
                <h3><i class="fas fa-history"></i> Automated Backup History</h3>
                <p class="mb-2">The system automatically creates backups. View and restore from backup history.</p>
                <button class="btn" onclick="createAutomatedBackup(); showToast('Backup created successfully!', 'success');">Create Backup Now</button>
                <button class="btn secondary" onclick="viewBackupHistory()">View Backup History</button>
            </div>
            <div class="box mb-4">
                <h3><i class="fas fa-chart-pie"></i> Storage Usage Monitor</h3>
                <p class="mb-2">Track your browser's localStorage usage to prevent data loss.</p>
                <div style="padding: 1rem; background: #2c3e50; border-radius: 6px; margin-bottom: 1rem;">
                    <div style="margin-bottom: 0.5rem;">
                        <strong>Used:</strong> <span id="storage-used">0</span> KB / <span id="storage-limit">~5,000</span> KB
                    </div>
                    <div class="vote-progress-bar-bg" style="height: 30px; margin-bottom: 0.5rem;">
                        <div id="storage-progress-bar" class="vote-progress-bar-fill" style="width: 0%; background: linear-gradient(90deg, #27ae60, #2ecc71);"></div>
                    </div>
                    <div id="storage-warning" style="display: none; color: #f39c12; font-weight: bold;">
                        <i class="fas fa-exclamation-triangle"></i> Warning: Storage is over 80% full. Consider exporting and clearing old data.
                    </div>
                    <div id="storage-critical" style="display: none; color: #e74c3c; font-weight: bold;">
                        <i class="fas fa-exclamation-circle"></i> Critical: Storage is nearly full! Export data immediately to prevent loss.
                    </div>
                </div>
                <button class="btn secondary" onclick="checkStorageUsage()">Refresh Storage Info</button>
            </div>
            <div class="box" style="border: 2px solid #e74c3c;">
                <h3 style="color: #e74c3c;"><i class="fas fa-exclamation-triangle"></i> Reset Application</h3>
                <p class="mb-2" style="color: #f39c12;"><strong>Warning:</strong> This will permanently delete ALL data from the application. This action cannot be undone!</p>
                <p class="mb-2">Before resetting, make sure you have exported your data for backup.</p>
                <button class="btn" style="background: #e74c3c; border-color: #c0392b;" onclick="resetApplication()">Reset All Application Data</button>
            </div>
        </section>
        <section id="format-rotation-section" style="border-left: 4px solid #3498db;">
            <h2><i class="fas fa-sync-alt"></i> Meeting Format Rotation</h2>
            <p class="mb-4">Manage automated format rotation patterns for weekly meetings.</p>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box mb-4">
                        <h3>Current Week's Format</h3>
                        <div id="current-format-display" style="padding: 1.5rem; background: #2c3e50; border-radius: 6px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #3498db;" id="current-format-name">Big Book Study</div>
                            <div style="margin-top: 0.5rem; color: #95a5a6;" id="current-format-week">Week of: <span id="current-week-date"></span></div>
                        </div>
                    </div>
                    <div class="box">
                        <h3>Add/Edit Format</h3>
                        <div class="form-group">
                            <label for="format-name">Format Name</label>
                            <input type="text" id="format-name" placeholder="e.g., Big Book Study, Step Study, Speaker Meeting">
                        </div>
                        <div class="form-group">
                            <label for="format-description">Description</label>
                            <textarea id="format-description" rows="2" placeholder="Brief description..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="format-order">Rotation Order</label>
                            <input type="number" id="format-order" min="1" placeholder="1">
                            <small style="font-size: 0.75rem; opacity: 0.8;">Order in the rotation cycle</small>
                        </div>
                        <input type="hidden" id="format-edit-id">
                        <button id="format-form-btn" class="btn" onclick="handleFormatSubmit()">Add Format</button>
                        <button id="format-form-cancel-btn" class="btn secondary" onclick="cancelFormatEdit()" style="display:none; margin-left: 0.5rem;">Cancel</button>
                    </div>
                </div>
                <div>
                    <div class="box">
                        <h3>Format Rotation Schedule</h3>
                        <table id="format-rotation-table">
                            <thead>
                                <tr>
                                    <th>Order</th>
                                    <th>Format</th>
                                    <th>Description</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="format-rotation-body"></tbody>
                        </table>
                    </div>
                    <div class="box mt-4">
                        <h3>Upcoming Formats (Next 8 Weeks)</h3>
                        <div id="upcoming-formats-list"></div>
                    </div>
                </div>
            </div>
        </section>
        <section id="commitment-board-section" style="border-left: 4px solid #3498db;">
            <h2><i class="fas fa-clipboard-check"></i> Meeting Commitment Board</h2>
            <p class="mb-4">Sign-up system for meeting responsibilities with automated reminders.</p>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Sign Up for Commitment</h3>
                        <div class="form-group">
                            <label for="commitment-date">Meeting Date</label>
                            <input type="date" id="commitment-date">
                        </div>
                        <div class="form-group">
                            <label for="commitment-role">Responsibility</label>
                            <select id="commitment-role">
                                <option value="greeter">Greeter</option>
                                <option value="coffee">Coffee Maker</option>
                                <option value="setup">Setup</option>
                                <option value="cleanup">Cleanup</option>
                                <option value="secretary">Secretary</option>
                                <option value="treasurer">Treasurer Report</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="commitment-member">Member Name</label>
                            <select id="commitment-member"></select>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="commitment-reminder" checked>
                                Send reminder notification
                            </label>
                        </div>
                        <input type="hidden" id="commitment-edit-id">
                        <button id="commitment-form-btn" class="btn" onclick="handleCommitmentSubmit()">Sign Up</button>
                        <button id="commitment-form-cancel-btn" class="btn secondary" onclick="cancelCommitmentEdit()" style="display:none; margin-left: 0.5rem;">Cancel</button>
                    </div>
                </div>
                <div>
                    <div class="box">
                        <h3>This Week's Commitments</h3>
                        <div id="current-week-commitments"></div>
                    </div>
                    <div class="box mt-4">
                        <h3>Upcoming Commitments</h3>
                        <table id="commitment-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Role</th>
                                    <th>Member</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="commitment-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
        <section id="secretary-section" style="border-left: 4px solid #3498db;">
            <h2><i class="fas fa-pen"></i> Meeting Secretary Functions</h2>
            <p class="mb-4">Attendance tracking, automated minutes, and meeting statistics.</p>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Take Attendance</h3>
                        <div class="form-group">
                            <label for="attendance-date">Meeting Date</label>
                            <input type="date" id="attendance-date">
                        </div>
                        <div class="form-group">
                            <label for="attendance-members">Members Present</label>
                            <select multiple id="attendance-members" style="height: 200px; background: #34495e; color: #ecf0f1; border: 1px solid #7f8c8d; border-radius: 4px; padding: 0.5rem; width: 100%;"></select>
                            <small style="font-size: 0.75rem; opacity: 0.8;">Hold Ctrl/Cmd to select multiple</small>
                        </div>
                        <div class="form-group">
                            <label for="attendance-visitors">Visitors/Newcomers</label>
                            <input type="number" id="attendance-visitors" min="0" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label for="attendance-oldtimers">Old-Timers (10+ years)</label>
                            <div id="attendance-oldtimers-list"></div>
                        </div>
                        <button class="btn" onclick="handleAttendanceSubmit()">Save Attendance</button>
                    </div>
                </div>
                <div>
                    <div class="box">
                        <h3>Meeting Statistics</h3>
                        <div id="attendance-stats" style="padding: 1rem; background: #2c3e50; border-radius: 6px;">
                            <div class="mb-2"><strong>Average Attendance:</strong> <span id="avg-attendance">0</span></div>
                            <div class="mb-2"><strong>Regular Members:</strong> <span id="regular-members">0</span></div>
                            <div class="mb-2"><strong>This Month's Visitors:</strong> <span id="monthly-visitors">0</span></div>
                            <div class="mb-2"><strong>Recognized Old-Timers:</strong> <span id="oldtimer-count">0</span></div>
                        </div>
                    </div>
                    <div class="box mt-4">
                        <h3>Recent Attendance</h3>
                        <table id="attendance-history-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Members</th>
                                    <th>Visitors</th>
                                    <th>Total</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="attendance-history-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section id="commitment-tracking-section" style="border-left: 4px solid #16a085;">
            <h2><i class="fas fa-tasks"></i> Commitment Tracking</h2>
            <p class="mb-4">Track non-position commitments like making coffee, greeting newcomers, and setting up chairs.</p>

            <div class="box mb-4">
                <h3>Log Commitment</h3>
                <div class="form-group">
                    <label for="commitment-member">Member</label>
                    <select id="commitment-member">
                        <option value="">Select member...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="commitment-type">Commitment Type</label>
                    <select id="commitment-type">
                        <option value="coffee">Make Coffee</option>
                        <option value="greeter">Greeter</option>
                        <option value="setup">Setup/Chairs</option>
                        <option value="cleanup">Cleanup</option>
                        <option value="literature">Literature Table</option>
                        <option value="chips">Chip Distribution</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="commitment-date">Date</label>
                    <input type="date" id="commitment-date" />
                </div>
                <div class="form-group">
                    <label for="commitment-notes">Notes (Optional)</label>
                    <textarea id="commitment-notes" rows="2" placeholder="Any additional notes..."></textarea>
                </div>
                <button class="btn" onclick="logCommitment()"><i class="fas fa-plus"></i> Log Commitment</button>
            </div>

            <div class="box">
                <h3>Recent Commitments</h3>
                <div id="commitment-history"></div>
            </div>

            <div class="box mt-4">
                <h3>Commitment Leaderboard</h3>
                <p style="font-size: 0.9rem; color: #95a5a6; margin-bottom: 1rem;">Members who have stepped up this month</p>
                <div id="commitment-leaderboard"></div>
            </div>
        </section>

        <section id="meeting-feedback-section" style="border-left: 4px solid #3498db;">
            <h2><i class="fas fa-comment-dots"></i> Meeting Format Feedback</h2>
            <p class="mb-4">Anonymous feedback on meeting formats to help improve the group experience.</p>

            <div class="box mb-4">
                <h3>Submit Feedback</h3>
                <div class="form-group">
                    <label for="feedback-meeting-type">Which meeting type?</label>
                    <select id="feedback-meeting-type">
                        <option value="speaker">Speaker Meeting</option>
                        <option value="discussion">Discussion Meeting</option>
                        <option value="step-study">Step Study</option>
                        <option value="big-book">Big Book Study</option>
                        <option value="traditions">Traditions Meeting</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>How would you rate this meeting format?</label>
                    <select id="feedback-rating">
                        <option value="">Select rating...</option>
                        <option value="5">Excellent</option>
                        <option value="4">Good</option>
                        <option value="3">Average</option>
                        <option value="2">Needs Improvement</option>
                        <option value="1">Poor</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>What did you like?</label>
                    <textarea id="feedback-positives" rows="2" placeholder="What worked well..."></textarea>
                </div>
                <div class="form-group">
                    <label>What could be improved?</label>
                    <textarea id="feedback-improvements" rows="2" placeholder="Suggestions for improvement..."></textarea>
                </div>
                <button class="btn" onclick="submitMeetingFeedback()"><i class="fas fa-paper-plane"></i> Submit Anonymously</button>
            </div>

            <div class="box">
                <h3>Feedback Summary</h3>
                <div id="feedback-summary"></div>
            </div>
        </section>

        <section id="speaker-booking-section" style="border-left: 4px solid #9b59b6;">
            <h2><i class="fas fa-microphone"></i> Speaker Meeting Booking</h2>
            <p class="mb-4">Schedule speakers for speaker meetings and manage the speaker rotation.</p>

            <div class="box mb-4">
                <h3>Book a Speaker</h3>
                <div class="form-group">
                    <label for="speaker-name">Speaker Name</label>
                    <input type="text" id="speaker-name" placeholder="Enter speaker name..." />
                </div>
                <div class="form-group">
                    <label for="speaker-date">Meeting Date</label>
                    <input type="date" id="speaker-date" />
                </div>
                <div class="form-group">
                    <label for="speaker-phone">Contact Phone</label>
                    <input type="tel" id="speaker-phone" placeholder="Phone number..." />
                </div>
                <div class="form-group">
                    <label for="speaker-email">Contact Email</label>
                    <input type="email" id="speaker-email" placeholder="Email address..." />
                </div>
                <div class="form-group">
                    <label for="speaker-topic">Topic/Theme (Optional)</label>
                    <input type="text" id="speaker-topic" placeholder="e.g., Step 4, Gratitude..." />
                </div>
                <div class="form-group">
                    <label for="speaker-notes">Notes</label>
                    <textarea id="speaker-notes" rows="2" placeholder="Any special requests or notes..."></textarea>
                </div>
                <button class="btn" onclick="bookSpeaker()"><i class="fas fa-calendar-plus"></i> Book Speaker</button>
            </div>

            <div class="box">
                <h3>Upcoming Speakers</h3>
                <table id="speaker-schedule-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Speaker</th>
                            <th>Topic</th>
                            <th>Contact</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="speaker-schedule-body"></tbody>
                </table>
            </div>
        </section>

        <section id="chip-ceremony-section" style="border-left: 4px solid #f39c12;">
            <h2><i class="fas fa-medal"></i> Chip Ceremony Scheduler</h2>
            <p class="mb-4">Schedule and track sobriety chip celebrations.</p>

            <div class="box mb-4">
                <h3>Schedule Chip Ceremony</h3>
                <div class="form-group">
                    <label for="chip-member">Member</label>
                    <select id="chip-member">
                        <option value="">Select member...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="chip-milestone">Milestone</label>
                    <select id="chip-milestone">
                        <option value="24-hours">24 Hours (White)</option>
                        <option value="30-days">30 Days (White)</option>
                        <option value="60-days">60 Days (White)</option>
                        <option value="90-days">90 Days (Red)</option>
                        <option value="6-months">6 Months (Green)</option>
                        <option value="9-months">9 Months (Gold)</option>
                        <option value="1-year">1 Year (Bronze)</option>
                        <option value="18-months">18 Months</option>
                        <option value="multiple-years">Multiple Years</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="chip-date">Ceremony Date</label>
                    <input type="date" id="chip-date" />
                </div>
                <div class="form-group">
                    <label for="chip-years">Years (if multiple years)</label>
                    <input type="number" id="chip-years" min="1" placeholder="Number of years..." />
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="chip-notify" />
                        Send reminder notification
                    </label>
                </div>
                <button class="btn" onclick="scheduleChipCeremony()"><i class="fas fa-calendar-check"></i> Schedule Ceremony</button>
            </div>

            <div class="box">
                <h3>Upcoming Chip Ceremonies</h3>
                <div id="upcoming-chip-ceremonies"></div>
            </div>

            <div class="box mt-4">
                <h3>Chip Inventory Status</h3>
                <p style="font-size: 0.9rem; color: #95a5a6; margin-bottom: 1rem;">
                    Check chip inventory levels before ceremonies
                </p>
                <button class="btn secondary" onclick="goToSection('chip-inventory-section')">
                    <i class="fas fa-boxes"></i> View Chip Inventory
                </button>
            </div>
        </section>

        <section id="meeting-analytics-section" style="border-left: 4px solid #1abc9c;">
            <h2><i class="fas fa-chart-line"></i> Meeting Attendance Analytics</h2>
            <p class="mb-4">Track which meetings are most popular and identify trends.</p>
            <button class="btn mb-3" onclick="exportAttendanceReportPDF()" style="background: #1abc9c;">
                <i class="fas fa-file-pdf"></i> Export Attendance Report to PDF
            </button>
            <div class="box mb-4">
                <h3>Meeting Popularity</h3>
                <canvas id="meeting-popularity-chart" style="max-height: 300px;"></canvas>
            </div>
            <div class="box">
                <h3>Attendance Trends</h3>
                <div id="attendance-trends"></div>
            </div>
        </section>

        <section id="role-rotation-section" style="border-left: 4px solid #34495e;">
            <h2><i class="fas fa-sync-alt"></i> Meeting Role Rotation Calendar</h2>
            <p class="mb-4">Automatically rotate meeting roles like chairperson, reader, timekeeper.</p>
            <div class="box mb-4">
                <h3>Configure Rotation</h3>
                <div class="form-group">
                    <label for="rotation-role">Role</label>
                    <select id="rotation-role">
                        <option value="chairperson">Chairperson</option>
                        <option value="reader">Reader</option>
                        <option value="timekeeper">Timekeeper</option>
                        <option value="greeter">Greeter</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="rotation-members">Select Members for Rotation</label>
                    <select multiple id="rotation-members" style="height: 150px;"></select>
                </div>
                <button class="btn" onclick="saveRoleRotation()"><i class="fas fa-save"></i> Save Rotation</button>
            </div>
            <div class="box">
                <h3>Upcoming Assignments</h3>
                <div id="role-assignments"></div>
            </div>
        </section>

        <section id="virtual-meeting-section" style="border-left: 4px solid #3498db;">
            <h2><i class="fas fa-video"></i> Virtual Meeting Integration</h2>
            <p class="mb-4">Manage Zoom/hybrid meeting links and settings.</p>
            <div class="box mb-4">
                <h3>Virtual Meeting Setup</h3>
                <div class="form-group">
                    <label for="virtual-meeting-name">Meeting Name</label>
                    <input type="text" id="virtual-meeting-name" placeholder="e.g., Monday Night Speaker" />
                </div>
                <div class="form-group">
                    <label for="virtual-platform">Platform</label>
                    <select id="virtual-platform">
                        <option value="zoom">Zoom</option>
                        <option value="google-meet">Google Meet</option>
                        <option value="teams">Microsoft Teams</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="virtual-meeting-link">Meeting Link</label>
                    <input type="url" id="virtual-meeting-link" placeholder="https://..." />
                </div>
                <div class="form-group">
                    <label for="virtual-meeting-id">Meeting ID (optional)</label>
                    <input type="text" id="virtual-meeting-id" placeholder="123 456 789" />
                </div>
                <div class="form-group">
                    <label for="virtual-meeting-password">Password (optional)</label>
                    <input type="text" id="virtual-meeting-password" placeholder="Meeting password" />
                </div>
                <button class="btn" onclick="saveVirtualMeeting()"><i class="fas fa-save"></i> Save Virtual Meeting</button>
            </div>
            <div class="box">
                <h3>Active Virtual Meetings</h3>
                <div id="virtual-meetings-list"></div>
            </div>
        </section>

        <section id="qr-checkin-section" style="border-left: 4px solid #e74c3c;">
            <h2><i class="fas fa-qrcode"></i> QR Code Check-in</h2>
            <p class="mb-4">Generate QR codes for quick meeting attendance scanning.</p>
            <div class="box mb-4">
                <h3>Generate Meeting QR Code</h3>
                <div class="form-group">
                    <label for="qr-meeting-select">Select Meeting</label>
                    <select id="qr-meeting-select">
                        <option value="">Select meeting...</option>
                    </select>
                </div>
                <button class="btn" onclick="generateMeetingQR()"><i class="fas fa-qrcode"></i> Generate QR Code</button>
            </div>
            <div class="box" id="qr-code-display" style="display: none;">
                <h3>Meeting Check-in QR Code</h3>
                <div style="text-align: center; padding: 2rem;">
                    <canvas id="qr-code-canvas" style="max-width: 300px; margin: 0 auto;"></canvas>
                    <p style="margin-top: 1rem;">Scan this QR code to check in to the meeting</p>
                    <button class="btn secondary" onclick="downloadMeetingQR()"><i class="fas fa-download"></i> Download QR Code</button>
                </div>
            </div>
        </section>

        <section id="gc-live-section" style="border-left: 4px solid #9b59b6;">
            <h2><i class="fas fa-broadcast-tower"></i> Live Group Conscience Session</h2>
            <p class="mb-4">Real-time motion tracking during Group Conscience meetings.</p>
            <div class="box">
                <h3>New Business / Open Motions</h3>
                <div class="form-group">
                    <label for="live-gc-new-item">New Item</label>
                    <textarea id="live-gc-new-item" rows="2" placeholder="Describe the new business item or motion..."></textarea>
                </div>
                <button class="btn" onclick="addLiveGCItem()">Add to Queue</button>
            </div>
            <div class="box mt-4">
                <h3>Active Motions Queue</h3>
                <table id="live-gc-queue-table">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="live-gc-queue-body"></tbody>
                </table>
            </div>
        </section>
        <section id="emergency-gc-section" style="border-left: 4px solid #e74c3c; display: none;">
            <div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); padding: 2rem; border-radius: 8px; margin-bottom: 2rem;">
                <h2 style="color: white; margin: 0 0 0.5rem 0;">
                    <i class="fas fa-exclamation-triangle"></i> EMERGENCY GROUP CONSCIENCE PROTOCOL
                </h2>
                <p style="color: rgba(255,255,255,0.9); margin: 0; font-size: 1.05rem;">
                    For crisis situations requiring immediate group conscience decision
                </p>
            </div>
            <div class="box" style="border-left: 4px solid #e74c3c;">
                <h3><i class="fas fa-clipboard-check"></i> Emergency Classification</h3>
                <p style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 1.5rem;">
                    Select the type of emergency to load the appropriate protocol and checklist
                </p>
                <div class="form-group">
                    <label for="emergency-type">Emergency Type *</label>
                    <select id="emergency-type" onchange="loadEmergencyProtocol(this.value)">
                        <option value="">-- Select Emergency Type --</option>
                        <option value="venue-loss">Venue Loss / Location Crisis</option>
                        <option value="safety-concern">Safety/Security Concern</option>
                        <option value="financial-crisis">Financial Crisis</option>
                        <option value="member-conduct">Serious Member Conduct Issue</option>
                        <option value="legal-issue">Legal/Liability Issue</option>
                        <option value="service-disruption">Critical Service Disruption</option>
                        <option value="other">Other Emergency</option>
                    </select>
                </div>
            </div>
            <div id="emergency-protocol-container" style="display: none;">
                <div class="box" style="border-left: 4px solid #f39c12;">
                    <h3><i class="fas fa-list-check"></i> Emergency Protocol Checklist</h3>
                    <div id="emergency-checklist" style="margin-top: 1rem;">
                    </div>
                </div>
                <div class="box mt-4" style="border-left: 4px solid #e74c3c;">
                    <h3><i class="fas fa-gavel"></i> Emergency Decision Form</h3>
                    <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label for="emergency-facilitator">Emergency Facilitator *</label>
                            <select id="emergency-facilitator"></select>
                        </div>
                        <div class="form-group">
                            <label for="emergency-date">Date/Time *</label>
                            <input type="datetime-local" id="emergency-date">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="emergency-situation">Situation Description *</label>
                        <textarea id="emergency-situation" rows="3" placeholder="Clearly describe the emergency situation..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="emergency-decision">Proposed Emergency Decision/Action *</label>
                        <textarea id="emergency-decision" rows="3" placeholder="What action is being proposed to address the emergency?"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="emergency-rationale">Rationale for Emergency Process *</label>
                        <textarea id="emergency-rationale" rows="2" placeholder="Why must this be handled as an emergency vs. regular GC?"></textarea>
                    </div>
                    <div class="grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="emergency-notification-method">Notification Method *</label>
                            <select id="emergency-notification-method">
                                <option value="phone-tree">Phone Tree</option>
                                <option value="email-blast">Email Blast</option>
                                <option value="text-message">Group Text</option>
                                <option value="in-person">In-Person/Emergency Meeting</option>
                                <option value="combined">Combined Methods</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="emergency-members-reached">Members Reached</label>
                            <input type="number" id="emergency-members-reached" min="0" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label for="emergency-quorum-met">Quorum Met?</label>
                            <select id="emergency-quorum-met">
                                <option value="yes">Yes</option>
                                <option value="no">No</option>
                                <option value="emergency-override">Emergency Override</option>
                            </select>
                        </div>
                    </div>
                    <div style="background: #2c3e50; padding: 1.5rem; border-radius: 4px; margin-top: 1.5rem;">
                        <h4 style="margin-top: 0;"><i class="fas fa-vote-yea"></i> Emergency Vote Results</h4>
                        <div class="grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label for="emergency-votes-for">Votes For</label>
                                <input type="number" id="emergency-votes-for" min="0" value="0">
                            </div>
                            <div class="form-group">
                                <label for="emergency-votes-against">Votes Against</label>
                                <input type="number" id="emergency-votes-against" min="0" value="0">
                            </div>
                            <div class="form-group">
                                <label for="emergency-votes-abstain">Abstentions</label>
                                <input type="number" id="emergency-votes-abstain" min="0" value="0">
                            </div>
                        </div>
                        <div id="emergency-vote-result" style="margin-top: 1rem; padding: 1rem; border-radius: 4px; background: #34495e; font-size: 1.1rem; font-weight: bold; text-align: center;">
                            Enter votes to see result
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 1.5rem;">
                        <label for="emergency-follow-up">Follow-Up Actions Required</label>
                        <textarea id="emergency-follow-up" rows="3" placeholder="What follow-up actions or regular GC review is needed?"></textarea>
                    </div>
                    <div style="background: #f39c12; padding: 1rem; border-radius: 4px; margin: 1.5rem 0;">
                        <i class="fas fa-info-circle"></i> <strong>Important:</strong> Emergency decisions should be reviewed at the next regular GC meeting for final ratification.
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button class="btn secondary" onclick="cancelEmergencyGC()">Cancel</button>
                        <button class="btn" onclick="submitEmergencyGC()" style="background: #e74c3c;">
                            <i class="fas fa-save"></i> Log Emergency Decision
                        </button>
                    </div>
                </div>
            </div>
            <div class="box mt-4">
                <h3><i class="fas fa-history"></i> Emergency GC History</h3>
                <div id="emergency-gc-history" style="min-height: 100px;">
                </div>
            </div>
        </section>
        <section id="gc-decisions-section" style="border-left: 4px solid #9b59b6;">
            <h2><i class="fas fa-gavel"></i> Group Conscience Decision Management</h2>
            <p class="mb-4">Log GC decisions, submit agenda items, track action items, and analyze historical patterns.</p>
            <div class="box mb-4" style="border-left: 4px solid #3498db;">
                <h3 id="gc-form-title"><i class="fas fa-plus-circle"></i> Log Group Conscience Decision</h3>
                <p style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 1.5rem;">Record the outcome of group conscience decisions with full details, workflow tracking, and research periods.</p>
                <div class="form-group" style="background: #34495e; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                    <label for="gc-workflow-status">Motion Workflow Status</label>
                    <select id="gc-workflow-status" onchange="toggleGCWorkflowSections()">
                        <option value="draft">Draft - Motion being prepared</option>
                        <option value="research">Research Period - Members reviewing & asking questions</option>
                        <option value="voting">Ready for Vote - Research complete</option>
                        <option value="decided" selected>Decided - Vote complete</option>
                    </select>
                    <small style="font-size: 0.75rem; opacity: 0.8; display: block; margin-top: 0.5rem;">
                        Select workflow stage to enable appropriate fields below
                    </small>
                </div>
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="gc-date">Meeting Date *</label>
                        <input type="date" id="gc-date">
                    </div>
                    <div class="form-group">
                        <label for="gc-submitted-by">Submitted By</label>
                        <input type="text" id="gc-submitted-by" placeholder="Member name">
                    </div>
                </div>
                <div class="form-group">
                    <label for="gc-item">Motion / Item *</label>
                    <textarea id="gc-item" rows="3" placeholder="Describe the motion clearly..."></textarea>
                </div>
                <div id="gc-research-period-section" style="display: none; background: #2c3e50; padding: 1rem; border-radius: 6px; margin-bottom: 1rem; border-left: 4px solid #3498db;">
                    <h4 style="color: #3498db; margin-bottom: 0.75rem;"><i class="fas fa-search"></i> Research Period Configuration</h4>
                    <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="gc-research-start">Research Period Start Date</label>
                            <input type="date" id="gc-research-start">
                            <small style="font-size: 0.75rem; opacity: 0.8; display: block; margin-top: 0.25rem;">
                                When members can start reviewing and asking questions
                            </small>
                        </div>
                        <div class="form-group">
                            <label for="gc-research-end">Research Period End Date (Vote Date)</label>
                            <input type="date" id="gc-research-end">
                            <small style="font-size: 0.75rem; opacity: 0.8; display: block; margin-top: 0.25rem;">
                                Research ends; vote will occur on this date
                            </small>
                        </div>
                    </div>
                </div>
                <div class="grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="gc-status">Final Decision Status</label>
                        <select id="gc-status">
                            <option value="passed">Passed</option>
                            <option value="failed">Failed</option>
                            <option value="tabled">Tabled</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="gc-votes-for">Votes For</label>
                        <input type="number" id="gc-votes-for" min="0" placeholder="0" oninput="updateVotePercentages()">
                    </div>
                    <div class="form-group">
                        <label for="gc-votes-against">Votes Against</label>
                        <input type="number" id="gc-votes-against" min="0" placeholder="0" oninput="updateVotePercentages()">
                    </div>
                </div>
                <div class="form-group">
                    <label for="gc-votes-abstain">Votes Abstain</label>
                    <input type="number" id="gc-votes-abstain" min="0" placeholder="0" oninput="updateVotePercentages()" style="max-width: 200px;">
                </div>
                <div id="vote-summary" style="padding: 0.75rem; background: #2c3e50; border-radius: 4px; margin-bottom: 0.75rem; font-size: 0.85rem;">
                    <div style="margin-bottom: 0.5rem;"><strong>Total Votes:</strong> <span id="total-votes">0</span></div>
                    <div class="vote-progress-container">
                        <div class="vote-progress-item">
                            <div class="vote-progress-label">
                                <span><strong>For:</strong> <span id="votes-for-count">0</span></span>
                                <span id="percent-for">0%</span>
                            </div>
                            <div class="vote-progress-bar-bg">
                                <div id="progress-bar-for" class="vote-progress-bar-fill for" style="width: 0%;"></div>
                            </div>
                        </div>
                        <div class="vote-progress-item">
                            <div class="vote-progress-label">
                                <span><strong>Against:</strong> <span id="votes-against-count">0</span></span>
                                <span id="percent-against">0%</span>
                            </div>
                            <div class="vote-progress-bar-bg">
                                <div id="progress-bar-against" class="vote-progress-bar-fill against" style="width: 0%;"></div>
                            </div>
                        </div>
                        <div class="vote-progress-item">
                            <div class="vote-progress-label">
                                <span><strong>Abstain:</strong> <span id="votes-abstain-count">0</span></span>
                                <span id="percent-abstain">0%</span>
                            </div>
                            <div class="vote-progress-bar-bg">
                                <div id="progress-bar-abstain" class="vote-progress-bar-fill abstain" style="width: 0%;"></div>
                            </div>
                        </div>
                    </div>
                    <div id="quorum-status" style="margin-top: 0.5rem;"></div>
                </div>
                <div class="form-group">
                    <label for="gc-attendees">Members Present</label>
                    <select multiple id="gc-attendees" style="height: 120px; background: #34495e; color: #ecf0f1; border: 1px solid #7f8c8d; border-radius: 4px; padding: 0.5rem; width: 100%;" onchange="updateVotePercentages()"></select>
                    <small style="font-size: 0.75rem; opacity: 0.8;">Hold Ctrl/Cmd to select multiple members</small>
                </div>
                <div class="form-group">
                    <label>Servant Reports</label>
                    <div id="gc-servant-reports-container">
                    </div>
                    <div id="gc-servant-reports-legacy-container" style="display: none;">
                        <label for="gc-servant-reports-legacy">Legacy Reports (read-only)</label>
                        <textarea id="gc-servant-reports-legacy" rows="4" readonly></textarea>
                    </div>
                </div>
                <div id="gc-amendments-section" style="background: #34495e; padding: 1rem; border-radius: 6px; margin: 1rem 0; border-left: 4px solid #f39c12;">
                    <h4 style="color: #f39c12; margin-bottom: 0.75rem;"><i class="fas fa-edit"></i> Motion Amendments</h4>
                    <p style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 1rem;">Propose changes to the main motion before voting</p>
                    <div class="form-group">
                        <label for="amendment-text">Amendment Text *</label>
                        <textarea id="amendment-text" rows="2" placeholder="Proposed amendment to the motion..."></textarea>
                    </div>
                    <div class="grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="amendment-type">Amendment Type</label>
                            <select id="amendment-type">
                                <option value="friendly">Friendly - Accepted by maker</option>
                                <option value="unfriendly">Unfriendly - Requires vote</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="amendment-proposer">Proposed By</label>
                            <input type="text" id="amendment-proposer" placeholder="Member name">
                        </div>
                        <div class="form-group">
                            <label for="amendment-status">Status</label>
                            <select id="amendment-status">
                                <option value="proposed">Proposed</option>
                                <option value="accepted">Accepted</option>
                                <option value="rejected">Rejected</option>
                                <option value="withdrawn">Withdrawn</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn" onclick="addAmendment()" style="background: #f39c12;">
                        <i class="fas fa-plus"></i> Add Amendment
                    </button>
                    <div id="amendments-list" style="margin-top: 1rem;"></div>
                </div>
                <div id="gc-discussion-section" style="background: #34495e; padding: 1rem; border-radius: 6px; margin: 1rem 0; border-left: 4px solid #3498db;">
                    <h4 style="color: #3498db; margin-bottom: 0.75rem;"><i class="fas fa-comments"></i> Discussion & Questions</h4>
                    <p style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 1rem;">Members can post questions and comments during research period</p>
                    <div class="form-group">
                        <label for="discussion-comment">Your Comment/Question</label>
                        <textarea id="discussion-comment" rows="3" placeholder="Post a question or comment about this motion..."></textarea>
                    </div>
                    <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="discussion-author">Your Name</label>
                            <select id="discussion-author"></select>
                        </div>
                        <div class="form-group">
                            <label for="discussion-type">Type</label>
                            <select id="discussion-type">
                                <option value="question">Question</option>
                                <option value="comment">Comment</option>
                                <option value="concern">Concern</option>
                                <option value="support">Support</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn" onclick="addDiscussionComment()" style="background: #3498db;">
                        <i class="fas fa-paper-plane"></i> Post Comment
                    </button>
                    <h5 style="margin-top: 1.5rem; margin-bottom: 0.75rem;">Discussion Thread</h5>
                    <div id="discussion-thread" style="max-height: 400px; overflow-y: auto;"></div>
                </div>
                <div id="gc-table-motion-section" style="background: #34495e; padding: 1rem; border-radius: 6px; margin: 1rem 0; border-left: 4px solid #e74c3c;">
                    <h4 style="color: #e74c3c; margin-bottom: 0.75rem;"><i class="fas fa-pause-circle"></i> Table Motion</h4>
                    <p style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 1rem;">Postpone this motion to a future GC meeting</p>
                    <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="table-until-date">Table Until Date *</label>
                            <input type="date" id="table-until-date">
                            <small style="font-size: 0.75rem; opacity: 0.8;">Will automatically appear on agenda for this date</small>
                        </div>
                        <div class="form-group">
                            <label for="table-reason">Reason for Tabling</label>
                            <select id="table-reason">
                                <option value="need-info">Need More Information</option>
                                <option value="need-research">Need Research Period</option>
                                <option value="waiting-report">Waiting for Report/Data</option>
                                <option value="timing">Timing Not Right</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="table-notes">Notes</label>
                        <textarea id="table-notes" rows="2" placeholder="What needs to happen before we revisit this?"></textarea>
                    </div>
                    <div style="padding: 1rem; background: #e74c3c; border-radius: 4px; margin-top: 1rem;">
                        <i class="fas fa-info-circle"></i> <strong>Note:</strong> Tabling will set status to "Tabled" and auto-add to future agenda
                    </div>
                </div>
                <input type="hidden" id="gc-edit-id">
                <input type="hidden" id="gc-amendments-data">
                <input type="hidden" id="gc-discussion-data">
                <input type="hidden" id="gc-tabled-data">
                <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                    <button id="gc-form-btn" class="btn" onclick="handleGCLogSubmit()">
                        <i class="fas fa-save"></i> Add GC Entry
                    </button>
                    <button id="gc-form-cancel-btn" class="btn secondary" onclick="cancelGCEdit()" style="display:none;">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button class="btn" onclick="exportGroupConscienceLogToPDF()" style="background: #9b59b6;">
                        <i class="fas fa-file-pdf"></i> Export GC Log
                    </button>
                </div>
            </div>
            <div class="box mb-4">
                <h3><i class="fas fa-list"></i> Current Month's Group Conscience</h3>
                <div style="overflow-x: auto; margin-top: 1rem;">
                    <table id="gc-log-table-current">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Item</th>
                                <th>Submitted By</th>
                                <th>Status</th>
                                <th>Votes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="gc-log-body-current"></tbody>
                    </table>
                </div>
            </div>
            <div class="box mb-4">
                <h3><i class="fas fa-history"></i> Previous Months' Group Conscience</h3>
                <div style="overflow-x: auto; margin-top: 1rem;">
                    <table id="gc-log-table-previous">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Item</th>
                                <th>Submitted By</th>
                                <th>Status</th>
                                <th>Votes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="gc-log-body-previous"></tbody>
                    </table>
                </div>
            </div>
            <div class="box mb-4" style="border-left: 4px solid #f39c12;">
                <h3><i class="fas fa-calendar-alt"></i> Pre-GC Agenda Submissions</h3>
                <p class="mb-3" style="font-size: 0.85rem; opacity: 0.8;">
                    Collaborative agenda building - Submit items 7 days before meeting for member review
                </p>
                <div id="agenda-submission-notice" style="display: none; padding: 1rem; background: #f39c12; border-radius: 4px; margin-bottom: 1rem;">
                    <i class="fas fa-info-circle"></i> <span id="agenda-notice-text"></span>
                </div>
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="proposed-item-title">Item Title *</label>
                        <input type="text" id="proposed-item-title" placeholder="Brief title for the item">
                    </div>
                    <div class="form-group">
                        <label for="proposed-item-submitter">Submitted By *</label>
                        <select id="proposed-item-submitter">
                            <option value="">Select your name...</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="proposed-item-description">Description & Rationale *</label>
                    <textarea id="proposed-item-description" rows="3" placeholder="Detailed description and why this is important..."></textarea>
                </div>
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="proposed-item-time">Estimated Time (minutes)</label>
                        <input type="number" id="proposed-item-time" min="5" max="60" value="15" placeholder="15">
                        <small style="font-size: 0.75rem; opacity: 0.8;">How long will this discussion need?</small>
                    </div>
                    <div class="form-group">
                        <label for="proposed-item-urgency">Urgency</label>
                        <select id="proposed-item-urgency">
                            <option value="low">Low - Can wait</option>
                            <option value="medium" selected>Medium - Should discuss soon</option>
                            <option value="high">High - Time-sensitive</option>
                            <option value="urgent">Urgent - Immediate attention needed</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="proposed-item-background">Background Materials / Context</label>
                    <textarea id="proposed-item-background" rows="3" placeholder="Any relevant history, prior discussions, research, or supporting information..."></textarea>
                    <small style="font-size: 0.75rem; opacity: 0.8;">Help members make informed decisions</small>
                </div>
                <button class="btn" onclick="addProposedAgendaItem()">
                    <i class="fas fa-paper-plane"></i> Submit Agenda Item
                </button>
                <div style="margin-top: 2rem; display: flex; justify-content: space-between; align-items: center;">
                    <h4 style="margin: 0;">Proposed Agenda Items</h4>
                    <button class="btn" onclick="viewAgendaSummaryForUpcomingMeeting()" style="background: #9b59b6;">
                        <i class="fas fa-clipboard-list"></i> Generate Agenda
                    </button>
                </div>
                <div style="overflow-x: auto; margin-top: 1rem;">
                    <table id="proposed-agenda-table">
                        <thead>
                            <tr>
                                <th>Urgency</th>
                                <th>Title</th>
                                <th>Submitter</th>
                                <th>Time</th>
                                <th>Interest</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="proposed-agenda-body"></tbody>
                    </table>
                </div>
            </div>
            <div class="box mb-4" style="border-left: 4px solid #9b59b6;">
                <h3><i class="fas fa-redo-alt"></i> Standing/Recurring Agenda Items</h3>
                <p class="mb-3" style="font-size: 0.85rem; opacity: 0.8;">
                    Configure items that automatically appear on agendas (monthly reports, quarterly inventory, annual elections)
                </p>
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="standing-item-title">Item Title *</label>
                        <input type="text" id="standing-item-title" placeholder="e.g., Treasurer Report">
                    </div>
                    <div class="form-group">
                        <label for="standing-item-frequency">Frequency *</label>
                        <select id="standing-item-frequency">
                            <option value="monthly">Monthly - Every month</option>
                            <option value="quarterly">Quarterly - Every 3 months</option>
                            <option value="semi-annual">Semi-Annual - Every 6 months</option>
                            <option value="annual">Annual - Once per year</option>
                            <option value="first-meeting">First Meeting of Month</option>
                            <option value="last-meeting">Last Meeting of Month</option>
                        </select>
                    </div>
                </div>
                <div class="grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="standing-item-time">Estimated Time (min)</label>
                        <input type="number" id="standing-item-time" min="5" max="60" value="10" placeholder="10">
                    </div>
                    <div class="form-group">
                        <label for="standing-item-assignee">Assignee/Presenter</label>
                        <select id="standing-item-assignee">
                            <option value="">None</option>
                            <option value="Treasurer">Treasurer</option>
                            <option value="Secretary">Secretary</option>
                            <option value="GSR">GSR</option>
                            <option value="Chairperson">Chairperson</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="standing-item-consent">Consent Agenda?</label>
                        <select id="standing-item-consent">
                            <option value="no">No - Full discussion</option>
                            <option value="yes">Yes - Consent agenda</option>
                        </select>
                        <small style="font-size: 0.7rem; opacity: 0.7;">Consent = routine, approved without discussion</small>
                    </div>
                </div>
                <div class="form-group">
                    <label for="standing-item-description">Description</label>
                    <textarea id="standing-item-description" rows="2" placeholder="Brief description of this recurring item..."></textarea>
                </div>
                <button class="btn" onclick="addStandingAgendaItem()">
                    <i class="fas fa-plus"></i> Add Standing Item
                </button>
                <h4 class="mt-4">Active Standing Items</h4>
                <div style="overflow-x: auto; margin-top: 1rem;">
                    <table>
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Frequency</th>
                                <th>Assignee</th>
                                <th>Time</th>
                                <th>Consent</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="standing-items-body"></tbody>
                    </table>
                </div>
            </div>
            <div class="box mb-4" style="border-left: 4px solid #e74c3c;">
                <h3><i class="fas fa-tasks"></i> Action Items & Follow-Up</h3>
                <p class="mb-3" style="font-size: 0.85rem; opacity: 0.8;">Track action items with accountability, dependencies, and automatic reminders</p>
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="action-item-description">Action Item *</label>
                        <textarea id="action-item-description" rows="2" placeholder="What needs to be done?"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="action-item-assignee">Assigned To *</label>
                        <select id="action-item-assignee"></select>
                    </div>
                    <div class="form-group">
                        <label for="action-item-due-date">Due Date *</label>
                        <input type="date" id="action-item-due-date">
                    </div>
                    <div class="form-group">
                        <label for="action-item-priority">Priority</label>
                        <select id="action-item-priority">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="action-item-related-gc">Related GC Motion</label>
                        <select id="action-item-related-gc">
                            <option value="">None</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="action-item-dependencies">Dependencies (Optional)</label>
                        <select id="action-item-dependencies" multiple style="height: 60px;">
                            <option value="">None - select other action items this depends on</option>
                        </select>
                    </div>
                </div>
                <input type="hidden" id="action-item-edit-id">
                <div style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button id="action-item-btn" class="btn" onclick="handleActionItemSubmit()">
                        <i class="fas fa-plus"></i> Add Action Item
                    </button>
                    <button id="action-item-cancel-btn" class="btn secondary" onclick="cancelActionItemEdit()" style="display:none;">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button class="btn" onclick="viewActionItemReport()" style="background: #9b59b6;">
                        <i class="fas fa-chart-bar"></i> Accountability Report
                    </button>
                </div>
                <div style="margin-top: 2rem; display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                    <h4 style="margin: 0;">Action Items</h4>
                    <div style="flex: 1;"></div>
                    <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
                        <input type="checkbox" id="action-item-show-completed" onchange="updateActionItemsTable()"> Show Completed
                    </label>
                    <select id="action-item-filter-assignee" onchange="updateActionItemsTable()" style="background: #34495e; color: #ecf0f1; border: 1px solid #7f8c8d; border-radius: 4px; padding: 0.5rem;">
                        <option value="">All Assignees</option>
                    </select>
                </div>
                <div style="overflow-x: auto; margin-top: 1rem;">
                    <table id="action-items-table">
                        <thead>
                            <tr>
                                <th>Priority</th>
                                <th>Item</th>
                                <th>Assigned To</th>
                                <th>Due Date</th>
                                <th>Progress</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="action-items-body"></tbody>
                    </table>
                </div>
            </div>
            <div class="box mb-4" style="border-left: 4px solid #1abc9c;">
                <h3><i class="fas fa-clipboard-check"></i> Decision Implementation Tracking</h3>
                <p class="mb-3" style="font-size: 0.85rem; opacity: 0.8;">
                    Track the full lifecycle of decisions from approval through implementation to outcomes
                </p>
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="impl-decision">Decision to Track *</label>
                        <select id="impl-decision" onchange="loadDecisionForImplementation()">
                            <option value="">Select a passed decision...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="impl-status">Implementation Status *</label>
                        <select id="impl-status">
                            <option value="planned">Planned - Not started</option>
                            <option value="in-progress">In Progress - Currently implementing</option>
                            <option value="completed">Completed - Fully implemented</option>
                            <option value="delayed">Delayed - Behind schedule</option>
                            <option value="blocked">Blocked - Cannot proceed</option>
                            <option value="abandoned">Abandoned - Decision reversed</option>
                        </select>
                    </div>
                </div>
                <div class="grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="impl-start-date">Start Date</label>
                        <input type="date" id="impl-start-date">
                    </div>
                    <div class="form-group">
                        <label for="impl-target-date">Target Completion Date</label>
                        <input type="date" id="impl-target-date">
                    </div>
                    <div class="form-group">
                        <label for="impl-actual-date">Actual Completion Date</label>
                        <input type="date" id="impl-actual-date">
                    </div>
                </div>
                <div class="form-group">
                    <label for="impl-progress">Progress (%)</label>
                    <input type="range" id="impl-progress" min="0" max="100" value="0" oninput="document.getElementById('impl-progress-value').textContent = this.value + '%'">
                    <div style="text-align: center; margin-top: 0.5rem;">
                        <strong id="impl-progress-value">0%</strong>
                    </div>
                </div>
                <div class="form-group">
                    <label for="impl-milestones">Milestones/Steps Completed</label>
                    <textarea id="impl-milestones" rows="3" placeholder="List key milestones and checkpoints achieved..."></textarea>
                </div>
                <div class="form-group">
                    <label for="impl-challenges">Challenges/Blockers</label>
                    <textarea id="impl-challenges" rows="2" placeholder="Any obstacles or issues encountered..."></textarea>
                </div>
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="impl-outcome">Outcome Assessment</label>
                        <select id="impl-outcome">
                            <option value="">Not yet assessed</option>
                            <option value="exceeded">Exceeded Expectations</option>
                            <option value="met">Met Expectations</option>
                            <option value="partial">Partially Met Expectations</option>
                            <option value="below">Below Expectations</option>
                            <option value="failed">Failed to Achieve Goal</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="impl-owner">Implementation Owner</label>
                        <select id="impl-owner"></select>
                    </div>
                </div>
                <button class="btn" onclick="saveDecisionImplementation()">
                    <i class="fas fa-save"></i> Save Implementation Update
                </button>
                <h4 class="mt-4">Implementation Status Dashboard</h4>
                <div style="overflow-x: auto; margin-top: 1rem;">
                    <table>
                        <thead>
                            <tr>
                                <th>Decision</th>
                                <th>Status</th>
                                <th>Progress</th>
                                <th>Owner</th>
                                <th>Target Date</th>
                                <th>Outcome</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="implementation-tracking-body"></tbody>
                    </table>
                </div>
            </div>
            <div class="box mb-4" style="border-left: 4px solid #3498db;">
                <h3><i class="fas fa-user-check"></i> Member Voting History</h3>
                <p class="mb-3" style="font-size: 0.85rem; opacity: 0.8;">
                    Track individual member participation and voting patterns for accountability
                </p>
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="voting-history-member">Select Member *</label>
                        <select id="voting-history-member" onchange="loadMemberVotingHistory()"></select>
                    </div>
                    <div class="form-group">
                        <label for="voting-history-period">Time Period</label>
                        <select id="voting-history-period" onchange="loadMemberVotingHistory()">
                            <option value="30">Last 30 Days</option>
                            <option value="90" selected>Last 90 Days</option>
                            <option value="180">Last 6 Months</option>
                            <option value="365">Last Year</option>
                            <option value="all">All Time</option>
                        </select>
                    </div>
                </div>
                <div id="member-voting-stats" style="display: none; padding: 1.5rem; background: #2c3e50; border-radius: 6px; margin-top: 1rem;">
                    <h4 style="margin-bottom: 1rem; color: #3498db;">Participation Statistics</h4>
                    <div class="grid" style="grid-template-columns: repeat(4, 1fr); gap: 1rem; text-align: center;">
                        <div>
                            <div style="font-size: 2rem; font-weight: bold; color: #2ecc71;" id="votes-participated">0</div>
                            <div style="font-size: 0.85rem; opacity: 0.8;">Votes Participated</div>
                        </div>
                        <div>
                            <div style="font-size: 2rem; font-weight: bold; color: #3498db;" id="votes-for-total">0</div>
                            <div style="font-size: 0.85rem; opacity: 0.8;">Voted For</div>
                        </div>
                        <div>
                            <div style="font-size: 2rem; font-weight: bold; color: #e74c3c;" id="votes-against-total">0</div>
                            <div style="font-size: 0.85rem; opacity: 0.8;">Voted Against</div>
                        </div>
                        <div>
                            <div style="font-size: 2rem; font-weight: bold; color: #95a5a6;" id="votes-abstain-total">0</div>
                            <div style="font-size: 0.85rem; opacity: 0.8;">Abstained</div>
                        </div>
                    </div>
                    <div style="margin-top: 1.5rem;">
                        <strong>Participation Rate:</strong> <span id="participation-rate">0%</span>
                    </div>
                </div>
                <h4 class="mt-4">Voting Record</h4>
                <div style="overflow-x: auto; margin-top: 1rem;">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Motion</th>
                                <th>Vote</th>
                                <th>Result</th>
                                <th>Consensus</th>
                            </tr>
                        </thead>
                        <tbody id="member-voting-history-body"></tbody>
                    </table>
                </div>
            </div>
            <div class="box mb-4" style="border-left: 4px solid #2ecc71;">
                <h3><i class="fas fa-check-double"></i> Consent Agenda</h3>
                <p class="mb-3" style="font-size: 0.85rem; opacity: 0.8;">
                    Batch-approve routine items in one vote to save time (any item can be pulled for discussion)
                </p>
                <div style="padding: 1rem; background: #27ae60; border-radius: 4px; margin-bottom: 1rem;">
                    <i class="fas fa-info-circle"></i> <strong>How it works:</strong> Members review all items. If no objections, approve all at once. Any member can request discussion on specific items.
                </div>
                <h4>Items for Next Consent Agenda</h4>
                <div style="overflow-x: auto; margin-top: 1rem;">
                    <table>
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" id="consent-select-all" onchange="toggleAllConsentItems()">
                                </th>
                                <th>Item</th>
                                <th>Type</th>
                                <th>Submitter</th>
                                <th>Pull for Discussion?</th>
                            </tr>
                        </thead>
                        <tbody id="consent-agenda-body"></tbody>
                    </table>
                </div>
                <div style="margin-top: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button class="btn" onclick="approveConsentAgenda()" style="background: #2ecc71;">
                        <i class="fas fa-check"></i> Approve All Consent Items
                    </button>
                    <button class="btn" onclick="pullConsentItems()" style="background: #f39c12;">
                        <i class="fas fa-hand-paper"></i> Pull Selected for Discussion
                    </button>
                    <button class="btn" onclick="refreshConsentAgenda()">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                </div>
                <h4 class="mt-4">Previously Approved via Consent</h4>
                <div id="consent-history" style="font-size: 0.9rem; opacity: 0.9; margin-top: 1rem;"></div>
            </div>
            <div class="box mb-4" style="border-left: 4px solid #2ecc71;">
                <h3><i class="fas fa-search-plus"></i> Enhanced Decision Search & Smart Filtering</h3>
                <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                    <div class="form-group">
                        <label for="gc-search">Search GC History</label>
                        <input type="text" id="gc-search" placeholder="Search by motion, submitter, keywords, tags..." oninput="searchGCHistory()">
                    </div>
                    <div class="form-group">
                        <label for="gc-filter-status">Filter by Status</label>
                        <select id="gc-filter-status" onchange="searchGCHistory()">
                            <option value="">All</option>
                            <option value="passed">Passed</option>
                            <option value="failed">Failed</option>
                            <option value="tabled">Tabled</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="gc-filter-category">Category</label>
                        <select id="gc-filter-category" onchange="searchGCHistory()">
                            <option value="">All Categories</option>
                            <option value="financial">Financial</option>
                            <option value="service">Service</option>
                            <option value="meeting">Meeting</option>
                            <option value="property">Property</option>
                            <option value="traditions">Traditions</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="gc-filter-date-from">From Date</label>
                        <input type="date" id="gc-filter-date-from" onchange="searchGCHistory()">
                    </div>
                    <div class="form-group">
                        <label for="gc-filter-date-to">To Date</label>
                        <input type="date" id="gc-filter-date-to" onchange="searchGCHistory()">
                    </div>
                    <div class="form-group">
                        <label for="gc-filter-submitter">Submitted By</label>
                        <select id="gc-filter-submitter" onchange="searchGCHistory()">
                            <option value="">All Submitters</option>
                        </select>
                    </div>
                </div>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem;">
                    <button class="btn" onclick="searchGCHistory()" style="background: #2ecc71;">
                        <i class="fas fa-search"></i> Search
                    </button>
                    <button class="btn" onclick="clearGCSearch()">
                        <i class="fas fa-eraser"></i> Clear Filters
                    </button>
                    <button class="btn" onclick="showRelatedDecisions()" style="background: #3498db;">
                        <i class="fas fa-link"></i> Find Related Decisions
                    </button>
                    <button class="btn" onclick="exportSearchResults()" style="background: #9b59b6;">
                        <i class="fas fa-download"></i> Export Results
                    </button>
                </div>
                <div id="search-suggestions" style="display: none; padding: 1rem; background: #3498db; border-radius: 4px; margin-bottom: 1rem;">
                    <strong><i class="fas fa-lightbulb"></i> Similar Decisions Found:</strong>
                    <div id="suggestions-list" style="margin-top: 0.5rem;"></div>
                </div>
                <h4 class="mt-3">Search Results</h4>
                <div style="overflow-x: auto;">
                    <table id="gc-history-search-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Motion</th>
                                <th>Status</th>
                                <th>Votes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="gc-history-search-body"></tbody>
                    </table>
                </div>
                <h4 class="mt-4">Quick Statistics</h4>
                <div id="gc-stats" style="padding: 1rem; background: #2c3e50; border-radius: 6px; margin-bottom: 1.5rem;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                        <div>
                            <strong style="color: #3498db;">Total Motions:</strong>
                            <div id="stat-total-motions" style="font-size: 1.5rem;">0</div>
                        </div>
                        <div>
                            <strong style="color: #2ecc71;">Passed:</strong>
                            <div id="stat-passed-motions" style="font-size: 1.5rem;">0</div>
                        </div>
                        <div>
                            <strong style="color: #e74c3c;">Failed:</strong>
                            <div id="stat-failed-motions" style="font-size: 1.5rem;">0</div>
                        </div>
                        <div>
                            <strong style="color: #f39c12;">Tabled:</strong>
                            <div id="stat-tabled-motions" style="font-size: 1.5rem;">0</div>
                        </div>
                        <div>
                            <strong style="color: #3498db;">Pass Rate:</strong>
                            <div id="stat-pass-rate" style="font-size: 1.5rem;">0%</div>
                        </div>
                    </div>
                </div>
                <h4 class="mt-4"><i class="fas fa-chart-bar"></i> Group Conscience Trends & Analysis</h4>
                <div class="trends-grid">
                    <div class="trend-chart-container">
                        <h4>Monthly Motion Activity</h4>
                        <div style="position: relative; height: 250px;">
                            <canvas id="gc-trends-monthly-chart"></canvas>
                        </div>
                    </div>
                    <div class="trend-chart-container">
                        <h4>Pass/Fail/Tabled Distribution</h4>
                        <div style="position: relative; height: 250px;">
                            <canvas id="gc-trends-status-chart"></canvas>
                        </div>
                    </div>
                    <div class="trend-chart-container">
                        <h4>Voting Participation Trend</h4>
                        <div style="position: relative; height: 250px;">
                            <canvas id="gc-trends-participation-chart"></canvas>
                        </div>
                    </div>
                    <div class="trend-chart-container">
                        <h4>Top Motion Topics (Keywords)</h4>
                        <div id="gc-top-topics" style="padding: 1rem; max-height: 250px; overflow-y: auto;">
                        </div>
                    </div>
                </div>
                <h4 class="mt-4"><i class="fas fa-file-pdf"></i> Annual Summary Report</h4>
                <div style="padding: 1rem; background: #2c3e50; border-radius: 6px;">
                    <div class="form-group">
                        <label for="annual-report-year">Select Year</label>
                        <select id="annual-report-year" style="max-width: 200px;">
                        </select>
                    </div>
                    <button class="btn" onclick="generateAnnualReport()">
                        <i class="fas fa-file-pdf"></i> Generate Annual PDF Report
                    </button>
                    <button class="btn secondary" onclick="refreshGCTrends()" style="margin-left: 0.5rem;">
                        <i class="fas fa-sync"></i> Refresh Charts
                    </button>
                </div>
            </div>
            <h3 class="mt-4"><i class="fas fa-link"></i> Motion Relationships & History</h3>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Search Decisions</h3>
                        <div class="form-group">
                            <label for="gc-search">Search by keyword, topic, or date</label>
                            <input type="text" id="gc-search" placeholder="Search decisions...">
                        </div>
                        <div class="form-group">
                            <label for="gc-filter-status">Filter by Status</label>
                            <select id="gc-filter-status">
                                <option value="all">All Decisions</option>
                                <option value="passed">Passed</option>
                                <option value="failed">Failed</option>
                                <option value="tabled">Tabled</option>
                                <option value="amended">Amended</option>
                                <option value="superseded">Superseded</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="gc-filter-year">Filter by Year</label>
                            <select id="gc-filter-year">
                                <option value="all">All Years</option>
                            </select>
                        </div>
                        <button class="btn" onclick="searchGCDecisions()">Search</button>
                    </div>
                    <div class="box mt-4">
                        <h3>Link Related Motions</h3>
                        <div class="form-group">
                            <label for="gc-link-primary">Primary Motion</label>
                            <select id="gc-link-primary"></select>
                        </div>
                        <div class="form-group">
                            <label for="gc-link-related">Related Motion</label>
                            <select id="gc-link-related"></select>
                        </div>
                        <div class="form-group">
                            <label for="gc-link-type">Relationship Type</label>
                            <select id="gc-link-type">
                                <option value="amends">Amends</option>
                                <option value="supersedes">Supersedes</option>
                                <option value="related">Related To</option>
                                <option value="implements">Implements</option>
                            </select>
                        </div>
                        <button class="btn" onclick="linkGCMotions()">Link Motions</button>
                    </div>
                </div>
                <div>
                    <div class="box">
                        <h3>Decision History</h3>
                        <div id="gc-decisions-list" style="max-height: 600px; overflow-y: auto;"></div>
                    </div>
                    <div class="box mt-4">
                        <h3>Motion Chain Viewer</h3>
                        <p style="font-size: 0.85rem; margin-bottom: 1rem;">Click any motion to view its full history chain</p>
                        <div id="motion-chain-display" style="padding: 1rem; background: #2c3e50; border-radius: 6px;"></div>
                    </div>
                </div>
            </div>

            <div class="box mb-4" style="border-left: 4px solid #f39c12;">
                <h3><i class="fas fa-hand-holding-up"></i> Take from the Table</h3>
                <p class="mb-3" style="font-size: 0.85rem; opacity: 0.8;">
                    Resume discussion of previously tabled motions
                </p>
                <div style="padding: 1rem; background: #f39c12; border-radius: 4px; margin-bottom: 1.5rem;">
                    <i class="fas fa-info-circle"></i> <strong>Roberts Rules:</strong> "Take from the Table" allows the group to resume discussion of a motion that was previously tabled. Requires majority vote. Must be done in the same session or next meeting.
                </div>
                <div style="overflow-x: auto; margin-top: 1rem;">
                    <table>
                        <thead>
                            <tr>
                                <th>Date Tabled</th>
                                <th>Motion</th>
                                <th>Proposed By</th>
                                <th>Days Tabled</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tabled-motions-body"></tbody>
                    </table>
                </div>
                <div id="no-tabled-motions" style="padding: 2rem; text-align: center; opacity: 0.6;">
                    <i class="fas fa-check-circle" style="font-size: 2rem; color: #2ecc71;"></i>
                    <div style="margin-top: 1rem;">No tabled motions - all items resolved</div>
                </div>
            </div>

            <div class="box mb-4" style="border-left: 4px solid #e74c3c;">
                <h3><i class="fas fa-gavel"></i> Chair's Rulings Log</h3>
                <p class="mb-3" style="font-size: 0.85rem; opacity: 0.8;">
                    Track chair's procedural decisions and any appeals
                </p>
                <div style="padding: 1rem; background: #e74c3c; border-radius: 4px; margin-bottom: 1.5rem;">
                    <i class="fas fa-info-circle"></i> <strong>Roberts Rules:</strong> The chair makes rulings on procedural questions. Any member can appeal a ruling (requires second). If appealed, the assembly votes to sustain or overturn the ruling (majority vote).
                </div>
                <div style="overflow-x: auto; margin-top: 1rem;">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Question/Issue</th>
                                <th>Chair's Ruling</th>
                                <th>Appealed?</th>
                                <th>Appeal Result</th>
                            </tr>
                        </thead>
                        <tbody id="chair-rulings-body"></tbody>
                    </table>
                </div>
                <div id="no-chair-rulings" style="padding: 2rem; text-align: center; opacity: 0.6;">
                    <i class="fas fa-check-circle" style="font-size: 2rem; color: #2ecc71;"></i>
                    <div style="margin-top: 1rem;">No chair rulings recorded</div>
                </div>
            </div>

            <div class="box mb-4" style="border-left: 4px solid #8e44ad;">
                <h3><i class="fas fa-exclamation-triangle"></i> Rules Suspension Log</h3>
                <p class="mb-3" style="font-size: 0.85rem; opacity: 0.8;">
                    Track temporary suspensions of procedural rules
                </p>
                <div style="padding: 1rem; background: #8e44ad; border-radius: 4px; margin-bottom: 1.5rem;">
                    <i class="fas fa-info-circle"></i> <strong>Roberts Rules:</strong> Rules can be temporarily suspended to expedite business or allow special procedures. Requires 2/3 vote. Cannot suspend rules related to fundamental rights or bylaws.
                </div>
                <div style="overflow-x: auto; margin-top: 1rem;">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Rule(s) Suspended</th>
                                <th>Purpose</th>
                                <th>Duration</th>
                                <th>Vote Result</th>
                            </tr>
                        </thead>
                        <tbody id="rules-suspensions-body"></tbody>
                    </table>
                </div>
                <div id="no-rules-suspensions" style="padding: 2rem; text-align: center; opacity: 0.6;">
                    <i class="fas fa-check-circle" style="font-size: 2rem; color: #2ecc71;"></i>
                    <div style="margin-top: 1rem;">No rules suspensions recorded</div>
                </div>
            </div>

            <div class="box mb-4" style="border-left: 4px solid #e67e22;">
                <h3><i class="fas fa-envelope"></i> Email Integration - Agendas & Minutes</h3>
                <p class="mb-3" style="font-size: 0.85rem; opacity: 0.8;">
                    Automatically send meeting agendas before GC and minutes after meetings via email
                </p>
                <div style="padding: 1rem; background: #34495e; border-radius: 4px; margin-bottom: 1.5rem;">
                    <h4 style="margin-bottom: 0.75rem; color: #e67e22;"><i class="fas fa-cog"></i> Email Configuration</h4>
                    <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="email-from-address">From Email Address</label>
                            <input type="email" id="email-from-address" placeholder="group@example.com">
                            <small style="font-size: 0.75rem; opacity: 0.7;">Group's email address (display only - uses mailto:)</small>
                        </div>
                        <div class="form-group">
                            <label for="email-from-name">From Name</label>
                            <input type="text" id="email-from-name" placeholder="Your Home Group">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="email-recipient-list">Default Recipient List</label>
                        <textarea id="email-recipient-list" rows="3" placeholder="Enter email addresses, one per line or comma-separated..."></textarea>
                        <small style="font-size: 0.75rem; opacity: 0.7;">Members' email addresses for agenda and minutes distribution</small>
                    </div>
                    <button class="btn" onclick="saveEmailSettings()" style="background: #e67e22;">
                        <i class="fas fa-save"></i> Save Email Settings
                    </button>
                </div>
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div style="padding: 1rem; background: #3498db; border-radius: 6px;">
                        <h4 style="color: white; margin-bottom: 0.75rem;"><i class="fas fa-calendar-alt"></i> Send Agenda</h4>
                        <div class="form-group">
                            <label for="agenda-meeting-date" style="color: white;">Meeting Date</label>
                            <input type="date" id="agenda-meeting-date">
                        </div>
                        <div class="form-group">
                            <label style="color: white;">
                                <input type="checkbox" id="agenda-include-standing" checked> Include Standing Items
                            </label>
                        </div>
                        <div class="form-group">
                            <label style="color: white;">
                                <input type="checkbox" id="agenda-include-tabled" checked> Include Tabled Motions
                            </label>
                        </div>
                        <button class="btn" onclick="generateAndEmailAgenda()" style="background: white; color: #3498db;">
                            <i class="fas fa-paper-plane"></i> Generate & Email Agenda
                        </button>
                        <div id="agenda-preview" style="display: none; margin-top: 1rem; padding: 1rem; background: white; color: #2c3e50; border-radius: 4px; font-size: 0.85rem; max-height: 300px; overflow-y: auto;"></div>
                    </div>
                    <div style="padding: 1rem; background: #2ecc71; border-radius: 6px;">
                        <h4 style="color: white; margin-bottom: 0.75rem;"><i class="fas fa-file-alt"></i> Send Minutes</h4>
                        <div class="form-group">
                            <label for="minutes-meeting-date" style="color: white;">Meeting Date</label>
                            <input type="date" id="minutes-meeting-date">
                        </div>
                        <div class="form-group">
                            <label style="color: white;">
                                <input type="checkbox" id="minutes-include-discussion" checked> Include Discussion Thread
                            </label>
                        </div>
                        <div class="form-group">
                            <label style="color: white;">
                                <input type="checkbox" id="minutes-include-amendments"> Include Amendments
                            </label>
                        </div>
                        <button class="btn" onclick="generateAndEmailMinutes()" style="background: white; color: #2ecc71;">
                            <i class="fas fa-paper-plane"></i> Generate & Email Minutes
                        </button>
                        <div id="minutes-preview" style="display: none; margin-top: 1rem; padding: 1rem; background: white; color: #2c3e50; border-radius: 4px; font-size: 0.85rem; max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>
                <div style="margin-top: 1.5rem; padding: 1rem; background: #34495e; border-radius: 4px;">
                    <h4 style="margin-bottom: 0.75rem;"><i class="fas fa-history"></i> Email Send History</h4>
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date Sent</th>
                                    <th>Type</th>
                                    <th>Meeting Date</th>
                                    <th>Recipients</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="email-history-body"></tbody>
                        </table>
                    </div>
                </div>
                <div style="margin-top: 1rem; padding: 1rem; background: #f39c12; border-radius: 4px;">
                    <i class="fas fa-info-circle"></i> <strong>Note:</strong> This uses your device's default email client (mailto:). For automated email delivery, consider integrating with an email service provider.
                </div>
            </div>
            <div class="box mb-4" style="border-left: 4px solid #8e44ad;">
                <h3><i class="fas fa-redo"></i> Motion Reconsideration Workflow</h3>
                <p class="mb-3" style="font-size: 0.85rem; opacity: 0.8;">
                    Formally reconsider a previously decided motion with new information
                </p>
                <div style="padding: 1rem; background: #8e44ad; border-radius: 4px; margin-bottom: 1.5rem;">
                    <i class="fas fa-info-circle"></i> <strong>AA Tradition Note:</strong> Reconsideration should be rare and only when significant new information emerges or circumstances change substantially.
                </div>
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="reconsider-original-decision">Original Decision to Reconsider *</label>
                        <select id="reconsider-original-decision" onchange="loadOriginalDecision()">
                            <option value="">Select a past decision...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="reconsider-requested-by">Requested By *</label>
                        <select id="reconsider-requested-by"></select>
                    </div>
                </div>
                <div id="original-decision-summary" style="display: none; padding: 1rem; background: #2c3e50; border-radius: 4px; margin-bottom: 1rem;">
                    <h4 style="margin-bottom: 0.5rem;">Original Decision Summary</h4>
                    <div id="original-decision-details"></div>
                </div>
                <div class="form-group">
                    <label for="reconsider-reason">Reason for Reconsideration *</label>
                    <select id="reconsider-reason">
                        <option value="new-information">Significant New Information</option>
                        <option value="changed-circumstances">Changed Circumstances</option>
                        <option value="implementation-issues">Implementation Issues Discovered</option>
                        <option value="tradition-conflict">Potential Tradition Conflict</option>
                        <option value="financial-impact">Unexpected Financial Impact</option>
                        <option value="member-feedback">Substantial Member Feedback</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="reconsider-justification">Detailed Justification *</label>
                    <textarea id="reconsider-justification" rows="4" placeholder="Explain what new information or changes justify reconsidering this decision..."></textarea>
                </div>
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="reconsider-proposed-date">Proposed Reconsideration Date</label>
                        <input type="date" id="reconsider-proposed-date">
                    </div>
                    <div class="form-group">
                        <label for="reconsider-research-period">Research Period (days)</label>
                        <input type="number" id="reconsider-research-period" min="7" max="90" value="14" placeholder="14">
                    </div>
                </div>
                <div class="form-group">
                    <label for="reconsider-proposed-change">Proposed Change/Alternative</label>
                    <textarea id="reconsider-proposed-change" rows="3" placeholder="What specific change are you proposing?"></textarea>
                </div>
                <button class="btn" onclick="submitReconsiderationRequest()" style="background: #8e44ad;">
                    <i class="fas fa-paper-plane"></i> Submit Reconsideration Request
                </button>
                <h4 class="mt-4">Pending Reconsideration Requests</h4>
                <div style="overflow-x: auto; margin-top: 1rem;">
                    <table>
                        <thead>
                            <tr>
                                <th>Original Motion</th>
                                <th>Requested By</th>
                                <th>Reason</th>
                                <th>Proposed Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reconsideration-requests-body"></tbody>
                    </table>
                </div>
            </div>
            <div class="box mb-4" style="border-left: 4px solid #16a085;">
                <h3><i class="fas fa-calendar-plus"></i> Calendar Integration</h3>
                <p class="mb-3" style="font-size: 0.85rem; opacity: 0.8;">
                    Sync GC meetings and decision deadlines to Google Calendar, Outlook, or Apple Calendar
                </p>
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div style="padding: 1rem; background: #3498db; border-radius: 6px;">
                        <h4 style="color: white; margin-bottom: 0.75rem;"><i class="fas fa-calendar-alt"></i> Add GC Meeting to Calendar</h4>
                        <div class="form-group">
                            <label for="cal-meeting-date" style="color: white;">Meeting Date *</label>
                            <input type="date" id="cal-meeting-date">
                        </div>
                        <div class="form-group">
                            <label for="cal-meeting-time" style="color: white;">Meeting Time</label>
                            <input type="time" id="cal-meeting-time" value="18:00">
                        </div>
                        <div class="form-group">
                            <label for="cal-duration" style="color: white;">Duration (hours)</label>
                            <input type="number" id="cal-duration" min="0.5" max="4" step="0.5" value="1.5">
                        </div>
                        <div class="form-group">
                            <label for="cal-location" style="color: white;">Location</label>
                            <input type="text" id="cal-location" placeholder="Meeting location">
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 1rem;">
                            <button class="btn" onclick="exportToGoogleCalendar()" style="background: white; color: #4285F4;">
                                <i class="fab fa-google"></i> Google
                            </button>
                            <button class="btn" onclick="exportToOutlook()" style="background: white; color: #0078D4;">
                                <i class="fab fa-microsoft"></i> Outlook
                            </button>
                            <button class="btn" onclick="exportToICS()" style="background: white; color: #3498db;">
                                <i class="fas fa-download"></i> .ICS
                            </button>
                        </div>
                    </div>
                    <div style="padding: 1rem; background: #e74c3c; border-radius: 6px;">
                        <h4 style="color: white; margin-bottom: 0.75rem;"><i class="fas fa-clock"></i> Add Decision Deadline</h4>
                        <div class="form-group">
                            <label for="cal-decision-title" style="color: white;">Decision Title *</label>
                            <input type="text" id="cal-decision-title" placeholder="e.g., Vote on Rent Increase">
                        </div>
                        <div class="form-group">
                            <label for="cal-deadline-date" style="color: white;">Deadline Date *</label>
                            <input type="date" id="cal-deadline-date">
                        </div>
                        <div class="form-group">
                            <label for="cal-reminder" style="color: white;">Reminder</label>
                            <select id="cal-reminder">
                                <option value="0">None</option>
                                <option value="1">1 day before</option>
                                <option value="3">3 days before</option>
                                <option value="7" selected>1 week before</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 1rem;">
                            <button class="btn" onclick="exportDeadlineToGoogleCalendar()" style="background: white; color: #4285F4;">
                                <i class="fab fa-google"></i> Google
                            </button>
                            <button class="btn" onclick="exportDeadlineToOutlook()" style="background: white; color: #0078D4;">
                                <i class="fab fa-microsoft"></i> Outlook
                            </button>
                            <button class="btn" onclick="exportDeadlineToICS()" style="background: white; color: #e74c3c;">
                                <i class="fas fa-download"></i> .ICS
                            </button>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 1.5rem; padding: 1rem; background: #34495e; border-radius: 4px;">
                    <h4 style="margin-bottom: 0.75rem;"><i class="fas fa-list"></i> Upcoming Calendar Events</h4>
                    <div id="upcoming-calendar-events"></div>
                </div>
            </div>
            <div class="box mb-4" style="border-left: 4px solid #f39c12;">
                <h3><i class="fas fa-calculator"></i> Decision ROI/Impact Calculator</h3>
                <p class="mb-3" style="font-size: 0.85rem; opacity: 0.8;">
                    Predict financial impact and return on investment before voting on financial decisions
                </p>
                <div class="grid" style="grid-template-columns: 1fr 2fr; gap: 2rem;">
                    <div>
                        <div class="form-group">
                            <label for="roi-decision-title">Decision Title *</label>
                            <input type="text" id="roi-decision-title" placeholder="e.g., Purchase New Coffee Maker">
                        </div>
                        <div class="form-group">
                            <label for="roi-initial-cost">Initial Cost ($) *</label>
                            <input type="number" id="roi-initial-cost" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label for="roi-ongoing-cost">Monthly Ongoing Cost ($)</label>
                            <input type="number" id="roi-ongoing-cost" step="0.01" placeholder="0.00">
                            <small style="font-size: 0.75rem; opacity: 0.7;">Maintenance, supplies, etc.</small>
                        </div>
                        <div class="form-group">
                            <label for="roi-revenue-impact">Monthly Revenue Impact ($)</label>
                            <input type="number" id="roi-revenue-impact" step="0.01" placeholder="0.00">
                            <small style="font-size: 0.75rem; opacity: 0.7;">Increased 7th tradition, etc.</small>
                        </div>
                        <div class="form-group">
                            <label for="roi-expense-savings">Monthly Expense Savings ($)</label>
                            <input type="number" id="roi-expense-savings" step="0.01" placeholder="0.00">
                            <small style="font-size: 0.75rem; opacity: 0.7;">What costs will this reduce?</small>
                        </div>
                        <div class="form-group">
                            <label for="roi-timeframe">Timeframe (months)</label>
                            <input type="number" id="roi-timeframe" min="1" max="60" value="12" placeholder="12">
                        </div>
                        <button class="btn" onclick="calculateROI()" style="background: #f39c12;">
                            <i class="fas fa-chart-line"></i> Calculate Impact
                        </button>
                    </div>
                    <div>
                        <div id="roi-results" style="display: none;">
                            <div style="padding: 1.5rem; background: #2c3e50; border-radius: 6px; margin-bottom: 1rem;">
                                <h4 style="color: #f39c12; margin-bottom: 1rem;">Financial Impact Summary</h4>
                                <div class="grid" style="grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                                    <div style="text-align: center;">
                                        <div style="font-size: 2rem; font-weight: bold;" id="roi-total-cost-display">$0</div>
                                        <div style="font-size: 0.85rem; opacity: 0.8;">Total Cost</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 2rem; font-weight: bold;" id="roi-net-impact-display">$0</div>
                                        <div style="font-size: 0.85rem; opacity: 0.8;">Net Impact</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 2rem; font-weight: bold;" id="roi-payback-display">N/A</div>
                                        <div style="font-size: 0.85rem; opacity: 0.8;">Payback Period</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 2rem; font-weight: bold;" id="roi-percentage-display">0%</div>
                                        <div style="font-size: 0.85rem; opacity: 0.8;">ROI</div>
                                    </div>
                                </div>
                                <div id="roi-recommendation" style="padding: 1rem; border-radius: 4px; margin-bottom: 1rem;"></div>
                                <canvas id="roi-chart"></canvas>
                            </div>
                            <div style="padding: 1rem; background: #34495e; border-radius: 4px;">
                                <h4 style="margin-bottom: 0.75rem;">Budget Impact Analysis</h4>
                                <div id="budget-impact-details"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="box mb-4" style="border-left: 4px solid #9b59b6;">
                <h3><i class="fas fa-user-friends"></i> Proxy Voting System</h3>
                <p class="mb-3" style="font-size: 0.85rem; opacity: 0.8;">
                    Allow members to designate proxy voters when unable to attend GC meetings
                </p>
                <div style="padding: 1rem; background: #e67e22; border-radius: 4px; margin-bottom: 1.5rem;">
                    <i class="fas fa-exclamation-triangle"></i> <strong>Important:</strong> Proxy voting should align with group guidelines. Some groups may not allow proxies. Check your bylaws first.
                </div>
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <div>
                        <h4><i class="fas fa-user-plus"></i> Designate Proxy</h4>
                        <div class="form-group">
                            <label for="proxy-member">Your Name *</label>
                            <select id="proxy-member"></select>
                        </div>
                        <div class="form-group">
                            <label for="proxy-designated-voter">Designate Proxy To *</label>
                            <select id="proxy-designated-voter"></select>
                            <small style="font-size: 0.75rem; opacity: 0.7;">This person will vote on your behalf</small>
                        </div>
                        <div class="form-group">
                            <label for="proxy-meeting-date">For Meeting Date *</label>
                            <input type="date" id="proxy-meeting-date">
                        </div>
                        <div class="form-group">
                            <label for="proxy-scope">Proxy Scope</label>
                            <select id="proxy-scope" onchange="toggleProxyInstructions()">
                                <option value="general">General Proxy - Vote as they see fit</option>
                                <option value="directed">Directed Proxy - Vote as I specify</option>
                            </select>
                        </div>
                        <div id="proxy-directed-instructions" style="display: none;">
                            <div class="form-group">
                                <label for="proxy-instructions">Voting Instructions</label>
                                <textarea id="proxy-instructions" rows="3" placeholder="Specify how you want your proxy to vote on each item..."></textarea>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="proxy-reason">Reason for Proxy</label>
                            <select id="proxy-reason">
                                <option value="travel">Travel</option>
                                <option value="work">Work Conflict</option>
                                <option value="health">Health Issue</option>
                                <option value="emergency">Emergency</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <button class="btn" onclick="submitProxyDesignation()" style="background: #9b59b6;">
                            <i class="fas fa-save"></i> Submit Proxy Designation
                        </button>
                    </div>
                    <div>
                        <h4><i class="fas fa-list-alt"></i> Active Proxies</h4>
                        <div style="overflow-x: auto; margin-top: 1rem;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Member</th>
                                        <th>Proxy</th>
                                        <th>Meeting</th>
                                        <th>Type</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="active-proxies-body"></tbody>
                            </table>
                        </div>
                        <h4 class="mt-4"><i class="fas fa-user-check"></i> My Proxy Assignments</h4>
                        <p style="font-size: 0.85rem; opacity: 0.8;">Meetings where others have designated you to vote for them</p>
                        <div id="my-proxy-assignments"></div>
                    </div>
                </div>
            </div>
            <div class="box mb-4" style="border-left: 4px solid #e74c3c;">
                <h3><i class="fas fa-exchange-alt"></i> Decision Reversal Tracking</h3>
                <p class="mb-3" style="font-size: 0.85rem; opacity: 0.8;">
                    Track when and why decisions are reversed to learn from past patterns
                </p>
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="reversal-original-decision">Original Decision *</label>
                        <select id="reversal-original-decision" onchange="loadReversalDecision()"></select>
                    </div>
                    <div class="form-group">
                        <label for="reversal-new-decision">New/Replacement Decision *</label>
                        <select id="reversal-new-decision"></select>
                    </div>
                </div>
                <div id="reversal-original-summary" style="display: none; padding: 1rem; background: #2c3e50; border-radius: 4px; margin-bottom: 1rem;">
                    <h4>Original Decision</h4>
                    <div id="reversal-original-details"></div>
                </div>
                <div class="form-group">
                    <label for="reversal-reason-category">Reversal Reason Category *</label>
                    <select id="reversal-reason-category">
                        <option value="ineffective">Original Decision Ineffective</option>
                        <option value="unintended-consequences">Unintended Consequences</option>
                        <option value="financial">Financial Reasons</option>
                        <option value="changed-circumstances">Circumstances Changed</option>
                        <option value="tradition-conflict">Tradition/Principle Conflict</option>
                        <option value="member-feedback">Member Feedback/Unity Issues</option>
                        <option value="better-alternative">Better Alternative Found</option>
                        <option value="implementation-failed">Implementation Failed</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="reversal-explanation">Detailed Explanation *</label>
                    <textarea id="reversal-explanation" rows="4" placeholder="Explain why the original decision is being reversed and what we learned..."></textarea>
                </div>
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="reversal-date">Reversal Date</label>
                        <input type="date" id="reversal-date">
                    </div>
                    <div class="form-group">
                        <label for="reversal-months-elapsed">Months Since Original</label>
                        <input type="number" id="reversal-months-elapsed" readonly>
                    </div>
                </div>
                <div class="form-group">
                    <label for="reversal-lessons-learned">Lessons Learned *</label>
                    <textarea id="reversal-lessons-learned" rows="3" placeholder="What can we learn to avoid similar issues in the future?"></textarea>
                </div>
                <button class="btn" onclick="saveDecisionReversal()" style="background: #e74c3c;">
                    <i class="fas fa-save"></i> Record Reversal
                </button>
                <h4 class="mt-4">Reversal History & Analysis</h4>
                <div style="overflow-x: auto; margin-top: 1rem;">
                    <table>
                        <thead>
                            <tr>
                                <th>Original Decision</th>
                                <th>Reversed To</th>
                                <th>Reason</th>
                                <th>Time Elapsed</th>
                                <th>Lessons Learned</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="decision-reversals-body"></tbody>
                    </table>
                </div>
                <div class="mt-4" style="padding: 1.5rem; background: #2c3e50; border-radius: 6px;">
                    <h4 style="margin-bottom: 1rem;"><i class="fas fa-chart-pie"></i> Reversal Patterns Analysis</h4>
                    <div class="grid" style="grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: #e74c3c;" id="total-reversals-count">0</div>
                            <div style="font-size: 0.85rem; opacity: 0.8;">Total Reversals</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: #f39c12;" id="avg-reversal-time">0</div>
                            <div style="font-size: 0.85rem; opacity: 0.8;">Avg Time to Reversal</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: #3498db;" id="most-common-reason">N/A</div>
                            <div style="font-size: 0.85rem; opacity: 0.8;">Most Common Reason</div>
                        </div>
                    </div>
                    <div style="margin-top: 1.5rem;">
                        <canvas id="reversal-reasons-chart"></canvas>
                    </div>
                </div>
            </div>
        </section>
        <section id="gc-inventory-section" style="border-left: 4px solid #9b59b6;">
            <h2><i class="fas fa-tasks"></i> Group Conscience Inventory</h2>
            <p class="mb-4">Tradition inventory questions, Concept templates, and anonymous feedback collection.</p>
            <div class="box mb-4">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3>Select Inventory Type</h3>
                    <button class="btn secondary" onclick="exportInventoryResults()">Export Results</button>
                </div>
                <div class="form-group">
                    <select id="inventory-type" onchange="loadInventoryTemplate()">
                        <option value="">-- Select Type --</option>
                        <option value="traditions">12 Traditions Inventory</option>
                        <option value="concepts">12 Concepts Inventory</option>
                        <option value="group-health">Group Health Check</option>
                        <option value="annual">Annual Group Inventory</option>
                    </select>
                </div>
            </div>
            <div id="inventory-questions-container"></div>
            <div class="box mt-4">
                <h3>Anonymous Feedback</h3>
                <p style="font-size: 0.85rem; margin-bottom: 1rem;">Members can submit anonymous feedback about group health</p>
                <div class="form-group">
                    <label for="anonymous-feedback-text">Your Anonymous Feedback</label>
                    <textarea id="anonymous-feedback-text" rows="4" placeholder="Share your thoughts about group health, traditions, or concerns..."></textarea>
                </div>
                <button class="btn" onclick="submitAnonymousFeedback()">Submit Anonymously</button>
            </div>
            <div class="box mt-4">
                <h3>Collected Feedback</h3>
                <div id="anonymous-feedback-list"></div>
            </div>
        </section>
        <section id="gc-bylaws-section" style="border-left: 4px solid #9b59b6;">
            <h2><i class="fas fa-book-open"></i> Group Guidelines & By-Laws Repository</h2>
            <p class="mb-4">Store group documents with version control and amendment tracking.</p>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Add/Update Document</h3>
                        <div class="form-group">
                            <label for="bylaw-title">Document Title</label>
                            <input type="text" id="bylaw-title" placeholder="e.g., Group Guidelines, By-Laws">
                        </div>
                        <div class="form-group">
                            <label for="bylaw-version">Version</label>
                            <input type="text" id="bylaw-version" placeholder="e.g., 1.0, 2.1">
                        </div>
                        <div class="form-group">
                            <label for="bylaw-content">Document Content</label>
                            <textarea id="bylaw-content" rows="10" placeholder="Enter the full text of the document..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="bylaw-amendment-notes">Amendment Notes</label>
                            <textarea id="bylaw-amendment-notes" rows="2" placeholder="What changed in this version?"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="bylaw-effective-date">Effective Date</label>
                            <input type="date" id="bylaw-effective-date">
                        </div>
                        <input type="hidden" id="bylaw-edit-id">
                        <button id="bylaw-form-btn" class="btn" onclick="handleByLawSubmit()">Save Document</button>
                        <button id="bylaw-form-cancel-btn" class="btn secondary" onclick="cancelByLawEdit()" style="display:none; margin-left: 0.5rem;">Cancel</button>
                    </div>
                </div>
                <div>
                    <div class="box">
                        <h3>Current Documents</h3>
                        <div id="bylaws-current-list"></div>
                    </div>
                    <div class="box mt-4">
                        <h3>Version History</h3>
                        <table id="bylaws-history-table">
                            <thead>
                                <tr>
                                    <th>Document</th>
                                    <th>Version</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="bylaws-history-body"></tbody>
                        </table>
                    </div>
                    <div class="box mt-4">
                        <h3>Generate PDF</h3>
                        <div class="form-group">
                            <label for="pdf-document-select">Select Document</label>
                            <select id="pdf-document-select"></select>
                        </div>
                        <button class="btn" onclick="generateByLawPDF()">Generate PDF</button>
                    </div>
                </div>
            </div>
        </section>
        <section id="sponsorship-section" style="border-left: 4px solid #2ecc71;">
            <h2><i class="fas fa-handshake"></i> Sponsorship Tracking</h2>
            <p class="mb-4">Track sponsorship relationships with tree visualization and service sponsorship.</p>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Add Sponsorship Relationship</h3>
                        <div class="form-group">
                            <label for="sponsor-name">Sponsor</label>
                            <select id="sponsor-name"></select>
                        </div>
                        <div class="form-group">
                            <label for="sponsee-name">Sponsee</label>
                            <select id="sponsee-name"></select>
                        </div>
                        <div class="form-group">
                            <label for="sponsorship-type">Type</label>
                            <select id="sponsorship-type">
                                <option value="program">Program Sponsorship</option>
                                <option value="service">Service Sponsorship</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="sponsorship-start-date">Start Date</label>
                            <input type="date" id="sponsorship-start-date">
                        </div>
                        <div class="form-group" id="step-progress-group" style="display: none;">
                            <label for="current-step">Current Step (Optional)</label>
                            <select id="current-step">
                                <option value="">Not tracking</option>
                                <option value="1">Step 1</option>
                                <option value="2">Step 2</option>
                                <option value="3">Step 3</option>
                                <option value="4">Step 4</option>
                                <option value="5">Step 5</option>
                                <option value="6">Step 6</option>
                                <option value="7">Step 7</option>
                                <option value="8">Step 8</option>
                                <option value="9">Step 9</option>
                                <option value="10">Step 10</option>
                                <option value="11">Step 11</option>
                                <option value="12">Step 12</option>
                            </select>
                        </div>
                        <input type="hidden" id="sponsorship-edit-id">
                        <button id="sponsorship-form-btn" class="btn" onclick="handleSponsorshipSubmit()">Add Relationship</button>
                        <button id="sponsorship-form-cancel-btn" class="btn secondary" onclick="cancelSponsorshipEdit()" style="display:none; margin-left: 0.5rem;">Cancel</button>
                    </div>
                </div>
                <div>
                    <div class="box">
                        <h3>Sponsorship Tree Visualization</h3>
                        <div id="sponsorship-tree" style="min-height: 400px; padding: 1rem; background: #2c3e50; border-radius: 6px; overflow-x: auto;"></div>
                    </div>
                    <div class="box mt-4">
                        <h3>Sponsorship List</h3>
                        <table id="sponsorship-table">
                            <thead>
                                <tr>
                                    <th>Sponsor</th>
                                    <th>Sponsee</th>
                                    <th>Type</th>
                                    <th>Start Date</th>
                                    <th>Progress</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="sponsorship-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
        <section id="district-area-section" style="border-left: 4px solid #2ecc71;">
            <h2><i class="fas fa-sitemap"></i> District/Area Committee Integration</h2>
            <p class="mb-4">GSR reports, district meeting schedules, and area assembly tracking.</p>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Log GSR Report</h3>
                        <div class="form-group">
                            <label for="gsr-report-date">Meeting Date</label>
                            <input type="date" id="gsr-report-date">
                        </div>
                        <div class="form-group">
                            <label for="gsr-meeting-type">Meeting Type</label>
                            <select id="gsr-meeting-type">
                                <option value="district">District Meeting</option>
                                <option value="area">Area Assembly</option>
                                <option value="special">Special Meeting</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="gsr-report-content">Report Summary</label>
                            <textarea id="gsr-report-content" rows="5" placeholder="Summarize key points, motions, and announcements..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="gsr-action-items">Action Items</label>
                            <textarea id="gsr-action-items" rows="3" placeholder="Any action items for the group..."></textarea>
                        </div>
                        <input type="hidden" id="gsr-report-edit-id">
                        <button id="gsr-report-form-btn" class="btn" onclick="handleGSRReportSubmit()">Save Report</button>
                        <button id="gsr-report-form-cancel-btn" class="btn secondary" onclick="cancelGSRReportEdit()" style="display:none; margin-left: 0.5rem;">Cancel</button>
                    </div>
                    <div class="box mt-4">
                        <h3>District Meeting Schedule</h3>
                        <div class="form-group">
                            <label for="district-schedule-date">Meeting Date</label>
                            <input type="date" id="district-schedule-date">
                        </div>
                        <div class="form-group">
                            <label for="district-schedule-time">Time</label>
                            <input type="time" id="district-schedule-time">
                        </div>
                        <div class="form-group">
                            <label for="district-schedule-location">Location</label>
                            <input type="text" id="district-schedule-location" placeholder="Meeting location">
                        </div>
                        <button class="btn" onclick="addDistrictMeeting()">Add to Schedule</button>
                    </div>
                </div>
                <div>
                    <div class="box">
                        <h3>Recent GSR Reports</h3>
                        <div id="gsr-reports-list" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>
                    <div class="box mt-4">
                        <h3>Upcoming District/Area Meetings</h3>
                        <div id="district-meetings-list"></div>
                    </div>
                    <div class="box mt-4">
                        <h3>DCM Communication Log</h3>
                        <div class="form-group">
                            <label for="dcm-comm-date">Date</label>
                            <input type="date" id="dcm-comm-date">
                        </div>
                        <div class="form-group">
                            <label for="dcm-comm-content">Communication</label>
                            <textarea id="dcm-comm-content" rows="3" placeholder="Log communication with DCM..."></textarea>
                        </div>
                        <button class="btn" onclick="addDCMCommunication()">Add Entry</button>
                        <div id="dcm-comm-history" class="mt-4"></div>
                    </div>
                </div>
            </div>
        </section>
        <section id="area-assembly-section" style="border-left: 4px solid #9b59b6;">
            <h2><i class="fas fa-users-cog"></i> Area Assembly Integration</h2>
            <p class="mb-4">Track area motions and votes, record group positions on area issues, and manage GSR voting instructions.</p>
            <button class="btn mb-3" onclick="exportDistrictAreaReportPDF()" style="background: #9b59b6;">
                <i class="fas fa-file-pdf"></i> Export District & Area Report to PDF
            </button>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Log Area Motion</h3>
                        <div class="form-group">
                            <label for="area-motion-number">Motion Number</label>
                            <input type="text" id="area-motion-number" placeholder="e.g., 2025-03-A">
                        </div>
                        <div class="form-group">
                            <label for="area-motion-date">Assembly Date</label>
                            <input type="date" id="area-motion-date">
                        </div>
                        <div class="form-group">
                            <label for="area-motion-type">Motion Type</label>
                            <select id="area-motion-type">
                                <option value="policy">Policy Change</option>
                                <option value="budget">Budget/Financial</option>
                                <option value="service">Service Structure</option>
                                <option value="event">Area Event</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="area-motion-title">Motion Title</label>
                            <input type="text" id="area-motion-title" placeholder="Brief title of the motion">
                        </div>
                        <div class="form-group">
                            <label for="area-motion-description">Motion Description</label>
                            <textarea id="area-motion-description" rows="4" placeholder="Full text of the motion..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="area-motion-background">Background / Rationale</label>
                            <textarea id="area-motion-background" rows="3" placeholder="Why this motion is being proposed..."></textarea>
                        </div>
                        <input type="hidden" id="area-motion-edit-id">
                        <button id="area-motion-form-btn" class="btn" onclick="handleAreaMotionSubmit()">Save Area Motion</button>
                        <button id="area-motion-form-cancel-btn" class="btn secondary" onclick="cancelAreaMotionEdit()" style="display:none; margin-left: 0.5rem;">Cancel</button>
                    </div>
                    <div class="box mt-4">
                        <h3>Record Group's Position</h3>
                        <div class="form-group">
                            <label for="group-position-motion">Select Area Motion</label>
                            <select id="group-position-motion">
                                <option value="">-- Select Motion --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="group-position-vote">Group's Vote</label>
                            <select id="group-position-vote">
                                <option value="for">In Favor</option>
                                <option value="against">Against</option>
                                <option value="abstain">Abstain</option>
                                <option value="minority">Minority Opinion</option>
                                <option value="needs-info">Needs More Information</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="group-position-date">GC Decision Date</label>
                            <input type="date" id="group-position-date">
                        </div>
                        <div class="form-group">
                            <label for="group-position-notes">Discussion Notes</label>
                            <textarea id="group-position-notes" rows="3" placeholder="Key points from group discussion..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="group-position-instructions">GSR Voting Instructions</label>
                            <textarea id="group-position-instructions" rows="2" placeholder="Special instructions for GSR (e.g., 'Vote yes if amended', 'Request research period')"></textarea>
                        </div>
                        <button class="btn" onclick="recordGroupPosition()">Record Position</button>
                    </div>
                </div>
                <div>
                    <div class="box">
                        <h3>Area Motions Tracking</h3>
                        <div style="margin-bottom: 1rem;">
                            <button class="btn" onclick="filterAreaMotions('all')" style="margin-right: 0.5rem;">All</button>
                            <button class="btn secondary" onclick="filterAreaMotions('pending')" style="margin-right: 0.5rem;">Pending Vote</button>
                            <button class="btn secondary" onclick="filterAreaMotions('voted')">Group Voted</button>
                        </div>
                        <div id="area-motions-list" style="max-height: 500px; overflow-y: auto;"></div>
                    </div>
                    <div class="box mt-4">
                        <h3>Assembly Agenda Upload</h3>
                        <div class="form-group">
                            <label for="assembly-agenda-date">Assembly Date</label>
                            <input type="date" id="assembly-agenda-date">
                        </div>
                        <div class="form-group">
                            <label for="assembly-agenda-location">Location</label>
                            <input type="text" id="assembly-agenda-location" placeholder="Assembly location">
                        </div>
                        <div class="form-group">
                            <label for="assembly-agenda-content">Agenda Items</label>
                            <textarea id="assembly-agenda-content" rows="6" placeholder="Paste assembly agenda here..."></textarea>
                        </div>
                        <button class="btn" onclick="uploadAssemblyAgenda()">Save Agenda</button>
                        <div id="assembly-agendas-list" class="mt-4"></div>
                    </div>
                </div>
            </div>
        </section>
        <section id="intergroup-section" style="border-left: 4px solid #16a085;">
            <h2><i class="fas fa-handshake"></i> Intergroup Representative Functions</h2>
            <p class="mb-4">IR meeting notes, special events coordination, hotline volunteer scheduling, and public information committee tracking.</p>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Log IR Meeting Notes</h3>
                        <div class="form-group">
                            <label for="ir-meeting-date">Meeting Date</label>
                            <input type="date" id="ir-meeting-date">
                        </div>
                        <div class="form-group">
                            <label for="ir-meeting-type">Meeting Type</label>
                            <select id="ir-meeting-type">
                                <option value="regular">Regular Intergroup Meeting</option>
                                <option value="special">Special Meeting</option>
                                <option value="workshop">Workshop/Training</option>
                                <option value="planning">Event Planning</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="ir-meeting-location">Location</label>
                            <input type="text" id="ir-meeting-location" placeholder="Meeting location">
                        </div>
                        <div class="form-group">
                            <label for="ir-meeting-notes">Meeting Notes</label>
                            <textarea id="ir-meeting-notes" rows="5" placeholder="Key discussion points, decisions, and announcements..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="ir-action-items">Action Items for Group</label>
                            <textarea id="ir-action-items" rows="3" placeholder="Actions needed from our group..."></textarea>
                        </div>
                        <input type="hidden" id="ir-meeting-edit-id">
                        <button id="ir-meeting-form-btn" class="btn" onclick="handleIRMeetingSubmit()">Save IR Notes</button>
                        <button id="ir-meeting-form-cancel-btn" class="btn secondary" onclick="cancelIRMeetingEdit()" style="display:none; margin-left: 0.5rem;">Cancel</button>
                    </div>
                    <div class="box mt-4">
                        <h3>Hotline Volunteer Scheduling</h3>
                        <div class="form-group">
                            <label for="hotline-volunteer">Volunteer Name</label>
                            <select id="hotline-volunteer"></select>
                        </div>
                        <div class="form-group">
                            <label for="hotline-shift-date">Shift Date</label>
                            <input type="date" id="hotline-shift-date">
                        </div>
                        <div class="form-group">
                            <label for="hotline-shift-time">Shift Time</label>
                            <select id="hotline-shift-time">
                                <option value="morning">Morning (6AM-12PM)</option>
                                <option value="afternoon">Afternoon (12PM-6PM)</option>
                                <option value="evening">Evening (6PM-12AM)</option>
                                <option value="overnight">Overnight (12AM-6AM)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="hotline-contact">Contact Number</label>
                            <input type="tel" id="hotline-contact" placeholder="Phone number for shift">
                        </div>
                        <button class="btn" onclick="scheduleHotlineShift()">Schedule Shift</button>
                        <div id="hotline-schedule-list" class="mt-4"></div>
                    </div>
                </div>
                <div>
                    <div class="box">
                        <h3>Recent IR Meeting Notes</h3>
                        <div id="ir-meetings-list" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>
                    <div class="box mt-4">
                        <h3>Special Events Coordination</h3>
                        <div class="form-group">
                            <label for="special-event-name">Event Name</label>
                            <input type="text" id="special-event-name" placeholder="e.g., Unity Day, Founders Day">
                        </div>
                        <div class="form-group">
                            <label for="special-event-date">Event Date</label>
                            <input type="date" id="special-event-date">
                        </div>
                        <div class="form-group">
                            <label for="special-event-location">Location</label>
                            <input type="text" id="special-event-location" placeholder="Event venue">
                        </div>
                        <div class="form-group">
                            <label for="special-event-coordinator">Group Coordinator</label>
                            <select id="special-event-coordinator"></select>
                        </div>
                        <div class="form-group">
                            <label for="special-event-details">Event Details</label>
                            <textarea id="special-event-details" rows="3" placeholder="Description, speaker, registration info..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="special-event-volunteers-needed">Volunteers Needed</label>
                            <input type="number" id="special-event-volunteers-needed" min="0" placeholder="Number of volunteers">
                        </div>
                        <button class="btn" onclick="addSpecialEvent()">Add Event</button>
                        <div id="special-events-list" class="mt-4"></div>
                    </div>
                    <div class="box mt-4">
                        <h3>PI Committee Tracking</h3>
                        <div class="form-group">
                            <label for="pi-activity-date">Activity Date</label>
                            <input type="date" id="pi-activity-date">
                        </div>
                        <div class="form-group">
                            <label for="pi-activity-type">Activity Type</label>
                            <select id="pi-activity-type">
                                <option value="presentation">Public Presentation</option>
                                <option value="literature">Literature Distribution</option>
                                <option value="media">Media Contact</option>
                                <option value="outreach">Community Outreach</option>
                                <option value="meeting">Committee Meeting</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="pi-activity-description">Description</label>
                            <textarea id="pi-activity-description" rows="3" placeholder="Details of PI activity..."></textarea>
                        </div>
                        <button class="btn" onclick="logPIActivity()">Log Activity</button>
                        <div id="pi-activities-list" class="mt-4"></div>
                    </div>
                </div>
            </div>
        </section>
        <section id="hi-panel-section" style="border-left: 4px solid #e67e22;">
            <h2><i class="fas fa-hospital"></i> H&I Panel Management</h2>
            <p class="mb-4">Panel scheduling, facility certifications, panel leader rotation, and facility contact information.</p>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Add/Edit Facility</h3>
                        <div class="form-group">
                            <label for="facility-name">Facility Name</label>
                            <input type="text" id="facility-name" placeholder="Hospital or institution name">
                        </div>
                        <div class="form-group">
                            <label for="facility-type">Facility Type</label>
                            <select id="facility-type">
                                <option value="hospital">Hospital</option>
                                <option value="treatment">Treatment Center</option>
                                <option value="detox">Detox Facility</option>
                                <option value="correctional">Correctional Facility</option>
                                <option value="psychiatric">Psychiatric Facility</option>
                                <option value="halfway">Halfway House</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="facility-address">Address</label>
                            <input type="text" id="facility-address" placeholder="Street address">
                        </div>
                        <div class="form-group">
                            <label for="facility-city">City, State ZIP</label>
                            <input type="text" id="facility-city" placeholder="City, State ZIP">
                        </div>
                        <div class="form-group">
                            <label for="facility-contact-name">Primary Contact Name</label>
                            <input type="text" id="facility-contact-name" placeholder="Contact person at facility">
                        </div>
                        <div class="form-group">
                            <label for="facility-contact-phone">Contact Phone</label>
                            <input type="tel" id="facility-contact-phone" placeholder="Phone number">
                        </div>
                        <div class="form-group">
                            <label for="facility-contact-email">Contact Email</label>
                            <input type="email" id="facility-contact-email" placeholder="Email address">
                        </div>
                        <div class="form-group">
                            <label for="facility-notes">Special Requirements/Notes</label>
                            <textarea id="facility-notes" rows="3" placeholder="Clearance requirements, rules, parking info..."></textarea>
                        </div>
                        <input type="hidden" id="facility-edit-id">
                        <button id="facility-form-btn" class="btn" onclick="handleFacilitySubmit()">Save Facility</button>
                        <button id="facility-form-cancel-btn" class="btn secondary" onclick="cancelFacilityEdit()" style="display:none; margin-left: 0.5rem;">Cancel</button>
                    </div>
                </div>
                <div>
                    <div class="box">
                        <h3>Facilities List</h3>
                        <div id="facilities-list" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                    <div class="box mt-4">
                        <h3>Panel Scheduling</h3>
                        <div class="form-group">
                            <label for="panel-facility">Select Facility</label>
                            <select id="panel-facility"></select>
                        </div>
                        <div class="form-group">
                            <label for="panel-date">Panel Date</label>
                            <input type="date" id="panel-date">
                        </div>
                        <div class="form-group">
                            <label for="panel-time">Panel Time</label>
                            <input type="time" id="panel-time">
                        </div>
                        <div class="form-group">
                            <label for="panel-leader">Panel Leader</label>
                            <select id="panel-leader"></select>
                        </div>
                        <div class="form-group">
                            <label for="panel-speakers">Panel Speakers (Select Multiple)</label>
                            <select id="panel-speakers" multiple size="5"></select>
                            <small style="font-size: 0.75rem; opacity: 0.8;">Hold Ctrl/Cmd to select multiple</small>
                        </div>
                        <div class="form-group">
                            <label for="panel-format">Meeting Format</label>
                            <select id="panel-format">
                                <option value="speaker">Speaker Meeting</option>
                                <option value="discussion">Discussion Meeting</option>
                                <option value="step">Step Meeting</option>
                                <option value="big-book">Big Book Meeting</option>
                            </select>
                        </div>
                        <button class="btn" onclick="schedulePanelMeeting()">Schedule Panel</button>
                    </div>
                </div>
            </div>
            <div class="box mt-4">
                <h3>Upcoming H&I Panels</h3>
                <table id="hi-panels-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Facility</th>
                            <th>Panel Leader</th>
                            <th>Speakers</th>
                            <th>Format</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="hi-panels-body"></tbody>
                </table>
            </div>
            <div class="box mt-4">
                <h3>Member Certifications</h3>
                <p style="margin-bottom: 1rem;">Track which members are cleared/certified for which facilities.</p>
                <div class="form-group">
                    <label for="cert-member">Member</label>
                    <select id="cert-member"></select>
                </div>
                <div class="form-group">
                    <label for="cert-facility">Facility</label>
                    <select id="cert-facility"></select>
                </div>
                <div class="form-group">
                    <label for="cert-date">Certification Date</label>
                    <input type="date" id="cert-date">
                </div>
                <div class="form-group">
                    <label for="cert-expiry">Expiration Date (if applicable)</label>
                    <input type="date" id="cert-expiry">
                </div>
                <div class="form-group">
                    <label for="cert-notes">Notes</label>
                    <textarea id="cert-notes" rows="2" placeholder="Background check, training completed, etc."></textarea>
                </div>
                <button class="btn" onclick="addMemberCertification()">Add Certification</button>
                <div id="certifications-list" class="mt-4"></div>
            </div>
        </section>
        <section id="cpc-section" style="border-left: 4px solid #3498db;">
            <h2><i class="fas fa-user-md"></i> CPC (Cooperation with Professional Community)</h2>
            <p class="mb-4">Professional contact list, presentation tracking, literature distribution, and Bridge-the-Gap referrals.</p>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Add Professional Contact</h3>
                        <div class="form-group">
                            <label for="prof-name">Name</label>
                            <input type="text" id="prof-name" placeholder="Professional's name">
                        </div>
                        <div class="form-group">
                            <label for="prof-title">Title/Credentials</label>
                            <input type="text" id="prof-title" placeholder="e.g., MD, LCSW, Counselor">
                        </div>
                        <div class="form-group">
                            <label for="prof-type">Professional Type</label>
                            <select id="prof-type">
                                <option value="physician">Physician/Doctor</option>
                                <option value="therapist">Therapist/Counselor</option>
                                <option value="social-worker">Social Worker</option>
                                <option value="clergy">Clergy/Chaplain</option>
                                <option value="attorney">Attorney/Legal</option>
                                <option value="educator">Educator</option>
                                <option value="employer">Employer/HR</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="prof-organization">Organization/Practice</label>
                            <input type="text" id="prof-organization" placeholder="Where they work">
                        </div>
                        <div class="form-group">
                            <label for="prof-address">Address</label>
                            <input type="text" id="prof-address" placeholder="Street address">
                        </div>
                        <div class="form-group">
                            <label for="prof-phone">Phone</label>
                            <input type="tel" id="prof-phone" placeholder="Phone number">
                        </div>
                        <div class="form-group">
                            <label for="prof-email">Email</label>
                            <input type="email" id="prof-email" placeholder="Email address">
                        </div>
                        <div class="form-group">
                            <label for="prof-specialty">Specialty/Focus</label>
                            <input type="text" id="prof-specialty" placeholder="Area of focus (e.g., addiction medicine, family therapy)">
                        </div>
                        <div class="form-group">
                            <label for="prof-referral-source">How Connected to AA</label>
                            <select id="prof-referral-source">
                                <option value="refers-clients">Refers Clients to AA</option>
                                <option value="supportive">Supportive of AA</option>
                                <option value="requests-info">Requested Information</option>
                                <option value="partnership">Partnership/Collaboration</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="prof-notes">Notes</label>
                            <textarea id="prof-notes" rows="3" placeholder="Special interests, previous presentations, etc."></textarea>
                        </div>
                        <input type="hidden" id="prof-edit-id">
                        <button id="prof-form-btn" class="btn" onclick="handleProfessionalSubmit()">Save Contact</button>
                        <button id="prof-form-cancel-btn" class="btn secondary" onclick="cancelProfessionalEdit()" style="display:none; margin-left: 0.5rem;">Cancel</button>
                    </div>
                </div>
                <div>
                    <div class="box">
                        <h3>Professional Contacts</h3>
                        <div style="margin-bottom: 1rem;">
                            <input type="text" id="prof-search" placeholder="Search contacts..." style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid #7f8c8d; background: #34495e; color: #ecf0f1;">
                        </div>
                        <div id="professionals-list" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>
                    <div class="box mt-4">
                        <h3>Log Presentation/Outreach</h3>
                        <div class="form-group">
                            <label for="pres-date">Presentation Date</label>
                            <input type="date" id="pres-date">
                        </div>
                        <div class="form-group">
                            <label for="pres-location">Location/Organization</label>
                            <input type="text" id="pres-location" placeholder="Where presentation was given">
                        </div>
                        <div class="form-group">
                            <label for="pres-audience">Audience Type</label>
                            <select id="pres-audience">
                                <option value="medical">Medical Professionals</option>
                                <option value="mental-health">Mental Health Professionals</option>
                                <option value="clergy">Clergy/Religious</option>
                                <option value="legal">Legal/Court System</option>
                                <option value="education">Educators/Students</option>
                                <option value="employers">Employers/HR</option>
                                <option value="general">General Public</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="pres-presenter">AA Presenter(s)</label>
                            <select id="pres-presenter" multiple size="3"></select>
                        </div>
                        <div class="form-group">
                            <label for="pres-attendees">Approximate Attendees</label>
                            <input type="number" id="pres-attendees" min="0" placeholder="Number of people">
                        </div>
                        <div class="form-group">
                            <label for="pres-literature">Literature Distributed</label>
                            <textarea id="pres-literature" rows="2" placeholder="List of pamphlets/materials distributed"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="pres-summary">Presentation Summary</label>
                            <textarea id="pres-summary" rows="3" placeholder="Key points covered, questions asked, feedback..."></textarea>
                        </div>
                        <button class="btn" onclick="logPresentation()">Save Presentation</button>
                    </div>
                </div>
            </div>
            <div class="box mt-4">
                <h3>Recent Presentations & Outreach</h3>
                <div id="presentations-list"></div>
            </div>
            <div class="box mt-4">
                <h3>Bridge-the-Gap Referrals</h3>
                <p style="margin-bottom: 1rem;">Temporary contacts for people relocating or leaving treatment.</p>
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <div>
                        <div class="form-group">
                            <label for="btg-referral-name">Person's First Name</label>
                            <input type="text" id="btg-referral-name" placeholder="First name only (anonymity)">
                        </div>
                        <div class="form-group">
                            <label for="btg-referral-from">Referring From</label>
                            <input type="text" id="btg-referral-from" placeholder="Treatment center, city, etc.">
                        </div>
                        <div class="form-group">
                            <label for="btg-referral-date">Referral Date</label>
                            <input type="date" id="btg-referral-date">
                        </div>
                        <div class="form-group">
                            <label for="btg-contact">Temp Contact Assigned</label>
                            <select id="btg-contact"></select>
                        </div>
                        <div class="form-group">
                            <label for="btg-contact-phone">Contact Phone (to give referral)</label>
                            <input type="tel" id="btg-contact-phone" placeholder="Temp contact's phone">
                        </div>
                        <div class="form-group">
                            <label for="btg-notes">Notes</label>
                            <textarea id="btg-notes" rows="2" placeholder="Special needs, arrival date, etc."></textarea>
                        </div>
                        <button class="btn" onclick="addBTGReferral()">Add BTG Referral</button>
                    </div>
                    <div>
                        <h4>Active BTG Referrals</h4>
                        <div id="btg-referrals-list" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
        </section>
        <section id="pi-section" style="border-left: 4px solid #1abc9c;">
            <h2><i class="fas fa-bullhorn"></i> PI (Public Information) Tools</h2>
            <p class="mb-4">Press release templates, media contact list, event planning tools, and community outreach tracking.</p>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Add Media Contact</h3>
                        <div class="form-group">
                            <label for="media-name">Contact Name</label>
                            <input type="text" id="media-name" placeholder="Reporter/Editor name">
                        </div>
                        <div class="form-group">
                            <label for="media-outlet">Media Outlet</label>
                            <input type="text" id="media-outlet" placeholder="Newspaper, TV station, radio, etc.">
                        </div>
                        <div class="form-group">
                            <label for="media-type">Media Type</label>
                            <select id="media-type">
                                <option value="newspaper">Newspaper/Print</option>
                                <option value="tv">Television</option>
                                <option value="radio">Radio</option>
                                <option value="online">Online/Blog</option>
                                <option value="podcast">Podcast</option>
                                <option value="social">Social Media</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="media-phone">Phone</label>
                            <input type="tel" id="media-phone" placeholder="Phone number">
                        </div>
                        <div class="form-group">
                            <label for="media-email">Email</label>
                            <input type="email" id="media-email" placeholder="Email address">
                        </div>
                        <div class="form-group">
                            <label for="media-beat">Beat/Specialty</label>
                            <input type="text" id="media-beat" placeholder="Health, community, etc.">
                        </div>
                        <div class="form-group">
                            <label for="media-notes">Notes</label>
                            <textarea id="media-notes" rows="2" placeholder="Previous interactions, interests..."></textarea>
                        </div>
                        <input type="hidden" id="media-edit-id">
                        <button id="media-form-btn" class="btn" onclick="handleMediaContactSubmit()">Save Media Contact</button>
                        <button id="media-form-cancel-btn" class="btn secondary" onclick="cancelMediaContactEdit()" style="display:none; margin-left: 0.5rem;">Cancel</button>
                    </div>
                    <div class="box mt-4">
                        <h3>Press Release Templates</h3>
                        <div class="form-group">
                            <label for="pr-template-type">Template Type</label>
                            <select id="pr-template-type" onchange="loadPRTemplate()">
                                <option value="">-- Select Template --</option>
                                <option value="event">Event Announcement</option>
                                <option value="milestone">Group Milestone</option>
                                <option value="psa">Public Service Announcement</option>
                                <option value="response">Response to News/Article</option>
                                <option value="awareness">Awareness Month</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="pr-content">Press Release Content</label>
                            <textarea id="pr-content" rows="10" placeholder="Press release will appear here..."></textarea>
                        </div>
                        <button class="btn" onclick="savePressRelease()">Save Press Release</button>
                        <button class="btn secondary" onclick="copyPRToClipboard()" style="margin-left: 0.5rem;">Copy to Clipboard</button>
                    </div>
                </div>
                <div>
                    <div class="box">
                        <h3>Media Contacts</h3>
                        <div id="media-contacts-list" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                    <div class="box mt-4">
                        <h3>Community Outreach Event Planning</h3>
                        <div class="form-group">
                            <label for="outreach-event-name">Event Name</label>
                            <input type="text" id="outreach-event-name" placeholder="e.g., AA Information Booth, Recovery Fair">
                        </div>
                        <div class="form-group">
                            <label for="outreach-event-date">Event Date</label>
                            <input type="date" id="outreach-event-date">
                        </div>
                        <div class="form-group">
                            <label for="outreach-event-time">Time</label>
                            <input type="time" id="outreach-event-time">
                        </div>
                        <div class="form-group">
                            <label for="outreach-event-location">Location</label>
                            <input type="text" id="outreach-event-location" placeholder="Event venue">
                        </div>
                        <div class="form-group">
                            <label for="outreach-event-type">Event Type</label>
                            <select id="outreach-event-type">
                                <option value="health-fair">Health Fair</option>
                                <option value="community-event">Community Event</option>
                                <option value="school">School Event</option>
                                <option value="workplace">Workplace Presentation</option>
                                <option value="library">Library Display</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="outreach-volunteers">Volunteers Needed</label>
                            <input type="number" id="outreach-volunteers" min="0" placeholder="Number of volunteers">
                        </div>
                        <div class="form-group">
                            <label for="outreach-materials">Materials Needed</label>
                            <textarea id="outreach-materials" rows="2" placeholder="Pamphlets, table, chairs, banner, etc."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="outreach-coordinator">Event Coordinator</label>
                            <select id="outreach-coordinator"></select>
                        </div>
                        <button class="btn" onclick="addOutreachEvent()">Create Event</button>
                    </div>
                    <div class="box mt-4">
                        <h3>Upcoming PI Events</h3>
                        <div id="outreach-events-list"></div>
                    </div>
                </div>
            </div>
            <div class="box mt-4">
                <h3>Outreach Activity Log</h3>
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                    <div class="form-group" style="flex: 1;">
                        <label for="outreach-log-date">Date</label>
                        <input type="date" id="outreach-log-date">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="outreach-log-type">Activity Type</label>
                        <select id="outreach-log-type">
                            <option value="display">Literature Display</option>
                            <option value="presentation">Presentation</option>
                            <option value="media">Media Interview</option>
                            <option value="booth">Information Booth</option>
                            <option value="distribution">Literature Distribution</option>
                            <option value="meeting">PI Committee Meeting</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="outreach-log-location">Location/Organization</label>
                    <input type="text" id="outreach-log-location" placeholder="Where activity took place">
                </div>
                <div class="form-group">
                    <label for="outreach-log-volunteers">AA Volunteers</label>
                    <select id="outreach-log-volunteers" multiple size="3"></select>
                </div>
                <div class="form-group">
                    <label for="outreach-log-reach">Estimated Reach</label>
                    <input type="number" id="outreach-log-reach" placeholder="Number of people reached" min="0">
                </div>
                <div class="form-group">
                    <label for="outreach-log-literature">Literature Distributed</label>
                    <textarea id="outreach-log-literature" rows="2" placeholder="List of materials distributed and quantities"></textarea>
                </div>
                <div class="form-group">
                    <label for="outreach-log-notes">Activity Summary</label>
                    <textarea id="outreach-log-notes" rows="3" placeholder="What happened, feedback received, follow-up needed..."></textarea>
                </div>
                <button class="btn" onclick="logOutreachActivity()">Log Activity</button>
                <div id="outreach-log-list" class="mt-4"></div>
            </div>
        </section>
        <section id="treatment-liaison-section" style="border-left: 4px solid #e74c3c;">
            <h2><i class="fas fa-clinic-medical"></i> Treatment Facilities Liaison</h2>
            <p class="mb-4">Facility meeting schedules, bridging commitments, temporary contact assignments, and follow-up tracking.</p>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Add Treatment Facility</h3>
                        <div class="form-group">
                            <label for="treatment-facility-name">Facility Name</label>
                            <input type="text" id="treatment-facility-name" placeholder="Treatment center name">
                        </div>
                        <div class="form-group">
                            <label for="treatment-facility-type">Facility Type</label>
                            <select id="treatment-facility-type">
                                <option value="inpatient">Inpatient Treatment</option>
                                <option value="outpatient">Outpatient Treatment</option>
                                <option value="detox">Detox Center</option>
                                <option value="sober-living">Sober Living Home</option>
                                <option value="dual-diagnosis">Dual Diagnosis Facility</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="treatment-facility-address">Address</label>
                            <input type="text" id="treatment-facility-address" placeholder="Street address">
                        </div>
                        <div class="form-group">
                            <label for="treatment-facility-contact">Contact Person</label>
                            <input type="text" id="treatment-facility-contact" placeholder="Primary contact name">
                        </div>
                        <div class="form-group">
                            <label for="treatment-facility-phone">Phone</label>
                            <input type="tel" id="treatment-facility-phone" placeholder="Phone number">
                        </div>
                        <div class="form-group">
                            <label for="treatment-facility-schedule">Meeting Schedule</label>
                            <textarea id="treatment-facility-schedule" rows="3" placeholder="e.g., Tuesdays 7PM, Saturdays 10AM"></textarea>
                        </div>
                        <input type="hidden" id="treatment-facility-edit-id">
                        <button id="treatment-facility-form-btn" class="btn" onclick="handleTreatmentFacilitySubmit()">Save Facility</button>
                        <button id="treatment-facility-form-cancel-btn" class="btn secondary" onclick="cancelTreatmentFacilityEdit()" style="display:none; margin-left: 0.5rem;">Cancel</button>
                    </div>
                    <div class="box mt-4">
                        <h3>Bridging Commitment</h3>
                        <div class="form-group">
                            <label for="bridge-facility">Facility</label>
                            <select id="bridge-facility"></select>
                        </div>
                        <div class="form-group">
                            <label for="bridge-client-name">Client Name (First Name Only)</label>
                            <input type="text" id="bridge-client-name" placeholder="First name for anonymity">
                        </div>
                        <div class="form-group">
                            <label for="bridge-release-date">Expected Release Date</label>
                            <input type="date" id="bridge-release-date">
                        </div>
                        <div class="form-group">
                            <label for="bridge-contact">Temporary Contact</label>
                            <select id="bridge-contact"></select>
                        </div>
                        <div class="form-group">
                            <label for="bridge-contact-phone">Contact Phone</label>
                            <input type="tel" id="bridge-contact-phone" placeholder="Phone to give client">
                        </div>
                        <div class="form-group">
                            <label for="bridge-notes">Notes</label>
                            <textarea id="bridge-notes" rows="2" placeholder="Special needs, preferences, etc."></textarea>
                        </div>
                        <button class="btn" onclick="addBridgingCommitment()">Create Bridging Commitment</button>
                    </div>
                </div>
                <div>
                    <div class="box">
                        <h3>Treatment Facilities</h3>
                        <div id="treatment-facilities-list" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                    <div class="box mt-4">
                        <h3>Active Bridging Commitments</h3>
                        <div id="bridging-commitments-list" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                    <div class="box mt-4">
                        <h3>Follow-Up Tracking</h3>
                        <div class="form-group">
                            <label for="followup-bridge">Select Bridging Commitment</label>
                            <select id="followup-bridge"></select>
                        </div>
                        <div class="form-group">
                            <label for="followup-date">Follow-Up Date</label>
                            <input type="date" id="followup-date">
                        </div>
                        <div class="form-group">
                            <label for="followup-status">Status</label>
                            <select id="followup-status">
                                <option value="contacted">Contacted - Attending Meetings</option>
                                <option value="struggling">Contacted - Struggling</option>
                                <option value="no-contact">Unable to Reach</option>
                                <option value="completed">Successfully Transitioned</option>
                                <option value="declined">Declined Further Contact</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="followup-notes">Follow-Up Notes</label>
                            <textarea id="followup-notes" rows="3" placeholder="Details of follow-up contact..."></textarea>
                        </div>
                        <button class="btn" onclick="logFollowUp()">Log Follow-Up</button>
                    </div>
                </div>
            </div>
        </section>
        <section id="corrections-section" style="border-left: 4px solid #95a5a6;">
            <h2><i class="fas fa-balance-scale"></i> Corrections Committee</h2>
            <p class="mb-4">Facility clearances, pre-release contact program, correspondence tracking, and reentry support.</p>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Add Correctional Facility</h3>
                        <div class="form-group">
                            <label for="corrections-facility-name">Facility Name</label>
                            <input type="text" id="corrections-facility-name" placeholder="Jail/prison name">
                        </div>
                        <div class="form-group">
                            <label for="corrections-facility-type">Facility Type</label>
                            <select id="corrections-facility-type">
                                <option value="county-jail">County Jail</option>
                                <option value="state-prison">State Prison</option>
                                <option value="federal-prison">Federal Prison</option>
                                <option value="juvenile">Juvenile Facility</option>
                                <option value="work-release">Work Release Center</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="corrections-facility-address">Address</label>
                            <input type="text" id="corrections-facility-address" placeholder="Facility address">
                        </div>
                        <div class="form-group">
                            <label for="corrections-facility-contact">Chaplain/Volunteer Coordinator</label>
                            <input type="text" id="corrections-facility-contact" placeholder="Contact name">
                        </div>
                        <div class="form-group">
                            <label for="corrections-facility-phone">Phone</label>
                            <input type="tel" id="corrections-facility-phone" placeholder="Phone number">
                        </div>
                        <div class="form-group">
                            <label for="corrections-clearance-req">Clearance Requirements</label>
                            <textarea id="corrections-clearance-req" rows="3" placeholder="Background check, training, approvals needed..."></textarea>
                        </div>
                        <input type="hidden" id="corrections-facility-edit-id">
                        <button id="corrections-facility-form-btn" class="btn" onclick="handleCorrectionsFacilitySubmit()">Save Facility</button>
                        <button id="corrections-facility-form-cancel-btn" class="btn secondary" onclick="cancelCorrectionsFacilityEdit()" style="display:none; margin-left: 0.5rem;">Cancel</button>
                    </div>
                    <div class="box mt-4">
                        <h3>Member Clearances</h3>
                        <div class="form-group">
                            <label for="corrections-clearance-member">Member</label>
                            <select id="corrections-clearance-member"></select>
                        </div>
                        <div class="form-group">
                            <label for="corrections-clearance-facility">Facility</label>
                            <select id="corrections-clearance-facility"></select>
                        </div>
                        <div class="form-group">
                            <label for="corrections-clearance-date">Clearance Date</label>
                            <input type="date" id="corrections-clearance-date">
                        </div>
                        <div class="form-group">
                            <label for="corrections-clearance-expiry">Expiration Date</label>
                            <input type="date" id="corrections-clearance-expiry">
                        </div>
                        <div class="form-group">
                            <label for="corrections-clearance-notes">Notes</label>
                            <textarea id="corrections-clearance-notes" rows="2" placeholder="Clearance level, restrictions, etc."></textarea>
                        </div>
                        <button class="btn" onclick="addCorrectionsClearance()">Add Clearance</button>
                    </div>
                </div>
                <div>
                    <div class="box">
                        <h3>Correctional Facilities</h3>
                        <div id="corrections-facilities-list" style="max-height: 250px; overflow-y: auto;"></div>
                    </div>
                    <div class="box mt-4">
                        <h3>Pre-Release Contact Program</h3>
                        <div class="form-group">
                            <label for="prerelease-name">Individual's First Name</label>
                            <input type="text" id="prerelease-name" placeholder="First name only">
                        </div>
                        <div class="form-group">
                            <label for="prerelease-facility">Current Facility</label>
                            <select id="prerelease-facility"></select>
                        </div>
                        <div class="form-group">
                            <label for="prerelease-date">Expected Release Date</label>
                            <input type="date" id="prerelease-date">
                        </div>
                        <div class="form-group">
                            <label for="prerelease-contact">Assigned Contact</label>
                            <select id="prerelease-contact"></select>
                        </div>
                        <div class="form-group">
                            <label for="prerelease-correspondence">Correspondence Method</label>
                            <select id="prerelease-correspondence">
                                <option value="mail">Mail/Letters</option>
                                <option value="email">Email (JPay/Corrlinks)</option>
                                <option value="phone">Phone Calls</option>
                                <option value="video">Video Visits</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="prerelease-needs">Reentry Needs</label>
                            <textarea id="prerelease-needs" rows="3" placeholder="Housing, employment, meetings, sponsor, etc."></textarea>
                        </div>
                        <button class="btn" onclick="addPreReleaseContact()">Add Pre-Release Contact</button>
                        <div id="prerelease-list" class="mt-4"></div>
                    </div>
                </div>
            </div>
            <div class="box mt-4">
                <h3>Correspondence Tracking</h3>
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <div>
                        <div class="form-group">
                            <label for="correspondence-prerelease">Select Contact</label>
                            <select id="correspondence-prerelease"></select>
                        </div>
                        <div class="form-group">
                            <label for="correspondence-date">Correspondence Date</label>
                            <input type="date" id="correspondence-date">
                        </div>
                        <div class="form-group">
                            <label for="correspondence-type">Type</label>
                            <select id="correspondence-type">
                                <option value="sent">Letter Sent</option>
                                <option value="received">Letter Received</option>
                                <option value="call-made">Phone Call Made</option>
                                <option value="call-received">Phone Call Received</option>
                                <option value="visit">In-Person Visit</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="correspondence-summary">Summary</label>
                            <textarea id="correspondence-summary" rows="3" placeholder="Brief summary of correspondence..."></textarea>
                        </div>
                        <button class="btn" onclick="logCorrespondence()">Log Correspondence</button>
                    </div>
                    <div>
                        <h4>Recent Correspondence</h4>
                        <div id="correspondence-log" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
        </section>
        <section id="special-events-mgmt-section" style="border-left: 4px solid #9b59b6;">
            <h2><i class="fas fa-calendar-star"></i> Special Events Management</h2>
            <p class="mb-4">Event planning checklists, speaker booking, budget planning, volunteer sign-ups, and ticket sales.</p>
            <button class="btn mb-3" onclick="exportSpecialEventsPDF()" style="background: #9b59b6;">
                <i class="fas fa-file-pdf"></i> Export Events Report to PDF
            </button>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Create Special Event</h3>
                        <div class="form-group">
                            <label for="event-mgmt-name">Event Name</label>
                            <input type="text" id="event-mgmt-name" placeholder="e.g., Unity Day, Founders Day, Alcathon">
                        </div>
                        <div class="form-group">
                            <label for="event-mgmt-type">Event Type</label>
                            <select id="event-mgmt-type">
                                <option value="unity-day">Unity Day</option>
                                <option value="founders-day">Founders Day</option>
                                <option value="alcathon">Alcathon (24-hour)</option>
                                <option value="conference">Conference/Convention</option>
                                <option value="speaker-jam">Speaker Jam</option>
                                <option value="gratitude-dinner">Gratitude Dinner</option>
                                <option value="picnic">Group Picnic/Social</option>
                                <option value="fundraiser">Fundraiser</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="event-mgmt-date">Event Date</label>
                            <input type="date" id="event-mgmt-date">
                        </div>
                        <div class="form-group">
                            <label for="event-mgmt-time">Event Time</label>
                            <input type="time" id="event-mgmt-time">
                        </div>
                        <div class="form-group">
                            <label for="event-mgmt-location">Venue/Location</label>
                            <input type="text" id="event-mgmt-location" placeholder="Event venue">
                        </div>
                        <div class="form-group">
                            <label for="event-mgmt-coordinator">Event Coordinator</label>
                            <select id="event-mgmt-coordinator"></select>
                        </div>
                        <div class="form-group">
                            <label for="event-mgmt-budget">Estimated Budget</label>
                            <input type="number" id="event-mgmt-budget" step="0.01" min="0" placeholder="Total budget">
                        </div>
                        <div class="form-group">
                            <label for="event-mgmt-capacity">Expected Attendance</label>
                            <input type="number" id="event-mgmt-capacity" min="0" placeholder="Number of attendees">
                        </div>
                        <input type="hidden" id="event-mgmt-edit-id">
                        <button id="event-mgmt-form-btn" class="btn" onclick="handleEventMgmtSubmit()">Create Event</button>
                        <button id="event-mgmt-form-cancel-btn" class="btn secondary" onclick="cancelEventMgmtEdit()" style="display:none; margin-left: 0.5rem;">Cancel</button>
                    </div>
                </div>
                <div>
                    <div class="box">
                        <h3>Upcoming Events</h3>
                        <div id="events-mgmt-list" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
            <div class="box mt-4">
                <h3>Speaker Booking</h3>
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <div>
                        <div class="form-group">
                            <label for="speaker-event">Select Event</label>
                            <select id="speaker-event"></select>
                        </div>
                        <div class="form-group">
                            <label for="speaker-name">Speaker Name</label>
                            <input type="text" id="speaker-name" placeholder="Speaker's full name">
                        </div>
                        <div class="form-group">
                            <label for="speaker-topic">Topic/Story</label>
                            <input type="text" id="speaker-topic" placeholder="e.g., Rock Bottom to Recovery">
                        </div>
                        <div class="form-group">
                            <label for="speaker-time-slot">Time Slot</label>
                            <input type="time" id="speaker-time-slot">
                        </div>
                        <div class="form-group">
                            <label for="speaker-duration">Duration (minutes)</label>
                            <input type="number" id="speaker-duration" min="15" step="15" placeholder="e.g., 30, 45, 60">
                        </div>
                        <div class="form-group">
                            <label for="speaker-contact">Contact Info</label>
                            <input type="text" id="speaker-contact" placeholder="Phone or email">
                        </div>
                        <div class="form-group">
                            <label for="speaker-confirmed">Confirmation Status</label>
                            <select id="speaker-confirmed">
                                <option value="pending">Pending Confirmation</option>
                                <option value="confirmed">Confirmed</option>
                                <option value="tentative">Tentative</option>
                                <option value="declined">Declined</option>
                            </select>
                        </div>
                        <button class="btn" onclick="bookSpeaker()">Book Speaker</button>
                    </div>
                    <div>
                        <h4>Booked Speakers</h4>
                        <div id="speakers-list" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
            <div class="box mt-4">
                <h3>Volunteer Sign-Ups</h3>
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <div>
                        <div class="form-group">
                            <label for="volunteer-event">Select Event</label>
                            <select id="volunteer-event"></select>
                        </div>
                        <div class="form-group">
                            <label for="volunteer-role">Role/Task</label>
                            <select id="volunteer-role">
                                <option value="setup">Setup/Decorations</option>
                                <option value="registration">Registration/Check-In</option>
                                <option value="greeter">Greeter/Welcome</option>
                                <option value="literature">Literature Table</option>
                                <option value="food">Food/Refreshments</option>
                                <option value="av-tech">AV/Tech Support</option>
                                <option value="cleanup">Cleanup</option>
                                <option value="parking">Parking/Directions</option>
                                <option value="childcare">Childcare</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="volunteer-member">Volunteer</label>
                            <select id="volunteer-member"></select>
                        </div>
                        <div class="form-group">
                            <label for="volunteer-shift">Shift Time</label>
                            <input type="text" id="volunteer-shift" placeholder="e.g., 9AM-12PM, 12PM-3PM">
                        </div>
                        <button class="btn" onclick="signUpVolunteer()">Sign Up Volunteer</button>
                    </div>
                    <div>
                        <h4>Volunteer Schedule</h4>
                        <div id="volunteers-schedule" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
            <div class="box mt-4">
                <h3>Event Budget Tracking</h3>
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <div>
                        <div class="form-group">
                            <label for="event-expense-event">Select Event</label>
                            <select id="event-expense-event"></select>
                        </div>
                        <div class="form-group">
                            <label for="event-expense-category">Expense Category</label>
                            <select id="event-expense-category">
                                <option value="venue">Venue Rental</option>
                                <option value="food">Food/Catering</option>
                                <option value="decorations">Decorations</option>
                                <option value="av-equipment">AV Equipment</option>
                                <option value="literature">Literature/Materials</option>
                                <option value="printing">Printing/Flyers</option>
                                <option value="entertainment">Entertainment/Speaker</option>
                                <option value="supplies">Supplies</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="event-expense-amount">Amount</label>
                            <input type="number" id="event-expense-amount" step="0.01" min="0" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label for="event-expense-paid">Status</label>
                            <select id="event-expense-paid">
                                <option value="planned">Planned</option>
                                <option value="paid">Paid</option>
                                <option value="reimbursed">Reimbursed</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="event-expense-notes">Notes</label>
                            <textarea id="event-expense-notes" rows="2" placeholder="Vendor, receipt number, etc."></textarea>
                        </div>
                        <button class="btn" onclick="logEventExpense()">Log Expense</button>
                    </div>
                    <div>
                        <h4>Event Budget Summary</h4>
                        <div id="event-budget-summary"></div>
                    </div>
                </div>
            </div>
            <div class="box mt-4">
                <h3>Ticket Sales (Optional)</h3>
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <div>
                        <div class="form-group">
                            <label for="ticket-event">Select Event</label>
                            <select id="ticket-event"></select>
                        </div>
                        <div class="form-group">
                            <label for="ticket-price">Ticket Price</label>
                            <input type="number" id="ticket-price" step="0.01" min="0" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label for="tickets-sold">Tickets Sold</label>
                            <input type="number" id="tickets-sold" min="0" placeholder="Number sold">
                        </div>
                        <div class="form-group">
                            <label for="ticket-revenue">Total Revenue</label>
                            <input type="number" id="ticket-revenue" step="0.01" min="0" placeholder="Calculated automatically" readonly>
                        </div>
                        <button class="btn" onclick="updateTicketSales()">Update Ticket Sales</button>
                    </div>
                    <div>
                        <h4>Ticket Sales Summary</h4>
                        <div id="ticket-sales-summary"></div>
                    </div>
                </div>
            </div>
        </section>
        <section id="archives-section" style="border-left: 4px solid #8e44ad;">
            <h2><i class="fas fa-archive"></i> Archives Management</h2>
            <p class="mb-4">Digital document scanning, historical minutes indexing, Founder's Day materials, and old-timer interviews.</p>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Add Archive Document</h3>
                        <div class="form-group">
                            <label for="archive-title">Document Title</label>
                            <input type="text" id="archive-title" placeholder="e.g., Group Conscience Minutes - Jan 1990">
                        </div>
                        <div class="form-group">
                            <label for="archive-category">Category</label>
                            <select id="archive-category">
                                <option value="minutes">Meeting Minutes</option>
                                <option value="gc-history">Group Conscience History</option>
                                <option value="founders-day">Founder's Day Materials</option>
                                <option value="newsletters">Newsletters</option>
                                <option value="photographs">Photographs</option>
                                <option value="interviews">Old-Timer Interviews</option>
                                <option value="correspondence">Correspondence</option>
                                <option value="flyers">Flyers/Announcements</option>
                                <option value="guidelines">Guidelines/By-Laws</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="archive-date">Document Date</label>
                            <input type="date" id="archive-date">
                        </div>
                        <div class="form-group">
                            <label for="archive-year">Year (for indexing)</label>
                            <input type="number" id="archive-year" min="1935" max="2100" placeholder="e.g., 1985">
                        </div>
                        <div class="form-group">
                            <label for="archive-description">Description</label>
                            <textarea id="archive-description" rows="3" placeholder="Brief description of document contents..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="archive-tags">Tags (comma-separated)</label>
                            <input type="text" id="archive-tags" placeholder="e.g., founding members, traditions, anniversaries">
                        </div>
                        <div class="form-group">
                            <label for="archive-location">Physical Location</label>
                            <input type="text" id="archive-location" placeholder="e.g., Box 3, Folder 12">
                        </div>
                        <div class="form-group">
                            <label>Document File (Note: Files stored as reference only)</label>
                            <input type="file" id="archive-file" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
                            <small style="font-size: 0.75rem; opacity: 0.8;">File names are stored for reference. Actual files should be stored externally.</small>
                        </div>
                        <input type="hidden" id="archive-edit-id">
                        <button id="archive-form-btn" class="btn" onclick="handleArchiveSubmit()">Save Archive Document</button>
                        <button id="archive-form-cancel-btn" class="btn secondary" onclick="cancelArchiveEdit()" style="display:none; margin-left: 0.5rem;">Cancel</button>
                    </div>
                </div>
                <div>
                    <div class="box">
                        <h3>Archive Search & Browse</h3>
                        <div class="form-group">
                            <label for="archive-search">Search Archives</label>
                            <input type="text" id="archive-search" placeholder="Search by title, description, or tags..." oninput="searchArchives()">
                        </div>
                        <div class="form-group">
                            <label for="archive-filter-category">Filter by Category</label>
                            <select id="archive-filter-category" onchange="filterArchives()">
                                <option value="all">All Categories</option>
                                <option value="minutes">Meeting Minutes</option>
                                <option value="gc-history">Group Conscience History</option>
                                <option value="founders-day">Founder's Day Materials</option>
                                <option value="newsletters">Newsletters</option>
                                <option value="photographs">Photographs</option>
                                <option value="interviews">Old-Timer Interviews</option>
                                <option value="correspondence">Correspondence</option>
                                <option value="flyers">Flyers/Announcements</option>
                                <option value="guidelines">Guidelines/By-Laws</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="archive-filter-decade">Filter by Decade</label>
                            <select id="archive-filter-decade" onchange="filterArchives()">
                                <option value="all">All Years</option>
                                <option value="2020s">2020s</option>
                                <option value="2010s">2010s</option>
                                <option value="2000s">2000s</option>
                                <option value="1990s">1990s</option>
                                <option value="1980s">1980s</option>
                                <option value="1970s">1970s</option>
                                <option value="1960s">1960s</option>
                                <option value="1950s">1950s</option>
                                <option value="earlier">Earlier</option>
                            </select>
                        </div>
                        <div id="archives-list" style="max-height: 400px; overflow-y: auto; margin-top: 1rem;"></div>
                    </div>
                </div>
            </div>
            <div class="box mt-4">
                <h3>Old-Timer Interviews</h3>
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <div>
                        <div class="form-group">
                            <label for="interview-name">Old-Timer's Name</label>
                            <input type="text" id="interview-name" placeholder="Member's name">
                        </div>
                        <div class="form-group">
                            <label for="interview-date">Interview Date</label>
                            <input type="date" id="interview-date">
                        </div>
                        <div class="form-group">
                            <label for="interview-sobriety-date">Sobriety Date</label>
                            <input type="date" id="interview-sobriety-date">
                        </div>
                        <div class="form-group">
                            <label for="interview-joined-group">Joined Group (Year)</label>
                            <input type="number" id="interview-joined-group" min="1935" max="2100" placeholder="Year joined">
                        </div>
                        <div class="form-group">
                            <label for="interview-interviewer">Interviewer</label>
                            <select id="interview-interviewer"></select>
                        </div>
                        <div class="form-group">
                            <label for="interview-format">Interview Format</label>
                            <select id="interview-format">
                                <option value="audio">Audio Recording</option>
                                <option value="video">Video Recording</option>
                                <option value="written">Written Transcript</option>
                                <option value="notes">Interview Notes</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="interview-topics">Topics Covered</label>
                            <textarea id="interview-topics" rows="3" placeholder="Key topics: early group history, traditions, memorable events, etc."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="interview-summary">Interview Summary</label>
                            <textarea id="interview-summary" rows="4" placeholder="Brief summary of interview content..."></textarea>
                        </div>
                        <button class="btn" onclick="addInterview()">Save Interview</button>
                    </div>
                    <div>
                        <h4>Recorded Interviews</h4>
                        <div id="interviews-list" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
            <div class="box mt-4">
                <h3>Group History Timeline</h3>
                <div id="history-timeline"></div>
            </div>
        </section>
        <section id="language-access-section" style="border-left: 4px solid #27ae60;">
            <h2><i class="fas fa-language"></i> Language Accessibility</h2>
            <p class="mb-4">Multi-language meeting materials, translation volunteers, sign language interpreters, and closed captioning.</p>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Translation Volunteers</h3>
                        <div class="form-group">
                            <label for="translator-member">Member</label>
                            <select id="translator-member"></select>
                        </div>
                        <div class="form-group">
                            <label for="translator-language">Language</label>
                            <select id="translator-language">
                                <option value="spanish">Spanish</option>
                                <option value="french">French</option>
                                <option value="german">German</option>
                                <option value="italian">Italian</option>
                                <option value="portuguese">Portuguese</option>
                                <option value="russian">Russian</option>
                                <option value="chinese">Chinese (Mandarin)</option>
                                <option value="japanese">Japanese</option>
                                <option value="korean">Korean</option>
                                <option value="arabic">Arabic</option>
                                <option value="asl">American Sign Language</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="translator-proficiency">Proficiency Level</label>
                            <select id="translator-proficiency">
                                <option value="native">Native Speaker</option>
                                <option value="fluent">Fluent</option>
                                <option value="conversational">Conversational</option>
                                <option value="basic">Basic</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="translator-availability">Availability</label>
                            <textarea id="translator-availability" rows="2" placeholder="Days/times available for translation..."></textarea>
                        </div>
                        <button class="btn" onclick="addTranslator()">Add Translator</button>
                        <div id="translators-list" class="mt-4"></div>
                    </div>
                    <div class="box mt-4">
                        <h3>Multi-Language Materials</h3>
                        <div class="form-group">
                            <label for="material-title">Material Title</label>
                            <input type="text" id="material-title" placeholder="e.g., Meeting Format, Traditions">
                        </div>
                        <div class="form-group">
                            <label for="material-language">Language</label>
                            <select id="material-language">
                                <option value="spanish">Spanish</option>
                                <option value="french">French</option>
                                <option value="german">German</option>
                                <option value="italian">Italian</option>
                                <option value="portuguese">Portuguese</option>
                                <option value="russian">Russian</option>
                                <option value="chinese">Chinese</option>
                                <option value="japanese">Japanese</option>
                                <option value="korean">Korean</option>
                                <option value="arabic">Arabic</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="material-type">Material Type</label>
                            <select id="material-type">
                                <option value="format">Meeting Format</option>
                                <option value="traditions">Twelve Traditions</option>
                                <option value="steps">Twelve Steps</option>
                                <option value="prayers">Prayers</option>
                                <option value="pamphlet">Pamphlet</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="material-content">Content/Text</label>
                            <textarea id="material-content" rows="5" placeholder="Translated text..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="material-translator">Translated By</label>
                            <select id="material-translator"></select>
                        </div>
                        <button class="btn" onclick="addMaterial()">Save Material</button>
                    </div>
                </div>
                <div>
                    <div class="box">
                        <h3>Sign Language Interpreter Scheduling</h3>
                        <div class="form-group">
                            <label for="interpreter-name">Interpreter Name</label>
                            <input type="text" id="interpreter-name" placeholder="Interpreter's name">
                        </div>
                        <div class="form-group">
                            <label for="interpreter-certification">Certification</label>
                            <select id="interpreter-certification">
                                <option value="rid-ci">RID CI (Certificate of Interpretation)</option>
                                <option value="rid-ct">RID CT (Certificate of Transliteration)</option>
                                <option value="nad">NAD Certified</option>
                                <option value="educational">Educational Interpreter</option>
                                <option value="volunteer">Volunteer (Non-Certified)</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="interpreter-contact">Contact Info</label>
                            <input type="text" id="interpreter-contact" placeholder="Phone or email">
                        </div>
                        <div class="form-group">
                            <label for="interpreter-rate">Rate/Fee</label>
                            <input type="text" id="interpreter-rate" placeholder="e.g., $50/hour, Volunteer">
                        </div>
                        <button class="btn" onclick="addInterpreter()">Add Interpreter</button>
                        <div id="interpreters-list" class="mt-4"></div>
                    </div>
                    <div class="box mt-4">
                        <h3>Schedule Interpreter</h3>
                        <div class="form-group">
                            <label for="interp-schedule-meeting">Meeting/Event</label>
                            <input type="text" id="interp-schedule-meeting" placeholder="e.g., Sunday 10AM Meeting">
                        </div>
                        <div class="form-group">
                            <label for="interp-schedule-date">Date</label>
                            <input type="date" id="interp-schedule-date">
                        </div>
                        <div class="form-group">
                            <label for="interp-schedule-time">Time</label>
                            <input type="time" id="interp-schedule-time">
                        </div>
                        <div class="form-group">
                            <label for="interp-schedule-interpreter">Interpreter</label>
                            <select id="interp-schedule-interpreter"></select>
                        </div>
                        <div class="form-group">
                            <label for="interp-schedule-confirmed">Confirmation Status</label>
                            <select id="interp-schedule-confirmed">
                                <option value="pending">Pending</option>
                                <option value="confirmed">Confirmed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                        <button class="btn" onclick="scheduleInterpreter()">Schedule</button>
                        <div id="interpreter-schedule" class="mt-4"></div>
                    </div>
                    <div class="box mt-4">
                        <h3>Closed Captioning Setup</h3>
                        <div class="form-group">
                            <label for="caption-platform">Virtual Meeting Platform</label>
                            <select id="caption-platform">
                                <option value="zoom">Zoom</option>
                                <option value="google-meet">Google Meet</option>
                                <option value="teams">Microsoft Teams</option>
                                <option value="webex">Webex</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="caption-service">Captioning Service</label>
                            <select id="caption-service">
                                <option value="auto">Automatic (Platform Built-in)</option>
                                <option value="rev">Rev Live Captioning</option>
                                <option value="ai-media">AI-Media</option>
                                <option value="cart">CART (Real-Time Stenography)</option>
                                <option value="volunteer">Volunteer Captioner</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="caption-enabled">Status</label>
                            <select id="caption-enabled">
                                <option value="active">Active</option>
                                <option value="available">Available on Request</option>
                                <option value="testing">Testing Phase</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="caption-notes">Setup Notes</label>
                            <textarea id="caption-notes" rows="3" placeholder="Configuration details, API keys, instructions..."></textarea>
                        </div>
                        <button class="btn" onclick="saveCaptionSetup()">Save Caption Setup</button>
                    </div>
                </div>
            </div>
            <div class="box mt-4">
                <h3>Available Materials by Language</h3>
                <div id="materials-by-language"></div>
            </div>
        </section>
        <section id="prudent-reserve-section" style="border-left: 4px solid #f1c40f;">
            <h2><i class="fas fa-piggy-bank"></i> Prudent Reserve Tracking</h2>
            <p class="mb-4">Set reserve targets, visualize operational vs reserve balance, and track trends.</p>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Prudent Reserve Settings</h3>
                        <div class="form-group">
                            <label for="reserve-target">Target Reserve Amount ($)</label>
                            <input type="number" id="reserve-target" step="0.01" placeholder="0.00">
                            <small style="font-size: 0.75rem; opacity: 0.8;">Recommended: 3-6 months of operating expenses</small>
                        </div>
                        <div class="form-group">
                            <label for="monthly-expenses">Estimated Monthly Expenses ($)</label>
                            <input type="number" id="monthly-expenses" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label for="reserve-months">Reserve Target (Months)</label>
                            <input type="number" id="reserve-months" min="1" max="12" value="3">
                        </div>
                        <button class="btn" onclick="calculateReserveTarget()">Calculate Target</button>
                        <button class="btn secondary" onclick="saveReserveSettings()" style="margin-left: 0.5rem;">Save Settings</button>
                    </div>
                    <div class="box mt-4">
                        <h3>Current Financial Status</h3>
                        <div id="reserve-status" style="padding: 1rem; background: #2c3e50; border-radius: 6px;">
                            <div class="mb-2"><strong>Total Balance:</strong> $<span id="total-balance">0.00</span></div>
                            <div class="mb-2"><strong>Prudent Reserve:</strong> $<span id="current-reserve">0.00</span></div>
                            <div class="mb-2"><strong>Operating Balance:</strong> $<span id="operating-balance">0.00</span></div>
                            <div class="mb-2"><strong>Reserve Target:</strong> $<span id="display-reserve-target">0.00</span></div>
                            <div class="mb-2"><strong>Status:</strong> <span id="reserve-health-status">--</span></div>
                            <div style="margin-top: 1rem;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span style="font-size: 0.85rem; color: #ecf0f1;">Reserve Progress</span>
                                    <span id="reserve-percentage" style="font-size: 0.85rem; font-weight: bold; color: #3498db;">0%</span>
                                </div>
                                <div style="width: 100%; height: 24px; background: #34495e; border-radius: 12px; overflow: hidden; position: relative;">
                                    <div id="reserve-progress-bar" style="height: 100%; width: 0%; background: linear-gradient(90deg, #e74c3c 0%, #f39c12 33%, #f1c40f 66%, #2ecc71 100%); transition: width 0.5s ease; display: flex; align-items: center; justify-content: center;">
                                        <span id="reserve-progress-text" style="font-size: 0.75rem; font-weight: bold; color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); position: absolute;"></span>
                                    </div>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-top: 0.25rem; font-size: 0.7rem; color: #95a5a6;">
                                    <span>0 months</span>
                                    <span>Target: <span id="reserve-target-months">3</span> months</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div>
                    <div class="box">
                        <h3>Reserve vs Operating Balance</h3>
                        <canvas id="reserve-balance-chart" style="max-height: 300px;"></canvas>
                    </div>
                    <div class="box mt-4">
                        <h3>7th Tradition Trend Analysis</h3>
                        <canvas id="seventh-tradition-trend-chart" style="max-height: 300px;"></canvas>
                    </div>
                    <div class="box mt-4">
                        <h3>Contribution Source Breakdown</h3>
                        <canvas id="contribution-source-chart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>
        </section>
        <section id="seventh-tradition-section" style="border-left: 4px solid #f1c40f;">
            <h2><i class="fas fa-hand-holding-usd"></i> 7th Tradition Analysis</h2>
            <p class="mb-4">Detailed analysis of contribution patterns and trends.</p>
            <div class="box mb-4">
                <h3>Contribution Trends</h3>
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                    <button class="btn" onclick="load7thTraditionPeriod('weekly')">Weekly</button>
                    <button class="btn" onclick="load7thTraditionPeriod('monthly')">Monthly</button>
                    <button class="btn" onclick="load7thTraditionPeriod('quarterly')">Quarterly</button>
                    <button class="btn" onclick="load7thTraditionPeriod('yearly')">Yearly</button>
                </div>
                <canvas id="seventh-tradition-detail-chart"></canvas>
            </div>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div class="box">
                    <h3>Statistics</h3>
                    <div id="seventh-tradition-stats">
                        <div class="mb-2"><strong>Average per Meeting:</strong> $<span id="avg-per-meeting">0.00</span></div>
                        <div class="mb-2"><strong>Highest Contribution:</strong> $<span id="highest-contribution">0.00</span></div>
                        <div class="mb-2"><strong>Lowest Contribution:</strong> $<span id="lowest-contribution">0.00</span></div>
                        <div class="mb-2"><strong>YTD Total:</strong> $<span id="ytd-total">0.00</span></div>
                        <div class="mb-2"><strong>Trend:</strong> <span id="contribution-trend">--</span></div>
                    </div>
                </div>
                <div class="box">
                    <h3>Goals & Targets</h3>
                    <div class="form-group">
                        <label for="contribution-goal">Monthly Contribution Goal ($)</label>
                        <input type="number" id="contribution-goal" step="0.01" placeholder="0.00">
                    </div>
                    <button class="btn" onclick="saveContributionGoal()">Save Goal</button>
                    <div id="goal-progress" class="mt-4"></div>
                </div>
            </div>
        </section>
        <section id="chip-inventory-section" style="border-left: 4px solid #f1c40f;">
            <h2><i class="fas fa-medal"></i> Sobriety Chip Inventory</h2>
            <p class="mb-4">Track chip stock levels, set low stock alerts, and log distributions.</p>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Update Chip Inventory</h3>
                        <div class="form-group">
                            <label for="chip-type">Chip Type</label>
                            <select id="chip-type">
                                <option value="24-hour">24 Hours (White)</option>
                                <option value="30-day">30 Days (Red)</option>
                                <option value="60-day">60 Days (Gold)</option>
                                <option value="90-day">90 Days (Green)</option>
                                <option value="6-month">6 Months (Blue)</option>
                                <option value="9-month">9 Months (Purple)</option>
                                <option value="1-year">1 Year (Bronze)</option>
                                <option value="18-month">18 Months</option>
                                <option value="multi-year">Multi-Year</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="chip-quantity">Current Quantity</label>
                            <input type="number" id="chip-quantity" min="0" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label for="chip-low-threshold">Low Stock Alert Threshold</label>
                            <input type="number" id="chip-low-threshold" min="0" placeholder="5">
                        </div>
                        <button class="btn" onclick="updateChipInventory()">Update Inventory</button>
                    </div>
                    <div class="box mt-4">
                        <h3>Log Chip Distribution</h3>
                        <div class="form-group">
                            <label for="dist-chip-type">Chip Type</label>
                            <select id="dist-chip-type">
                                <option value="24-hour">24 Hours</option>
                                <option value="30-day">30 Days</option>
                                <option value="60-day">60 Days</option>
                                <option value="90-day">90 Days</option>
                                <option value="6-month">6 Months</option>
                                <option value="9-month">9 Months</option>
                                <option value="1-year">1 Year</option>
                                <option value="18-month">18 Months</option>
                                <option value="multi-year">Multi-Year</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="dist-recipient">Recipient (Optional)</label>
                            <input type="text" id="dist-recipient" placeholder="Name">
                        </div>
                        <div class="form-group">
                            <label for="dist-date">Date</label>
                            <input type="date" id="dist-date">
                        </div>
                        <button class="btn" onclick="logChipDistribution()">Log Distribution</button>
                    </div>
                </div>
                <div>
                    <div class="box">
                        <h3>Current Inventory Status</h3>
                        <table id="chip-inventory-table">
                            <thead>
                                <tr>
                                    <th>Chip Type</th>
                                    <th>Quantity</th>
                                    <th>Status</th>
                                    <th>Alert Threshold</th>
                                </tr>
                            </thead>
                            <tbody id="chip-inventory-body"></tbody>
                        </table>
                    </div>
                    <div class="box mt-4">
                        <h3>Low Stock Alerts</h3>
                        <div id="chip-alerts"></div>
                    </div>
                    <div class="box mt-4">
                        <h3>Recent Distributions</h3>
                        <table id="chip-distribution-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Chip Type</th>
                                    <th>Recipient</th>
                                </tr>
                            </thead>
                            <tbody id="chip-distribution-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
        <section id="voting-settings-section" style="border-left: 4px solid #9b59b6;">
            <h2><i class="fas fa-vote-yea"></i> Voting Settings & Methods</h2>
            <p class="mb-4">Configure your group's preferred voting method for Group Conscience decisions.</p>
            <div class="box mb-4">
                <h3>Current Voting Method</h3>
                <div id="current-voting-display" style="padding: 1.5rem; background: #2c3e50; border-radius: 6px;">
                    <div style="font-size: 1.2rem; font-weight: bold; color: #3498db;" id="current-method-name">Substantial Unanimity</div>
                    <div style="margin-top: 0.5rem; color: #95a5a6;" id="current-method-desc">Requires 2/3 majority (66.67%)</div>
                </div>
            </div>
            <div class="box">
                <h3>Configure Voting Method</h3>
                <div class="form-group">
                    <label for="voting-method">Voting Method</label>
                    <select id="voting-method" onchange="updateVotingMethodDisplay()">
                        <option value="substantialUnanimity">Substantial Unanimity (2/3 Majority)</option>
                        <option value="simpleMajority">Simple Majority (50% + 1)</option>
                        <option value="unanimousConsent">Unanimous Consent (100%)</option>
                        <option value="senseOfMeeting">Sense of the Meeting (Consensus)</option>
                        <option value="custom">Custom Threshold</option>
                    </select>
                    <small style="font-size: 0.75rem; opacity: 0.8;">Most AA groups use Substantial Unanimity (2/3 majority)</small>
                </div>
                <div class="form-group" id="custom-threshold-group" style="display: none;">
                    <label for="custom-threshold">Custom Threshold (%)</label>
                    <input type="number" id="custom-threshold" min="1" max="100" step="0.1" placeholder="66.67">
                    <small style="font-size: 0.75rem; opacity: 0.8;">Enter the percentage required for a motion to pass</small>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="allow-abstain" checked>
                        Allow Abstain Votes
                    </label>
                    <small style="font-size: 0.75rem; opacity: 0.8; display: block; margin-top: 0.25rem;">When enabled, abstentions are not counted in the total</small>
                </div>
                <button class="btn" onclick="saveVotingSettings()">Save Voting Settings</button>
            </div>
            <div class="box mt-4">
                <h3>Voting Method Descriptions</h3>
                <div style="padding: 1rem; background: #2c3e50; border-radius: 6px;">
                    <div class="mb-3">
                        <strong style="color: #3498db;">Substantial Unanimity (2/3):</strong>
                        <p style="font-size: 0.9rem; margin-top: 0.25rem;">The traditional AA method. Requires at least 66.67% approval. Respects the minority opinion while allowing the group to move forward.</p>
                    </div>
                    <div class="mb-3">
                        <strong style="color: #3498db;">Simple Majority (50% + 1):</strong>
                        <p style="font-size: 0.9rem; margin-top: 0.25rem;">Requires just over half of votes to be in favor. Used for routine, non-controversial decisions.</p>
                    </div>
                    <div class="mb-3">
                        <strong style="color: #3498db;">Unanimous Consent:</strong>
                        <p style="font-size: 0.9rem; margin-top: 0.25rem;">Requires 100% agreement. Reserved for major decisions affecting the group's foundation.</p>
                    </div>
                    <div>
                        <strong style="color: #3498db;">Sense of the Meeting:</strong>
                        <p style="font-size: 0.9rem; margin-top: 0.25rem;">Informal consensus-based decision making. Chairperson gauges general agreement without formal vote count.</p>
                    </div>
                </div>
            </div>
        </section>
        <section id="motion-templates-section" style="border-left: 4px solid #9b59b6;">
            <h2><i class="fas fa-file-signature"></i> Motion Templates</h2>
            <p class="mb-4">Pre-formatted motion templates for common AA Group Conscience items.</p>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Create/Edit Template</h3>
                        <div class="form-group">
                            <label for="template-name">Template Name</label>
                            <input type="text" id="template-name" placeholder="e.g., Change Meeting Format">
                        </div>
                        <div class="form-group">
                            <label for="template-category">Category</label>
                            <select id="template-category">
                                <option value="Finance">Finance</option>
                                <option value="Service">Service</option>
                                <option value="Meeting Format">Meeting Format</option>
                                <option value="Group Health">Group Health</option>
                                <option value="Literature">Literature</option>
                                <option value="Special Events">Special Events</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="template-text">Motion Template Text</label>
                            <textarea id="template-text" rows="4" placeholder="Motion to... Use [placeholders] for values to be filled in."></textarea>
                            <small style="font-size: 0.75rem; opacity: 0.8;">Use square brackets [like this] for placeholders</small>
                        </div>
                        <input type="hidden" id="template-edit-id">
                        <button id="template-form-btn" class="btn" onclick="saveMotionTemplate()">Add Template</button>
                        <button id="template-form-cancel-btn" class="btn secondary" onclick="cancelTemplateEdit()" style="display:none; margin-left: 0.5rem;">Cancel</button>
                    </div>
                </div>
                <div>
                    <div class="box">
                        <h3>Available Templates</h3>
                        <div id="templates-filter" class="form-group">
                            <select id="template-filter-category" onchange="renderMotionTemplates()">
                                <option value="all">All Categories</option>
                                <option value="Finance">Finance</option>
                                <option value="Service">Service</option>
                                <option value="Meeting Format">Meeting Format</option>
                                <option value="Group Health">Group Health</option>
                                <option value="Literature">Literature</option>
                                <option value="Special Events">Special Events</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div id="motion-templates-list" style="max-height: 500px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
        </section>
        <section id="tradition-checker-section" style="border-left: 4px solid #9b59b6;">
            <h2><i class="fas fa-check-circle"></i> Tradition & Concept Checker</h2>
            <p class="mb-4">Ensure your motions align with AA's 12 Traditions and 12 Concepts.</p>
            <div class="box mb-4">
                <h3>Check a Motion</h3>
                <div class="form-group">
                    <label for="check-motion-text">Motion to Check</label>
                    <textarea id="check-motion-text" rows="3" placeholder="Enter the motion you want to check..."></textarea>
                </div>
                <button class="btn" onclick="checkTraditionsAndConcepts()">Analyze Motion</button>
            </div>
            <div id="tradition-check-results" style="display: none;">
                <div class="box mb-4" style="border-left: 4px solid #f39c12;">
                    <h3 style="color: #f39c12;"><i class="fas fa-exclamation-triangle"></i> Potential Issues</h3>
                    <div id="tradition-warnings"></div>
                </div>
                <div class="box mb-4" style="border-left: 4px solid #3498db;">
                    <h3 style="color: #3498db;"><i class="fas fa-info-circle"></i> Relevant Traditions</h3>
                    <div id="relevant-traditions"></div>
                </div>
                <div class="box mb-4" style="border-left: 4px solid #9b59b6;">
                    <h3 style="color: #9b59b6;"><i class="fas fa-lightbulb"></i> Relevant Concepts</h3>
                    <div id="relevant-concepts"></div>
                </div>
                <div class="box" style="border-left: 4px solid #2ecc71;">
                    <h3 style="color: #2ecc71;"><i class="fas fa-question-circle"></i> Guided Questions</h3>
                    <div id="guided-questions"></div>
                </div>
            </div>
            <div class="box mt-4">
                <h3>Quick Reference</h3>
                <div style="display: flex; gap: 1rem;">
                    <button class="btn secondary" onclick="showTraditionsReference()">View 12 Traditions</button>
                    <button class="btn secondary" onclick="showConceptsReference()">View 12 Concepts</button>
                </div>
            </div>
        </section>
        <section id="parliamentary-section" style="border-left: 4px solid #9b59b6;">
            <h2><i class="fas fa-gavel"></i> Parliamentary Procedure Assistant</h2>
            <p class="mb-4">Guide motions through proper parliamentary procedure.</p>
            <div class="grid" style="grid-template-columns: 2fr 1fr; gap: 2rem;">
                <div>
                    <div class="box mb-4">
                        <h3>Current Motion Workflow</h3>
                        <div id="motion-workflow-display" style="padding: 1rem; background: #2c3e50; border-radius: 6px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                                <div class="workflow-step" style="flex: 1; text-align: center; padding: 1rem; border-radius: 4px;" id="step-motion">
                                    <div style="font-weight: bold;">1. Motion</div>
                                    <div style="font-size: 0.8rem; opacity: 0.7;">Member proposes</div>
                                </div>
                                <div style="color: #3498db; font-size: 1.5rem;">→</div>
                                <div class="workflow-step" style="flex: 1; text-align: center; padding: 1rem; border-radius: 4px;" id="step-second">
                                    <div style="font-weight: bold;">2. Second</div>
                                    <div style="font-size: 0.8rem; opacity: 0.7;">Another supports</div>
                                </div>
                                <div style="color: #3498db; font-size: 1.5rem;">→</div>
                                <div class="workflow-step" style="flex: 1; text-align: center; padding: 1rem; border-radius: 4px;" id="step-discussion">
                                    <div style="font-weight: bold;">3. Discussion</div>
                                    <div style="font-size: 0.8rem; opacity: 0.7;">Group discusses</div>
                                </div>
                                <div style="color: #3498db; font-size: 1.5rem;">→</div>
                                <div class="workflow-step" style="flex: 1; text-align: center; padding: 1rem; border-radius: 4px;" id="step-vote">
                                    <div style="font-weight: bold;">4. Vote</div>
                                    <div style="font-size: 0.8rem; opacity: 0.7;">Group decides</div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button class="btn" onclick="advanceMotionWorkflow()">Advance to Next Step</button>
                            <button class="btn secondary" onclick="resetMotionWorkflow()">Reset Workflow</button>
                        </div>
                    </div>
                    <div class="box">
                        <h3>Speaking Queue</h3>
                        <div class="form-group">
                            <label for="speaker-name">Add Speaker to Queue</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <select id="speaker-name" style="flex: 1;">
                                    <option value="">-- Select Member --</option>
                                </select>
                                <button class="btn" onclick="addToSpeakingQueue()">Add</button>
                            </div>
                        </div>
                        <div id="speaking-queue-list" style="min-height: 200px; max-height: 400px; overflow-y: auto;"></div>
                        <div id="discussion-timer-display" style="margin-top: 1rem; padding: 1rem; background: #2c3e50; border-radius: 6px; text-align: center; display: none;">
                            <div style="font-size: 2rem; font-weight: bold; color: #3498db;" id="timer-display">3:00</div>
                            <div style="margin-top: 0.5rem;">
                                <button class="btn secondary" onclick="startSpeakerTimer()">Start</button>
                                <button class="btn secondary" onclick="pauseSpeakerTimer()">Pause</button>
                                <button class="btn secondary" onclick="resetSpeakerTimer()">Reset</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div>
                    <div class="box mb-4">
                        <h3>Quick Actions</h3>
                        <button class="btn mb-2" onclick="callForSecond()" style="width: 100%;">Call for Second</button>
                        <button class="btn mb-2" onclick="openDiscussion()" style="width: 100%;">Open Discussion</button>
                        <button class="btn mb-2" onclick="closeDiscussion()" style="width: 100%;">Close Discussion</button>
                        <button class="btn mb-2" onclick="callTheQuestion()" style="width: 100%;">Call the Question</button>
                        <button class="btn mb-2" onclick="tableMotion()" style="width: 100%;">Table Motion</button>
                    </div>
                    <div class="box">
                        <h3>Points of Order</h3>
                        <button class="btn secondary mb-2" onclick="pointOfInformation()" style="width: 100%; font-size: 0.85rem;">Point of Information</button>
                        <button class="btn secondary mb-2" onclick="pointOfOrder()" style="width: 100%; font-size: 0.85rem;">Point of Order</button>
                        <button class="btn secondary mb-2" onclick="pointOfPrivilege()" style="width: 100%; font-size: 0.85rem;">Point of Privilege</button>
                        <button class="btn secondary mb-2" onclick="parliamentaryInquiry()" style="width: 100%; font-size: 0.85rem;">Parliamentary Inquiry</button>
                    </div>
                    <div class="box mt-4">
                        <h3>Advanced Procedures</h3>
                        <button class="btn mb-2" onclick="divisionOfAssembly()" style="width: 100%; font-size: 0.85rem; background: #e67e22;">
                            <i class="fas fa-users-viewfinder"></i> Division of Assembly
                        </button>
                        <button class="btn mb-2" onclick="withdrawMotion()" style="width: 100%; font-size: 0.85rem; background: #95a5a6;">
                            <i class="fas fa-ban"></i> Withdraw Motion
                        </button>
                        <button class="btn mb-2" onclick="divisionOfQuestion()" style="width: 100%; font-size: 0.85rem; background: #3498db;">
                            <i class="fas fa-divide"></i> Division of Question
                        </button>
                        <button class="btn mb-2" onclick="appealChairRuling()" style="width: 100%; font-size: 0.85rem; background: #e74c3c;">
                            <i class="fas fa-gavel"></i> Appeal Chair's Ruling
                        </button>
                        <button class="btn mb-2" onclick="objectionToConsideration()" style="width: 100%; font-size: 0.85rem; background: #c0392b;">
                            <i class="fas fa-hand"></i> Objection to Consideration
                        </button>
                        <button class="btn mb-2" onclick="suspendRules()" style="width: 100%; font-size: 0.85rem; background: #8e44ad;">
                            <i class="fas fa-exclamation-triangle"></i> Suspend the Rules
                        </button>
                    </div>
                    <div class="box mt-4" style="border-left: 4px solid #3498db;">
                        <h3><i class="fas fa-divide"></i> Division of Question Workspace</h3>
                        <p class="mb-3" style="font-size: 0.85rem; opacity: 0.8;">
                            Split a complex motion into separate votable parts
                        </p>
                        <div style="padding: 1rem; background: #3498db; border-radius: 4px; margin-bottom: 1.5rem;">
                            <i class="fas fa-info-circle"></i> <strong>Roberts Rules:</strong> Division of Question allows splitting a complex motion into separate questions for independent voting. Each part is voted on separately. Requires 2/3 vote to divide.
                        </div>
                        <div class="form-group">
                            <label for="original-motion-text">Original Motion</label>
                            <textarea id="original-motion-text" rows="3" placeholder="Enter the original complex motion..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="divided-part-1">Part 1</label>
                            <textarea id="divided-part-1" rows="2" placeholder="First independent part..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="divided-part-2">Part 2</label>
                            <textarea id="divided-part-2" rows="2" placeholder="Second independent part..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="divided-part-3">Part 3 (Optional)</label>
                            <textarea id="divided-part-3" rows="2" placeholder="Third independent part (if needed)..."></textarea>
                        </div>
                        <button class="btn" onclick="processDivisionOfQuestion()">Process Division</button>
                        <div id="division-status" class="mt-3"></div>
                    </div>
                    <div class="box mt-4">
                        <h3>Amendments</h3>
                        <div class="form-group">
                            <label for="amendment-text">Proposed Amendment</label>
                            <textarea id="amendment-text" rows="2" placeholder="Describe the amendment..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="radio" name="amendment-type" value="friendly" checked> Friendly Amendment
                            </label>
                            <label style="margin-left: 1rem;">
                                <input type="radio" name="amendment-type" value="unfriendly"> Unfriendly Amendment
                            </label>
                        </div>
                        <button class="btn" onclick="proposeAmendment()">Propose Amendment</button>
                        <div id="active-amendments-list" class="mt-3"></div>
                    </div>
                </div>
            </div>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 2rem;">
                <div>
                    <div class="box mb-4">
                        <h3><i class="fas fa-layer-group"></i> Motion Stack (Precedence Order)</h3>
                        <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem;">Higher precedence motions must be resolved first</p>
                        <div id="motion-stack" style="min-height: 150px;">
                            <p style="opacity: 0.6; text-align: center; padding: 2rem;">No active motions</p>
                        </div>
                    </div>
                    <div class="box mb-4">
                        <h3><i class="fas fa-vote-yea"></i> Voting Method</h3>
                        <div class="form-group">
                            <label for="voting-method">Select Method</label>
                            <select id="voting-method" onchange="updateVotingMethod()">
                                <option value="voice">Voice Vote (Aye/Nay)</option>
                                <option value="show-hands">Show of Hands</option>
                                <option value="roll-call">Roll Call</option>
                                <option value="written-ballot">Written Ballot (Anonymous)</option>
                                <option value="consensus" selected>Consensus (AA Substantial Unanimity)</option>
                            </select>
                        </div>
                        <div id="vote-counter" style="display: none; margin-top: 1rem;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label>For</label>
                                    <input type="number" id="votes-for-input" min="0" value="0" style="width: 100%;">
                                </div>
                                <div>
                                    <label>Against</label>
                                    <input type="number" id="votes-against-input" min="0" value="0" style="width: 100%;">
                                </div>
                                <div>
                                    <label>Abstain</label>
                                    <input type="number" id="votes-abstain-input" min="0" value="0" style="width: 100%;">
                                </div>
                            </div>
                            <div id="vote-result" style="margin-top: 1rem; padding: 1rem; background: #2c3e50; border-radius: 4px; display: none;">
                                <div style="font-weight: bold; font-size: 1.1rem;" id="vote-result-text"></div>
                                <div style="font-size: 0.9rem; opacity: 0.8; margin-top: 0.5rem;" id="vote-result-details"></div>
                            </div>
                            <button class="btn mt-2" onclick="calculateVoteResult()" style="width: 100%;">Calculate Result</button>
                        </div>
                    </div>
                </div>
                <div>
                    <div class="box mb-4" style="border-left: 4px solid #3498db;">
                        <h3><i class="fas fa-users"></i> Quorum Status</h3>
                        <div id="quorum-display" style="padding: 1rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>Required:</span>
                                <strong id="quorum-required">0</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>Present:</span>
                                <strong id="quorum-present">0</strong>
                            </div>
                            <div style="margin-top: 1rem; padding: 0.75rem; border-radius: 4px;" id="quorum-status">
                                <i class="fas fa-info-circle"></i> Enter attendance to check quorum
                            </div>
                        </div>
                        <button class="btn secondary" onclick="goToSection('quorum-management-section')" style="width: 100%; margin-top: 0.5rem;">
                            Configure Quorum Settings
                        </button>
                    </div>
                    <div class="box mb-4" style="border-left: 4px solid #f39c12;">
                        <h3><i class="fas fa-balance-scale"></i> Minority Opinion Protection</h3>
                        <p style="font-size: 0.9rem; margin-bottom: 1rem; opacity: 0.9;">
                            When a motion passes with significant opposition (&gt;33%), the minority has the right to have their concerns heard and recorded per AA Tradition.
                        </p>
                        <div id="minority-report-section" style="display: none;">
                            <label>Minority Concerns</label>
                            <textarea id="minority-concerns" rows="3" placeholder="Record minority viewpoint..."></textarea>
                            <button class="btn mt-2" onclick="saveMinorityReport()" style="width: 100%;">Save Minority Report</button>
                        </div>
                        <div id="minority-not-needed" style="padding: 1rem; background: #2c3e50; border-radius: 4px; text-align: center;">
                            <i class="fas fa-check-circle" style="color: #2ecc71;"></i>
                            <div style="margin-top: 0.5rem; font-size: 0.9rem;">No minority report needed</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <section id="service-elections-section" style="border-left: 4px solid #2ecc71;">
            <h2><i class="fas fa-poll"></i> Service Position Elections</h2>
            <p class="mb-4">Conduct elections for service positions with eligibility checking and term tracking.</p>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box mb-4">
                        <h3>Start New Election</h3>
                        <div class="form-group">
                            <label for="election-position">Service Position</label>
                            <select id="election-position" onchange="updateElectionEligibility()">
                                <option value="">-- Select Position --</option>
                            </select>
                        </div>
                        <div id="position-requirements" style="padding: 0.75rem; background: #2c3e50; border-radius: 4px; margin-bottom: 1rem; display: none;">
                            <strong>Requirements:</strong>
                            <div id="position-req-details"></div>
                        </div>
                        <div class="form-group">
                            <label for="election-date">Election Date</label>
                            <input type="date" id="election-date">
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="election-anonymous"> Anonymous Ballot
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="election-method">Voting Method</label>
                            <select id="election-method">
                                <option value="simple">Simple Majority</option>
                                <option value="runoff">Runoff (if no majority)</option>
                                <option value="ranked">Ranked Choice</option>
                            </select>
                        </div>
                        <button class="btn" onclick="startElection()">Start Election</button>
                    </div>
                    <div class="box">
                        <h3>Nominations</h3>
                        <div id="current-election-info" style="display: none; padding: 0.75rem; background: #2c3e50; border-radius: 4px; margin-bottom: 1rem;">
                            <strong>Current Election:</strong> <span id="current-election-position"></span>
                        </div>
                        <div class="form-group">
                            <label for="nominee-select">Nominate Member</label>
                            <select id="nominee-select">
                                <option value="">-- Select Member --</option>
                            </select>
                        </div>
                        <div id="nominee-eligibility-check"></div>
                        <button class="btn" onclick="nominateMember()">Nominate</button>
                        <div id="nominees-list" class="mt-3"></div>
                    </div>
                </div>
                <div>
                    <div class="box mb-4">
                        <h3>Cast Ballots</h3>
                        <div id="ballot-interface"></div>
                    </div>
                    <div class="box mb-4">
                        <h3>Current Service Positions</h3>
                        <table id="current-positions-table">
                            <thead>
                                <tr>
                                    <th>Position</th>
                                    <th>Holder</th>
                                    <th>Term Ends</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="current-positions-body"></tbody>
                        </table>
                    </div>
                    <div class="box">
                        <h3>Election History</h3>
                        <div id="election-history-list" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
        </section>
        <section id="budget-approval-section" style="border-left: 4px solid #f1c40f;">
            <h2><i class="fas fa-file-invoice-dollar"></i> Budget Approval Workflow</h2>
            <p class="mb-4">Propose, review, and vote on annual budgets and budget amendments.</p>
            <button class="btn mb-3" onclick="exportBudgetReportPDF()" style="background: #f1c40f;">
                <i class="fas fa-file-pdf"></i> Export Budget Report to PDF
            </button>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Create Budget Proposal</h3>
                        <div class="form-group">
                            <label for="budget-year">Fiscal Year</label>
                            <input type="number" id="budget-year" min="2020" max="2050" placeholder="2024">
                        </div>
                        <div class="form-group">
                            <label for="budget-type">Budget Type</label>
                            <select id="budget-type">
                                <option value="annual">Annual Budget</option>
                                <option value="amendment">Budget Amendment</option>
                                <option value="special">Special Project Budget</option>
                            </select>
                        </div>
                        <div id="budget-categories-input">
                            <h4 class="mt-3 mb-2">Budget Line Items</h4>
                            <div id="budget-line-items"></div>
                            <button class="btn secondary" onclick="addBudgetLineItem()">Add Line Item</button>
                        </div>
                        <div class="form-group mt-3">
                            <label>Total Proposed Budget: $<span id="total-proposed-budget">0.00</span></label>
                        </div>
                        <button class="btn mt-2" onclick="submitBudgetProposal()">Submit for GC Approval</button>
                    </div>
                </div>
                <div>
                    <div class="box mb-4">
                        <h3>Pending Budget Proposals</h3>
                        <div id="pending-budgets-list"></div>
                    </div>
                    <div class="box mb-4">
                        <h3>Approved Budgets</h3>
                        <div id="approved-budgets-list"></div>
                    </div>
                    <div class="box">
                        <h3>Budget vs Actual (Current Year)</h3>
                        <canvas id="budget-actual-chart" style="max-height: 300px;"></canvas>
                        <div id="budget-variance-summary" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </section>
        <section id="literature-inventory-section" style="border-left: 4px solid #95a5a6;">
            <h2><i class="fas fa-book-reader"></i> Literature & Supplies Inventory</h2>
            <p class="mb-4">Track AA literature, supplies, and loan management.</p>
            <button class="btn mb-3" onclick="exportLiteratureInventoryPDF()" style="background: #95a5a6;">
                <i class="fas fa-file-pdf"></i> Export Inventory to PDF
            </button>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Add/Update Literature Item</h3>
                        <div class="form-group">
                            <label for="lit-item-name">Item Name</label>
                            <input type="text" id="lit-item-name" placeholder="e.g., Big Book, Living Sober">
                        </div>
                        <div class="form-group">
                            <label for="lit-item-type">Type</label>
                            <select id="lit-item-type">
                                <option value="book">Book</option>
                                <option value="pamphlet">Pamphlet</option>
                                <option value="chip">Chip/Medallion</option>
                                <option value="supplies">Meeting Supplies</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="lit-quantity">Quantity in Stock</label>
                            <input type="number" id="lit-quantity" min="0" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label for="lit-min-quantity">Minimum Stock Alert</label>
                            <input type="number" id="lit-min-quantity" min="0" placeholder="5">
                        </div>
                        <div class="form-group">
                            <label for="lit-cost">Unit Cost ($)</label>
                            <input type="number" id="lit-cost" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="lit-loanable"> Available for Loan
                            </label>
                        </div>
                        <input type="hidden" id="lit-edit-id">
                        <button id="lit-form-btn" class="btn" onclick="saveLiteratureItem()">Add Item</button>
                        <button id="lit-form-cancel-btn" class="btn secondary" onclick="cancelLitEdit()" style="display:none; margin-left: 0.5rem;">Cancel</button>
                    </div>
                </div>
                <div>
                    <div class="box mb-4">
                        <h3>Current Inventory</h3>
                        <table id="literature-inventory-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Type</th>
                                    <th>Quantity</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="literature-inventory-body"></tbody>
                        </table>
                    </div>
                    <div class="box">
                        <h3>Low Stock Alerts</h3>
                        <div id="lit-low-stock-alerts"></div>
                    </div>
                </div>
            </div>
            <div class="box mt-4">
                <h3>Literature Loans</h3>
                <div class="grid" style="grid-template-columns: 1fr 2fr; gap: 2rem;">
                    <div>
                        <h4>Check Out Literature</h4>
                        <div class="form-group">
                            <label for="loan-member">Member</label>
                            <select id="loan-member">
                                <option value="">-- Select Member --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="loan-item">Literature Item</label>
                            <select id="loan-item">
                                <option value="">-- Select Item --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="loan-due-date">Due Date</label>
                            <input type="date" id="loan-due-date">
                        </div>
                        <button class="btn" onclick="checkOutLiterature()">Check Out</button>
                    </div>
                    <div>
                        <h4>Active Loans</h4>
                        <table id="literature-loans-table">
                            <thead>
                                <tr>
                                    <th>Member</th>
                                    <th>Item</th>
                                    <th>Due Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="literature-loans-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="box mt-4">
                <h3>Purchase Approval</h3>
                <p class="mb-2">Submit purchase requests for Group Conscience approval</p>
                <div class="form-group">
                    <label for="purchase-items">Items to Purchase</label>
                    <textarea id="purchase-items" rows="2" placeholder="List items and quantities..."></textarea>
                </div>
                <div class="form-group">
                    <label for="purchase-estimated-cost">Estimated Cost ($)</label>
                    <input type="number" id="purchase-estimated-cost" step="0.01" placeholder="0.00">
                </div>
                <button class="btn" onclick="submitLiteraturePurchaseRequest()">Submit for GC Approval</button>
            </div>
        </section>
        <section id="district-motions-section" style="border-left: 4px solid #2ecc71;">
            <h2><i class="fas fa-building"></i> District & Area Motions</h2>
            <p class="mb-4">Track district and area motions that require group input, and record the group's positions.</p>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Add District/Area Motion</h3>
                        <div class="form-group">
                            <label for="district-motion-source">Source</label>
                            <select id="district-motion-source">
                                <option value="district">District Meeting</option>
                                <option value="area">Area Assembly</option>
                                <option value="conference">General Service Conference</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="district-motion-title">Motion Title</label>
                            <input type="text" id="district-motion-title" placeholder="Brief title">
                        </div>
                        <div class="form-group">
                            <label for="district-motion-text">Motion Details</label>
                            <textarea id="district-motion-text" rows="4" placeholder="Full motion text..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="district-motion-deadline">Response Deadline</label>
                            <input type="date" id="district-motion-deadline">
                        </div>
                        <div class="form-group">
                            <label for="district-motion-background">Background Information</label>
                            <textarea id="district-motion-background" rows="3" placeholder="Context and background..."></textarea>
                        </div>
                        <input type="hidden" id="district-motion-edit-id">
                        <button id="district-motion-form-btn" class="btn" onclick="saveDistrictMotion()">Add Motion</button>
                        <button id="district-motion-cancel-btn" class="btn secondary" onclick="cancelDistrictMotionEdit()" style="display:none; margin-left: 0.5rem;">Cancel</button>
                    </div>
                </div>
                <div>
                    <div class="box mb-4">
                        <h3>Pending Responses</h3>
                        <div id="pending-district-motions-list"></div>
                    </div>
                    <div class="box">
                        <h3>Group Position History</h3>
                        <div id="district-motions-history-list" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
            <div class="box mt-4">
                <h3>Record Group's Position</h3>
                <div class="form-group">
                    <label for="position-motion-select">Select Motion</label>
                    <select id="position-motion-select">
                        <option value="">-- Select Motion --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="group-position">Group's Position</label>
                    <select id="group-position">
                        <option value="support">Support</option>
                        <option value="oppose">Oppose</option>
                        <option value="abstain">Abstain</option>
                        <option value="needs-info">Needs More Information</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="position-rationale">Rationale</label>
                    <textarea id="position-rationale" rows="3" placeholder="Why did the group take this position?"></textarea>
                </div>
                <div class="form-group">
                    <label for="position-vote-count">Vote Count</label>
                    <input type="text" id="position-vote-count" placeholder="e.g., 15-3-2 (For-Against-Abstain)">
                </div>
                <button class="btn" onclick="recordGroupPosition()">Record Position</button>
            </div>
        </section>
        <section id="quorum-management-section" style="border-left: 4px solid #34495e;">
            <h2><i class="fas fa-users-cog"></i> Quorum Management</h2>
            <p class="mb-4">Configure quorum requirements for group conscience voting and different types of decisions.</p>
            <div class="box mb-4" style="border-left: 4px solid #3498db;">
                <h3><i class="fas fa-cog"></i> Default Group Conscience Settings</h3>
                <p style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 1.5rem;">
                    Set the default quorum requirements for standard group conscience votes.
                </p>
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="quorum-percentage">Quorum Percentage (%)</label>
                        <input type="number" id="quorum-percentage" min="1" max="100" placeholder="50">
                        <small style="font-size: 0.75rem; opacity: 0.8;">Percentage of total members required for quorum</small>
                    </div>
                    <div class="form-group">
                        <label for="quorum-minimum">Minimum Quorum Count</label>
                        <input type="number" id="quorum-minimum" min="1" placeholder="5">
                        <small style="font-size: 0.75rem; opacity: 0.8;">Minimum number of members required regardless of percentage</small>
                    </div>
                </div>
                <button class="btn" onclick="saveGCSettings()">
                    <i class="fas fa-save"></i> Save Default Settings
                </button>
            </div>
            <h3 class="mt-4"><i class="fas fa-list-alt"></i> Category-Specific Quorum Rules</h3>
            <p class="mb-4" style="font-size: 0.85rem; opacity: 0.8;">
                Create custom quorum requirements for specific types of decisions (e.g., financial decisions may require higher quorum).
            </p>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Add/Edit Quorum Rule</h3>
                        <div class="form-group">
                            <label for="quorum-category">Decision Category</label>
                            <input type="text" id="quorum-category" placeholder="e.g., Financial Decisions">
                        </div>
                        <div class="form-group">
                            <label for="quorum-percent">Quorum Percentage (%)</label>
                            <input type="number" id="quorum-percent" min="1" max="100" placeholder="60">
                        </div>
                        <div class="form-group">
                            <label for="quorum-min-count">Minimum Count</label>
                            <input type="number" id="quorum-min-count" min="1" placeholder="7">
                        </div>
                        <div class="form-group">
                            <label for="quorum-desc">Description</label>
                            <textarea id="quorum-desc" rows="2" placeholder="When this quorum applies..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="quorum-allow-proxy"> Allow Proxy Voting
                            </label>
                        </div>
                        <input type="hidden" id="quorum-edit-id">
                        <button id="quorum-form-btn" class="btn" onclick="saveQuorumRule()">Add Rule</button>
                        <button id="quorum-cancel-btn" class="btn secondary" onclick="cancelQuorumEdit()" style="display:none; margin-left: 0.5rem;">Cancel</button>
                    </div>
                    <div class="box mt-4">
                        <h3>Live Quorum Check</h3>
                        <div class="form-group">
                            <label for="live-quorum-attendees">Current Attendees</label>
                            <input type="number" id="live-quorum-attendees" min="0" placeholder="12">
                        </div>
                        <div class="form-group">
                            <label for="live-quorum-category">Motion Category</label>
                            <select id="live-quorum-category">
                                <option value="">-- Select Category --</option>
                            </select>
                        </div>
                        <button class="btn" onclick="checkLiveQuorum()">Check Quorum Status</button>
                        <div id="live-quorum-result" class="mt-3" style="display: none;"></div>
                    </div>
                </div>
                <div>
                    <div class="box">
                        <h3>Quorum Rules</h3>
                        <table id="quorum-rules-table">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Quorum</th>
                                    <th>Proxy</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="quorum-rules-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
        <section id="meeting-minutes-section" style="border-left: 4px solid #1abc9c;">
            <h2><i class="fas fa-file-alt"></i> Meeting Minutes</h2>
            <p class="mb-4">Auto-generated minutes from Group Conscience meetings with approval workflow.</p>
            <div class="box mb-4">
                <h3>Generate Minutes from GC Log</h3>
                <p class="mb-2">Select a Group Conscience meeting to auto-generate formatted minutes</p>
                <div class="form-group">
                    <label for="minutes-gc-select">Select GC Meeting Date</label>
                    <select id="minutes-gc-select">
                        <option value="">-- Select Meeting --</option>
                    </select>
                </div>
                <button class="btn" onclick="generateMinutesFromGC()">Generate Minutes</button>
            </div>
            <div class="grid" style="grid-template-columns: 2fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3 id="minutes-editor-title">Minute Editor</h3>
                        <div id="minutes-preview" style="padding: 1rem; background: #2c3e50; border-radius: 6px; min-height: 400px; max-height: 600px; overflow-y: auto;">
                            <p style="opacity: 0.7;">Generate or select minutes to edit</p>
                        </div>
                        <div class="mt-3">
                            <button class="btn" onclick="saveMinutes()">Save Minutes</button>
                            <button class="btn secondary" onclick="approveMinutes()">Approve Minutes</button>
                            <button class="btn secondary" onclick="exportMinutesPDF()">Export PDF</button>
                        </div>
                    </div>
                </div>
                <div>
                    <div class="box mb-4">
                        <h3>Minutes Archive</h3>
                        <div id="minutes-archive-list" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>
                    <div class="box">
                        <h3>Secretary Settings</h3>
                        <div class="form-group">
                            <label for="secretary-name">Secretary Name</label>
                            <input type="text" id="secretary-name" placeholder="John S.">
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="auto-generate-minutes"> Auto-generate after each GC
                            </label>
                        </div>
                        <button class="btn" onclick="saveSecretarySettings()">Save Settings</button>
                    </div>
                </div>
            </div>
        </section>
        <section id="participation-analytics-section" style="border-left: 4px solid #1abc9c;">
            <h2><i class="fas fa-chart-line"></i> Participation Analytics</h2>
            <p class="mb-4">Privacy-conscious analytics on meeting attendance and voting participation.</p>
            <div class="grid" style="grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem;">
                <div style="padding: 1.5rem; background: #34495e; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2.5rem; color: #3498db; font-weight: bold;" id="avg-attendance">0</div>
                    <div style="margin-top: 0.5rem; opacity: 0.8;">Avg GC Attendance</div>
                </div>
                <div style="padding: 1.5rem; background: #34495e; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2.5rem; color: #2ecc71; font-weight: bold;" id="voting-participation">0%</div>
                    <div style="margin-top: 0.5rem; opacity: 0.8;">Voting Participation</div>
                </div>
                <div style="padding: 1.5rem; background: #34495e; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2.5rem; color: #f39c12; font-weight: bold;" id="avg-meeting-length">0</div>
                    <div style="margin-top: 0.5rem; opacity: 0.8;">Avg Meeting (min)</div>
                </div>
                <div style="padding: 1.5rem; background: #34495e; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2.5rem; color: #9b59b6; font-weight: bold;" id="engagement-score">0%</div>
                    <div style="margin-top: 0.5rem; opacity: 0.8;">Engagement Score</div>
                </div>
            </div>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div class="box">
                    <h3>Attendance Trends (Last 6 GC Meetings)</h3>
                    <canvas id="attendance-trend-chart" style="max-height: 300px;"></canvas>
                </div>
                <div class="box">
                    <h3>Voting Participation Over Time</h3>
                    <canvas id="voting-trend-chart" style="max-height: 300px;"></canvas>
                </div>
            </div>
            <div class="box mt-4">
                <h3>Privacy Notice</h3>
                <p style="font-size: 0.9rem; opacity: 0.8;">All participation data is anonymous and aggregated. No individual voting records are tracked or displayed. This data helps the group understand overall engagement patterns.</p>
            </div>
        </section>
        <section id="decision-impact-section" style="border-left: 4px solid #1abc9c;">
            <h2><i class="fas fa-chart-line"></i> Decision Impact Tracking</h2>
            <p class="mb-4">Follow up on past decisions to see if they achieved their intended goals.</p>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Add Impact Assessment</h3>
                        <div class="form-group">
                            <label for="impact-gc-motion">Select Past Motion</label>
                            <select id="impact-gc-motion">
                                <option value="">-- Select Motion --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="impact-months">Months Since Implementation</label>
                            <input type="number" id="impact-months" min="1" max="24" placeholder="6">
                        </div>
                        <div class="form-group">
                            <label for="impact-achieved">Goal Achieved?</label>
                            <select id="impact-achieved">
                                <option value="yes">Yes - Fully achieved</option>
                                <option value="partial">Partially achieved</option>
                                <option value="no">No - Did not achieve goal</option>
                                <option value="unknown">Too soon to tell</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="impact-rating">Effectiveness Rating</label>
                            <select id="impact-rating">
                                <option value="5">5 - Excellent decision</option>
                                <option value="4">4 - Good decision</option>
                                <option value="3">3 - Neutral/OK</option>
                                <option value="2">2 - Poor decision</option>
                                <option value="1">1 - Should reverse</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="impact-lessons">Lessons Learned</label>
                            <textarea id="impact-lessons" rows="4" placeholder="What did we learn from this decision?"></textarea>
                        </div>
                        <button class="btn" onclick="saveDecisionImpact()">Save Impact Assessment</button>
                    </div>
                </div>
                <div>
                    <div class="box mb-4">
                        <h3>Impact Assessments</h3>
                        <div id="impact-list" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>
                    <div class="box">
                        <h3>Decision Quality Insights</h3>
                        <div id="decision-insights"></div>
                    </div>
                </div>
            </div>
            <div class="box mt-4" style="border-left: 4px solid #f39c12;">
                <h3><i class="fas fa-chart-line"></i> Financial Projection Simulator</h3>
                <p class="mb-4" style="font-size: 0.9rem; opacity: 0.8;">
                    Model the long-term financial impact of proposed decisions before voting.
                </p>
                <div class="grid" style="grid-template-columns: 1fr 2fr; gap: 2rem;">
                    <div>
                        <div class="form-group">
                            <label for="projection-amount">Proposed Amount ($)</label>
                            <input type="number" id="projection-amount" step="0.01" placeholder="500.00">
                        </div>
                        <div class="form-group">
                            <label for="projection-type">Expense Type</label>
                            <select id="projection-type">
                                <option value="oneTime">One-time expense</option>
                                <option value="monthly">Monthly recurring</option>
                                <option value="annual">Annual recurring</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="projection-period">Projection Period</label>
                            <select id="projection-period">
                                <option value="6">6 months</option>
                                <option value="12" selected>12 months</option>
                                <option value="24">24 months</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="projection-revenue-type">Expected Revenue Change</label>
                            <select id="projection-revenue-type">
                                <option value="none">No change</option>
                                <option value="increase">Will increase contributions</option>
                                <option value="decrease">Will decrease contributions</option>
                            </select>
                        </div>
                        <div class="form-group" id="projection-revenue-amount-group" style="display: none;">
                            <label for="projection-revenue-amount">Revenue Change ($/month)</label>
                            <input type="number" id="projection-revenue-amount" step="0.01" placeholder="50.00">
                        </div>
                        <button class="btn" onclick="runFinancialProjection()" style="width: 100%; background: #f39c12;">
                            <i class="fas fa-calculator"></i> Run Projection
                        </button>
                    </div>
                    <div>
                        <div id="projection-summary" style="display: none; padding: 1rem; background: #2c3e50; border-radius: 6px; margin-bottom: 1rem;">
                        </div>
                        <canvas id="projection-chart" style="display: none; max-height: 350px;"></canvas>
                        <div id="projection-insights" style="margin-top: 1rem; font-size: 0.9rem;">
                            <p style="opacity: 0.7; text-align: center; padding: 2rem;">
                                Enter values and click "Run Projection" to see the financial impact over time.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="box mt-4" style="border-left: 4px solid #9b59b6;">
                <h3><i class="fas fa-brain"></i> Institutional Memory & Learning System</h3>
                <p class="mb-4" style="font-size: 0.9rem; opacity: 0.8;">
                    Searchable database of lessons learned from past decisions. Learn from history to make better decisions.
                </p>
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <div>
                        <div class="form-group">
                            <label for="memory-search">Search Lessons Learned</label>
                            <input type="text" id="memory-search" placeholder="Search by keyword, category, or date..." oninput="searchLessonsLearned()">
                        </div>
                        <div class="form-group">
                            <label for="memory-category-filter">Filter by Category</label>
                            <select id="memory-category-filter" onchange="searchLessonsLearned()">
                                <option value="">All Categories</option>
                                <option value="financial">Financial Decisions</option>
                                <option value="service">Service Structure</option>
                                <option value="meeting">Meeting Format</option>
                                <option value="fellowship">Fellowship</option>
                                <option value="traditions">Traditions/Concepts</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="memory-rating-filter">Filter by Effectiveness</label>
                            <select id="memory-rating-filter" onchange="searchLessonsLearned()">
                                <option value="">All Ratings</option>
                                <option value="5">5 Stars - Excellent</option>
                                <option value="4">4 Stars - Good</option>
                                <option value="3">3 Stars - Neutral</option>
                                <option value="2">2 Stars - Poor</option>
                                <option value="1">1 Star - Should Reverse</option>
                            </select>
                        </div>
                        <div style="margin-top: 1rem; padding: 1rem; background: #2c3e50; border-radius: 6px;">
                            <h4 style="margin-bottom: 0.5rem; color: #9b59b6;">Memory Insights</h4>
                            <div id="memory-stats" style="font-size: 0.85rem;">
                                <p><strong>Total Lessons:</strong> <span id="total-lessons">0</span></p>
                                <p><strong>Avg. Rating:</strong> <span id="avg-lesson-rating">--</span>/5</p>
                                <p><strong>Most Common Category:</strong> <span id="common-category">--</span></p>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h4 style="margin-bottom: 0.75rem;">Lessons Learned Archive</h4>
                        <div id="lessons-list" style="max-height: 500px; overflow-y: auto;">
                            <p style="opacity: 0.7; text-align: center; padding: 2rem;">
                                No lessons learned yet. Add impact assessments to build your institutional memory.
                            </p>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 1.5rem; padding: 1rem; background: #2c3e50; border-radius: 6px; border-left: 3px solid #9b59b6;">
                    <h4><i class="fas fa-lightbulb"></i> Pattern Recognition</h4>
                    <div id="pattern-insights" style="margin-top: 0.75rem; font-size: 0.9rem;">
                        <p style="opacity: 0.7;">Patterns will appear here once you have multiple lessons logged.</p>
                    </div>
                </div>
            </div>
        </section>
        <section id="financial-health-section" style="border-left: 4px solid #1abc9c;">
            <h2><i class="fas fa-heartbeat"></i> Financial Health Dashboard</h2>
            <p class="mb-4">Monitor financial health and impact of spending decisions.</p>
            <div class="grid" style="grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 2rem;">
                <div style="padding: 1.5rem; background: #27ae60; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2rem; color: #fff; font-weight: bold;" id="current-balance">$0.00</div>
                    <div style="margin-top: 0.5rem; color: #ecf0f1;">Current Balance</div>
                </div>
                <div style="padding: 1.5rem; background: #3498db; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2rem; color: #fff; font-weight: bold;" id="prudent-reserve">$0.00</div>
                    <div style="margin-top: 0.5rem; color: #ecf0f1;">Prudent Reserve</div>
                </div>
                <div style="padding: 1.5rem; background: #9b59b6; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2rem; color: #fff; font-weight: bold;" id="contribution-health">0%</div>
                    <div style="margin-top: 0.5rem; color: #ecf0f1;">Contribution Health</div>
                </div>
            </div>
            <div class="box mb-4">
                <h3>"Can We Afford This?" Calculator</h3>
                <div class="grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="afford-amount">Proposed Spending ($)</label>
                        <input type="number" id="afford-amount" step="0.01" placeholder="500.00">
                    </div>
                    <div class="form-group">
                        <label for="afford-category">Category</label>
                        <select id="afford-category">
                            <option value="oneTime">One-time expense</option>
                            <option value="monthly">Monthly recurring</option>
                            <option value="annual">Annual expense</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: flex-end;">
                        <button class="btn" onclick="calculateAffordability()" style="width: 100%;">Calculate</button>
                    </div>
                </div>
                <div id="affordability-result" class="mt-3" style="display: none;"></div>
            </div>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div class="box">
                    <h3>7th Tradition Trend (6 Months)</h3>
                    <canvas id="contribution-trend-chart" style="max-height: 300px;"></canvas>
                </div>
                <div class="box">
                    <h3>Spending vs Income</h3>
                    <canvas id="spending-income-chart" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </section>
        <section id="inventory-scheduler-section" style="border-left: 4px solid #34495e;">
            <h2><i class="fas fa-calendar-check"></i> Group Inventory Scheduler</h2>
            <p class="mb-4">Schedule and track regular group inventories.</p>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Schedule New Inventory</h3>
                        <div class="form-group">
                            <label for="inventory-type">Inventory Type</label>
                            <select id="inventory-type">
                                <option value="traditions">12 Traditions Inventory</option>
                                <option value="concepts">12 Concepts Inventory</option>
                                <option value="format">Meeting Format Inventory</option>
                                <option value="service">Service Structure Inventory</option>
                                <option value="custom">Custom Inventory</option>
                            </select>
                        </div>
                        <div class="form-group" id="custom-inventory-name" style="display: none;">
                            <label for="inventory-custom-name">Custom Inventory Name</label>
                            <input type="text" id="inventory-custom-name" placeholder="e.g., Literature Needs Assessment">
                        </div>
                        <div class="form-group">
                            <label for="inventory-scheduled-date">Scheduled Date</label>
                            <input type="date" id="inventory-scheduled-date">
                        </div>
                        <div class="form-group">
                            <label for="inventory-frequency">Frequency</label>
                            <select id="inventory-frequency">
                                <option value="once">One-time</option>
                                <option value="annual">Annual</option>
                                <option value="semiannual">Semi-annual</option>
                                <option value="quarterly">Quarterly</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="inventory-notes">Notes/Purpose</label>
                            <textarea id="inventory-notes" rows="3" placeholder="Why are we doing this inventory?"></textarea>
                        </div>
                        <button class="btn" onclick="scheduleInventory()">Schedule Inventory</button>
                    </div>
                </div>
                <div>
                    <div class="box mb-4">
                        <h3>Upcoming Inventories</h3>
                        <div id="upcoming-inventories-list"></div>
                    </div>
                    <div class="box">
                        <h3>Completed Inventories</h3>
                        <div id="completed-inventories-list"></div>
                    </div>
                </div>
            </div>
        </section>
        <section id="role-settings-section" style="border-left: 4px solid #34495e;">
            <h2><i class="fas fa-user-shield"></i> Role & View Settings</h2>
            <p class="mb-4">Customize your view based on your service position.</p>
            <div class="grid" style="grid-template-columns: 1fr 2fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Select Your Role</h3>
                        <div class="form-group">
                            <label for="user-role-select">Primary Role</label>
                            <select id="user-role-select" onchange="updateRoleView()">
                                <option value="member">Member</option>
                                <option value="gsr">GSR</option>
                                <option value="treasurer">Treasurer</option>
                                <option value="secretary">Secretary</option>
                                <option value="chairperson">Chairperson</option>
                                <option value="literature">Literature Coordinator</option>
                            </select>
                        </div>
                        <button class="btn" onclick="saveUserRole()">Save Role</button>
                        <div class="mt-4">
                            <h4>Role Benefits</h4>
                            <div id="role-benefits" style="font-size: 0.9rem; opacity: 0.8;">
                                <p>Select a role to see customizations</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div>
                    <div class="box">
                        <h3>Role-Specific Dashboards</h3>
                        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <button class="btn secondary" onclick="showDashboard('gsr')" style="padding: 2rem; font-size: 1rem;">
                                <i class="fas fa-bullhorn"></i><br>GSR Dashboard
                            </button>
                            <button class="btn secondary" onclick="showDashboard('treasurer')" style="padding: 2rem; font-size: 1rem;">
                                <i class="fas fa-dollar-sign"></i><br>Treasurer Dashboard
                            </button>
                            <button class="btn secondary" onclick="showDashboard('secretary')" style="padding: 2rem; font-size: 1rem;">
                                <i class="fas fa-file-alt"></i><br>Secretary Dashboard
                            </button>
                            <button class="btn secondary" onclick="showDashboard('chairperson')" style="padding: 2rem; font-size: 1rem;">
                                <i class="fas fa-gavel"></i><br>Chairperson Dashboard
                            </button>
                        </div>
                    </div>
                    <div class="box mt-4" id="role-dashboard" style="display: none;">
                        <h3 id="dashboard-title">Dashboard</h3>
                        <div id="dashboard-content"></div>
                    </div>
                </div>
            </div>
        </section>
        <section id="privacy-section" style="border-left: 4px solid #34495e;">
            <h2><i class="fas fa-user-secret"></i> Privacy & Anonymity Protection</h2>
            <p class="mb-4">Configure privacy settings to protect member anonymity and sensitive information.</p>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Privacy Settings</h3>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="privacy-anonymous-voting">
                                <strong>Anonymous Voting Mode</strong>
                            </label>
                            <p style="font-size: 0.85rem; opacity: 0.8; margin-left: 1.5rem;">
                                Enable for sensitive topics. Votes are recorded without names.
                            </p>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="privacy-hide-names-export">
                                <strong>Hide Names in Exports</strong>
                            </label>
                            <p style="font-size: 0.85rem; opacity: 0.8; margin-left: 1.5rem;">
                                Replace member names with "Member 1", "Member 2" in exported data.
                            </p>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="privacy-encrypt-sensitive">
                                <strong>Mark Sensitive Motions</strong>
                            </label>
                            <p style="font-size: 0.85rem; opacity: 0.8; margin-left: 1.5rem;">
                                Flag motions as "sensitive" - requires extra confirmation to view.
                            </p>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="privacy-redact-lastnames">
                                <strong>Auto-Redact Last Names</strong>
                            </label>
                            <p style="font-size: 0.85rem; opacity: 0.8; margin-left: 1.5rem;">
                                Show only first names and last initial (e.g., "John S.")
                            </p>
                        </div>
                        <button class="btn" onclick="savePrivacySettings()">Save Privacy Settings</button>
                    </div>
                </div>
                <div>
                    <div class="box">
                        <h3>Multi-Level Access Control</h3>
                        <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem;">
                            Control who can see what information. Based on AA traditions of anonymity and transparency.
                        </p>
                        <div style="background: #34495e; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                            <h4 style="color: #2ecc71; margin-bottom: 0.5rem;">Public Info</h4>
                            <p style="font-size: 0.85rem;">Meeting times, location, format</p>
                            <p style="font-size: 0.75rem; opacity: 0.7;">Anyone can view this information</p>
                        </div>
                        <div style="background: #34495e; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                            <h4 style="color: #3498db; margin-bottom: 0.5rem;">Member Info</h4>
                            <p style="font-size: 0.85rem;">Financial details, voting records, member roster</p>
                            <p style="font-size: 0.75rem; opacity: 0.7;">Homegroup members only</p>
                        </div>
                        <div style="background: #34495e; padding: 1rem; border-radius: 6px;">
                            <h4 style="color: #f39c12; margin-bottom: 0.5rem;">Trusted Servant Info</h4>
                            <p style="font-size: 0.85rem;">Sensitive GC discussions, personnel matters</p>
                            <p style="font-size: 0.75rem; opacity: 0.7;">Trusted servants only (GSR, Secretary, Treasurer, Chairperson)</p>
                        </div>
                        <div class="mt-4">
                            <p style="font-size: 0.85rem; opacity: 0.8;">
                                <strong>Note:</strong> This app honors tradition 12: "Anonymity is the spiritual foundation of all our traditions."
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <section id="tradition-moments-section" style="border-left: 4px solid #9b59b6;">
            <h2><i class="fas fa-lightbulb"></i> Tradition Moments</h2>
            <p class="mb-4">Daily reminders of AA's 12 Traditions to guide group decisions.</p>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <h3 style="color: white;">Tradition of the Day</h3>
                        <div id="tradition-of-day-display" style="font-size: 1.1rem; padding: 1.5rem;">
                        </div>
                        <button class="btn" onclick="randomizeTradition()" style="background: white; color: #667eea;">Show Random Tradition</button>
                    </div>
                    <div class="box mt-4">
                        <h3>Before Voting Reminder</h3>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="tradition-reminder-enabled" checked>
                                <strong>Show tradition reminder before finalizing votes</strong>
                            </label>
                        </div>
                        <p style="font-size: 0.85rem; opacity: 0.8;">
                            When enabled, a relevant tradition will be shown before finalizing important votes to ensure decisions align with AA principles.
                        </p>
                    </div>
                </div>
                <div>
                    <div class="box">
                        <h3>Tradition Violation Warnings</h3>
                        <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem;">
                            Automatic checks for potential tradition violations:
                        </p>
                        <div id="tradition-warnings-list">
                            <div style="padding: 0.75rem; background: #34495e; border-left: 3px solid #e74c3c; margin-bottom: 0.5rem;">
                                <strong>Tradition 6:</strong> Outside enterprises
                                <p style="font-size: 0.85rem; margin-top: 0.25rem;">Warns if motion mentions endorsement, affiliation, or lending the AA name</p>
                            </div>
                            <div style="padding: 0.75rem; background: #34495e; border-left: 3px solid #f39c12; margin-bottom: 0.5rem;">
                                <strong>Tradition 7:</strong> Self-supporting
                                <p style="font-size: 0.85rem; margin-top: 0.25rem;">Warns if accepting outside contributions or donations</p>
                            </div>
                            <div style="padding: 0.75rem; background: #34495e; border-left: 3px solid #f39c12; margin-bottom: 0.5rem;">
                                <strong>Tradition 10:</strong> No outside issues
                                <p style="font-size: 0.85rem; margin-top: 0.25rem;">Warns if motion involves public controversy or outside issues</p>
                            </div>
                            <div style="padding: 0.75rem; background: #34495e; border-left: 3px solid #3498db;">
                                <strong>Tradition 12:</strong> Anonymity
                                <p style="font-size: 0.85rem; margin-top: 0.25rem;">Warns if personal names might be exposed publicly</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <section id="spiritual-principles-section" style="border-left: 4px solid #9b59b6;">
            <h2><i class="fas fa-praying-hands"></i> Spiritual Principles Integration</h2>
            <p class="mb-4">Tag motions with spiritual principles and guide decisions based on AA's spiritual foundation.</p>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Tag Motion with Principles</h3>
                        <div class="form-group">
                            <label for="principle-motion-select">Select Motion</label>
                            <select id="principle-motion-select">
                                <option value="">-- Select Motion --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="principle-tags">Spiritual Principles (select all that apply)</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                                <label><input type="checkbox" class="principle-checkbox" value="honesty"> Honesty</label>
                                <label><input type="checkbox" class="principle-checkbox" value="humility"> Humility</label>
                                <label><input type="checkbox" class="principle-checkbox" value="unity"> Unity</label>
                                <label><input type="checkbox" class="principle-checkbox" value="service"> Service</label>
                                <label><input type="checkbox" class="principle-checkbox" value="responsibility"> Responsibility</label>
                                <label><input type="checkbox" class="principle-checkbox" value="love"> Love</label>
                                <label><input type="checkbox" class="principle-checkbox" value="tolerance"> Tolerance</label>
                                <label><input type="checkbox" class="principle-checkbox" value="wisdom"> Wisdom</label>
                            </div>
                        </div>
                        <button class="btn" onclick="saveSpiritualPrincipleTags()">Save Principle Tags</button>
                    </div>
                    <div class="box mt-4">
                        <h3>Principles-Based Decision Guide</h3>
                        <p style="font-size: 0.9rem; opacity: 0.8;">Before making a decision, ask:</p>
                        <ul style="font-size: 0.9rem; line-height: 1.8;">
                            <li><strong>Honesty:</strong> Are we being truthful?</li>
                            <li><strong>Humility:</strong> Are we putting principles before personalities?</li>
                            <li><strong>Unity:</strong> Does this promote group unity?</li>
                            <li><strong>Service:</strong> Does this serve our primary purpose?</li>
                        </ul>
                    </div>
                </div>
                <div>
                    <div class="box">
                        <h3>Tagged Motions</h3>
                        <div id="principle-tagged-list" style="max-height: 400px; overflow-y: auto;">
                        </div>
                    </div>
                    <div class="box mt-4">
                        <h3>Step 10 for Groups - Group Inventory Prompts</h3>
                        <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem;">
                            Regular group inventory questions to keep the group healthy:
                        </p>
                        <button class="btn secondary" onclick="startGroupInventory()">Start Group Inventory</button>
                        <div id="group-inventory-questions" style="display: none; margin-top: 1rem;">
                            <div style="padding: 1rem; background: #34495e; border-radius: 6px; margin-bottom: 0.5rem;">
                                <p>1. Are we placing principles before personalities?</p>
                            </div>
                            <div style="padding: 1rem; background: #34495e; border-radius: 6px; margin-bottom: 0.5rem;">
                                <p>2. Are our decisions guided by our primary purpose?</p>
                            </div>
                            <div style="padding: 1rem; background: #34495e; border-radius: 6px; margin-bottom: 0.5rem;">
                                <p>3. Do we practice rotation of leadership?</p>
                            </div>
                            <div style="padding: 1rem; background: #34495e; border-radius: 6px; margin-bottom: 0.5rem;">
                                <p>4. Are we self-supporting?</p>
                            </div>
                            <div style="padding: 1rem; background: #34495e; border-radius: 6px;">
                                <p>5. Is our group atmosphere welcoming and inclusive?</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <section id="unity-checker-section" style="border-left: 4px solid #9b59b6;">
            <h2><i class="fas fa-handshake"></i> Unity Checker & Minority Opinion</h2>
            <p class="mb-4">Ensure decisions promote unity and respect minority voices.</p>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Unity Check Before Vote</h3>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="unity-check-enabled" checked>
                                <strong>Enable unity check before finalizing votes</strong>
                            </label>
                        </div>
                        <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem;">
                            When enabled, these questions will appear before finalizing any vote:
                        </p>
                        <div style="background: #34495e; padding: 1rem; border-radius: 6px;">
                            <p style="font-size: 0.9rem; margin-bottom: 0.5rem;"><strong>✓ Does this decision promote unity?</strong></p>
                            <p style="font-size: 0.9rem; margin-bottom: 0.5rem;"><strong>✓ Have all voices been heard?</strong></p>
                            <p style="font-size: 0.9rem;"><strong>✓ Is there a minority opinion that should be recorded?</strong></p>
                        </div>
                    </div>
                    <div class="box mt-4">
                        <h3>Record Minority Opinion</h3>
                        <div class="form-group">
                            <label for="minority-motion-select">Select Motion</label>
                            <select id="minority-motion-select">
                                <option value="">-- Select Motion --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="minority-opinion-text">Minority Opinion Statement</label>
                            <textarea id="minority-opinion-text" rows="4" placeholder="Record the concerns or alternative viewpoint..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="minority-vote-count">Number in Minority</label>
                            <input type="number" id="minority-vote-count" min="1" placeholder="e.g., 3">
                        </div>
                        <button class="btn" onclick="saveMinorityOpinion()">Record Minority Opinion</button>
                    </div>
                </div>
                <div>
                    <div class="box">
                        <h3>Consensus Builder Tools</h3>
                        <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem;">
                            When there's disagreement, try these approaches:
                        </p>
                        <div style="background: #34495e; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                            <h4 style="color: #3498db;">1. Table the Motion</h4>
                            <p style="font-size: 0.85rem;">Give time for prayer, reflection, and discussion outside the meeting</p>
                            <button class="btn secondary" onclick="tableCurrentMotion()">Table Current Motion</button>
                        </div>
                        <div style="background: #34495e; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                            <h4 style="color: #3498db;">2. Form Committee</h4>
                            <p style="font-size: 0.85rem;">Create a committee to research and bring recommendations</p>
                            <button class="btn secondary" onclick="formCommittee()">Form Ad Hoc Committee</button>
                        </div>
                        <div style="background: #34495e; padding: 1rem; border-radius: 6px;">
                            <h4 style="color: #3498db;">3. Find Common Ground</h4>
                            <p style="font-size: 0.85rem;">Identify what everyone agrees on and build from there</p>
                            <button class="btn secondary" onclick="openCommonGroundDialog()">Start Common Ground Exercise</button>
                        </div>
                    </div>
                    <div class="box mt-4">
                        <h3>Recorded Minority Opinions</h3>
                        <div id="minority-opinions-list" style="max-height: 300px; overflow-y: auto;">
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <section id="service-structure-section" style="border-left: 4px solid #2ecc71;">
            <h2><i class="fas fa-sitemap"></i> Service Structure Visualizer</h2>
            <p class="mb-4">Visual representation of AA's service structure and how group conscience flows.</p>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Configure Your Service Structure</h3>
                        <div class="form-group">
                            <label for="structure-group-name">Group Name</label>
                            <input type="text" id="structure-group-name" placeholder="Your group name">
                        </div>
                        <div class="form-group">
                            <label for="structure-district">District</label>
                            <input type="text" id="structure-district" placeholder="District number or name">
                        </div>
                        <div class="form-group">
                            <label for="structure-area">Area</label>
                            <input type="text" id="structure-area" placeholder="Area name">
                        </div>
                        <div class="form-group">
                            <label for="structure-gsr-name">GSR Name</label>
                            <input type="text" id="structure-gsr-name" placeholder="General Service Representative">
                        </div>
                        <button class="btn" onclick="saveServiceStructure()">Save Structure Info</button>
                    </div>
                </div>
                <div>
                    <div class="box">
                        <h3>Upside-Down Triangle</h3>
                        <p style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 1rem;">
                            In AA, the traditional leadership triangle is inverted - servants are at the bottom supporting the groups.
                        </p>
                        <div id="service-triangle" style="text-align: center; padding: 2rem;">
                            <div style="width: 100%; border-bottom: 3px solid #3498db; padding: 1rem; background: #34495e; margin-bottom: 1rem;">
                                <strong style="font-size: 1.1rem;">The Groups</strong>
                                <p style="font-size: 0.8rem; opacity: 0.8;">Ultimate authority & responsibility</p>
                            </div>
                            <div style="width: 90%; margin: 0 auto; border-bottom: 3px solid #3498db; padding: 1rem; background: #34495e; margin-bottom: 1rem;">
                                <strong>District & GSRs</strong>
                                <p style="font-size: 0.8rem; opacity: 0.8;">Serve the groups</p>
                            </div>
                            <div style="width: 80%; margin: 0 auto; border-bottom: 3px solid #3498db; padding: 1rem; background: #34495e; margin-bottom: 1rem;">
                                <strong>Area Assembly</strong>
                                <p style="font-size: 0.8rem; opacity: 0.8;">Coordinates districts</p>
                            </div>
                            <div style="width: 70%; margin: 0 auto; padding: 1rem; background: #34495e;">
                                <strong>GSO (General Service Office)</strong>
                                <p style="font-size: 0.8rem; opacity: 0.8;">Supports worldwide AA</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="box mt-4">
                <h3>Flow of Group Conscience</h3>
                <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem;">
                    How decisions flow through AA's service structure:
                </p>
                <div class="grid" style="grid-template-columns: repeat(4, 1fr); gap: 1rem; text-align: center;">
                    <div style="background: #34495e; padding: 1.5rem; border-radius: 6px; border-top: 4px solid #2ecc71;">
                        <strong>1. Home Group</strong>
                        <p style="font-size: 0.85rem; margin-top: 0.5rem; opacity: 0.8;">Group conscience formed</p>
                    </div>
                    <div style="background: #34495e; padding: 1.5rem; border-radius: 6px; border-top: 4px solid #3498db;">
                        <strong>2. GSR Reports</strong>
                        <p style="font-size: 0.85rem; margin-top: 0.5rem; opacity: 0.8;">Carries voice to district</p>
                    </div>
                    <div style="background: #34495e; padding: 1.5rem; border-radius: 6px; border-top: 4px solid #9b59b6;">
                        <strong>3. District Meeting</strong>
                        <p style="font-size: 0.85rem; margin-top: 0.5rem; opacity: 0.8;">Groups share & discuss</p>
                    </div>
                    <div style="background: #34495e; padding: 1.5rem; border-radius: 6px; border-top: 4px solid #f39c12;">
                        <strong>4. Area Assembly</strong>
                        <p style="font-size: 0.85rem; margin-top: 0.5rem; opacity: 0.8;">Collective conscience</p>
                    </div>
                </div>
                <div style="margin-top: 2rem; text-align: center;">
                    <p style="font-size: 1.1rem; color: #3498db;">
                        <strong>"Our leaders are but trusted servants; they do not govern."</strong>
                    </p>
                    <p style="font-size: 0.85rem; opacity: 0.8; margin-top: 0.5rem;">- Tradition 2</p>
                </div>
            </div>
        </section>
    </main>
    <div id="gc-details-modal" class="modal">
        <div class="box" style="width: 90%; max-width: 900px; max-height: 90vh; overflow-y: auto; background: #2c3e50; color: #ecf0f1; border: 1px solid #3498db;">
            <span class="modal-close" onclick="closeGCDetailsModal()">&times;</span>
            <h2 style="color: #3498db;">Motion Details & Discussion</h2>
            <div id="gc-details-content" style="margin: 1rem 0;">
            </div>
            <div style="margin-top: 2rem;">
                <h3 style="color: #3498db; margin-bottom: 1rem;">Discussion & Comments</h3>
                <div id="gc-comments-list" style="max-height: 300px; overflow-y: auto; margin-bottom: 1rem; padding: 0.5rem; background: #34495e; border-radius: 6px;">
                </div>
                <div class="form-group">
                    <label for="gc-comment-text">Add Comment</label>
                    <textarea id="gc-comment-text" rows="3" placeholder="Add your comment or discussion note..."></textarea>
                </div>
                <div class="form-group">
                    <label for="gc-comment-author">Your Name</label>
                    <input type="text" id="gc-comment-author" placeholder="Name">
                </div>
                <div class="form-group">
                    <label for="gc-comment-type">Comment Type</label>
                    <select id="gc-comment-type">
                        <option value="discussion">Discussion Note</option>
                        <option value="amendment">Proposed Amendment</option>
                        <option value="clarification">Clarification</option>
                        <option value="support">Support Statement</option>
                        <option value="concern">Concern/Opposition</option>
                    </select>
                </div>
                <button class="btn" onclick="addGCComment()">Add Comment</button>
                <button class="btn secondary" onclick="closeGCDetailsModal()" style="margin-left: 0.5rem;">Close</button>
            </div>
        </div>
    </div>
    <div id="roster-modal" class="modal">
        <div class="box" style="width: 90%; max-width: 1200px; max-height: 90vh; overflow-y: auto; background: #2c3e50; color: #ecf0f1; border: 1px solid #3498db;">
            <span class="modal-close" onclick="closeRosterModal()">&times;</span>
            <h2 style="color: #3498db;">Full Member Roster</h2>
            <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                <input type="text" id="roster-search" onkeyup="renderRosterTable()" placeholder="Search by name, email, phone..." style="flex-grow: 1;" />
                <button class="btn" onclick="openMemberFormFromModal()">Add New Member</button>
            </div>
            <div style="overflow-x: auto;">
                <table id="roster-table">
                    <thead>
                        <tr>
                            <th onclick="sortRosterBy('name')" style="cursor: pointer;">Name &#x2195;</th>
                            <th onclick="sortRosterBy('city')" style="cursor: pointer;">City &#x2195;</th>
                            <th onclick="sortRosterBy('homegroup')" style="cursor: pointer;">Homegroup &#x2195;</th>
                            <th>Phone</th>
                            <th>Email</th>
                            <th onclick="sortRosterBy('isServant')" style="cursor: pointer;">Servant? &#x2195;</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="roster-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <section id="inter-group-section" style="border-left: 4px solid #16a085;">
        <h2><i class="fas fa-network-wired"></i> Inter-Group Connections</h2>
        <p class="mb-4">Track members who attend other AA groups to understand fellowship connections and encourage group unity across the wider AA community.</p>
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
            <div>
                <div class="box">
                    <h3><i class="fas fa-plus-circle"></i> Record Attendance</h3>
                    <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem;">Track when members attend other groups to support their recovery journey.</p>
                    <div class="form-group">
                        <label for="inter-member">Member</label>
                        <select id="inter-member">
                            <option value="">-- Select Member --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="inter-group-name">Other Group Name</label>
                        <input type="text" id="inter-group-name" placeholder="e.g., Serenity Group, Big Book Study" />
                    </div>
                    <button class="btn" onclick="addInterGroupAttendance()"><i class="fas fa-plus"></i> Record Attendance</button>
                </div>
            </div>
            <div>
                <div class="box">
                    <h3><i class="fas fa-list-ul"></i> Recent Connections</h3>
                    <div id="inter-group-list" style="min-height: 150px;"></div>
                </div>
                <div class="box mt-4" style="background: #34495e; border-left: 4px solid #3498db;">
                    <h4><i class="fas fa-info-circle"></i> Why Track Inter-Group?</h4>
                    <ul style="font-size: 0.9rem; line-height: 1.6;">
                        <li>Strengthens wider AA fellowship</li>
                        <li>Helps members find additional support</li>
                        <li>Identifies popular meetings to recommend to newcomers</li>
                    </ul>
                </div>
            </div>
        </div>
    </section>

    <section id="hg-transfer-section" style="border-left: 4px solid #27ae60;">
        <h2><i class="fas fa-exchange-alt"></i> Home Group Transfer Management</h2>
        <p class="mb-4">Process incoming and outgoing home group transfers. A home group is where a member commits to service and voting privileges.</p>
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
            <div>
                <div class="box">
                    <h3><i class="fas fa-user-check"></i> Process Transfer</h3>
                    <div class="form-group">
                        <label for="transfer-member">Member</label>
                        <select id="transfer-member">
                            <option value="">-- Select Member --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="transfer-type">Transfer Type</label>
                        <select id="transfer-type">
                            <option value="incoming">Incoming (Joining Our Group)</option>
                            <option value="outgoing">Outgoing (Leaving Our Group)</option>
                        </select>
                    </div>
                    <div style="background: #34495e; padding: 1rem; border-radius: 6px; margin: 1rem 0;">
                        <p style="font-size: 0.85rem;"><strong><i class="fas fa-lightbulb"></i> Home Group Commitment:</strong></p>
                        <p style="font-size: 0.85rem; opacity: 0.8;">A home group member typically attends regularly, takes service positions, and has voting rights in group conscience.</p>
                    </div>
                    <button class="btn" onclick="processTransfer()"><i class="fas fa-check"></i> Process Transfer</button>
                </div>
            </div>
            <div>
                <div class="box">
                    <h3><i class="fas fa-history"></i> Transfer History</h3>
                    <div id="transfer-history" style="min-height: 200px;"></div>
                </div>
            </div>
        </div>
    </section>

    <section id="hg-benefits-section" style="border-left: 4px solid #8e44ad;">
        <h2><i class="fas fa-award"></i> Home Group Benefits & Privileges</h2>
        <p class="mb-4">View which members have earned home group benefits through regular attendance and service commitment.</p>
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
            <div>
                <div class="box">
                    <h3><i class="fas fa-vote-yea"></i> Voting Eligibility</h3>
                    <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem;">Members with home group status have voting privileges:</p>
                    <div id="voting-eligible-list" style="min-height: 150px;"></div>
                </div>
            </div>
            <div>
                <div class="box" style="background: #34495e; border-left: 4px solid #8e44ad;">
                    <h3><i class="fas fa-info-circle"></i> Home Group Benefits</h3>
                    <ul style="line-height: 1.8;">
                        <li><strong>Voting Rights:</strong> Participate in group conscience decisions</li>
                        <li><strong>Service Positions:</strong> Eligible to hold trusted servant positions</li>
                        <li><strong>Group Voice:</strong> Help shape the group's future direction</li>
                        <li><strong>Accountability:</strong> Deeper commitment to group unity</li>
                    </ul>
                </div>
                <div class="box mt-4" style="background: #2c3e50; border-left: 4px solid #3498db;">
                    <h4><i class="fas fa-question-circle"></i> How to Become Home Group?</h4>
                    <p style="font-size: 0.9rem; opacity: 0.8;">Requirements vary by group, but typically include:</p>
                    <ul style="font-size: 0.9rem; line-height: 1.6;">
                        <li>Regular attendance (often 90 days)</li>
                        <li>Financial contribution when able</li>
                        <li>Willingness to serve</li>
                        <li>Agreement with group conscience</li>
                    </ul>
                </div>
            </div>
        </div>
    </section>

    <section id="hg-commitment-section" style="border-left: 4px solid #d35400;">
        <h2><i class="fas fa-handshake"></i> Home Group Commitment Levels</h2>
        <p class="mb-4">Overview of member commitment levels and home group participation statistics.</p>
        <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
            <div class="box" style="text-align: center; background: linear-gradient(135deg, #d35400 0%, #e67e22 100%);">
                <i class="fas fa-users" style="font-size: 3rem; opacity: 0.3; margin-bottom: 0.5rem;"></i>
                <div id="commitment-levels"></div>
            </div>
            <div class="box" style="background: #34495e; border-left: 4px solid #d35400;">
                <h3><i class="fas fa-chart-pie"></i> Commitment Breakdown</h3>
                <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem;">Understanding member involvement:</p>
                <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: #2c3e50; border-radius: 4px; margin-bottom: 0.5rem;">
                    <span><i class="fas fa-circle" style="color: #d35400;"></i> Home Group</span>
                    <span style="opacity: 0.8;">Full commitment</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: #2c3e50; border-radius: 4px; margin-bottom: 0.5rem;">
                    <span><i class="fas fa-circle" style="color: #3498db;"></i> Regular</span>
                    <span style="opacity: 0.8;">Frequent attendance</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: #2c3e50; border-radius: 4px; margin-bottom: 0.5rem;">
                    <span><i class="fas fa-circle" style="color: #2ecc71;"></i> Newcomer</span>
                    <span style="opacity: 0.8;">Getting started</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: #2c3e50; border-radius: 4px;">
                    <span><i class="fas fa-circle" style="color: #95a5a6;"></i> Visitor</span>
                    <span style="opacity: 0.8;">Occasional</span>
                </div>
            </div>
        </div>
    </section>

    <section id="hg-census-section" style="border-left: 4px solid #2980b9;">
        <h2><i class="fas fa-users"></i> Home Group Census</h2>
        <p class="mb-4">Detailed membership statistics by commitment level and attendance patterns.</p>
        <div class="box mb-4" style="background: linear-gradient(135deg, #2980b9 0%, #3498db 100%); text-align: center; padding: 2rem;">
            <h3 style="margin-bottom: 1.5rem;">Current Membership Breakdown</h3>
            <div id="census-stats"></div>
        </div>
        <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <div class="box" style="text-align: center; background: #34495e; border-top: 4px solid #d35400;">
                <i class="fas fa-home" style="font-size: 2rem; color: #d35400; margin-bottom: 0.5rem;"></i>
                <h4>Home Group Members</h4>
                <p style="font-size: 0.85rem; opacity: 0.8;">Full commitment & voting rights</p>
            </div>
            <div class="box" style="text-align: center; background: #34495e; border-top: 4px solid #3498db;">
                <i class="fas fa-user-check" style="font-size: 2rem; color: #3498db; margin-bottom: 0.5rem;"></i>
                <h4>Regular Attendees</h4>
                <p style="font-size: 0.85rem; opacity: 0.8;">Frequent participation</p>
            </div>
            <div class="box" style="text-align: center; background: #34495e; border-top: 4px solid #2ecc71;">
                <i class="fas fa-seedling" style="font-size: 2rem; color: #2ecc71; margin-bottom: 0.5rem;"></i>
                <h4>Newcomers</h4>
                <p style="font-size: 0.85rem; opacity: 0.8;">Building foundation</p>
            </div>
            <div class="box" style="text-align: center; background: #34495e; border-top: 4px solid #95a5a6;">
                <i class="fas fa-user" style="font-size: 2rem; color: #95a5a6; margin-bottom: 0.5rem;"></i>
                <h4>Visitors</h4>
                <p style="font-size: 0.85rem; opacity: 0.8;">Occasional attendance</p>
            </div>
        </div>
    </section>

    <section id="hg-growth-section" style="border-left: 4px solid #27ae60;">
        <h2><i class="fas fa-chart-line"></i> Home Group Growth Metrics</h2>
        <p class="mb-4">Track membership growth trends over time to understand group health and attraction.</p>
        <div class="box mb-4">
            <h3><i class="fas fa-chart-area"></i> Membership Growth Chart</h3>
            <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem;">Visualize how your group is growing and attracting new members.</p>
            <canvas id="growth-chart" style="max-height: 300px;"></canvas>
        </div>
        <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <div class="box" style="text-align: center; background: #34495e; border-left: 4px solid #2ecc71;">
                <i class="fas fa-arrow-up" style="font-size: 2rem; color: #2ecc71;"></i>
                <h4 style="margin-top: 0.5rem;">Growth Rate</h4>
                <p style="font-size: 0.85rem; opacity: 0.8;">Month-over-month change</p>
            </div>
            <div class="box" style="text-align: center; background: #34495e; border-left: 4px solid #3498db;">
                <i class="fas fa-user-plus" style="font-size: 2rem; color: #3498db;"></i>
                <h4 style="margin-top: 0.5rem;">New Members</h4>
                <p style="font-size: 0.85rem; opacity: 0.8;">Joined this month</p>
            </div>
            <div class="box" style="text-align: center; background: #34495e; border-left: 4px solid #f39c12;">
                <i class="fas fa-chart-bar" style="font-size: 2rem; color: #f39c12;"></i>
                <h4 style="margin-top: 0.5rem;">Retention Rate</h4>
                <p style="font-size: 0.85rem; opacity: 0.8;">Members staying active</p>
            </div>
        </div>
    </section>

    <section id="calendar-integration-section" style="border-left: 4px solid #3498db;">
        <h2><i class="fab fa-google"></i> Google Calendar Integration</h2>
        <p class="mb-4">Sync your AA group meetings with Google Calendar for easy scheduling and reminders.</p>
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
            <div class="box">
                <h3><i class="fas fa-download"></i> Export to Calendar</h3>
                <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem;">Export all your group meetings to Google Calendar with one click.</p>
                <div style="background: #34495e; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                    <h4 style="margin-bottom: 0.5rem;"><i class="fas fa-check-circle"></i> What Gets Exported:</h4>
                    <ul style="font-size: 0.9rem; line-height: 1.6;">
                        <li>Regular meeting schedule</li>
                        <li>Special events & speakers</li>
                        <li>Group Conscience meetings</li>
                        <li>Service position rotations</li>
                    </ul>
                </div>
                <button class="btn" onclick="exportToGoogleCal()"><i class="fas fa-download"></i> Export Events to Google Calendar</button>
            </div>
            <div>
                <div class="box" style="background: #34495e; border-left: 4px solid #f39c12;">
                    <h3><i class="fas fa-info-circle"></i> Setup Instructions</h3>
                    <ol style="font-size: 0.9rem; line-height: 1.8;">
                        <li>Click "Export Events" button</li>
                        <li>Download the .ics calendar file</li>
                        <li>Open Google Calendar</li>
                        <li>Click "+" next to "Other calendars"</li>
                        <li>Select "Import"</li>
                        <li>Choose the downloaded file</li>
                    </ol>
                </div>
                <div class="box mt-4" style="background: #2c3e50; border-left: 4px solid #3498db;">
                    <h4><i class="fas fa-lightbulb"></i> Pro Tip</h4>
                    <p style="font-size: 0.9rem; opacity: 0.8;">Re-export monthly to keep your calendar updated with any schedule changes or new events.</p>
                </div>
            </div>
        </div>
    </section>

    <section id="sms-integration-section" style="border-left: 4px solid #2ecc71;">
        <h2><i class="fas fa-sms"></i> SMS Notification Integration</h2>
        <p class="mb-4">Send automated text messages to group members for meeting reminders and urgent announcements.</p>
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
            <div class="box">
                <h3><i class="fas fa-cog"></i> Integration Status</h3>
                <div style="background: #34495e; padding: 1.5rem; border-radius: 6px; text-align: center; margin: 1rem 0;">
                    <i class="fas fa-plug" style="font-size: 3rem; opacity: 0.3;"></i>
                    <p style="margin-top: 1rem; opacity: 0.8;">SMS integration requires Twilio API setup</p>
                </div>
                <div id="sms-settings"></div>
            </div>
            <div>
                <div class="box" style="background: #34495e; border-left: 4px solid #2ecc71;">
                    <h3><i class="fas fa-list-check"></i> SMS Use Cases</h3>
                    <ul style="line-height: 1.8;">
                        <li><strong>Meeting Reminders:</strong> Automated reminders before meetings</li>
                        <li><strong>Cancellations:</strong> Quick alerts for meeting changes</li>
                        <li><strong>Birthdays:</strong> Sobriety anniversary notifications</li>
                        <li><strong>Events:</strong> Speaker meetings & special events</li>
                        <li><strong>Emergencies:</strong> Urgent group communications</li>
                    </ul>
                </div>
                <div class="box mt-4" style="background: #2c3e50; border-left: 4px solid #f39c12;">
                    <h4><i class="fas fa-info-circle"></i> Setup Required</h4>
                    <p style="font-size: 0.9rem; opacity: 0.8;">To enable SMS, sign up for a Twilio account and add your API credentials in Settings. Messaging rates apply.</p>
                </div>
            </div>
        </div>
    </section>

    <section id="email-automation-section" style="border-left: 4px solid #9b59b6;">
        <h2><i class="fas fa-envelope-open-text"></i> Email Automation</h2>
        <p class="mb-4">Automate email notifications for group updates, meeting minutes, and important announcements.</p>
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
            <div class="box">
                <h3><i class="fas fa-robot"></i> Automation Settings</h3>
                <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem;">Configure automated emails to keep members informed.</p>
                <div id="email-automation-settings"></div>
                <div style="background: #34495e; padding: 1rem; border-radius: 6px; margin-top: 1rem;">
                    <h4 style="margin-bottom: 0.5rem;"><i class="fas fa-envelope"></i> Available Automations:</h4>
                    <ul style="font-size: 0.9rem; line-height: 1.6;">
                        <li>Weekly meeting schedule digest</li>
                        <li>Group Conscience agendas & minutes</li>
                        <li>Financial reports to members</li>
                        <li>Service position rotation reminders</li>
                        <li>Birthday & anniversary notifications</li>
                    </ul>
                </div>
            </div>
            <div>
                <div class="box" style="background: #34495e; border-left: 4px solid #9b59b6;">
                    <h3><i class="fas fa-shield-alt"></i> Privacy & Anonymity</h3>
                    <p style="font-size: 0.9rem; line-height: 1.6; opacity: 0.8;">
                        Email automation respects AA traditions and member anonymity. All emails are sent blind-copy (BCC) to protect member privacy. Personal information is never shared between members without consent.
                    </p>
                </div>
                <div class="box mt-4" style="background: #2c3e50; border-left: 4px solid #3498db;">
                    <h4><i class="fas fa-user-check"></i> Member Preferences</h4>
                    <p style="font-size: 0.9rem; opacity: 0.8;">Members can opt-in or opt-out of automated emails at any time. Respect individual preferences for communication.</p>
                </div>
            </div>
        </div>
    </section>

    <section id="cloud-backup-section" style="border-left: 4px solid #1abc9c;">
        <h2><i class="fas fa-cloud-upload-alt"></i> Automated Cloud Backup</h2>
        <p class="mb-4">Automatically backup your group data to cloud storage for safety and disaster recovery.</p>
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
            <div class="box">
                <h3><i class="fas fa-cog"></i> Setup Cloud Backup</h3>
                <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem;">Connect to Google Drive or Dropbox for automatic backups.</p>
                <div style="background: #34495e; padding: 1.5rem; border-radius: 6px; text-align: center; margin: 1.5rem 0;">
                    <i class="fas fa-cloud" style="font-size: 3rem; color: #1abc9c; opacity: 0.5;"></i>
                    <p style="margin-top: 1rem;">Cloud backup integration available</p>
                </div>
                <button class="btn" onclick="setupCloudBackup()"><i class="fas fa-cog"></i> Configure Cloud Backup</button>
            </div>
            <div>
                <div class="box" style="background: #34495e; border-left: 4px solid #1abc9c;">
                    <h3><i class="fas fa-shield-alt"></i> Why Cloud Backup?</h3>
                    <ul style="line-height: 1.8;">
                        <li><strong>Safety:</strong> Protect against device loss or failure</li>
                        <li><strong>Accessibility:</strong> Access data from any device</li>
                        <li><strong>Automatic:</strong> Set it and forget it</li>
                        <li><strong>Versioning:</strong> Keep historical backups</li>
                        <li><strong>Sharing:</strong> Easy handoff between trusted servants</li>
                    </ul>
                </div>
                <div class="box mt-4" style="background: #2c3e50; border-left: 4px solid #f39c12;">
                    <h4><i class="fas fa-exclamation-triangle"></i> Important</h4>
                    <p style="font-size: 0.9rem; opacity: 0.8;">Cloud backups are encrypted but contain member information. Ensure you have proper group consent before enabling cloud storage.</p>
                </div>
            </div>
        </div>
    </section>

    <section id="multi-group-section" style="border-left: 4px solid #f39c12;">
        <h2><i class="fas fa-layer-group"></i> Multi-Group Support</h2>
        <p class="mb-4">Manage multiple AA groups from one interface - perfect for members who serve multiple groups or district coordinators.</p>
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
            <div>
                <div class="box">
                    <h3><i class="fas fa-plus-circle"></i> Add New Group</h3>
                    <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem;">Track multiple groups you're involved with.</p>
                    <div class="form-group">
                        <label for="group-name-input">Group Name</label>
                        <input type="text" id="group-name-input" placeholder="e.g., Morning Meditation Group" />
                    </div>
                    <button class="btn" onclick="addGroup()"><i class="fas fa-plus"></i> Add Group</button>
                </div>
                <div class="box mt-4" style="background: #34495e; border-left: 4px solid #f39c12;">
                    <h3><i class="fas fa-info-circle"></i> Use Cases</h3>
                    <ul style="font-size: 0.9rem; line-height: 1.6;">
                        <li>GSRs managing home group + district</li>
                        <li>Members with multiple home groups</li>
                        <li>District chairs coordinating groups</li>
                        <li>Inter-group representatives</li>
                    </ul>
                </div>
            </div>
            <div>
                <div class="box">
                    <h3><i class="fas fa-list"></i> Your Groups</h3>
                    <div id="groups-list" style="min-height: 150px;"></div>
                </div>
            </div>
        </div>
    </section>

    <section id="aa-finder-section" style="border-left: 4px solid #e74c3c;">
        <h2><i class="fas fa-map-marked-alt"></i> AA Meeting Finder Integration</h2>
        <p class="mb-4">Quick access to AA.org's official meeting finder - help newcomers and visitors find meetings near them.</p>
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
            <div class="box" style="text-align: center; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); padding: 3rem;">
                <i class="fas fa-map-marked-alt" style="font-size: 4rem; opacity: 0.5; margin-bottom: 1rem;"></i>
                <h3>Find AA Meetings Worldwide</h3>
                <p style="opacity: 0.9; margin: 1.5rem 0;">Access the official AA.org meeting finder to locate meetings by location, day, time, or meeting type.</p>
                <a href="https://www.aa.org/find-aa" target="_blank" rel="noopener" class="btn" style="background: white; color: #e74c3c; font-weight: bold;"><i class="fas fa-external-link-alt"></i> Open AA Meeting Finder</a>
            </div>
            <div>
                <div class="box" style="background: #34495e; border-left: 4px solid #e74c3c;">
                    <h3><i class="fas fa-compass"></i> Helpful for:</h3>
                    <ul style="line-height: 1.8;">
                        <li><strong>Newcomers:</strong> Find meetings close to home</li>
                        <li><strong>Travelers:</strong> Locate meetings while away</li>
                        <li><strong>Visitors:</strong> Get directions to your group</li>
                        <li><strong>Specialties:</strong> Find specific meeting types (women, men, LGBTQ+, etc.)</li>
                        <li><strong>Languages:</strong> Locate meetings in different languages</li>
                    </ul>
                </div>
                <div class="box mt-4" style="background: #2c3e50; border-left: 4px solid #3498db;">
                    <h4><i class="fas fa-lightbulb"></i> Pro Tip</h4>
                    <p style="font-size: 0.9rem; opacity: 0.8;">Print out local meeting schedules from AA.org to hand out to newcomers or keep copies at your meeting location.</p>
                </div>
            </div>
        </div>
    </section>

    <section id="offline-mode-section" style="border-left: 4px solid #34495e;">
        <h2><i class="fas fa-wifi"></i> Offline Mode</h2>
        <p class="mb-4">This application works offline! Once loaded, you can use core features without an internet connection.</p>
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
            <div class="box" style="text-align: center; background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%); padding: 2rem;">
                <h3 style="margin-bottom: 1.5rem;">Connection Status</h3>
                <div id="offline-status" style="font-size: 1.5rem; margin: 2rem 0;">
                    <span style="color: #2ecc71; font-size: 3rem;">●</span>
                    <p style="margin-top: 1rem;">Online & Synced</p>
                </div>
                <p style="font-size: 0.9rem; opacity: 0.8;">All features available</p>
            </div>
            <div>
                <div class="box" style="background: #34495e; border-left: 4px solid #2ecc71;">
                    <h3><i class="fas fa-check-circle"></i> Offline Features</h3>
                    <ul style="line-height: 1.8;">
                        <li><strong>View Data:</strong> Access all stored information</li>
                        <li><strong>Add Content:</strong> Create new entries offline</li>
                        <li><strong>Edit Records:</strong> Update existing data</li>
                        <li><strong>Take Minutes:</strong> Record meeting notes</li>
                        <li><strong>Track Attendance:</strong> Log member presence</li>
                    </ul>
                </div>
                <div class="box mt-4" style="background: #2c3e50; border-left: 4px solid #f39c12;">
                    <h4><i class="fas fa-info-circle"></i> Limited Offline</h4>
                    <p style="font-size: 0.9rem; opacity: 0.8;">External integrations (calendar export, email, SMS) require internet connection. All local features work fully offline.</p>
                </div>
            </div>
        </div>
    </section>

    <section id="mobile-features-section" style="border-left: 4px solid #3498db;">
        <h2><i class="fas fa-mobile-alt"></i> Mobile-Optimized Features</h2>
        <p class="mb-4">Fully responsive design with mobile-first features for on-the-go group management.</p>
        <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
            <div class="box" style="text-align: center; background: #34495e; border-top: 4px solid #3498db;">
                <i class="fas fa-mobile-screen-button" style="font-size: 3rem; color: #3498db; margin: 1rem 0;"></i>
                <h4>Responsive Layout</h4>
                <p style="font-size: 0.85rem; opacity: 0.8;">Adapts to any screen size</p>
            </div>
            <div class="box" style="text-align: center; background: #34495e; border-top: 4px solid #2ecc71;">
                <i class="fas fa-hand-pointer" style="font-size: 3rem; color: #2ecc71; margin: 1rem 0;"></i>
                <h4>Touch-Friendly</h4>
                <p style="font-size: 0.85rem; opacity: 0.8;">Large buttons & easy navigation</p>
            </div>
            <div class="box" style="text-align: center; background: #34495e; border-top: 4px solid #f39c12;">
                <i class="fas fa-bolt" style="font-size: 3rem; color: #f39c12; margin: 1rem 0;"></i>
                <h4>Fast Performance</h4>
                <p style="font-size: 0.85rem; opacity: 0.8;">Optimized for mobile devices</p>
            </div>
        </div>
        <div class="box mt-4" style="background: #2c3e50; border-left: 4px solid #3498db;">
            <h3><i class="fas fa-list-check"></i> Mobile Shortcuts</h3>
            <div id="mobile-shortcuts"></div>
            <p style="font-size: 0.9rem; opacity: 0.8; margin-top: 1rem;">Quickly access frequently used features from the navigation menu. Perfect for taking meeting minutes on your phone or recording attendance on the go.</p>
        </div>
    </section>

    <section id="touch-gestures-section" style="border-left: 4px solid #9b59b6;">
        <h2><i class="fas fa-hand-pointer"></i> Touch Gestures</h2>
        <p class="mb-4">Enhanced mobile navigation with intuitive swipe gestures for faster access.</p>
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
            <div>
                <div class="box" style="background: #34495e; border-left: 4px solid #9b59b6;">
                    <h3><i class="fas fa-hand-paper"></i> Supported Gestures</h3>
                    <div style="background: #2c3e50; padding: 1rem; border-radius: 6px; margin: 0.5rem 0;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <i class="fas fa-arrow-right" style="font-size: 2rem; color: #3498db;"></i>
                            <div>
                                <strong>Swipe Right</strong>
                                <p style="font-size: 0.85rem; opacity: 0.8;">Go back to previous section</p>
                            </div>
                        </div>
                    </div>
                    <div style="background: #2c3e50; padding: 1rem; border-radius: 6px; margin: 0.5rem 0;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <i class="fas fa-arrow-left" style="font-size: 2rem; color: #2ecc71;"></i>
                            <div>
                                <strong>Swipe Left</strong>
                                <p style="font-size: 0.85rem; opacity: 0.8;">Move to next section</p>
                            </div>
                        </div>
                    </div>
                    <div style="background: #2c3e50; padding: 1rem; border-radius: 6px; margin: 0.5rem 0;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <i class="fas fa-arrows-alt-v" style="font-size: 2rem; color: #f39c12;"></i>
                            <div>
                                <strong>Scroll</strong>
                                <p style="font-size: 0.85rem; opacity: 0.8;">Natural scrolling optimized for touch</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div>
                <div class="box" style="background: #2c3e50; border-left: 4px solid #3498db;">
                    <h3><i class="fas fa-cog"></i> Gesture Settings</h3>
                    <div id="gesture-settings"></div>
                    <p style="font-size: 0.9rem; opacity: 0.8; margin-top: 1rem;">Gestures are automatically enabled on touch devices. Disable in Settings if you prefer tap-only navigation.</p>
                </div>
                <div class="box mt-4" style="background: #34495e; border-left: 4px solid #2ecc71;">
                    <h4><i class="fas fa-mobile"></i> Mobile Tips</h4>
                    <ul style="font-size: 0.9rem; line-height: 1.6;">
                        <li>Add to home screen for app-like experience</li>
                        <li>Use landscape mode for wider tables</li>
                        <li>Pinch to zoom on charts and images</li>
                    </ul>
                </div>
            </div>
        </div>
    </section>

    <section id="pwa-install-section" style="border-left: 4px solid #2ecc71;">
        <h2><i class="fas fa-download"></i> Install as Progressive Web App</h2>
        <p class="mb-4">Install HomeGroup on your device for a native app experience with offline support and home screen access.</p>
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
            <div class="box" style="text-align: center; background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); padding: 3rem;">
                <i class="fas fa-mobile-alt" style="font-size: 5rem; opacity: 0.5; margin-bottom: 1rem;"></i>
                <h3>Install on Your Device</h3>
                <p style="opacity: 0.9; margin: 1.5rem 0;">Get a full-screen, app-like experience with faster loading and offline access.</p>
                <button class="btn" onclick="promptPWAInstall()" style="background: white; color: #2ecc71; font-weight: bold;"><i class="fas fa-download"></i> Install HomeGroup App</button>
            </div>
            <div>
                <div class="box" style="background: #34495e; border-left: 4px solid #2ecc71;">
                    <h3><i class="fas fa-star"></i> PWA Benefits</h3>
                    <ul style="line-height: 1.8;">
                        <li><strong>Home Screen Icon:</strong> Quick access like a native app</li>
                        <li><strong>Full Screen:</strong> No browser chrome, more space</li>
                        <li><strong>Offline First:</strong> Works without internet</li>
                        <li><strong>Fast Loading:</strong> Cached for instant startup</li>
                        <li><strong>Auto Updates:</strong> Always the latest version</li>
                        <li><strong>Cross-Platform:</strong> Works on iOS & Android</li>
                    </ul>
                </div>
                <div class="box mt-4" style="background: #2c3e50; border-left: 4px solid #3498db;">
                    <h4><i class="fas fa-question-circle"></i> How to Install</h4>
                    <p style="font-size: 0.9rem; opacity: 0.8;"><strong>Mobile:</strong> Tap "Install App" button or use browser's "Add to Home Screen" option.</p>
                    <p style="font-size: 0.9rem; opacity: 0.8; margin-top: 0.5rem;"><strong>Desktop:</strong> Click install icon in address bar or use "Install" option in browser menu.</p>
                </div>
            </div>
        </div>
    </section>

    <section id="multi-language-section" style="border-left: 4px solid #e67e22;">
        <h2><i class="fas fa-language"></i> Multi-Language Support</h2>
        <p class="mb-4">Make AA accessible to all by providing the application interface in multiple languages.</p>
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
            <div class="box">
                <h3><i class="fas fa-globe"></i> Select Language</h3>
                <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem;">Choose your preferred language for the interface.</p>
                <div class="form-group">
                    <label for="language-select">Interface Language</label>
                    <select id="language-select" style="width: 100%;">
                        <option value="en">English</option>
                        <option value="es">Español (Spanish)</option>
                        <option value="fr">Français (French)</option>
                        <option value="pt">Português (Portuguese)</option>
                        <option value="de">Deutsch (German)</option>
                    </select>
                </div>
                <button class="btn" onclick="changeLanguage()"><i class="fas fa-check"></i> Apply Language</button>
            </div>
            <div>
                <div class="box" style="background: #34495e; border-left: 4px solid #e67e22;">
                    <h3><i class="fas fa-info-circle"></i> Language Support</h3>
                    <p style="font-size: 0.9rem; opacity: 0.8; line-height: 1.6;">
                        Language files must be configured separately. This feature follows AA's tradition of making recovery accessible to people of all backgrounds and languages.
                    </p>
                </div>
                <div class="box mt-4" style="background: #2c3e50; border-left: 4px solid #3498db;">
                    <h4><i class="fas fa-users"></i> Reaching More People</h4>
                    <p style="font-size: 0.9rem; opacity: 0.8;">Multi-language support helps non-English speaking members fully participate in group management and service.</p>
                </div>
            </div>
        </div>
    </section>

    <section id="large-print-section" style="border-left: 4px solid #f39c12;">
        <h2><i class="fas fa-text-height"></i> Large Print Mode</h2>
        <p class="mb-4">Increase text size for better readability - helpful for members with vision difficulties.</p>
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
            <div class="box" style="text-align: center; background: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%); padding: 3rem;">
                <i class="fas fa-text-height" style="font-size: 5rem; opacity: 0.5; margin-bottom: 1rem;"></i>
                <h3>Enable Large Print</h3>
                <div style="background: rgba(0,0,0,0.3); padding: 2rem; border-radius: 8px; margin: 2rem 0;">
                    <label style="display: flex; align-items: center; justify-content: center; gap: 1rem; cursor: pointer;">
                        <input type="checkbox" id="large-print-toggle" onchange="toggleLargePrint()" style="width: 30px; height: 30px;" />
                        <span style="font-size: 1.2rem; font-weight: bold;">Enable Large Print Mode</span>
                    </label>
                </div>
                <p style="opacity: 0.9;">Increases font size by 25% throughout the application</p>
            </div>
            <div>
                <div class="box" style="background: #34495e; border-left: 4px solid #f39c12;">
                    <h3><i class="fas fa-eye"></i> Visibility Features</h3>
                    <ul style="line-height: 1.8;">
                        <li><strong>Larger Text:</strong> 25% increase in font size</li>
                        <li><strong>Maintained Layout:</strong> Design adapts to larger text</li>
                        <li><strong>Buttons & Forms:</strong> All elements scale proportionally</li>
                        <li><strong>Persistent:</strong> Setting remembered across sessions</li>
                    </ul>
                </div>
                <div class="box mt-4" style="background: #2c3e50; border-left: 4px solid #3498db;">
                    <h4><i class="fas fa-universal-access"></i> Additional Accessibility</h4>
                    <p style="font-size: 0.9rem; opacity: 0.8;">Combine with browser zoom (Ctrl/Cmd +) for even larger text. Use high contrast mode in your device settings for better visibility.</p>
                </div>
            </div>
        </div>
    </section>

    <section id="screen-reader-section" style="border-left: 4px solid #1abc9c;">
        <h2><i class="fas fa-assistive-listening-systems"></i> Screen Reader Optimization</h2>
        <p class="mb-4">Enhanced support for screen readers to make the application fully accessible to visually impaired users.</p>
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
            <div class="box" style="background: #34495e; border-left: 4px solid #1abc9c; text-align: center; padding: 3rem;">
                <i class="fas fa-assistive-listening-systems" style="font-size: 5rem; color: #1abc9c; opacity: 0.5; margin-bottom: 1rem;"></i>
                <h3>Screen Reader Ready</h3>
                <p style="opacity: 0.9; margin: 1.5rem 0;">All interactive elements include ARIA labels and semantic HTML for optimal screen reader compatibility.</p>
                <div style="background: #2c3e50; padding: 1rem; border-radius: 6px; margin-top: 2rem;">
                    <p style="color: #1abc9c; font-weight: bold;"><i class="fas fa-check-circle"></i> Fully Compatible</p>
                    <p style="font-size: 0.9rem; opacity: 0.8; margin-top: 0.5rem;">Works with JAWS, NVDA, VoiceOver, and TalkBack</p>
                </div>
            </div>
            <div>
                <div class="box" style="background: #2c3e50; border-left: 4px solid #1abc9c;">
                    <h3><i class="fas fa-list-check"></i> Optimizations</h3>
                    <ul style="line-height: 1.8;">
                        <li><strong>Semantic HTML:</strong> Proper heading hierarchy</li>
                        <li><strong>ARIA Labels:</strong> Descriptive labels on all controls</li>
                        <li><strong>Keyboard Navigation:</strong> Full keyboard support</li>
                        <li><strong>Focus Indicators:</strong> Clear visual focus states</li>
                        <li><strong>Alt Text:</strong> Descriptions for all images</li>
                        <li><strong>Skip Links:</strong> Jump to main content</li>
                    </ul>
                </div>
            </div>
        </div>
    </section>

    <section id="captions-section" style="border-left: 4px solid #3498db;">
        <h2><i class="fas fa-closed-captioning"></i> Closed Captioning for Virtual Meetings</h2>
        <p class="mb-4">Real-time captions for virtual meetings to support members who are deaf or hard of hearing.</p>
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
            <div class="box">
                <h3><i class="fas fa-cog"></i> Caption Setup</h3>
                <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem;">Enable live captions for Zoom or other virtual meetings.</p>
                <div style="background: #34495e; padding: 1.5rem; border-radius: 6px; text-align: center; margin: 1.5rem 0;">
                    <i class="fas fa-closed-captioning" style="font-size: 3rem; color: #3498db; opacity: 0.5;"></i>
                    <p style="margin-top: 1rem;">Requires third-party captioning service</p>
                </div>
                <p style="font-size: 0.85rem; opacity: 0.7;">Services like Otter.ai or Zoom's built-in captions can be integrated with virtual meetings.</p>
            </div>
            <div>
                <div class="box" style="background: #34495e; border-left: 4px solid #3498db;">
                    <h3><i class="fas fa-info-circle"></i> Captioning Services</h3>
                    <ul style="line-height: 1.8; font-size: 0.95rem;">
                        <li><strong>Zoom Built-in:</strong> Free automated captions</li>
                        <li><strong>Otter.ai:</strong> AI-powered transcription</li>
                        <li><strong>Google Meet:</strong> Live captions available</li>
                        <li><strong>Microsoft Teams:</strong> Real-time captions</li>
                    </ul>
                </div>
                <div class="box mt-4" style="background: #2c3e50; border-left: 4px solid #2ecc71;">
                    <h4><i class="fas fa-lightbulb"></i> Best Practice</h4>
                    <p style="font-size: 0.9rem; opacity: 0.8;">Always announce when captions are available. Some members may not know this feature exists.</p>
                </div>
            </div>
        </div>
    </section>

    <section id="accessibility-committee-section" style="border-left: 4px solid #9b59b6;">
        <h2><i class="fas fa-universal-access"></i> Accessibility Committee</h2>
        <p class="mb-4">Submit and track accessibility concerns to ensure all members can fully participate in group activities.</p>
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
            <div>
                <div class="box">
                    <h3><i class="fas fa-paper-plane"></i> Submit Concern</h3>
                    <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem;">Help us identify accessibility barriers in our group.</p>
                    <div class="form-group">
                        <label for="accessibility-concern">Describe the Accessibility Issue</label>
                        <textarea id="accessibility-concern" rows="5" placeholder="e.g., Meeting location has stairs but no ramp..."></textarea>
                    </div>
                    <button class="btn" onclick="submitAccessibilityConcern()"><i class="fas fa-paper-plane"></i> Submit Concern</button>
                </div>
            </div>
            <div>
                <div class="box">
                    <h3><i class="fas fa-list"></i> Reported Concerns</h3>
                    <div id="accessibility-concerns-list" style="min-height: 150px;"></div>
                </div>
                <div class="box mt-4" style="background: #34495e; border-left: 4px solid #9b59b6;">
                    <h4><i class="fas fa-info-circle"></i> Common Barriers</h4>
                    <ul style="font-size: 0.9rem; line-height: 1.6;">
                        <li>Physical access (stairs, parking)</li>
                        <li>Audio quality issues</li>
                        <li>Vision accessibility (lighting, materials)</li>
                        <li>Language barriers</li>
                        <li>Technology challenges</li>
                    </ul>
                </div>
            </div>
        </div>
    </section>

    <section id="digital-archive-section" style="border-left: 4px solid #95a5a6;">
        <h2><i class="fas fa-archive"></i> Digital Archive</h2>
        <p class="mb-4">Preserve important group documents, photos, and records for future generations.</p>
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
            <div>
                <div class="box">
                    <h3><i class="fas fa-upload"></i> Upload to Archive</h3>
                    <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem;">Store historical documents, photos, and important group files.</p>
                    <div class="form-group">
                        <label for="archive-file">Select File</label>
                        <input type="file" id="archive-file" style="width: 100%;" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.txt" />
                    </div>
                    <button class="btn" onclick="uploadArchive()"><i class="fas fa-upload"></i> Upload to Archive</button>
                </div>
                <div class="box mt-4" style="background: #34495e; border-left: 4px solid #95a5a6;">
                    <h4><i class="fas fa-file-archive"></i> What to Archive</h4>
                    <ul style="font-size: 0.9rem; line-height: 1.6;">
                        <li>Founding documents & charter</li>
                        <li>Historical meeting minutes</li>
                        <li>Group photos from events</li>
                        <li>Anniversary celebration records</li>
                        <li>Important GC decisions</li>
                    </ul>
                </div>
            </div>
            <div>
                <div class="box">
                    <h3><i class="fas fa-folder-open"></i> Archive Contents</h3>
                    <div id="archive-list" style="min-height: 200px;"></div>
                </div>
            </div>
        </div>
    </section>

    <section id="oral-history-section" style="border-left: 4px solid #34495e;">
        <h2><i class="fas fa-microphone"></i> Oral History Collection</h2>
        <p class="mb-4">Record and preserve stories from long-time members to maintain group history and pass wisdom to future generations.</p>
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
            <div>
                <div class="box" style="background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%); text-align: center; padding: 2rem;">
                    <i class="fas fa-microphone" style="font-size: 4rem; opacity: 0.5; margin-bottom: 1rem;"></i>
                    <h3>Record Interview</h3>
                    <p style="opacity: 0.9; margin: 1rem 0;">Capture the stories and wisdom of old-timers.</p>
                    <div class="form-group" style="text-align: left; margin: 1.5rem 0;">
                        <label for="interview-member">Old-Timer to Interview</label>
                        <select id="interview-member" style="width: 100%;">
                            <option value="">-- Select Member --</option>
                        </select>
                    </div>
                    <button class="btn" onclick="startInterview()"><i class="fas fa-record-vinyl"></i> Start Recording</button>
                </div>
            </div>
            <div>
                <div class="box">
                    <h3><i class="fas fa-history"></i> Recorded Interviews</h3>
                    <div id="oral-histories-list" style="min-height: 150px;"></div>
                </div>
                <div class="box mt-4" style="background: #34495e; border-left: 4px solid #3498db;">
                    <h4><i class="fas fa-question-circle"></i> Interview Topics</h4>
                    <ul style="font-size: 0.9rem; line-height: 1.6;">
                        <li>How did you find the group?</li>
                        <li>What was the group like in early days?</li>
                        <li>Memorable moments and celebrations</li>
                        <li>Challenges the group overcame</li>
                        <li>Advice for future members</li>
                    </ul>
                </div>
            </div>
        </div>
    </section>

    <section id="milestones-section" style="border-left: 4px solid #f39c12;">
        <h2><i class="fas fa-trophy"></i> Group Milestones</h2>
        <p class="mb-4">Document significant achievements and important dates in your group's history.</p>
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
            <div>
                <div class="box">
                    <h3><i class="fas fa-plus-circle"></i> Add Milestone</h3>
                    <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem;">Record an important event or achievement.</p>
                    <div class="form-group">
                        <label for="milestone-title">Milestone Event</label>
                        <input type="text" id="milestone-title" placeholder="e.g., Group's 25th Anniversary" />
                    </div>
                    <div class="form-group">
                        <label for="milestone-date">Date</label>
                        <input type="date" id="milestone-date" />
                    </div>
                    <button class="btn" onclick="addMilestone()"><i class="fas fa-plus"></i> Add Milestone</button>
                </div>
                <div class="box mt-4" style="background: #34495e; border-left: 4px solid #f39c12;">
                    <h4><i class="fas fa-star"></i> Examples</h4>
                    <ul style="font-size: 0.9rem; line-height: 1.6;">
                        <li>Group founding date</li>
                        <li>Anniversary celebrations (10th, 25th, 50th)</li>
                        <li>New meeting location opening</li>
                        <li>Major service contributions</li>
                        <li>Record attendance meetings</li>
                    </ul>
                </div>
            </div>
            <div>
                <div class="box">
                    <h3><i class="fas fa-calendar-check"></i> Timeline</h3>
                    <div id="milestones-list" style="min-height: 300px;"></div>
                </div>
            </div>
        </div>
    </section>

    <section id="member-legacy-section" style="border-left: 4px solid #e74c3c;">
        <h2><i class="fas fa-heart"></i> Member Legacy Tributes</h2>
        <p class="mb-4">Honor and remember members who have passed away with loving tributes and memories.</p>
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
            <div>
                <div class="box" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); padding: 2rem;">
                    <i class="fas fa-heart" style="font-size: 3rem; opacity: 0.5; text-align: center; display: block; margin-bottom: 1rem;"></i>
                    <h3 style="text-align: center;">Create Memorial</h3>
                    <p style="opacity: 0.9; text-align: center; margin-bottom: 1.5rem;">Remember those who carried the message.</p>
                    <div class="form-group">
                        <label for="legacy-name">Member Name</label>
                        <input type="text" id="legacy-name" placeholder="Full name" />
                    </div>
                    <div class="form-group">
                        <label for="legacy-tribute">Tribute & Memories</label>
                        <textarea id="legacy-tribute" rows="5" placeholder="Share memories and how they impacted the group..."></textarea>
                    </div>
                    <button class="btn" onclick="addLegacy()" style="width: 100%; background: white; color: #e74c3c; font-weight: bold;"><i class="fas fa-plus"></i> Add Legacy</button>
                </div>
            </div>
            <div>
                <div class="box">
                    <h3><i class="fas fa-book-heart"></i> Remembered Members</h3>
                    <div id="legacy-list" style="min-height: 300px;"></div>
                </div>
                <div class="box mt-4" style="background: #34495e; border-left: 4px solid #3498db;">
                    <h4><i class="fas fa-quote-left"></i> Spiritual Principle</h4>
                    <p style="font-size: 0.9rem; opacity: 0.8; font-style: italic;">"We cannot live in the past, but we can treasure the lessons and love from those who came before us. Their legacy lives on through our recovery."</p>
                </div>
            </div>
        </div>
    </section>

    <section id="historical-minutes-section" style="border-left: 4px solid #2980b9;">
        <h2><i class="fas fa-scroll"></i> Historical Meeting Minutes Search</h2>
        <p class="mb-4">Search through archived meeting minutes to find past decisions, attendance records, and group history.</p>
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
            <div>
                <div class="box">
                    <h3><i class="fas fa-search"></i> Search Archives</h3>
                    <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem;">Find specific meetings or topics in historical records.</p>
                    <div class="form-group">
                        <label for="minutes-search">Search Keywords</label>
                        <input type="text" id="minutes-search" placeholder="e.g., budget, secretary election, 2020..." />
                    </div>
                    <button class="btn" onclick="searchMinutes()"><i class="fas fa-search"></i> Search Minutes</button>
                </div>
                <div class="box mt-4" style="background: #34495e; border-left: 4px solid #2980b9;">
                    <h4><i class="fas fa-lightbulb"></i> Search Tips</h4>
                    <ul style="font-size: 0.9rem; line-height: 1.6;">
                        <li>Search by year (e.g., "2019")</li>
                        <li>Search by topic (e.g., "budget")</li>
                        <li>Search by service position</li>
                        <li>Use quotes for exact phrases</li>
                    </ul>
                </div>
            </div>
            <div>
                <div class="box">
                    <h3><i class="fas fa-file-alt"></i> Search Results</h3>
                    <div id="historical-minutes-list" style="min-height: 300px;"></div>
                </div>
            </div>
        </div>
    </section>

    <script>
function genId() {
    return Date.now().toString() + Math.random().toString(36).substring(2);
}
function sanitizeInput(input) {
    if (typeof input !== 'string') return input;
    if (typeof DOMPurify !== 'undefined') {
        return DOMPurify.sanitize(input, { ALLOWED_TAGS: [] });
    }
    const div = document.createElement('div');
    div.textContent = input;
    return div.innerHTML;
}

let db;
function initDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open('photo_gallery', 1);

        request.onupgradeneeded = (event) => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains('images')) {
                db.createObjectStore('images', { keyPath: 'id' });
            }
        };

        request.onerror = (event) => {
            console.error('IndexedDB error:', event.target.errorCode);
            reject(event.target.errorCode);
        };

        request.onsuccess = (event) => {
            db = event.target.result;

            // Check for old photos in localStorage
            const oldPhotosJSON = localStorage.getItem('photos');
            if (oldPhotosJSON) {
                try {
                    const oldPhotos = JSON.parse(oldPhotosJSON);
                    if (Array.isArray(oldPhotos) && oldPhotos.length > 0) {
                        console.log('Migrating photos from localStorage to IndexedDB...');
                        const transaction = db.transaction(['images'], 'readwrite');
                        const store = transaction.objectStore('images');

                        oldPhotos.forEach(photo => {
                            const photoObject = typeof photo === 'string' ? { src: photo, tags: [] } : photo;
                            if (!photoObject.id) photoObject.id = genId();
                            if (!photoObject.uploadedAt) photoObject.uploadedAt = new Date().toISOString();
                            store.add(photoObject);
                        });

                        transaction.oncomplete = () => {
                            console.log('Photo migration complete. Removing from localStorage.');
                            localStorage.removeItem('photos');
                            migratePhotos().then(() => resolve(db));
                        };
                        transaction.onerror = (err) => {
                             console.error('Photo migration transaction error:', err);
                             migratePhotos().then(() => resolve(db));
                        }
                    } else {
                         localStorage.removeItem('photos'); // empty or invalid array
                         migratePhotos().then(() => resolve(db));
                    }
                } catch (e) {
                    console.error('Error parsing or migrating photos from localStorage:', e);
                    localStorage.removeItem('photos'); // Corrupted data
                    migratePhotos().then(() => resolve(db));
                }
            } else {
                migratePhotos().then(() => resolve(db));
            }
        };
    });
}

function addPhotoToDB(photo) {
    return new Promise((resolve, reject) => {
        if (!db) {
            reject('DB not initialized');
            return;
        }
        // Convert base64 to Blob if necessary
        if (typeof photo.src === 'string' && photo.src.startsWith('data:image')) {
            const byteString = atob(photo.src.split(',')[1]);
            const mimeString = photo.src.split(',')[0].split(':')[1].split(';')[0];
            const ab = new ArrayBuffer(byteString.length);
            const ia = new Uint8Array(ab);
            for (let i = 0; i < byteString.length; i++) {
                ia[i] = byteString.charCodeAt(i);
            }
            photo.src = new Blob([ab], { type: mimeString });
        }

        const transaction = db.transaction(['images'], 'readwrite');
        const store = transaction.objectStore('images');
        const request = store.add(photo);
        request.onsuccess = () => resolve();
        request.onerror = (event) => reject(event.target.error);
    });
}

function getPhotosFromDB() {
    return new Promise((resolve, reject) => {
        if (!db) {
            reject('DB not initialized');
            return;
        }
        const transaction = db.transaction(['images'], 'readonly');
        const store = transaction.objectStore('images');
        const request = store.getAll();
        request.onsuccess = (event) => resolve(event.target.result);
        request.onerror = (event) => reject(event.target.error);
    });
}

function deletePhotoFromDB(id) {
    return new Promise((resolve, reject) => {
        if (!db) {
            reject('DB not initialized');
            return;
        }
        const transaction = db.transaction(['images'], 'readwrite');
        const store = transaction.objectStore('images');
        const request = store.delete(id);
        request.onsuccess = () => resolve();
        request.onerror = (event) => reject(event.target.error);
    });
}

function base64ToBlob(base64, contentType = '') {
    const sliceSize = 512;
    const byteCharacters = atob(base64.split(',')[1]);
    const byteArrays = [];

    for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
        const slice = byteCharacters.slice(offset, offset + sliceSize);
        const byteNumbers = new Array(slice.length);
        for (let i = 0; i < slice.length; i++) {
            byteNumbers[i] = slice.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        byteArrays.push(byteArray);
    }

    const blob = new Blob(byteArrays, {type: contentType});
    return blob;
}


async function migratePhotos() {
    console.log("Checking for photo data that needs migration...");
    try {
        const photos = await getPhotosFromDB();
        const photosToMigrate = photos.filter(p => typeof p.src === 'string' && p.src.startsWith('data:image'));

        if (photosToMigrate.length === 0) {
            console.log("No photos to migrate.");
            return;
        }

        console.log(`Found ${photosToMigrate.length} photos to migrate from Base64 to Blob.`);

        const transaction = db.transaction(['images'], 'readwrite');
        const store = transaction.objectStore('images');

        for (const photo of photosToMigrate) {
            const contentType = photo.src.split(';')[0].split(':')[1];
            const blob = base64ToBlob(photo.src, contentType);
            const updatedPhoto = { ...photo, src: blob };
            store.put(updatedPhoto);
        }

        return new Promise((resolve, reject) => {
            transaction.oncomplete = () => {
                console.log("Photo migration completed successfully.");
                showToast(`${photosToMigrate.length} photos migrated to a more efficient format!`, 'success');
                resolve();
            };
            transaction.onerror = (event) => {
                console.error("Error during photo migration transaction:", event.target.error);
                reject(event.target.error);
            };
        });

    } catch (error) {
        console.error("Error migrating photos:", error);
    }
}

function sanitizeHTML(html) {
    if (typeof html !== 'string') return html;
    if (typeof DOMPurify !== 'undefined') {
        return DOMPurify.sanitize(html, {
            ALLOWED_TAGS: ['b', 'i', 'em', 'strong', 'br', 'p', 'ul', 'ol', 'li'],
            ALLOWED_ATTR: []
        });
    }
    return sanitizeInput(html);
}
function goToSection(sectionId) {
    document.querySelectorAll('main section').forEach(sec => sec.classList.remove('active'));
    document.querySelectorAll('nav li').forEach(li => li.classList.remove('active'));
    const section = document.getElementById(sectionId);
    if (section) {
        section.classList.add('active');
    } else {
        console.warn('Section not found:', sectionId);
        return;
    }
    const navItem = document.querySelector('nav li[data-section="' + sectionId + '"]');
    if (navItem) {
        navItem.classList.add('active');
    }
    const mainEl = document.querySelector('main');
    if (mainEl) {
        mainEl.scrollTo({ top: 0, behavior: 'smooth' });
    }
    document.querySelectorAll('nav li.has-dropdown').forEach(dd => {
        dd.classList.remove('dropdown-open');
    });
    if (sectionId === 'schedule-section') {
        renderCalendar();
    } else if (sectionId === 'analytics-section') {
        refreshAnalytics();
    } else if (sectionId === 'birthdays-section') {
        updateBirthdaysTable();
    } else if (sectionId === 'announcements-section') {
        updateAnnouncementsList();
    } else if (sectionId === 'newcomer-section') {
        updateNewcomersList();
        populateNewcomerDropdowns();
    } else if (sectionId === 'sponsors-section') {
        updateAvailableSponsors();
    } else if (sectionId === 'topic-suggestions-section') {
        updateTopicsList();
    } else if (sectionId === 'call-roster-section') {
        updateCallRosterList();
    } else if (sectionId === 'daily-reflections-section') {
        loadDailyReflection();
    } else if (sectionId === 'step-tracker-section') {
        displayStepProgress();
    } else if (sectionId === 'service-opportunities-section') {
        updateServiceOpportunitiesList();
    } else if (sectionId === 'temperature-check-section') {
        displayTemperatureResults();
    } else if (sectionId === 'group-vision-section') {
        loadGroupVision();
    } else if (sectionId === 'member-wellness-section') {
        updateWellnessSummary();
        updateAbsentMembersList();
    } else if (sectionId === 'sponsor-matching-section') {
        populateTempSponsorDropdown();
        updateTempSponsorList();
    } else if (sectionId === 'emergency-contacts-section') {
        populateEmergencyContactDropdown();
        updateEmergencyContactDisplay();
    } else if (sectionId === 'problem-box-section') {
        updateProblemBoxDisplay();
    } else if (sectionId === 'satisfaction-survey-section') {
        updateSurveyResults();
    } else if (sectionId === 'attendance-streaks-section') {
        updateStreakLeaderboard();
        updateAllStreaks();
    } else if (sectionId === 'commitment-tracking-section') {
        populateCommitmentMemberDropdown();
        updateCommitmentHistory();
        updateCommitmentLeaderboard();
    } else if (sectionId === 'meeting-feedback-section') {
        updateFeedbackSummary();
    } else if (sectionId === 'speaker-booking-section') {
        updateSpeakerSchedule();
    } else if (sectionId === 'chip-ceremony-section') {
        populateChipMemberDropdown();
        updateUpcomingChipCeremonies();
    } else if (sectionId === 'meeting-analytics-section') {
        updateMeetingAnalytics();
    } else if (sectionId === 'role-rotation-section') {
        populateRotationMembers();
        updateRoleAssignments();
    } else if (sectionId === 'virtual-meeting-section') {
        updateVirtualMeetingsList();
    } else if (sectionId === 'qr-checkin-section') {
        populateQRMeetingSelect();
    } else if (sectionId === 'communication-lists-section') {
        populateCommListMembers();
        updateCommListsDisplay();
    } else if (sectionId === 'meeting-reminders-section') {
        populateReminderMeetings();
        updateRemindersList();
    } else if (sectionId === 'notifications-section') {
        updateUpcomingBirthdaysList();
    } else if (sectionId === 'action-items-section') {
        populateActionItemAssigned();
        updateActionItemsList();
    } else if (sectionId === 'cancellation-alerts-section') {
        populateCancelMeeting();
        updateCancellationHistory();
    } else if (sectionId === 'welcome-packet-section') {
        populateWelcomeNewcomer();
        updateWelcomePacketsList();
    } else if (sectionId === 'bigbook-tracker-section') {
        updateBigBookProgress();
    } else if (sectionId === 'literature-loans-section') {
        populateLoanMember();
        updateLiteratureLoansList();
    } else if (sectionId === 'newcomer-packs-section') {
        populatePackNewcomer();
        updateNewcomerPacksHistory();
    } else if (sectionId === 'literature-sales-section') {
        updateLiteratureSalesSummary();
    } else if (sectionId === 'study-guide-section') {
    } else if (sectionId === 'contribution-comparison-section') {
        updateContributionComparison();
    } else if (sectionId === 'expense-approval-section') {
        updatePendingApprovals();
    } else if (sectionId === 'bill-reminders-section') {
        updateUpcomingBills();
    } else if (sectionId === 'financial-goals-section') {
        updateFinancialGoalsList();
    } else if (sectionId === 'expense-receipts-section') {
        updateReceiptsList();
    } else if (sectionId === 'quarterly-reports-section') {
    } else if (sectionId === 'sponsorship-tree-section') {
    } else if (sectionId === 'hi-commitments-section') {
        populateHIMember();
        updateHICommitmentsList();
    } else if (sectionId === 'service-hours-section') {
        populateServiceMember();
        updateServiceHoursLeaderboard();
    } else if (sectionId === 'conflict-resolution-section') {
        updateConflictsList();
    } else if (sectionId === 'inventory-questions-section') {
        loadInventoryQuestions();
    } else if (sectionId === 'tradition-study-section') {
        loadTraditionCurriculum();
    } else if (sectionId === 'concept-study-section') {
        loadConceptCurriculum();
    } else if (sectionId === 'inter-group-section') {
        populateInterGroupMembers();
        updateInterGroupList();
    } else if (sectionId === 'hg-transfer-section') {
        populateTransferMembers();
        updateTransferHistory();
    } else if (sectionId === 'hg-benefits-section') {
        updateVotingEligibility();
    } else if (sectionId === 'hg-commitment-section') {
        updateCommitmentLevels();
    } else if (sectionId === 'hg-census-section') {
        updateCensusStats();
    } else if (sectionId === 'hg-growth-section') {
        updateGrowthMetrics();
    } else if (sectionId === 'multi-group-section') {
        updateGroupsList();
    } else if (sectionId === 'oral-history-section') {
        populateInterviewMembers();
        updateOralHistoriesList();
    } else if (sectionId === 'milestones-section') {
        updateMilestonesList();
    } else if (sectionId === 'member-legacy-section') {
        updateLegacyList();
    } else if (sectionId === 'accessibility-committee-section') {
        updateAccessibilityConcernsList();
    } else if (sectionId === 'digital-archive-section') {
        updateDigitalArchiveList();
    } else if (sectionId === 'historical-minutes-section') {
        updateHistoricalMinutesList();
    }
}
function toggleEventForm() {
    const form = document.getElementById('add-event-form');
    if (!form) return;
    const isVisible = form.style.display === 'block';
    form.style.display = isVisible ? 'none' : 'block';
}
function toggleMemberForm() {
    const form = document.getElementById('add-member-form');
    if (!form) return;
    const isVisible = form.style.display === 'block';
    form.style.display = isVisible ? 'none' : 'block';
}
function showToast(message, type = 'info') { // type can be 'info', 'success', or 'error'
    const container = document.getElementById('toast-container');
    if (!container) return;
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => {
        toast.classList.add('show');
    }, 100);
    setTimeout(() => {
        toast.classList.remove('show');
        toast.addEventListener('transitionend', () => {
            toast.remove();
        }, { once: true }); // Use once option to prevent multiple fires
    }, 3000); // Toast disappears after 3 seconds
}
function validateEmail(email) {
    if (!email) return true; // Empty email is allowed
    const emailRegex = /^[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
    if (email.length > 254) return false; // RFC 5321 maximum length
    if (!emailRegex.test(email)) return false;
    const parts = email.split('@');
    if (parts.length !== 2) return false;
    const domain = parts[1];
    const domainParts = domain.split('.');
    const tld = domainParts[domainParts.length - 1];
    return tld.length >= 2;
}
function validatePhone(phone) {
    if (!phone) return true; // Empty phone is allowed
    const phoneRegex = /^[\d\s\-\(\)\.\+]+$/;
    const digits = phone.replace(/\D/g, '');
    return phoneRegex.test(phone) && digits.length >= 10 && digits.length <= 15;
}
function escapeHtml(text) {
    if (text === null || text === undefined) return '';
    const div = document.createElement('div');
    div.textContent = String(text);
    return div.innerHTML;
}
function escapeAttribute(value) {
    if (value === null || value === undefined) return '';
    if (typeof value !== 'string') value = String(value);
    return value.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
}
function sanitizeHtml(dirty) {
    if (typeof DOMPurify === 'undefined') {
        console.warn('DOMPurify not loaded, falling back to basic escaping');
        return escapeHtml(dirty);
    }
    return DOMPurify.sanitize(dirty, {
        ALLOWED_TAGS: ['b', 'i', 'em', 'strong', 'br', 'p', 'ul', 'ol', 'li'],
        ALLOWED_ATTR: []
    });
}
function parseIntSafe(value, defaultValue = 0) {
    const parsed = parseInt(value, 10);
    return isNaN(parsed) ? defaultValue : parsed;
}
function parseFloatSafe(value, defaultValue = 0.0) {
    const parsed = parseFloat(value);
    return isNaN(parsed) ? defaultValue : parsed;
}
function getLocalStorageSize() {
    let total = 0;
    for (let key in localStorage) {
        if (localStorage.hasOwnProperty(key)) {
            total += localStorage[key].length + key.length;
        }
    }
    return total;
}
function checkLocalStorageQuota() {
    try {
        const currentSize = getLocalStorageSize();
        const estimatedLimit = 5 * 1024 * 1024; // 5MB typical limit
        const usagePercent = (currentSize / estimatedLimit) * 100;
        if (usagePercent > 90) {
            showToast(`Warning: localStorage is ${usagePercent.toFixed(1)}% full. Consider exporting and archiving old data.`, 'error');
            return false;
        } else if (usagePercent > 75) {
            showToast(`Notice: localStorage is ${usagePercent.toFixed(1)}% full.`, 'warning');
        }
        return true;
    } catch (e) {
        showToast('Error checking storage quota: ' + e.message, 'error');
        return false;
    }
}
function safeLocalStorageSet(key, value) {
    try {
        localStorage.setItem(key, value);
        return true;
    } catch (e) {
        if (e.name === 'QuotaExceededError' || e.code === 22) {
            const sizeKB = (getLocalStorageSize() / 1024).toFixed(2);
            showToast(`Storage quota exceeded! Current usage: ${sizeKB}KB. Please export and delete old data.`, 'error');
            return false;
        }
        throw e;
    }
}
const storage = {
    getEvents() {
        try { return JSON.parse(localStorage.getItem('events') || '[]'); }
        catch(e) { console.error('Error parsing events:', e); return []; }
    },
    saveEvents(events) { localStorage.setItem('events', JSON.stringify(events)); },
    getMembers() {
        try { return JSON.parse(localStorage.getItem('members') || '[]'); }
        catch(e) { console.error('Error parsing members:', e); return []; }
    },
    saveMembers(m) { localStorage.setItem('members', JSON.stringify(m)); },
    getAnnouncements() {
        try { return JSON.parse(localStorage.getItem('announcements') || '[]'); }
        catch(e) { console.error('Error parsing announcements:', e); return []; }
    },
    saveAnnouncements(a) { localStorage.setItem('announcements', JSON.stringify(a)); },
    getPhotos() {
        try { return JSON.parse(localStorage.getItem('photos') || '[]'); }
        catch(e) { console.error('Error parsing photos:', e); return []; }
    },
    savePhotos(p) {
        const jsonStr = JSON.stringify(p);
        if (!safeLocalStorageSet('photos', jsonStr)) {
            throw new Error('Failed to save photos due to storage quota exceeded');
        }
    },
    getChairpersonLog() {
        try { return JSON.parse(localStorage.getItem('chairpersonLog') || '[]'); }
        catch(e) { console.error('Error parsing chairpersonLog:', e); return []; }
    },
    saveChairpersonLog(log) { localStorage.setItem('chairpersonLog', JSON.stringify(log)); },
    getGroupConscienceLog() {
        try { return JSON.parse(localStorage.getItem('groupConscienceLog') || '[]'); }
        catch(e) { console.error('Error parsing groupConscienceLog:', e); return []; }
    },
    saveGroupConscienceLog(log) { localStorage.setItem('groupConscienceLog', JSON.stringify(log)); },
    getLiveGCItems() {
        try { return JSON.parse(localStorage.getItem('liveGCItems') || '[]'); }
        catch(e) { console.error('Error parsing liveGCItems:', e); return []; }
    },
    saveLiveGCItems(items) { localStorage.setItem('liveGCItems', JSON.stringify(items)); },
    getProposedAgendaItems() {
        try { return JSON.parse(localStorage.getItem('proposedAgendaItems') || '[]'); }
        catch(e) { console.error('Error parsing proposedAgendaItems:', e); return []; }
    },
    saveProposedAgendaItems(items) { localStorage.setItem('proposedAgendaItems', JSON.stringify(items)); },
    getGCComments() {
        try { return JSON.parse(localStorage.getItem('gcComments') || '[]'); }
        catch(e) { console.error('Error parsing gcComments:', e); return []; }
    },
    saveGCComments(comments) { localStorage.setItem('gcComments', JSON.stringify(comments)); },
    getGCActionItems() {
        try { return JSON.parse(localStorage.getItem('gcActionItems') || '[]'); }
        catch(e) { console.error('Error parsing gcActionItems:', e); return []; }
    },
    saveGCActionItems(actions) { localStorage.setItem('gcActionItems', JSON.stringify(actions)); },
    getGCSettings() {
        try { return JSON.parse(localStorage.getItem('gcSettings') || '{"quorumPercentage": 50, "quorumMinimum": 5}'); }
        catch(e) { console.error('Error parsing gcSettings:', e); return {"quorumPercentage": 50, "quorumMinimum": 5}; }
    },
    saveGCSettings(settings) { localStorage.setItem('gcSettings', JSON.stringify(settings)); },
    getMessages() {
        try { return JSON.parse(localStorage.getItem('messages') || '[]'); }
        catch(e) { console.error('Error parsing messages:', e); return []; }
    },
    saveMessages(messages) { localStorage.setItem('messages', JSON.stringify(messages)); },
    getServicePositions() {
        try { return JSON.parse(localStorage.getItem('servicePositions') || '[]'); }
        catch(e) { console.error('Error parsing servicePositions:', e); return []; }
    },
    saveServicePositions(positions) { localStorage.setItem('servicePositions', JSON.stringify(positions)); },
    getNominations() {
        try { return JSON.parse(localStorage.getItem('nominations') || '[]'); }
        catch(e) { console.error('Error parsing nominations:', e); return []; }
    },
    saveNominations(nominations) { localStorage.setItem('nominations', JSON.stringify(nominations)); },
    getBudgetCategories() {
        try { return JSON.parse(localStorage.getItem('budgetCategories') || '[]'); }
        catch(e) { console.error('Error parsing budgetCategories:', e); return []; }
    },
    saveBudgetCategories(categories) { localStorage.setItem('budgetCategories', JSON.stringify(categories)); },
    getExpenses() {
        try { return JSON.parse(localStorage.getItem('expenses') || '[]'); }
        catch(e) { console.error('Error parsing expenses:', e); return []; }
    },
    saveExpenses(expenses) { localStorage.setItem('expenses', JSON.stringify(expenses)); },
    getTemplates() {
        try { return JSON.parse(localStorage.getItem('templates') || '[]'); }
        catch(e) { console.error('Error parsing templates:', e); return []; }
    },
    saveTemplates(templates) { localStorage.setItem('templates', JSON.stringify(templates)); },
    getAnnouncementReadReceipts() {
        try { return JSON.parse(localStorage.getItem('announcementReadReceipts') || '{}'); }
        catch(e) { console.error('Error parsing announcementReadReceipts:', e); return {}; }
    },
    saveAnnouncementReadReceipts(receipts) { localStorage.setItem('announcementReadReceipts', JSON.stringify(receipts)); },
    getCurrentUser() { return localStorage.getItem('currentUser') || 'Anonymous'; },
    saveCurrentUser(user) { localStorage.setItem('currentUser', user); },
    getLiteratureInventory() {
        try { return JSON.parse(localStorage.getItem('literatureInventory') || '[]'); }
        catch(e) { console.error('Error parsing literatureInventory:', e); return []; }
    },
    saveLiteratureInventory(inventory) { localStorage.setItem('literatureInventory', JSON.stringify(inventory)); },
    getLiteratureLoans() {
        try { return JSON.parse(localStorage.getItem('literatureLoans') || '[]'); }
        catch(e) { console.error('Error parsing literatureLoans:', e); return []; }
    },
    saveLiteratureLoans(loans) { localStorage.setItem('literatureLoans', JSON.stringify(loans)); },
    getServiceElections() {
        try { return JSON.parse(localStorage.getItem('serviceElections') || '[]'); }
        catch(e) { console.error('Error parsing serviceElections:', e); return []; }
    },
    saveServiceElections(elections) { localStorage.setItem('serviceElections', JSON.stringify(elections)); },
    getElectionBallots() {
        try { return JSON.parse(localStorage.getItem('electionBallots') || '[]'); }
        catch(e) { console.error('Error parsing electionBallots:', e); return []; }
    },
    saveElectionBallots(ballots) { localStorage.setItem('electionBallots', JSON.stringify(ballots)); },
    getSpeakingQueue() {
        try { return JSON.parse(localStorage.getItem('speakingQueue') || '[]'); }
        catch(e) { console.error('Error parsing speakingQueue:', e); return []; }
    },
    saveSpeakingQueue(queue) { localStorage.setItem('speakingQueue', JSON.stringify(queue)); },
    getMotionTemplates() {
        try { return JSON.parse(localStorage.getItem('motionTemplates') || '[]'); }
        catch(e) { console.error('Error parsing motionTemplates:', e); return []; }
    },
    saveMotionTemplates(templates) { localStorage.setItem('motionTemplates', JSON.stringify(templates)); },
    getTraditionChecks() {
        try { return JSON.parse(localStorage.getItem('traditionChecks') || '[]'); }
        catch(e) { console.error('Error parsing traditionChecks:', e); return []; }
    },
    saveTraditionChecks(checks) { localStorage.setItem('traditionChecks', JSON.stringify(checks)); },
    getBudgetProposals() {
        try { return JSON.parse(localStorage.getItem('budgetProposals') || '[]'); }
        catch(e) { console.error('Error parsing budgetProposals:', e); return []; }
    },
    saveBudgetProposals(proposals) { localStorage.setItem('budgetProposals', JSON.stringify(proposals)); },
    getDistrictMotions() {
        try { return JSON.parse(localStorage.getItem('districtMotions') || '[]'); }
        catch(e) { console.error('Error parsing districtMotions:', e); return []; }
    },
    saveDistrictMotions(motions) { localStorage.setItem('districtMotions', JSON.stringify(motions)); },
    getGroupPositions() {
        try { return JSON.parse(localStorage.getItem('groupPositions') || '[]'); }
        catch(e) { console.error('Error parsing groupPositions:', e); return []; }
    },
    saveGroupPositions(positions) { localStorage.setItem('groupPositions', JSON.stringify(positions)); },
    getVotingSettings() {
        try { return JSON.parse(localStorage.getItem('votingSettings') || '{"method": "substantialUnanimity", "threshold": 66.67, "allowAbstain": true}'); }
        catch(e) { console.error('Error parsing votingSettings:', e); return {"method": "substantialUnanimity", "threshold": 66.67, "allowAbstain": true}; }
    },
    saveVotingSettings(settings) { localStorage.setItem('votingSettings', JSON.stringify(settings)); },
    getQuorumRules() {
        try { return JSON.parse(localStorage.getItem('quorumRules') || '[]'); }
        catch(e) { console.error('Error parsing quorumRules:', e); return []; }
    },
    saveQuorumRules(rules) { localStorage.setItem('quorumRules', JSON.stringify(rules)); },
    getMeetingMinutes() {
        try { return JSON.parse(localStorage.getItem('meetingMinutes') || '[]'); }
        catch(e) { console.error('Error parsing meetingMinutes:', e); return []; }
    },
    saveMeetingMinutes(minutes) { localStorage.setItem('meetingMinutes', JSON.stringify(minutes)); },
    getInventorySchedules() {
        try { return JSON.parse(localStorage.getItem('inventorySchedules') || '[]'); }
        catch(e) { console.error('Error parsing inventorySchedules:', e); return []; }
    },
    saveInventorySchedules(schedules) { localStorage.setItem('inventorySchedules', JSON.stringify(schedules)); },
    getDecisionImpacts() {
        try { return JSON.parse(localStorage.getItem('decisionImpacts') || '[]'); }
        catch(e) { console.error('Error parsing decisionImpacts:', e); return []; }
    },
    saveDecisionImpacts(impacts) { localStorage.setItem('decisionImpacts', JSON.stringify(impacts)); },
    getParticipationData() {
        try { return JSON.parse(localStorage.getItem('participationData') || '{"votes": [], "attendance": []}'); }
        catch(e) { console.error('Error parsing participationData:', e); return {"votes": [], "attendance": []}; }
    },
    saveParticipationData(data) { localStorage.setItem('participationData', JSON.stringify(data)); },
    getUserRole() {
        try { return localStorage.getItem('userRole') || 'member'; }
        catch(e) { console.error('Error getting userRole:', e); return 'member'; }
    },
    saveUserRole(role) { localStorage.setItem('userRole', role); },
    getEducationalProgress() {
        try { return JSON.parse(localStorage.getItem('educationalProgress') || '{"completed": [], "dismissed": []}'); }
        catch(e) { console.error('Error parsing educationalProgress:', e); return {"completed": [], "dismissed": []}; }
    },
    saveEducationalProgress(progress) { localStorage.setItem('educationalProgress', JSON.stringify(progress)); },
    getPrivacySettings() {
        try { return JSON.parse(localStorage.getItem('privacySettings') || '{"anonymousVoting": false, "hideNamesInExports": false, "encryptSensitive": false, "autoRedactLastNames": false}'); }
        catch(e) { console.error('Error parsing privacySettings:', e); return {"anonymousVoting": false, "hideNamesInExports": false, "encryptSensitive": false, "autoRedactLastNames": false}; }
    },
    savePrivacySettings(settings) { localStorage.setItem('privacySettings', JSON.stringify(settings)); },
    getAccessLevels() {
        try { return JSON.parse(localStorage.getItem('accessLevels') || '{}'); }
        catch(e) { console.error('Error parsing accessLevels:', e); return {}; }
    },
    saveAccessLevels(levels) { localStorage.setItem('accessLevels', JSON.stringify(levels)); },
    getTraditionOfDay() {
        try { return JSON.parse(localStorage.getItem('traditionOfDay') || '{"tradition": 1, "date": ""}'); }
        catch(e) { console.error('Error parsing traditionOfDay:', e); return {"tradition": 1, "date": ""}; }
    },
    saveTraditionOfDay(data) { localStorage.setItem('traditionOfDay', JSON.stringify(data)); },
    getSpiritualPrinciples() {
        try { return JSON.parse(localStorage.getItem('spiritualPrinciples') || '[]'); }
        catch(e) { console.error('Error parsing spiritualPrinciples:', e); return []; }
    },
    saveSpiritualPrinciples(principles) { localStorage.setItem('spiritualPrinciples', JSON.stringify(principles)); },
    getNotifications() {
        try { return JSON.parse(localStorage.getItem('notifications') || '[]'); }
        catch(e) { console.error('Error parsing notifications:', e); return []; }
    },
    saveNotifications(notifications) { localStorage.setItem('notifications', JSON.stringify(notifications)); },
    getUnityChecks() {
        try { return JSON.parse(localStorage.getItem('unityChecks') || '[]'); }
        catch(e) { console.error('Error parsing unityChecks:', e); return []; }
    },
    saveUnityChecks(checks) { localStorage.setItem('unityChecks', JSON.stringify(checks)); },
    getMinorityOpinions() {
        try { return JSON.parse(localStorage.getItem('minorityOpinions') || '[]'); }
        catch(e) { console.error('Error parsing minorityOpinions:', e); return []; }
    },
    saveMinorityOpinions(opinions) { localStorage.setItem('minorityOpinions', JSON.stringify(opinions)); },
    getServiceStructure() {
        try { return JSON.parse(localStorage.getItem('serviceStructure') || '{"group": {}, "district": {}, "area": {}}'); }
        catch(e) { console.error('Error parsing serviceStructure:', e); return {"group": {}, "district": {}, "area": {}}; }
    },
    saveServiceStructure(structure) { localStorage.setItem('serviceStructure', JSON.stringify(structure)); },
    saveBirthdays(birthdays) {
        const existingMembers = this.getMembers();
        birthdays.forEach(b => {
            const existingIndex = existingMembers.findIndex(m => m.id === b.id);
            if (existingIndex >= 0) {
                existingMembers[existingIndex].birthday = b.birthday;
                if (b.phone) existingMembers[existingIndex].phone = b.phone;
                if (b.email) existingMembers[existingIndex].email = b.email;
            } else {
                existingMembers.push({
                    id: b.id || genId(),
                    name: b.name,
                    birthday: b.birthday,
                    phone: b.phone || '',
                    email: b.email || '',
                    homegroup: 'Yes',
                    sponsor: '',
                    city: '',
                    isServant: false,
                    servantPosition: '',
                    servantSince: ''
                });
            }
        });
        this.saveMembers(existingMembers);
    },
    getStandingAgendaItems() {
        try { return JSON.parse(localStorage.getItem('standingAgendaItems') || '[]'); }
        catch(e) { console.error('Error parsing standingAgendaItems:', e); return []; }
    },
    saveStandingAgendaItems(items) { localStorage.setItem('standingAgendaItems', JSON.stringify(items)); },
    getTabledMotions() {
        try { return JSON.parse(localStorage.getItem('tabledMotions') || '[]'); }
        catch(e) { console.error('Error parsing tabledMotions:', e); return []; }
    },
    saveTabledMotions(motions) { localStorage.setItem('tabledMotions', JSON.stringify(motions)); },
    getMotionAmendments() {
        try { return JSON.parse(localStorage.getItem('motionAmendments') || '{}'); }
        catch(e) { console.error('Error parsing motionAmendments:', e); return {}; }
    },
    saveMotionAmendments(amendments) { localStorage.setItem('motionAmendments', JSON.stringify(amendments)); },
    getDiscussionThreads() {
        try { return JSON.parse(localStorage.getItem('discussionThreads') || '{}'); }
        catch(e) { console.error('Error parsing discussionThreads:', e); return {}; }
    },
    saveDiscussionThreads(threads) { localStorage.setItem('discussionThreads', JSON.stringify(threads)); },
    getEmailSettings() {
        try { return JSON.parse(localStorage.getItem('emailSettings') || '{"fromAddress": "", "fromName": "", "recipientList": ""}'); }
        catch(e) { console.error('Error parsing emailSettings:', e); return {"fromAddress": "", "fromName": "", "recipientList": ""}; }
    },
    saveEmailSettings(settings) { localStorage.setItem('emailSettings', JSON.stringify(settings)); },
    getEmailHistory() {
        try { return JSON.parse(localStorage.getItem('emailHistory') || '[]'); }
        catch(e) { console.error('Error parsing emailHistory:', e); return []; }
    },
    saveEmailHistory(history) { localStorage.setItem('emailHistory', JSON.stringify(history)); },
    getMemberVotingRecords() {
        try { return JSON.parse(localStorage.getItem('memberVotingRecords') || '{}'); }
        catch(e) { console.error('Error parsing memberVotingRecords:', e); return {}; }
    },
    saveMemberVotingRecords(records) { localStorage.setItem('memberVotingRecords', JSON.stringify(records)); },
    getImplementationTracking() {
        try { return JSON.parse(localStorage.getItem('implementationTracking') || '[]'); }
        catch(e) { console.error('Error parsing implementationTracking:', e); return []; }
    },
    saveImplementationTracking(tracking) { localStorage.setItem('implementationTracking', JSON.stringify(tracking)); },
    getConsentAgendaItems() {
        try { return JSON.parse(localStorage.getItem('consentAgendaItems') || '[]'); }
        catch(e) { console.error('Error parsing consentAgendaItems:', e); return []; }
    },
    saveConsentAgendaItems(items) { localStorage.setItem('consentAgendaItems', JSON.stringify(items)); },
    getConsentHistory() {
        try { return JSON.parse(localStorage.getItem('consentHistory') || '[]'); }
        catch(e) { console.error('Error parsing consentHistory:', e); return []; }
    },
    saveConsentHistory(history) { localStorage.setItem('consentHistory', JSON.stringify(history)); },
    getReconsiderationRequests() {
        try { return JSON.parse(localStorage.getItem('reconsiderationRequests') || '[]'); }
        catch(e) { console.error('Error parsing reconsiderationRequests:', e); return []; }
    },
    saveReconsiderationRequests(requests) { localStorage.setItem('reconsiderationRequests', JSON.stringify(requests)); },
    getCalendarEvents() {
        try { return JSON.parse(localStorage.getItem('calendarEvents') || '[]'); }
        catch(e) { console.error('Error parsing calendarEvents:', e); return []; }
    },
    saveCalendarEvents(events) { localStorage.setItem('calendarEvents', JSON.stringify(events)); },
    getROICalculations() {
        try { return JSON.parse(localStorage.getItem('roiCalculations') || '[]'); }
        catch(e) { console.error('Error parsing roiCalculations:', e); return []; }
    },
    saveROICalculations(calculations) { localStorage.setItem('roiCalculations', JSON.stringify(calculations)); },
    getProxyVotes() {
        try { return JSON.parse(localStorage.getItem('proxyVotes') || '[]'); }
        catch(e) { console.error('Error parsing proxyVotes:', e); return []; }
    },
    saveProxyVotes(proxies) { localStorage.setItem('proxyVotes', JSON.stringify(proxies)); },
    getDecisionReversals() {
        try { return JSON.parse(localStorage.getItem('decisionReversals') || '[]'); }
        catch(e) { console.error('Error parsing decisionReversals:', e); return []; }
    },
    saveDecisionReversals(reversals) { localStorage.setItem('decisionReversals', JSON.stringify(reversals)); },
    getAreaMotions() {
        try { return JSON.parse(localStorage.getItem('areaMotions') || '[]'); }
        catch(e) { console.error('Error parsing areaMotions:', e); return []; }
    },
    saveAreaMotions(motions) { localStorage.setItem('areaMotions', JSON.stringify(motions)); },
    getAssemblyAgendas() {
        try { return JSON.parse(localStorage.getItem('assemblyAgendas') || '[]'); }
        catch(e) { console.error('Error parsing assemblyAgendas:', e); return []; }
    },
    saveAssemblyAgendas(agendas) { localStorage.setItem('assemblyAgendas', JSON.stringify(agendas)); },
    getIRMeetings() {
        try { return JSON.parse(localStorage.getItem('irMeetings') || '[]'); }
        catch(e) { console.error('Error parsing irMeetings:', e); return []; }
    },
    saveIRMeetings(meetings) { localStorage.setItem('irMeetings', JSON.stringify(meetings)); },
    getHotlineShifts() {
        try { return JSON.parse(localStorage.getItem('hotlineShifts') || '[]'); }
        catch(e) { console.error('Error parsing hotlineShifts:', e); return []; }
    },
    saveHotlineShifts(shifts) { localStorage.setItem('hotlineShifts', JSON.stringify(shifts)); },
    getSpecialEvents() {
        try { return JSON.parse(localStorage.getItem('specialEvents') || '[]'); }
        catch(e) { console.error('Error parsing specialEvents:', e); return []; }
    },
    saveSpecialEvents(events) { localStorage.setItem('specialEvents', JSON.stringify(events)); },
    getPIActivities() {
        try { return JSON.parse(localStorage.getItem('piActivities') || '[]'); }
        catch(e) { console.error('Error parsing piActivities:', e); return []; }
    },
    savePIActivities(activities) { localStorage.setItem('piActivities', JSON.stringify(activities)); },
    getFacilities() {
        try { return JSON.parse(localStorage.getItem('facilities') || '[]'); }
        catch(e) { console.error('Error parsing facilities:', e); return []; }
    },
    saveFacilities(facilities) { localStorage.setItem('facilities', JSON.stringify(facilities)); },
    getHIPanels() {
        try { return JSON.parse(localStorage.getItem('hiPanels') || '[]'); }
        catch(e) { console.error('Error parsing hiPanels:', e); return []; }
    },
    saveHIPanels(panels) { localStorage.setItem('hiPanels', JSON.stringify(panels)); },
    getMemberCertifications() {
        try { return JSON.parse(localStorage.getItem('memberCertifications') || '[]'); }
        catch(e) { console.error('Error parsing memberCertifications:', e); return []; }
    },
    saveMemberCertifications(certs) { localStorage.setItem('memberCertifications', JSON.stringify(certs)); },
    getProfessionals() {
        try { return JSON.parse(localStorage.getItem('professionals') || '[]'); }
        catch(e) { console.error('Error parsing professionals:', e); return []; }
    },
    saveProfessionals(professionals) { localStorage.setItem('professionals', JSON.stringify(professionals)); },
    getPresentations() {
        try { return JSON.parse(localStorage.getItem('presentations') || '[]'); }
        catch(e) { console.error('Error parsing presentations:', e); return []; }
    },
    savePresentations(presentations) { localStorage.setItem('presentations', JSON.stringify(presentations)); },
    getBTGReferrals() {
        try { return JSON.parse(localStorage.getItem('btgReferrals') || '[]'); }
        catch(e) { console.error('Error parsing btgReferrals:', e); return []; }
    },
    saveBTGReferrals(referrals) { localStorage.setItem('btgReferrals', JSON.stringify(referrals)); },
    getMediaContacts() {
        try { return JSON.parse(localStorage.getItem('mediaContacts') || '[]'); }
        catch(e) { console.error('Error parsing mediaContacts:', e); return []; }
    },
    saveMediaContacts(contacts) { localStorage.setItem('mediaContacts', JSON.stringify(contacts)); },
    getPressReleases() {
        try { return JSON.parse(localStorage.getItem('pressReleases') || '[]'); }
        catch(e) { console.error('Error parsing pressReleases:', e); return []; }
    },
    savePressReleases(releases) { localStorage.setItem('pressReleases', JSON.stringify(releases)); },
    getOutreachEvents() {
        try { return JSON.parse(localStorage.getItem('outreachEvents') || '[]'); }
        catch(e) { console.error('Error parsing outreachEvents:', e); return []; }
    },
    saveOutreachEvents(events) { localStorage.setItem('outreachEvents', JSON.stringify(events)); },
    getOutreachLogs() {
        try { return JSON.parse(localStorage.getItem('outreachLogs') || '[]'); }
        catch(e) { console.error('Error parsing outreachLogs:', e); return []; }
    },
    saveOutreachLogs(logs) { localStorage.setItem('outreachLogs', JSON.stringify(logs)); },
    getTreatmentFacilities() {
        try { return JSON.parse(localStorage.getItem('treatmentFacilities') || '[]'); }
        catch(e) { console.error('Error parsing treatmentFacilities:', e); return []; }
    },
    saveTreatmentFacilities(facilities) { localStorage.setItem('treatmentFacilities', JSON.stringify(facilities)); },
    getBridgingCommitments() {
        try { return JSON.parse(localStorage.getItem('bridgingCommitments') || '[]'); }
        catch(e) { console.error('Error parsing bridgingCommitments:', e); return []; }
    },
    saveBridgingCommitments(commitments) { localStorage.setItem('bridgingCommitments', JSON.stringify(commitments)); },
    getFollowUps() {
        try { return JSON.parse(localStorage.getItem('followUps') || '[]'); }
        catch(e) { console.error('Error parsing followUps:', e); return []; }
    },
    saveFollowUps(followups) { localStorage.setItem('followUps', JSON.stringify(followups)); },
    getCorrectionsFacilities() {
        try { return JSON.parse(localStorage.getItem('correctionsFacilities') || '[]'); }
        catch(e) { console.error('Error parsing correctionsFacilities:', e); return []; }
    },
    saveCorrectionsFacilities(facilities) { localStorage.setItem('correctionsFacilities', JSON.stringify(facilities)); },
    getCorrectionsClearances() {
        try { return JSON.parse(localStorage.getItem('correctionsClearances') || '[]'); }
        catch(e) { console.error('Error parsing correctionsClearances:', e); return []; }
    },
    saveCorrectionsClearances(clearances) { localStorage.setItem('correctionsClearances', JSON.stringify(clearances)); },
    getPreReleaseContacts() {
        try { return JSON.parse(localStorage.getItem('preReleaseContacts') || '[]'); }
        catch(e) { console.error('Error parsing preReleaseContacts:', e); return []; }
    },
    savePreReleaseContacts(contacts) { localStorage.setItem('preReleaseContacts', JSON.stringify(contacts)); },
    getCorrespondenceLog() {
        try { return JSON.parse(localStorage.getItem('correspondenceLog') || '[]'); }
        catch(e) { console.error('Error parsing correspondenceLog:', e); return []; }
    },
    saveCorrespondenceLog(log) { localStorage.setItem('correspondenceLog', JSON.stringify(log)); },
    getEventsMgmt() {
        try { return JSON.parse(localStorage.getItem('eventsMgmt') || '[]'); }
        catch(e) { console.error('Error parsing eventsMgmt:', e); return []; }
    },
    saveEventsMgmt(events) { localStorage.setItem('eventsMgmt', JSON.stringify(events)); },
    getSpeakers() {
        try { return JSON.parse(localStorage.getItem('speakers') || '[]'); }
        catch(e) { console.error('Error parsing speakers:', e); return []; }
    },
    saveSpeakers(speakers) { localStorage.setItem('speakers', JSON.stringify(speakers)); },
    getEventVolunteers() {
        try { return JSON.parse(localStorage.getItem('eventVolunteers') || '[]'); }
        catch(e) { console.error('Error parsing eventVolunteers:', e); return []; }
    },
    saveEventVolunteers(volunteers) { localStorage.setItem('eventVolunteers', JSON.stringify(volunteers)); },
    getEventExpenses() {
        try { return JSON.parse(localStorage.getItem('eventExpenses') || '[]'); }
        catch(e) { console.error('Error parsing eventExpenses:', e); return []; }
    },
    saveEventExpenses(expenses) { localStorage.setItem('eventExpenses', JSON.stringify(expenses)); },
    getTicketSales() {
        try { return JSON.parse(localStorage.getItem('ticketSales') || '[]'); }
        catch(e) { console.error('Error parsing ticketSales:', e); return []; }
    },
    saveTicketSales(sales) { localStorage.setItem('ticketSales', JSON.stringify(sales)); },
    getArchiveDocuments() {
        try { return JSON.parse(localStorage.getItem('archiveDocuments') || '[]'); }
        catch(e) { console.error('Error parsing archiveDocuments:', e); return []; }
    },
    saveArchiveDocuments(documents) { localStorage.setItem('archiveDocuments', JSON.stringify(documents)); },
    getInterviews() {
        try { return JSON.parse(localStorage.getItem('interviews') || '[]'); }
        catch(e) { console.error('Error parsing interviews:', e); return []; }
    },
    saveInterviews(interviews) { localStorage.setItem('interviews', JSON.stringify(interviews)); },
    getTranslators() {
        try { return JSON.parse(localStorage.getItem('translators') || '[]'); }
        catch(e) { console.error('Error parsing translators:', e); return []; }
    },
    saveTranslators(translators) { localStorage.setItem('translators', JSON.stringify(translators)); },
    getLanguageMaterials() {
        try { return JSON.parse(localStorage.getItem('languageMaterials') || '[]'); }
        catch(e) { console.error('Error parsing languageMaterials:', e); return []; }
    },
    saveLanguageMaterials(materials) { localStorage.setItem('languageMaterials', JSON.stringify(materials)); },
    getInterpreters() {
        try { return JSON.parse(localStorage.getItem('interpreters') || '[]'); }
        catch(e) { console.error('Error parsing interpreters:', e); return []; }
    },
    saveInterpreters(interpreters) { localStorage.setItem('interpreters', JSON.stringify(interpreters)); },
    getInterpreterSchedule() {
        try { return JSON.parse(localStorage.getItem('interpreterSchedule') || '[]'); }
        catch(e) { console.error('Error parsing interpreterSchedule:', e); return []; }
    },
    saveInterpreterSchedule(schedule) { localStorage.setItem('interpreterSchedule', JSON.stringify(schedule)); },
    getCaptionSetup() {
        try { return JSON.parse(localStorage.getItem('captionSetup') || '{}'); }
        catch(e) { console.error('Error parsing captionSetup:', e); return {}; }
    },
    saveCaptionSetup(setup) { localStorage.setItem('captionSetup', JSON.stringify(setup)); },

    getChairRulings() {
        try { return JSON.parse(localStorage.getItem('chairRulings') || '[]'); }
        catch(e) { console.error('Error parsing chairRulings:', e); return []; }
    },
    saveChairRulings(rulings) { localStorage.setItem('chairRulings', JSON.stringify(rulings)); },
    getRulesSuspensions() {
        try { return JSON.parse(localStorage.getItem('rulesSuspensions') || '[]'); }
        catch(e) { console.error('Error parsing rulesSuspensions:', e); return []; }
    },
    saveRulesSuspensions(suspensions) { localStorage.setItem('rulesSuspensions', JSON.stringify(suspensions)); },
    getDividedQuestions() {
        try { return JSON.parse(localStorage.getItem('dividedQuestions') || '[]'); }
        catch(e) { console.error('Error parsing dividedQuestions:', e); return []; }
    },
    saveDividedQuestions(questions) { localStorage.setItem('dividedQuestions', JSON.stringify(questions)); },
    getParliamentaryInquiries() {
        try { return JSON.parse(localStorage.getItem('parliamentaryInquiries') || '[]'); }
        catch(e) { console.error('Error parsing parliamentaryInquiries:', e); return []; }
    },
    saveParliamentaryInquiries(inquiries) { localStorage.setItem('parliamentaryInquiries', JSON.stringify(inquiries)); }
};
function initDefaults() {
    if (localStorage.getItem('birthdays') && !localStorage.getItem('members')) {
        const oldBirthdays = JSON.parse(localStorage.getItem('birthdays') || '[]');
        const newMembers = oldBirthdays.map(b => ({
            id: b.id,
            name: b.name,
            birthday: b.birthday,
            phone: '',
            email: '',
            homegroup: '',
            sponsor: '',
            city: '',
            isServant: false,
            servantPosition: '',
            servantSince: ''
        }));
        storage.saveMembers(newMembers);
        localStorage.removeItem('birthdays'); // Clean up old data
    }
    if (!localStorage.getItem('events')) {
        storage.saveEvents([]);
    }
    if (!localStorage.getItem('members')) {
        storage.saveMembers([]);
    }
    if (!localStorage.getItem('announcements')) {
        storage.saveAnnouncements([]);
    }
    if (!localStorage.getItem('photos')) {
        storage.savePhotos([]);
    } else {
        const photos = storage.getPhotos();
        if (photos.length > 0 && typeof photos[0] === 'string') {
            const newPhotos = photos.map(p => ({ src: p, tags: [] }));
            storage.savePhotos(newPhotos);
        }
    }
    if (!localStorage.getItem('chairpersonLog')) {
        storage.saveChairpersonLog([]);
    }
    if (!localStorage.getItem('groupConscienceLog')) {
        storage.saveGroupConscienceLog([]);
    }
    if (!localStorage.getItem('liveGCItems')) {
        storage.saveLiveGCItems([]);
    }
    if (!localStorage.getItem('proposedAgendaItems')) {
        storage.saveProposedAgendaItems([]);
    }
    if (!localStorage.getItem('gcComments')) {
        storage.saveGCComments([]);
    }
    if (!localStorage.getItem('gcActionItems')) {
        storage.saveGCActionItems([]);
    }
    if (!localStorage.getItem('gcSettings')) {
        storage.saveGCSettings({ quorumPercentage: 50, quorumMinimum: 5 });
    }
    if (!localStorage.getItem('votingSettings')) {
        storage.saveVotingSettings({ method: 'substantialUnanimity', threshold: 66.67, allowAbstain: true });
    }
    if (!localStorage.getItem('literatureInventory')) {
        storage.saveLiteratureInventory([]);
    }
    if (!localStorage.getItem('literatureLoans')) {
        storage.saveLiteratureLoans([]);
    }
    if (!localStorage.getItem('serviceElections')) {
        storage.saveServiceElections([]);
    }
    if (!localStorage.getItem('electionBallots')) {
        storage.saveElectionBallots([]);
    }
    if (!localStorage.getItem('speakingQueue')) {
        storage.saveSpeakingQueue([]);
    }
    if (!localStorage.getItem('motionTemplates')) {
        const defaultTemplates = [
            {
                id: genId(),
                name: 'Change 7th Tradition Split',
                template: 'Motion to change our 7th Tradition contribution split to [X]% for group expenses, [Y]% for District, [Z]% for Area, and [W]% for GSO.',
                category: 'Finance'
            },
            {
                id: genId(),
                name: 'Approve Service Position',
                template: 'Motion to approve [Name] as [Service Position] for a term of [Duration].',
                category: 'Service'
            },
            {
                id: genId(),
                name: 'Change Meeting Format',
                template: 'Motion to change the meeting format from [Current Format] to [New Format] effective [Date].',
                category: 'Meeting Format'
            },
            {
                id: genId(),
                name: 'Approve Group Inventory',
                template: 'Motion to conduct a group inventory on [Date] using the [12 Traditions/12 Concepts/Custom] format.',
                category: 'Group Health'
            },
            {
                id: genId(),
                name: 'Purchase Literature',
                template: 'Motion to purchase [Quantity] of [Literature Item] at an estimated cost of $[Amount].',
                category: 'Literature'
            },
            {
                id: genId(),
                name: 'Approve Budget',
                template: 'Motion to approve the proposed annual budget of $[Amount] for fiscal year [Year].',
                category: 'Finance'
            }
        ];
        storage.saveMotionTemplates(defaultTemplates);
    }
    if (!localStorage.getItem('traditionChecks')) {
        storage.saveTraditionChecks([]);
    }
    if (!localStorage.getItem('budgetProposals')) {
        storage.saveBudgetProposals([]);
    }
    if (!localStorage.getItem('districtMotions')) {
        storage.saveDistrictMotions([]);
    }
    if (!localStorage.getItem('groupPositions')) {
        const defaultPositions = [
            { id: genId(), title: 'General Service Representative (GSR)', term: 24, minSobriety: 12, description: 'Represents the group at District and Area meetings' },
            { id: genId(), title: 'Alternate GSR', term: 24, minSobriety: 6, description: 'Backs up the GSR' },
            { id: genId(), title: 'Treasurer', term: 24, minSobriety: 12, description: 'Manages group finances' },
            { id: genId(), title: 'Secretary', term: 12, minSobriety: 6, description: 'Takes meeting minutes and attendance' },
            { id: genId(), title: 'Chairperson', term: 12, minSobriety: 6, description: 'Chairs the meeting' },
            { id: genId(), title: 'Literature Coordinator', term: 12, minSobriety: 6, description: 'Manages group literature' },
            { id: genId(), title: 'Coffee/Setup Coordinator', term: 6, minSobriety: 3, description: 'Coordinates coffee and setup duties' }
        ];
        storage.saveGroupPositions(defaultPositions);
    }
    if (!localStorage.getItem('quorumRules')) {
        const defaultRules = [
            { id: genId(), category: 'General Motions', quorumPercent: 50, quorumMin: 5, description: 'Standard group conscience items' },
            { id: genId(), category: 'Financial Decisions', quorumPercent: 60, quorumMin: 7, description: 'Spending over prudent reserve' },
            { id: genId(), category: 'Major Changes', quorumPercent: 66.67, quorumMin: 10, description: 'Format changes, location moves, etc.' }
        ];
        storage.saveQuorumRules(defaultRules);
    }
    if (!localStorage.getItem('meetingMinutes')) {
        storage.saveMeetingMinutes([]);
    }
    if (!localStorage.getItem('inventorySchedules')) {
        storage.saveInventorySchedules([]);
    }
    if (!localStorage.getItem('decisionImpacts')) {
        storage.saveDecisionImpacts([]);
    }
    if (!localStorage.getItem('participationData')) {
        storage.saveParticipationData({ votes: [], attendance: [] });
    }
    if (!localStorage.getItem('userRole')) {
        storage.saveUserRole('member');
    }
    if (!localStorage.getItem('educationalProgress')) {
        storage.saveEducationalProgress({ completed: [], dismissed: [] });
    }
}
function handleEventSubmit() {
    const editId = document.getElementById('event-edit-id').value;
    if (editId) {
        updateEvent();
    } else {
        addEvent();
    }
}
function editEvent(id) {
    const events = storage.getEvents();
    const eventToEdit = events.find(ev => ev.id === id);
    if (!eventToEdit) {
        console.error('Event not found for editing');
        return;
    }
    const form = document.getElementById('add-event-form');
    if (form.style.display === 'none') {
        form.style.display = 'block';
    }
    document.getElementById('event-edit-id').value = eventToEdit.id;
    document.getElementById('event-title').value = eventToEdit.title;
    document.getElementById('event-date').value = eventToEdit.date || '';
    document.getElementById('event-day').value = eventToEdit.dayOfWeek !== null ? eventToEdit.dayOfWeek : '';
    document.getElementById('event-time').value = eventToEdit.time;
    document.getElementById('event-category').value = eventToEdit.category || 'General';
    document.getElementById('event-reading').value = eventToEdit.reading || '';
    document.getElementById('event-speaker').value = eventToEdit.speaker || '';
    document.getElementById('event-chair').value = eventToEdit.chair || '';
    document.getElementById('event-description').value = eventToEdit.description || '';
    document.getElementById('event-form-btn').textContent = 'Save Changes';
    document.getElementById('event-form-cancel-btn').style.display = 'inline-block';
    document.getElementById('schedule-section').scrollIntoView({ behavior: 'smooth' });
}
function cancelEventEdit() {
    document.getElementById('event-edit-id').value = '';
    document.getElementById('event-title').value = '';
    document.getElementById('event-date').value = '';
    document.getElementById('event-day').value = '';
    document.getElementById('event-time').value = '';
    document.getElementById('event-category').value = 'General';
    document.getElementById('event-reading').value = '';
    document.getElementById('event-speaker').value = '';
    document.getElementById('event-chair').value = '';
    document.getElementById('event-description').value = '';
    document.getElementById('event-form-btn').textContent = 'Add Event';
    document.getElementById('event-form-cancel-btn').style.display = 'none';
}
function updateEvent() {
    const id = document.getElementById('event-edit-id').value;
    if (!id) return;
    const title = document.getElementById('event-title').value.trim();
    const dateVal = document.getElementById('event-date').value;
    const dayVal = document.getElementById('event-day').value;
    const time = document.getElementById('event-time').value;
    const category = document.getElementById('event-category').value;
    const reading = document.getElementById('event-reading').value.trim();
    const speaker = document.getElementById('event-speaker').value.trim();
    const chair = document.getElementById('event-chair').value.trim();
    const description = document.getElementById('event-description').value.trim();
    if (!title || !time || (!dateVal && dayVal === '')) {
        showToast('Please provide at least a title, time, and either a date or day of week.', 'error');
        return;
    }
    let events = storage.getEvents();
    const eventIndex = events.findIndex(ev => ev.id === id);
    if (eventIndex > -1) {
        events[eventIndex] = {
            id,
            title,
            date: dateVal || null,
            dayOfWeek: dateVal ? null : parseInt(dayVal, 10),
            time,
            category,
            reading,
            speaker,
            chair,
            description
        };
        storage.saveEvents(events);
        showToast('Event updated successfully!', 'success');
    }
    cancelEventEdit(); // Resets form and buttons
    updateEventsTable();
    updateHome();
    renderCalendar();
}
function addEvent() {
    const title = document.getElementById('event-title').value.trim();
    const dateVal = document.getElementById('event-date').value;
    const dayVal = document.getElementById('event-day').value;
    const time = document.getElementById('event-time').value;
    const category = document.getElementById('event-category').value;
    const reading = document.getElementById('event-reading').value.trim();
    const speaker = document.getElementById('event-speaker').value.trim();
    const chair = document.getElementById('event-chair').value.trim();
    const description = document.getElementById('event-description').value.trim();
    if (!title || !time || (!dateVal && dayVal === '')) {
        showToast('Please provide at least a title, time, and either a date or day of week.', 'error');
        return;
    }
    const events = storage.getEvents();
    events.push({
        id: genId(),
        title,
        date: dateVal || null,
        dayOfWeek: dateVal ? null : parseInt(dayVal, 10),
        time,
        category,
        reading,
        speaker,
        chair,
        description
    });
    storage.saveEvents(events);
    showToast('Event added successfully!', 'success');
    document.getElementById('event-title').value = '';
    document.getElementById('event-date').value = '';
    document.getElementById('event-day').value = '';
    document.getElementById('event-time').value = '';
    document.getElementById('event-reading').value = '';
    document.getElementById('event-speaker').value = '';
    document.getElementById('event-chair').value = '';
    document.getElementById('event-description').value = '';
    updateEventsTable();
    updateHome();
    renderCalendar();
}
function deleteEvent(id) {
    if (!confirm('Delete this event?')) return;
    let events = storage.getEvents();
    events = events.filter(ev => ev.id !== id);
    storage.saveEvents(events);
    showToast('Event deleted.', 'info');
    updateEventsTable();
    updateHome();
    renderCalendar();
}
function computeUpcomingOccurrences(daysAhead = 30) {
    const events = storage.getEvents();
    const now = new Date();
    const end = new Date();
    end.setDate(end.getDate() + daysAhead);
    let occurrences = [];
    events.forEach(ev => {
        if (ev.date) {
            const eventDate = new Date(ev.date + 'T' + (ev.time || '00:00'));
            if (eventDate >= now && eventDate <= end) occurrences.push({ occurDate: eventDate, event: ev });
        } else if (ev.dayOfWeek !== null && ev.dayOfWeek !== undefined) {
            for (let d = 0; d <= daysAhead; d++) {
                const date = new Date(now);
                date.setHours(0, 0, 0, 0);
                date.setDate(date.getDate() + d);
                if (date.getDay() === ev.dayOfWeek) {
                    const timeParts = (ev.time || '00:00').split(':');
                    if (timeParts.length >= 2) {
                        const hours = parseInt(timeParts[0], 10) || 0;
                        const minutes = parseInt(timeParts[1], 10) || 0;
                        date.setHours(hours, minutes, 0, 0);
                    }
                    if (date >= now && date <= end) occurrences.push({ occurDate: new Date(date), event: ev });
                }
            }
        }
    });
    occurrences.sort((a, b) => a.occurDate - b.occurDate);
    return occurrences;
}
function updateEventsTable() {
    const tbody = document.getElementById('events-body');
    const categoryFilter = document.getElementById('category-filter').value;
    tbody.innerHTML = '';
    let occ = computeUpcomingOccurrences(60);
    if (categoryFilter !== 'All') {
        occ = occ.filter(item => (item.event.category || 'General') === categoryFilter);
    }
    occ.forEach(item => {
        const tr = document.createElement('tr');
        const dateStr = item.occurDate.toLocaleDateString();
        const timeStr = item.occurDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        tr.innerHTML = `<td>${escapeHtml(dateStr)}</td><td>${escapeHtml(item.event.title)}</td><td>${escapeHtml(item.event.category || 'General')}</td><td>${escapeHtml(timeStr)}</td><td>${escapeHtml(item.event.speaker || '')}</td><td>${escapeHtml(item.event.chair || '')}</td><td><button class="btn" data-action="edit-event" data-id="${escapeAttribute(item.event.id)}" style="margin-right: 5px;">Edit</button><button class="btn secondary" data-action="delete-event" data-id="${escapeAttribute(item.event.id)}">Delete</button></td>`;
        tbody.appendChild(tr);
    });
    if (occ.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="7">No upcoming events match the filter.</td>';
        tbody.appendChild(tr);
    }
}
function handleMemberSubmit() {
    const editId = document.getElementById('member-edit-id').value;
    if (editId) {
        updateMember();
    } else {
        addMember();
    }
}
function editMember(id) {
    const members = storage.getMembers();
    const memberToEdit = members.find(m => m.id === id);
    if (!memberToEdit) {
        console.error('Member not found for editing');
        return;
    }
    const form = document.getElementById('add-member-form');
    if (form.style.display === 'none') {
        form.style.display = 'block';
    }
    document.getElementById('member-edit-id').value = memberToEdit.id;
    document.getElementById('member-name').value = memberToEdit.name;
    document.getElementById('member-birthday').value = memberToEdit.birthday;
    document.getElementById('member-phone').value = memberToEdit.phone || '';
    document.getElementById('member-email').value = memberToEdit.email || '';
    document.getElementById('member-homegroup').value = memberToEdit.homegroup || '';
    document.getElementById('member-sponsor').value = memberToEdit.sponsor || '';
    document.getElementById('member-city').value = memberToEdit.city || '';
    document.getElementById('member-status').value = memberToEdit.membershipStatus || 'home-group-member';
    document.getElementById('member-is-servant').checked = memberToEdit.isServant || false;
    document.getElementById('member-servant-position').value = memberToEdit.servantPosition || '';
    document.getElementById('member-servant-since').value = memberToEdit.servantSince || '';
    document.getElementById('member-available-sponsor').checked = memberToEdit.availableToSponsor || false;
    document.getElementById('member-gender').value = memberToEdit.gender || '';
    document.getElementById('member-sponsor-preference').value = memberToEdit.sponsorPreference || '';
    document.getElementById('member-form-btn').textContent = 'Save Changes';
    document.getElementById('member-form-cancel-btn').style.display = 'inline-block';
    document.getElementById('birthdays-section').scrollIntoView({ behavior: 'smooth' });
}
function cancelMemberEdit() {
    document.getElementById('member-edit-id').value = '';
    document.getElementById('member-name').value = '';
    document.getElementById('member-birthday').value = '';
    document.getElementById('member-phone').value = '';
    document.getElementById('member-email').value = '';
    document.getElementById('member-homegroup').value = '';
    document.getElementById('member-sponsor').value = '';
    document.getElementById('member-city').value = '';
    document.getElementById('member-status').value = 'home-group-member';
    document.getElementById('member-is-servant').checked = false;
    document.getElementById('member-servant-position').value = '';
    document.getElementById('member-servant-since').value = '';
    document.getElementById('member-available-sponsor').checked = false;
    document.getElementById('member-gender').value = '';
    document.getElementById('member-sponsor-preference').value = '';
    document.getElementById('member-form-btn').textContent = 'Add Member';
    document.getElementById('member-form-cancel-btn').style.display = 'none';
}
function updateMember() {
    const id = document.getElementById('member-edit-id').value;
    if (!id) return;
    const name = document.getElementById('member-name').value.trim();
    const bdate = document.getElementById('member-birthday').value;
    const email = document.getElementById('member-email').value.trim();
    const phone = document.getElementById('member-phone').value.trim();
    if (!name || !bdate) {
        showToast('Please provide both name and sobriety date.', 'error');
        return;
    }
    if (!validateEmail(email)) {
        showToast('Please enter a valid email address (e.g., user@example.com).', 'error');
        return;
    }
    if (!validatePhone(phone)) {
        showToast('Please enter a valid phone number with at least 10 digits.', 'error');
        return;
    }
    let members = storage.getMembers();
    const memberIndex = members.findIndex(m => m.id === id);
    if (memberIndex > -1) {
        members[memberIndex] = {
            id,
            name,
            birthday: bdate,
            phone: phone,
            email: email,
            homegroup: document.getElementById('member-homegroup').value.trim(),
            sponsor: document.getElementById('member-sponsor').value.trim(),
            city: document.getElementById('member-city').value.trim(),
            membershipStatus: document.getElementById('member-status').value || 'home-group-member',
            isServant: document.getElementById('member-is-servant').checked,
            servantPosition: document.getElementById('member-servant-position').value.trim(),
            servantSince: document.getElementById('member-servant-since').value,
            availableToSponsor: document.getElementById('member-available-sponsor').checked,
            gender: document.getElementById('member-gender').value,
            sponsorPreference: document.getElementById('member-sponsor-preference').value
        };
        storage.saveMembers(members);
        showToast('Member updated successfully!', 'success');
    }
    cancelMemberEdit(); // Resets form and buttons
    updateBirthdaysTable();
    updateHome();
    populateAttendeeDropdown();
    populateMemberDropdowns();
    renderServantReportInputs();
}
function addMember() {
    const name = document.getElementById('member-name').value.trim();
    const bdate = document.getElementById('member-birthday').value;
    const email = document.getElementById('member-email').value.trim();
    const phone = document.getElementById('member-phone').value.trim();
    if (!name || !bdate) {
        showToast('Please provide both name and sobriety date.', 'error');
        return;
    }
    if (!validateEmail(email)) {
        showToast('Please enter a valid email address (e.g., user@example.com).', 'error');
        return;
    }
    if (!validatePhone(phone)) {
        showToast('Please enter a valid phone number with at least 10 digits.', 'error');
        return;
    }
    const newMember = {
        id: genId(),
        name,
        birthday: bdate,
        phone: phone,
        email: email,
        homegroup: document.getElementById('member-homegroup').value.trim(),
        sponsor: document.getElementById('member-sponsor').value.trim(),
        city: document.getElementById('member-city').value.trim(),
        membershipStatus: document.getElementById('member-status').value || 'home-group-member',
        isServant: document.getElementById('member-is-servant').checked,
        servantPosition: document.getElementById('member-servant-position').value.trim(),
        servantSince: document.getElementById('member-servant-since').value,
        availableToSponsor: document.getElementById('member-available-sponsor').checked,
        gender: document.getElementById('member-gender').value,
        sponsorPreference: document.getElementById('member-sponsor-preference').value
    };
    const duplicates = checkForDuplicateMembers(newMember);
    if (duplicates.length > 0) {
        const topMatch = duplicates[0];
        const confirmMsg = `⚠️ Possible duplicate member detected!\n\n` +
            `Existing member: ${topMatch.member.name}\n` +
            `Match confidence: ${topMatch.score}%\n` +
            `Reasons: ${topMatch.reasons.join(', ')}\n\n` +
            `Do you want to add this member anyway?`;
        if (!confirm(confirmMsg)) {
            return; // User cancelled
        }
    }
    const members = storage.getMembers();
    members.push(newMember);
    storage.saveMembers(members);
    showToast('Member added successfully!', 'success');
    cancelMemberEdit();
    updateBirthdaysTable();
    updateHome();
    populateAttendeeDropdown();
    populateMemberDropdowns();
    renderServantReportInputs();
}
function deleteMember(id) {
    if (!confirm('Delete this member?')) return;
    let members = storage.getMembers();
    members = members.filter(m => m.id !== id);
    storage.saveMembers(members);
    showToast('Member deleted.', 'info');
    updateBirthdaysTable();
    updateHome();
    populateAttendeeDropdown();
    populateMemberDropdowns();
    renderServantReportInputs();
}
function getAnniversariesInWindow(members, pastDays, futureDays) {
    const now = new Date();
    now.setHours(0,0,0,0);
    const lowerBound = new Date(now);
    lowerBound.setDate(lowerBound.getDate() - pastDays);
    const upperBound = new Date(now);
    upperBound.setDate(upperBound.getDate() + futureDays);
    const relevantMembers = [];
    members.forEach(member => {
        if (!member.birthday) return; // Skip members with no birthday
        const parts = member.birthday.split('-');
        if (parts.length < 3) return; // Invalid date format
        const [origYear, month, day] = parts.map(Number);
        if (isNaN(month) || isNaN(day)) return; // Invalid numbers
        const thisYearAnniversary = new Date(now.getFullYear(), month - 1, day);
        if (thisYearAnniversary >= lowerBound && thisYearAnniversary <= upperBound) {
            relevantMembers.push({ ...member, displayDate: thisYearAnniversary });
            return; // Move to next member, avoid duplicates
        }
        if (now.getFullYear() > origYear) {
             const lastYearAnniversary = new Date(now.getFullYear() - 1, month - 1, day);
             if (lastYearAnniversary >= lowerBound && lastYearAnniversary <= upperBound) {
                relevantMembers.push({ ...member, displayDate: lastYearAnniversary });
                return;
             }
        }
        const nextYearAnniversary = new Date(now.getFullYear() + 1, month - 1, day);
        if (nextYearAnniversary >= lowerBound && nextYearAnniversary <= upperBound) {
            relevantMembers.push({ ...member, displayDate: nextYearAnniversary });
        }
    });
    return relevantMembers.sort((a, b) => a.displayDate - b.displayDate);
}
function calculateSoberTime(bdayStr) {
    if (!bdayStr) return { years: 0, months: 0, days: 0 };
    const soberDate = new Date(bdayStr);
    const now = new Date();
    let years = now.getFullYear() - soberDate.getFullYear();
    let months = now.getMonth() - soberDate.getMonth();
    let days = now.getDate() - soberDate.getDate();
    if (days < 0) {
        months--;
        const lastMonth = new Date(now.getFullYear(), now.getMonth(), 0);
        days += lastMonth.getDate();
    }
    if (months < 0) {
        years--;
        months += 12;
    }
    return { years, months, days };
}
function nextBirthdayDate(bdayStr) {
    const now = new Date();
    const parts = bdayStr.split('-');
    if (parts.length < 3) return null; // Invalid format
    const [year, month, day] = parts.map(Number);
    if (isNaN(year) || isNaN(month) || isNaN(day)) return null; // Invalid numbers
    const today = new Date(now);
    today.setHours(0, 0, 0, 0);
    let nextDate = new Date(today.getFullYear(), month - 1, day);
    if (nextDate < today) {
        nextDate = new Date(today.getFullYear() + 1, month - 1, day);
    }
    return nextDate;
}
function updateBirthdaysTable() {
    const tbody = document.getElementById('birthdays-body');
    tbody.innerHTML = '';
    const members = storage.getMembers();
    const membersInWindow = getAnniversariesInWindow(members, 15, 60);
    const now = new Date();
    now.setHours(0,0,0,0);
    membersInWindow.forEach(m => {
        const tr = document.createElement('tr');
        if (m.displayDate < now) {
            tr.style.backgroundColor = '#6b5d2f';
        }
        const displayDateStr = m.displayDate.toLocaleDateString();
        const origDate = new Date(m.birthday);
        const md = origDate.toLocaleDateString(undefined, { month: 'long', day: 'numeric', year: 'numeric' });
        const years = m.displayDate.getFullYear() - origDate.getFullYear();
        const soberTime = calculateSoberTime(m.birthday);
        const soberTimeStr = `${soberTime.years}y ${soberTime.months}m ${soberTime.days}d`;
        const statusLabels = {
            'home-group-member': '<span style="background: #27ae60; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Home Group</span>',
            'regular-attendee': '<span style="background: #3498db; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Regular</span>',
            'guest': '<span style="background: #95a5a6; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Guest</span>',
            'newcomer': '<span style="background: #e74c3c; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Newcomer</span>'
        };
        const statusBadge = statusLabels[m.membershipStatus] || statusLabels['home-group-member'];
        tr.innerHTML = `
            <td>${escapeHtml(m.name)}</td>
            <td>${escapeHtml(md)}</td>
            <td>${escapeHtml(displayDateStr)}</td>
            <td>${escapeHtml(String(years))}</td>
            <td>${escapeHtml(soberTimeStr)}</td>
            <td>${statusBadge}</td>
            <td>
                <button class="btn" data-action="edit-member" data-id="${escapeAttribute(m.id)}" style="margin-right: 5px;">Edit</button>
                <button class="btn secondary" data-action="delete-member" data-id="${escapeAttribute(m.id)}">Delete</button>
            </td>`;
        tbody.appendChild(tr);
    });
    if (membersInWindow.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="7">No recent or upcoming birthdays in the next 60 days.</td>';
        tbody.appendChild(tr);
    }
}
function generatePhoneList() {
    const members = storage.getMembers();
    if (members.length === 0) {
        showToast('No members to generate phone list.', 'error');
        return;
    }
    const sortedMembers = members.sort((a, b) => a.name.localeCompare(b.name));

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.setFontSize(18);
    doc.setFont(undefined, 'bold');
    doc.text('HomeGroup Phone List', doc.internal.pageSize.width / 2, 20, { align: 'center' });

    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text(`Generated: ${new Date().toLocaleDateString()}`, doc.internal.pageSize.width / 2, 28, { align: 'center' });

    const tableData = [];
    const statusLabels = {
        'home-group-member': 'Home Group',
        'regular-attendee': 'Regular',
        'guest': 'Guest',
        'newcomer': 'Newcomer'
    };

    sortedMembers.forEach(m => {
        const status = statusLabels[m.membershipStatus] || 'Home Group';
        tableData.push([
            m.name || '',
            m.phone || 'No phone',
            m.email || '',
            status
        ]);
    });

    doc.autoTable({
        head: [['Name', 'Phone', 'Email', 'Status']],
        body: tableData,
        startY: 35,
        theme: 'grid',
        styles: { fontSize: 9 },
        headStyles: { fillColor: [52, 152, 219] },
        alternateRowStyles: { fillColor: [245, 245, 245] },
        margin: { top: 35, left: 14, right: 14 }
    });

    const pageCount = doc.internal.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(150);
        doc.text(
            'Anonymity is the spiritual foundation of all our traditions. Please keep this list confidential.',
            doc.internal.pageSize.width / 2,
            doc.internal.pageSize.height - 10,
            { align: 'center' }
        );
    }

    doc.save('HomeGroup-Phone-List-' + new Date().toISOString().split('T')[0] + '.pdf');
    showToast('Phone list generated successfully!', 'success');
}
function updateNewcomersList() {
    const members = storage.getMembers();
    const newcomers = members.filter(m => m.membershipStatus === 'newcomer');
    const newcomersList = document.getElementById('newcomers-list');

    if (!newcomersList) return;

    newcomersList.innerHTML = '';

    if (newcomers.length === 0) {
        newcomersList.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #95a5a6;">No active newcomers. Mark members as "Newcomer" in the Member Roster.</p>';
        return;
    }

    newcomers.forEach(newcomer => {
        const attendance = getNewcomerAttendance(newcomer.id);
        const progress = calculate90in90Progress(newcomer.id, newcomer.birthday);

        const card = document.createElement('div');
        card.className = 'box';
        card.style.cssText = 'padding: 1rem; border-left: 4px solid #e74c3c;';

        let progressColor = '#e74c3c';
        if (progress.percentage >= 75) progressColor = '#27ae60';
        else if (progress.percentage >= 50) progressColor = '#f39c12';

        card.innerHTML = `
            <h4 style="margin-bottom: 0.5rem;"><i class="fas fa-user"></i> ${escapeHtml(newcomer.name)}</h4>
            <p style="font-size: 0.85rem; color: #95a5a6; margin-bottom: 0.5rem;">
                Sobriety Date: ${new Date(newcomer.birthday).toLocaleDateString()}
            </p>
            <div style="margin-bottom: 0.5rem;">
                <div style="display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 0.25rem;">
                    <span>90-in-90 Progress</span>
                    <span style="font-weight: bold;">${progress.meetingsLogged} / 90 meetings</span>
                </div>
                <div style="width: 100%; background: #34495e; border-radius: 4px; height: 20px; overflow: hidden;">
                    <div style="width: ${progress.percentage}%; background: ${progressColor}; height: 100%; transition: width 0.3s;"></div>
                </div>
            </div>
            <p style="font-size: 0.8rem; color: #95a5a6;">
                <i class="fas fa-calendar"></i> Days since first meeting: ${progress.daysSinceStart}<br>
                <i class="fas fa-clock"></i> Days remaining: ${Math.max(0, 90 - progress.daysSinceStart)}
            </p>
            ${progress.percentage >= 100 ? '<p style="color: #27ae60; font-weight: bold; margin-top: 0.5rem;"><i class="fas fa-trophy"></i> 90-in-90 Complete!</p>' : ''}
        `;

        newcomersList.appendChild(card);
    });
}
function populateNewcomerDropdowns() {
    const members = storage.getMembers();
    const newcomers = members.filter(m => m.membershipStatus === 'newcomer');

    const select1 = document.getElementById('newcomer-select');
    const select2 = document.getElementById('history-newcomer-select');

    if (select1) {
        select1.innerHTML = '<option value="">-- Select a newcomer --</option>';
        newcomers.forEach(n => {
            const option = document.createElement('option');
            option.value = n.id;
            option.textContent = n.name;
            select1.appendChild(option);
        });
    }

    if (select2) {
        select2.innerHTML = '<option value="">-- Select a newcomer --</option>';
        newcomers.forEach(n => {
            const option = document.createElement('option');
            option.value = n.id;
            option.textContent = n.name;
            select2.appendChild(option);
        });
    }
}
function getNewcomerAttendance(memberId) {
    const key = `newcomerAttendance_${memberId}`;
    const data = localStorage.getItem(key);
    return data ? JSON.parse(data) : [];
}
function saveNewcomerAttendance(memberId, attendance) {
    const key = `newcomerAttendance_${memberId}`;
    localStorage.setItem(key, JSON.stringify(attendance));
}
function logNewcomerAttendance() {
    const newcomerId = document.getElementById('newcomer-select').value;
    const meetingDate = document.getElementById('meeting-date').value;

    if (!newcomerId) {
        showToast('Please select a newcomer.', 'error');
        return;
    }

    if (!meetingDate) {
        showToast('Please select a meeting date.', 'error');
        return;
    }

    const attendance = getNewcomerAttendance(newcomerId);

    if (attendance.some(a => a.date === meetingDate)) {
        showToast('Attendance already logged for this date.', 'error');
        return;
    }

    attendance.push({
        date: meetingDate,
        loggedAt: new Date().toISOString()
    });

    attendance.sort((a, b) => new Date(a.date) - new Date(b.date));

    saveNewcomerAttendance(newcomerId, attendance);

    document.getElementById('meeting-date').value = '';

    showToast('Attendance logged successfully!', 'success');
    updateNewcomersList();
}
function calculate90in90Progress(memberId, sobrietyDate) {
    const attendance = getNewcomerAttendance(memberId);
    const startDate = new Date(sobrietyDate);
    const today = new Date();

    const daysSinceStart = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
    const meetingsLogged = attendance.length;
    const percentage = Math.min(100, Math.round((meetingsLogged / 90) * 100));

    return {
        daysSinceStart,
        meetingsLogged,
        percentage,
        targetDays: 90,
        targetMeetings: 90
    };
}
function showNewcomerHistory() {
    const newcomerId = document.getElementById('history-newcomer-select').value;
    const display = document.getElementById('newcomer-history-display');

    if (!display) return;

    if (!newcomerId) {
        display.innerHTML = '';
        return;
    }

    const members = storage.getMembers();
    const newcomer = members.find(m => m.id === newcomerId);

    if (!newcomer) {
        display.innerHTML = '<p style="color: #e74c3c;">Newcomer not found.</p>';
        return;
    }

    const attendance = getNewcomerAttendance(newcomerId);
    const progress = calculate90in90Progress(newcomerId, newcomer.birthday);

    let html = `
        <div class="box" style="margin-top: 1rem; background: #2c3e50; border-left: 4px solid #e74c3c;">
            <h4>${escapeHtml(newcomer.name)}'s Progress</h4>
            <p style="margin-top: 0.5rem;">
                <strong>Meetings Logged:</strong> ${progress.meetingsLogged} / 90<br>
                <strong>Days Since First Meeting:</strong> ${progress.daysSinceStart}<br>
                <strong>Progress:</strong> ${progress.percentage}%
            </p>
        </div>
    `;

    if (attendance.length > 0) {
        html += '<table style="margin-top: 1rem; width: 100%;"><thead><tr><th>Meeting Date</th><th>Logged At</th><th>Actions</th></tr></thead><tbody>';

        attendance.forEach((entry, index) => {
            html += `
                <tr>
                    <td>${new Date(entry.date).toLocaleDateString()}</td>
                    <td>${new Date(entry.loggedAt).toLocaleDateString()}</td>
                    <td><button class="btn secondary" onclick="deleteNewcomerAttendance('${newcomerId}', '${entry.date}')">Delete</button></td>
                </tr>
            `;
        });

        html += '</tbody></table>';
    } else {
        html += '<p style="margin-top: 1rem; color: #95a5a6;">No attendance logged yet.</p>';
    }

    display.innerHTML = html;
}
function deleteNewcomerAttendance(memberId, date) {
    if (!confirm('Delete this attendance entry?')) return;

    let attendance = getNewcomerAttendance(memberId);
    attendance = attendance.filter(a => a.date !== date);
    saveNewcomerAttendance(memberId, attendance);

    showToast('Attendance entry deleted.', 'info');
    updateNewcomersList();
    showNewcomerHistory();
}
function updateAvailableSponsors() {
    const members = storage.getMembers();
    const sponsors = members.filter(m => m.availableToSponsor === true);

    const genderFilter = document.getElementById('filter-sponsor-gender')?.value || '';
    const minYears = parseInt(document.getElementById('filter-min-years')?.value || '0');

    const filteredSponsors = sponsors.filter(sponsor => {
        if (genderFilter && sponsor.gender !== genderFilter) {
            return false;
        }

        const soberTime = calculateSoberTime(sponsor.birthday);
        if (soberTime.years < minYears) {
            return false;
        }

        return true;
    });

    filteredSponsors.sort((a, b) => {
        const aTime = calculateSoberTime(a.birthday);
        const bTime = calculateSoberTime(b.birthday);
        return bTime.years - aTime.years;
    });

    const sponsorsList = document.getElementById('sponsors-list');
    const sponsorCount = document.getElementById('sponsor-count');

    if (!sponsorsList) return;

    if (sponsorCount) {
        sponsorCount.textContent = filteredSponsors.length;
    }

    sponsorsList.innerHTML = '';

    if (filteredSponsors.length === 0) {
        sponsorsList.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #95a5a6;">No available sponsors match your filters.</p>';
        return;
    }

    filteredSponsors.forEach(sponsor => {
        const soberTime = calculateSoberTime(sponsor.birthday);
        const genderLabel = sponsor.gender ? (sponsor.gender.charAt(0).toUpperCase() + sponsor.gender.slice(1)) : 'Not specified';

        const card = document.createElement('div');
        card.className = 'box';
        card.style.cssText = 'padding: 1rem; border-left: 4px solid #9b59b6;';

        card.innerHTML = `
            <h4 style="margin-bottom: 0.5rem;"><i class="fas fa-user-tie"></i> ${escapeHtml(sponsor.name)}</h4>
            <div style="font-size: 0.85rem; color: #95a5a6; margin-bottom: 0.75rem;">
                <p style="margin-bottom: 0.25rem;"><i class="fas fa-venus-mars"></i> <strong>Gender:</strong> ${escapeHtml(genderLabel)}</p>
                <p style="margin-bottom: 0.25rem;"><i class="fas fa-calendar-check"></i> <strong>Sobriety:</strong> ${soberTime.years} years, ${soberTime.months} months</p>
                ${sponsor.homegroup ? `<p style="margin-bottom: 0.25rem;"><i class="fas fa-home"></i> <strong>Home Group:</strong> ${escapeHtml(sponsor.homegroup)}</p>` : ''}
            </div>
            <div style="border-top: 1px solid #7f8c8d; padding-top: 0.5rem; margin-top: 0.5rem;">
                <p style="font-size: 0.85rem; margin-bottom: 0.25rem;"><i class="fas fa-phone"></i> ${escapeHtml(sponsor.phone || 'No phone listed')}</p>
                ${sponsor.email ? `<p style="font-size: 0.85rem;"><i class="fas fa-envelope"></i> ${escapeHtml(sponsor.email)}</p>` : ''}
            </div>
        `;

        sponsorsList.appendChild(card);
    });
}
function submitTopicSuggestion() {
    const title = document.getElementById('topic-title').value.trim();
    if (!title) {
        showToast('Please enter a topic title.', 'error');
        return;
    }
    const topics = JSON.parse(localStorage.getItem('topicSuggestions') || '[]');
    topics.push({
        id: genId(),
        title,
        description: document.getElementById('topic-description').value.trim(),
        category: document.getElementById('topic-category').value,
        submittedAt: new Date().toISOString(),
        votes: 0,
        voters: []
    });
    localStorage.setItem('topicSuggestions', JSON.stringify(topics));
    document.getElementById('topic-title').value = '';
    document.getElementById('topic-description').value = '';
    showToast('Topic suggestion submitted!', 'success');
    updateTopicsList();
}
function updateTopicsList() {
    const topics = JSON.parse(localStorage.getItem('topicSuggestions') || '[]');
    const list = document.getElementById('topics-list');
    if (!list) return;
    list.innerHTML = '';
    if (topics.length === 0) {
        list.innerHTML = '<p style="text-align: center; color: #95a5a6;">No topic suggestions yet. Be the first to suggest one!</p>';
        return;
    }
    topics.sort((a, b) => b.votes - a.votes);
    topics.forEach(topic => {
        const card = document.createElement('div');
        card.className = 'box';
        card.style.marginBottom = '1rem';
        const categoryColors = {
            'steps': '#3498db', 'traditions': '#e74c3c', 'big-book': '#2ecc71',
            'recovery': '#9b59b6', 'sponsorship': '#f39c12', 'service': '#1abc9c', 'other': '#95a5a6'
        };
        card.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div style="flex: 1;">
                    <h4>${escapeHtml(topic.title)}</h4>
                    <span style="background: ${categoryColors[topic.category]}; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; margin-top: 0.5rem; display: inline-block;">${escapeHtml(topic.category)}</span>
                    ${topic.description ? `<p style="margin-top: 0.5rem; color: #95a5a6;">${escapeHtml(topic.description)}</p>` : ''}
                    <p style="font-size: 0.85rem; color: #7f8c8d; margin-top: 0.5rem;">Submitted: ${new Date(topic.submittedAt).toLocaleDateString()}</p>
                </div>
                <div style="text-align: center; margin-left: 1rem;">
                    <button class="btn" onclick="voteForTopic('${topic.id}')" style="padding: 0.5rem 1rem;"><i class="fas fa-thumbs-up"></i> ${topic.votes}</button>
                </div>
            </div>
        `;
        list.appendChild(card);
    });
}
function voteForTopic(topicId) {
    const topics = JSON.parse(localStorage.getItem('topicSuggestions') || '[]');
    const topic = topics.find(t => t.id === topicId);
    if (topic) {
        topic.votes = (topic.votes || 0) + 1;
        localStorage.setItem('topicSuggestions', JSON.stringify(topics));
        showToast('Vote recorded!', 'success');
        updateTopicsList();
    }
}
function updateCallRosterAvailability() {
    const available = document.getElementById('call-available').checked;
    const prefs = document.getElementById('call-time-preference');
    const contact = document.getElementById('call-preferred-contact');
    if (prefs && contact) {
        prefs.disabled = !available;
        contact.disabled = !available;
    }
}
function saveCallRosterPreferences() {
    const currentUser = storage.getCurrentUser();
    if (!currentUser || !currentUser.id) {
        showToast('Please set up your user profile first.', 'error');
        return;
    }
    const roster = JSON.parse(localStorage.getItem('callRoster') || '{}');
    if (document.getElementById('call-available').checked) {
        roster[currentUser.id] = {
            timePreference: document.getElementById('call-time-preference').value,
            contactMethod: document.getElementById('call-preferred-contact').value,
            updatedAt: new Date().toISOString()
        };
    } else {
        delete roster[currentUser.id];
    }
    localStorage.setItem('callRoster', JSON.stringify(roster));
    showToast('Call roster preferences saved!', 'success');
    updateCallRosterList();
}
function updateCallRosterList() {
    const roster = JSON.parse(localStorage.getItem('callRoster') || '{}');
    const members = storage.getMembers();
    const list = document.getElementById('call-roster-list');
    const count = document.getElementById('call-roster-count');
    if (!list) return;
    const availableMembers = members.filter(m => roster[m.id]);
    if (count) count.textContent = availableMembers.length;
    list.innerHTML = '';
    if (availableMembers.length === 0) {
        list.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #95a5a6;">No members currently available for 12-step calls.</p>';
        return;
    }
    availableMembers.forEach(member => {
        const prefs = roster[member.id];
        const card = document.createElement('div');
        card.className = 'box';
        card.style.cssText = 'padding: 1rem; border-left: 4px solid #c0392b;';
        const timeLabels = {
            'anytime': '24/7', 'daytime': 'Daytime', 'evening': 'Evening', 'weekends': 'Weekends'
        };
        card.innerHTML = `
            <h4 style="margin-bottom: 0.5rem;"><i class="fas fa-phone"></i> ${escapeHtml(member.name)}</h4>
            <p style="font-size: 0.85rem; color: #95a5a6; margin-bottom: 0.5rem;">
                <strong>Available:</strong> ${timeLabels[prefs.timePreference] || prefs.timePreference}<br>
                <strong>Contact:</strong> ${escapeHtml(prefs.contactMethod)}
            </p>
            <div style="border-top: 1px solid #7f8c8d; padding-top: 0.5rem; margin-top: 0.5rem;">
                <p style="font-size: 0.85rem;"><i class="fas fa-mobile-alt"></i> ${escapeHtml(member.phone || 'No phone')}</p>
            </div>
        `;
        list.appendChild(card);
    });
}
function loadDailyReflection() {
    const today = new Date();
    const dateStr = today.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    const dateEl = document.getElementById('daily-reflection-date');
    const contentEl = document.getElementById('daily-reflection-content');
    if (dateEl) dateEl.textContent = dateStr;
    const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / 86400000);
    const reflections = [
        { title: 'One Day at a Time', text: 'Just for today, I will try to live through this day only, and not tackle all my problems at once. I can do something for twelve hours that would appall me if I felt that I had to keep it up for a lifetime.' },
        { title: 'Acceptance', text: 'And acceptance is the answer to all my problems today. When I am disturbed, it is because I find some person, place, thing, or situation unacceptable to me.' },
        { title: 'Gratitude', text: 'We absolutely insist on enjoying life. We try not to indulge in cynicism over the state of the nations, nor do we carry the world\'s troubles on our shoulders.' },
        { title: 'Higher Power', text: 'We came to believe that a Power greater than ourselves could restore us to sanity. This is the cornerstone of recovery - finding faith in something beyond ourselves.' }
    ];
    const reflection = reflections[dayOfYear % reflections.length];
    if (contentEl) {
        contentEl.innerHTML = `
            <h4 style="color: white; font-size: 1.25rem; margin-bottom: 0.75rem;">${reflection.title}</h4>
            <p style="line-height: 1.6; font-size: 1rem;">${reflection.text}</p>
        `;
    }
    const notesEl = document.getElementById('reflection-notes');
    const savedNotes = localStorage.getItem(`reflection_${today.toISOString().split('T')[0]}`);
    if (notesEl && savedNotes) {
        notesEl.value = savedNotes;
    }
}
function saveReflectionNotes() {
    const today = new Date().toISOString().split('T')[0];
    const notes = document.getElementById('reflection-notes').value;
    localStorage.setItem(`reflection_${today}`, notes);
    showToast('Reflection notes saved!', 'success');
}
function viewReflectionHistory() {
    alert('Reflection history feature - implementation complete in full version.');
}
function updateStepProgress() {
    const stepNum = document.getElementById('step-select').value;
    const status = document.getElementById('step-status').value;
    const notes = document.getElementById('step-notes').value.trim();
    const progress = JSON.parse(localStorage.getItem('stepProgress') || '{}');
    progress[stepNum] = { status, notes, updatedAt: new Date().toISOString() };
    localStorage.setItem('stepProgress', JSON.stringify(progress));
    document.getElementById('step-notes').value = '';
    showToast(`Step ${stepNum} progress updated!`, 'success');
    displayStepProgress();
}
function displayStepProgress() {
    const progress = JSON.parse(localStorage.getItem('stepProgress') || '{}');
    const display = document.getElementById('step-progress-display');
    if (!display) return;
    const steps = [
        'Admitted powerlessness', 'Came to believe', 'Made a decision', 'Moral inventory',
        'Admitted wrongs', 'Ready to remove defects', 'Asked God to remove defects', 'Made a list',
        'Made amends', 'Continued inventory', 'Prayer and meditation', 'Spiritual awakening'
    ];
    let html = '<div class="grid" style="grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem;">';
    for (let i = 1; i <= 12; i++) {
        const stepData = progress[i] || { status: 'not-started' };
        const statusColors = {
            'not-started': '#95a5a6', 'in-progress': '#f39c12',
            'completed': '#27ae60', 'practicing': '#3498db'
        };
        const statusLabels = {
            'not-started': 'Not Started', 'in-progress': 'In Progress',
            'completed': 'Completed', 'practicing': 'Practicing'
        };
        html += `
            <div class="box" style="border-left: 4px solid ${statusColors[stepData.status]};">
                <h4>Step ${i}</h4>
                <p style="font-size: 0.85rem; color: #95a5a6; margin: 0.5rem 0;">${steps[i-1]}</p>
                <span style="background: ${statusColors[stepData.status]}; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">${statusLabels[stepData.status]}</span>
            </div>
        `;
    }
    html += '</div>';
    display.innerHTML = html;
}
function postServiceOpportunity() {
    const task = document.getElementById('service-task').value.trim();
    if (!task) {
        showToast('Please enter a service task.', 'error');
        return;
    }
    const opportunities = JSON.parse(localStorage.getItem('serviceOpportunities') || '[]');
    opportunities.push({
        id: genId(),
        task,
        description: document.getElementById('service-description').value.trim(),
        date: document.getElementById('service-date').value,
        postedAt: new Date().toISOString(),
        claimed: false
    });
    localStorage.setItem('serviceOpportunities', JSON.stringify(opportunities));
    document.getElementById('service-task').value = '';
    document.getElementById('service-description').value = '';
    document.getElementById('service-date').value = '';
    showToast('Service opportunity posted!', 'success');
    updateServiceOpportunitiesList();
}
function claimServiceOpportunity(id) {
    const opportunities = JSON.parse(localStorage.getItem('serviceOpportunities') || '[]');
    const opp = opportunities.find(o => o.id === id);
    if (opp) {
        opp.claimed = true;
        opp.claimedAt = new Date().toISOString();
        localStorage.setItem('serviceOpportunities', JSON.stringify(opportunities));
        showToast('Thank you for your service!', 'success');
        updateServiceOpportunitiesList();
    }
}
function updateServiceOpportunitiesList() {
    const opportunities = JSON.parse(localStorage.getItem('serviceOpportunities') || '[]');
    const list = document.getElementById('service-opportunities-list');
    if (!list) return;
    const unclaimed = opportunities.filter(o => !o.claimed);
    list.innerHTML = '';
    if (unclaimed.length === 0) {
        list.innerHTML = '<p style="text-align: center; color: #95a5a6;">No service opportunities available. Post one above!</p>';
        return;
    }
    unclaimed.forEach(opp => {
        const card = document.createElement('div');
        card.className = 'box';
        card.style.marginBottom = '1rem';
        card.innerHTML = `
            <h4>${escapeHtml(opp.task)}</h4>
            ${opp.description ? `<p style="color: #95a5a6; margin: 0.5rem 0;">${escapeHtml(opp.description)}</p>` : ''}
            ${opp.date ? `<p style="font-size: 0.85rem;"><i class="fas fa-calendar"></i> ${new Date(opp.date).toLocaleDateString()}</p>` : ''}
            <button class="btn" onclick="claimServiceOpportunity('${opp.id}')" style="margin-top: 0.5rem;"><i class="fas fa-hand-paper"></i> I'll Do This</button>
        `;
        list.appendChild(card);
    });
}
function submitTemperatureCheck() {
    const health = document.querySelector('input[name="overall-health"]:checked');
    const welcome = document.querySelector('input[name="feel-welcome"]:checked');
    const traditions = document.querySelector('input[name="follows-traditions"]:checked');
    if (!health || !welcome || !traditions) {
        showToast('Please answer all questions.', 'error');
        return;
    }
    const responses = JSON.parse(localStorage.getItem('temperatureChecks') || '[]');
    responses.push({
        id: genId(),
        overallHealth: parseInt(health.value),
        feelWelcome: parseInt(welcome.value),
        followsTraditions: parseInt(traditions.value),
        comments: document.getElementById('temp-check-comments').value.trim(),
        submittedAt: new Date().toISOString()
    });
    localStorage.setItem('temperatureChecks', JSON.stringify(responses));
    document.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false);
    document.getElementById('temp-check-comments').value = '';
    showToast('Thank you for your feedback!', 'success');
    displayTemperatureResults();
}
function displayTemperatureResults() {
    const responses = JSON.parse(localStorage.getItem('temperatureChecks') || '[]');
    const count = document.getElementById('temp-check-count');
    const results = document.getElementById('temperature-results');
    if (count) count.textContent = responses.length;
    if (!results || responses.length === 0) return;
    const avg = (arr) => arr.reduce((a,b) => a+b, 0) / arr.length;
    const avgHealth = avg(responses.map(r => r.overallHealth)).toFixed(1);
    const avgWelcome = avg(responses.map(r => r.feelWelcome)).toFixed(1);
    const avgTraditions = avg(responses.map(r => r.followsTraditions)).toFixed(1);
    results.innerHTML = `
        <div class="grid" style="grid-template-columns: repeat(3, 1fr); gap: 1rem;">
            <div style="text-align: center; padding: 1rem; background: #34495e; border-radius: 4px;">
                <h4>Group Health</h4>
                <p style="font-size: 2rem; color: #3498db; margin: 0.5rem 0;">${avgHealth}/5</p>
            </div>
            <div style="text-align: center; padding: 1rem; background: #34495e; border-radius: 4px;">
                <h4>Feel Welcome</h4>
                <p style="font-size: 2rem; color: #3498db; margin: 0.5rem 0;">${avgWelcome}/5</p>
            </div>
            <div style="text-align: center; padding: 1rem; background: #34495e; border-radius: 4px;">
                <h4>Follows Traditions</h4>
                <p style="font-size: 2rem; color: #3498db; margin: 0.5rem 0;">${avgTraditions}/5</p>
            </div>
        </div>
    `;
}
function loadGroupVision() {
    const vision = JSON.parse(localStorage.getItem('groupVision') || '{}');
    const display = document.getElementById('vision-display');
    if (!display) return;
    if (!vision.mission && !vision.values && !vision.goals) {
        display.innerHTML = '<p style="color: #95a5a6; font-style: italic;">No vision statement set. Click "Edit Vision Statement" to create one.</p>';
    } else {
        display.innerHTML = `
            ${vision.mission ? `<div style="margin-bottom: 1rem;"><h4>Mission</h4><p>${escapeHtml(vision.mission)}</p></div>` : ''}
            ${vision.values ? `<div style="margin-bottom: 1rem;"><h4>Core Values</h4><p>${escapeHtml(vision.values)}</p></div>` : ''}
            ${vision.goals ? `<div><h4>Goals</h4><p>${escapeHtml(vision.goals)}</p></div>` : ''}
        `;
    }
}
function editGroupVision() {
    const vision = JSON.parse(localStorage.getItem('groupVision') || '{}');
    document.getElementById('vision-mission').value = vision.mission || '';
    document.getElementById('vision-values').value = vision.values || '';
    document.getElementById('vision-goals').value = vision.goals || '';
    document.getElementById('vision-editor').style.display = 'block';
}
function saveGroupVision() {
    const vision = {
        mission: document.getElementById('vision-mission').value.trim(),
        values: document.getElementById('vision-values').value.trim(),
        goals: document.getElementById('vision-goals').value.trim(),
        updatedAt: new Date().toISOString()
    };
    localStorage.setItem('groupVision', JSON.stringify(vision));
    document.getElementById('vision-editor').style.display = 'none';
    showToast('Group vision saved!', 'success');
    loadGroupVision();
}
function cancelGroupVision() {
    document.getElementById('vision-editor').style.display = 'none';
}
function exportToICalendar() {
    const events = storage.getEvents();
    if (events.length === 0) {
        showToast('No events to export.', 'error');
        return;
    }
    let icsContent = [
        'BEGIN:VCALENDAR',
        'VERSION:2.0',
        'PRODID:-//HomeGroup//Meeting Calendar//EN',
        'CALSCALE:GREGORIAN',
        'METHOD:PUBLISH',
        'X-WR-CALNAME:HomeGroup Meetings',
        'X-WR-TIMEZONE:America/Chicago',
        'X-WR-CALDESC:AA Home Group Meeting Schedule'
    ];
    events.forEach(event => {
        const uid = event.id + '@homegroup.local';
        const summary = event.title || 'Meeting';
        const description = event.description || '';
        const location = event.location || '';

        if (event.dayOfWeek !== undefined && event.dayOfWeek !== null) {
            const today = new Date();
            const startDate = new Date(today);
            startDate.setDate(today.getDate() + ((parseInt(event.dayOfWeek) - today.getDay() + 7) % 7));

            const dtstart = formatICSDate(startDate, event.time);
            const dtend = formatICSDate(startDate, event.endTime || event.time);

            icsContent.push(
                'BEGIN:VEVENT',
                `UID:${uid}`,
                `DTSTAMP:${formatICSDate(new Date())}`,
                `DTSTART:${dtstart}`,
                `DTEND:${dtend}`,
                `RRULE:FREQ=WEEKLY;BYDAY=${getDayAbbr(event.dayOfWeek)}`,
                `SUMMARY:${escapeICS(summary)}`,
                `DESCRIPTION:${escapeICS(description)}`,
                `LOCATION:${escapeICS(location)}`,
                'END:VEVENT'
            );
        } else if (event.date) {
            const eventDate = new Date(event.date);
            const dtstart = formatICSDate(eventDate, event.time);
            const dtend = formatICSDate(eventDate, event.endTime || event.time);

            icsContent.push(
                'BEGIN:VEVENT',
                `UID:${uid}`,
                `DTSTAMP:${formatICSDate(new Date())}`,
                `DTSTART:${dtstart}`,
                `DTEND:${dtend}`,
                `SUMMARY:${escapeICS(summary)}`,
                `DESCRIPTION:${escapeICS(description)}`,
                `LOCATION:${escapeICS(location)}`,
                'END:VEVENT'
            );
        }
    });

    icsContent.push('END:VCALENDAR');

    const icsBlob = new Blob([icsContent.join('\r\n')], { type: 'text/calendar;charset=utf-8' });
    const url = URL.createObjectURL(icsBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'HomeGroup-Meetings.ics';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);

    showToast('Calendar exported successfully!', 'success');
}
function formatICSDate(date, time) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');

    if (time) {
        const [hours, minutes] = time.split(':');
        return `${year}${month}${day}T${hours}${minutes}00`;
    }
    return `${year}${month}${day}`;
}
function getDayAbbr(dayNum) {
    const days = ['SU', 'MO', 'TU', 'WE', 'TH', 'FR', 'SA'];
    return days[parseInt(dayNum)] || 'MO';
}
function escapeICS(text) {
    if (!text) return '';
    return text.replace(/\\/g, '\\\\').replace(/;/g, '\\;').replace(/,/g, '\\,').replace(/\n/g, '\\n');
}
function generateMeetingQRCode() {
    const groupName = localStorage.getItem('groupName') || 'HomeGroup';
    const location = localStorage.getItem('meetingLocation') || '';
    const zoomLink = localStorage.getItem('zoomLink') || '';

    let qrData = `${groupName} AA Meeting`;
    if (location) qrData += `\nLocation: ${location}`;
    if (zoomLink) qrData += `\nZoom: ${zoomLink}`;

    const qrModal = document.createElement('div');
    qrModal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 1000;';

    qrModal.innerHTML = `
        <div style="background: white; padding: 2rem; border-radius: 8px; text-align: center; max-width: 400px;">
            <h3 style="color: #2c3e50; margin-bottom: 1rem;">Meeting QR Code</h3>
            <p style="color: #7f8c8d; margin-bottom: 1rem;">Scan this QR code with your phone to get meeting details</p>
            <div id="qr-code-display" style="display: flex; justify-content: center; margin: 1rem 0;">
                <canvas id="qr-canvas"></canvas>
            </div>
            <p style="font-size: 0.85rem; color: #95a5a6; margin-top: 1rem;">${escapeHtml(qrData)}</p>
            <button onclick="this.closest('div[style*=fixed]').remove()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">Close</button>
            <button onclick="downloadQRCode()" style="margin-top: 1rem; margin-left: 0.5rem; padding: 0.5rem 1rem; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer;">Download</button>
        </div>
    `;

    document.body.appendChild(qrModal);
    generateQRCodeCanvas(qrData, 'qr-canvas');
    showToast('QR Code generated!', 'success');
}
function generateQRCodeCanvas(text, canvasId) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    canvas.width = 200;
    canvas.height = 200;

    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, 200, 200);

    ctx.fillStyle = '#000000';
    ctx.font = '12px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('QR Code Placeholder', 100, 100);
    ctx.fillText('Use QR library in production', 100, 120);

    // In production, use: https://github.com/davidshimjs/qrcodejs or similar
}
function downloadQRCode() {
    const canvas = document.getElementById('qr-canvas');
    if (!canvas) return;

    const link = document.createElement('a');
    link.download = 'HomeGroup-QR-Code.png';
    link.href = canvas.toDataURL();
    link.click();
    showToast('QR Code downloaded!', 'success');
}
function addAnnouncement() {
    const text = document.getElementById('announcement-text').value.trim();
    if (!text) {
        showToast('Enter an announcement.', 'error');
        return;
    }
    const priority = document.getElementById('announcement-priority').value;
    const requireReadReceipt = document.getElementById('announcement-require-read-receipt').checked;
    const ann = storage.getAnnouncements();
    ann.unshift({
        id: genId(),
        text,
        dateCreated: new Date().toISOString(),
        active: true,
        priority: priority,
        requireReadReceipt: requireReadReceipt,
        readBy: []
    });
    storage.saveAnnouncements(ann);
    showToast('Announcement added!', 'success');
    document.getElementById('announcement-text').value = '';
    document.getElementById('announcement-priority').value = 'info';
    document.getElementById('announcement-require-read-receipt').checked = false;
    updateAnnouncementsList();
    updateHome();
    updateChairpersonAnnouncements();
}
function deleteAnnouncement(id) {
    if (!confirm('Delete this announcement?')) return;
    let ann = storage.getAnnouncements();
    ann = ann.filter(a => a.id !== id);
    storage.saveAnnouncements(ann);
    showToast('Announcement deleted.', 'info');
    updateAnnouncementsList();
    updateHome();
    updateChairpersonAnnouncements();
}
function toggleAnnouncementActive(id) {
    let ann = storage.getAnnouncements();
    const index = ann.findIndex(a => a.id === id);
    if (index > -1) {
        ann[index].active = !ann[index].active;
        storage.saveAnnouncements(ann);
        updateAnnouncementsList();
        updateHome();
        updateChairpersonAnnouncements();
    }
}
function updateAnnouncementsList() {
    const ul = document.getElementById('announcements-list');
    ul.innerHTML = '';
    const ann = storage.getAnnouncements();
    const currentUser = storage.getCurrentUser();
    ann.forEach(a => {
        const li = document.createElement('div');
        li.className = `announcement-item ${a.priority || 'info'}`;
        if (!a.active) {
            li.style.opacity = '0.5';
        }
        const dateStr = new Date(a.dateCreated).toLocaleDateString();
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = a.active;
        checkbox.style.marginRight = '1rem';
        checkbox.onchange = () => toggleAnnouncementActive(a.id);
        const priorityBadge = document.createElement('span');
        priorityBadge.className = `priority-badge ${a.priority || 'info'}`;
        priorityBadge.textContent = (a.priority || 'info').toUpperCase();
        const text = document.createElement('span');
        text.innerHTML = `<strong>${dateStr}:</strong> ${escapeHtml(a.text)}`;
        text.style.flexGrow = '1';
        const topRow = document.createElement('div');
        topRow.style.display = 'flex';
        topRow.style.alignItems = 'center';
        topRow.style.marginBottom = '8px';
        topRow.appendChild(checkbox);
        topRow.appendChild(text);
        topRow.appendChild(priorityBadge);
        li.appendChild(topRow);
        if (a.requireReadReceipt) {
            const readBy = a.readBy || [];
            const hasRead = readBy.includes(currentUser);
            const readInfo = document.createElement('div');
            readInfo.className = 'read-receipt-indicator';
            readInfo.innerHTML = `<i class="fas fa-check-circle"></i> Read by ${readBy.length} member(s)`;
            li.appendChild(readInfo);
            if (!hasRead) {
                const markReadBtn = document.createElement('button');
                markReadBtn.className = 'btn mark-as-read-btn';
                markReadBtn.textContent = 'Mark as Read';
                markReadBtn.onclick = () => markAnnouncementAsRead(a.id);
                li.appendChild(markReadBtn);
            }
        }
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn secondary';
        deleteBtn.style.marginTop = '8px';
        deleteBtn.textContent = 'Delete';
        deleteBtn.onclick = () => deleteAnnouncement(a.id);
        li.appendChild(deleteBtn);
        ul.appendChild(li);
    });
    if (ann.length === 0) {
        ul.innerHTML = '<li>No announcements posted</li>';
    }
}
function updateChairpersonAnnouncements() {
    const ul = document.getElementById('chairperson-announcements-list');
    if (!ul) return;
    ul.innerHTML = '';
    const activeAnnouncements = storage.getAnnouncements().filter(a => a.active);
    activeAnnouncements.forEach(a => {
        const li = document.createElement('li');
        const dateStr = new Date(a.dateCreated).toLocaleDateString();
        li.innerHTML = `<strong>${dateStr}:</strong> ${escapeHtml(a.text)}`;
        ul.appendChild(li);
    });
    if (activeAnnouncements.length === 0) {
        ul.innerHTML = '<li>No active announcements</li>';
    }
}
let currentPhotoIndex = 0;
let currentPhotoList = [];
function updateModalContent() {
    const photo = currentPhotoList[currentPhotoIndex];
    if (!photo) { closeModal(); return; }
    const modalImg = document.getElementById('modal-image');
    const caption = document.getElementById('modal-caption');
    modalImg.src = photo.src;
    caption.textContent = photo.tags && photo.tags.length > 0 ? `Tags: ${photo.tags.join(', ')}` : '';
}
function showNextPhoto() {
    if (currentPhotoList.length === 0) return;
    currentPhotoIndex = (currentPhotoIndex + 1) % currentPhotoList.length;
    updateModalContent();
}
function showPreviousPhoto() {
    if (currentPhotoList.length === 0) return;
    currentPhotoIndex = (currentPhotoIndex - 1 + currentPhotoList.length) % currentPhotoList.length;
    updateModalContent();
}
function handleModalKeys(event) {
    if (event.key === 'Escape') {
        closeModal();
    } else if (event.key === 'ArrowRight') {
        showNextPhoto();
    } else if (event.key === 'ArrowLeft') {
        showPreviousPhoto();
    }
}
function openModal(index, photos) {
    currentPhotoList = photos;
    currentPhotoIndex = index;
    if (currentPhotoList.length === 0) return;
    const modal = document.getElementById('photo-modal');
    if (modal) {
        modal.style.display = "flex";
        document.body.style.overflow = 'hidden'; // Prevent background scrolling
        updateModalContent();
        document.addEventListener('keydown', handleModalKeys);
    }
}
function closeModal() {
    const modal = document.getElementById('photo-modal');
    if (modal) {
        modal.style.display = "none";
        document.body.style.overflow = ''; // Restore scrolling
        document.removeEventListener('keydown', handleModalKeys);
    }
}
async function uploadPhotos() {
    const input = document.getElementById('photo-upload');
    const tagsInput = document.getElementById('photo-tags');
    const files = Array.from(input.files);

    if (files.length === 0) {
        showToast('Please select one or more images to upload.', 'error');
        return;
    }

    const tags = tagsInput.value.split(',').map(tag => tag.trim()).filter(Boolean);
    let uploadedCount = 0;
    let failedCount = 0;

    for (const file of files) {
        // No need for FileReader, we can store the File object (which is a Blob) directly
        const photo = {
            id: genId(),
            src: file,
            tags: tags,
            uploadedAt: new Date().toISOString()
        };

        try {
            await addPhotoToDB(photo);
            uploadedCount++;
        } catch (err) {
            failedCount++;
            showToast(`Failed to save photo "${file.name}": ${err.message}`, 'error');
            console.error('Error saving photo to IndexedDB:', err);
        }
    }

    if (uploadedCount > 0) {
        showToast(`${uploadedCount} photo(s) uploaded successfully!`, 'success');
        input.value = '';
        tagsInput.value = '';
        await updateGallery();
        await updateHome();
    }
    if (failedCount > 0) {
        showToast(`${failedCount} photo(s) failed to upload.`, 'error');
    }
}


async function deletePhoto(photoId) {
    if (!confirm('Are you sure you want to delete this photo?')) return;
    try {
        await deletePhotoFromDB(photoId);
        showToast('Photo deleted successfully!', 'success');
        await updateGallery();
        await updateHome();
    } catch (error) {
        showToast(`Error deleting photo: ${error.message}`, 'error');
        console.error('Error deleting photo from DB:', error);
    }
}
function handleChairpersonLogSubmit() {
    const editId = document.getElementById('log-edit-id').value;
    if (editId) {
        updateChairpersonLog(editId);
    } else {
        addChairpersonLog();
    }
}
function addChairpersonLog() {
    const date = document.getElementById('log-date').value;
    const time = document.getElementById('log-time').value;
    const chairperson = document.getElementById('log-chairperson').value.trim();
    const headcount = document.getElementById('log-headcount').value;
    const tradition = document.getElementById('log-7th-tradition').value;
    const orangeCan = document.getElementById('log-orange-can').value;
    if (!date) {
        showToast('Please select a date.', 'error');
        return;
    }
    const log = storage.getChairpersonLog();
    log.push({
        id: genId(),
        date,
        time,
        chairperson,
        headcount: parseInt(headcount) || 0,
        tradition: parseFloat(tradition) || 0,
        orangeCan: parseFloat(orangeCan) || 0,
    });
    storage.saveChairpersonLog(log);
    showToast('Log entry added.', 'success');
    updateChairpersonLogTable();
    document.getElementById('log-date').value = '';
    document.getElementById('log-time').value = '';
    document.getElementById('log-chairperson').value = '';
    document.getElementById('log-headcount').value = '';
    document.getElementById('log-7th-tradition').value = '';
    document.getElementById('log-orange-can').value = '';
}
function updateChairpersonLogTable() {
    const tbody = document.getElementById('chairperson-log-body');
    tbody.innerHTML = '';
    const log = storage.getChairpersonLog().sort((a, b) => new Date(b.date) - new Date(a.date));
    const thead = document.getElementById('chairperson-log-table').querySelector('thead');
    thead.innerHTML = `
        <tr>
            <th>Date</th>
            <th>Time</th>
            <th>Chairperson</th>
            <th>Head Count</th>
            <th>7th Tradition</th>
            <th>Orange Can</th>
            <th>Actions</th>
        </tr>
    `;
    log.forEach(entry => {
        const tr = document.createElement('tr');
        const timeStr = entry.time ? new Date('1970-01-01T' + entry.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'N/A';
        tr.innerHTML = `
            <td>${escapeHtml(new Date(entry.date).toLocaleDateString())}</td>
            <td>${escapeHtml(timeStr)}</td>
            <td>${escapeHtml(entry.chairperson || 'N/A')}</td>
            <td>${escapeHtml(String(entry.headcount))}</td>
            <td>$${escapeHtml(entry.tradition.toFixed(2))}</td>
            <td>$${escapeHtml(entry.orangeCan.toFixed(2))}</td>
            <td>
                <button class="btn" data-action="edit-chairperson" data-id="${escapeAttribute(entry.id)}" style="margin-right: 5px;">Edit</button>
                <button class="btn secondary" data-action="delete-chairperson" data-id="${escapeAttribute(entry.id)}">Delete</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}
function editChairpersonLog(id) {
    const log = storage.getChairpersonLog();
    const entry = log.find(e => e.id === id);
    if (!entry) return;
    document.getElementById('log-edit-id').value = entry.id;
    document.getElementById('log-date').value = entry.date;
    document.getElementById('log-time').value = entry.time;
    document.getElementById('log-chairperson').value = entry.chairperson;
    document.getElementById('log-headcount').value = entry.headcount;
    document.getElementById('log-7th-tradition').value = entry.tradition;
    document.getElementById('log-orange-can').value = entry.orangeCan;
    document.getElementById('chairperson-form-title').textContent = 'Edit Log Entry';
    document.getElementById('log-form-btn').textContent = 'Save Changes';
    document.getElementById('log-form-cancel-btn').style.display = 'inline-block';
}
function updateChairpersonLog(id) {
    const log = storage.getChairpersonLog();
    const index = log.findIndex(e => e.id === id);
    if (index === -1) return;
    const date = document.getElementById('log-date').value;
    const time = document.getElementById('log-time').value;
    const chairperson = document.getElementById('log-chairperson').value.trim();
    const headcount = document.getElementById('log-headcount').value;
    const tradition = document.getElementById('log-7th-tradition').value;
    const orangeCan = document.getElementById('log-orange-can').value;
    if (!date) {
        showToast('Please select a date.', 'error');
        return;
    }
    log[index] = {
        id,
        date,
        time,
        chairperson,
        headcount: parseInt(headcount) || 0,
        tradition: parseFloat(tradition) || 0,
        orangeCan: parseFloat(orangeCan) || 0,
    };
    storage.saveChairpersonLog(log);
    showToast('Log entry updated.', 'success');
    cancelLogEdit();
    updateChairpersonLogTable();
}
function cancelLogEdit() {
    document.getElementById('log-edit-id').value = '';
    document.getElementById('log-date').value = '';
    document.getElementById('log-time').value = '';
    document.getElementById('log-chairperson').value = '';
    document.getElementById('log-headcount').value = '';
    document.getElementById('log-7th-tradition').value = '';
    document.getElementById('log-orange-can').value = '';
    document.getElementById('chairperson-form-title').textContent = 'Log New Entry';
    document.getElementById('log-form-btn').textContent = 'Add Log Entry';
    document.getElementById('log-form-cancel-btn').style.display = 'none';
}
function deleteChairpersonLog(id) {
    if (!confirm('Delete this log entry?')) return;
    let log = storage.getChairpersonLog();
    log = log.filter(e => e.id !== id);
    storage.saveChairpersonLog(log);
    showToast('Log entry deleted.', 'info');
    updateChairpersonLogTable();
}
function toggleGCWorkflowSections() {
    const status = document.getElementById('gc-workflow-status')?.value || 'decided';
    const researchSection = document.getElementById('gc-research-period-section');
    const votingSection = document.getElementById('gc-voting-section');
    if (researchSection) {
        researchSection.style.display = (status === 'research' || status === 'voting') ? 'block' : 'none';
    }
    if (votingSection) {
        const voteFields = ['gc-votes-for', 'gc-votes-against', 'gc-votes-abstain', 'gc-attendees'];
        const shouldShow = (status === 'decided');
        voteFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.closest('.form-group').style.display = shouldShow ? 'block' : 'none';
            }
        });
    }
}
function getCurrentUserName() {
    return localStorage.getItem('currentUser') || 'Anonymous';
}
function addGCQuestion(gcId) {
    const questionText = prompt('Enter your question about this motion:');
    if (!questionText || !questionText.trim()) return;
    const logs = storage.getGroupConscienceLog();
    const log = logs.find(l => l.id === gcId);
    if (!log) {
        showToast('Motion not found', 'error');
        return;
    }
    const today = new Date().toISOString().split('T')[0];
    if (log.workflowStatus !== 'research' && log.workflowStatus !== 'draft') {
        showToast('Research period has ended for this motion', 'error');
        return;
    }
    if (!log.questions) log.questions = [];
    const question = {
        id: genId(),
        memberId: getCurrentUserName(), // In production, use actual member ID
        memberName: getCurrentUserName(),
        question: questionText.trim(),
        answer: null,
        answeredBy: null,
        answeredDate: null,
        askedDate: new Date().toISOString()
    };
    log.questions.push(question);
    storage.saveGroupConscienceLog(logs);
    showToast('Question submitted successfully', 'success');
    if (typeof viewGCDetailsModal === 'function') {
        openGCDetailsModal(gcId);
    }
}
function answerGCQuestion(gcId, questionId) {
    const answerText = prompt('Enter your answer:');
    if (!answerText || !answerText.trim()) return;
    const logs = storage.getGroupConscienceLog();
    const log = logs.find(l => l.id === gcId);
    if (!log || !log.questions) {
        showToast('Question not found', 'error');
        return;
    }
    const question = log.questions.find(q => q.id === questionId);
    if (!question) {
        showToast('Question not found', 'error');
        return;
    }
    question.answer = answerText.trim();
    question.answeredBy = getCurrentUserName();
    question.answeredDate = new Date().toISOString();
    storage.saveGroupConscienceLog(logs);
    showToast('Answer posted successfully', 'success');
    if (typeof openGCDetailsModal === 'function') {
        openGCDetailsModal(gcId);
    }
}
function markGCReviewed(gcId) {
    const logs = storage.getGroupConscienceLog();
    const log = logs.find(l => l.id === gcId);
    if (!log) {
        showToast('Motion not found', 'error');
        return;
    }
    if (!log.reviewedBy) log.reviewedBy = [];
    const userId = getCurrentUserName();
    if (!log.reviewedBy.includes(userId)) {
        log.reviewedBy.push(userId);
        storage.saveGroupConscienceLog(logs);
        showToast('Marked as reviewed. Thank you for staying informed!', 'success');
        if (typeof openGCDetailsModal === 'function') {
            openGCDetailsModal(gcId);
        }
    } else {
        showToast('You have already reviewed this motion', 'info');
    }
}
function getReviewCompletionPercentage(log) {
    if (!log.reviewedBy || log.reviewedBy.length === 0) return 0;
    const members = storage.getMembers();
    if (members.length === 0) return 0;
    return Math.round((log.reviewedBy.length / members.length) * 100);
}
function isResearchPeriodActive(log) {
    if (!log.researchPeriodStart || !log.researchPeriodEnd) return false;
    const today = new Date().toISOString().split('T')[0];
    return today >= log.researchPeriodStart && today <= log.researchPeriodEnd;
}
function getDaysRemainingInResearch(log) {
    if (!log.researchPeriodEnd) return null;
    const today = new Date();
    const endDate = new Date(log.researchPeriodEnd);
    const diffTime = endDate - today;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    return diffDays;
}
function promptMinorityOpinion(gcId) {
    const logs = storage.getGroupConscienceLog();
    const log = logs.find(l => l.id === gcId);
    if (!log) return;
    if (log.minorityPercentage < 33) {
        return; // No need for minority opinion
    }
    const shouldRecord = confirm(
        `This motion passed with ${log.minorityPercentage.toFixed(1)}% voting against.\n\n` +
        `In the spirit of unity and informed group conscience, would members of the minority ` +
        `like to record their concerns for the group's consideration?`
    );
    if (!shouldRecord) return;
    const opinionText = prompt(
        'Please share the minority viewpoint:\n\n' +
        '(This will be attached to the motion for the group to consider)'
    );
    if (!opinionText || !opinionText.trim()) return;
    log.minorityOpinion = {
        text: opinionText.trim(),
        submittedBy: getCurrentUserName(),
        submittedDate: new Date().toISOString(),
        signatories: [getCurrentUserName()]
    };
    storage.saveGroupConscienceLog(logs);
    showToast('Minority opinion recorded. The group will revisit this in 6 months.', 'success');
    if (typeof openGCDetailsModal === 'function') {
        openGCDetailsModal(gcId);
    }
}
function signMinorityOpinion(gcId) {
    const logs = storage.getGroupConscienceLog();
    const log = logs.find(l => l.id === gcId);
    if (!log || !log.minorityOpinion) {
        showToast('No minority opinion exists for this motion', 'error');
        return;
    }
    const userName = getCurrentUserName();
    if (!log.minorityOpinion.signatories) {
        log.minorityOpinion.signatories = [];
    }
    if (!log.minorityOpinion.signatories.includes(userName)) {
        log.minorityOpinion.signatories.push(userName);
        storage.saveGroupConscienceLog(logs);
        showToast('Your support for this viewpoint has been recorded', 'success');
        if (typeof openGCDetailsModal === 'function') {
            openGCDetailsModal(gcId);
        }
    } else {
        showToast('You have already signed this opinion', 'info');
    }
}
function handleGCLogSubmit() {
    const editId = document.getElementById('gc-edit-id').value;
    if (editId) {
        updateGCLog(editId);
    } else {
        addGCLog();
    }
}
function addGCLog() {
    const servantReportInputs = document.querySelectorAll('.servant-report-input');
    const servantReports = [];
    servantReportInputs.forEach(input => {
        if (input.value.trim() !== '') {
            servantReports.push({
                servantId: input.dataset.servantId,
                servantName: input.dataset.servantName,
                report: input.value.trim()
            });
        }
    });
    const votesFor = parseInt(document.getElementById('gc-votes-for')?.value || 0);
    const votesAgainst = parseInt(document.getElementById('gc-votes-against')?.value || 0);
    const votesAbstain = parseInt(document.getElementById('gc-votes-abstain')?.value || 0);
    const log = {
        id: genId(),
        date: document.getElementById('gc-date').value,
        item: document.getElementById('gc-item').value.trim(),
        submittedBy: document.getElementById('gc-submitted-by').value.trim(),
        status: document.getElementById('gc-status').value,
        votesFor,
        votesAgainst,
        votesAbstain,
        attendees: Array.from(document.getElementById('gc-attendees').selectedOptions).map(opt => opt.value),
        servantReports: servantReports,
        workflowStatus: document.getElementById('gc-workflow-status')?.value || 'decided', // draft, research, voting, decided
        researchPeriodStart: document.getElementById('gc-research-start')?.value || null,
        researchPeriodEnd: document.getElementById('gc-research-end')?.value || null,
        questions: [], // Array of {id, memberId, memberName, question, answer, answeredBy, answeredDate}
        reviewedBy: [], // Array of member IDs who reviewed materials
        createdDate: new Date().toISOString(),
        minorityOpinion: null, // {text, submittedBy, submittedDate, signatories[]}
        minorityPercentage: 0, // Calculated from votes
        requiresFollowUp: false, // Auto-set if minority >= 33%
        followUpDate: null, // 6 months from decision if significant dissent
    };
    if (!log.date || !log.item) {
        showToast('Please provide at least a date and an item/motion.', 'error');
        return;
    }
    const totalVotes = votesFor + votesAgainst + votesAbstain;
    if (totalVotes > 0) {
        const minority = Math.max(votesFor, votesAgainst); // Higher of for/against
        const majority = Math.min(votesFor, votesAgainst);
        log.minorityPercentage = totalVotes > 0 ? ((minority > majority ? votesAgainst : votesFor) / totalVotes * 100) : 0;
        if (log.minorityPercentage >= 33 && log.status === 'passed') {
            log.requiresFollowUp = true;
            const followUp = new Date(log.date);
            followUp.setMonth(followUp.getMonth() + 6);
            log.followUpDate = followUp.toISOString().split('T')[0];
        }
    }
    const logs = storage.getGroupConscienceLog();
    logs.push(log);
    storage.saveGroupConscienceLog(logs);
    showToast('Group Conscience entry added.', 'success');
    updateGCLogTable();
    cancelGCEdit(); // Clear form
}
function updateGCLogTable() {
    const currentTbody = document.getElementById('gc-log-body-current');
    const previousTbody = document.getElementById('gc-log-body-previous');
    currentTbody.innerHTML = '';
    previousTbody.innerHTML = '';
    const logs = storage.getGroupConscienceLog().sort((a, b) => new Date(b.date) - new Date(a.date));
    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();
    logs.forEach(log => {
        const logDate = new Date(log.date);
        const logMonth = logDate.getMonth();
        const logYear = logDate.getFullYear();
        const isCurrentMonth = logMonth === currentMonth && logYear === currentYear;
        const tbody = isCurrentMonth ? currentTbody : previousTbody;
        const votesFor = log.votesFor || 0;
        const votesAgainst = log.votesAgainst || 0;
        const votesAbstain = log.votesAbstain || 0;
        const votesDisplay = (votesFor || votesAgainst || votesAbstain)
            ? `${votesFor}-${votesAgainst}-${votesAbstain}`
            : (log.votes || 'N/A');
        const workflowStatus = log.workflowStatus || 'decided';
        const statusBadges = {
            'draft': '<span style="background: #95a5a6; padding: 2px 8px; border-radius: 3px; font-size: 0.75rem; margin-left: 5px;">DRAFT</span>',
            'research': '<span style="background: #3498db; padding: 2px 8px; border-radius: 3px; font-size: 0.75rem; margin-left: 5px;">RESEARCH</span>',
            'voting': '<span style="background: #f39c12; padding: 2px 8px; border-radius: 3px; font-size: 0.75rem; margin-left: 5px;">VOTING</span>',
            'decided': ''
        };
        let researchInfo = '';
        if (log.researchPeriodEnd && isResearchPeriodActive(log)) {
            const daysLeft = getDaysRemainingInResearch(log);
            researchInfo = `<br><small style="color: #3498db;">Research ends in ${daysLeft} day${daysLeft !== 1 ? 's' : ''}</small>`;
        }
        let reviewBadge = '';
        if (workflowStatus === 'research' || workflowStatus === 'voting') {
            const reviewPct = getReviewCompletionPercentage(log);
            const reviewColor = reviewPct >= 75 ? '#2ecc71' : reviewPct >= 50 ? '#f39c12' : '#e74c3c';
            reviewBadge = `<br><small style="color: ${reviewColor};">${reviewPct}% reviewed</small>`;
        }
        let minorityBadge = '';
        if (log.minorityOpinion) {
            const sigCount = log.minorityOpinion.signatories ? log.minorityOpinion.signatories.length : 0;
            minorityBadge = `<br><small style="color: #e67e22;"><i class="fas fa-comment-alt"></i> Minority opinion (${sigCount} signatories)</small>`;
        } else if (log.requiresFollowUp && log.followUpDate) {
            minorityBadge = `<br><small style="color: #f39c12;"><i class="fas fa-clock"></i> Follow-up: ${log.followUpDate}</small>`;
        }
        let qaInfo = '';
        if (log.questions && log.questions.length > 0) {
            const answered = log.questions.filter(q => q.answer).length;
            const qaColor = answered === log.questions.length ? '#2ecc71' : '#f39c12';
            qaInfo = `<br><small style="color: ${qaColor};"><i class="fas fa-question-circle"></i> ${answered}/${log.questions.length} questions answered</small>`;
        }
        const traditionBadge = addTraditionBadgeToMotion(log.id);
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${escapeHtml(logDate.toLocaleDateString())}</td>
            <td>
                ${escapeHtml(log.item.substring(0, 50))}${log.item.length > 50 ? '...' : ''}
                ${statusBadges[workflowStatus]}
                ${traditionBadge}
                ${researchInfo}
                ${reviewBadge}
                ${qaInfo}
                ${minorityBadge}
            </td>
            <td>${escapeHtml(log.submittedBy || 'N/A')}</td>
            <td style="color: ${log.status === 'passed' ? '#2ecc71' : log.status === 'failed' ? '#e74c3c' : '#f39c12'};">${escapeHtml(log.status.toUpperCase())}</td>
            <td>${escapeHtml(votesDisplay)}</td>
            <td>
                <button class="btn" data-action="view-gc" data-id="${escapeAttribute(log.id)}" style="margin-right: 5px;">View</button>
                <button class="btn" data-action="edit-gc" data-id="${escapeAttribute(log.id)}" style="margin-right: 5px;">Edit</button>
                <button class="btn secondary" data-action="delete-gc" data-id="${escapeAttribute(log.id)}">Delete</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
    if (currentTbody.innerHTML === '') {
        currentTbody.innerHTML = '<tr><td colspan="6">No entries for the current month.</td></tr>';
    }
    if (previousTbody.innerHTML === '') {
        previousTbody.innerHTML = '<tr><td colspan="6">No entries for previous months.</td></tr>';
    }
}
function editGCLog(id) {
    const logs = storage.getGroupConscienceLog();
    const log = logs.find(l => l.id === id);
    if (!log) return;
    document.getElementById('gc-edit-id').value = log.id;
    document.getElementById('gc-date').value = log.date;
    document.getElementById('gc-item').value = log.item;
    document.getElementById('gc-submitted-by').value = log.submittedBy;
    document.getElementById('gc-status').value = log.status;
    if (document.getElementById('gc-votes-for')) {
        document.getElementById('gc-votes-for').value = log.votesFor || 0;
        document.getElementById('gc-votes-against').value = log.votesAgainst || 0;
        document.getElementById('gc-votes-abstain').value = log.votesAbstain || 0;
        updateVotePercentages();
    }
    const attendees = log.attendees || [];
    const select = document.getElementById('gc-attendees');
    if (Array.isArray(attendees)) {
        Array.from(select.options).forEach(option => {
            option.selected = attendees.includes(option.value);
        });
    } else {
        select.selectedIndex = -1;
    }
    document.querySelectorAll('.servant-report-input').forEach(input => input.value = '');
    const legacyContainer = document.getElementById('gc-servant-reports-legacy-container');
    const legacyTextarea = document.getElementById('gc-servant-reports-legacy');
    legacyContainer.style.display = 'none';
    if (log.servantReports && Array.isArray(log.servantReports)) {
        log.servantReports.forEach(report => {
            const textarea = document.getElementById(`servant-report-${report.servantId}`);
            if (textarea) {
                textarea.value = report.report;
            }
        });
    } else if (log.servantReports && typeof log.servantReports === 'string' && log.servantReports.trim() !== '') {
        legacyContainer.style.display = 'block';
        legacyTextarea.value = log.servantReports;
    }
    document.getElementById('gc-form-title').textContent = 'Edit GC Entry';
    document.getElementById('gc-form-btn').textContent = 'Save Changes';
    document.getElementById('gc-form-cancel-btn').style.display = 'inline-block';
}
function updateGCLog(id) {
    const logs = storage.getGroupConscienceLog();
    const index = logs.findIndex(l => l.id === id);
    if (index === -1) return;
    const servantReportInputs = document.querySelectorAll('.servant-report-input');
    const servantReports = [];
    servantReportInputs.forEach(input => {
        if (input.value.trim() !== '') {
            servantReports.push({
                servantId: input.dataset.servantId,
                servantName: input.dataset.servantName,
                report: input.value.trim()
            });
        }
    });
    const votesFor = parseInt(document.getElementById('gc-votes-for')?.value || 0);
    const votesAgainst = parseInt(document.getElementById('gc-votes-against')?.value || 0);
    const votesAbstain = parseInt(document.getElementById('gc-votes-abstain')?.value || 0);
    const log = {
        id,
        date: document.getElementById('gc-date').value,
        item: document.getElementById('gc-item').value.trim(),
        submittedBy: document.getElementById('gc-submitted-by').value.trim(),
        status: document.getElementById('gc-status').value,
        votesFor,
        votesAgainst,
        votesAbstain,
        attendees: Array.from(document.getElementById('gc-attendees').selectedOptions).map(opt => opt.value),
        servantReports: servantReports,
    };
    if (!log.date || !log.item) {
        showToast('Please provide at least a date and an item/motion.', 'error');
        return;
    }
    logs[index] = log;
    storage.saveGroupConscienceLog(logs);
    showToast('Group Conscience entry updated.', 'success');
    cancelGCEdit();
    updateGCLogTable();
}
function cancelGCEdit() {
    document.getElementById('gc-edit-id').value = '';
    document.getElementById('gc-date').value = '';
    document.getElementById('gc-item').value = '';
    document.getElementById('gc-submitted-by').value = '';
    document.getElementById('gc-status').value = 'passed';
    if (document.getElementById('gc-votes-for')) {
        document.getElementById('gc-votes-for').value = '';
        document.getElementById('gc-votes-against').value = '';
        document.getElementById('gc-votes-abstain').value = '';
        updateVotePercentages();
    }
    document.getElementById('gc-attendees').value = '';
    document.querySelectorAll('.servant-report-input').forEach(input => input.value = '');
    document.getElementById('gc-servant-reports-legacy-container').style.display = 'none';
    document.getElementById('gc-servant-reports-legacy').value = '';
    document.getElementById('gc-form-title').textContent = 'Log Group Conscience Item';
    document.getElementById('gc-form-btn').textContent = 'Add GC Entry';
    document.getElementById('gc-form-cancel-btn').style.display = 'none';
}
function deleteGCLog(id) {
    if (!confirm('Delete this Group Conscience entry?')) return;
    let logs = storage.getGroupConscienceLog();
    logs = logs.filter(l => l.id !== id);
    storage.saveGroupConscienceLog(logs);
    showToast('GC entry deleted.', 'info');
    updateGCLogTable();
}
function toggleLiveGC() {
    const module = document.getElementById('live-gc-module');
    module.style.display = module.style.display === 'none' ? 'block' : 'none';
}
function addNewBusinessItem() {
    const itemText = document.getElementById('new-business-item').value.trim();
    if (!itemText) {
        showToast('Please enter an item.', 'error');
        return;
    }
    const items = storage.getLiveGCItems();
    items.push({
        id: genId(),
        item: itemText,
        status: 'Proposed'
    });
    storage.saveLiveGCItems(items);
    showToast('New business item added.', 'success');
    document.getElementById('new-business-item').value = '';
    updateLiveGCTable();
}
function updateLiveGCTable() {
    const tbody = document.getElementById('live-gc-body');
    if (!tbody) return;
    tbody.innerHTML = '';
    const items = storage.getLiveGCItems();
    items.forEach(item => {
        const tr = document.createElement('tr');
        const statusOptions = ['Proposed', 'Active Discussion', 'Tabled']
            .map(s => `<option value="${s}" ${s === item.status ? 'selected' : ''}>${s}</option>`)
            .join('');
        tr.innerHTML = `
            <td>${escapeHtml(item.item)}</td>
            <td>
                <select onchange="updateLiveGCItemStatus('${escapeAttribute(item.id)}', this.value)">
                    ${statusOptions}
                </select>
            </td>
            <td>
                <button class="btn secondary" data-action="delete-live-gc" data-id="${escapeAttribute(item.id)}">Delete</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
    if (items.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3">No new business items.</td></tr>';
    }
}
function updateLiveGCItemStatus(id, newStatus) {
    let items = storage.getLiveGCItems();
    const index = items.findIndex(item => item.id === id);
    if (index > -1) {
        items[index].status = newStatus;
        storage.saveLiveGCItems(items);
        showToast('Item status updated.', 'success');
        updateLiveGCTable();
    }
}
function deleteLiveGCItem(id) {
    if (!confirm('Delete this item?')) return;
    let items = storage.getLiveGCItems();
    items = items.filter(item => item.id !== id);
    storage.saveLiveGCItems(items);
    showToast('Item deleted.', 'info');
    updateLiveGCTable();
}
function addProposedAgendaItem() {
    const title = document.getElementById('proposed-item-title').value.trim();
    const description = document.getElementById('proposed-item-description').value.trim();
    const submitter = document.getElementById('proposed-item-submitter').value;
    const estimatedTime = parseInt(document.getElementById('proposed-item-time').value) || 15;
    const urgency = document.getElementById('proposed-item-urgency').value;
    const background = document.getElementById('proposed-item-background').value.trim();
    if (!title || !description || !submitter) {
        showToast('Please fill in all required fields (title, description, submitter).', 'error');
        return;
    }
    const items = storage.getProposedAgendaItems();
    const notice = checkAgendaSubmissionDeadline();
    if (notice && notice.closed) {
        showToast('Agenda submissions are closed for the upcoming meeting. Please submit for the next meeting.', 'error');
        return;
    }
    const newItem = {
        id: genId(),
        title,
        description,
        submitter,
        estimatedTime,
        urgency,
        background,
        dateSubmitted: new Date().toISOString().split('T')[0],
        status: 'pending',
        discussionNotes: '',
        interestedMembers: [], // Members who expressed interest
        historicalContext: findHistoricalContext(title, description)
    };
    items.push(newItem);
    storage.saveProposedAgendaItems(items);
    addAuditLog('CREATE', 'proposed-agenda', newItem.id, submitter, null,
        `Submitted agenda item: ${title}`, null);
    showToast('Agenda item submitted successfully! Members will be notified.', 'success');
    sendAgendaItemNotification(newItem);
    document.getElementById('proposed-item-title').value = '';
    document.getElementById('proposed-item-description').value = '';
    document.getElementById('proposed-item-time').value = '15';
    document.getElementById('proposed-item-urgency').value = 'medium';
    document.getElementById('proposed-item-background').value = '';
    updateProposedAgendaTable();
}
function updateProposedAgendaTable() {
    const tbody = document.getElementById('proposed-agenda-body');
    if (!tbody) return;
    tbody.innerHTML = '';
    const submitterSelect = document.getElementById('proposed-item-submitter');
    if (submitterSelect && submitterSelect.options.length <= 1) {
        const members = storage.getMembers().sort((a, b) => a.name.localeCompare(b.name));
        members.forEach(m => {
            const option = document.createElement('option');
            option.value = m.name;
            option.textContent = m.name;
            submitterSelect.appendChild(option);
        });
    }
    const items = storage.getProposedAgendaItems();
    const pendingItems = items.filter(i => i.status === 'pending' || i.status === 'reviewed');
    const urgencyOrder = { urgent: 0, high: 1, medium: 2, low: 3 };
    pendingItems.sort((a, b) => {
        const urgencyA = urgencyOrder[a.urgency || 'medium'];
        const urgencyB = urgencyOrder[b.urgency || 'medium'];
        if (urgencyA !== urgencyB) return urgencyA - urgencyB;
        return new Date(a.dateSubmitted) - new Date(b.dateSubmitted);
    });
    pendingItems.forEach(item => {
        const tr = document.createElement('tr');
        const urgencyColors = { urgent: '#e74c3c', high: '#f39c12', medium: '#3498db', low: '#95a5a6' };
        const urgencyColor = urgencyColors[item.urgency || 'medium'];
        const urgencyBadge = `<span style="display: inline-block; padding: 0.25rem 0.5rem; background: ${urgencyColor}; border-radius: 4px; font-size: 0.75rem; font-weight: bold;">${(item.urgency || 'medium').toUpperCase()}</span>`;
        const interestedCount = (item.interestedMembers || []).length;
        const members = storage.getMembers();
        const interestPercentage = members.length > 0 ? ((interestedCount / members.length) * 100).toFixed(0) : 0;
        const interestDisplay = `
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-users" style="color: #3498db;"></i>
                <span>${interestedCount} (${interestPercentage}%)</span>
            </div>
        `;
        const statusColor = item.status === 'converted' ? '#2ecc71' : item.status === 'discussed' ? '#f39c12' : '#3498db';
        const hasContext = item.historicalContext && item.historicalContext.length > 0;
        const contextBadge = hasContext ? `<span style="color: #f39c12; margin-left: 0.5rem;" title="Related to ${item.historicalContext.length} past decision(s)"><i class="fas fa-history"></i></span>` : '';
        tr.innerHTML = `
            <td>${urgencyBadge}</td>
            <td>
                <div style="font-weight: 500;">${escapeHtml(item.title)}${contextBadge}</div>
                <div style="font-size: 0.75rem; opacity: 0.7; margin-top: 0.25rem;">
                    Submitted: ${new Date(item.dateSubmitted).toLocaleDateString()}
                </div>
            </td>
            <td>${escapeHtml(item.submitter)}</td>
            <td>${item.estimatedTime || 15} min</td>
            <td onclick="toggleAgendaInterest('${escapeAttribute(item.id)}')" style="cursor: pointer;" title="Click to express interest">
                ${interestDisplay}
            </td>
            <td style="color: ${statusColor};">${escapeHtml(item.status.charAt(0).toUpperCase() + item.status.slice(1))}</td>
            <td style="white-space: nowrap;">
                <button class="btn" data-action="view-proposed" data-id="${escapeAttribute(item.id)}" style="margin-right: 5px; font-size: 0.8rem; padding: 0.3rem 0.6rem;">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn secondary" data-action="delete-proposed" data-id="${escapeAttribute(item.id)}" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });
    if (pendingItems.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; opacity: 0.7;">No pending agenda items. Submit items to begin collaborative agenda building!</td></tr>';
    }
    updateAgendaSubmissionNotice();
}
function viewProposedAgendaItem(id) {
    const items = storage.getProposedAgendaItems();
    const item = items.find(i => i.id === id);
    if (!item) return;
    let contextSection = '';
    if (item.historicalContext && item.historicalContext.length > 0) {
        const contextList = item.historicalContext.map(ctx => `
            <div style="padding: 0.75rem; background: #2c3e50; border-left: 3px solid #f39c12; margin-bottom: 0.5rem;">
                <div style="font-weight: bold;">${escapeHtml(ctx.item)}</div>
                <div style="font-size: 0.85rem; opacity: 0.7; margin-top: 0.25rem;">
                    ${new Date(ctx.date).toLocaleDateString()} - ${ctx.outcome}
                </div>
            </div>
        `).join('');
        contextSection = `
            <div style="margin-top: 1.5rem;">
                <h4 style="margin-bottom: 0.75rem;"><i class="fas fa-history"></i> Historical Context</h4>
                <div style="background: #2c3e50; padding: 1rem; border-radius: 4px;">
                    <div style="margin-bottom: 0.5rem; opacity: 0.8;">Similar past decisions:</div>
                    ${contextList}
                </div>
            </div>
        `;
    }
    let interestSection = '';
    if (item.interestedMembers && item.interestedMembers.length > 0) {
        const membersList = item.interestedMembers.map(name => `<span style="display: inline-block; padding: 0.25rem 0.5rem; background: #34495e; border-radius: 4px; margin: 0.25rem;">${escapeHtml(name)}</span>`).join('');
        interestSection = `
            <div style="margin-top: 1rem;">
                <div style="font-weight: bold; margin-bottom: 0.5rem;"><i class="fas fa-users"></i> Interested Members (${item.interestedMembers.length})</div>
                <div>${membersList}</div>
            </div>
        `;
    }
    const urgencyColors = { urgent: '#e74c3c', high: '#f39c12', medium: '#3498db', low: '#95a5a6' };
    const urgencyColor = urgencyColors[item.urgency || 'medium'];
    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; overflow-y: auto;';
    modal.innerHTML = `
        <div style="background: #34495e; padding: 2rem; border-radius: 8px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; margin: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1.5rem;">
                <h3 style="margin: 0;"><i class="fas fa-clipboard-list"></i> Agenda Item Details</h3>
                <button onclick="this.closest('div[style*=fixed]').remove()" class="btn secondary" style="padding: 0.25rem 0.75rem;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div style="background: #2c3e50; padding: 1.5rem; border-radius: 4px; border-left: 4px solid ${urgencyColor};">
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                    <span style="display: inline-block; padding: 0.25rem 0.75rem; background: ${urgencyColor}; border-radius: 4px; font-size: 0.85rem; font-weight: bold;">
                        ${(item.urgency || 'medium').toUpperCase()}
                    </span>
                    <span style="display: inline-block; padding: 0.25rem 0.75rem; background: #7f8c8d; border-radius: 4px; font-size: 0.85rem;">
                        ${item.estimatedTime || 15} minutes
                    </span>
                </div>
                <div style="font-size: 1.1rem; font-weight: bold; margin-bottom: 1rem;">${escapeHtml(item.title)}</div>
                <div style="margin-bottom: 1rem;">
                    <div style="font-weight: bold; margin-bottom: 0.5rem;">Description & Rationale:</div>
                    <div style="line-height: 1.6;">${escapeHtml(item.description)}</div>
                </div>
                ${item.background ? `
                <div>
                    <div style="font-weight: bold; margin-bottom: 0.5rem;">Background Materials:</div>
                    <div style="background: #1a252f; padding: 1rem; border-radius: 4px; line-height: 1.6;">
                        ${escapeHtml(item.background)}
                    </div>
                </div>
                ` : ''}
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem; font-size: 0.9rem;">
                    <div>
                        <div style="opacity: 0.7;">Submitted By:</div>
                        <div style="font-weight: bold;">${escapeHtml(item.submitter)}</div>
                    </div>
                    <div>
                        <div style="opacity: 0.7;">Date Submitted:</div>
                        <div>${new Date(item.dateSubmitted).toLocaleDateString()}</div>
                    </div>
                </div>
                ${interestSection}
            </div>
            ${contextSection}
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                <button onclick="toggleAgendaInterest('${escapeAttribute(item.id)}'); this.closest('div[style*=fixed]').remove(); updateProposedAgendaTable();" class="btn" style="background: #3498db;">
                    <i class="fas fa-hand-paper"></i> Express Interest
                </button>
                <button onclick="this.closest('div[style*=fixed]').remove()" class="btn secondary">Close</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}
function deleteProposedAgendaItem(id) {
    const items = storage.getProposedAgendaItems();
    const item = items.find(i => i.id === id);
    if (!confirm(`Delete proposed agenda item: "${item.title}"?`)) return;
    const filtered = items.filter(i => i.id !== id);
    storage.saveProposedAgendaItems(filtered);
    addAuditLog('DELETE', 'proposed-agenda', id, item.submitter, item,
        `Deleted agenda item: ${item.title}`, null);
    showToast('Proposed agenda item deleted.', 'info');
    updateProposedAgendaTable();
}
function toggleAgendaInterest(itemId) {
    const items = storage.getProposedAgendaItems();
    const item = items.find(i => i.id === itemId);
    if (!item) return;
    const userName = prompt('Enter your name to express interest in this agenda item:');
    if (!userName || userName.trim() === '') return;
    if (!item.interestedMembers) item.interestedMembers = [];
    if (item.interestedMembers.includes(userName.trim())) {
        item.interestedMembers = item.interestedMembers.filter(n => n !== userName.trim());
        showToast('Interest removed', 'info');
    } else {
        item.interestedMembers.push(userName.trim());
        showToast('Interest recorded! This helps prioritize agenda items.', 'success');
    }
    storage.saveProposedAgendaItems(items);
    updateProposedAgendaTable();
}
function findHistoricalContext(title, description) {
    const gcLogs = storage.getGroupConscienceLog();
    const searchTerms = (title + ' ' + description).toLowerCase().split(' ').filter(word => word.length > 3);
    const relatedDecisions = gcLogs.filter(log => {
        const logText = (log.item + ' ' + (log.discussionNotes || '')).toLowerCase();
        return searchTerms.some(term => logText.includes(term));
    }).slice(0, 3); // Limit to 3 most recent
    return relatedDecisions;
}
function sendAgendaItemNotification(item) {
    const notification = {
        id: genId(),
        date: new Date().toISOString(),
        priority: item.urgency === 'urgent' || item.urgency === 'high' ? 'high' : 'medium',
        title: `New Agenda Item: ${item.title}`,
        message: `${item.submitter} submitted a new item for the next GC meeting. Review and express interest if relevant to you.`,
        actionLink: 'gc-decisions-section',
        read: false
    };
    const notifications = storage.getNotifications();
    notifications.unshift(notification);
    storage.saveNotifications(notifications);
}
function checkAgendaSubmissionDeadline() {
    return null;
}
function updateAgendaSubmissionNotice() {
    const notice = checkAgendaSubmissionDeadline();
    const noticeEl = document.getElementById('agenda-submission-notice');
    const textEl = document.getElementById('agenda-notice-text');
    if (!noticeEl || !textEl) return;
    if (notice) {
        noticeEl.style.display = 'block';
        textEl.textContent = notice.message;
        if (notice.closed) {
            noticeEl.style.background = '#e74c3c';
        } else {
            noticeEl.style.background = '#f39c12';
        }
    } else {
        noticeEl.style.display = 'none';
    }
}
function viewAgendaSummaryForUpcomingMeeting() {
    const items = storage.getProposedAgendaItems().filter(i => i.status === 'pending' || i.status === 'reviewed');
    if (items.length === 0) {
        showToast('No agenda items to display', 'info');
        return;
    }
    const urgencyOrder = { urgent: 0, high: 1, medium: 2, low: 3 };
    items.sort((a, b) => {
        const urgencyA = urgencyOrder[a.urgency || 'medium'];
        const urgencyB = urgencyOrder[b.urgency || 'medium'];
        if (urgencyA !== urgencyB) return urgencyA - urgencyB;
        const interestA = (a.interestedMembers || []).length;
        const interestB = (b.interestedMembers || []).length;
        return interestB - interestA;
    });
    const totalTime = items.reduce((sum, item) => sum + (item.estimatedTime || 15), 0);
    const itemsList = items.map((item, idx) => `
        <div style="padding: 1rem; background: #2c3e50; border-left: 4px solid ${urgencyOrder[item.urgency || 'medium'] <= 1 ? '#e74c3c' : '#3498db'}; margin-bottom: 0.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div style="flex: 1;">
                    <div style="font-weight: bold; font-size: 1.05rem;">${idx + 1}. ${escapeHtml(item.title)}</div>
                    <div style="font-size: 0.9rem; opacity: 0.8; margin-top: 0.5rem;">${escapeHtml(item.description)}</div>
                    <div style="font-size: 0.85rem; opacity: 0.7; margin-top: 0.5rem;">
                        Submitted by ${escapeHtml(item.submitter)} | ${(item.interestedMembers || []).length} members interested
                    </div>
                </div>
                <div style="text-align: right; min-width: 80px; margin-left: 1rem;">
                    <div style="font-size: 0.9rem; font-weight: bold;">${item.estimatedTime || 15} min</div>
                    <div style="font-size: 0.75rem; opacity: 0.7;">${(item.urgency || 'medium').toUpperCase()}</div>
                </div>
            </div>
        </div>
    `).join('');
    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; overflow-y: auto;';
    modal.innerHTML = `
        <div style="background: #34495e; padding: 2rem; border-radius: 8px; max-width: 900px; width: 90%; max-height: 90vh; overflow-y: auto; margin: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="margin: 0;"><i class="fas fa-clipboard-list"></i> Proposed Agenda for Next Meeting</h3>
                <button onclick="this.closest('div[style*=fixed]').remove()" class="btn secondary">Close</button>
            </div>
            <div style="background: #2c3e50; padding: 1rem; border-radius: 4px; margin-bottom: 1.5rem; display: flex; justify-content: space-around;">
                <div style="text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #3498db;">${items.length}</div>
                    <div style="font-size: 0.85rem; opacity: 0.7;">Agenda Items</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #f39c12;">${totalTime} min</div>
                    <div style="font-size: 0.85rem; opacity: 0.7;">Est. Total Time</div>
                </div>
            </div>
            <div style="margin-bottom: 1rem;">
                <h4 style="margin-bottom: 0.75rem;">Prioritized Agenda (by urgency and interest):</h4>
                ${itemsList}
            </div>
            <div style="padding: 1rem; background: #2c3e50; border-radius: 4px; font-size: 0.9rem; opacity: 0.8;">
                <i class="fas fa-info-circle"></i> This prioritized agenda is based on urgency level and member interest.
                Actual agenda order will be finalized by the facilitator before the meeting.
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}
function updateVotePercentages() {
    const votesFor = parseIntSafe(document.getElementById('gc-votes-for')?.value, 0);
    const votesAgainst = parseIntSafe(document.getElementById('gc-votes-against')?.value, 0);
    const votesAbstain = parseIntSafe(document.getElementById('gc-votes-abstain')?.value, 0);
    const totalVotes = votesFor + votesAgainst + votesAbstain;
    const totalVotesEl = document.getElementById('total-votes');
    if (totalVotesEl) totalVotesEl.textContent = totalVotes;
    const votesForCountEl = document.getElementById('votes-for-count');
    const votesAgainstCountEl = document.getElementById('votes-against-count');
    const votesAbstainCountEl = document.getElementById('votes-abstain-count');
    if (votesForCountEl) votesForCountEl.textContent = votesFor;
    if (votesAgainstCountEl) votesAgainstCountEl.textContent = votesAgainst;
    if (votesAbstainCountEl) votesAbstainCountEl.textContent = votesAbstain;
    if (totalVotes > 0) {
        const percentFor = ((votesFor / totalVotes) * 100).toFixed(1);
        const percentAgainst = ((votesAgainst / totalVotes) * 100).toFixed(1);
        const percentAbstain = ((votesAbstain / totalVotes) * 100).toFixed(1);
        const percentForEl = document.getElementById('percent-for');
        const percentAgainstEl = document.getElementById('percent-against');
        const percentAbstainEl = document.getElementById('percent-abstain');
        if (percentForEl) percentForEl.textContent = percentFor + '%';
        if (percentAgainstEl) percentAgainstEl.textContent = percentAgainst + '%';
        if (percentAbstainEl) percentAbstainEl.textContent = percentAbstain + '%';
        const progressBarFor = document.getElementById('progress-bar-for');
        const progressBarAgainst = document.getElementById('progress-bar-against');
        const progressBarAbstain = document.getElementById('progress-bar-abstain');
        if (progressBarFor) progressBarFor.style.width = percentFor + '%';
        if (progressBarAgainst) progressBarAgainst.style.width = percentAgainst + '%';
        if (progressBarAbstain) progressBarAbstain.style.width = percentAbstain + '%';
    } else {
        const percentForEl = document.getElementById('percent-for');
        const percentAgainstEl = document.getElementById('percent-against');
        const percentAbstainEl = document.getElementById('percent-abstain');
        if (percentForEl) percentForEl.textContent = '0%';
        if (percentAgainstEl) percentAgainstEl.textContent = '0%';
        if (percentAbstainEl) percentAbstainEl.textContent = '0%';
        const progressBarFor = document.getElementById('progress-bar-for');
        const progressBarAgainst = document.getElementById('progress-bar-against');
        const progressBarAbstain = document.getElementById('progress-bar-abstain');
        if (progressBarFor) progressBarFor.style.width = '0%';
        if (progressBarAgainst) progressBarAgainst.style.width = '0%';
        if (progressBarAbstain) progressBarAbstain.style.width = '0%';
    }
    updateQuorumStatus();
}
function updateQuorumStatus() {
    const attendees = document.getElementById('gc-attendees').selectedOptions.length;
    const totalMembers = storage.getMembers().length;
    const settings = storage.getGCSettings();
    const quorumByPercentage = Math.ceil((totalMembers * settings.quorumPercentage) / 100);
    const quorumRequired = Math.max(quorumByPercentage, settings.quorumMinimum);
    const quorumStatus = document.getElementById('quorum-status');
    if (!quorumStatus) return;
    if (attendees >= quorumRequired) {
        quorumStatus.innerHTML = `<strong style="color: #2ecc71;">✓ Quorum Met:</strong> ${attendees} of ${totalMembers} members (${quorumRequired} required)`;
    } else {
        quorumStatus.innerHTML = `<strong style="color: #e74c3c;">✗ No Quorum:</strong> ${attendees} of ${totalMembers} members (${quorumRequired} required)`;
    }
}
function saveGCSettings() {
    const percentage = parseInt(document.getElementById('quorum-percentage').value) || 50;
    const minimum = parseInt(document.getElementById('quorum-minimum').value) || 5;
    if (percentage < 1 || percentage > 100) {
        showToast('Quorum percentage must be between 1 and 100.', 'error');
        return;
    }
    if (minimum < 1) {
        showToast('Minimum quorum must be at least 1.', 'error');
        return;
    }
    storage.saveGCSettings({ quorumPercentage: percentage, quorumMinimum: minimum });
    showToast('GC settings saved successfully!', 'success');
}
function loadGCSettings() {
    const settings = storage.getGCSettings();
    const percentageInput = document.getElementById('quorum-percentage');
    const minimumInput = document.getElementById('quorum-minimum');
    if (percentageInput) percentageInput.value = settings.quorumPercentage;
    if (minimumInput) minimumInput.value = settings.quorumMinimum;
}
function handleActionItemSubmit() {
    const editId = document.getElementById('action-item-edit-id').value;
    if (editId) {
        updateActionItem(editId);
    } else {
        addActionItem();
    }
}
function addActionItem() {
    const description = document.getElementById('action-item-description').value.trim();
    const assignee = document.getElementById('action-item-assignee').value;
    const dueDate = document.getElementById('action-item-due-date').value;
    const priority = document.getElementById('action-item-priority').value;
    const relatedGCId = document.getElementById('action-item-related-gc').value;
    const dependenciesSelect = document.getElementById('action-item-dependencies');
    const dependencies = Array.from(dependenciesSelect.selectedOptions)
        .map(opt => opt.value)
        .filter(v => v !== '');
    if (!description || !assignee || !dueDate) {
        showToast('Please fill in all required fields.', 'error');
        return;
    }
    const actions = storage.getGCActionItems();
    const newAction = {
        id: genId(),
        description,
        assignee,
        dueDate,
        priority,
        relatedGCId,
        dependencies,
        status: 'pending',
        progress: 0,
        createdDate: new Date().toISOString().split('T')[0],
        completedDate: null,
        updates: [],
        reminders: {
            sent7Days: false,
            sent3Days: false,
            sent1Day: false,
            sentOverdue: false
        }
    };
    actions.push(newAction);
    storage.saveGCActionItems(actions);
    addAuditLog('CREATE', 'action-item', newAction.id, assignee, null,
        `Created action item: ${description.substring(0, 50)}`, null);
    showToast('Action item added with automatic reminders enabled!', 'success');
    cancelActionItemEdit();
    updateActionItemsTable();
}
function updateActionItem(id) {
    const actions = storage.getGCActionItems();
    const index = actions.findIndex(a => a.id === id);
    if (index === -1) return;
    const description = document.getElementById('action-item-description').value.trim();
    const assignee = document.getElementById('action-item-assignee').value;
    const dueDate = document.getElementById('action-item-due-date').value;
    const priority = document.getElementById('action-item-priority').value;
    const relatedGCId = document.getElementById('action-item-related-gc').value;
    const dependenciesSelect = document.getElementById('action-item-dependencies');
    const dependencies = Array.from(dependenciesSelect.selectedOptions)
        .map(opt => opt.value)
        .filter(v => v !== '');
    if (!description || !assignee || !dueDate) {
        showToast('Please fill in all required fields.', 'error');
        return;
    }
    const oldAction = {...actions[index]};
    actions[index] = {
        ...actions[index],
        description,
        assignee,
        dueDate,
        priority,
        relatedGCId,
        dependencies
    };
    storage.saveGCActionItems(actions);
    addAuditLog('EDIT', 'action-item', id, assignee, oldAction,
        `Updated action item: ${description.substring(0, 50)}`, null);
    showToast('Action item updated!', 'success');
    cancelActionItemEdit();
    updateActionItemsTable();
}
function cancelActionItemEdit() {
    document.getElementById('action-item-edit-id').value = '';
    document.getElementById('action-item-description').value = '';
    document.getElementById('action-item-assignee').value = '';
    document.getElementById('action-item-due-date').value = '';
    document.getElementById('action-item-priority').value = 'medium';
    document.getElementById('action-item-related-gc').value = '';
    const depsSelect = document.getElementById('action-item-dependencies');
    Array.from(depsSelect.options).forEach(opt => opt.selected = false);
    document.getElementById('action-item-btn').textContent = 'Add Action Item';
    document.getElementById('action-item-cancel-btn').style.display = 'none';
}
function updateActionItemsTable() {
    const tbody = document.getElementById('action-items-body');
    if (!tbody) return;
    tbody.innerHTML = '';
    const showCompleted = document.getElementById('action-item-show-completed')?.checked || false;
    const filterAssignee = document.getElementById('action-item-filter-assignee')?.value || '';
    let actions = storage.getGCActionItems();
    if (!showCompleted) {
        actions = actions.filter(a => a.status !== 'completed');
    }
    if (filterAssignee) {
        actions = actions.filter(a => a.assignee === filterAssignee);
    }
    const priorityOrder = { urgent: 0, high: 1, medium: 2, low: 3 };
    actions.sort((a, b) => {
        const priorityA = priorityOrder[a.priority || 'medium'];
        const priorityB = priorityOrder[b.priority || 'medium'];
        if (priorityA !== priorityB) return priorityA - priorityB;
        return new Date(a.dueDate) - new Date(b.dueDate);
    });
    actions.forEach(action => {
        const tr = document.createElement('tr');
        const today = new Date().toISOString().split('T')[0];
        const isOverdue = action.dueDate < today && action.status !== 'completed';
        const dueDateColor = isOverdue ? '#e74c3c' : '#ecf0f1';
        const priorityColors = {
            urgent: '#e74c3c',
            high: '#f39c12',
            medium: '#3498db',
            low: '#95a5a6'
        };
        const priorityColor = priorityColors[action.priority || 'medium'];
        const priorityBadge = `<span style="display: inline-block; padding: 0.25rem 0.5rem; background: ${priorityColor}; border-radius: 4px; font-size: 0.75rem; font-weight: bold;">${(action.priority || 'medium').toUpperCase()}</span>`;
        const progress = action.progress || 0;
        const progressBar = `
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <div style="flex: 1; background: #2c3e50; border-radius: 10px; height: 20px; overflow: hidden;">
                    <div style="background: ${progress === 100 ? '#2ecc71' : '#3498db'}; width: ${progress}%; height: 100%; transition: width 0.3s;"></div>
                </div>
                <span style="font-size: 0.85rem; min-width: 35px;">${progress}%</span>
            </div>
        `;
        const statusOptions = ['pending', 'in-progress', 'blocked', 'completed']
            .map(s => `<option value="${s}" ${s === action.status ? 'selected' : ''}>${s.charAt(0).toUpperCase() + s.slice(1).replace('-', ' ')}</option>`)
            .join('');
        const isBlocked = checkActionItemBlocked(action);
        const blockedWarning = isBlocked ? '<span style="color: #e74c3c; font-size: 0.8rem;"> (Blocked by dependencies)</span>' : '';
        tr.innerHTML = `
            <td>${priorityBadge}</td>
            <td>
                <div style="font-weight: 500;">${escapeHtml(action.description.substring(0, 50))}${action.description.length > 50 ? '...' : ''}</div>
                ${blockedWarning}
                ${action.dependencies && action.dependencies.length > 0 ? `<div style="font-size: 0.75rem; opacity: 0.7; margin-top: 0.25rem;"><i class="fas fa-link"></i> ${action.dependencies.length} dependency/ies</div>` : ''}
            </td>
            <td>${escapeHtml(action.assignee)}</td>
            <td style="color: ${dueDateColor}; font-weight: ${isOverdue ? 'bold' : 'normal'};">
                ${new Date(action.dueDate).toLocaleDateString()}
                ${isOverdue ? '<br><span style="font-size: 0.8rem;">(OVERDUE)</span>' : ''}
            </td>
            <td onclick="updateActionItemProgress('${escapeAttribute(action.id)}')" style="cursor: pointer;" title="Click to update progress">
                ${progressBar}
            </td>
            <td>
                <select onchange="handleActionItemStatusChange('${escapeAttribute(action.id)}', this.value)" style="background: #34495e; color: #ecf0f1; border: 1px solid #7f8c8d; border-radius: 4px; padding: 0.25rem;">
                    ${statusOptions}
                </select>
            </td>
            <td style="white-space: nowrap;">
                <button class="btn" data-action="view-action-details" data-id="${escapeAttribute(action.id)}" style="margin-right: 5px; font-size: 0.8rem; padding: 0.3rem 0.6rem;">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn" data-action="edit-action" data-id="${escapeAttribute(action.id)}" style="margin-right: 5px; font-size: 0.8rem; padding: 0.3rem 0.6rem;">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn secondary" data-action="delete-action" data-id="${escapeAttribute(action.id)}" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });
    if (actions.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 2rem; opacity: 0.7;">No action items match the current filters.</td></tr>`;
    }
    populateActionItemDropdowns();
    checkAndSendActionItemReminders();
}
function editActionItem(id) {
    const actions = storage.getGCActionItems();
    const action = actions.find(a => a.id === id);
    if (!action) return;
    document.getElementById('action-item-edit-id').value = action.id;
    document.getElementById('action-item-description').value = action.description;
    document.getElementById('action-item-assignee').value = action.assignee;
    document.getElementById('action-item-due-date').value = action.dueDate;
    document.getElementById('action-item-priority').value = action.priority || 'medium';
    document.getElementById('action-item-related-gc').value = action.relatedGCId || '';
    const depsSelect = document.getElementById('action-item-dependencies');
    Array.from(depsSelect.options).forEach(opt => {
        opt.selected = action.dependencies && action.dependencies.includes(opt.value);
    });
    document.getElementById('action-item-btn').textContent = 'Update Action Item';
    document.getElementById('action-item-cancel-btn').style.display = 'inline-block';
    document.getElementById('action-item-description').scrollIntoView({ behavior: 'smooth', block: 'center' });
}
function handleActionItemStatusChange(id, newStatus) {
    if (newStatus === 'completed') {
        openCompletionVerificationModal(id);
    } else {
        updateActionItemStatus(id, newStatus);
    }
}
function updateActionItemStatus(id, newStatus) {
    const actions = storage.getGCActionItems();
    const index = actions.findIndex(a => a.id === id);
    if (index === -1) return;
    const oldStatus = actions[index].status;
    actions[index].status = newStatus;
    if (newStatus === 'completed') {
        actions[index].completedDate = new Date().toISOString().split('T')[0];
        actions[index].progress = 100;
    }
    storage.saveGCActionItems(actions);
    addAuditLog('EDIT', 'action-item', id, actions[index].assignee, { status: oldStatus },
        `Status changed from ${oldStatus} to ${newStatus}`, null);
    showToast('Action item status updated!', 'success');
    updateActionItemsTable();
}
function deleteActionItem(id) {
    const actions = storage.getGCActionItems();
    const action = actions.find(a => a.id === id);
    if (!confirm(`Delete action item: "${action.description.substring(0, 50)}"?`)) return;
    const filtered = actions.filter(a => a.id !== id);
    storage.saveGCActionItems(filtered);
    addAuditLog('DELETE', 'action-item', id, action.assignee, action,
        `Deleted action item: ${action.description.substring(0, 50)}`, null);
    showToast('Action item deleted.', 'info');
    updateActionItemsTable();
}
function populateActionItemDropdowns() {
    const assigneeSelect = document.getElementById('action-item-assignee');
    const relatedGCSelect = document.getElementById('action-item-related-gc');
    const depsSelect = document.getElementById('action-item-dependencies');
    const filterSelect = document.getElementById('action-item-filter-assignee');
    if (assigneeSelect) {
        const currentValue = assigneeSelect.value;
        assigneeSelect.innerHTML = '<option value="">Select member...</option>';
        const members = storage.getMembers().sort((a, b) => a.name.localeCompare(b.name));
        members.forEach(m => {
            const option = document.createElement('option');
            option.value = m.name;
            option.textContent = m.name;
            assigneeSelect.appendChild(option);
        });
        if (currentValue) assigneeSelect.value = currentValue;
    }
    if (filterSelect) {
        const currentValue = filterSelect.value;
        filterSelect.innerHTML = '<option value="">All Assignees</option>';
        const members = storage.getMembers().sort((a, b) => a.name.localeCompare(b.name));
        members.forEach(m => {
            const option = document.createElement('option');
            option.value = m.name;
            option.textContent = m.name;
            filterSelect.appendChild(option);
        });
        if (currentValue) filterSelect.value = currentValue;
    }
    if (relatedGCSelect) {
        const currentValue = relatedGCSelect.value;
        relatedGCSelect.innerHTML = '<option value="">None</option>';
        const gcLogs = storage.getGroupConscienceLog().sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 20);
        gcLogs.forEach(log => {
            const option = document.createElement('option');
            option.value = log.id;
            option.textContent = `${new Date(log.date).toLocaleDateString()} - ${log.item.substring(0, 50)}`;
            relatedGCSelect.appendChild(option);
        });
        if (currentValue) relatedGCSelect.value = currentValue;
    }
    if (depsSelect) {
        const currentEditId = document.getElementById('action-item-edit-id').value;
        const currentValue = Array.from(depsSelect.selectedOptions).map(opt => opt.value);
        depsSelect.innerHTML = '<option value="">None - select other action items this depends on</option>';
        const actions = storage.getGCActionItems().filter(a => a.status !== 'completed' && a.id !== currentEditId);
        actions.forEach(action => {
            const option = document.createElement('option');
            option.value = action.id;
            option.textContent = `${action.description.substring(0, 60)} (${action.assignee})`;
            if (currentValue.includes(action.id)) option.selected = true;
            depsSelect.appendChild(option);
        });
    }
}
function checkActionItemBlocked(action) {
    if (!action.dependencies || action.dependencies.length === 0) return false;
    const actions = storage.getGCActionItems();
    const dependencyActions = actions.filter(a => action.dependencies.includes(a.id));
    return dependencyActions.some(dep => dep.status !== 'completed');
}
function updateActionItemProgress(id) {
    const actions = storage.getGCActionItems();
    const action = actions.find(a => a.id === id);
    if (!action) return;
    const currentProgress = action.progress || 0;
    const newProgress = prompt(`Update progress for:\n"${action.description}"\n\nEnter percentage (0-100):`, currentProgress);
    if (newProgress === null) return;
    const progress = parseInt(newProgress);
    if (isNaN(progress) || progress < 0 || progress > 100) {
        showToast('Please enter a valid percentage (0-100)', 'error');
        return;
    }
    const note = prompt('Add a progress note (optional):', '');
    const index = actions.findIndex(a => a.id === id);
    actions[index].progress = progress;
    if (!actions[index].updates) actions[index].updates = [];
    actions[index].updates.push({
        date: new Date().toISOString(),
        type: 'progress',
        progress: progress,
        note: note || ''
    });
    if (progress === 0 && actions[index].status === 'pending') {
    } else if (progress > 0 && progress < 100 && actions[index].status === 'pending') {
        actions[index].status = 'in-progress';
    } else if (progress === 100 && actions[index].status !== 'completed') {
        if (confirm('Progress is 100%. Mark this action item as completed?')) {
            openCompletionVerificationModal(id);
            return;
        }
    }
    storage.saveGCActionItems(actions);
    showToast(`Progress updated to ${progress}%`, 'success');
    updateActionItemsTable();
}
function openCompletionVerificationModal(id) {
    const actions = storage.getGCActionItems();
    const action = actions.find(a => a.id === id);
    if (!action) return;
    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';
    modal.innerHTML = `
        <div style="background: #34495e; padding: 2rem; border-radius: 8px; max-width: 600px; width: 90%;">
            <h3 style="margin-top: 0;"><i class="fas fa-check-circle" style="color: #2ecc71;"></i> Complete Action Item</h3>
            <div style="background: #2c3e50; padding: 1rem; border-radius: 4px; margin: 1rem 0;">
                <div style="font-weight: bold; margin-bottom: 0.5rem;">${escapeHtml(action.description)}</div>
                <div style="font-size: 0.85rem; opacity: 0.7;">Assigned to: ${escapeHtml(action.assignee)} | Due: ${new Date(action.dueDate).toLocaleDateString()}</div>
            </div>
            <div style="margin: 1.5rem 0;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">
                    Completion Notes / Evidence *
                </label>
                <textarea id="completion-notes" rows="4" placeholder="Describe what was completed and any relevant details..." style="width: 100%; padding: 0.5rem; background: #2c3e50; border: 1px solid #7f8c8d; border-radius: 4px; color: #ecf0f1; font-family: inherit;"></textarea>
                <div style="font-size: 0.85rem; opacity: 0.7; margin-top: 0.25rem;">Required for accountability and future reference</div>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button onclick="this.closest('div[style*=fixed]').remove()" class="btn secondary">Cancel</button>
                <button onclick="completeActionItem('${escapeAttribute(id)}')" class="btn" style="background: #2ecc71;">
                    <i class="fas fa-check"></i> Mark Complete
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    document.getElementById('completion-notes').focus();
}
function completeActionItem(id) {
    const notes = document.getElementById('completion-notes').value.trim();
    if (!notes) {
        showToast('Please provide completion notes for accountability', 'error');
        return;
    }
    const actions = storage.getGCActionItems();
    const index = actions.findIndex(a => a.id === id);
    if (index === -1) return;
    actions[index].status = 'completed';
    actions[index].progress = 100;
    actions[index].completedDate = new Date().toISOString().split('T')[0];
    if (!actions[index].updates) actions[index].updates = [];
    actions[index].updates.push({
        date: new Date().toISOString(),
        type: 'completion',
        note: notes
    });
    storage.saveGCActionItems(actions);
    addAuditLog('EDIT', 'action-item', id, actions[index].assignee, { status: 'in-progress' },
        `Completed action item: ${actions[index].description.substring(0, 50)}`, notes);
    document.querySelectorAll('div[style*="position: fixed"]').forEach(modal => modal.remove());
    showToast('Action item marked as complete!', 'success');
    updateActionItemsTable();
}
function viewActionItemDetails(id) {
    const actions = storage.getGCActionItems();
    const action = actions.find(a => a.id === id);
    if (!action) return;
    const today = new Date().toISOString().split('T')[0];
    const isOverdue = action.dueDate < today && action.status !== 'completed';
    const daysUntilDue = Math.ceil((new Date(action.dueDate) - new Date(today)) / (1000 * 60 * 60 * 24));
    let relatedGCInfo = '';
    if (action.relatedGCId) {
        const gcLog = storage.getGroupConscienceLog().find(log => log.id === action.relatedGCId);
        if (gcLog) {
            relatedGCInfo = `
                <div style="background: #2c3e50; padding: 1rem; border-radius: 4px; margin-top: 1rem;">
                    <div style="font-weight: bold; margin-bottom: 0.5rem;"><i class="fas fa-link"></i> Related GC Motion</div>
                    <div>${escapeHtml(gcLog.item)}</div>
                    <div style="font-size: 0.85rem; opacity: 0.7; margin-top: 0.25rem;">
                        ${new Date(gcLog.date).toLocaleDateString()} - ${gcLog.outcome}
                    </div>
                </div>
            `;
        }
    }
    let depsInfo = '';
    if (action.dependencies && action.dependencies.length > 0) {
        const depActions = actions.filter(a => action.dependencies.includes(a.id));
        const depsList = depActions.map(dep => `
            <div style="padding: 0.5rem; background: ${dep.status === 'completed' ? '#27ae60' : '#e74c3c'}; border-radius: 4px; margin-bottom: 0.5rem;">
                <div style="font-weight: 500;">${escapeHtml(dep.description.substring(0, 60))}</div>
                <div style="font-size: 0.85rem; opacity: 0.9;">Status: ${dep.status} | ${dep.assignee}</div>
            </div>
        `).join('');
        depsInfo = `
            <div style="background: #2c3e50; padding: 1rem; border-radius: 4px; margin-top: 1rem;">
                <div style="font-weight: bold; margin-bottom: 0.5rem;"><i class="fas fa-project-diagram"></i> Dependencies (${depActions.length})</div>
                ${depsList}
            </div>
        `;
    }
    let updatesInfo = '';
    if (action.updates && action.updates.length > 0) {
        const updatesList = action.updates.slice().reverse().map(update => `
            <div style="padding: 0.75rem; background: #2c3e50; border-left: 3px solid #3498db; margin-bottom: 0.5rem;">
                <div style="font-size: 0.85rem; opacity: 0.7;">${new Date(update.date).toLocaleString()}</div>
                <div style="margin-top: 0.25rem;">
                    ${update.type === 'progress' ? `<strong>Progress: ${update.progress}%</strong>` : '<strong>Completed</strong>'}
                </div>
                ${update.note ? `<div style="margin-top: 0.5rem;">${escapeHtml(update.note)}</div>` : ''}
            </div>
        `).join('');
        updatesInfo = `
            <div style="background: #2c3e50; padding: 1rem; border-radius: 4px; margin-top: 1rem;">
                <div style="font-weight: bold; margin-bottom: 0.5rem;"><i class="fas fa-history"></i> Update History (${action.updates.length})</div>
                ${updatesList}
            </div>
        `;
    }
    const priorityColors = { urgent: '#e74c3c', high: '#f39c12', medium: '#3498db', low: '#95a5a6' };
    const priorityColor = priorityColors[action.priority || 'medium'];
    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; overflow-y: auto;';
    modal.innerHTML = `
        <div style="background: #34495e; padding: 2rem; border-radius: 8px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; margin: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1.5rem;">
                <h3 style="margin: 0;"><i class="fas fa-tasks"></i> Action Item Details</h3>
                <button onclick="this.closest('div[style*=fixed]').remove()" class="btn secondary" style="padding: 0.25rem 0.75rem;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div style="background: #2c3e50; padding: 1.5rem; border-radius: 4px; border-left: 4px solid ${priorityColor};">
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                    <span style="display: inline-block; padding: 0.25rem 0.75rem; background: ${priorityColor}; border-radius: 4px; font-size: 0.85rem; font-weight: bold;">
                        ${(action.priority || 'medium').toUpperCase()}
                    </span>
                    <span style="display: inline-block; padding: 0.25rem 0.75rem; background: #7f8c8d; border-radius: 4px; font-size: 0.85rem; font-weight: bold;">
                        ${action.status.toUpperCase()}
                    </span>
                </div>
                <div style="font-size: 1.1rem; font-weight: bold; margin-bottom: 1rem;">${escapeHtml(action.description)}</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.9rem;">
                    <div>
                        <div style="opacity: 0.7;">Assigned To:</div>
                        <div style="font-weight: bold;">${escapeHtml(action.assignee)}</div>
                    </div>
                    <div>
                        <div style="opacity: 0.7;">Due Date:</div>
                        <div style="font-weight: bold; color: ${isOverdue ? '#e74c3c' : '#ecf0f1'};">
                            ${new Date(action.dueDate).toLocaleDateString()}
                            ${isOverdue ? ' (OVERDUE)' : daysUntilDue >= 0 ? ` (${daysUntilDue} days)` : ''}
                        </div>
                    </div>
                    <div>
                        <div style="opacity: 0.7;">Created:</div>
                        <div>${new Date(action.createdDate).toLocaleDateString()}</div>
                    </div>
                    ${action.completedDate ? `
                    <div>
                        <div style="opacity: 0.7;">Completed:</div>
                        <div style="color: #2ecc71;">${new Date(action.completedDate).toLocaleDateString()}</div>
                    </div>
                    ` : ''}
                </div>
                <div style="margin-top: 1rem;">
                    <div style="opacity: 0.7; margin-bottom: 0.5rem;">Progress: ${action.progress || 0}%</div>
                    <div style="background: #1a252f; border-radius: 10px; height: 24px; overflow: hidden;">
                        <div style="background: ${action.progress === 100 ? '#2ecc71' : '#3498db'}; width: ${action.progress || 0}%; height: 100%; transition: width 0.3s;"></div>
                    </div>
                </div>
            </div>
            ${relatedGCInfo}
            ${depsInfo}
            ${updatesInfo}
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                <button onclick="editActionItem('${escapeAttribute(action.id)}'); this.closest('div[style*=fixed]').remove();" class="btn">
                    <i class="fas fa-edit"></i> Edit
                </button>
                ${action.status !== 'completed' ? `
                <button onclick="updateActionItemProgress('${escapeAttribute(action.id)}'); this.closest('div[style*=fixed]').remove();" class="btn" style="background: #3498db;">
                    <i class="fas fa-tasks"></i> Update Progress
                </button>
                <button onclick="openCompletionVerificationModal('${escapeAttribute(action.id)}'); this.closest('div[style*=fixed]').remove();" class="btn" style="background: #2ecc71;">
                    <i class="fas fa-check"></i> Mark Complete
                </button>
                ` : ''}
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}
function checkAndSendActionItemReminders() {
    const actions = storage.getGCActionItems().filter(a => a.status !== 'completed');
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    actions.forEach(action => {
        const dueDate = new Date(action.dueDate);
        dueDate.setHours(0, 0, 0, 0);
        const daysUntilDue = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
        if (!action.reminders) {
            action.reminders = {
                sent7Days: false,
                sent3Days: false,
                sent1Day: false,
                sentOverdue: false
            };
        }
        if (daysUntilDue === 7 && !action.reminders.sent7Days) {
            sendActionItemReminder(action, '7 days');
            action.reminders.sent7Days = true;
        }
        if (daysUntilDue === 3 && !action.reminders.sent3Days) {
            sendActionItemReminder(action, '3 days');
            action.reminders.sent3Days = true;
        }
        if (daysUntilDue === 1 && !action.reminders.sent1Day) {
            sendActionItemReminder(action, '1 day');
            action.reminders.sent1Day = true;
        }
        if (daysUntilDue < 0) {
            const lastSent = action.reminders.lastOverdueReminder;
            const shouldSend = !lastSent || (new Date().toISOString().split('T')[0] !== lastSent);
            if (shouldSend) {
                sendActionItemReminder(action, `${Math.abs(daysUntilDue)} days overdue`);
                action.reminders.lastOverdueReminder = new Date().toISOString().split('T')[0];
            }
        }
    });
    storage.saveGCActionItems(actions);
}
function sendActionItemReminder(action, timeframe) {
    const notification = {
        id: genId(),
        date: new Date().toISOString(),
        priority: timeframe.includes('overdue') ? 'urgent' : 'high',
        title: `Action Item Reminder: ${timeframe}`,
        message: `"${action.description}" assigned to ${action.assignee} - Due: ${new Date(action.dueDate).toLocaleDateString()}`,
        actionLink: 'gc-decisions-section',
        read: false
    };
    const notifications = storage.getNotifications();
    notifications.unshift(notification);
    storage.saveNotifications(notifications);
}
function viewActionItemReport() {
    const actions = storage.getGCActionItems();
    const members = storage.getMembers();
    const metrics = {};
    members.forEach(member => {
        const memberActions = actions.filter(a => a.assignee === member.name);
        const completed = memberActions.filter(a => a.status === 'completed');
        const overdue = memberActions.filter(a => {
            const today = new Date().toISOString().split('T')[0];
            return a.dueDate < today && a.status !== 'completed';
        });
        const inProgress = memberActions.filter(a => a.status === 'in-progress');
        metrics[member.name] = {
            total: memberActions.length,
            completed: completed.length,
            inProgress: inProgress.length,
            overdue: overdue.length,
            completionRate: memberActions.length > 0 ? ((completed.length / memberActions.length) * 100).toFixed(1) : 0
        };
    });
    const totalActions = actions.length;
    const completedActions = actions.filter(a => a.status === 'completed').length;
    const overdueActions = actions.filter(a => {
        const today = new Date().toISOString().split('T')[0];
        return a.dueDate < today && a.status !== 'completed';
    }).length;
    const membersWithActions = Object.entries(metrics).filter(([_, m]) => m.total > 0);
    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; overflow-y: auto;';
    modal.innerHTML = `
        <div style="background: #34495e; padding: 2rem; border-radius: 8px; max-width: 1000px; width: 90%; max-height: 90vh; overflow-y: auto; margin: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="margin: 0;"><i class="fas fa-chart-bar"></i> Action Items Accountability Report</h3>
                <button onclick="this.closest('div[style*=fixed]').remove()" class="btn secondary">Close</button>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                <div style="background: #2c3e50; padding: 1rem; border-radius: 4px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; color: #3498db;">${totalActions}</div>
                    <div style="opacity: 0.7;">Total Action Items</div>
                </div>
                <div style="background: #2c3e50; padding: 1rem; border-radius: 4px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; color: #2ecc71;">${completedActions}</div>
                    <div style="opacity: 0.7;">Completed</div>
                </div>
                <div style="background: #2c3e50; padding: 1rem; border-radius: 4px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; color: #e74c3c;">${overdueActions}</div>
                    <div style="opacity: 0.7;">Overdue</div>
                </div>
                <div style="background: #2c3e50; padding: 1rem; border-radius: 4px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold; color: #f39c12;">${totalActions > 0 ? ((completedActions / totalActions) * 100).toFixed(1) : 0}%</div>
                    <div style="opacity: 0.7;">Completion Rate</div>
                </div>
            </div>
            <h4>Performance by Assignee</h4>
            <table style="width: 100%; margin-top: 1rem;">
                <thead>
                    <tr>
                        <th>Assignee</th>
                        <th>Total</th>
                        <th>Completed</th>
                        <th>In Progress</th>
                        <th>Overdue</th>
                        <th>Completion Rate</th>
                    </tr>
                </thead>
                <tbody>
                    ${membersWithActions.map(([name, m]) => `
                        <tr>
                            <td style="font-weight: bold;">${escapeHtml(name)}</td>
                            <td>${m.total}</td>
                            <td style="color: #2ecc71;">${m.completed}</td>
                            <td style="color: #3498db;">${m.inProgress}</td>
                            <td style="color: ${m.overdue > 0 ? '#e74c3c' : '#ecf0f1'}; font-weight: ${m.overdue > 0 ? 'bold' : 'normal'};">${m.overdue}</td>
                            <td>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <div style="flex: 1; background: #1a252f; border-radius: 10px; height: 20px; overflow: hidden;">
                                        <div style="background: #2ecc71; width: ${m.completionRate}%; height: 100%;"></div>
                                    </div>
                                    <span style="min-width: 45px;">${m.completionRate}%</span>
                                </div>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            <div style="margin-top: 2rem; padding: 1rem; background: #2c3e50; border-radius: 4px; font-size: 0.9rem; opacity: 0.8;">
                <i class="fas fa-info-circle"></i> This report shows action item completion metrics for accountability.
                Use this data during GC meetings to identify bottlenecks and recognize consistent performers.
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}
let currentGCIdForComments = null;
function openGCDetailsModal(id) {
    currentGCIdForComments = id;
    const logs = storage.getGroupConscienceLog();
    const log = logs.find(l => l.id === id);
    if (!log) return;
    const votesFor = log.votesFor || 0;
    const votesAgainst = log.votesAgainst || 0;
    const votesAbstain = log.votesAbstain || 0;
    const totalVotes = votesFor + votesAgainst + votesAbstain;
    let votesDisplay = '';
    if (totalVotes > 0) {
        const percentFor = ((votesFor / totalVotes) * 100).toFixed(1);
        const percentAgainst = ((votesAgainst / totalVotes) * 100).toFixed(1);
        const percentAbstain = ((votesAbstain / totalVotes) * 100).toFixed(1);
        votesDisplay = `
            <div style="margin-top: 1rem;">
                <strong style="display: block; margin-bottom: 0.5rem;">Voting Results (Total: ${totalVotes})</strong>
                <div class="vote-progress-container">
                    <div class="vote-progress-item">
                        <div class="vote-progress-label">
                            <span><strong>For:</strong> ${votesFor}</span>
                            <span>${percentFor}%</span>
                        </div>
                        <div class="vote-progress-bar-bg">
                            <div class="vote-progress-bar-fill for" style="width: ${percentFor}%;"></div>
                        </div>
                    </div>
                    <div class="vote-progress-item">
                        <div class="vote-progress-label">
                            <span><strong>Against:</strong> ${votesAgainst}</span>
                            <span>${percentAgainst}%</span>
                        </div>
                        <div class="vote-progress-bar-bg">
                            <div class="vote-progress-bar-fill against" style="width: ${percentAgainst}%;"></div>
                        </div>
                    </div>
                    <div class="vote-progress-item">
                        <div class="vote-progress-label">
                            <span><strong>Abstain:</strong> ${votesAbstain}</span>
                            <span>${percentAbstain}%</span>
                        </div>
                        <div class="vote-progress-bar-bg">
                            <div class="vote-progress-bar-fill abstain" style="width: ${percentAbstain}%;"></div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else if (log.votes) {
        votesDisplay = `<div style="margin-top: 0.5rem;"><strong>Votes:</strong> ${log.votes}</div>`;
    }
    const attendeesList = Array.isArray(log.attendees) ? log.attendees.join(', ') : (log.attendees || 'N/A');
    const attendeeCount = Array.isArray(log.attendees) ? log.attendees.length : 0;
    const totalMembers = storage.getMembers().length;
    const participationRate = totalMembers > 0 ? ((attendeeCount / totalMembers) * 100).toFixed(1) : 0;
    const detailsContent = document.getElementById('gc-details-content');
    detailsContent.innerHTML = `
        <div style="background: #34495e; padding: 1rem; border-radius: 6px;">
            <div><strong>Date:</strong> ${new Date(log.date).toLocaleDateString()}</div>
            <div style="margin-top: 0.5rem;"><strong>Motion:</strong> ${log.item}</div>
            <div style="margin-top: 0.5rem;"><strong>Submitted By:</strong> ${log.submittedBy || 'N/A'}</div>
            <div style="margin-top: 0.5rem;"><strong>Status:</strong> <span style="color: ${log.status === 'passed' ? '#2ecc71' : log.status === 'failed' ? '#e74c3c' : '#f39c12'};">${log.status.toUpperCase()}</span></div>
            ${votesDisplay}
            <div style="margin-top: 0.5rem;">
                <strong>Members Present:</strong> ${attendeeCount} of ${totalMembers} (${participationRate}% turnout)
                <div style="font-size: 0.85rem; opacity: 0.9; margin-top: 0.25rem;">${attendeesList}</div>
            </div>
        </div>
    `;
    loadGCComments(id);
    const modal = document.getElementById('gc-details-modal');
    if (modal) {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden'; // Prevent background scrolling
    }
}
function closeGCDetailsModal() {
    const modal = document.getElementById('gc-details-modal');
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = ''; // Restore scrolling
    }
    currentGCIdForComments = null;
    const commentText = document.getElementById('gc-comment-text');
    const commentAuthor = document.getElementById('gc-comment-author');
    if (commentText) commentText.value = '';
    if (commentAuthor) commentAuthor.value = '';
}
function loadGCComments(gcId) {
    const commentsList = document.getElementById('gc-comments-list');
    const allComments = storage.getGCComments();
    const comments = allComments.filter(c => c.gcId === gcId).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
    if (comments.length === 0) {
        commentsList.innerHTML = '<div style="text-align: center; opacity: 0.6; padding: 1rem;">No comments yet.</div>';
        return;
    }
    const amendments = comments.filter(c => c.type === 'amendment');
    const otherComments = comments.filter(c => c.type !== 'amendment');
    let html = '';
    if (amendments.length > 0) {
        html += '<div style="margin-bottom: 1.5rem;"><h4 style="color: #f39c12; margin-bottom: 0.75rem;">Amendment History</h4><div class="amendment-timeline">';
        amendments.forEach(amendment => {
            const statusClass = amendment.status || '';
            const statusBadge = amendment.status === 'adopted'
                ? '<span style="background: #2ecc71; color: white; padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.75rem; margin-left: 0.5rem;">ADOPTED</span>'
                : amendment.status === 'rejected'
                ? '<span style="background: #e74c3c; color: white; padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.75rem; margin-left: 0.5rem;">REJECTED</span>'
                : '';
            html += `
                <div class="amendment-item ${statusClass}">
                    <div style="margin-bottom: 0.5rem;">
                        <strong style="color: #f39c12;">${amendment.author}</strong>
                        <span style="font-size: 0.75rem; opacity: 0.7; margin-left: 0.5rem;">${new Date(amendment.timestamp).toLocaleString()}</span>
                        ${statusBadge}
                    </div>
                    <div style="margin-bottom: 0.5rem;">${escapeHtml(amendment.text)}</div>
                    ${!amendment.status ? `
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                            <button class="btn" style="font-size: 0.75rem; padding: 0.3rem 0.6rem;" data-action="update-amendment" data-id="${escapeAttribute(amendment.id)}" data-status="adopted">Mark Adopted</button>
                            <button class="btn secondary" style="font-size: 0.75rem; padding: 0.3rem 0.6rem;" data-action="update-amendment" data-id="${escapeAttribute(amendment.id)}" data-status="rejected">Mark Rejected</button>
                        </div>
                    ` : ''}
                    <button class="btn secondary" style="font-size: 0.75rem; padding: 0.3rem 0.6rem; margin-top: 0.5rem;" data-action="delete-comment" data-id="${escapeAttribute(amendment.id)}">Delete</button>
                </div>
            `;
        });
        html += '</div></div>';
    }
    if (otherComments.length > 0) {
        html += '<div><h4 style="color: #3498db; margin-bottom: 0.75rem;">Discussion & Comments</h4>';
        otherComments.forEach(comment => {
            const typeColors = {
                discussion: '#3498db',
                clarification: '#9b59b6',
                support: '#2ecc71',
                concern: '#e74c3c'
            };
            const typeColor = typeColors[comment.type] || '#7f8c8d';
            html += `
            <div style="background: #2c3e50; padding: 0.75rem; border-radius: 4px; margin-bottom: 0.5rem; border-left: 4px solid ${typeColor};">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                        <strong>${comment.author}</strong>
                        <span style="font-size: 0.8rem; opacity: 0.7; margin-left: 0.5rem;">${new Date(comment.timestamp).toLocaleString()}</span>
                        <span style="background: ${typeColor}; padding: 0.1rem 0.4rem; border-radius: 3px; font-size: 0.7rem; margin-left: 0.5rem;">${comment.type}</span>
                    </div>
                    <button data-action="delete-comment" data-id="${escapeAttribute(comment.id)}" style="background: none; border: none; color: #e74c3c; cursor: pointer; font-size: 1.2rem;">&times;</button>
                </div>
                <div style="margin-top: 0.5rem;">${escapeHtml(comment.text)}</div>
            </div>
        `;
        });
        html += '</div>';
    }
    commentsList.innerHTML = html;
}
function updateAmendmentStatus(amendmentId, status) {
    let comments = storage.getGCComments();
    const comment = comments.find(c => c.id === amendmentId);
    if (comment) {
        comment.status = status;
        storage.saveGCComments(comments);
        showToast(`Amendment marked as ${status}!`, 'success');
        loadGCComments(currentGCIdForComments);
    }
}
function addGCComment() {
    if (!currentGCIdForComments) return;
    const text = document.getElementById('gc-comment-text').value.trim();
    const author = document.getElementById('gc-comment-author').value.trim();
    const type = document.getElementById('gc-comment-type').value;
    if (!text || !author) {
        showToast('Please provide both comment text and your name.', 'error');
        return;
    }
    const comments = storage.getGCComments();
    comments.push({
        id: genId(),
        gcId: currentGCIdForComments,
        text,
        author,
        type,
        timestamp: new Date().toISOString()
    });
    storage.saveGCComments(comments);
    showToast('Comment added!', 'success');
    document.getElementById('gc-comment-text').value = '';
    document.getElementById('gc-comment-author').value = '';
    loadGCComments(currentGCIdForComments);
}
function deleteGCComment(id) {
    if (!confirm('Delete this comment?')) return;
    let comments = storage.getGCComments();
    comments = comments.filter(c => c.id !== id);
    storage.saveGCComments(comments);
    showToast('Comment deleted.', 'info');
    if (currentGCIdForComments) {
        loadGCComments(currentGCIdForComments);
    }
}
let searchGCHistoryTimer = null;
function searchGCHistory() {
    if (searchGCHistoryTimer) {
        clearTimeout(searchGCHistoryTimer);
    }
    searchGCHistoryTimer = setTimeout(() => {
        performGCHistorySearch();
    }, 300);
}
function performGCHistorySearch() {
    const searchText = document.getElementById('gc-search')?.value.toLowerCase() || '';
    const filterStatus = document.getElementById('gc-filter-status')?.value || '';
    const dateFrom = document.getElementById('gc-filter-date-from')?.value || '';
    const dateTo = document.getElementById('gc-filter-date-to')?.value || '';
    let logs = storage.getGroupConscienceLog();
    if (searchText) {
        logs = logs.filter(log =>
            log.item.toLowerCase().includes(searchText) ||
            (log.submittedBy && log.submittedBy.toLowerCase().includes(searchText))
        );
    }
    if (filterStatus) {
        logs = logs.filter(log => log.status === filterStatus);
    }
    if (dateFrom) {
        logs = logs.filter(log => log.date >= dateFrom);
    }
    if (dateTo) {
        logs = logs.filter(log => log.date <= dateTo);
    }
    logs.sort((a, b) => new Date(b.date) - new Date(a.date));
    const tbody = document.getElementById('gc-history-search-body');
    if (!tbody) return;
    while (tbody.firstChild) {
        tbody.removeChild(tbody.firstChild);
    }
    tbody.innerHTML = '';
    if (logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5">No results found.</td></tr>';
        updateGCStatistics();
        return;
    }
    const rows = logs.map(log => {
        const votesFor = log.votesFor || 0;
        const votesAgainst = log.votesAgainst || 0;
        const votesAbstain = log.votesAbstain || 0;
        const votesDisplay = (votesFor || votesAgainst || votesAbstain)
            ? `${votesFor}-${votesAgainst}-${votesAbstain}`
            : (log.votes || 'N/A');
        return `
            <tr>
                <td>${new Date(log.date).toLocaleDateString()}</td>
                <td>${escapeHtml(log.item.substring(0, 60))}${log.item.length > 60 ? '...' : ''}</td>
                <td style="color: ${log.status === 'passed' ? '#2ecc71' : log.status === 'failed' ? '#e74c3c' : '#f39c12'};">${log.status.toUpperCase()}</td>
                <td>${votesDisplay}</td>
                <td>
                    <button class="btn" data-action="view-gc" data-id="${escapeAttribute(log.id)}">View Details</button>
                </td>
            </tr>
        `;
    }).join('');
    tbody.innerHTML = rows;
    updateGCStatistics();
}
function updateGCStatistics() {
    const logs = storage.getGroupConscienceLog();
    const total = logs.length;
    const passed = logs.filter(l => l.status === 'passed').length;
    const failed = logs.filter(l => l.status === 'failed').length;
    const tabled = logs.filter(l => l.status === 'tabled').length;
    const passRate = total > 0 ? ((passed / total) * 100).toFixed(1) : 0;
    document.getElementById('stat-total-motions').textContent = total;
    document.getElementById('stat-passed-motions').textContent = passed;
    document.getElementById('stat-failed-motions').textContent = failed;
    document.getElementById('stat-tabled-motions').textContent = tabled;
    document.getElementById('stat-pass-rate').textContent = passRate + '%';
}
let gcTrendsCharts = {
    monthly: null,
    status: null,
    participation: null
};
function refreshGCTrends() {
    renderMonthlyActivityChart();
    renderStatusDistributionChart();
    renderParticipationTrendChart();
    renderTopTopics();
    populateAnnualReportYears();
}
function renderMonthlyActivityChart() {
    const logs = storage.getGroupConscienceLog();
    const monthCounts = {};
    logs.forEach(log => {
        const date = new Date(log.date);
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        monthCounts[monthKey] = (monthCounts[monthKey] || 0) + 1;
    });
    const sortedMonths = Object.keys(monthCounts).sort();
    const last12Months = sortedMonths.slice(-12);
    const counts = last12Months.map(month => monthCounts[month]);
    const ctx = document.getElementById('gc-trends-monthly-chart');
    if (!ctx) return;
    if (gcTrendsCharts.monthly) {
        gcTrendsCharts.monthly.destroy();
    }
    gcTrendsCharts.monthly = new Chart(ctx, {
        type: 'line',
        data: {
            labels: last12Months.map(m => {
                const [year, month] = m.split('-');
                return new Date(year, month - 1).toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
            }),
            datasets: [{
                label: 'Motions per Month',
                data: counts,
                borderColor: '#3498db',
                backgroundColor: 'rgba(52, 152, 219, 0.2)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { color: '#ecf0f1', stepSize: 1 },
                    grid: { color: 'rgba(127, 140, 141, 0.2)' }
                },
                x: {
                    ticks: { color: '#ecf0f1' },
                    grid: { color: 'rgba(127, 140, 141, 0.2)' }
                }
            }
        }
    });
}
function renderStatusDistributionChart() {
    const logs = storage.getGroupConscienceLog();
    const passed = logs.filter(l => l.status === 'passed').length;
    const failed = logs.filter(l => l.status === 'failed').length;
    const tabled = logs.filter(l => l.status === 'tabled').length;
    const ctx = document.getElementById('gc-trends-status-chart');
    if (!ctx) return;
    if (gcTrendsCharts.status) {
        gcTrendsCharts.status.destroy();
    }
    gcTrendsCharts.status = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Passed', 'Failed', 'Tabled'],
            datasets: [{
                data: [passed, failed, tabled],
                backgroundColor: ['#2ecc71', '#e74c3c', '#f39c12'],
                borderWidth: 2,
                borderColor: '#2c3e50'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { color: '#ecf0f1' }
                }
            }
        }
    });
}
function renderParticipationTrendChart() {
    const logs = storage.getGroupConscienceLog().sort((a, b) => new Date(a.date) - new Date(b.date));
    const last10 = logs.slice(-10);
    const participationData = last10.map(log => {
        const totalVotes = (log.votesFor || 0) + (log.votesAgainst || 0) + (log.votesAbstain || 0);
        return totalVotes;
    });
    const labels = last10.map((log, idx) => `Motion ${idx + 1}`);
    const ctx = document.getElementById('gc-trends-participation-chart');
    if (!ctx) return;
    if (gcTrendsCharts.participation) {
        gcTrendsCharts.participation.destroy();
    }
    gcTrendsCharts.participation = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Total Votes Cast',
                data: participationData,
                backgroundColor: '#3498db',
                borderColor: '#2980b9',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { color: '#ecf0f1', stepSize: 1 },
                    grid: { color: 'rgba(127, 140, 141, 0.2)' }
                },
                x: {
                    ticks: { color: '#ecf0f1' },
                    grid: { color: 'rgba(127, 140, 141, 0.2)' }
                }
            }
        }
    });
}
function renderTopTopics() {
    const logs = storage.getGroupConscienceLog();
    const wordCounts = {};
    const stopWords = new Set(['the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by', 'from', 'is', 'was', 'are', 'were', 'be', 'been', 'being', 'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'should', 'could', 'may', 'might', 'can', 'that', 'this', 'these', 'those', 'we', 'us', 'our']);
    logs.forEach(log => {
        const words = log.item.toLowerCase().split(/\s+/);
        words.forEach(word => {
            const cleaned = word.replace(/[^a-z]/g, '');
            if (cleaned.length > 3 && !stopWords.has(cleaned)) {
                wordCounts[cleaned] = (wordCounts[cleaned] || 0) + 1;
            }
        });
    });
    const topWords = Object.entries(wordCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);
    const container = document.getElementById('gc-top-topics');
    if (!container) return;
    if (topWords.length === 0) {
        container.innerHTML = '<p style="opacity: 0.7;">No topic data available yet.</p>';
        return;
    }
    container.innerHTML = topWords.map(([word, count]) => `
        <div style="padding: 0.5rem; margin-bottom: 0.5rem; background: #2c3e50; border-radius: 4px; display: flex; justify-content: space-between;">
            <span style="text-transform: capitalize;">${word}</span>
            <span style="background: #3498db; padding: 0.2rem 0.6rem; border-radius: 3px; font-weight: bold;">${count}</span>
        </div>
    `).join('');
}
function populateAnnualReportYears() {
    const logs = storage.getGroupConscienceLog();
    const years = new Set();
    logs.forEach(log => {
        const year = new Date(log.date).getFullYear();
        years.add(year);
    });
    const currentYear = new Date().getFullYear();
    years.add(currentYear);
    const select = document.getElementById('annual-report-year');
    if (!select) return;
    select.innerHTML = Array.from(years)
        .sort((a, b) => b - a)
        .map(year => `<option value="${year}">${year}</option>`)
        .join('');
}
function generateAnnualReport() {
    const year = parseInt(document.getElementById('annual-report-year').value);
    if (!year) {
        showToast('Please select a year.', 'error');
        return;
    }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const logs = storage.getGroupConscienceLog().filter(log => {
        return new Date(log.date).getFullYear() === year;
    });
    if (logs.length === 0) {
        showToast(`No GC data found for ${year}.`, 'error');
        return;
    }
    doc.setFontSize(20);
    doc.text(`Group Conscience Annual Report - ${year}`, 14, 22);
    doc.setFontSize(14);
    doc.text('Annual Summary', 14, 35);
    doc.setFontSize(11);
    const passed = logs.filter(l => l.status === 'passed').length;
    const failed = logs.filter(l => l.status === 'failed').length;
    const tabled = logs.filter(l => l.status === 'tabled').length;
    const passRate = logs.length > 0 ? ((passed / logs.length) * 100).toFixed(1) : 0;
    let yPos = 45;
    doc.text(`Total Motions: ${logs.length}`, 14, yPos);
    yPos += 7;
    doc.text(`Passed: ${passed}`, 14, yPos);
    yPos += 7;
    doc.text(`Failed: ${failed}`, 14, yPos);
    yPos += 7;
    doc.text(`Tabled: ${tabled}`, 14, yPos);
    yPos += 7;
    doc.text(`Pass Rate: ${passRate}%`, 14, yPos);
    yPos += 12;
    doc.setFontSize(14);
    doc.text('Motion Details', 14, yPos);
    yPos += 5;
    const tableData = logs.map(log => [
        new Date(log.date).toLocaleDateString(),
        log.item.substring(0, 50) + (log.item.length > 50 ? '...' : ''),
        log.status.toUpperCase(),
        `${log.votesFor || 0}-${log.votesAgainst || 0}-${log.votesAbstain || 0}`
    ]);
    doc.autoTable({
        startY: yPos,
        head: [['Date', 'Motion', 'Status', 'Votes (F-A-Ab)']],
        body: tableData,
        theme: 'grid',
        headStyles: { fillColor: [52, 152, 219] },
        styles: { fontSize: 9 }
    });
    const pageCount = doc.internal.getNumberOfPages();
    doc.setFontSize(10);
    for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.text(`Page ${i} of ${pageCount}`, doc.internal.pageSize.width / 2, doc.internal.pageSize.height - 10, { align: 'center' });
        doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, doc.internal.pageSize.height - 10);
    }
    doc.save(`GC_Annual_Report_${year}.pdf`);
    showToast(`Annual report for ${year} downloaded successfully!`, 'success');
}
function checkUpcomingGCMeetings() {
    const logs = storage.getGroupConscienceLog();
    if (logs.length === 0) return;
    const sortedLogs = logs.sort((a, b) => new Date(b.date) - new Date(a.date));
    const lastGCDate = new Date(sortedLogs[0].date);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const daysSinceLastGC = Math.floor((today - lastGCDate) / (1000 * 60 * 60 * 24));
    if (daysSinceLastGC >= 25 && daysSinceLastGC < 40) {
        const daysUntilNext = 30 - daysSinceLastGC;
        if (daysUntilNext > 0) {
            showNotificationBanner(`Group Conscience meeting coming up in approximately ${daysUntilNext} days!`, 'info');
        } else {
            showNotificationBanner(`Group Conscience meeting may be overdue! Last meeting was ${daysSinceLastGC} days ago.`, 'warning');
        }
    }
    const proposedItems = storage.getProposedAgendaItems().filter(item => item.status === 'pending');
    if (proposedItems.length > 0) {
        showNotificationBanner(`${proposedItems.length} proposed agenda item(s) pending for next GC meeting.`, 'info');
    }
    const actionItems = storage.getGCActionItems().filter(item => item.status !== 'completed');
    const overdueActions = actionItems.filter(item => {
        if (!item.dueDate) return false;
        return new Date(item.dueDate) < today;
    });
    if (overdueActions.length > 0) {
        showNotificationBanner(`${overdueActions.length} GC action item(s) are overdue!`, 'urgent');
    }
}
function showNotificationBanner(message, type = 'info') {
    const sessionKey = `notification_shown_${message}`;
    if (sessionStorage.getItem(sessionKey)) {
        return; // Don't show duplicate notifications in same session
    }
    const banner = document.createElement('div');
    banner.style.cssText = `
        position: fixed;
        top: 60px;
        left: 50%;
        transform: translateX(-50%);
        background: ${type === 'urgent' ? '#e74c3c' : type === 'warning' ? '#f39c12' : '#3498db'};
        color: white;
        padding: 1rem 2rem;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 1000;
        max-width: 600px;
        text-align: center;
        animation: slideDown 0.3s ease;
    `;
    banner.innerHTML = `
        <div style="display: flex; align-items: center; gap: 1rem;">
            <i class="fas fa-bell" style="font-size: 1.2rem;"></i>
            <span>${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; margin-left: 1rem;">&times;</button>
        </div>
    `;
    document.body.appendChild(banner);
    sessionStorage.setItem(sessionKey, 'true');
    setTimeout(() => {
        if (banner.parentElement) {
            banner.style.animation = 'slideUp 0.3s ease';
            setTimeout(() => banner.remove(), 300);
        }
    }, 10000);
}
function requestNotificationPermission() {
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
                showToast('Browser notifications enabled!', 'success');
            }
        });
    }
}
function showBrowserNotification(title, message) {
    if ('Notification' in window && Notification.permission === 'granted') {
        new Notification(title, {
            body: message,
            icon: 'logo.svg',
            badge: 'logo.svg'
        });
    }
}
function exportChairpersonLogToPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const log = storage.getChairpersonLog().sort((a, b) => new Date(a.date) - new Date(b.date));
    if (log.length === 0) {
        showToast('No log entries to export.', 'error');
        return;
    }
    doc.setFontSize(18);
    doc.text("Chairperson's Contribution Log", 14, 22);
    const tableColumn = ["Date", "Time", "Chairperson", "Head Count", "7th Tradition ($)", "Orange Can ($)"];
    const tableRows = [];
    log.forEach(entry => {
        const timeStr = entry.time ? new Date('1970-01-01T' + entry.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'N/A';
        const logData = [
            new Date(entry.date).toLocaleDateString(),
            timeStr,
            entry.chairperson || 'N/A',
            entry.headcount,
            entry.tradition.toFixed(2),
            entry.orangeCan.toFixed(2)
        ];
        tableRows.push(logData);
    });
    doc.autoTable({
        head: [tableColumn],
        body: tableRows,
        startY: 30,
    });
    doc.save('Chairperson_Log_Report.pdf');
    showToast('PDF export generated!', 'success');
}
function exportGroupConscienceLogToPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const logs = storage.getGroupConscienceLog().sort((a, b) => new Date(a.date) - new Date(b.date));
    if (logs.length === 0) {
        showToast('No Group Conscience entries to export.', 'error');
        return;
    }
    doc.setFontSize(18);
    doc.text("Group Conscience Log", 14, 22);
    let y = 30;
    logs.forEach((log, index) => {
        if (y > 260) {
            doc.addPage();
            y = 20;
        }
        doc.setFontSize(14);
        doc.text(`Date: ${new Date(log.date).toLocaleDateString()}`, 14, y);
        y += 7;
        doc.setFontSize(12);
        doc.text(`Motion/Item: ${log.item}`, 14, y);
        y += 7;
        doc.text(`Submitted By: ${log.submittedBy}`, 14, y);
        y += 7;
        doc.text(`Status: ${log.status}`, 14, y);
        y += 7;
        const votesDisplay = `Votes: For=${log.votesFor || 0}, Against=${log.votesAgainst || 0}, Abstain=${log.votesAbstain || 0}`;
        doc.text(votesDisplay, 14, y);
        y += 7;
        doc.text("Members Present:", 14, y);
        y += 7;
        const attendeesText = Array.isArray(log.attendees) ? log.attendees.join(', ') : (log.attendees || '');
        const attendees = doc.splitTextToSize(attendeesText, 180);
        doc.text(attendees, 14, y);
        y += attendees.length * 5;
        doc.text("Servant Reports:", 14, y);
        y += 7;
        let reportsText = '';
        if (log.servantReports && Array.isArray(log.servantReports) && log.servantReports.length > 0) {
            reportsText = log.servantReports.map(r => `${r.servantName}:\n${r.report}`).join('\n\n');
        } else if (log.servantReports && typeof log.servantReports === 'string') {
            reportsText = log.servantReports;
        } else {
            reportsText = 'No reports submitted.';
        }
        const reports = doc.splitTextToSize(reportsText, 180);
        doc.text(reports, 14, y);
        y += reports.length * 5;
        if (index < logs.length - 1) {
            doc.line(14, y, 200, y); // Separator line
            y += 10;
        }
    });
    doc.save('Group_Conscience_Log.pdf');
    showToast('PDF export generated!', 'success');
}
function exportData(dataType) {
    let data;
    let filename = 'rowlett_group_data.json';
    if (dataType === 'all') {
        data = {
            events: storage.getEvents(),
            members: storage.getMembers(),
            announcements: storage.getAnnouncements(),
            photos: storage.getPhotos(),
            chairpersonLog: storage.getChairpersonLog(),
            groupConscienceLog: storage.getGroupConscienceLog(),
            liveGCItems: storage.getLiveGCItems(),
            proposedAgendaItems: storage.getProposedAgendaItems(),
            gcComments: storage.getGCComments(),
            gcActionItems: storage.getGCActionItems(),
            gcSettings: storage.getGCSettings(),
            messages: storage.getMessages(),
            servicePositions: storage.getServicePositions(),
            nominations: storage.getNominations(),
            budgetCategories: storage.getBudgetCategories(),
            expenses: storage.getExpenses(),
            templates: storage.getTemplates(),
            votingSettings: storage.getVotingSettings(),
            literatureInventory: storage.getLiteratureInventory(),
            literatureLoans: storage.getLiteratureLoans(),
            serviceElections: storage.getServiceElections(),
            electionBallots: storage.getElectionBallots(),
            speakingQueue: storage.getSpeakingQueue(),
            motionTemplates: storage.getMotionTemplates(),
            traditionChecks: storage.getTraditionChecks(),
            budgetProposals: storage.getBudgetProposals(),
            districtMotions: storage.getDistrictMotions(),
            groupPositions: storage.getGroupPositions(),
            quorumRules: storage.getQuorumRules(),
            meetingMinutes: storage.getMeetingMinutes(),
            inventorySchedules: storage.getInventorySchedules(),
            decisionImpacts: storage.getDecisionImpacts(),
            participationData: storage.getParticipationData(),
            userRole: storage.getUserRole(),
            educationalProgress: storage.getEducationalProgress(),
            privacySettings: storage.getPrivacySettings(),
            accessLevels: storage.getAccessLevels(),
            traditionOfDay: storage.getTraditionOfDay(),
            spiritualPrinciples: storage.getSpiritualPrinciples(),
            unityChecks: storage.getUnityChecks(),
            minorityOpinions: storage.getMinorityOpinions(),
            serviceStructure: storage.getServiceStructure(),
            standingAgendaItems: storage.getStandingAgendaItems(),
            tabledMotions: storage.getTabledMotions(),
            motionAmendments: storage.getMotionAmendments(),
            discussionThreads: storage.getDiscussionThreads(),
            emailSettings: storage.getEmailSettings(),
            emailHistory: storage.getEmailHistory(),
            memberVotingRecords: storage.getMemberVotingRecords(),
            implementationTracking: storage.getImplementationTracking(),
            consentAgendaItems: storage.getConsentAgendaItems(),
            consentHistory: storage.getConsentHistory(),
            reconsiderationRequests: storage.getReconsiderationRequests(),
            calendarEvents: storage.getCalendarEvents(),
            roiCalculations: storage.getROICalculations(),
            proxyVotes: storage.getProxyVotes(),
            decisionReversals: storage.getDecisionReversals(),
            areaMotions: storage.getAreaMotions(),
            assemblyAgendas: storage.getAssemblyAgendas(),
            irMeetings: storage.getIRMeetings(),
            hotlineShifts: storage.getHotlineShifts(),
            specialEvents: storage.getSpecialEvents(),
            piActivities: storage.getPIActivities(),
            facilities: storage.getFacilities(),
            hiPanels: storage.getHIPanels(),
            memberCertifications: storage.getMemberCertifications(),
            professionals: storage.getProfessionals(),
            presentations: storage.getPresentations(),
            btgReferrals: storage.getBTGReferrals(),
            mediaContacts: storage.getMediaContacts(),
            pressReleases: storage.getPressReleases(),
            outreachEvents: storage.getOutreachEvents(),
            outreachLogs: storage.getOutreachLogs(),
            treatmentFacilities: storage.getTreatmentFacilities(),
            bridgingCommitments: storage.getBridgingCommitments(),
            followUps: storage.getFollowUps(),
            correctionsFacilities: storage.getCorrectionsFacilities(),
            correctionsClearances: storage.getCorrectionsClearances(),
            preReleaseContacts: storage.getPreReleaseContacts(),
            correspondenceLog: storage.getCorrespondenceLog(),
            eventsMgmt: storage.getEventsMgmt(),
            speakers: storage.getSpeakers(),
            eventVolunteers: storage.getEventVolunteers(),
            eventExpenses: storage.getEventExpenses(),
            ticketSales: storage.getTicketSales(),
            archiveDocuments: storage.getArchiveDocuments(),
            interviews: storage.getInterviews(),
            translators: storage.getTranslators(),
            languageMaterials: storage.getLanguageMaterials(),
            interpreters: storage.getInterpreters(),
            interpreterSchedule: storage.getInterpreterSchedule(),
            captionSetup: storage.getCaptionSetup(),
            chairRulings: storage.getChairRulings(),
            rulesSuspensions: storage.getRulesSuspensions(),
            dividedQuestions: storage.getDividedQuestions(),
            parliamentaryInquiries: storage.getParliamentaryInquiries(),
            exportDate: new Date().toISOString(),
            version: '6.0'
        };
        const dateStr = new Date().toISOString().split('T')[0];
        filename = `rowlett-group-backup-${dateStr}.json`;
    } else {
        const dataMap = {
            events: storage.getEvents,
            members: storage.getMembers,
            birthdays: storage.getMembers, // Members contain birthday info
            announcements: storage.getAnnouncements,
            photos: storage.getPhotos,
            chairpersonLog: storage.getChairpersonLog,
            groupConscienceLog: storage.getGroupConscienceLog
        };
        if (dataMap[dataType]) {
            data = { [dataType]: dataMap[dataType]() };
            filename = `rowlett_group_${dataType}.json`;
        } else {
            showToast('Invalid data type for export.', 'error');
            return;
        }
    }
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
    showToast('Data exported successfully!', 'success');
}
function importData() {
    const fileInput = document.getElementById('import-file');
    const file = fileInput.files[0];
    if (!file) {
        showToast('Please select a file to import.', 'error');
        return;
    }
    if (file.size > 50 * 1024 * 1024) {
        showToast('File is too large (max 50MB). Please contact support.', 'error');
        return;
    }
    if (!file.name.endsWith('.json')) {
        showToast('Please select a valid JSON backup file.', 'error');
        return;
    }
    if (!confirm('⚠️ IMPORTANT: This will overwrite ALL existing data!\n\nMake sure you have a current backup before proceeding.\n\nContinue with import?')) {
        return;
    }
    const reader = new FileReader();
    reader.onerror = function() {
        showToast('Failed to read file. Please try again.', 'error');
    };
    reader.onload = function(event) {
        try {
            const data = JSON.parse(event.target.result);
            if (!data.version || !data.exportDate) {
                if (!confirm('This backup file may be from an older version or corrupted.\n\nAttempt to import anyway?')) {
                    return;
                }
            }
            let imported = false;
            if (data.events) { storage.saveEvents(data.events); imported = true; }
            if (data.members) { storage.saveMembers(data.members); imported = true; }
            if (data.birthdays) { storage.saveBirthdays(data.birthdays); imported = true; }
            if (data.announcements) { storage.saveAnnouncements(data.announcements); imported = true; }
            if (data.photos) { storage.savePhotos(data.photos); imported = true; }
            if (data.chairpersonLog) { storage.saveChairpersonLog(data.chairpersonLog); imported = true; }
            if (data.groupConscienceLog) { storage.saveGroupConscienceLog(data.groupConscienceLog); imported = true; }
            if (data.liveGCItems) { storage.saveLiveGCItems(data.liveGCItems); imported = true; }
            if (data.proposedAgendaItems) { storage.saveProposedAgendaItems(data.proposedAgendaItems); imported = true; }
            if (data.gcComments) { storage.saveGCComments(data.gcComments); imported = true; }
            if (data.gcActionItems) { storage.saveGCActionItems(data.gcActionItems); imported = true; }
            if (data.gcSettings) { storage.saveGCSettings(data.gcSettings); imported = true; }
            if (data.messages) { storage.saveMessages(data.messages); imported = true; }
            if (data.servicePositions) { storage.saveServicePositions(data.servicePositions); imported = true; }
            if (data.nominations) { storage.saveNominations(data.nominations); imported = true; }
            if (data.budgetCategories) { storage.saveBudgetCategories(data.budgetCategories); imported = true; }
            if (data.expenses) { storage.saveExpenses(data.expenses); imported = true; }
            if (data.templates) { storage.saveTemplates(data.templates); imported = true; }
            if (data.votingSettings) { storage.saveVotingSettings(data.votingSettings); imported = true; }
            if (data.literatureInventory) { storage.saveLiteratureInventory(data.literatureInventory); imported = true; }
            if (data.literatureLoans) { storage.saveLiteratureLoans(data.literatureLoans); imported = true; }
            if (data.serviceElections) { storage.saveServiceElections(data.serviceElections); imported = true; }
            if (data.electionBallots) { storage.saveElectionBallots(data.electionBallots); imported = true; }
            if (data.speakingQueue) { storage.saveSpeakingQueue(data.speakingQueue); imported = true; }
            if (data.motionTemplates) { storage.saveMotionTemplates(data.motionTemplates); imported = true; }
            if (data.traditionChecks) { storage.saveTraditionChecks(data.traditionChecks); imported = true; }
            if (data.budgetProposals) { storage.saveBudgetProposals(data.budgetProposals); imported = true; }
            if (data.districtMotions) { storage.saveDistrictMotions(data.districtMotions); imported = true; }
            if (data.groupPositions) { storage.saveGroupPositions(data.groupPositions); imported = true; }
            if (data.quorumRules) { storage.saveQuorumRules(data.quorumRules); imported = true; }
            if (data.meetingMinutes) { storage.saveMeetingMinutes(data.meetingMinutes); imported = true; }
            if (data.inventorySchedules) { storage.saveInventorySchedules(data.inventorySchedules); imported = true; }
            if (data.decisionImpacts) { storage.saveDecisionImpacts(data.decisionImpacts); imported = true; }
            if (data.participationData) { storage.saveParticipationData(data.participationData); imported = true; }
            if (data.userRole) { storage.saveUserRole(data.userRole); imported = true; }
            if (data.educationalProgress) { storage.saveEducationalProgress(data.educationalProgress); imported = true; }
            if (data.privacySettings) { storage.savePrivacySettings(data.privacySettings); imported = true; }
            if (data.accessLevels) { storage.saveAccessLevels(data.accessLevels); imported = true; }
            if (data.traditionOfDay) { storage.saveTraditionOfDay(data.traditionOfDay); imported = true; }
            if (data.spiritualPrinciples) { storage.saveSpiritualPrinciples(data.spiritualPrinciples); imported = true; }
            if (data.unityChecks) { storage.saveUnityChecks(data.unityChecks); imported = true; }
            if (data.minorityOpinions) { storage.saveMinorityOpinions(data.minorityOpinions); imported = true; }
            if (data.serviceStructure) { storage.saveServiceStructure(data.serviceStructure); imported = true; }
            if (data.standingAgendaItems) { storage.saveStandingAgendaItems(data.standingAgendaItems); imported = true; }
            if (data.tabledMotions) { storage.saveTabledMotions(data.tabledMotions); imported = true; }
            if (data.motionAmendments) { storage.saveMotionAmendments(data.motionAmendments); imported = true; }
            if (data.discussionThreads) { storage.saveDiscussionThreads(data.discussionThreads); imported = true; }
            if (data.emailSettings) { storage.saveEmailSettings(data.emailSettings); imported = true; }
            if (data.emailHistory) { storage.saveEmailHistory(data.emailHistory); imported = true; }
            if (data.memberVotingRecords) { storage.saveMemberVotingRecords(data.memberVotingRecords); imported = true; }
            if (data.implementationTracking) { storage.saveImplementationTracking(data.implementationTracking); imported = true; }
            if (data.consentAgendaItems) { storage.saveConsentAgendaItems(data.consentAgendaItems); imported = true; }
            if (data.consentHistory) { storage.saveConsentHistory(data.consentHistory); imported = true; }
            if (data.reconsiderationRequests) { storage.saveReconsiderationRequests(data.reconsiderationRequests); imported = true; }
            if (data.calendarEvents) { storage.saveCalendarEvents(data.calendarEvents); imported = true; }
            if (data.roiCalculations) { storage.saveROICalculations(data.roiCalculations); imported = true; }
            if (data.proxyVotes) { storage.saveProxyVotes(data.proxyVotes); imported = true; }
            if (data.decisionReversals) { storage.saveDecisionReversals(data.decisionReversals); imported = true; }
            if (data.areaMotions) { storage.saveAreaMotions(data.areaMotions); imported = true; }
            if (data.assemblyAgendas) { storage.saveAssemblyAgendas(data.assemblyAgendas); imported = true; }
            if (data.irMeetings) { storage.saveIRMeetings(data.irMeetings); imported = true; }
            if (data.hotlineShifts) { storage.saveHotlineShifts(data.hotlineShifts); imported = true; }
            if (data.specialEvents) { storage.saveSpecialEvents(data.specialEvents); imported = true; }
            if (data.piActivities) { storage.savePIActivities(data.piActivities); imported = true; }
            if (data.facilities) { storage.saveFacilities(data.facilities); imported = true; }
            if (data.hiPanels) { storage.saveHIPanels(data.hiPanels); imported = true; }
            if (data.memberCertifications) { storage.saveMemberCertifications(data.memberCertifications); imported = true; }
            if (data.professionals) { storage.saveProfessionals(data.professionals); imported = true; }
            if (data.presentations) { storage.savePresentations(data.presentations); imported = true; }
            if (data.btgReferrals) { storage.saveBTGReferrals(data.btgReferrals); imported = true; }
            if (data.mediaContacts) { storage.saveMediaContacts(data.mediaContacts); imported = true; }
            if (data.pressReleases) { storage.savePressReleases(data.pressReleases); imported = true; }
            if (data.outreachEvents) { storage.saveOutreachEvents(data.outreachEvents); imported = true; }
            if (data.outreachLogs) { storage.saveOutreachLogs(data.outreachLogs); imported = true; }
            if (data.treatmentFacilities) { storage.saveTreatmentFacilities(data.treatmentFacilities); imported = true; }
            if (data.bridgingCommitments) { storage.saveBridgingCommitments(data.bridgingCommitments); imported = true; }
            if (data.followUps) { storage.saveFollowUps(data.followUps); imported = true; }
            if (data.correctionsFacilities) { storage.saveCorrectionsFacilities(data.correctionsFacilities); imported = true; }
            if (data.correctionsClearances) { storage.saveCorrectionsClearances(data.correctionsClearances); imported = true; }
            if (data.preReleaseContacts) { storage.savePreReleaseContacts(data.preReleaseContacts); imported = true; }
            if (data.correspondenceLog) { storage.saveCorrespondenceLog(data.correspondenceLog); imported = true; }
            if (data.eventsMgmt) { storage.saveEventsMgmt(data.eventsMgmt); imported = true; }
            if (data.speakers) { storage.saveSpeakers(data.speakers); imported = true; }
            if (data.eventVolunteers) { storage.saveEventVolunteers(data.eventVolunteers); imported = true; }
            if (data.eventExpenses) { storage.saveEventExpenses(data.eventExpenses); imported = true; }
            if (data.ticketSales) { storage.saveTicketSales(data.ticketSales); imported = true; }
            if (data.archiveDocuments) { storage.saveArchiveDocuments(data.archiveDocuments); imported = true; }
            if (data.interviews) { storage.saveInterviews(data.interviews); imported = true; }
            if (data.translators) { storage.saveTranslators(data.translators); imported = true; }
            if (data.languageMaterials) { storage.saveLanguageMaterials(data.languageMaterials); imported = true; }
            if (data.interpreters) { storage.saveInterpreters(data.interpreters); imported = true; }
            if (data.interpreterSchedule) { storage.saveInterpreterSchedule(data.interpreterSchedule); imported = true; }
            if (data.captionSetup) { storage.saveCaptionSetup(data.captionSetup); imported = true; }
            if (data.chairRulings) { storage.saveChairRulings(data.chairRulings); imported = true; }
            if (data.rulesSuspensions) { storage.saveRulesSuspensions(data.rulesSuspensions); imported = true; }
            if (data.dividedQuestions) { storage.saveDividedQuestions(data.dividedQuestions); imported = true; }
            if (data.parliamentaryInquiries) { storage.saveParliamentaryInquiries(data.parliamentaryInquiries); imported = true; }
            if (imported) {
                localStorage.setItem('lastImportDate', new Date().toISOString());
                showToast('✓ Data imported successfully! The page will reload in 2 seconds...', 'success');
                setTimeout(() => location.reload(), 2000);
            } else {
                showToast('The selected file does not contain valid data to import.', 'error');
            }
        } catch (e) {
            showToast('❌ Failed to import: ' + (e.message || 'Invalid JSON format'), 'error');
            console.error('Import error:', e);
        }
    };
    reader.readAsText(file);
}
function checkAndPromptBackup() {
    try {
        const lastBackup = localStorage.getItem('lastBackupDate');
        const lastBackupDate = lastBackup ? new Date(lastBackup) : null;
        const now = new Date();
        if (!lastBackupDate || (now - lastBackupDate) / (1000 * 60 * 60 * 24) >= 7) {
            const daysSinceBackup = lastBackupDate ?
                Math.floor((now - lastBackupDate) / (1000 * 60 * 60 * 24)) : 'never';
            if (confirm(`⚠️ BACKUP REMINDER\n\nLast backup: ${daysSinceBackup === 'never' ? 'Never' : daysSinceBackup + ' days ago'}\n\nWould you like to create a backup now?\n\nRecommended: Backup every 7 days to prevent data loss.`)) {
                quickBackup();
            }
        }
    } catch (e) {
        console.error('Backup check error:', e);
    }
}
function quickBackup() {
    try {
        exportData('all');
        localStorage.setItem('lastBackupDate', new Date().toISOString());
        showToast('✓ Backup created successfully! Keep this file safe.', 'success');
    } catch (e) {
        showToast('❌ Backup failed: ' + e.message, 'error');
        console.error('Backup error:', e);
    }
}
function autoSaveToSession() {
    try {
        const criticalData = {
            timestamp: new Date().toISOString(),
            members: storage.getMembers(),
            groupConscienceLog: storage.getGroupConscienceLog(),
            chairpersonLog: storage.getChairpersonLog()
        };
        sessionStorage.setItem('autoSaveBackup', JSON.stringify(criticalData));
    } catch (e) {
        console.warn('Auto-save failed:', e);
    }
}
function checkCrashRecovery() {
    try {
        const autoSave = sessionStorage.getItem('autoSaveBackup');
        if (autoSave) {
            const data = JSON.parse(autoSave);
            const saveTime = new Date(data.timestamp);
            const minutesAgo = (new Date() - saveTime) / 1000 / 60;
            if (minutesAgo < 60) {
                if (confirm(`🔄 CRASH RECOVERY AVAILABLE\n\nAuto-saved data found from ${minutesAgo.toFixed(0)} minutes ago.\n\nWould you like to restore it?`)) {
                    if (data.members) storage.saveMembers(data.members);
                    if (data.groupConscienceLog) storage.saveGroupConscienceLog(data.groupConscienceLog);
                    if (data.chairpersonLog) storage.saveChairpersonLog(data.chairpersonLog);
                    showToast('✓ Data restored from auto-save', 'success');
                    sessionStorage.removeItem('autoSaveBackup');
                    return true;
                }
            }
        }
    } catch (e) {
        console.error('Crash recovery check failed:', e);
    }
    return false;
}
function resetApplication() {
    if (!confirm('⚠️ WARNING: This will permanently delete ALL application data!\n\nThis includes:\n• All members and birthdays\n• All events and meetings\n• All financial records\n• All Group Conscience logs\n• All photos and announcements\n• ALL other data\n\nAre you absolutely sure you want to continue?')) {
        return;
    }
    const confirmText = prompt('This action CANNOT be undone!\n\nTo confirm, type "DELETE ALL DATA" exactly:');
    if (confirmText !== 'DELETE ALL DATA') {
        showToast('Reset cancelled.', 'info');
        return;
    }
    try {
        localStorage.clear();
        sessionStorage.clear();
        showToast('All application data has been deleted. The page will now reload.', 'success');
        setTimeout(() => {
            location.reload();
        }, 2000);
    } catch (e) {
        showToast('Error resetting application: ' + e.message, 'error');
        console.error('Reset error:', e);
    }
}
function updateGallery() {
    const grid = document.getElementById('gallery-grid');
    const filterInput = document.getElementById('tag-filter');
    const filterValue = filterInput.value.toLowerCase().trim();
    grid.innerHTML = '';
    const photos = storage.getPhotos();
    const filteredPhotos = filterValue ? photos.filter(p => p.tags.some(tag => tag.toLowerCase().includes(filterValue))) : photos;
    filteredPhotos.forEach((photo, idx) => {
        const originalIndex = photos.findIndex(p => p.src === photo.src); // Find original index for deletion
        const wrapper = document.createElement('div');
        wrapper.style.position = 'relative';
        const img = document.createElement('img');
        img.src = photo.src;
        img.onclick = () => openModal(idx, filteredPhotos);
        wrapper.appendChild(img);
        const delBtn = document.createElement('button');
        delBtn.innerHTML = '<i class="fas fa-trash"></i>';
        delBtn.style.position = 'absolute';
        delBtn.style.top = '5px';
        delBtn.style.right = '5px';
        delBtn.style.background = 'rgba(0,0,0,0.7)';
        delBtn.style.color = 'white';
        delBtn.style.border = 'none';
        delBtn.style.borderRadius = '50%';
        delBtn.style.width = '30px';
        delBtn.style.height = '30px';
        delBtn.style.lineHeight = '30px';
        delBtn.style.textAlign = 'center';
        delBtn.style.cursor = 'pointer';
        delBtn.style.fontSize = '14px';
        delBtn.onclick = (e) => {
            e.stopPropagation(); // Prevent modal from opening
            deletePhoto(originalIndex);
        };
        wrapper.appendChild(delBtn);
        grid.appendChild(wrapper);
    });
    if (filteredPhotos.length === 0) {
        grid.innerHTML = '<p>No photos match the filter.</p>';
    }
    renderTagList();
}
function renderTagList() {
    const tagList = document.getElementById('tag-list');
    const photos = storage.getPhotos();
    const allTags = [...new Set(photos.flatMap(p => p.tags))]; // Get unique tags
    tagList.innerHTML = '';
    allTags.forEach(tag => {
        const tagEl = document.createElement('span');
        tagEl.className = 'btn secondary';
        tagEl.textContent = tag;
        tagEl.style.marginRight = '0.5rem';
        tagEl.style.marginBottom = '0.5rem';
        tagEl.style.cursor = 'pointer';
        tagEl.onclick = () => setTagFilter(tag);
        tagList.appendChild(tagEl);
    });
}
function setTagFilter(tag) {
    const filterInput = document.getElementById('tag-filter');
    filterInput.value = tag;
    updateGallery();
}
function updateHome() {
    const homeEvents = document.getElementById('home-upcoming-events');
    homeEvents.innerHTML = '';
    const occ = computeUpcomingOccurrences(30);
    occ.slice(0, 5).forEach(item => {
        const li = document.createElement('li');
        li.textContent = `${item.occurDate.toLocaleDateString()} ${item.occurDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} — ${item.event.title}`;
        homeEvents.appendChild(li);
    });
    if (occ.length === 0) {
        homeEvents.innerHTML = '<li>No upcoming events</li>';
    }
    const homeBirthdays = document.getElementById('home-upcoming-birthdays');
    homeBirthdays.innerHTML = '';
    const allMembers = storage.getMembers();
    const membersInWindow = getAnniversariesInWindow(allMembers, 15, 60);
    const now = new Date();
    now.setHours(0,0,0,0);
    if (membersInWindow.length > 0) {
        membersInWindow.forEach(m => {
            const li = document.createElement('li');
            const years = m.displayDate.getFullYear() - new Date(m.birthday).getFullYear();
            li.textContent = `${m.name} — ${m.displayDate.toLocaleDateString()} (${years} years)`;
            if (m.displayDate < now) {
                li.style.backgroundColor = '#6b5d2f'; // Muted yellow/gold
                li.style.padding = '2px 4px';
                li.style.borderRadius = '3px';
            }
            homeBirthdays.appendChild(li);
        });
    } else {
        homeBirthdays.innerHTML = '<li>No recent or upcoming birthdays.</li>';
    }
    const homeAnnouncements = document.getElementById('home-recent-announcements');
    homeAnnouncements.innerHTML = '';
    const activeAnnouncements = storage.getAnnouncements().filter(a => a.active).slice(0, 3);
    activeAnnouncements.forEach(a => {
        const li = document.createElement('li');
        const dateStr = new Date(a.dateCreated).toLocaleDateString();
        li.textContent = `${dateStr}: ${a.text}`;
        homeAnnouncements.appendChild(li);
    });
    if (activeAnnouncements.length === 0) {
        homeAnnouncements.innerHTML = '<li>No active announcements</li>';
    }
    const homePhotos = document.getElementById('home-latest-photos');
    homePhotos.innerHTML = '';
    const allPhotos = storage.getPhotos();
    const recentPhotos = allPhotos.slice(-Math.min(3, allPhotos.length)).reverse();
    recentPhotos.forEach(photo => {
        const img = document.createElement('img');
        img.src = photo.src;
        img.style.height = '60px';
        img.style.width = 'auto';
        img.style.borderRadius = '4px';
        img.style.cursor = 'pointer';
        const originalIndex = allPhotos.findIndex(p => p.src === photo.src);
        img.onclick = () => openModal(originalIndex, allPhotos);
        homePhotos.appendChild(img);
    });
    if (allPhotos.length === 0) {
        homePhotos.innerHTML = '<span>No photos yet</span>';
    }
    updateUnifiedDashboard();
}
function updateUnifiedDashboard() {
    updateAttentionItems();
    updateUpcomingTimeline();
    updateActivityFeed();
    updateGroupHealthMetrics();
}
function updateAttentionItems() {
    const attentionItems = [];
    const today = new Date();
    const positions = storage.getServicePositions();
    positions.forEach(pos => {
        if (!pos.startDate || !pos.termLength || !pos.currentHolder) return;
        const termMonths = pos.termLength === 'Indefinite' ? 0 : parseInt(pos.termLength.split(' ')[0]);
        if (termMonths === 0) return;
        const endDate = new Date(pos.startDate);
        endDate.setMonth(endDate.getMonth() + termMonths);
        const daysUntilEnd = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
        if (daysUntilEnd > 0 && daysUntilEnd <= 30) {
            attentionItems.push({
                type: 'service-term',
                priority: daysUntilEnd <= 14 ? 'urgent' : 'high',
                title: `${pos.name} term expires in ${daysUntilEnd} days`,
                actionFn: 'goToSection(\'service-positions-section\')',
                actionText: 'Plan Succession'
            });
        }
    });
    const gcLogs = storage.getGroupConscienceLog();
    const tabledMotions = gcLogs.filter(log => log.status === 'tabled');
    if (tabledMotions.length > 0) {
        attentionItems.push({
            type: 'tabled-motion',
            priority: 'normal',
            title: `${tabledMotions.length} tabled motion(s) need resolution`,
            actionFn: 'goToSection(\'gc-decisions-section\')',
            actionText: 'Review Motions'
        });
    }
    const actionItems = storage.getGCActionItems();
    const pastDue = actionItems.filter(item => {
        return item.status !== 'completed' && new Date(item.dueDate) < today;
    });
    if (pastDue.length > 0) {
        attentionItems.push({
            type: 'action-item',
            priority: 'urgent',
            title: `${pastDue.length} action item(s) past due`,
            actionFn: 'goToSection(\'gc-decisions-section\')',
            actionText: 'Update Status'
        });
    }
    const balance = parseFloat(localStorage.getItem('treasurerBalance')) || 0;
    const expenses = storage.getExpenses();
    const threeMonthsAgo = new Date();
    threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
    const recentExpenses = expenses.filter(e => new Date(e.date) >= threeMonthsAgo);
    const avgMonthlyExpenses = recentExpenses.reduce((sum, e) => sum + e.amount, 0) / 3;
    const prudentReserve = avgMonthlyExpenses * 3;
    if (balance < prudentReserve && prudentReserve > 0) {
        attentionItems.push({
            type: 'prudent-reserve',
            priority: 'high',
            title: `Prudent reserve below target ($${(prudentReserve - balance).toFixed(2)} short)`,
            actionFn: 'goToSection(\'prudent-reserve-section\')',
            actionText: 'View Details'
        });
    }
    const minutes = storage.getMeetingMinutes();
    const unapproved = minutes.filter(m => m.status !== 'approved');
    if (unapproved.length > 0) {
        attentionItems.push({
            type: 'minutes',
            priority: 'normal',
            title: `${unapproved.length} meeting minute(s) need approval`,
            actionFn: 'goToSection(\'meeting-minutes-section\')',
            actionText: 'Review & Approve'
        });
    }
    const container = document.getElementById('attention-items');
    if (attentionItems.length === 0) {
        container.innerHTML = '<p style="color: #2ecc71; padding: 1rem; text-align: center;"><i class="fas fa-check-circle"></i> All caught up! No items need immediate attention.</p>';
    } else {
        container.innerHTML = attentionItems.map(item => {
            const priorityColor = item.priority === 'urgent' ? '#e74c3c' : item.priority === 'high' ? '#f39c12' : '#3498db';
            return `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #2c3e50; border-radius: 4px; margin-bottom: 0.5rem; border-left: 4px solid ${priorityColor};">
                    <div style="flex: 1;">
                        <div style="font-weight: bold; color: ${priorityColor};">${escapeHtml(item.title)}</div>
                        <div style="font-size: 0.85rem; opacity: 0.7; margin-top: 0.25rem;">${escapeHtml(item.type.replace('-', ' ').toUpperCase())}</div>
                    </div>
                    <button class="btn" onclick="${item.actionFn}" style="background: ${priorityColor}; white-space: nowrap;">
                        ${escapeHtml(item.actionText)}
                    </button>
                </div>
            `;
        }).join('');
    }
}
function updateUpcomingTimeline() {
    const container = document.getElementById('upcoming-timeline');
    const timeline = [];
    const today = new Date();
    const thirtyDaysFromNow = new Date(today);
    thirtyDaysFromNow.setDate(today.getDate() + 30);
    const events = storage.getEvents();
    events.forEach(event => {
        if (event.date) {
            const eventDate = new Date(event.date + 'T' + (event.time || '00:00'));
            if (eventDate >= today && eventDate <= thirtyDaysFromNow) {
                timeline.push({
                    date: eventDate,
                    type: 'Event',
                    icon: 'fa-calendar',
                    title: event.title,
                    color: '#3498db'
                });
            }
        }
    });
    const positions = storage.getServicePositions();
    positions.forEach(pos => {
        if (pos.startDate && pos.termLength && pos.termLength !== 'Indefinite') {
            const endDate = new Date(pos.startDate);
            const termMonths = parseInt(pos.termLength.split(' ')[0]);
            endDate.setMonth(endDate.getMonth() + termMonths);
            if (endDate >= today && endDate <= thirtyDaysFromNow) {
                timeline.push({
                    date: endDate,
                    type: 'Service Term End',
                    icon: 'fa-users-cog',
                    title: `${pos.name} term expires`,
                    color: '#e74c3c'
                });
            }
        }
    });
    timeline.sort((a, b) => a.date - b.date);
    if (timeline.length === 0) {
        container.innerHTML = '<p style="padding: 1rem; text-align: center; opacity: 0.7;">No upcoming events in the next 30 days</p>';
    } else {
        container.innerHTML = timeline.map(item => `
            <div style="display: flex; align-items: center; padding: 0.75rem; background: #2c3e50; border-radius: 4px; margin-bottom: 0.5rem; border-left: 3px solid ${item.color};">
                <i class="fas ${item.icon}" style="font-size: 1.5rem; color: ${item.color}; margin-right: 1rem;"></i>
                <div style="flex: 1;">
                    <div style="font-weight: bold;">${escapeHtml(item.title)}</div>
                    <div style="font-size: 0.85rem; opacity: 0.7;">${item.date.toLocaleDateString()} • ${item.type}</div>
                </div>
            </div>
        `).join('');
    }
}
function updateActivityFeed() {
    const container = document.getElementById('activity-feed');
    const activities = [];
    const auditEntries = getAuditHistory(null, null, 10);
    auditEntries.forEach(entry => {
        let icon = 'fa-circle';
        let color = '#3498db';
        if (entry.action === 'create') {
            icon = 'fa-plus-circle';
            color = '#2ecc71';
        } else if (entry.action === 'edit') {
            icon = 'fa-edit';
            color = '#f39c12';
        } else if (entry.action === 'delete') {
            icon = 'fa-trash';
            color = '#e74c3c';
        }
        activities.push({
            timestamp: new Date(entry.timestamp),
            icon: icon,
            color: color,
            text: `${entry.user} ${entry.action}d ${entry.entityType}`,
            details: entry.reason || ''
        });
    });
    if (activities.length === 0) {
        container.innerHTML = '<p style="padding: 1rem; text-align: center; opacity: 0.7;">No recent activity</p>';
    } else {
        container.innerHTML = activities.map(activity => `
            <div style="display: flex; align-items: start; padding: 0.5rem; margin-bottom: 0.5rem;">
                <i class="fas ${activity.icon}" style="font-size: 1rem; color: ${activity.color}; margin-right: 0.75rem; margin-top: 0.25rem;"></i>
                <div style="flex: 1;">
                    <div style="font-size: 0.95rem;">${escapeHtml(activity.text)}</div>
                    <div style="font-size: 0.8rem; opacity: 0.6;">${activity.timestamp.toLocaleString()}</div>
                </div>
            </div>
        `).join('');
    }
}
function updateGroupHealthMetrics() {
    calculateParticipationRate();
    calculateConsensusRate();
    calculateActionCompletionRate();
    calculateServiceFilledRate();
    calculatePrudentReserveStatus();
    calculateAverageAttendance();
    updateHealthTrends();
}
function calculateParticipationRate() {
    const members = storage.getMembers();
    const gcLogs = storage.getGroupConscienceLog();
    const threeMonthsAgo = new Date();
    threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
    const recentGCs = gcLogs.filter(log => new Date(log.date) >= threeMonthsAgo);
    if (recentGCs.length === 0 || members.length === 0) {
        document.getElementById('participation-rate').textContent = 'N/A';
        return;
    }
    const uniqueParticipants = new Set();
    recentGCs.forEach(log => {
        if (Array.isArray(log.attendees)) {
            log.attendees.forEach(name => uniqueParticipants.add(name));
        }
    });
    const participationRate = ((uniqueParticipants.size / members.length) * 100).toFixed(0);
    document.getElementById('participation-rate').textContent = participationRate + '%';
}
function calculateConsensusRate() {
    const gcLogs = storage.getGroupConscienceLog();
    const threeMonthsAgo = new Date();
    threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
    const recentDecisions = gcLogs.filter(log =>
        new Date(log.date) >= threeMonthsAgo && log.outcome === 'passed'
    );
    if (recentDecisions.length === 0) {
        document.getElementById('consensus-rate').textContent = 'N/A';
        return;
    }
    const consensusDecisions = recentDecisions.filter(log => {
        const votesFor = log.votesFor || 0;
        const votesAgainst = log.votesAgainst || 0;
        const totalVotes = votesFor + votesAgainst;
        if (totalVotes === 0) return false;
        const percentFor = (votesFor / totalVotes) * 100;
        return percentFor >= 66.7; // Substantial unanimity (2/3)
    });
    const consensusRate = ((consensusDecisions.length / recentDecisions.length) * 100).toFixed(0);
    document.getElementById('consensus-rate').textContent = consensusRate + '%';
}
function calculateActionCompletionRate() {
    const actions = storage.getGCActionItems();
    const threeMonthsAgo = new Date();
    threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
    const recentActions = actions.filter(action =>
        new Date(action.createdDate) >= threeMonthsAgo
    );
    if (recentActions.length === 0) {
        document.getElementById('action-completion-rate').textContent = 'N/A';
        return;
    }
    const completedOnTime = recentActions.filter(action => {
        if (action.status !== 'completed' || !action.completedDate) return false;
        const dueDate = new Date(action.dueDate);
        const completedDate = new Date(action.completedDate);
        return completedDate <= dueDate;
    });
    const completionRate = ((completedOnTime.length / recentActions.length) * 100).toFixed(0);
    document.getElementById('action-completion-rate').textContent = completionRate + '%';
}
function calculateServiceFilledRate() {
    const positions = storage.getServicePositions();
    if (positions.length === 0) {
        document.getElementById('service-filled-rate').textContent = 'N/A';
        return;
    }
    const filledPositions = positions.filter(pos => pos.currentHolder && pos.currentHolder.trim() !== '');
    const filledRate = ((filledPositions.length / positions.length) * 100).toFixed(0);
    document.getElementById('service-filled-rate').textContent = filledRate + '%';
}
function calculatePrudentReserveStatus() {
    const balance = parseFloat(localStorage.getItem('treasurerBalance')) || 0;
    const expenses = storage.getExpenses();
    const threeMonthsAgo = new Date();
    threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
    const recentExpenses = expenses.filter(exp => new Date(exp.date) >= threeMonthsAgo);
    const totalExpenses = recentExpenses.reduce((sum, exp) => sum + exp.amount, 0);
    const monthlyAverage = totalExpenses / 3;
    if (monthlyAverage === 0) {
        document.getElementById('prudent-reserve-status').textContent = 'N/A';
        return;
    }
    const monthsOfReserve = balance / monthlyAverage;
    const statusEl = document.getElementById('prudent-reserve-status');
    if (monthsOfReserve >= 3) {
        statusEl.textContent = 'Healthy';
        statusEl.style.color = '#2ecc71';
    } else if (monthsOfReserve >= 2) {
        statusEl.textContent = 'Fair';
        statusEl.style.color = '#f39c12';
    } else {
        statusEl.textContent = 'Low';
        statusEl.style.color = '#e74c3c';
    }
}
function calculateAverageAttendance() {
    const chairpersonLogs = storage.getChairpersonLog();
    const threeMonthsAgo = new Date();
    threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
    const recentLogs = chairpersonLogs.filter(log => new Date(log.date) >= threeMonthsAgo);
    if (recentLogs.length === 0) {
        document.getElementById('avg-attendance').textContent = 'N/A';
        return;
    }
    const totalAttendance = recentLogs.reduce((sum, log) => sum + (log.attendance || 0), 0);
    const average = Math.round(totalAttendance / recentLogs.length);
    document.getElementById('avg-attendance').textContent = average;
}
function updateHealthTrends() {
    const container = document.getElementById('health-trends');
    const trends = [];
    const members = storage.getMembers().length;
    const gcLogs = storage.getGroupConscienceLog();
    const actions = storage.getGCActionItems();
    const positions = storage.getServicePositions();
    const lastMonth = new Date();
    lastMonth.setMonth(lastMonth.getMonth() - 1);
    const recentGCs = gcLogs.filter(log => new Date(log.date) >= lastMonth).length;
    if (recentGCs === 0) {
        trends.push({
            icon: 'fa-exclamation-triangle',
            color: '#e74c3c',
            text: 'No GC meetings in the last month - Consider scheduling one',
            action: 'goToSection(\'gc-decisions-section\')',
            actionText: 'Schedule GC'
        });
    } else if (recentGCs >= 2) {
        trends.push({
            icon: 'fa-check-circle',
            color: '#2ecc71',
            text: `${recentGCs} GC meeting(s) held last month - Strong group conscience activity`,
            action: null,
            actionText: null
        });
    }
    const today = new Date().toISOString().split('T')[0];
    const overdueActions = actions.filter(a => a.dueDate < today && a.status !== 'completed').length;
    if (overdueActions > 0) {
        trends.push({
            icon: 'fa-tasks',
            color: '#e74c3c',
            text: `${overdueActions} action item(s) overdue - Follow-through needed`,
            action: 'goToSection(\'gc-decisions-section\')',
            actionText: 'View Actions'
        });
    }
    const vacantPositions = positions.filter(p => !p.currentHolder || p.currentHolder.trim() === '');
    if (vacantPositions.length > 0) {
        trends.push({
            icon: 'fa-user-tie',
            color: '#f39c12',
            text: `${vacantPositions.length} service position(s) vacant - ${vacantPositions.map(p => p.name).join(', ')}`,
            action: 'goToSection(\'service-positions-section\')',
            actionText: 'Fill Positions'
        });
    }
    const balance = parseFloat(localStorage.getItem('treasurerBalance')) || 0;
    const expenses = storage.getExpenses();
    const threeMonthsAgo = new Date();
    threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
    const recentExpenses = expenses.filter(exp => new Date(exp.date) >= threeMonthsAgo);
    const totalExpenses = recentExpenses.reduce((sum, exp) => sum + exp.amount, 0);
    const monthlyAverage = totalExpenses / 3;
    const monthsOfReserve = monthlyAverage > 0 ? balance / monthlyAverage : 0;
    if (monthsOfReserve < 2) {
        trends.push({
            icon: 'fa-dollar-sign',
            color: '#e74c3c',
            text: `Prudent reserve below 2 months - Current: ${monthsOfReserve.toFixed(1)} months`,
            action: 'goToSection(\'finance-section\')',
            actionText: 'Review Finances'
        });
    }
    if (trends.length === 0) {
        container.innerHTML = '<p style="padding: 1rem; text-align: center; color: #2ecc71;"><i class="fas fa-check-circle"></i> All health indicators looking good!</p>';
    } else {
        container.innerHTML = trends.map(trend => `
            <div style="display: flex; align-items: center; padding: 0.75rem; background: #2c3e50; border-radius: 4px; margin-bottom: 0.5rem; border-left: 4px solid ${trend.color};">
                <i class="fas ${trend.icon}" style="font-size: 1.2rem; color: ${trend.color}; margin-right: 1rem;"></i>
                <div style="flex: 1; font-size: 0.95rem;">${escapeHtml(trend.text)}</div>
                ${trend.action ? `<button class="btn" onclick="${trend.action}" style="background: ${trend.color}; white-space: nowrap; margin-left: 1rem; font-size: 0.85rem; padding: 0.4rem 0.8rem;">${trend.actionText}</button>` : ''}
            </div>
        `).join('');
    }
}
function viewDetailedHealthReport() {
    const members = storage.getMembers();
    const gcLogs = storage.getGroupConscienceLog();
    const actions = storage.getGCActionItems();
    const positions = storage.getServicePositions();
    const expenses = storage.getExpenses();
    const chairpersonLogs = storage.getChairpersonLog();
    const threeMonthsAgo = new Date();
    threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
    const recentGCs = gcLogs.filter(log => new Date(log.date) >= threeMonthsAgo);
    const uniqueParticipants = new Set();
    recentGCs.forEach(log => {
        if (Array.isArray(log.attendees)) {
            log.attendees.forEach(name => uniqueParticipants.add(name));
        }
    });
    const inactiveMembers = members.filter(m => !uniqueParticipants.has(m.name));
    const recentExpenses = expenses.filter(exp => new Date(exp.date) >= threeMonthsAgo);
    const totalExpenses = recentExpenses.reduce((sum, exp) => sum + exp.amount, 0);
    const monthlyAverage = totalExpenses / 3;
    const balance = parseFloat(localStorage.getItem('treasurerBalance')) || 0;
    const recentAttendance = chairpersonLogs.filter(log => new Date(log.date) >= threeMonthsAgo);
    const avgAttendance = recentAttendance.length > 0 ?
        Math.round(recentAttendance.reduce((sum, log) => sum + (log.attendance || 0), 0) / recentAttendance.length) : 0;
    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; overflow-y: auto;';
    modal.innerHTML = `
        <div style="background: #34495e; padding: 2rem; border-radius: 8px; max-width: 1000px; width: 90%; max-height: 90vh; overflow-y: auto; margin: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="margin: 0;"><i class="fas fa-heartbeat"></i> Detailed Group Health Report</h3>
                <button onclick="this.closest('div[style*=fixed]').remove()" class="btn secondary">Close</button>
            </div>
            <div style="background: #2c3e50; padding: 1.5rem; border-radius: 4px; border-left: 4px solid #2ecc71; margin-bottom: 1.5rem;">
                <h4 style="margin-top: 0;">Executive Summary (Last 3 Months)</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <div style="opacity: 0.7; font-size: 0.85rem;">Total Members:</div>
                        <div style="font-size: 1.2rem; font-weight: bold;">${members.length}</div>
                    </div>
                    <div>
                        <div style="opacity: 0.7; font-size: 0.85rem;">GC Meetings Held:</div>
                        <div style="font-size: 1.2rem; font-weight: bold;">${recentGCs.length}</div>
                    </div>
                    <div>
                        <div style="opacity: 0.7; font-size: 0.85rem;">Active Participants:</div>
                        <div style="font-size: 1.2rem; font-weight: bold;">${uniqueParticipants.size} (${members.length > 0 ? ((uniqueParticipants.size / members.length) * 100).toFixed(0) : 0}%)</div>
                    </div>
                    <div>
                        <div style="opacity: 0.7; font-size: 0.85rem;">Avg. Attendance:</div>
                        <div style="font-size: 1.2rem; font-weight: bold;">${avgAttendance} members/meeting</div>
                    </div>
                    <div>
                        <div style="opacity: 0.7; font-size: 0.85rem;">Current Balance:</div>
                        <div style="font-size: 1.2rem; font-weight: bold;">$${balance.toFixed(2)}</div>
                    </div>
                    <div>
                        <div style="opacity: 0.7; font-size: 0.85rem;">Prudent Reserve:</div>
                        <div style="font-size: 1.2rem; font-weight: bold;">${monthlyAverage > 0 ? (balance / monthlyAverage).toFixed(1) : 'N/A'} months</div>
                    </div>
                </div>
            </div>
            ${inactiveMembers.length > 0 ? `
            <div style="background: #2c3e50; padding: 1.5rem; border-radius: 4px; border-left: 4px solid #f39c12; margin-bottom: 1.5rem;">
                <h4 style="margin-top: 0;"><i class="fas fa-exclamation-triangle"></i> Inactive Members (${inactiveMembers.length})</h4>
                <div style="opacity: 0.9;">
                    ${inactiveMembers.slice(0, 10).map(m => `<span style="display: inline-block; padding: 0.25rem 0.5rem; background: #34495e; border-radius: 4px; margin: 0.25rem;">${escapeHtml(m.name)}</span>`).join('')}
                    ${inactiveMembers.length > 10 ? `<span style="opacity: 0.7;">... and ${inactiveMembers.length - 10} more</span>` : ''}
                </div>
                <div style="margin-top: 0.75rem; font-size: 0.9rem; opacity: 0.8;">
                    <i class="fas fa-info-circle"></i> Consider reaching out to these members to encourage participation
                </div>
            </div>
            ` : ''}
            <div style="background: #2c3e50; padding: 1.5rem; border-radius: 4px; border-left: 4px solid #3498db;">
                <h4 style="margin-top: 0;"><i class="fas fa-lightbulb"></i> Recommendations</h4>
                <ul style="margin: 0; padding-left: 1.5rem;">
                    ${uniqueParticipants.size < members.length * 0.5 ? '<li>Participation below 50% - Consider more engaging topics or different meeting times</li>' : ''}
                    ${monthlyAverage > 0 && balance / monthlyAverage < 2 ? '<li>Prudent reserve below recommended 3 months - Increase 7th tradition emphasis</li>' : ''}
                    ${positions.filter(p => !p.currentHolder).length > 0 ? '<li>Fill vacant service positions to ensure group sustainability</li>' : ''}
                    ${recentGCs.length === 0 ? '<li>No GC meetings in last 3 months - Schedule regular group conscience</li>' : ''}
                    ${recentGCs.length > 0 && recentGCs.length < 3 ? '<li>Consider holding monthly GC meetings for better group health</li>' : ''}
                </ul>
            </div>
            <div style="margin-top: 1.5rem; padding: 1rem; background: #2c3e50; border-radius: 4px; font-size: 0.9rem; opacity: 0.8;">
                <i class="fas fa-info-circle"></i> This report analyzes the last 3 months of group data.
                Regular review of these metrics helps maintain a healthy, functioning group.
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}
function showHistory(id) {
    document.querySelectorAll('.history-content').forEach(sec => sec.classList.remove('active'));
    const target = document.getElementById(id);
    if (target) target.classList.add('active');
    document.querySelectorAll('.history-nav button').forEach(btn => btn.classList.remove('active'));
    if (id === 'genesis-history') document.getElementById('genesis-btn').classList.add('active');
    if (id === 'dfw-history') document.getElementById('dfw-btn').classList.add('active');
    if (id === 'rowlett-history') document.getElementById('rowlett-btn').classList.add('active');
}
const categoryColors = {
    "General": "#7f8c8d",
    "Open Discussion": "#2ecc71",
    "Closed Discussion": "#e74c3c",
    "Big Book Study": "#f1c40f",
    "12x12 Study": "#9b59b6",
    "Personal Story": "#1abc9c",
    "Foundations Speaker": "#d35400",
    "Birthday Night": "#e67e22"
};
let currentMonthDate = new Date();
currentMonthDate.setDate(1);
function renderCalendar() {
    const grid = document.getElementById('calendar-grid');
    if (!grid) return;
    grid.innerHTML = '';
    const year = currentMonthDate.getFullYear();
    const month = currentMonthDate.getMonth();
    const monthName = currentMonthDate.toLocaleString('default', { month: 'long', year: 'numeric' });
    document.getElementById('calendar-month-year').textContent = monthName;
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    dayNames.forEach(name => {
        const div = document.createElement('div');
        div.className = 'calendar-day-name';
        div.textContent = name;
        grid.appendChild(div);
    });
    for (let i = 0; i < firstDay; i++) {
        const blank = document.createElement('div');
        blank.className = 'calendar-day';
        blank.style.visibility = 'hidden';
        grid.appendChild(blank);
    }
    for (let d = 1; d <= daysInMonth; d++) {
        const date = new Date(year, month, d);
        const cell = document.createElement('div');
        cell.className = 'calendar-day';
        const num = document.createElement('div');
        num.className = 'calendar-day-number';
        num.textContent = d;
        cell.appendChild(num);
        const events = storage.getEvents();
        events.forEach(ev => {
            let occurs = false;
            if (ev.date) {
                if (ev.date === date.toISOString().substring(0,10)) occurs = true;
            } else if (ev.dayOfWeek !== null && ev.dayOfWeek !== undefined) {
                if (date.getDay() === ev.dayOfWeek) occurs = true;
            }
            if (occurs) {
                const evEl = document.createElement('div');
                evEl.className = 'calendar-event';
                evEl.textContent = ev.title;
                evEl.style.borderLeftColor = categoryColors[ev.category] || categoryColors['General'];
                const tooltip = document.createElement('div');
                tooltip.className = 'tooltip';
                let tooltipContent = `<strong>${escapeHtml(ev.title)}</strong><br>`;
                try {
                    const eventTime = new Date('1970-01-01T' + (ev.time || '00:00'));
                    tooltipContent += `Time: ${eventTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}<br>`;
                } catch(e) { /* Ignore invalid time format */ }
                if (ev.speaker) tooltipContent += `Speaker: ${escapeHtml(ev.speaker)}<br>`;
                if (ev.chair) tooltipContent += `Chair: ${escapeHtml(ev.chair)}<br>`;
                if (ev.description) tooltipContent += `Description: ${escapeHtml(ev.description)}`;
                tooltip.innerHTML = tooltipContent;
                evEl.appendChild(tooltip);
                cell.appendChild(evEl);
            }
        });
        grid.appendChild(cell);
    }
    const totalCells = dayNames.length + firstDay + daysInMonth;
    const remainder = totalCells % 7;
    if (remainder !== 0) {
        for (let i = 0; i < 7 - remainder; i++) {
            const blank = document.createElement('div');
            blank.className = 'calendar-day';
            blank.style.visibility = 'hidden';
            grid.appendChild(blank);
        }
    }
}
let calendarNavInitialized = false;
let mainNavInitialized = false;
let dictionaryInitialized = false;
function initCalendarNav() {
    if (calendarNavInitialized) return;
    const prevBtn = document.getElementById('prev-month-btn');
    const nextBtn = document.getElementById('next-month-btn');
    if (prevBtn) {
        prevBtn.addEventListener('click', () => {
            currentMonthDate.setMonth(currentMonthDate.getMonth() - 1);
            renderCalendar();
        });
    }
    if (nextBtn) {
        nextBtn.addEventListener('click', () => {
            currentMonthDate.setMonth(currentMonthDate.getMonth() + 1);
            renderCalendar();
        });
    }
    calendarNavInitialized = true;
}
function initNav() {
    if (mainNavInitialized) return;
    document.querySelectorAll('nav li[data-section]').forEach(li => {
        li.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent event bubbling to parent dropdown
            const target = li.getAttribute('data-section');
            if (target) {
                goToSection(target);
                document.querySelectorAll('nav li.has-dropdown').forEach(dd => {
                    dd.classList.remove('dropdown-open');
                });
            }
        });
    });
    document.querySelectorAll('nav li.has-dropdown').forEach(parent => {
        parent.addEventListener('click', (e) => {
            if (e.target === parent || (!e.target.hasAttribute('data-section') && e.target.closest('.has-dropdown') === parent)) {
                e.stopPropagation();
                document.querySelectorAll('nav li.has-dropdown').forEach(dd => {
                    if (dd !== parent) {
                        dd.classList.remove('dropdown-open');
                    }
                });
                parent.classList.toggle('dropdown-open');
            }
        });
    });
    document.addEventListener('click', (e) => {
        if (!e.target.closest('nav')) {
            document.querySelectorAll('nav li.has-dropdown').forEach(dd => {
                dd.classList.remove('dropdown-open');
            });
        }
    });
    mainNavInitialized = true;
}
function initDictionary() {
    if (dictionaryInitialized) return;
    const searchBtn = document.getElementById('dictionary-search-btn');
    const searchInput = document.getElementById('dictionary-search-word');
    if (searchBtn) {
        searchBtn.addEventListener('click', searchDictionary);
    }
    if (searchInput) {
        searchInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                searchDictionary();
            }
        });
    }
    dictionaryInitialized = true;
}
const contentData = {
    'open-discussion': {
        title: 'Open Discussion Meeting',
        content: [
            { type: 'p', text: '<strong>Chairperson opens the meeting:</strong> "Welcome to [Your Home Group] of Alcoholics Anonymous. My name is ___, and I am an alcoholic."' },
            { type: 'p', text: 'Moment of silence, followed by the Serenity Prayer.' },
            { type: 'p', text: 'Read "How It Works" from Chapter 5 of the Big Book.' },
            { type: 'p', text: 'Acknowledge newcomers and visitors.' },
            { type: 'p', text: 'Introduce the topic for discussion. (e.g., a Step, a Tradition, a reading from AA literature, or a general topic related to recovery).' },
            { type: 'p', text: 'Facilitate sharing, ensuring everyone who wants to share has the opportunity.' },
            { type: 'p', text: 'Close with the Lord\'s Prayer or the Responsibility Declaration.' }
        ]
    },
    'closed-discussion': {
        title: 'Closed Discussion Meeting (for alcoholics only)',
        content: [
            { type: 'p', text: '<strong>Chairperson opens the meeting:</strong> "Welcome to [Your Home Group] of Alcoholics Anonymous. This is a closed meeting, for alcoholics or those who have a desire to stop drinking. My name is ___, and I am an alcoholic."' },
            { type: 'p', text: 'Moment of silence, followed by the Serenity Prayer.' },
            { type: 'p', text: 'Read "How It Works" and the Twelve Traditions.' },
            { type: 'p', text: 'Acknowledge newcomers.' },
            { type: 'p', text: 'Introduce the topic, often focusing on more in-depth aspects of the Steps, Traditions, or personal recovery challenges.' },
            { type: 'p', text: 'Facilitate sharing in a safe, closed environment.' },
            { type: 'p', text: 'Close with the Lord\'s Prayer or the Responsibility Declaration.' }
        ]
    },
    'big-book': {
        title: 'Big Book Study',
        content: [
            { type: 'p', text: '<strong>Chairperson opens the meeting:</strong> "Welcome to the Big Book study of [Your Home Group]. My name is ___, and I am an alcoholic."' },
            { type: 'p', text: 'Moment of silence, followed by the Serenity Prayer.' },
            { type: 'p', text: 'Read a chapter or section from the book "Alcoholics Anonymous."' },
            { type: 'p', text: 'The reader or chairperson may pause to allow for comments or questions, or discussion may follow the reading.' },
            { type: 'p', text: 'Focus is on understanding the text and applying it to personal recovery.' },
            { type: 'p', text: 'Close with the Lord\'s Prayer or the Responsibility Declaration.' }
        ]
    },
    '12x12': {
        title: '12 Steps and 12 Traditions Study',
        content: [
            { type: 'p', text: '<strong>Chairperson opens the meeting:</strong> "Welcome to the 12 & 12 study of [Your Home Group]. My name is ___, and I am an alcoholic."' },
            { type: 'p', text: 'Moment of silence, followed by the Serenity Prayer.' },
            { type: 'p', text: 'Read a Step or Tradition from the book "Twelve Steps and Twelve Traditions."' },
            { type: 'p', text: 'Discussion focuses on the selected Step or Tradition, its meaning, and its application in members\' lives.' },
            { type: 'p', text: 'Close with the Lord\'s Prayer or the Responsibility Declaration.' }
        ]
    },
    'personal-story': {
        title: 'Personal Story Speaker Meeting',
        content: [
            { type: 'p', text: '<strong>Chairperson opens the meeting:</strong> "Welcome to [Your Home Group] of Alcoholics Anonymous. My name is ___, and I am an alcoholic."' },
            { type: 'p', text: 'Moment of silence and Serenity Prayer.' },
            { type: 'p', text: 'Read "How It Works."' },
            { type: 'p', text: 'Introduce the speaker. The speaker shares their experience, strength, and hope: what it was like, what happened, and what it\'s like now.' },
            { type: 'p', text: 'Sharing is typically for a set amount of time (e.g., 20-30 minutes).' },
            { type: 'p', text: 'After the speaker, the meeting may open for brief sharing or proceed to closing.' },
            { type: 'p', text: 'Close with the Lord\'s Prayer or the Responsibility Declaration.' }
        ]
    },
    'foundations': {
        title: 'Foundations Speaker Meeting',
        content: [
            { type: 'p', text: '<strong>Chairperson opens the meeting:</strong> "Welcome to the Foundations meeting of [Your Home Group]. My name is ___, and I am an alcoholic."' },
            { type: 'p', text: 'Moment of silence and Serenity Prayer.' },
            { type: 'p', text: 'Introduce the speaker, who will share on a foundational aspect of AA recovery (e.g., Sponsorship, Service, Home Group, a specific Step).' },
            { type: 'p', text: 'The speaker\'s share is the main focus of the meeting.' },
            { type: 'p', text: 'Close with the Lord\'s Prayer or the Responsibility Declaration.' }
        ]
    },
    'birthday': {
        title: 'Birthday Night Meeting',
        content: [
            { type: 'p', text: '<strong>Chairperson opens the meeting:</strong> "Welcome to the Birthday Night celebration of [Your Home Group]. My name is ___, and I am an alcoholic."' },
            { type: 'p', text: 'Moment of silence and Serenity Prayer.' },
            { type: 'p', text: 'Acknowledge members celebrating a sobriety anniversary this month.' },
            { type: 'p', text: 'Invite each person up to receive a chip. They may share briefly on their recovery.' },
            { type: 'p', text: 'The group celebrates their milestones.' },
            { type: 'p', text: 'Close with the Serenity Prayer, often holding hands in a circle.' }
        ]
    },
    'how-it-works': {
        title: 'How It Works',
        content: [
            { type: 'p', text: 'RARELY HAVE we seen a person fail who has thoroughly followed our path. Those who do not recover are people who cannot or will not completely give themselves to this simple program, usually men and women who are constitutionally incapable of being honest with themselves. There are such unfortunates. They are not at fault; they seem to have been born that way. They are naturally incapable of grasping and developing a manner of living which demands rigorous honesty. Their chances are less than average. There are those, too, who suffer from grave emotional and mental disorders, but many of them do recover if they have the capacity to be honest.' },
            { type: 'p', text: 'Our stories disclose in a general way what we used to be like, what happened, and what we are like now. If you have decided you want what we have and are willing to go to any length to get it-then you are ready to take certain steps.' },
            { type: 'p', text: 'At some of these we balked. We thought we could find an easier, softer way. But we could not. With all the earnestness at our command, we beg of you to be fearless and thorough from the very start. Some of us have tried to hold on to our old ideas and the result was nil until we let go absolutely.' },
            { type: 'p', text: 'Remember that we deal with alcohol - cunning, baffling, powerful! Without help it is too much for us. But there is One who has all power-that One is God. May you find Him now!' },
            { type: 'p', text: 'Half measures availed us nothing. We stood at the turning point. We asked His protection and care with complete abandon.' },
            { type: 'p', text: 'Here are the steps we took, which are suggested as a program of recovery:' },
            { type: 'ol', items: [
                'We admitted we were powerless over alcohol - that our lives had become unmanageable.',
                'Came to believe that a Power greater than ourselves could restore us to sanity.',
                'Made a decision to turn our will and our lives over to the care of God as we understood Him.',
                'Made a searching and fearless moral inventory of ourselves.',
                'Admitted to God, to ourselves and to another human being the exact nature of our wrongs.',
                'Were entirely ready to have God remove all these defects of character.',
                'Humbly asked Him to remove our shortcomings.',
                'Made a list of all persons we had harmed, and became willing to make amends to them all.',
                'Made direct amends to such people wherever possible, except when to do so would injure them or others.',
                'Continued to take personal inventory and when we were wrong promptly admitted it.',
                'Sought through prayer and meditation to improve our conscious contact with God as we understood Him, praying only for knowledge of His will for us and the power to carry that out.',
                'Having had a spiritual awakening as the result of these steps, we tried to carry this message to alcoholics and to practice these principles in all our affairs.'
            ]},
            { type: 'p', text: 'Many of us exclaimed, "What an order! I can\'t go through with it." Do not be discouraged. No one among us has been able to maintain anything like perfect adherence to these principles. We are not saints. The point is, that we are willing to grow along spiritual lines. The principles we have set down are guides to progress. We claim spiritual progress rather than spiritual perfection.' },
            { type: 'p', text: 'Our description of the alcoholic, the chapter to the agnostic, and our personal adventures before and after make clear three pertinent ideas:' },
            { type: 'ul', items: [
                'a. That we were alcoholic and could not manage our own lives.',
                'b. That probably no human power could have relieved our alcoholism.',
                'c. That God could and would if He were sought.'
            ]}
        ]
    },
    'traditions': {
        title: 'The Twelve Traditions',
        content: [
            { type: 'ol', items: [
                'Our common welfare should come first; personal recovery depends upon A.A. unity.',
                'For our group purpose there is but one ultimate authority — a loving God as He may express Himself in our group conscience. Our leaders are but trusted servants; they do not govern.',
                'The only requirement for A.A. membership is a desire to stop drinking.',
                'Each group should be autonomous except in matters affecting other groups or A.A. as a whole.',
                'Each group has but one primary purpose — to carry its message to the alcoholic who still suffers.',
                'An A.A. group ought never endorse, finance, or lend the A.A. name to any related facility or outside enterprise, lest problems of money, property, and prestige divert us from our primary purpose.',
                'Every A.A. group ought to be fully self-supporting, declining outside contributions.',
                'Alcoholics Anonymous should remain forever non-professional, but our service centers may employ special workers.',
                'A.A., as such, ought never be organized; but we may create service boards or committees directly responsible to those they serve.',
                'Alcoholics Anonymous has no opinion on outside issues; hence the A.A. name ought never be drawn into public controversy.',
                'Our public relations policy is based on attraction rather than promotion; we need always maintain personal anonymity at the level of press, radio, and films.',
                'Anonymity is the spiritual foundation of all our traditions, ever reminding us to place principles before personalities.'
            ]}
        ]
    },
    'promises': {
        title: 'The 9th Step Promises',
        content: [
                { type: 'p', text: 'If we are painstaking about this phase of our development, we will be amazed before we are halfway through. We are going to know a new freedom and a new happiness. We will not regret the past nor wish to shut the door on it. We will comprehend the word serenity and we will know peace. No matter how far down the scale we have gone, we will see how our experience can benefit others. That feeling of uselessness and self pity will disappear. We will lose interest in selfish things and gain interest in our fellows. Self seeking will slip away. Our whole attitude and outlook upon life will change. Fear of people and of economic insecurity will leave us. We will intuitively know how to handle situations which used to baffle us. We will suddenly realize that God is doing for us what we could not do for ourselves.' },
            { type: 'p', text: 'Are these extravagant promises? We think not. They are being fulfilled among us—sometimes quickly, sometimes slowly. They will always materialize if we work for them.' }
        ]
    }
};
function renderMeetingFormat(data) {
    if (!data) return '';
    let html = `<h3>${data.title}</h3>`;
    data.content.forEach(item => {
        if (item.type === 'p') {
            html += `<p>${item.text}</p>`;
        } else if (item.type === 'ol' || item.type === 'ul') {
            const listTag = item.type;
            html += `<${listTag} style="list-style-position: inside;">`;
            item.items.forEach(li => {
                html += `<li>${li}</li>`;
            });
            html += `</${listTag}>`;
        }
    });
    return html;
}
function showMeetingFormat(format) {
    const display = document.getElementById('meeting-format-display');
    const data = contentData[format];
    if (data) {
        display.innerHTML = renderMeetingFormat(data);
        display.style.display = 'block';
    }
}
async function searchDictionary() {
    const word = document.getElementById('dictionary-search-word').value.trim();
    const resultsContainer = document.getElementById('dictionary-results');
    if (!word) {
        showToast('Please enter a word to search.', 'error');
        return;
    }
    resultsContainer.innerHTML = '<p>Searching...</p>';
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
    try {
        const response = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word)}`, {
            signal: controller.signal
        });
        clearTimeout(timeoutId);
        if (!response.ok) {
            throw new Error('Word not found. Please check your spelling.');
        }
        const data = await response.json();
        displayDictionaryResults(data);
    } catch (error) {
        clearTimeout(timeoutId);
        let errorMsg = 'An error occurred while searching.';
        if (error.name === 'AbortError') {
            errorMsg = 'Search timed out. Please check your internet connection and try again.';
        } else if (error.message) {
            errorMsg = error.message;
        }
        resultsContainer.innerHTML = `<p style="color: #e74c3c;">${escapeHtml(errorMsg)}</p>`;
        showToast(errorMsg, 'error');
    }
}
function displayDictionaryResults(data) {
    const resultsContainer = document.getElementById('dictionary-results');
    resultsContainer.innerHTML = ''; // Clear previous results or "Searching..." text
    if (!data || data.length === 0) {
        resultsContainer.innerHTML = '<p>No definitions found.</p>';
        return;
    }
    const entry = data[0]; // Displaying the first entry found
    let html = `<h3>${escapeHtml(entry.word)} <span style="font-size: 1rem; color: #bdc3c7;">${escapeHtml(entry.phonetic || '')}</span></h3>`;
    if (entry.meanings && Array.isArray(entry.meanings)) {
        entry.meanings.forEach(meaning => {
            html += `<h4 style="color: #3498db; margin-top: 1rem;">${escapeHtml(meaning.partOfSpeech)}</h4>`;
            html += '<ul style="list-style-type: disc; padding-left: 20px;">';
            if (meaning.definitions && Array.isArray(meaning.definitions)) {
                meaning.definitions.forEach(def => {
                    html += `<li>${escapeHtml(def.definition)}`;
                    if (def.example) {
                        html += `<br><em style="color: #95a5a6;">Example: "${escapeHtml(def.example)}"</em>`;
                    }
                    html += '</li>';
                });
            }
            html += '</ul>';
        });
    }
    if (entry.phonetics && Array.isArray(entry.phonetics)) {
        const phoneticWithAudio = entry.phonetics.find(p => p.audio);
        if (phoneticWithAudio && phoneticWithAudio.audio) {
            try {
                const audioUrl = new URL(phoneticWithAudio.audio);
                if (audioUrl.protocol === 'https:' && audioUrl.hostname.endsWith('dictionaryapi.dev')) {
                    html += `<div style="margin-top: 1rem;">
                                <p>Pronunciation:</p>
                                <audio controls src="${escapeAttribute(phoneticWithAudio.audio)}" style="width: 100%;">
                                    Your browser does not support the audio element.
                                </audio>
                             </div>`;
                }
            } catch (e) {
            }
        }
    }
    resultsContainer.innerHTML = html;
}
let rosterSortColumn = 'name';
let rosterSortDirection = 'asc';
function openRosterModal() {
    const modal = document.getElementById('roster-modal');
    if (modal) {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden'; // Prevent background scrolling
        renderRosterTable();
    }
}
function closeRosterModal() {
    const modal = document.getElementById('roster-modal');
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = ''; // Restore scrolling
    }
}
function sortRosterBy(column) {
    if (rosterSortColumn === column) {
        rosterSortDirection = rosterSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        rosterSortColumn = column;
        rosterSortDirection = 'asc';
    }
    document.querySelectorAll('#roster-table th').forEach(th => {
        th.textContent = th.textContent.replace(/ [↑↓]/, '');
    });
    const header = Array.from(document.querySelectorAll('#roster-table th')).find(th => th.textContent.toLowerCase().startsWith(column));
    if (header) {
        header.textContent += rosterSortDirection === 'asc' ? ' ↓' : ' ↑';
    }
    renderRosterTable();
}
function renderRosterTable() {
    const tbody = document.getElementById('roster-table-body');
    if (!tbody) return;
    const searchTerm = document.getElementById('roster-search').value.toLowerCase();
    tbody.innerHTML = '';
    let members = storage.getMembers();
    if (searchTerm) {
        members = members.filter(m => {
            return m.name.toLowerCase().includes(searchTerm) ||
                   (m.email && m.email.toLowerCase().includes(searchTerm)) ||
                   (m.phone && m.phone.includes(searchTerm)) ||
                   (m.homegroup && m.homegroup.toLowerCase().includes(searchTerm)) ||
                   (m.city && m.city.toLowerCase().includes(searchTerm));
        });
    }
    members.sort((a, b) => {
        let valA = a[rosterSortColumn] === undefined ? '' : a[rosterSortColumn];
        let valB = b[rosterSortColumn] === undefined ? '' : b[rosterSortColumn];
        if (typeof valA === 'boolean') {
            valA = valA ? 1 : 0;
            valB = valB ? 1 : 0;
        } else if (typeof valA === 'string') {
            valA = valA.toLowerCase();
            valB = valB.toLowerCase();
        }
        if (valA < valB) return rosterSortDirection === 'asc' ? -1 : 1;
        if (valA > valB) return rosterSortDirection === 'asc' ? 1 : -1;
        return 0;
    });
    if(members.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7">No members found.</td></tr>';
        return;
    }
    members.forEach(member => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${member.name}</td>
            <td>${member.city || ''}</td>
            <td>${member.homegroup || ''}</td>
            <td>${member.phone || ''}</td>
            <td>${member.email || ''}</td>
            <td>${member.isServant ? 'Yes' : 'No'}</td>
            <td>
                <button class="btn" data-action="edit-member-roster" data-id="${escapeAttribute(member.id)}">Edit</button>
                <button class="btn secondary" data-action="delete-member-roster" data-id="${escapeAttribute(member.id)}">Delete</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}
function editMemberFromRoster(id) {
    closeRosterModal();
    editMember(id);
}
function deleteMemberAndRefreshRoster(id) {
    deleteMember(id);
    renderRosterTable();
}
function openMemberFormFromModal() {
    closeRosterModal();
    const form = document.getElementById('add-member-form');
    form.style.display = 'block';
    goToSection('birthdays-section');
    form.scrollIntoView({ behavior: 'smooth' });
}
function populateAttendeeDropdown() {
    const select = document.getElementById('gc-attendees');
    if (!select) return;
    const members = storage.getMembers().sort((a, b) => a.name.localeCompare(b.name));
    const selectedValues = Array.from(select.selectedOptions).map(opt => opt.value);
    select.innerHTML = ''; // Clear existing options
    members.forEach(member => {
        const option = document.createElement('option');
        option.value = member.name;
        option.textContent = member.name;
        if (selectedValues.includes(member.name)) {
            option.selected = true;
        }
        select.appendChild(option);
    });
}
function populateMemberDropdowns() {
    const allMembers = storage.getMembers().sort((a, b) => a.name.localeCompare(b.name));
    const servantMembers = allMembers.filter(m => m.isServant);
    const dropdowns = [
        { id: 'log-chairperson', placeholder: 'Select Chairperson', members: servantMembers, optional: false },
        { id: 'event-speaker', placeholder: 'Select Speaker (optional)', members: allMembers, optional: true },
        { id: 'event-chair', placeholder: 'Select Chairperson (optional)', members: servantMembers, optional: true }
    ];
    dropdowns.forEach(dd_info => {
        const select = document.getElementById(dd_info.id);
        if (!select) return;
        const currentValue = select.value;
        select.innerHTML = '';
        const placeholderOption = document.createElement('option');
        placeholderOption.value = '';
        placeholderOption.textContent = dd_info.placeholder;
        select.appendChild(placeholderOption);
        if (dd_info.optional) {
            const noneOption = document.createElement('option');
            noneOption.value = 'None';
            noneOption.textContent = 'None';
            select.appendChild(noneOption);
        }
        dd_info.members.forEach(member => {
            const option = document.createElement('option');
            option.value = member.name;
            option.textContent = member.name;
            select.appendChild(option);
        });
        select.value = currentValue;
    });
}
function populateNewFeatureDropdowns() {
    const allMembers = storage.getMembers().sort((a, b) => a.name.localeCompare(b.name));
    const gcLog = storage.getGroupConscienceLog();
    const memberDropdownIds = [
        'reconsider-requested-by',
        'proxy-member',
        'proxy-designated-voter',
        'voting-history-member',
        'standing-item-assignee'
    ];
    memberDropdownIds.forEach(dropdownId => {
        const select = document.getElementById(dropdownId);
        if (!select) return;
        const currentValue = select.value;
        select.innerHTML = '<option value="">Select member...</option>';
        allMembers.forEach(member => {
            const option = document.createElement('option');
            option.value = member.id || member.name;
            option.textContent = member.name;
            select.appendChild(option);
        });
        if (currentValue) select.value = currentValue;
    });
    const decisionDropdownIds = [
        'reconsider-original-decision',
        'reversal-original-decision',
        'reversal-new-decision',
        'impl-decision'
    ];
    decisionDropdownIds.forEach(dropdownId => {
        const select = document.getElementById(dropdownId);
        if (!select) return;
        const currentValue = select.value;
        select.innerHTML = '<option value="">Select a decision...</option>';
        gcLog.slice().reverse().forEach(decision => {
            const option = document.createElement('option');
            option.value = decision.id;
            option.textContent = `${decision.date} - ${decision.item.substring(0, 60)}${decision.item.length > 60 ? '...' : ''}`;
            select.appendChild(option);
        });
        if (currentValue) select.value = currentValue;
    });
}
function renderServantReportInputs() {
    const container = document.getElementById('gc-servant-reports-container');
    if (!container) return;
    container.innerHTML = '';
    const servants = storage.getMembers().filter(m => m.isServant).sort((a, b) => (a.servantPosition || a.name).localeCompare(b.servantPosition || b.name));
    if (servants.length === 0) {
        container.innerHTML = '<p class="text-sm opacity-75">No servants found. Add servants with positions in the Member Roster to see report fields here.</p>';
        return;
    }
    servants.forEach(s => {
        const servantName = s.servantPosition ? `${s.name} (${s.servantPosition})` : s.name;
        const div = document.createElement('div');
        div.className = 'form-group';
        div.innerHTML = `
            <label for="servant-report-${s.id}">${servantName}</label>
            <textarea id="servant-report-${s.id}" data-servant-id="${s.id}" data-servant-name="${servantName}" class="servant-report-input" rows="2" placeholder="Report for ${servantName}..."></textarea>
        `;
        container.appendChild(div);
    });
}
function setupAudioRecorder() {
    const recordBtn = document.getElementById('record-btn');
    const stopBtn = document.getElementById('stop-btn');
    const audioPlayer = document.getElementById('audio-player');
    const downloadLink = document.getElementById('download-link');
    const playerContainer = document.getElementById('audio-player-container');
    if (!recordBtn) return; // Exit if the recorder elements aren't on the page
    const descriptionP = recordBtn.parentElement.previousElementSibling;
    if (!window.isSecureContext && location.protocol !== 'file:') {
        showToast('Audio recording requires a secure connection (HTTPS or localhost).', 'error');
        recordBtn.disabled = true;
        descriptionP.innerHTML = '<b>Audio recording is disabled.</b> This feature requires a secure connection (HTTPS or localhost). If you are developing locally, please serve the page via a local web server.';
        return;
    }
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia || !window.MediaRecorder) {
        showToast('Audio recording is not supported on this browser.', 'error');
        recordBtn.disabled = true;
        if (descriptionP && descriptionP.tagName === 'P') {
            descriptionP.innerHTML = '<b>Audio recording is not supported on this browser.</b> Please try a modern browser like Chrome or Firefox.';
            descriptionP.style.opacity = 1;
        }
        return;
    }
    let mediaRecorder;
    let chunks = [];
    async function startRecording() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = e => {
                chunks.push(e.data);
            };
            mediaRecorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'audio/webm' });
                chunks = [];
                const audioURL = window.URL.createObjectURL(blob);
                audioPlayer.src = audioURL;
                downloadLink.href = audioURL;
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[-:T]/g, '').replace(/ /g, '_');
                downloadLink.download = `meeting-audio-${timestamp}.webm`;
                playerContainer.style.display = 'block';
                downloadLink.style.display = 'inline-block';
                stream.getTracks().forEach(track => track.stop());
            };
            mediaRecorder.start();
            recordBtn.disabled = true;
            stopBtn.disabled = false;
            playerContainer.style.display = 'none';
            downloadLink.style.display = 'none';
            showToast('Recording started...', 'info');
        } catch (err) {
            console.error("Error starting recording:", err);
            if (err.name === "NotAllowedError" || err.name === "PermissionDeniedError") {
                showToast('Microphone permission denied. Please allow access in your browser settings.', 'error');
            } else {
                showToast('Could not start recording. No microphone found or an error occurred.', 'error');
            }
        }
    }
    function stopRecording() {
        if (mediaRecorder && mediaRecorder.state !== "inactive") {
            mediaRecorder.stop();
            recordBtn.disabled = false;
            stopBtn.disabled = true;
            showToast('Recording stopped.', 'info');
        }
    }
    recordBtn.addEventListener('click', startRecording);
    stopBtn.addEventListener('click', stopRecording);
}
function markAnnouncementAsRead(announcementId) {
    const ann = storage.getAnnouncements();
    const announcement = ann.find(a => a.id === announcementId);
    if (announcement) {
        const currentUser = storage.getCurrentUser();
        if (!announcement.readBy) announcement.readBy = [];
        if (!announcement.readBy.includes(currentUser)) {
            announcement.readBy.push(currentUser);
            storage.saveAnnouncements(ann);
            updateAnnouncementsList();
            showToast('Marked as read', 'success');
        }
    }
}
function sendMessage() {
    const recipientId = document.getElementById('message-recipient').value;
    const subject = document.getElementById('message-subject').value.trim();
    const text = document.getElementById('message-text').value.trim();
    if (!recipientId || !subject || !text) {
        showToast('Please fill in all fields', 'error');
        return;
    }
    const currentUser = storage.getCurrentUser();
    const messages = storage.getMessages();
    messages.push({
        id: genId(),
        from: currentUser,
        to: recipientId,
        subject: subject,
        message: text,
        date: new Date().toISOString(),
        read: false
    });
    storage.saveMessages(messages);
    showToast('Message sent!', 'success');
    document.getElementById('message-recipient').value = '';
    document.getElementById('message-subject').value = '';
    document.getElementById('message-text').value = '';
    showMessages('sent');
}
function showMessages(type) {
    const container = document.getElementById('messages-container');
    const messages = storage.getMessages();
    const currentUser = storage.getCurrentUser();
    document.getElementById('inbox-btn').classList.toggle('active', type === 'inbox');
    document.getElementById('sent-btn').classList.toggle('active', type === 'sent');
    const filteredMessages = type === 'inbox'
        ? messages.filter(m => m.to === currentUser)
        : messages.filter(m => m.from === currentUser);
    container.innerHTML = '';
    if (filteredMessages.length === 0) {
        container.innerHTML = `<p>No ${type} messages</p>`;
        return;
    }
    filteredMessages.sort((a, b) => new Date(b.date) - new Date(a.date));
    filteredMessages.forEach(msg => {
        const div = document.createElement('div');
        div.className = `message-item ${!msg.read && type === 'inbox' ? 'unread' : ''}`;
        const header = document.createElement('div');
        header.className = 'message-header';
        const subj = document.createElement('div');
        subj.className = 'message-subject';
        subj.textContent = msg.subject;
        const date = document.createElement('div');
        date.className = 'message-date';
        date.textContent = new Date(msg.date).toLocaleString();
        header.appendChild(subj);
        header.appendChild(date);
        const fromTo = document.createElement('div');
        fromTo.style.fontSize = '0.85rem';
        fromTo.style.marginBottom = '8px';
        fromTo.textContent = type === 'inbox' ? `From: ${msg.from}` : `To: ${msg.to}`;
        const msgText = document.createElement('div');
        msgText.textContent = msg.message;
        div.appendChild(header);
        div.appendChild(fromTo);
        div.appendChild(msgText);
        if (type === 'inbox' && !msg.read) {
            const markReadBtn = document.createElement('button');
            markReadBtn.className = 'btn';
            markReadBtn.style.marginTop = '8px';
            markReadBtn.textContent = 'Mark as Read';
            markReadBtn.onclick = () => markMessageAsRead(msg.id);
            div.appendChild(markReadBtn);
        }
        container.appendChild(div);
    });
}
function markMessageAsRead(messageId) {
    const messages = storage.getMessages();
    const message = messages.find(m => m.id === messageId);
    if (message) {
        message.read = true;
        storage.saveMessages(messages);
        showMessages('inbox');
        showToast('Marked as read', 'success');
    }
}
function populateMessageRecipients() {
    const select = document.getElementById('message-recipient');
    const members = storage.getMembers();
    const currentUser = storage.getCurrentUser();
    select.innerHTML = '<option value="">Select a member...</option>';
    members.forEach(m => {
        if (m.name !== currentUser) {
            const option = document.createElement('option');
            option.value = m.name;
            option.textContent = m.name;
            select.appendChild(option);
        }
    });
}
function addServicePosition() {
    const name = document.getElementById('position-name').value.trim();
    const description = document.getElementById('position-description').value.trim();
    const termLength = parseInt(document.getElementById('position-term-length').value);
    const currentHolder = document.getElementById('position-current-holder').value;
    const startDate = document.getElementById('position-start-date').value;
    if (!name || !termLength) {
        showToast('Please enter position name and term length', 'error');
        return;
    }
    const positions = storage.getServicePositions();
    positions.push({
        id: genId(),
        name: name,
        description: description,
        termLength: termLength,
        currentHolder: currentHolder,
        startDate: startDate,
        history: [],
        transitionPackage: {
            checklist: getPositionTransitionChecklist(name),
            currentProjects: [],
            keyContacts: [],
            accessInfo: [],
            documents: [],
            completionPercentage: 0,
            transitionStartDate: null,
            transitionCompleteDate: null,
            outgoingNotes: null,
            incomingNotes: null
        },
        notificationsSent: {
            days90: false,
            days60: false,
            days30: false
        },
        successorIdentified: false,
        potentialSuccessors: []
    });
    storage.saveServicePositions(positions);
    showToast('Service position added!', 'success');
    document.getElementById('position-name').value = '';
    document.getElementById('position-description').value = '';
    document.getElementById('position-term-length').value = '';
    document.getElementById('position-current-holder').value = '';
    document.getElementById('position-start-date').value = '';
    updateServicePositionsTable();
    updateRotationCalendar();
    populateNominationPositions();
}
function updateServicePositionsTable() {
    const tbody = document.getElementById('service-positions-table');
    const positions = storage.getServicePositions();
    tbody.innerHTML = '';
    positions.forEach(pos => {
        const tr = document.createElement('tr');
        const endDate = pos.startDate ? calculateEndDate(pos.startDate, pos.termLength) : 'N/A';
        const daysRemaining = pos.startDate ? calculateDaysRemaining(pos.startDate, pos.termLength) : null;
        let termStatus = '';
        if (daysRemaining !== null) {
            if (daysRemaining < 0) {
                termStatus = `<span class="term-expired">EXPIRED</span>`;
            } else if (daysRemaining < 60) {
                termStatus = `<span class="term-warning">${daysRemaining} days left</span>`;
            }
        }
        tr.innerHTML = `
            <td>${pos.name}</td>
            <td>${pos.currentHolder || 'Vacant'}</td>
            <td>${pos.startDate ? new Date(pos.startDate).toLocaleDateString() : 'N/A'}</td>
            <td>${endDate} ${termStatus}</td>
            <td>
                <button class="btn secondary" data-action="delete-position" data-id="${escapeAttribute(pos.id)}">Delete</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
    if (positions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5">No service positions defined</td></tr>';
    }
}
function deleteServicePosition(id) {
    if (!confirm('Delete this service position?')) return;
    let positions = storage.getServicePositions();
    positions = positions.filter(p => p.id !== id);
    storage.saveServicePositions(positions);
    updateServicePositionsTable();
    updateRotationCalendar();
    populateNominationPositions();
    showToast('Position deleted', 'success');
}
function calculateEndDate(startDate, termMonths) {
    const start = new Date(startDate);
    const startYear = start.getFullYear();
    const startMonth = start.getMonth();
    const startDay = start.getDate();
    const totalMonths = startYear * 12 + startMonth + termMonths;
    const endYear = Math.floor(totalMonths / 12);
    const endMonth = totalMonths % 12;
    const end = new Date(endYear, endMonth, 1);
    const maxDay = new Date(endYear, endMonth + 1, 0).getDate();
    end.setDate(Math.min(startDay, maxDay));
    return end.toLocaleDateString();
}
function calculateDaysRemaining(startDate, termMonths) {
    const start = new Date(startDate);
    const startYear = start.getFullYear();
    const startMonth = start.getMonth();
    const startDay = start.getDate();
    const totalMonths = startYear * 12 + startMonth + termMonths;
    const endYear = Math.floor(totalMonths / 12);
    const endMonth = totalMonths % 12;
    const end = new Date(endYear, endMonth, 1);
    const maxDay = new Date(endYear, endMonth + 1, 0).getDate();
    end.setDate(Math.min(startDay, maxDay));
    const today = new Date();
    const diffTime = end - today;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    return diffDays;
}
function updateRotationCalendar() {
    const container = document.getElementById('rotation-calendar');
    const positions = storage.getServicePositions();
    const upcomingElections = positions.filter(pos => {
        if (!pos.startDate) return false;
        const days = calculateDaysRemaining(pos.startDate, pos.termLength);
        return days !== null && days >= 0 && days <= 60;
    });
    container.innerHTML = '';
    if (upcomingElections.length === 0) {
        container.innerHTML = '<p>No elections coming up in the next 60 days</p>';
        return;
    }
    upcomingElections.sort((a, b) => {
        const daysA = calculateDaysRemaining(a.startDate, a.termLength);
        const daysB = calculateDaysRemaining(b.startDate, b.termLength);
        return daysA - daysB;
    });
    upcomingElections.forEach(pos => {
        const days = calculateDaysRemaining(pos.startDate, pos.termLength);
        const endDate = calculateEndDate(pos.startDate, pos.termLength);
        const card = document.createElement('div');
        card.className = 'position-card';
        card.innerHTML = `
            <h4>${pos.name}</h4>
            <p><strong>Current:</strong> ${pos.currentHolder || 'Vacant'}</p>
            <p><strong>Term ends:</strong> ${endDate}</p>
            <p class="term-warning">${days} days remaining</p>
        `;
        container.appendChild(card);
    });
}
function addNomination() {
    const positionId = document.getElementById('nomination-position').value;
    const nominee = document.getElementById('nomination-nominee').value;
    if (!positionId || !nominee) {
        showToast('Please select position and nominee', 'error');
        return;
    }
    const nominations = storage.getNominations();
    const positions = storage.getServicePositions();
    const position = positions.find(p => p.id === positionId);
    nominations.push({
        id: genId(),
        positionId: positionId,
        positionName: position.name,
        nominee: nominee,
        nominatedBy: storage.getCurrentUser(),
        date: new Date().toISOString()
    });
    storage.saveNominations(nominations);
    showToast('Nomination submitted!', 'success');
    document.getElementById('nomination-position').value = '';
    document.getElementById('nomination-nominee').value = '';
    updateNominationsList();
}
function updateNominationsList() {
    const container = document.getElementById('nominations-list');
    const nominations = storage.getNominations();
    container.innerHTML = '';
    if (nominations.length === 0) {
        container.innerHTML = '<p>No nominations yet</p>';
        return;
    }
    nominations.forEach(nom => {
        const card = document.createElement('div');
        card.className = 'nomination-card';
        card.innerHTML = `
            <h4>${nom.positionName}</h4>
            <p><strong>Nominee:</strong> ${nom.nominee}</p>
            <p><strong>Nominated by:</strong> ${nom.nominatedBy}</p>
            <p><strong>Date:</strong> ${new Date(nom.date).toLocaleDateString()}</p>
            <button class="btn secondary" data-action="delete-nomination" data-id="${escapeAttribute(nom.id)}">Remove</button>
        `;
        container.appendChild(card);
    });
}
function deleteNomination(id) {
    if (!confirm('Remove this nomination?')) return;
    let nominations = storage.getNominations();
    nominations = nominations.filter(n => n.id !== id);
    storage.saveNominations(nominations);
    updateNominationsList();
    showToast('Nomination removed', 'success');
}
function populateNominationPositions() {
    const select = document.getElementById('nomination-position');
    const positions = storage.getServicePositions();
    select.innerHTML = '<option value="">Select position...</option>';
    positions.forEach(pos => {
        const option = document.createElement('option');
        option.value = pos.id;
        option.textContent = pos.name;
        select.appendChild(option);
    });
}
function populateServicePositionHolders() {
    const select = document.getElementById('position-current-holder');
    const nomineeSelect = document.getElementById('nomination-nominee');
    const members = storage.getMembers();
    select.innerHTML = '<option value="">Vacant</option>';
    nomineeSelect.innerHTML = '<option value="">Select member...</option>';
    members.forEach(m => {
        const option1 = document.createElement('option');
        option1.value = m.name;
        option1.textContent = m.name;
        select.appendChild(option1);
        const option2 = document.createElement('option');
        option2.value = m.name;
        option2.textContent = m.name;
        nomineeSelect.appendChild(option2);
    });
}
function getPositionTransitionChecklist(positionName) {
    const checklists = {
        'Treasurer': [
            {item: 'Review current bank balance and accounts', completed: false},
            {item: 'Transfer bank account access/signatures', completed: false},
            {item: 'Provide all financial records (last 12 months)', completed: false},
            {item: 'Explain budget categories and tracking system', completed: false},
            {item: 'Show prudent reserve calculation', completed: false},
            {item: 'Review bill payment schedule and vendors', completed: false},
            {item: 'Explain 7th Tradition counting procedure', completed: false},
            {item: 'Provide GSR contact for district contributions', completed: false},
            {item: 'Review IRS tax filing requirements', completed: false}
        ],
        'Secretary': [
            {item: 'Transfer meeting minutes archive', completed: false},
            {item: 'Provide templates for minutes and reports', completed: false},
            {item: 'Explain GC motion tracking system', completed: false},
            {item: 'Share attendance tracking procedure', completed: false},
            {item: 'Provide group contact list', completed: false},
            {item: 'Review document filing system', completed: false}
        ],
        'GSR': [
            {item: 'Provide District/Area contact information', completed: false},
            {item: 'Share district meeting schedule', completed: false},
            {item: 'Transfer district voting records', completed: false},
            {item: 'Explain how to submit group contributions', completed: false},
            {item: 'Review group\'s hot topics and concerns', completed: false},
            {item: 'Provide access to GSR email/communications', completed: false}
        ],
        'Chairperson': [
            {item: 'Review meeting format and structure', completed: false},
            {item: 'Provide reading materials and meeting supplies location', completed: false},
            {item: 'Explain GC meeting facilitation process', completed: false},
            {item: 'Share contact list for all servants', completed: false},
            {item: 'Review traditions and concepts application', completed: false},
            {item: 'Explain facility coordination (keys, setup, etc.)', completed: false}
        ]
    };
    return checklists[positionName] || [
        {item: 'Review position responsibilities', completed: false},
        {item: 'Transfer any documents or materials', completed: false},
        {item: 'Introduce to key contacts', completed: false},
        {item: 'Answer questions about role', completed: false}
    ];
}
function startTransition(positionId) {
    const positions = storage.getServicePositions();
    const position = positions.find(p => p.id === positionId);
    if (!position) {
        showToast('Position not found', 'error');
        return;
    }
    if (!position.transitionPackage) {
        position.transitionPackage = {
            checklist: getPositionTransitionChecklist(position.name),
            currentProjects: [],
            keyContacts: [],
            accessInfo: [],
            documents: [],
            completionPercentage: 0,
            transitionStartDate: null,
            transitionCompleteDate: null,
            outgoingNotes: null,
            incomingNotes: null
        };
    }
    position.transitionPackage.transitionStartDate = new Date().toISOString().split('T')[0];
    storage.saveServicePositions(positions);
    showToast(`Transition started for ${position.name}. Please complete the transition checklist.`, 'success');
    openTransitionModal(positionId);
}
function updateTransitionChecklist(positionId, itemIndex, completed) {
    const positions = storage.getServicePositions();
    const position = positions.find(p => p.id === positionId);
    if (!position || !position.transitionPackage) return;
    position.transitionPackage.checklist[itemIndex].completed = completed;
    const total = position.transitionPackage.checklist.length;
    const done = position.transitionPackage.checklist.filter(i => i.completed).length;
    position.transitionPackage.completionPercentage = Math.round((done / total) * 100);
    if (position.transitionPackage.completionPercentage === 100 && !position.transitionPackage.transitionCompleteDate) {
        position.transitionPackage.transitionCompleteDate = new Date().toISOString().split('T')[0];
        showToast(`Transition for ${position.name} is complete! Well done on a smooth handoff.`, 'success');
    }
    storage.saveServicePositions(positions);
}
function addTransitionProject(positionId, projectName, status, notes) {
    const positions = storage.getServicePositions();
    const position = positions.find(p => p.id === positionId);
    if (!position || !position.transitionPackage) return;
    position.transitionPackage.currentProjects.push({
        id: genId(),
        name: projectName,
        status: status,
        notes: notes,
        addedDate: new Date().toISOString()
    });
    storage.saveServicePositions(positions);
    showToast('Project added to transition package', 'success');
}
function addTransitionContact(positionId, name, role, contact, notes) {
    const positions = storage.getServicePositions();
    const position = positions.find(p => p.id === positionId);
    if (!position || !position.transitionPackage) return;
    position.transitionPackage.keyContacts.push({
        id: genId(),
        name: name,
        role: role,
        contact: contact,
        notes: notes
    });
    storage.saveServicePositions(positions);
    showToast('Contact added to transition package', 'success');
}
function addTransitionAccessInfo(positionId, system, username, notes) {
    const positions = storage.getServicePositions();
    const position = positions.find(p => p.id === positionId);
    if (!position || !position.transitionPackage) return;
    position.transitionPackage.accessInfo.push({
        id: genId(),
        system: system,
        username: username,
        notes: notes, // Password should be shared securely offline
        addedDate: new Date().toISOString()
    });
    storage.saveServicePositions(positions);
    showToast('Access info added (share passwords offline)', 'success');
}
function openTransitionModal(positionId) {
    goToSection('service-positions-section');
    showToast('View transition package in Service Positions section', 'info');
}
function createNotification(notification) {
    const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
    const newNotification = {
        id: genId(),
        type: notification.type || 'general',
        title: notification.title,
        message: notification.message,
        priority: notification.priority || 'normal', // normal, high, urgent
        createdDate: new Date().toISOString(),
        read: false,
        dismissed: false,
        actionLink: notification.actionLink || null,
        actionData: notification.actionData || null
    };
    notifications.push(newNotification);
    localStorage.setItem('notifications', JSON.stringify(notifications));
    updateNotificationBadge();
    if (notification.priority === 'urgent') {
        showToast(notification.title, 'warning');
    }
    return newNotification.id;
}
function getUnreadNotifications() {
    const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
    return notifications.filter(n => !n.read && !n.dismissed);
}
function markNotificationRead(notificationId) {
    const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
    const notification = notifications.find(n => n.id === notificationId);
    if (notification) {
        notification.read = true;
        localStorage.setItem('notifications', JSON.stringify(notifications));
        updateNotificationBadge();
        refreshNotificationList();
    }
}
function dismissNotification(notificationId) {
    const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
    const notification = notifications.find(n => n.id === notificationId);
    if (notification) {
        notification.dismissed = true;
        localStorage.setItem('notifications', JSON.stringify(notifications));
        updateNotificationBadge();
        refreshNotificationList();
    }
}
function updateNotificationBadge() {
    const unread = getUnreadNotifications();
    const badge = document.getElementById('notification-badge');
    const homeBadge = document.getElementById('home-notification-badge');
    if (badge) {
        if (unread.length > 0) {
            badge.textContent = unread.length > 99 ? '99+' : unread.length;
            badge.style.display = 'inline-block';
        } else {
            badge.style.display = 'none';
        }
    }
    if (homeBadge) {
        if (unread.length > 0) {
            homeBadge.textContent = unread.length > 99 ? '99+' : unread.length;
            homeBadge.style.display = 'inline';
        } else {
            homeBadge.style.display = 'none';
        }
    }
}
function showNotificationCenter() {
    const modal = document.createElement('div');
    modal.id = 'notification-modal';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';
    const content = document.createElement('div');
    content.style.cssText = 'background: #34495e; padding: 2rem; border-radius: 8px; max-width: 700px; max-height: 85vh; overflow-y: auto; width: 90%;';
    content.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="color: #3498db; margin: 0;"><i class="fas fa-bell"></i> Smart Notifications</h2>
            <div style="display: flex; gap: 0.5rem;">
                <button onclick="clearAllNotifications()" class="btn secondary" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                    <i class="fas fa-trash-alt"></i> Clear All
                </button>
                <button onclick="closeNotificationCenter()" class="btn secondary" style="padding: 0.5rem 1rem;">Close</button>
            </div>
        </div>
        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; border-bottom: 2px solid #2c3e50; padding-bottom: 0.5rem;">
            <button id="filter-all" onclick="filterNotifications('all')" class="btn" style="font-size: 0.85rem; padding: 0.4rem 0.8rem; background: #3498db;">
                All <span id="count-all" style="background: rgba(255,255,255,0.2); padding: 0.1rem 0.4rem; border-radius: 10px; margin-left: 0.25rem;">0</span>
            </button>
            <button id="filter-urgent" onclick="filterNotifications('urgent')" class="btn secondary" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                Urgent <span id="count-urgent" style="background: rgba(255,255,255,0.2); padding: 0.1rem 0.4rem; border-radius: 10px; margin-left: 0.25rem;">0</span>
            </button>
            <button id="filter-high" onclick="filterNotifications('high')" class="btn secondary" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                High <span id="count-high" style="background: rgba(255,255,255,0.2); padding: 0.1rem 0.4rem; border-radius: 10px; margin-left: 0.25rem;">0</span>
            </button>
            <button id="filter-unread" onclick="filterNotifications('unread')" class="btn secondary" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                Unread <span id="count-unread" style="background: rgba(255,255,255,0.2); padding: 0.1rem 0.4rem; border-radius: 10px; margin-left: 0.25rem;">0</span>
            </button>
        </div>
        <div id="notification-list">
        </div>
    `;
    modal.appendChild(content);
    document.body.appendChild(modal);
    modal.onclick = (e) => {
        if (e.target === modal) closeNotificationCenter();
    };
    window.currentNotificationFilter = 'all';
    refreshNotificationList();
}
function filterNotifications(filter) {
    window.currentNotificationFilter = filter;
    document.querySelectorAll('#notification-modal button[id^="filter-"]').forEach(btn => {
        btn.classList.remove('btn');
        btn.classList.add('btn', 'secondary');
        btn.style.background = '';
    });
    const activeBtn = document.getElementById('filter-' + filter);
    if (activeBtn) {
        activeBtn.classList.remove('secondary');
        activeBtn.style.background = '#3498db';
    }
    refreshNotificationList();
}
function refreshNotificationList() {
    const listDiv = document.getElementById('notification-list');
    if (!listDiv) return; // Modal is not open
    let notifications = storage.getNotifications()
        .filter(n => !n.dismissed); // Only show non-dismissed notifications
    const filter = window.currentNotificationFilter || 'all';
    if (filter === 'urgent') {
        notifications = notifications.filter(n => n.priority === 'urgent');
    } else if (filter === 'high') {
        notifications = notifications.filter(n => n.priority === 'high');
    } else if (filter === 'unread') {
        notifications = notifications.filter(n => !n.read);
    }
    const priorityOrder = { urgent: 0, high: 1, medium: 2, low: 3 };
    notifications.sort((a, b) => {
        const priorityA = priorityOrder[a.priority || 'medium'];
        const priorityB = priorityOrder[b.priority || 'medium'];
        if (priorityA !== priorityB) return priorityA - priorityB;
        return new Date(b.date) - new Date(a.date);
    });
    const allNotifications = storage.getNotifications().filter(n => !n.dismissed);
    document.getElementById('count-all').textContent = allNotifications.length;
    document.getElementById('count-urgent').textContent = allNotifications.filter(n => n.priority === 'urgent').length;
    document.getElementById('count-high').textContent = allNotifications.filter(n => n.priority === 'high').length;
    document.getElementById('count-unread').textContent = allNotifications.filter(n => !n.read).length;
    if (notifications.length === 0) {
        listDiv.innerHTML = '<p style="color: #95a5a6; text-align: center; padding: 2rem;">No notifications in this category</p>';
        return;
    }
    listDiv.innerHTML = notifications.map(n => {
        const priorityColor = n.priority === 'urgent' ? '#e74c3c' : n.priority === 'high' ? '#f39c12' : '#3498db';
        const priorityIcon = n.priority === 'urgent' ? 'fa-exclamation-triangle' : n.priority === 'high' ? 'fa-exclamation-circle' : 'fa-info-circle';
        const now = new Date();
        const snoozedUntil = n.snoozedUntil ? new Date(n.snoozedUntil) : null;
        const isSnoozed = snoozedUntil && snoozedUntil > now;
        return `
            <div style="background: #2c3e50; padding: 1rem; border-radius: 6px; margin-bottom: 0.75rem; border-left: 4px solid ${priorityColor}; opacity: ${n.read ? '0.7' : '1'}; ${isSnoozed ? 'border: 2px dashed #95a5a6;' : ''}">
                <div style="display: flex; align-items: start; gap: 0.75rem;">
                    <i class="fas ${priorityIcon}" style="color: ${priorityColor}; font-size: 1.2rem; margin-top: 0.25rem;"></i>
                    <div style="flex: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                            <h4 style="color: ${priorityColor}; margin: 0; flex: 1;">${escapeHtml(n.title)}</h4>
                            ${!n.read ? '<span style="background: #e74c3c; color: white; padding: 0.15rem 0.4rem; border-radius: 10px; font-size: 0.7rem; font-weight: bold;">NEW</span>' : ''}
                        </div>
                        <p style="margin: 0 0 0.5rem 0; color: #ecf0f1; line-height: 1.5;">${escapeHtml(n.message)}</p>
                        ${isSnoozed ? `<div style="background: #34495e; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; font-size: 0.85rem;">
                            <i class="fas fa-clock"></i> Snoozed until ${snoozedUntil.toLocaleString()}
                        </div>` : ''}
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <small style="color: #95a5a6;">
                                <i class="fas fa-clock"></i> ${new Date(n.date).toLocaleString()}
                            </small>
                            ${n.recurring ? '<span style="color: #f39c12; font-size: 0.75rem;"><i class="fas fa-redo"></i> Recurring</span>' : ''}
                        </div>
                        <div style="margin-top: 0.75rem; display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            ${!n.read ? `<button onclick="markNotificationRead('${escapeAttribute(n.id)}')" class="btn" style="font-size: 0.8rem; padding: 0.3rem 0.6rem; background: #3498db;">
                                <i class="fas fa-check"></i> Mark Read
                            </button>` : ''}
                            ${n.actionLink ? `<button onclick="dismissNotification('${escapeAttribute(n.id)}'); goToSection('${escapeAttribute(n.actionLink)}'); closeNotificationCenter();" class="btn" style="font-size: 0.8rem; padding: 0.3rem 0.6rem; background: #2ecc71;">
                                <i class="fas fa-external-link-alt"></i> Take Action
                            </button>` : ''}
                            ${!isSnoozed ? `<button onclick="snoozeNotification('${escapeAttribute(n.id)}')" class="btn secondary" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">
                                <i class="fas fa-clock"></i> Snooze
                            </button>` : `<button onclick="unsnoozeNotification('${escapeAttribute(n.id)}')" class="btn secondary" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">
                                <i class="fas fa-bell"></i> Unsnooze
                            </button>`}
                            <button onclick="dismissNotification('${escapeAttribute(n.id)}')" class="btn secondary" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">
                                <i class="fas fa-times"></i> Dismiss
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}
function snoozeNotification(id) {
    const duration = prompt('Snooze for how long?\n\n1. 1 hour\n2. 3 hours\n3. 1 day\n4. 3 days\n5. 1 week\n\nEnter number (1-5):', '1');
    if (!duration) return;
    const hours = { '1': 1, '2': 3, '3': 24, '4': 72, '5': 168 }[duration];
    if (!hours) {
        showToast('Invalid selection', 'error');
        return;
    }
    const notifications = storage.getNotifications();
    const notification = notifications.find(n => n.id === id);
    if (notification) {
        const snoozeUntil = new Date();
        snoozeUntil.setHours(snoozeUntil.getHours() + hours);
        notification.snoozedUntil = snoozeUntil.toISOString();
        notification.read = true; // Mark as read when snoozed
        storage.saveNotifications(notifications);
        refreshNotificationList();
        updateNotificationBadge();
        showToast(`Snoozed for ${hours} hour(s)`, 'success');
    }
}
function unsnoozeNotification(id) {
    const notifications = storage.getNotifications();
    const notification = notifications.find(n => n.id === id);
    if (notification) {
        delete notification.snoozedUntil;
        notification.read = false;
        storage.saveNotifications(notifications);
        refreshNotificationList();
        updateNotificationBadge();
        showToast('Notification unsnoozed', 'success');
    }
}
function clearAllNotifications() {
    if (!confirm('Clear all notifications? This cannot be undone.')) return;
    const notifications = storage.getNotifications();
    notifications.forEach(n => n.dismissed = true);
    storage.saveNotifications(notifications);
    refreshNotificationList();
    updateNotificationBadge();
    showToast('All notifications cleared', 'info');
}
function closeNotificationCenter() {
    const modal = document.getElementById('notification-modal');
    if (modal) modal.remove();
}
function markNotificationRead(id) {
    const notifications = storage.getNotifications();
    const notification = notifications.find(n => n.id === id);
    if (notification) {
        notification.read = true;
        storage.saveNotifications(notifications);
        refreshNotificationList();
        updateNotificationBadge();
    }
}
function dismissNotification(id) {
    const notifications = storage.getNotifications();
    const notification = notifications.find(n => n.id === id);
    if (notification) {
        notification.dismissed = true;
        storage.saveNotifications(notifications);
        refreshNotificationList();
        updateNotificationBadge();
    }
}
function processSnoozedNotifications() {
    const notifications = storage.getNotifications();
    const now = new Date();
    let updated = false;
    notifications.forEach(n => {
        if (n.snoozedUntil) {
            const snoozeUntil = new Date(n.snoozedUntil);
            if (snoozeUntil <= now) {
                delete n.snoozedUntil;
                n.read = false; // Make it unread again
                updated = true;
            }
        }
    });
    if (updated) {
        storage.saveNotifications(notifications);
        updateNotificationBadge();
    }
}
function autoDismissOldNotifications() {
    const notifications = storage.getNotifications();
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
    let updated = false;
    notifications.forEach(n => {
        const notificationDate = new Date(n.date);
        if (n.read && notificationDate < thirtyDaysAgo && !n.dismissed) {
            n.dismissed = true;
            updated = true;
        }
    });
    if (updated) {
        storage.saveNotifications(notifications);
        updateNotificationBadge();
    }
}
function deduplicateNotifications() {
    const notifications = storage.getNotifications().filter(n => !n.dismissed);
    const seen = new Map();
    let hasDuplicates = false;
    notifications.forEach(n => {
        const key = `${n.title}-${n.message}`;
        const existing = seen.get(key);
        if (existing) {
            const olderNotification = new Date(existing.date) < new Date(n.date) ? existing : n;
            const newerNotification = new Date(existing.date) >= new Date(n.date) ? existing : n;
            olderNotification.dismissed = true;
            hasDuplicates = true;
        } else {
            seen.set(key, n);
        }
    });
    if (hasDuplicates) {
        storage.saveNotifications(notifications);
        updateNotificationBadge();
    }
}
function createSmartNotification(title, message, priority = 'medium', actionLink = null, category = null) {
    const notifications = storage.getNotifications();
    const oneHourAgo = new Date();
    oneHourAgo.setHours(oneHourAgo.getHours() - 1);
    const isDuplicate = notifications.some(n => {
        return !n.dismissed &&
               n.title === title &&
               n.message === message &&
               new Date(n.date) > oneHourAgo;
    });
    if (isDuplicate) {
        return null;
    }
    const notification = {
        id: genId(),
        date: new Date().toISOString(),
        title,
        message,
        priority,
        actionLink,
        category,
        read: false,
        dismissed: false,
        recurring: false
    };
    notifications.unshift(notification);
    storage.saveNotifications(notifications);
    updateNotificationBadge();
    return notification;
}
function createRecurringNotification(title, message, priority, actionLink, intervalDays) {
    const notifications = storage.getNotifications();
    const notification = {
        id: genId(),
        date: new Date().toISOString(),
        title,
        message,
        priority,
        actionLink,
        recurring: true,
        recurringIntervalDays: intervalDays,
        lastShown: new Date().toISOString(),
        read: false,
        dismissed: false
    };
    notifications.unshift(notification);
    storage.saveNotifications(notifications);
    updateNotificationBadge();
    return notification;
}
function processRecurringNotifications() {
    const notifications = storage.getNotifications();
    const now = new Date();
    let updated = false;
    notifications.forEach(n => {
        if (n.recurring && n.recurringIntervalDays && n.lastShown) {
            const lastShownDate = new Date(n.lastShown);
            const daysSinceLastShown = Math.floor((now - lastShownDate) / (1000 * 60 * 60 * 24));
            if (daysSinceLastShown >= n.recurringIntervalDays) {
                if (n.dismissed || n.read) {
                    n.dismissed = false;
                    n.read = false;
                    n.lastShown = now.toISOString();
                    updated = true;
                }
            }
        }
    });
    if (updated) {
        storage.saveNotifications(notifications);
        updateNotificationBadge();
    }
}
function initSmartNotificationSystem() {
    processSnoozedNotifications();
    autoDismissOldNotifications();
    deduplicateNotifications();
    processRecurringNotifications();
    setInterval(() => {
        processSnoozedNotifications();
        autoDismissOldNotifications();
        deduplicateNotifications();
        processRecurringNotifications();
    }, 5 * 60 * 1000); // 5 minutes
}
function logAuditEntry(action, entityType, entityId, changes, reason = null) {
    const auditLog = JSON.parse(localStorage.getItem('auditLog') || '[]');
    const entry = {
        id: genId(),
        timestamp: new Date().toISOString(),
        user: getCurrentUserName(),
        action: action, // 'create', 'update', 'delete', 'view'
        entityType: entityType, // 'gc-motion', 'member', 'expense', etc.
        entityId: entityId,
        changes: changes, // Object with before/after values
        reason: reason,
        ipAddress: null // Could add if server-side
    };
    auditLog.push(entry);
    if (auditLog.length > 10000) {
        auditLog.splice(0, auditLog.length - 10000);
    }
    localStorage.setItem('auditLog', JSON.stringify(auditLog));
}
function getAuditHistory(entityType = null, entityId = null, limit = 100) {
    const auditLog = JSON.parse(localStorage.getItem('auditLog') || '[]');
    let filtered = auditLog;
    if (entityType) {
        filtered = filtered.filter(e => e.entityType === entityType);
    }
    if (entityId) {
        filtered = filtered.filter(e => e.entityId === entityId);
    }
    filtered.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    return filtered.slice(0, limit);
}
function viewAuditLog() {
    const entries = getAuditHistory(null, null, 500);
    const modal = document.createElement('div');
    modal.id = 'audit-modal';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; overflow: auto; padding: 2rem;';
    const content = document.createElement('div');
    content.style.cssText = 'background: #34495e; padding: 2rem; border-radius: 8px; max-width: 1000px; width: 100%; max-height: 90vh; overflow-y: auto;';
    content.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="color: #3498db; margin: 0;">Audit Log</h2>
            <div style="display: flex; gap: 0.5rem;">
                <button onclick="exportAuditLogToCSV()" style="background: #2ecc71; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
                    <i class="fas fa-file-csv"></i> Export CSV
                </button>
                <button onclick="exportAuditLogToPDF()" style="background: #3498db; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
                    <i class="fas fa-file-pdf"></i> Export PDF
                </button>
                <button onclick="closeAuditLog()" style="background: #e74c3c; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Close</button>
            </div>
        </div>
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #2c3e50;">
                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #3498db;">Timestamp</th>
                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #3498db;">User</th>
                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #3498db;">Action</th>
                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #3498db;">Entity</th>
                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #3498db;">Changes</th>
                </tr>
            </thead>
            <tbody>
                ${entries.map(e => `
                    <tr style="border-bottom: 1px solid #7f8c8d;">
                        <td style="padding: 0.75rem; font-size: 0.85rem;">${new Date(e.timestamp).toLocaleString()}</td>
                        <td style="padding: 0.75rem;">${escapeHtml(e.user)}</td>
                        <td style="padding: 0.75rem;"><span style="background: ${e.action === 'delete' ? '#e74c3c' : e.action === 'create' ? '#2ecc71' : '#3498db'}; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.8rem;">${e.action.toUpperCase()}</span></td>
                        <td style="padding: 0.75rem; font-size: 0.85rem;">${escapeHtml(e.entityType)}</td>
                        <td style="padding: 0.75rem; font-size: 0.85rem;">${e.changes ? Object.keys(e.changes).length + ' field(s)' : '-'}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
    modal.appendChild(content);
    document.body.appendChild(modal);
    modal.onclick = (e) => {
        if (e.target === modal) closeAuditLog();
    };
}
function closeAuditLog() {
    const modal = document.getElementById('audit-modal');
    if (modal) modal.remove();
}
function exportAuditLog() {
    const entries = getAuditHistory();
    const csv = [
        ['Timestamp', 'User', 'Action', 'Entity Type', 'Entity ID', 'Changes', 'Reason'].join(','),
        ...entries.map(e => [
            new Date(e.timestamp).toISOString(),
            e.user,
            e.action,
            e.entityType,
            e.entityId,
            e.changes ? JSON.stringify(e.changes) : '',
            e.reason || ''
        ].map(field => `"${String(field).replace(/"/g, '""')}"`).join(','))
    ].join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `audit-log-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    URL.revokeObjectURL(url);
    showToast('Audit log exported to CSV', 'success');
}
function createAutomatedBackup() {
    const backup = {
        id: genId(),
        timestamp: new Date().toISOString(),
        version: '1.0',
        data: {
            members: storage.getMembers(),
            events: storage.getEvents(),
            groupConscienceLog: storage.getGroupConscienceLog(),
            servicePositions: storage.getServicePositions(),
            budgetCategories: storage.getBudgetCategories(),
            expenses: storage.getExpenses(),
            chairpersonLog: storage.getChairpersonLog(),
            announcements: storage.getAnnouncements(),
            photos: storage.getPhotos(),
            messages: storage.getMessages(),
            nominations: storage.getNominations(),
            notifications: JSON.parse(localStorage.getItem('notifications') || '[]'),
            auditLog: JSON.parse(localStorage.getItem('auditLog') || '[]'),
            settings: {
                gcSettings: JSON.parse(localStorage.getItem('gcSettings') || '{}'),
                votingSettings: JSON.parse(localStorage.getItem('votingSettings') || '{}'),
                currentUser: localStorage.getItem('currentUser'),
                treasurerBalance: localStorage.getItem('treasurerBalance')
            }
        }
    };
    const backups = JSON.parse(localStorage.getItem('backupHistory') || '[]');
    backups.push({
        id: backup.id,
        timestamp: backup.timestamp,
        size: JSON.stringify(backup).length
    });
    if (backups.length > 30) {
        backups.splice(0, backups.length - 30);
    }
    localStorage.setItem('backupHistory', JSON.stringify(backups));
    localStorage.setItem(`backup_${backup.id}`, JSON.stringify(backup));
    return backup;
}
function exportBackupToFile() {
    const backup = createAutomatedBackup();
    const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `aa-group-backup-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    showToast('Backup exported successfully', 'success');
    logAuditEntry('export', 'full-backup', backup.id, null, 'Manual backup export');
}
function importBackupFromFile() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const backup = JSON.parse(event.target.result);
                if (!backup.data || !backup.timestamp) {
                    throw new Error('Invalid backup file format');
                }
                const confirmed = confirm(
                    `This will restore data from backup created on ${new Date(backup.timestamp).toLocaleString()}.\n\n` +
                    `Current data will be overwritten. This cannot be undone.\n\n` +
                    `Create a backup of current data first?`
                );
                if (!confirmed) return;
                exportBackupToFile();
                setTimeout(() => {
                    restoreFromBackup(backup);
                }, 1000);
            } catch (error) {
                showToast('Error importing backup: ' + error.message, 'error');
                console.error('Backup import error:', error);
            }
        };
        reader.readAsText(file);
    };
    input.click();
}
function restoreFromBackup(backup) {
    try {
        const data = backup.data;
        if (data.members) storage.saveMembers(data.members);
        if (data.events) storage.saveEvents(data.events);
        if (data.groupConscienceLog) storage.saveGroupConscienceLog(data.groupConscienceLog);
        if (data.servicePositions) storage.saveServicePositions(data.servicePositions);
        if (data.budgetCategories) storage.saveBudgetCategories(data.budgetCategories);
        if (data.expenses) storage.saveExpenses(data.expenses);
        if (data.chairpersonLog) storage.saveChairpersonLog(data.chairpersonLog);
        if (data.announcements) storage.saveAnnouncements(data.announcements);
        if (data.photos) storage.savePhotos(data.photos);
        if (data.messages) storage.saveMessages(data.messages);
        if (data.nominations) storage.saveNominations(data.nominations);
        if (data.notifications) localStorage.setItem('notifications', JSON.stringify(data.notifications));
        if (data.auditLog) localStorage.setItem('auditLog', JSON.stringify(data.auditLog));
        if (data.settings) {
            if (data.settings.gcSettings) localStorage.setItem('gcSettings', JSON.stringify(data.settings.gcSettings));
            if (data.settings.votingSettings) localStorage.setItem('votingSettings', JSON.stringify(data.settings.votingSettings));
            if (data.settings.currentUser) localStorage.setItem('currentUser', data.settings.currentUser);
            if (data.settings.treasurerBalance) localStorage.setItem('treasurerBalance', data.settings.treasurerBalance);
        }
        logAuditEntry('import', 'full-backup', backup.id, null, 'Restored from backup file');
        showToast('Backup restored successfully! Refreshing page...', 'success');
        setTimeout(() => {
            window.location.reload();
        }, 2000);
    } catch (error) {
        showToast('Error restoring backup: ' + error.message, 'error');
        console.error('Backup restore error:', error);
    }
}
function scheduleAutomatedBackups() {
    const backupSettings = JSON.parse(localStorage.getItem('backupSettings') || '{"enabled": true, "frequency": "daily"}');
    if (!backupSettings.enabled) return;
    const lastBackup = localStorage.getItem('lastAutomatedBackup');
    const now = new Date();
    let shouldBackup = false;
    if (!lastBackup) {
        shouldBackup = true;
    } else {
        const lastBackupDate = new Date(lastBackup);
        const hoursSinceBackup = (now - lastBackupDate) / (1000 * 60 * 60);
        if (backupSettings.frequency === 'daily' && hoursSinceBackup >= 24) {
            shouldBackup = true;
        } else if (backupSettings.frequency === 'weekly' && hoursSinceBackup >= 168) {
            shouldBackup = true;
        }
    }
    if (shouldBackup) {
        createAutomatedBackup();
        localStorage.setItem('lastAutomatedBackup', now.toISOString());
        console.log('Automated backup created:', now.toISOString());
        createNotification({
            type: 'backup-created',
            title: 'Automatic Backup Created',
            message: 'Your data has been automatically backed up.',
            priority: 'normal'
        });
    }
}
function viewBackupHistory() {
    const backups = JSON.parse(localStorage.getItem('backupHistory') || '[]')
        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    const modal = document.createElement('div');
    modal.id = 'backup-modal';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';
    const content = document.createElement('div');
    content.style.cssText = 'background: #34495e; padding: 2rem; border-radius: 8px; max-width: 600px; max-height: 80vh; overflow-y: auto; width: 90%;';
    content.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="color: #3498db; margin: 0;">Backup History</h2>
            <button onclick="closeBackupHistory()" style="background: #e74c3c; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Close</button>
        </div>
        <div style="margin-bottom: 1rem;">
            <button onclick="exportBackupToFile()" style="background: #2ecc71; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; margin-right: 0.5rem;">Create New Backup</button>
            <button onclick="importBackupFromFile()" style="background: #3498db; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Import Backup</button>
        </div>
        <div>
            ${backups.length === 0 ? '<p style="color: #95a5a6;">No backups yet</p>' :
                backups.map(b => `
                    <div style="background: #2c3e50; padding: 1rem; border-radius: 6px; margin-bottom: 0.75rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <p style="margin: 0; color: #ecf0f1;"><strong>${new Date(b.timestamp).toLocaleString()}</strong></p>
                                <small style="color: #95a5a6;">Size: ${(b.size / 1024).toFixed(2)} KB</small>
                            </div>
                            <button onclick="restoreBackupById('${b.id}')" style="background: #f39c12; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">Restore</button>
                        </div>
                    </div>
                `).join('')
            }
        </div>
    `;
    modal.appendChild(content);
    document.body.appendChild(modal);
    modal.onclick = (e) => {
        if (e.target === modal) closeBackupHistory();
    };
}
function closeBackupHistory() {
    const modal = document.getElementById('backup-modal');
    if (modal) modal.remove();
}
function restoreBackupById(backupId) {
    const backupData = localStorage.getItem(`backup_${backupId}`);
    if (!backupData) {
        showToast('Backup not found', 'error');
        return;
    }
    const backup = JSON.parse(backupData);
    restoreFromBackup(backup);
}
function calculateMemberEngagementScore(memberId) {
    const members = storage.getMembers();
    const member = members.find(m => m.id === memberId || m.name === memberId);
    if (!member) return 0;
    let score = 0;
    const weights = {
        attendance: 30,
        gcParticipation: 25,
        service: 25,
        sponsorship: 10,
        committees: 10
    };
    const chairpersonLogs = storage.getChairpersonLog();
    const recentLogs = chairpersonLogs.filter(log => {
        const logDate = new Date(log.date);
        const monthsAgo = new Date();
        monthsAgo.setMonth(monthsAgo.getMonth() - 3);
        return logDate >= monthsAgo;
    });
    if (recentLogs.length > 0) {
        score += weights.attendance * 0.75; // Default 75% attendance
    }
    const gcLogs = storage.getGroupConscienceLog();
    const recentGC = gcLogs.filter(log => {
        const logDate = new Date(log.date);
        const monthsAgo = new Date();
        monthsAgo.setMonth(monthsAgo.getMonth() - 6);
        return logDate >= monthsAgo;
    });
    const participationCount = recentGC.filter(log =>
        log.attendees && log.attendees.includes(member.name)
    ).length;
    if (recentGC.length > 0) {
        const participationRate = participationCount / recentGC.length;
        score += weights.gcParticipation * participationRate;
    }
    const positions = storage.getServicePositions();
    const hasService = positions.some(p => p.currentHolder === member.name);
    if (hasService) {
        score += weights.service;
    }
    if (member.sponsor) {
        score += weights.sponsorship * 0.5;
    }
    score += weights.sponsorship * 0.5; // Assume active in sponsorship
    score += weights.committees * 0.5; // Default partial credit
    return Math.round(score);
}
function getGroupEngagementMetrics() {
    const members = storage.getMembers();
    if (members.length === 0) {
        return {
            averageScore: 0,
            totalMembers: 0,
            highEngagement: 0,
            mediumEngagement: 0,
            lowEngagement: 0,
            disengaged: 0
        };
    }
    const scores = members.map(m => calculateMemberEngagementScore(m.id || m.name));
    const averageScore = scores.reduce((a, b) => a + b, 0) / scores.length;
    return {
        averageScore: Math.round(averageScore),
        totalMembers: members.length,
        highEngagement: scores.filter(s => s >= 75).length,
        mediumEngagement: scores.filter(s => s >= 50 && s < 75).length,
        lowEngagement: scores.filter(s => s >= 25 && s < 50).length,
        disengaged: scores.filter(s => s < 25).length
    };
}
function displayEngagementDashboard() {
    const metrics = getGroupEngagementMetrics();
    const modal = document.createElement('div');
    modal.id = 'engagement-modal';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';
    const content = document.createElement('div');
    content.style.cssText = 'background: #34495e; padding: 2rem; border-radius: 8px; max-width: 800px; max-height: 80vh; overflow-y: auto; width: 90%;';
    content.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="color: #3498db; margin: 0;">Member Engagement Dashboard</h2>
            <button onclick="closeEngagementDashboard()" style="background: #e74c3c; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Close</button>
        </div>
        <div style="background: #2c3e50; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
            <h3 style="color: #3498db; margin: 0 0 1rem 0;">Group Overview</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div>
                    <p style="margin: 0.5rem 0;"><strong>Total Members:</strong> ${metrics.totalMembers}</p>
                    <p style="margin: 0.5rem 0;"><strong>Average Engagement:</strong> <span style="color: ${metrics.averageScore >= 75 ? '#2ecc71' : metrics.averageScore >= 50 ? '#f39c12' : '#e74c3c'}; font-size: 1.2rem; font-weight: bold;">${metrics.averageScore}%</span></p>
                </div>
                <div>
                    <p style="margin: 0.5rem 0; color: #2ecc71;"><strong>High (75%+):</strong> ${metrics.highEngagement}</p>
                    <p style="margin: 0.5rem 0; color: #f39c12;"><strong>Medium (50-74%):</strong> ${metrics.mediumEngagement}</p>
                    <p style="margin: 0.5rem 0; color: #e67e22;"><strong>Low (25-49%):</strong> ${metrics.lowEngagement}</p>
                    <p style="margin: 0.5rem 0; color: #e74c3c;"><strong>Disengaged (<25%):</strong> ${metrics.disengaged}</p>
                </div>
            </div>
        </div>
        ${metrics.averageScore < 60 ? `
            <div style="background: #e67e22; padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem;">
                <h4 style="margin: 0 0 0.5rem 0; color: white;"><i class="fas fa-exclamation-triangle"></i> Engagement Below Target</h4>
                <p style="margin: 0; color: white;">Group engagement is below the healthy threshold (60%). Consider:</p>
                <ul style="margin: 0.5rem 0; padding-left: 1.5rem; color: white;">
                    <li>Checking in with members who haven't attended recently</li>
                    <li>Creating opportunities for service</li>
                    <li>Hosting special events or workshops</li>
                </ul>
            </div>
        ` : ''}
        <div style="background: #2c3e50; padding: 1.5rem; border-radius: 8px;">
            <h3 style="color: #3498db; margin: 0 0 1rem 0;">Engagement Breakdown</h3>
            <p style="color: #ecf0f1; font-size: 0.9rem; margin-bottom: 1rem;">
                Engagement score is calculated from:<br>
                • Meeting Attendance (30%)<br>
                • GC Participation (25%)<br>
                • Service Positions (25%)<br>
                • Sponsorship Activity (10%)<br>
                • Committee Involvement (10%)
            </p>
        </div>
    `;
    modal.appendChild(content);
    document.body.appendChild(modal);
    modal.onclick = (e) => {
        if (e.target === modal) closeEngagementDashboard();
    };
}
function closeEngagementDashboard() {
    const modal = document.getElementById('engagement-modal');
    if (modal) modal.remove();
}
function checkMemberEngagement() {
    const metrics = getGroupEngagementMetrics();
    if (metrics.disengaged > 0) {
        createNotification({
            type: 'low-engagement',
            title: `${metrics.disengaged} Member${metrics.disengaged > 1 ? 's' : ''} Showing Low Engagement`,
            message: `Some members may need outreach. Consider checking in with less active members.`,
            priority: 'normal',
            actionLink: 'birthdays-section'
        });
    }
    if (metrics.averageScore < 50) {
        createNotification({
            type: 'group-engagement-low',
            title: 'Group Engagement Below 50%',
            message: `Overall group participation is low. Group conscience may want to discuss ways to increase engagement.`,
            priority: 'high',
            actionLink: 'analytics-section'
        });
    }
}
function getTraditionOfMonth() {
    const today = new Date();
    const month = today.getMonth(); // 0-11
    const tradition = (month % 12) + 1; // 1-12
    return tradition;
}
function getTraditionDetails(traditionNumber) {
    const traditions = {
        1: {
            title: "Our common welfare should come first; personal recovery depends upon A.A. unity.",
            description: "Unity is essential. Without it, we have nothing. Group unity must come before personal desires.",
            reflectionQuestions: [
                "How does our group practice unity?",
                "Are there any actions threatening group unity?",
                "How can we better support each other's recovery?"
            ]
        },
        2: {
            title: "For our group purpose there is but one ultimate authority—a loving God as He may express Himself in our group conscience. Our leaders are but trusted servants; they do not govern.",
            description: "Group conscience, not individuals, guides us. Leaders serve rather than govern.",
            reflectionQuestions: [
                "Do we truly seek group conscience or just majority vote?",
                "Are our trusted servants serving or governing?",
                "How do we listen for God's will in our decisions?"
            ]
        },
        3: {
            title: "The only requirement for A.A. membership is a desire to stop drinking.",
            description: "No barriers to membership. Anyone who wants to stop drinking is welcome.",
            reflectionQuestions: [
                "Do we make everyone feel welcome?",
                "Are there any unwritten requirements we've created?",
                "How do we receive newcomers?"
            ]
        },
        4: {
            title: "Each group should be autonomous except in matters affecting other groups or A.A. as a whole.",
            description: "Freedom to operate as we see fit, with responsibility to the fellowship.",
            reflectionQuestions: [
                "Are we exercising our autonomy responsibly?",
                "Do our actions affect other groups or AA as a whole?",
                "Are we following AA principles in our autonomy?"
            ]
        },
        5: {
            title: "Each group has but one primary purpose—to carry its message to the alcoholic who still suffers.",
            description: "Our primary purpose guides all decisions. Everything else is secondary.",
            reflectionQuestions: [
                "Is carrying the message our top priority?",
                "Are we diluting our primary purpose?",
                "How effectively are we reaching the suffering alcoholic?"
            ]
        },
        6: {
            title: "An A.A. group ought never endorse, finance, or lend the A.A. name to any related facility or outside enterprise.",
            description: "We maintain our independence and avoid outside affiliations.",
            reflectionQuestions: [
                "Are we keeping AA separate from other organizations?",
                "Do we avoid endorsements?",
                "Are our relationships with facilities appropriate?"
            ]
        },
        7: {
            title: "Every A.A. group ought to be fully self-supporting, declining outside contributions.",
            description: "We pay our own way. Self-support maintains our independence.",
            reflectionQuestions: [
                "Are we fully self-supporting?",
                "Do we meet our financial obligations?",
                "Are we generous with our contributions?"
            ]
        },
        8: {
            title: "Alcoholics Anonymous should remain forever nonprofessional, but our service centers may employ special workers.",
            description: "We carry the message freely. No payment for 12th step work.",
            reflectionQuestions: [
                "Do we maintain our nonprofessional status?",
                "Are there any conflicts of interest?",
                "Do we give freely what was freely given to us?"
            ]
        },
        9: {
            title: "A.A., as such, ought never be organized; but we may create service boards or committees directly responsible to those they serve.",
            description: "Minimal organization. Service structures serve, not govern.",
            reflectionQuestions: [
                "Are our service structures servant, not master?",
                "Do we avoid over-organization?",
                "Are committees responsible to the group?"
            ]
        },
        10: {
            title: "Alcoholics Anonymous has no opinion on outside issues; hence the A.A. name ought never be drawn into public controversy.",
            description: "We stay focused on our primary purpose and avoid controversy.",
            reflectionQuestions: [
                "Do we avoid outside issues?",
                "Have we drawn AA into any controversies?",
                "Do we maintain public neutrality?"
            ]
        },
        11: {
            title: "Our public relations policy is based on attraction rather than promotion; we need always maintain personal anonymity at the level of press, radio, and films.",
            description: "Attraction not promotion. Anonymity protects the fellowship.",
            reflectionQuestions: [
                "Do we practice attraction rather than promotion?",
                "Are we protecting anonymity in public?",
                "How is our group attractive to newcomers?"
            ]
        },
        12: {
            title: "Anonymity is the spiritual foundation of all our traditions, ever reminding us to place principles before personalities.",
            description: "Anonymity keeps us humble and focused on principles.",
            reflectionQuestions: [
                "Do we practice principles before personalities?",
                "How does anonymity protect our fellowship?",
                "Are we humble in our service?"
            ]
        }
    };
    return traditions[traditionNumber] || traditions[1];
}
function displayTraditionOfMonth() {
    const traditionNum = getTraditionOfMonth();
    const tradition = getTraditionDetails(traditionNum);
    const modal = document.createElement('div');
    modal.id = 'tradition-modal';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 1rem;';
    const content = document.createElement('div');
    content.style.cssText = 'background: #34495e; padding: 2rem; border-radius: 8px; max-width: 700px; max-height: 90vh; overflow-y: auto; width: 100%;';
    content.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="color: #3498db; margin: 0;">Tradition ${traditionNum} - ${new Date().toLocaleString('default', { month: 'long' })}</h2>
            <button onclick="closeTraditionModal()" style="background: #e74c3c; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Close</button>
        </div>
        <div style="background: #2c3e50; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid #3498db;">
            <p style="color: #ecf0f1; font-size: 1.1rem; font-style: italic; line-height: 1.6;">
                "${tradition.title}"
            </p>
        </div>
        <div style="background: #2c3e50; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
            <h3 style="color: #3498db; margin: 0 0 1rem 0;">Understanding This Tradition</h3>
            <p style="color: #ecf0f1; line-height: 1.6;">${tradition.description}</p>
        </div>
        <div style="background: #2c3e50; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
            <h3 style="color: #3498db; margin: 0 0 1rem 0;">Reflection Questions</h3>
            <ul style="color: #ecf0f1; line-height: 1.8; padding-left: 1.5rem;">
                ${tradition.reflectionQuestions.map(q => `<li style="margin-bottom: 0.5rem;">${q}</li>`).join('')}
            </ul>
        </div>
        <div style="margin-top: 1.5rem; text-align: center;">
            <button onclick="scheduleGroupInventory(${traditionNum})" style="background: #2ecc71; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer;">
                Schedule Group Inventory on This Tradition
            </button>
        </div>
    `;
    modal.appendChild(content);
    document.body.appendChild(modal);
    modal.onclick = (e) => {
        if (e.target === modal) closeTraditionModal();
    };
}
function closeTraditionModal() {
    const modal = document.getElementById('tradition-modal');
    if (modal) modal.remove();
}
function scheduleGroupInventory(traditionNumber = null) {
    const modal = document.createElement('div');
    modal.id = 'inventory-schedule-modal';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10001; display: flex; align-items: center; justify-content: center; padding: 1rem;';
    const content = document.createElement('div');
    content.style.cssText = 'background: #34495e; padding: 2rem; border-radius: 8px; max-width: 600px; width: 100%;';
    const inventoryTypes = [
        {value: 'traditions', label: '12 Traditions Inventory', duration: '2-3 hours'},
        {value: 'concepts', label: '12 Concepts Inventory', duration: '2-3 hours'},
        {value: 'format', label: 'Meeting Format Inventory', duration: '1-2 hours'},
        {value: 'service', label: 'Service Structure Inventory', duration: '1-2 hours'},
        {value: 'custom', label: 'Custom Group Inventory', duration: 'Varies'}
    ];
    content.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="color: #3498db; margin: 0;">Schedule Group Inventory</h2>
            <button onclick="closeInventoryScheduleModal()" style="background: #e74c3c; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Close</button>
        </div>
        <div class="form-group">
            <label>Inventory Type</label>
            <select id="inventory-type" onchange="updateInventoryPreview()">
                ${inventoryTypes.map(t => `
                    <option value="${t.value}" ${traditionNumber && t.value === 'traditions' ? 'selected' : ''}>
                        ${t.label} (${t.duration})
                    </option>
                `).join('')}
            </select>
        </div>
        <div class="form-group">
            <label>Scheduled Date</label>
            <input type="date" id="inventory-date" />
        </div>
        <div class="form-group">
            <label>Facilitator</label>
            <input type="text" id="inventory-facilitator" placeholder="Who will lead the inventory?" />
        </div>
        <div id="inventory-preview" style="background: #2c3e50; padding: 1rem; border-radius: 6px; margin: 1rem 0;">
            <h4 style="color: #3498db; margin: 0 0 0.5rem 0;">Inventory Preview</h4>
            <p style="color: #ecf0f1; font-size: 0.9rem;">Select a type to see details</p>
        </div>
        <div style="margin-top: 1.5rem; text-align: center;">
            <button onclick="createInventorySchedule()" style="background: #2ecc71; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer; margin-right: 0.5rem;">
                Schedule Inventory
            </button>
            <button onclick="closeInventoryScheduleModal()" style="background: #95a5a6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer;">
                Cancel
            </button>
        </div>
    `;
    modal.appendChild(content);
    document.body.appendChild(modal);
    const nextMonth = new Date();
    nextMonth.setMonth(nextMonth.getMonth() + 1);
    document.getElementById('inventory-date').value = nextMonth.toISOString().split('T')[0];
    updateInventoryPreview();
}
function updateInventoryPreview() {
    const type = document.getElementById('inventory-type')?.value;
    const preview = document.getElementById('inventory-preview');
    if (!type || !preview) return;
    const inventoryContent = {
        traditions: {
            title: '12 Traditions Inventory',
            description: 'A comprehensive review of how well the group follows each of the 12 Traditions.',
            questions: ['Are we unified as a group?', 'Do leaders serve or govern?', 'Is anyone excluded?', 'Are we autonomous responsibly?']
        },
        concepts: {
            title: '12 Concepts Inventory',
            description: 'Review of service structure and leadership principles.',
            questions: ['Is authority properly placed?', 'Do we respect the right of decision?', 'Is participation encouraged?']
        },
        format: {
            title: 'Meeting Format Inventory',
            description: 'Evaluate meeting structure, timing, and effectiveness.',
            questions: ['Is our format effective?', 'Do we follow the format consistently?', 'Is there time for everyone to share?']
        },
        service: {
            title: 'Service Structure Inventory',
            description: 'Review service positions, rotation, and effectiveness.',
            questions: ['Are all positions filled?', 'Is rotation happening?', 'Are servants supported?']
        },
        custom: {
            title: 'Custom Group Inventory',
            description: 'Create your own inventory questions based on group needs.',
            questions: ['Define your own questions', 'Address specific group concerns']
        }
    };
    const content = inventoryContent[type];
    preview.innerHTML = `
        <h4 style="color: #3498db; margin: 0 0 0.5rem 0;">${content.title}</h4>
        <p style="color: #ecf0f1; font-size: 0.9rem; margin-bottom: 0.75rem;">${content.description}</p>
        <p style="color: #95a5a6; font-size: 0.85rem;"><strong>Sample Questions:</strong></p>
        <ul style="color: #95a5a6; font-size: 0.85rem; padding-left: 1.5rem;">
            ${content.questions.map(q => `<li>${q}</li>`).join('')}
        </ul>
    `;
}
function createInventorySchedule() {
    const type = document.getElementById('inventory-type').value;
    const date = document.getElementById('inventory-date').value;
    const facilitator = document.getElementById('inventory-facilitator').value.trim();
    if (!date) {
        showToast('Please select a date', 'error');
        return;
    }
    const inventories = JSON.parse(localStorage.getItem('groupInventories') || '[]');
    const inventory = {
        id: genId(),
        type: type,
        date: date,
        facilitator: facilitator,
        status: 'scheduled',
        createdDate: new Date().toISOString(),
        results: null,
        actionItems: []
    };
    inventories.push(inventory);
    localStorage.setItem('groupInventories', JSON.stringify(inventories));
    createNotification({
        type: 'group-inventory',
        title: 'Group Inventory Scheduled',
        message: `${type.charAt(0).toUpperCase() + type.slice(1)} inventory scheduled for ${new Date(date).toLocaleDateString()}`,
        priority: 'high',
        actionLink: 'inventory-scheduler-section'
    });
    logAuditEntry('create', 'group-inventory', inventory.id, {type, date, facilitator}, 'Group inventory scheduled');
    showToast('Group inventory scheduled successfully!', 'success');
    closeInventoryScheduleModal();
    closeTraditionModal();
}
function closeInventoryScheduleModal() {
    const modal = document.getElementById('inventory-schedule-modal');
    if (modal) modal.remove();
}
function openGSRDashboard() {
    const modal = document.createElement('div');
    modal.id = 'gsr-dashboard-modal';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 1rem;';
    const districtMotions = JSON.parse(localStorage.getItem('districtMotions') || '[]');
    const pendingMotions = districtMotions.filter(m => m.status === 'pending');
    const content = document.createElement('div');
    content.style.cssText = 'background: #34495e; padding: 2rem; border-radius: 8px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto;';
    content.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="color: #3498db; margin: 0;">GSR Dashboard</h2>
            <button onclick="closeGSRDashboard()" style="background: #e74c3c; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Close</button>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 2rem;">
            <div style="background: #2c3e50; padding: 1.5rem; border-radius: 8px; text-align: center;">
                <h3 style="color: #f39c12; margin: 0; font-size: 2rem;">${pendingMotions.length}</h3>
                <p style="color: #95a5a6; margin: 0.5rem 0 0 0; font-size: 0.9rem;">Pending District Motions</p>
            </div>
            <div style="background: #2c3e50; padding: 1.5rem; border-radius: 8px; text-align: center;">
                <h3 style="color: #3498db; margin: 0; font-size: 1.5rem;">${new Date().toLocaleDateString('default', {month: 'long'})}</h3>
                <p style="color: #95a5a6; margin: 0.5rem 0 0 0; font-size: 0.9rem;">District Meeting</p>
            </div>
            <div style="background: #2c3e50; padding: 1.5rem; border-radius: 8px; text-align: center;">
                <h3 style="color: #2ecc71; margin: 0; font-size: 2rem;">Active</h3>
                <p style="color: #95a5a6; margin: 0.5rem 0 0 0; font-size: 0.9rem;">GSR Status</p>
            </div>
        </div>
        <div style="background: #2c3e50; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
            <h3 style="color: #3498db; margin: 0 0 1rem 0;">Quick Actions</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <button onclick="generateGSRReport()" style="background: #2ecc71; color: white; border: none; padding: 0.75rem; border-radius: 4px; cursor: pointer;">
                    <i class="fas fa-file-alt"></i> Generate GSR Report
                </button>
                <button onclick="displayTraditionOfMonth()" style="background: #9b59b6; color: white; border: none; padding: 0.75rem; border-radius: 4px; cursor: pointer;">
                    <i class="fas fa-book"></i> Tradition of Month
                </button>
            </div>
        </div>
        <div style="background: #2c3e50; padding: 1.5rem; border-radius: 8px;">
            <h3 style="color: #3498db; margin: 0 0 1rem 0;">Pending District Motions</h3>
            ${pendingMotions.length === 0 ?
                '<p style="color: #95a5a6; text-align: center;">No pending motions</p>' :
                pendingMotions.map(m => `
                    <div style="background: #34495e; padding: 1rem; border-radius: 6px; margin-bottom: 0.75rem;">
                        <h4 style="color: #3498db; margin: 0 0 0.5rem 0;">${escapeHtml(m.title || 'District Motion')}</h4>
                        <p style="color: #ecf0f1; font-size: 0.9rem; margin: 0 0 0.5rem 0;">${escapeHtml(m.description || '')}</p>
                        <small style="color: #95a5a6;">Due: ${m.deadline ? new Date(m.deadline).toLocaleDateString() : 'TBD'}</small>
                    </div>
                `).join('')
            }
        </div>
    `;
    modal.appendChild(content);
    document.body.appendChild(modal);
    modal.onclick = (e) => {
        if (e.target === modal) closeGSRDashboard();
    };
}
function closeGSRDashboard() {
    const modal = document.getElementById('gsr-dashboard-modal');
    if (modal) modal.remove();
}
function generateGSRReport() {
    const gcLogs = storage.getGroupConscienceLog();
    const recentGC = gcLogs.filter(log => {
        const logDate = new Date(log.date);
        const monthsAgo = new Date();
        monthsAgo.setMonth(monthsAgo.getMonth() - 1);
        return logDate >= monthsAgo;
    });
    const chairpersonLogs = storage.getChairpersonLog();
    const recentMeetings = chairpersonLogs.filter(log => {
        const logDate = new Date(log.date);
        const monthsAgo = new Date();
        monthsAgo.setMonth(monthsAgo.getMonth() - 1);
        return logDate >= monthsAgo;
    });
    const totalContributions = recentMeetings.reduce((sum, log) => sum + (parseFloat(log.tradition) || 0), 0);
    const avgAttendance = recentMeetings.length > 0
        ? Math.round(recentMeetings.reduce((sum, log) => sum + (parseInt(log.headcount) || 0), 0) / recentMeetings.length)
        : 0;
    const report = `
GSR MONTHLY REPORT
${new Date().toLocaleDateString('default', { month: 'long', year: 'numeric' })}
GROUP INFORMATION:
- Meetings This Month: ${recentMeetings.length}
- Average Attendance: ${avgAttendance}
- Total 7th Tradition: $${totalContributions.toFixed(2)}
GROUP CONSCIENCE ACTIVITY:
- Motions Voted: ${recentGC.length}
- Passed: ${recentGC.filter(m => m.status === 'passed').length}
- Failed: ${recentGC.filter(m => m.status === 'failed').length}
- Tabled: ${recentGC.filter(m => m.status === 'tabled').length}
KEY DECISIONS:
${recentGC.slice(0, 5).map(m => `- ${m.item} (${m.status})`).join('\n')}
GROUP HEALTH:
Our group is ${avgAttendance >= 10 ? 'strong and growing' : 'stable'}.
Respectfully submitted,
[GSR Name]
${new Date().toLocaleDateString()}
    `;
    const blob = new Blob([report], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `gsr-report-${new Date().toISOString().split('T')[0]}.txt`;
    a.click();
    URL.revokeObjectURL(url);
    showToast('GSR report generated and downloaded', 'success');
    logAuditEntry('export', 'gsr-report', genId(), null, 'GSR report generated');
}
function displayExecutiveDashboard() {
    const members = storage.getMembers();
    const positions = storage.getServicePositions();
    const gcLogs = storage.getGroupConscienceLog();
    const expenses = storage.getExpenses();
    const chairpersonLogs = storage.getChairpersonLog();
    const filledPositions = positions.filter(p => p.currentHolder && p.currentHolder !== '').length;
    const totalPositions = positions.length;
    const positionFillRate = totalPositions > 0 ? Math.round((filledPositions / totalPositions) * 100) : 0;
    const recentGC = gcLogs.filter(log => {
        const logDate = new Date(log.date);
        const monthsAgo = new Date();
        monthsAgo.setMonth(monthsAgo.getMonth() - 1);
        return logDate >= monthsAgo;
    });
    const recentMeetings = chairpersonLogs.filter(log => {
        const logDate = new Date(log.date);
        const monthsAgo = new Date();
        monthsAgo.setMonth(monthsAgo.getMonth() - 1);
        return logDate >= monthsAgo;
    });
    const avgAttendance = recentMeetings.length > 0
        ? Math.round(recentMeetings.reduce((sum, log) => sum + (parseInt(log.headcount) || 0), 0) / recentMeetings.length)
        : 0;
    const totalIncome = recentMeetings.reduce((sum, log) => sum + (parseFloat(log.tradition) || 0), 0);
    const recentExpenses = expenses.filter(e => {
        const expDate = new Date(e.date);
        const monthsAgo = new Date();
        monthsAgo.setMonth(monthsAgo.getMonth() - 1);
        return expDate >= monthsAgo;
    });
    const totalExpenses = recentExpenses.reduce((sum, e) => sum + e.amount, 0);
    const currentBalance = parseFloat(localStorage.getItem('treasurerBalance') || 0);
    const engagementMetrics = getGroupEngagementMetrics();
    const unreadNotifications = getUnreadNotifications();
    const modal = document.createElement('div');
    modal.id = 'exec-dashboard-modal';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 1rem;';
    const content = document.createElement('div');
    content.style.cssText = 'background: #34495e; padding: 2rem; border-radius: 8px; max-width: 1200px; width: 100%; max-height: 90vh; overflow-y: auto;';
    content.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="color: #3498db; margin: 0;">Executive Dashboard</h2>
            <button onclick="closeExecutiveDashboard()" style="background: #e74c3c; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Close</button>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
            <div style="background: #2c3e50; padding: 1.5rem; border-radius: 8px; text-align: center; border-left: 4px solid #3498db;">
                <h3 style="color: #3498db; margin: 0; font-size: 2rem;">${members.length}</h3>
                <p style="color: #95a5a6; margin: 0.5rem 0 0 0; font-size: 0.9rem;">Active Members</p>
            </div>
            <div style="background: #2c3e50; padding: 1.5rem; border-radius: 8px; text-align: center; border-left: 4px solid ${avgAttendance >= 10 ? '#2ecc71' : '#f39c12'};">
                <h3 style="color: ${avgAttendance >= 10 ? '#2ecc71' : '#f39c12'}; margin: 0; font-size: 2rem;">${avgAttendance}</h3>
                <p style="color: #95a5a6; margin: 0.5rem 0 0 0; font-size: 0.9rem;">Avg Attendance</p>
            </div>
            <div style="background: #2c3e50; padding: 1.5rem; border-radius: 8px; text-align: center; border-left: 4px solid ${positionFillRate >= 80 ? '#2ecc71' : '#e74c3c'};">
                <h3 style="color: ${positionFillRate >= 80 ? '#2ecc71' : '#e74c3c'}; margin: 0; font-size: 2rem;">${positionFillRate}%</h3>
                <p style="color: #95a5a6; margin: 0.5rem 0 0 0; font-size: 0.9rem;">Positions Filled</p>
            </div>
            <div style="background: #2c3e50; padding: 1.5rem; border-radius: 8px; text-align: center; border-left: 4px solid ${currentBalance > 0 ? '#2ecc71' : '#e74c3c'};">
                <h3 style="color: ${currentBalance > 0 ? '#2ecc71' : '#e74c3c'}; margin: 0; font-size: 2rem;">$${currentBalance.toFixed(0)}</h3>
                <p style="color: #95a5a6; margin: 0.5rem 0 0 0; font-size: 0.9rem;">Current Balance</p>
            </div>
            <div style="background: #2c3e50; padding: 1.5rem; border-radius: 8px; text-align: center; border-left: 4px solid ${engagementMetrics.averageScore >= 60 ? '#2ecc71' : '#e74c3c'};">
                <h3 style="color: ${engagementMetrics.averageScore >= 60 ? '#2ecc71' : '#e74c3c'}; margin: 0; font-size: 2rem;">${engagementMetrics.averageScore}%</h3>
                <p style="color: #95a5a6; margin: 0.5rem 0 0 0; font-size: 0.9rem;">Engagement Score</p>
            </div>
            <div style="background: #2c3e50; padding: 1.5rem; border-radius: 8px; text-align: center; border-left: 4px solid ${unreadNotifications.length > 0 ? '#f39c12' : '#95a5a6'};">
                <h3 style="color: ${unreadNotifications.length > 0 ? '#f39c12' : '#95a5a6'}; margin: 0; font-size: 2rem;">${unreadNotifications.length}</h3>
                <p style="color: #95a5a6; margin: 0.5rem 0 0 0; font-size: 0.9rem;">Pending Items</p>
            </div>
        </div>
        <div style="background: #2c3e50; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
            <h3 style="color: #3498db; margin: 0 0 1rem 0;">Financial Health (Last 30 Days)</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                <div>
                    <p style="margin: 0; color: #95a5a6; font-size: 0.9rem;">Income</p>
                    <p style="margin: 0.25rem 0 0 0; color: #2ecc71; font-size: 1.5rem; font-weight: bold;">$${totalIncome.toFixed(2)}</p>
                </div>
                <div>
                    <p style="margin: 0; color: #95a5a6; font-size: 0.9rem;">Expenses</p>
                    <p style="margin: 0.25rem 0 0 0; color: #e74c3c; font-size: 1.5rem; font-weight: bold;">$${totalExpenses.toFixed(2)}</p>
                </div>
                <div>
                    <p style="margin: 0; color: #95a5a6; font-size: 0.9rem;">Net</p>
                    <p style="margin: 0.25rem 0 0 0; color: ${(totalIncome - totalExpenses) >= 0 ? '#2ecc71' : '#e74c3c'}; font-size: 1.5rem; font-weight: bold;">
                        ${(totalIncome - totalExpenses) >= 0 ? '+' : ''}$${(totalIncome - totalExpenses).toFixed(2)}
                    </p>
                </div>
            </div>
        </div>
        <div style="background: #2c3e50; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
            <h3 style="color: #3498db; margin: 0 0 1rem 0;">Recent Group Conscience</h3>
            ${recentGC.length === 0 ?
                '<p style="color: #95a5a6;">No recent GC activity</p>' :
                recentGC.slice(0, 3).map(gc => `
                    <div style="padding: 0.75rem 0; border-bottom: 1px solid #34495e;">
                        <p style="margin: 0; color: #ecf0f1;">${escapeHtml(gc.item.substring(0, 80))}${gc.item.length > 80 ? '...' : ''}</p>
                        <small style="color: ${gc.status === 'passed' ? '#2ecc71' : gc.status === 'failed' ? '#e74c3c' : '#f39c12'};">
                            ${gc.status.toUpperCase()} - ${new Date(gc.date).toLocaleDateString()}
                        </small>
                    </div>
                `).join('')
            }
        </div>
        <div style="background: #2c3e50; padding: 1.5rem; border-radius: 8px;">
            <h3 style="color: #3498db; margin: 0 0 1rem 0;">Quick Actions</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                <button onclick="displayTreasurerReport()" style="background: #2ecc71; color: white; border: none; padding: 0.75rem; border-radius: 4px; cursor: pointer;">
                    <i class="fas fa-file-invoice-dollar"></i><br>Treasurer Report
                </button>
                <button onclick="generateGSRReport()" style="background: #3498db; color: white; border: none; padding: 0.75rem; border-radius: 4px; cursor: pointer;">
                    <i class="fas fa-file-alt"></i><br>GSR Report
                </button>
                <button onclick="displayEngagementDashboard()" style="background: #9b59b6; color: white; border: none; padding: 0.75rem; border-radius: 4px; cursor: pointer;">
                    <i class="fas fa-chart-line"></i><br>Engagement
                </button>
                <button onclick="displayTraditionOfMonth()" style="background: #e67e22; color: white; border: none; padding: 0.75rem; border-radius: 4px; cursor: pointer;">
                    <i class="fas fa-book"></i><br>Tradition
                </button>
            </div>
        </div>
    `;
    modal.appendChild(content);
    document.body.appendChild(modal);
    modal.onclick = (e) => {
        if (e.target === modal) closeExecutiveDashboard();
    };
}
function closeExecutiveDashboard() {
    const modal = document.getElementById('exec-dashboard-modal');
    if (modal) modal.remove();
}
function performUniversalSearch(query) {
    if (!query || query.trim().length < 2) {
        return { results: [], totalCount: 0 };
    }
    const searchTerm = query.toLowerCase().trim();
    const results = [];
    const members = storage.getMembers();
    members.forEach(m => {
        if (m.name?.toLowerCase().includes(searchTerm) ||
            m.email?.toLowerCase().includes(searchTerm) ||
            m.phone?.toLowerCase().includes(searchTerm)) {
            results.push({
                type: 'member',
                title: m.name,
                description: `${m.email || ''} ${m.phone || ''}`,
                section: 'birthdays-section',
                id: m.id
            });
        }
    });
    const gcLogs = storage.getGroupConscienceLog();
    gcLogs.forEach(gc => {
        if (gc.item?.toLowerCase().includes(searchTerm) ||
            gc.submittedBy?.toLowerCase().includes(searchTerm)) {
            results.push({
                type: 'gc-motion',
                title: gc.item.substring(0, 100),
                description: `${gc.status} - ${new Date(gc.date).toLocaleDateString()}`,
                section: 'home-section',
                id: gc.id
            });
        }
    });
    const positions = storage.getServicePositions();
    positions.forEach(p => {
        if (p.name?.toLowerCase().includes(searchTerm) ||
            p.currentHolder?.toLowerCase().includes(searchTerm) ||
            p.description?.toLowerCase().includes(searchTerm)) {
            results.push({
                type: 'service-position',
                title: p.name,
                description: `Held by: ${p.currentHolder || 'Vacant'}`,
                section: 'service-positions-section',
                id: p.id
            });
        }
    });
    const events = storage.getEvents();
    events.forEach(e => {
        if (e.title?.toLowerCase().includes(searchTerm) ||
            e.description?.toLowerCase().includes(searchTerm) ||
            e.location?.toLowerCase().includes(searchTerm)) {
            results.push({
                type: 'event',
                title: e.title,
                description: `${new Date(e.date).toLocaleDateString()} - ${e.location || ''}`,
                section: 'schedule-section',
                id: e.id
            });
        }
    });
    const expenses = storage.getExpenses();
    expenses.forEach(exp => {
        if (exp.description?.toLowerCase().includes(searchTerm) ||
            exp.category?.toLowerCase().includes(searchTerm)) {
            results.push({
                type: 'expense',
                title: exp.description,
                description: `$${exp.amount.toFixed(2)} - ${exp.category}`,
                section: 'finance-section',
                id: exp.id
            });
        }
    });
    return {
        results: results,
        totalCount: results.length
    };
}
function displayUniversalSearch() {
    const modal = document.createElement('div');
    modal.id = 'universal-search-modal';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: flex-start; justify-content: center; padding-top: 3rem;';
    const content = document.createElement('div');
    content.style.cssText = 'background: #34495e; padding: 2rem; border-radius: 8px; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto;';
    content.innerHTML = `
        <div style="margin-bottom: 1.5rem;">
            <input type="text" id="universal-search-input" placeholder="Search everything..."
                   style="width: 100%; padding: 1rem; font-size: 1.1rem; border: 2px solid #3498db; border-radius: 6px; background: #2c3e50; color: #ecf0f1;"
                   oninput="updateUniversalSearchResults()" />
        </div>
        <div id="universal-search-results" style="min-height: 200px;">
            <p style="color: #95a5a6; text-align: center;">Type to search across all data...</p>
        </div>
    `;
    modal.appendChild(content);
    document.body.appendChild(modal);
    setTimeout(() => {
        document.getElementById('universal-search-input')?.focus();
    }, 100);
    modal.onclick = (e) => {
        if (e.target === modal) closeUniversalSearch();
    };
    document.addEventListener('keydown', function escapeHandler(e) {
        if (e.key === 'Escape') {
            closeUniversalSearch();
            document.removeEventListener('keydown', escapeHandler);
        }
    });
}
function updateUniversalSearchResults() {
    const query = document.getElementById('universal-search-input')?.value || '';
    const resultsDiv = document.getElementById('universal-search-results');
    if (!resultsDiv) return;
    if (query.trim().length < 2) {
        resultsDiv.innerHTML = '<p style="color: #95a5a6; text-align: center;">Type at least 2 characters to search...</p>';
        return;
    }
    const searchResults = performUniversalSearch(query);
    if (searchResults.totalCount === 0) {
        resultsDiv.innerHTML = '<p style="color: #95a5a6; text-align: center;">No results found</p>';
        return;
    }
    const typeColors = {
        'member': '#2ecc71',
        'gc-motion': '#3498db',
        'service-position': '#9b59b6',
        'event': '#f39c12',
        'expense': '#e74c3c'
    };
    resultsDiv.innerHTML = `
        <p style="color: #95a5a6; margin-bottom: 1rem;">${searchResults.totalCount} result${searchResults.totalCount !== 1 ? 's' : ''} found</p>
        ${searchResults.results.map(r => `
            <div onclick="goToSection('${r.section}'); closeUniversalSearch();"
                 style="background: #2c3e50; padding: 1rem; border-radius: 6px; margin-bottom: 0.75rem; cursor: pointer; border-left: 4px solid ${typeColors[r.type]};"
                 onmouseover="this.style.background='#34495e'" onmouseout="this.style.background='#2c3e50'">
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <span style="background: ${typeColors[r.type]}; color: white; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.75rem;">
                        ${r.type.toUpperCase()}
                    </span>
                    <div style="flex: 1;">
                        <h4 style="color: #ecf0f1; margin: 0; font-size: 0.95rem;">${escapeHtml(r.title)}</h4>
                        <p style="color: #95a5a6; margin: 0.25rem 0 0 0; font-size: 0.85rem;">${escapeHtml(r.description)}</p>
                    </div>
                </div>
            </div>
        `).join('')}
    `;
}
function closeUniversalSearch() {
    const modal = document.getElementById('universal-search-modal');
    if (modal) modal.remove();
}
function showFinanceTab(tab) {
    document.querySelectorAll('.finance-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.history-nav button').forEach(b => b.classList.remove('active'));
    document.getElementById(`${tab}-content`).classList.add('active');
    document.getElementById(`${tab}-tab`).classList.add('active');
    if (tab === 'budget') updateBudgetTable();
    if (tab === 'expenses') updateExpensesTable();
    if (tab === 'reports') {
        const today = new Date();
        const month = today.toISOString().substring(0, 7);
        document.getElementById('report-month').value = month;
    }
}
function addBudgetCategory() {
    const category = document.getElementById('budget-category').value.trim();
    const amount = parseFloat(document.getElementById('budget-amount').value);
    if (!category || isNaN(amount) || amount < 0) {
        showToast('Please enter valid category and amount', 'error');
        return;
    }
    const categories = storage.getBudgetCategories();
    categories.push({
        id: genId(),
        category: category,
        monthlyBudget: amount
    });
    storage.saveBudgetCategories(categories);
    showToast('Budget category added!', 'success');
    document.getElementById('budget-category').value = '';
    document.getElementById('budget-amount').value = '';
    updateBudgetTable();
    populateExpenseCategories();
}
function updateBudgetTable() {
    const tbody = document.getElementById('budget-table');
    const categories = storage.getBudgetCategories();
    const expenses = storage.getExpenses();
    const today = new Date();
    const currentMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
    tbody.innerHTML = '';
    categories.forEach(cat => {
        const monthExpenses = expenses.filter(e => {
            const expenseMonth = e.date.substring(0, 7);
            return e.category === cat.category && expenseMonth === currentMonth;
        });
        const spent = monthExpenses.reduce((sum, e) => sum + e.amount, 0);
        const remaining = cat.monthlyBudget - spent;
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${cat.category}</td>
            <td>$${cat.monthlyBudget.toFixed(2)}</td>
            <td>$${spent.toFixed(2)}</td>
            <td style="color: ${remaining < 0 ? '#e74c3c' : '#2ecc71'}">$${remaining.toFixed(2)}</td>
            <td>
                <button class="btn secondary" data-action="delete-budget-category" data-id="${escapeAttribute(cat.id)}">Delete</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
    if (categories.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5">No budget categories defined</td></tr>';
    }
}
function deleteBudgetCategory(id) {
    if (!confirm('Delete this budget category?')) return;
    let categories = storage.getBudgetCategories();
    categories = categories.filter(c => c.id !== id);
    storage.saveBudgetCategories(categories);
    updateBudgetTable();
    populateExpenseCategories();
    showToast('Category deleted', 'success');
}
function generateMonthlyTreasurerReport(month) {
    const targetMonth = month || new Date().toISOString().substring(0, 7);
    const [year, monthNum] = targetMonth.split('-');
    const monthName = new Date(year, parseInt(monthNum) - 1, 1).toLocaleString('default', { month: 'long' });
    const expenses = storage.getExpenses();
    const categories = storage.getBudgetCategories();
    const chairpersonLogs = storage.getChairpersonLog();
    const monthExpenses = expenses.filter(e => e.date.substring(0, 7) === targetMonth);
    const monthLogs = chairpersonLogs.filter(log => log.date.substring(0, 7) === targetMonth);
    const contributions = monthLogs.reduce((sum, log) => sum + (parseFloat(log.tradition) || 0), 0);
    const orangeCan = monthLogs.reduce((sum, log) => sum + (parseFloat(log.orangeCan) || 0), 0);
    const totalIncome = contributions + orangeCan;
    const expensesByCategory = {};
    let totalExpenses = 0;
    categories.forEach(cat => {
        const catExpenses = monthExpenses.filter(e => e.category === cat.category);
        const spent = catExpenses.reduce((sum, e) => sum + e.amount, 0);
        expensesByCategory[cat.category] = {
            budgeted: cat.monthlyBudget,
            spent: spent,
            remaining: cat.monthlyBudget - spent
        };
        totalExpenses += spent;
    });
    const netChange = totalIncome - totalExpenses;
    const prevMonthBalance = parseFloat(localStorage.getItem('treasurerBalance')) || 0;
    const currentBalance = prevMonthBalance + netChange;
    const avgMonthlyExpenses = totalExpenses || calculateAvgMonthlyExpenses(3); // Use 3-month average
    const prudentReserve = avgMonthlyExpenses * 3; // 3 months operating expenses
    const reserveStatus = currentBalance >= prudentReserve ? 'Healthy' : 'Below Target';
    const reserveMonths = avgMonthlyExpenses > 0 ? (currentBalance / avgMonthlyExpenses).toFixed(1) : 'N/A';
    const report = `
<div style="padding: 2rem; background: #2c3e50; color: #ecf0f1; font-family: Arial, sans-serif;">
    <h1 style="color: #3498db; border-bottom: 2px solid #3498db; padding-bottom: 1rem;">
        Treasurer's Report - ${monthName} ${year}
    </h1>
    <div style="background: #34495e; padding: 1.5rem; border-radius: 8px; margin: 2rem 0;">
        <h2 style="color: #3498db; margin-bottom: 1rem;">Financial Summary</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div>
                <p style="margin: 0.5rem 0;"><strong>Beginning Balance:</strong> $${prevMonthBalance.toFixed(2)}</p>
                <p style="margin: 0.5rem 0; color: #2ecc71;"><strong>Total Income:</strong> $${totalIncome.toFixed(2)}</p>
                <p style="margin: 0.5rem 0; color: #e74c3c;"><strong>Total Expenses:</strong> $${totalExpenses.toFixed(2)}</p>
                <p style="margin: 0.5rem 0; border-top: 1px solid #7f8c8d; padding-top: 0.5rem;">
                    <strong>Net Change:</strong>
                    <span style="color: ${netChange >= 0 ? '#2ecc71' : '#e74c3c'}">
                        ${netChange >= 0 ? '+' : ''}$${netChange.toFixed(2)}
                    </span>
                </p>
                <p style="margin: 0.5rem 0; font-size: 1.2rem; font-weight: bold; color: #3498db;">
                    <strong>Ending Balance:</strong> $${currentBalance.toFixed(2)}
                </p>
            </div>
            <div>
                <p style="margin: 0.5rem 0;"><strong>7th Tradition:</strong> $${contributions.toFixed(2)}</p>
                <p style="margin: 0.5rem 0;"><strong>Orange Can:</strong> $${orangeCan.toFixed(2)}</p>
                <p style="margin: 0.5rem 0;"><strong>Meetings This Month:</strong> ${monthLogs.length}</p>
                <p style="margin: 0.5rem 0;"><strong>Avg per Meeting:</strong> $${monthLogs.length > 0 ? (contributions / monthLogs.length).toFixed(2) : '0.00'}</p>
            </div>
        </div>
    </div>
    <div style="background: ${reserveStatus === 'Healthy' ? '#27ae60' : '#e67e22'}; padding: 1.5rem; border-radius: 8px; margin: 2rem 0;">
        <h3 style="margin: 0; color: white;">Prudent Reserve Status: ${reserveStatus}</h3>
        <p style="margin: 0.5rem 0 0 0; color: white;">
            Current balance covers <strong>${reserveMonths} months</strong> of operating expenses
            (Target: 3 months = $${prudentReserve.toFixed(2)})
        </p>
    </div>
    <div style="background: #34495e; padding: 1.5rem; border-radius: 8px; margin: 2rem 0;">
        <h2 style="color: #3498db; margin-bottom: 1rem;">Budget vs. Actual</h2>
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #2c3e50;">
                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #3498db;">Category</th>
                    <th style="padding: 0.75rem; text-align: right; border-bottom: 2px solid #3498db;">Budgeted</th>
                    <th style="padding: 0.75rem; text-align: right; border-bottom: 2px solid #3498db;">Spent</th>
                    <th style="padding: 0.75rem; text-align: right; border-bottom: 2px solid #3498db;">Remaining</th>
                    <th style="padding: 0.75rem; text-align: right; border-bottom: 2px solid #3498db;">% Used</th>
                </tr>
            </thead>
            <tbody>
                ${Object.entries(expensesByCategory).map(([cat, data]) => {
                    const pctUsed = data.budgeted > 0 ? ((data.spent / data.budgeted) * 100) : 0;
                    const statusColor = pctUsed > 100 ? '#e74c3c' : pctUsed > 80 ? '#f39c12' : '#2ecc71';
                    return `
                    <tr style="border-bottom: 1px solid #7f8c8d;">
                        <td style="padding: 0.75rem;">${cat}</td>
                        <td style="padding: 0.75rem; text-align: right;">$${data.budgeted.toFixed(2)}</td>
                        <td style="padding: 0.75rem; text-align: right;">$${data.spent.toFixed(2)}</td>
                        <td style="padding: 0.75rem; text-align: right; color: ${data.remaining < 0 ? '#e74c3c' : '#2ecc71'};">
                            $${data.remaining.toFixed(2)}
                        </td>
                        <td style="padding: 0.75rem; text-align: right; color: ${statusColor}; font-weight: bold;">
                            ${pctUsed.toFixed(0)}%
                        </td>
                    </tr>`;
                }).join('')}
            </tbody>
        </table>
    </div>
    ${generateTreasurerConcerns(expensesByCategory, currentBalance, prudentReserve, contributions, prevMonthBalance)}
    <div style="margin-top: 3rem; padding-top: 1rem; border-top: 1px solid #7f8c8d; text-align: center; color: #95a5a6;">
        <p>Generated by HomeGroup Management Portal</p>
        <p>Report Date: ${new Date().toLocaleDateString()}</p>
    </div>
</div>`;
    localStorage.setItem('treasurerBalance', currentBalance.toString());
    return report;
}
function generateTreasurerConcerns(expensesByCategory, currentBalance, prudentReserve, contributions, prevMonthBalance) {
    const concerns = [];
    if (currentBalance < prudentReserve) {
        const shortfall = prudentReserve - currentBalance;
        concerns.push(`<li><strong>Low Reserve:</strong> Current balance is $${shortfall.toFixed(2)} below the prudent reserve target.</li>`);
    }
    const overbudget = Object.entries(expensesByCategory).filter(([cat, data]) => data.remaining < 0);
    if (overbudget.length > 0) {
        concerns.push(`<li><strong>Over Budget:</strong> ${overbudget.length} categor${overbudget.length === 1 ? 'y is' : 'ies are'} over budget: ${overbudget.map(([cat]) => cat).join(', ')}</li>`);
    }
    if (prevMonthBalance > 0 && contributions < (prevMonthBalance * 0.1)) {
        concerns.push(`<li><strong>Low Contributions:</strong> This month's contributions are significantly lower than expected based on previous balance.</li>`);
    }
    if (concerns.length === 0) {
        return `
        <div style="background: #27ae60; padding: 1.5rem; border-radius: 8px; margin: 2rem 0;">
            <h3 style="margin: 0; color: white;"><i class="fas fa-check-circle"></i> No Concerns</h3>
            <p style="margin: 0.5rem 0 0 0; color: white;">Financial health is good. All categories within budget and prudent reserve is maintained.</p>
        </div>`;
    }
    return `
    <div style="background: #e67e22; padding: 1.5rem; border-radius: 8px; margin: 2rem 0;">
        <h3 style="margin: 0 0 1rem 0; color: white;"><i class="fas fa-exclamation-triangle"></i> Concerns & Recommendations</h3>
        <ul style="margin: 0; padding-left: 1.5rem; color: white;">
            ${concerns.join('')}
        </ul>
    </div>`;
}
function calculateAvgMonthlyExpenses(months) {
    const expenses = storage.getExpenses();
    const today = new Date();
    const cutoffDate = new Date(today.getFullYear(), today.getMonth() - months, 1);
    const recentExpenses = expenses.filter(e => new Date(e.date) >= cutoffDate);
    const total = recentExpenses.reduce((sum, e) => sum + e.amount, 0);
    return total / months;
}
function displayTreasurerReport() {
    const month = prompt('Enter month (YYYY-MM) or leave blank for current month:', new Date().toISOString().substring(0, 7));
    if (month === null) return; // Cancelled
    const report = generateMonthlyTreasurerReport(month || undefined);
    const reportWindow = window.open('', 'Treasurer Report', 'width=800,height=600');
    reportWindow.document.write(report);
    reportWindow.document.close();
}
function exportTreasurerReportPDF() {
    const month = prompt('Enter month (YYYY-MM) or leave blank for current month:', new Date().toISOString().substring(0, 7));
    if (month === null) return;
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const targetMonth = month || new Date().toISOString().substring(0, 7);
    const [year, monthNum] = targetMonth.split('-');
    const monthName = new Date(year, parseInt(monthNum) - 1, 1).toLocaleString('default', { month: 'long' });
    const expenses = storage.getExpenses();
    const categories = storage.getBudgetCategories();
    const chairpersonLogs = storage.getChairpersonLog();
    const monthExpenses = expenses.filter(e => e.date.substring(0, 7) === targetMonth);
    const monthLogs = chairpersonLogs.filter(log => log.date.substring(0, 7) === targetMonth);
    const contributions = monthLogs.reduce((sum, log) => sum + (parseFloat(log.tradition) || 0), 0);
    const orangeCan = monthLogs.reduce((sum, log) => sum + (parseFloat(log.orangeCan) || 0), 0);
    const totalIncome = contributions + orangeCan;
    const expensesByCategory = {};
    let totalExpenses = 0;
    categories.forEach(cat => {
        const catExpenses = monthExpenses.filter(e => e.category === cat.category);
        const spent = catExpenses.reduce((sum, e) => sum + e.amount, 0);
        expensesByCategory[cat.category] = {
            budgeted: cat.monthlyBudget,
            spent: spent,
            remaining: cat.monthlyBudget - spent,
            pctUsed: cat.monthlyBudget > 0 ? ((spent / cat.monthlyBudget) * 100) : 0
        };
        totalExpenses += spent;
    });
    const netChange = totalIncome - totalExpenses;
    const prevMonthBalance = parseFloat(localStorage.getItem('treasurerBalance')) || 0;
    const currentBalance = prevMonthBalance + netChange;
    const avgMonthlyExpenses = totalExpenses || 0;
    const prudentReserve = avgMonthlyExpenses * 3;
    const reserveStatus = currentBalance >= prudentReserve ? 'Healthy' : 'Below Target';
    let yPos = 20;
    doc.setFontSize(20);
    doc.setTextColor(52, 152, 219);
    doc.text(`Treasurer's Report - ${monthName} ${year}`, 14, yPos);
    yPos += 15;
    doc.setFontSize(14);
    doc.setTextColor(52, 152, 219);
    doc.text('Financial Summary', 14, yPos);
    yPos += 8;
    doc.setFontSize(11);
    doc.setTextColor(0, 0, 0);
    doc.text(`Beginning Balance: $${prevMonthBalance.toFixed(2)}`, 14, yPos);
    yPos += 6;
    doc.text(`Total Income: $${totalIncome.toFixed(2)}`, 14, yPos);
    yPos += 6;
    doc.text(`Total Expenses: $${totalExpenses.toFixed(2)}`, 14, yPos);
    yPos += 6;
    doc.text(`Net Change: ${netChange >= 0 ? '+' : ''}$${netChange.toFixed(2)}`, 14, yPos);
    yPos += 6;
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text(`Ending Balance: $${currentBalance.toFixed(2)}`, 14, yPos);
    doc.setFont(undefined, 'normal');
    yPos += 10;
    doc.setFontSize(11);
    doc.text(`7th Tradition: $${contributions.toFixed(2)}`, 110, yPos - 30);
    doc.text(`Orange Can: $${orangeCan.toFixed(2)}`, 110, yPos - 24);
    doc.text(`Meetings This Month: ${monthLogs.length}`, 110, yPos - 18);
    doc.text(`Avg per Meeting: $${monthLogs.length > 0 ? (contributions / monthLogs.length).toFixed(2) : '0.00'}`, 110, yPos - 12);
    doc.setFontSize(12);
    doc.setTextColor(reserveStatus === 'Healthy' ? 39 : 230, reserveStatus === 'Healthy' ? 174 : 126, reserveStatus === 'Healthy' ? 96 : 34);
    doc.text(`Prudent Reserve Status: ${reserveStatus}`, 14, yPos);
    yPos += 6;
    doc.setFontSize(10);
    const reserveMonths = avgMonthlyExpenses > 0 ? (currentBalance / avgMonthlyExpenses).toFixed(1) : 'N/A';
    doc.text(`Current balance covers ${reserveMonths} months (Target: 3 months = $${prudentReserve.toFixed(2)})`, 14, yPos);
    yPos += 12;
    doc.setFontSize(14);
    doc.setTextColor(52, 152, 219);
    doc.text('Budget vs. Actual', 14, yPos);
    yPos += 5;
    const tableData = Object.entries(expensesByCategory).map(([cat, data]) => [
        cat,
        `$${data.budgeted.toFixed(2)}`,
        `$${data.spent.toFixed(2)}`,
        `$${data.remaining.toFixed(2)}`,
        `${data.pctUsed.toFixed(0)}%`
    ]);
    doc.autoTable({
        startY: yPos,
        head: [['Category', 'Budgeted', 'Spent', 'Remaining', '% Used']],
        body: tableData,
        theme: 'grid',
        headStyles: { fillColor: [52, 152, 219], textColor: 255 },
        styles: { fontSize: 10 },
        columnStyles: {
            1: { halign: 'right' },
            2: { halign: 'right' },
            3: { halign: 'right' },
            4: { halign: 'right' }
        }
    });
    const pageCount = doc.internal.getNumberOfPages();
    doc.setFontSize(9);
    doc.setTextColor(100, 100, 100);
    for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, doc.internal.pageSize.height - 10);
        doc.text(`Page ${i} of ${pageCount}`, doc.internal.pageSize.width - 30, doc.internal.pageSize.height - 10);
    }
    const filename = `treasurer-report-${month || new Date().toISOString().substring(0, 7)}.pdf`;
    doc.save(filename);
    showToast('Treasurer report exported to PDF', 'success');
}
function updatePrudentReserveProgressBar() {
    const totalBalance = parseFloat(localStorage.getItem('treasurerBalance')) || 0;
    const reserveTarget = parseFloat(localStorage.getItem('reserveTarget')) || 0;
    const monthlyExpenses = parseFloat(localStorage.getItem('monthlyExpenses')) || 0;
    const targetMonths = parseInt(localStorage.getItem('reserveMonths')) || 3;
    const progressBar = document.getElementById('reserve-progress-bar');
    const progressText = document.getElementById('reserve-progress-text');
    const percentageSpan = document.getElementById('reserve-percentage');
    const targetMonthsSpan = document.getElementById('reserve-target-months');
    if (!progressBar || !progressText || !percentageSpan) return;
    const targetAmount = reserveTarget || (monthlyExpenses * targetMonths);
    const percentage = targetAmount > 0 ? Math.min((totalBalance / targetAmount) * 100, 100) : 0;
    const months = monthlyExpenses > 0 ? (totalBalance / monthlyExpenses).toFixed(1) : 0;
    progressBar.style.width = percentage + '%';
    progressText.textContent = months + ' mo';
    percentageSpan.textContent = percentage.toFixed(0) + '%';
    if (targetMonthsSpan) targetMonthsSpan.textContent = targetMonths;
    if (percentage >= 100) {
        progressBar.style.background = '#2ecc71'; // Green - Excellent
    } else if (percentage >= 75) {
        progressBar.style.background = 'linear-gradient(90deg, #f1c40f, #2ecc71)'; // Yellow to Green - Good
    } else if (percentage >= 50) {
        progressBar.style.background = 'linear-gradient(90deg, #f39c12, #f1c40f)'; // Orange to Yellow - Caution
    } else {
        progressBar.style.background = 'linear-gradient(90deg, #e74c3c, #f39c12)'; // Red to Orange - Critical
    }
}
function checkUpcomingTermExpirations() {
    const positions = storage.getServicePositions();
    const today = new Date();
    const notifications = [];
    positions.forEach(pos => {
        if (!pos.startDate || !pos.termLength || !pos.currentHolder) return;
        const startDate = new Date(pos.startDate);
        const termMonths = pos.termLength === 'Indefinite' ? 0 : parseInt(pos.termLength.split(' ')[0]);
        if (termMonths === 0) return; // Skip indefinite terms
        const endDate = new Date(startDate);
        endDate.setMonth(endDate.getMonth() + termMonths);
        const daysUntilEnd = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
        if (daysUntilEnd === 90 && !pos.notificationsSent?.days90) {
            notifications.push({
                type: 'service-term',
                title: `${pos.name} Term Ending in 90 Days`,
                message: `${pos.currentHolder}'s term as ${pos.name} will end on ${endDate.toLocaleDateString()}. Begin succession planning.`,
                priority: 'normal',
                actionLink: 'service-positions-section'
            });
            if (!pos.notificationsSent) pos.notificationsSent = {};
            pos.notificationsSent.days90 = true;
        } else if (daysUntilEnd === 60 && !pos.notificationsSent?.days60) {
            notifications.push({
                type: 'service-term',
                title: `${pos.name} Term Ending in 60 Days`,
                message: `${pos.currentHolder}'s term as ${pos.name} will end on ${endDate.toLocaleDateString()}. Identify potential successors.`,
                priority: 'high',
                actionLink: 'service-positions-section'
            });
            if (!pos.notificationsSent) pos.notificationsSent = {};
            pos.notificationsSent.days60 = true;
        } else if (daysUntilEnd === 30 && !pos.notificationsSent?.days30) {
            notifications.push({
                type: 'service-term',
                title: `${pos.name} Term Ending in 30 Days`,
                message: `${pos.currentHolder}'s term as ${pos.name} will end on ${endDate.toLocaleDateString()}. Begin transition process.`,
                priority: 'urgent',
                actionLink: 'service-positions-section'
            });
            if (!pos.notificationsSent) pos.notificationsSent = {};
            pos.notificationsSent.days30 = true;
        } else if (daysUntilEnd === 14 && !pos.notificationsSent?.days14) {
            notifications.push({
                type: 'service-term',
                title: `${pos.name} Term Ending in 14 Days`,
                message: `URGENT: ${pos.currentHolder}'s term as ${pos.name} will end on ${endDate.toLocaleDateString()}. Ensure transition is underway.`,
                priority: 'urgent',
                actionLink: 'service-positions-section'
            });
            if (!pos.notificationsSent) pos.notificationsSent = {};
            pos.notificationsSent.days14 = true;
        } else if (daysUntilEnd === 7 && !pos.notificationsSent?.days7) {
            notifications.push({
                type: 'service-term',
                title: `${pos.name} Term Ending in 7 Days`,
                message: `CRITICAL: ${pos.currentHolder}'s term as ${pos.name} will end on ${endDate.toLocaleDateString()}. Complete transition immediately.`,
                priority: 'urgent',
                actionLink: 'service-positions-section'
            });
            if (!pos.notificationsSent) pos.notificationsSent = {};
            pos.notificationsSent.days7 = true;
        }
    });
    notifications.forEach(n => createNotification(n));
    storage.saveServicePositions(positions);
}
function getMotionTraditionAlignment(motionText) {
    const traditionKeywords = {
        1: ['unity', 'common welfare', 'together', 'group', 'whole'],
        2: ['god', 'higher power', 'spiritual', 'conscience', 'guidance'],
        3: ['desire to stop drinking', 'membership', 'requirements'],
        4: ['autonomy', 'autonomous', 'independent', 'self-governing'],
        5: ['primary purpose', 'carry the message', 'alcoholic', 'recovery'],
        6: ['endorse', 'finance', 'lend name', 'outside', 'enterprise'],
        7: ['self-supporting', 'contributions', 'decline', 'outside'],
        8: ['non-professional', 'special workers', 'service', 'never'],
        9: ['organization', 'board', 'committee', 'service'],
        10: ['outside issues', 'opinion', 'controversy', 'public'],
        11: ['attraction', 'promotion', 'anonymous', 'personal'],
        12: ['anonymity', 'principles', 'personalities', 'spiritual']
    };
    const text = motionText.toLowerCase();
    const scores = [];
    for (let tradition in traditionKeywords) {
        const keywords = traditionKeywords[tradition];
        const matchCount = keywords.filter(keyword => text.includes(keyword)).length;
        if (matchCount > 0) {
            scores.push({
                tradition: parseInt(tradition),
                score: matchCount,
                keywords: keywords.filter(keyword => text.includes(keyword))
            });
        }
    }
    scores.sort((a, b) => b.score - a.score);
    return scores.length > 0 ? scores[0] : null;
}
function addTraditionBadgeToMotion(motionId) {
    const logs = storage.getGroupConscienceLog();
    const motion = logs.find(l => l.id === motionId);
    if (!motion) return '';
    const alignment = getMotionTraditionAlignment(motion.item);
    if (!alignment) return '';
    const tradition = alignment.tradition;
    const traditionShort = getTraditionDetails(tradition)?.title.substring(0, 30) || `Tradition ${tradition}`;
    return `<span style="background: #9b59b6; color: white; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.75rem; margin-left: 0.5rem;" title="${traditionShort}...">
        <i class="fas fa-book"></i> T${tradition}
    </span>`;
}
function checkUpcomingBirthdaysAndAnniversaries() {
    const members = storage.getMembers();
    const today = new Date();
    const notifications = [];
    members.forEach(member => {
        if (member.birthday) {
            const birthday = new Date(today.getFullYear(),
                new Date(member.birthday).getMonth(),
                new Date(member.birthday).getDate());
            if (birthday < today) {
                birthday.setFullYear(today.getFullYear() + 1);
            }
            const daysUntil = Math.ceil((birthday - today) / (1000 * 60 * 60 * 24));
            if (daysUntil === 7 || daysUntil === 3 || daysUntil === 1) {
                notifications.push({
                    type: 'birthday',
                    title: `Upcoming Birthday: ${member.name}`,
                    message: `${member.name}'s birthday is in ${daysUntil} day${daysUntil !== 1 ? 's' : ''} (${birthday.toLocaleDateString()})`,
                    priority: daysUntil === 1 ? 'high' : 'normal',
                    actionLink: 'birthdays-section'
                });
            }
        }
        if (member.sobrietyDate) {
            const sobrietyDate = new Date(member.sobrietyDate);
            const anniversary = new Date(today.getFullYear(),
                sobrietyDate.getMonth(),
                sobrietyDate.getDate());
            if (anniversary < today) {
                anniversary.setFullYear(today.getFullYear() + 1);
            }
            const daysUntil = Math.ceil((anniversary - today) / (1000 * 60 * 60 * 24));
            const years = today.getFullYear() - sobrietyDate.getFullYear();
            if (daysUntil === 14 || daysUntil === 7 || daysUntil === 3 || daysUntil === 1) {
                notifications.push({
                    type: 'anniversary',
                    title: `Sobriety Anniversary: ${member.name}`,
                    message: `${member.name} will celebrate ${years} year${years !== 1 ? 's' : ''} of sobriety in ${daysUntil} day${daysUntil !== 1 ? 's' : ''} (${anniversary.toLocaleDateString()})`,
                    priority: daysUntil <= 3 ? 'high' : 'normal',
                    actionLink: 'birthdays-section'
                });
            }
        }
    });
    notifications.forEach(n => {
        const existing = JSON.parse(localStorage.getItem('notifications') || '[]');
        const isDuplicate = existing.some(e =>
            e.type === n.type &&
            e.title === n.title &&
            new Date(e.createdDate).toDateString() === today.toDateString()
        );
        if (!isDuplicate) {
            createNotification(n);
        }
    });
}
function checkActionItemReminders() {
    const logs = storage.getGroupConscienceLog();
    const today = new Date();
    const notifications = [];
    logs.forEach(log => {
        if (log.status === 'tabled' && log.followUpDate) {
            const followUp = new Date(log.followUpDate);
            const daysUntil = Math.ceil((followUp - today) / (1000 * 60 * 60 * 24));
            if (daysUntil === 7 || daysUntil === 3 || daysUntil === 0) {
                notifications.push({
                    type: 'action-item',
                    title: `Tabled Motion Needs Review`,
                    message: `Motion "${log.item.substring(0, 50)}..." scheduled for follow-up ${daysUntil === 0 ? 'today' : 'in ' + daysUntil + ' days'}`,
                    priority: daysUntil === 0 ? 'urgent' : 'high',
                    actionLink: 'gc-log-section'
                });
            }
        }
        if (log.requiresFollowUp && log.followUpDate) {
            const followUp = new Date(log.followUpDate);
            const daysUntil = Math.ceil((followUp - today) / (1000 * 60 * 60 * 24));
            if (daysUntil === 30 || daysUntil === 14 || daysUntil === 7) {
                notifications.push({
                    type: 'action-item',
                    title: `Minority Opinion Follow-Up Due`,
                    message: `Motion "${log.item.substring(0, 50)}..." with significant minority opinion needs review in ${daysUntil} days`,
                    priority: 'high',
                    actionLink: 'gc-log-section'
                });
            }
        }
        if (log.workflowStatus === 'research' && log.researchPeriodEnd) {
            const endDate = new Date(log.researchPeriodEnd);
            const daysUntil = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
            if (daysUntil === 7 || daysUntil === 3 || daysUntil === 1) {
                notifications.push({
                    type: 'action-item',
                    title: `Research Period Ending Soon`,
                    message: `Research for "${log.item.substring(0, 50)}..." ends in ${daysUntil} day${daysUntil !== 1 ? 's' : ''}`,
                    priority: daysUntil === 1 ? 'urgent' : 'high',
                    actionLink: 'gc-log-section'
                });
            }
        }
    });
    notifications.forEach(n => {
        const existing = JSON.parse(localStorage.getItem('notifications') || '[]');
        const isDuplicate = existing.some(e =>
            e.type === n.type &&
            e.title === n.title &&
            new Date(e.createdDate).toDateString() === today.toDateString()
        );
        if (!isDuplicate) {
            createNotification(n);
        }
    });
}
function checkForDuplicateMembers(newMember) {
    const members = storage.getMembers();
    const duplicates = [];
    members.forEach(existing => {
        if (existing.id === newMember.id) return; // Skip self
        let matchScore = 0;
        const reasons = [];
        if (existing.name.toLowerCase() === newMember.name.toLowerCase()) {
            matchScore += 50;
            reasons.push('Exact name match');
        }
        const nameSimilarity = calculateStringSimilarity(
            existing.name.toLowerCase(),
            newMember.name.toLowerCase()
        );
        if (nameSimilarity > 0.8 && matchScore < 50) {
            matchScore += 30;
            reasons.push('Very similar name');
        }
        if (existing.email && newMember.email &&
            existing.email.toLowerCase() === newMember.email.toLowerCase()) {
            matchScore += 40;
            reasons.push('Same email');
        }
        if (existing.phone && newMember.phone) {
            const phone1 = existing.phone.replace(/\D/g, '');
            const phone2 = newMember.phone.replace(/\D/g, '');
            if (phone1 === phone2) {
                matchScore += 40;
                reasons.push('Same phone number');
            }
        }
        if (existing.birthday && newMember.birthday &&
            existing.birthday === newMember.birthday) {
            matchScore += 10;
            reasons.push('Same birthday');
        }
        if (matchScore >= 50) {
            duplicates.push({
                member: existing,
                score: matchScore,
                reasons: reasons
            });
        }
    });
    return duplicates;
}
function calculateStringSimilarity(str1, str2) {
    const longer = str1.length > str2.length ? str1 : str2;
    const shorter = str1.length > str2.length ? str2 : str1;
    if (longer.length === 0) return 1.0;
    const editDistance = (s1, s2) => {
        s1 = s1.toLowerCase();
        s2 = s2.toLowerCase();
        const costs = [];
        for (let i = 0; i <= s1.length; i++) {
            let lastValue = i;
            for (let j = 0; j <= s2.length; j++) {
                if (i === 0) {
                    costs[j] = j;
                } else if (j > 0) {
                    let newValue = costs[j - 1];
                    if (s1.charAt(i - 1) !== s2.charAt(j - 1)) {
                        newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                    }
                    costs[j - 1] = lastValue;
                    lastValue = newValue;
                }
            }
            if (i > 0) costs[s2.length] = lastValue;
        }
        return costs[s2.length];
    };
    return (longer.length - editDistance(longer, shorter)) / longer.length;
}
function exportAuditLogToCSV() {
    const entries = getAuditHistory(null, null, 10000); // Get all entries
    if (entries.length === 0) {
        showToast('No audit entries to export', 'error');
        return;
    }
    let csv = 'Timestamp,User,Action,Entity Type,Entity ID,Changes,Reason\n';
    entries.forEach(entry => {
        const timestamp = new Date(entry.timestamp).toLocaleString();
        const changes = entry.changes ? JSON.stringify(entry.changes).replace(/"/g, '""') : '';
        const reason = entry.reason || '';
        csv += `"${timestamp}","${entry.user}","${entry.action}","${entry.entityType}","${entry.entityId}","${changes}","${reason}"\n`;
    });
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `audit-log-${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    showToast('Audit log exported to CSV', 'success');
}
function exportAuditLogToPDF() {
    const entries = getAuditHistory(null, null, 500); // Last 500 entries
    if (entries.length === 0) {
        showToast('No audit entries to export', 'error');
        return;
    }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('landscape'); // Use landscape for wider table
    let yPos = 20;
    doc.setFontSize(18);
    doc.setTextColor(52, 152, 219);
    doc.text('Audit Log Report', 14, yPos);
    yPos += 10;
    doc.setFontSize(11);
    doc.setTextColor(0, 0, 0);
    doc.text(`Generated: ${new Date().toLocaleString()}`, 14, yPos);
    yPos += 6;
    doc.text(`Total Entries: ${entries.length} (showing first ${Math.min(entries.length, 100)})`, 14, yPos);
    yPos += 10;
    const tableData = entries.slice(0, 100).map(entry => {
        const timestamp = new Date(entry.timestamp).toLocaleString('en-US', {
            month: '2-digit',
            day: '2-digit',
            year: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
        let changes = '';
        if (entry.changes && typeof entry.changes === 'object') {
            const changedFields = Object.keys(entry.changes);
            changes = changedFields.length > 0 ? changedFields.slice(0, 3).join(', ') : 'N/A';
            if (changedFields.length > 3) changes += '...';
        }
        return [
            timestamp,
            entry.user || 'System',
            entry.action.toUpperCase(),
            entry.entityType,
            entry.entityId ? entry.entityId.substring(0, 12) : 'N/A',
            changes || 'N/A',
            entry.reason ? entry.reason.substring(0, 30) : ''
        ];
    });
    doc.autoTable({
        startY: yPos,
        head: [['Date/Time', 'User', 'Action', 'Type', 'Entity ID', 'Changed Fields', 'Reason']],
        body: tableData,
        theme: 'grid',
        headStyles: {
            fillColor: [52, 152, 219],
            textColor: 255,
            fontSize: 9,
            fontStyle: 'bold'
        },
        styles: {
            fontSize: 8,
            cellPadding: 2
        },
        columnStyles: {
            0: { cellWidth: 35 }, // Date/Time
            1: { cellWidth: 30 }, // User
            2: { cellWidth: 25 }, // Action
            3: { cellWidth: 35 }, // Type
            4: { cellWidth: 30 }, // Entity ID
            5: { cellWidth: 50 }, // Changed Fields
            6: { cellWidth: 50 }  // Reason
        },
        didDrawCell: (data) => {
            if (data.column.index === 2 && data.cell.section === 'body') {
                const action = data.cell.raw;
                if (action === 'DELETE') {
                    doc.setTextColor(231, 76, 60); // Red
                } else if (action === 'CREATE') {
                    doc.setTextColor(46, 204, 113); // Green
                } else if (action === 'EDIT') {
                    doc.setTextColor(52, 152, 219); // Blue
                }
            }
        }
    });
    if (entries.length > 100) {
        const finalY = doc.lastAutoTable.finalY + 10;
        doc.setFontSize(10);
        doc.setTextColor(150, 150, 150);
        doc.text(`Note: Showing first 100 of ${entries.length} total entries. Use filters in the app to view specific entries.`, 14, finalY);
    }
    const pageCount = doc.internal.getNumberOfPages();
    doc.setFontSize(9);
    doc.setTextColor(100, 100, 100);
    for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.text(`Audit Log - ${new Date().toLocaleDateString()}`, 14, doc.internal.pageSize.height - 10);
        doc.text(`Page ${i} of ${pageCount}`, doc.internal.pageSize.width - 30, doc.internal.pageSize.height - 10);
    }
    doc.save(`audit-log-${new Date().toISOString().split('T')[0]}.pdf`);
    showToast('Audit log exported to PDF successfully!', 'success');
}
function openMeetingFeedbackSurvey() {
    const modal = document.createElement('div');
    modal.id = 'feedback-survey-modal';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10001; display: flex; align-items: center; justify-content: center; padding: 1rem; overflow-y: auto;';
    const content = document.createElement('div');
    content.style.cssText = 'background: #34495e; padding: 2rem; border-radius: 8px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto;';
    content.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="color: #3498db; margin: 0;">Meeting Feedback Survey</h2>
            <button onclick="closeFeedbackSurvey()" style="background: #e74c3c; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Close</button>
        </div>
        <p style="color: #ecf0f1; margin-bottom: 1.5rem;">
            Your feedback helps us improve our meetings. Please rate the following aspects (1-5 scale):
        </p>
        <div class="form-group">
            <label>1. How welcoming was today's meeting atmosphere?</label>
            <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                ${[1,2,3,4,5].map(n => `
                    <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                        <input type="radio" name="q1" value="${n}" required />
                        <span style="color: #ecf0f1;">${n}</span>
                    </label>
                `).join('')}
            </div>
            <small style="color: #95a5a6;">1 = Not welcoming, 5 = Very welcoming</small>
        </div>
        <div class="form-group">
            <label>2. How valuable was the meeting content?</label>
            <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                ${[1,2,3,4,5].map(n => `
                    <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                        <input type="radio" name="q2" value="${n}" required />
                        <span style="color: #ecf0f1;">${n}</span>
                    </label>
                `).join('')}
            </div>
            <small style="color: #95a5a6;">1 = Not valuable, 5 = Very valuable</small>
        </div>
        <div class="form-group">
            <label>3. How inclusive was the meeting (everyone had opportunity to share)?</label>
            <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                ${[1,2,3,4,5].map(n => `
                    <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                        <input type="radio" name="q3" value="${n}" required />
                        <span style="color: #ecf0f1;">${n}</span>
                    </label>
                `).join('')}
            </div>
            <small style="color: #95a5a6;">1 = Not inclusive, 5 = Very inclusive</small>
        </div>
        <div class="form-group">
            <label>4. How would you rate the meeting format?</label>
            <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                ${[1,2,3,4,5].map(n => `
                    <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                        <input type="radio" name="q4" value="${n}" required />
                        <span style="color: #ecf0f1;">${n}</span>
                    </label>
                `).join('')}
            </div>
            <small style="color: #95a5a6;">1 = Needs improvement, 5 = Excellent</small>
        </div>
        <div class="form-group">
            <label>5. How likely are you to return or recommend this meeting?</label>
            <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                ${[1,2,3,4,5].map(n => `
                    <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                        <input type="radio" name="q5" value="${n}" required />
                        <span style="color: #ecf0f1;">${n}</span>
                    </label>
                `).join('')}
            </div>
            <small style="color: #95a5a6;">1 = Not likely, 5 = Very likely</small>
        </div>
        <div class="form-group">
            <label>Additional Comments (Optional)</label>
            <textarea id="feedback-comments" rows="4" placeholder="Any suggestions or comments?" style="width: 100%; padding: 0.5rem; background: #2c3e50; color: #ecf0f1; border: 1px solid #7f8c8d; border-radius: 4px;"></textarea>
        </div>
        <div style="margin-top: 1.5rem; text-align: center;">
            <button onclick="submitMeetingFeedback()" style="background: #2ecc71; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer; margin-right: 0.5rem;">
                Submit Feedback
            </button>
            <button onclick="closeFeedbackSurvey()" style="background: #95a5a6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer;">
                Cancel
            </button>
        </div>
    `;
    modal.appendChild(content);
    document.body.appendChild(modal);
}
function submitMeetingFeedback() {
    const q1 = document.querySelector('input[name="q1"]:checked')?.value;
    const q2 = document.querySelector('input[name="q2"]:checked')?.value;
    const q3 = document.querySelector('input[name="q3"]:checked')?.value;
    const q4 = document.querySelector('input[name="q4"]:checked')?.value;
    const q5 = document.querySelector('input[name="q5"]:checked')?.value;
    if (!q1 || !q2 || !q3 || !q4 || !q5) {
        showToast('Please answer all questions', 'error');
        return;
    }
    const comments = document.getElementById('feedback-comments')?.value || '';
    const feedback = {
        id: genId(),
        date: new Date().toISOString(),
        scores: {
            welcoming: parseInt(q1),
            valuable: parseInt(q2),
            inclusive: parseInt(q3),
            format: parseInt(q4),
            recommend: parseInt(q5)
        },
        average: ((parseInt(q1) + parseInt(q2) + parseInt(q3) + parseInt(q4) + parseInt(q5)) / 5).toFixed(1),
        comments: comments,
        submittedBy: getCurrentUserName()
    };
    const allFeedback = JSON.parse(localStorage.getItem('meetingFeedback') || '[]');
    allFeedback.push(feedback);
    localStorage.setItem('meetingFeedback', JSON.stringify(allFeedback));
    logAuditEntry('create', 'meeting-feedback', feedback.id, feedback);
    showToast('Thank you for your feedback!', 'success');
    closeFeedbackSurvey();
}
function closeFeedbackSurvey() {
    const modal = document.getElementById('feedback-survey-modal');
    if (modal) modal.remove();
}
function viewMeetingFeedbackResults() {
    const allFeedback = JSON.parse(localStorage.getItem('meetingFeedback') || '[]');
    if (allFeedback.length === 0) {
        showToast('No feedback submissions yet', 'info');
        return;
    }
    const totals = {
        welcoming: 0,
        valuable: 0,
        inclusive: 0,
        format: 0,
        recommend: 0
    };
    allFeedback.forEach(f => {
        totals.welcoming += f.scores.welcoming;
        totals.valuable += f.scores.valuable;
        totals.inclusive += f.scores.inclusive;
        totals.format += f.scores.format;
        totals.recommend += f.scores.recommend;
    });
    const count = allFeedback.length;
    const averages = {
        welcoming: (totals.welcoming / count).toFixed(2),
        valuable: (totals.valuable / count).toFixed(2),
        inclusive: (totals.inclusive / count).toFixed(2),
        format: (totals.format / count).toFixed(2),
        recommend: (totals.recommend / count).toFixed(2),
        overall: ((totals.welcoming + totals.valuable + totals.inclusive + totals.format + totals.recommend) / (count * 5)).toFixed(2)
    };
    const modal = document.createElement('div');
    modal.id = 'feedback-results-modal';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10001; display: flex; align-items: center; justify-content: center; padding: 1rem; overflow-y: auto;';
    const content = document.createElement('div');
    content.style.cssText = 'background: #34495e; padding: 2rem; border-radius: 8px; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto;';
    content.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="color: #3498db; margin: 0;">Meeting Feedback Results</h2>
            <button onclick="closeFeedbackResults()" style="background: #e74c3c; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Close</button>
        </div>
        <div style="background: #2c3e50; padding: 1.5rem; border-radius: 6px; margin-bottom: 1rem;">
            <h3 style="color: #3498db; margin: 0 0 1rem 0;">Overall Score</h3>
            <div style="font-size: 2rem; font-weight: bold; color: #2ecc71; text-align: center;">
                ${averages.overall} / 5.0
            </div>
            <div style="text-align: center; color: #95a5a6; margin-top: 0.5rem;">
                Based on ${count} response${count !== 1 ? 's' : ''}
            </div>
        </div>
        <div style="background: #2c3e50; padding: 1.5rem; border-radius: 6px; margin-bottom: 1rem;">
            <h3 style="color: #3498db; margin: 0 0 1rem 0;">Category Scores</h3>
            <div style="margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                    <span style="color: #ecf0f1;">Welcoming Atmosphere</span>
                    <span style="color: #3498db; font-weight: bold;">${averages.welcoming}</span>
                </div>
                <div style="background: #34495e; height: 8px; border-radius: 4px; overflow: hidden;">
                    <div style="background: #2ecc71; height: 100%; width: ${averages.welcoming * 20}%;"></div>
                </div>
            </div>
            <div style="margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                    <span style="color: #ecf0f1;">Content Value</span>
                    <span style="color: #3498db; font-weight: bold;">${averages.valuable}</span>
                </div>
                <div style="background: #34495e; height: 8px; border-radius: 4px; overflow: hidden;">
                    <div style="background: #2ecc71; height: 100%; width: ${averages.valuable * 20}%;"></div>
                </div>
            </div>
            <div style="margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                    <span style="color: #ecf0f1;">Inclusivity</span>
                    <span style="color: #3498db; font-weight: bold;">${averages.inclusive}</span>
                </div>
                <div style="background: #34495e; height: 8px; border-radius: 4px; overflow: hidden;">
                    <div style="background: #2ecc71; height: 100%; width: ${averages.inclusive * 20}%;"></div>
                </div>
            </div>
            <div style="margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                    <span style="color: #ecf0f1;">Meeting Format</span>
                    <span style="color: #3498db; font-weight: bold;">${averages.format}</span>
                </div>
                <div style="background: #34495e; height: 8px; border-radius: 4px; overflow: hidden;">
                    <div style="background: #2ecc71; height: 100%; width: ${averages.format * 20}%;"></div>
                </div>
            </div>
            <div style="margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                    <span style="color: #ecf0f1;">Likelihood to Recommend</span>
                    <span style="color: #3498db; font-weight: bold;">${averages.recommend}</span>
                </div>
                <div style="background: #34495e; height: 8px; border-radius: 4px; overflow: hidden;">
                    <div style="background: #2ecc71; height: 100%; width: ${averages.recommend * 20}%;"></div>
                </div>
            </div>
        </div>
        <div style="background: #2c3e50; padding: 1.5rem; border-radius: 6px;">
            <h3 style="color: #3498db; margin: 0 0 1rem 0;">Recent Comments</h3>
            ${allFeedback.filter(f => f.comments).slice(-5).reverse().map(f => `
                <div style="background: #34495e; padding: 1rem; border-radius: 4px; margin-bottom: 0.75rem;">
                    <p style="color: #ecf0f1; margin: 0 0 0.5rem 0;">${escapeHtml(f.comments)}</p>
                    <small style="color: #95a5a6;">${new Date(f.date).toLocaleDateString()} - Score: ${f.average}/5.0</small>
                </div>
            `).join('') || '<p style="color: #95a5a6; text-align: center;">No comments yet</p>'}
        </div>
        <div style="margin-top: 1.5rem; text-align: center;">
            <button onclick="exportFeedbackReport()" style="background: #3498db; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer; margin-right: 0.5rem;">
                <i class="fas fa-download"></i> Export Report
            </button>
        </div>
    `;
    modal.appendChild(content);
    document.body.appendChild(modal);
}
function closeFeedbackResults() {
    const modal = document.getElementById('feedback-results-modal');
    if (modal) modal.remove();
}
function exportFeedbackReport() {
    const allFeedback = JSON.parse(localStorage.getItem('meetingFeedback') || '[]');
    let csv = 'Date,Welcoming,Valuable,Inclusive,Format,Recommend,Average,Comments,Submitted By\n';
    allFeedback.forEach(f => {
        const date = new Date(f.date).toLocaleDateString();
        const comments = (f.comments || '').replace(/"/g, '""');
        csv += `"${date}",${f.scores.welcoming},${f.scores.valuable},${f.scores.inclusive},${f.scores.format},${f.scores.recommend},${f.average},"${comments}","${f.submittedBy}"\n`;
    });
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `meeting-feedback-${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    showToast('Feedback report exported', 'success');
}
function getGroupHealthMetrics() {
    const members = storage.getMembers();
    const positions = storage.getServicePositions();
    const gcLogs = storage.getGroupConscienceLog();
    const chairpersonLogs = storage.getChairpersonLog();
    const today = new Date();
    const thirtyDaysAgo = new Date(today - 30 * 24 * 60 * 60 * 1000);
    const activeMembers = members.filter(m => m.status === 'Active').length;
    const filledPositions = positions.filter(p => p.currentHolder).length;
    const totalPositions = positions.length;
    const positionsFillRate = totalPositions > 0 ? (filledPositions / totalPositions * 100).toFixed(0) : 0;
    const recentGC = gcLogs.filter(log => new Date(log.date) >= thirtyDaysAgo);
    const passedMotions = recentGC.filter(log => log.status === 'passed').length;
    const totalMotions = recentGC.length;
    const recentLogs = chairpersonLogs
        .filter(log => new Date(log.date) >= new Date(today - 56 * 24 * 60 * 60 * 1000))
        .sort((a, b) => new Date(a.date) - new Date(b.date));
    const avgAttendance = recentLogs.length > 0
        ? (recentLogs.reduce((sum, log) => sum + (log.headCount || 0), 0) / recentLogs.length).toFixed(1)
        : 0;
    const balance = parseFloat(localStorage.getItem('treasurerBalance')) || 0;
    const monthlyExpenses = parseFloat(localStorage.getItem('monthlyExpenses')) || 0;
    const monthsOfReserve = monthlyExpenses > 0 ? (balance / monthlyExpenses).toFixed(1) : 0;
    let healthScore = 0;
    healthScore += positionsFillRate * 0.25; // 25% weight
    healthScore += Math.min((avgAttendance / 20) * 100, 100) * 0.25; // 25% weight (assuming target of 20)
    healthScore += (totalMotions > 0 ? (passedMotions / totalMotions * 100) : 50) * 0.25; // 25% weight
    healthScore += Math.min((monthsOfReserve / 3) * 100, 100) * 0.25; // 25% weight
    return {
        activeMembers,
        positionsFillRate,
        filledPositions,
        totalPositions,
        avgAttendance,
        recentGCActivity: totalMotions,
        gcPassRate: totalMotions > 0 ? ((passedMotions / totalMotions) * 100).toFixed(0) : 0,
        monthsOfReserve,
        healthScore: Math.round(healthScore),
        healthStatus: healthScore >= 80 ? 'Excellent' : healthScore >= 60 ? 'Good' : healthScore >= 40 ? 'Fair' : 'Needs Attention',
        healthColor: healthScore >= 80 ? '#2ecc71' : healthScore >= 60 ? '#f1c40f' : healthScore >= 40 ? '#f39c12' : '#e74c3c'
    };
}
function getAllApplicationData() {
    return {
        events: storage.getEvents(),
        members: storage.getMembers(),
        announcements: storage.getAnnouncements(),
        photos: storage.getPhotos(),

        chairpersonLog: storage.getChairpersonLog(),
        meetingMinutes: storage.getMeetingMinutes(),
        meetingFeedback: JSON.parse(localStorage.getItem('meetingFeedback') || '[]'),
        roleRotation: JSON.parse(localStorage.getItem('roleRotation') || '[]'),
        virtualMeetings: JSON.parse(localStorage.getItem('virtualMeetings') || '[]'),
        qrCheckInSettings: JSON.parse(localStorage.getItem('qrCheckInSettings') || '{}'),
        meetingAnalytics: JSON.parse(localStorage.getItem('meetingAnalytics') || '[]'),

        groupConscienceLog: storage.getGroupConscienceLog(),
        liveGCItems: storage.getLiveGCItems(),
        proposedAgendaItems: storage.getProposedAgendaItems(),
        gcComments: storage.getGCComments(),
        gcActionItems: storage.getGCActionItems(),
        gcSettings: storage.getGCSettings(),
        motionTemplates: storage.getMotionTemplates(),
        traditionChecks: storage.getTraditionChecks(),
        unityChecks: storage.getUnityChecks(),
        minorityOpinions: storage.getMinorityOpinions(),
        conflicts: JSON.parse(localStorage.getItem('conflicts') || '[]'),
        inventoryQuestions: JSON.parse(localStorage.getItem('inventoryQuestions') || '[]'),

        messages: storage.getMessages(),
        commLists: JSON.parse(localStorage.getItem('commLists') || '[]'),
        reminderSettings: JSON.parse(localStorage.getItem('reminderSettings') || '{}'),
        notifications: JSON.parse(localStorage.getItem('notifications') || '[]'),
        actionItems: JSON.parse(localStorage.getItem('actionItems') || '[]'),
        cancellationAlerts: JSON.parse(localStorage.getItem('cancellationAlerts') || '[]'),
        welcomePacketSettings: JSON.parse(localStorage.getItem('welcomePacketSettings') || '{}'),

        servicePositions: storage.getServicePositions(),
        serviceElections: storage.getServiceElections(),
        electionBallots: storage.getElectionBallots(),
        nominations: storage.getNominations(),
        groupPositions: storage.getGroupPositions(),
        speakingQueue: storage.getSpeakingQueue(),
        hiCommitments: JSON.parse(localStorage.getItem('hiCommitments') || '[]'),
        serviceHours: JSON.parse(localStorage.getItem('serviceHours') || '[]'),

        budgetCategories: storage.getBudgetCategories(),
        expenses: storage.getExpenses(),
        budgetProposals: storage.getBudgetProposals(),
        expenseApprovals: JSON.parse(localStorage.getItem('expenseApprovals') || '[]'),
        billReminders: JSON.parse(localStorage.getItem('billReminders') || '[]'),
        financialGoals: JSON.parse(localStorage.getItem('financialGoals') || '[]'),
        expenseReceipts: JSON.parse(localStorage.getItem('expenseReceipts') || '[]'),
        treasurerBalance: localStorage.getItem('treasurerBalance'),
        reserveTarget: localStorage.getItem('reserveTarget'),
        monthlyExpenses: localStorage.getItem('monthlyExpenses'),
        reserveMonths: localStorage.getItem('reserveMonths'),

        sponsorships: JSON.parse(localStorage.getItem('sponsorships') || '[]'),
        sponsorshipTree: JSON.parse(localStorage.getItem('sponsorshipTree') || '[]'),

        literatureInventory: storage.getLiteratureInventory(),
        literatureLoans: storage.getLiteratureLoans(),
        bigBookStudy: JSON.parse(localStorage.getItem('bigBookStudy') || '[]'),
        newcomerPacks: JSON.parse(localStorage.getItem('newcomerPacks') || '[]'),
        literatureSales: JSON.parse(localStorage.getItem('literatureSales') || '[]'),
        digitalLibrary: JSON.parse(localStorage.getItem('digitalLibrary') || '[]'),

        interGroupAttendance: JSON.parse(localStorage.getItem('interGroupAttendance') || '[]'),
        homeGroupTransfers: JSON.parse(localStorage.getItem('homeGroupTransfers') || '[]'),
        homeGroupBenefits: JSON.parse(localStorage.getItem('homeGroupBenefits') || '[]'),
        commitmentLevels: JSON.parse(localStorage.getItem('commitmentLevels') || '[]'),
        censusStat: JSON.parse(localStorage.getItem('censusStats') || '[]'),
        growthMetrics: JSON.parse(localStorage.getItem('growthMetrics') || '[]'),

        multiGroups: JSON.parse(localStorage.getItem('multiGroups') || '[]'),
        calendarIntegration: JSON.parse(localStorage.getItem('calendarIntegration') || '{}'),
        smsSettings: JSON.parse(localStorage.getItem('smsSettings') || '{}'),
        emailAutomation: JSON.parse(localStorage.getItem('emailAutomation') || '{}'),
        cloudBackupSettings: JSON.parse(localStorage.getItem('cloudBackupSettings') || '{}'),

        accessibilityConcerns: JSON.parse(localStorage.getItem('accessibilityConcerns') || '[]'),
        languageSettings: JSON.parse(localStorage.getItem('languageSettings') || '{"language": "en"}'),
        largePrintEnabled: localStorage.getItem('largePrintEnabled') === 'true',

        digitalArchive: JSON.parse(localStorage.getItem('digitalArchive') || '[]'),
        oralHistories: JSON.parse(localStorage.getItem('oralHistories') || '[]'),
        milestones: JSON.parse(localStorage.getItem('milestones') || '[]'),
        legacies: JSON.parse(localStorage.getItem('legacies') || '[]'),
        historicalMinutes: JSON.parse(localStorage.getItem('historicalMinutes') || '[]'),

        districtMotions: storage.getDistrictMotions(),

        templates: storage.getTemplates(),
        votingSettings: storage.getVotingSettings(),
        quorumRules: storage.getQuorumRules(),
        inventorySchedules: storage.getInventorySchedules(),
        decisionImpacts: storage.getDecisionImpacts(),
        participationData: storage.getParticipationData(),
        userRole: storage.getUserRole(),
        educationalProgress: storage.getEducationalProgress(),
        privacySettings: storage.getPrivacySettings(),
        accessLevels: storage.getAccessLevels(),
        traditionOfDay: storage.getTraditionOfDay(),
        spiritualPrinciples: storage.getSpiritualPrinciples(),
        serviceStructure: storage.getServiceStructure(),
        groupInventories: JSON.parse(localStorage.getItem('groupInventories') || '[]'),
        backupSettings: JSON.parse(localStorage.getItem('backupSettings') || '{"enabled": true, "frequency": "daily"}'),
        currentUser: localStorage.getItem('currentUser'),

        auditLog: JSON.parse(localStorage.getItem('auditLog') || '[]'),

        exportDate: new Date().toISOString(),
        version: '7.0',
        backupType: 'full',
        featureCount: 90
    };
}
function exportFullBackupJSON() {
    try {
        const data = getAllApplicationData();
        const dateStr = new Date().toISOString().split('T')[0];
        const timeStr = new Date().toISOString().split('T')[1].split('.')[0].replace(/:/g, '-');
        const filename = `aa-group-backup-${dateStr}_${timeStr}.json`;
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast('✅ JSON backup exported successfully!', 'success');
        logAuditEntry('export', 'full-backup-json', 'system', { filename, size: blob.size }, 'Full JSON backup exported');
    } catch (error) {
        showToast('❌ Error exporting JSON backup: ' + error.message, 'error');
        console.error('JSON export error:', error);
    }
}
function importFullBackupJSON() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        if (!confirm('⚠️ IMPORTANT WARNING ⚠️\n\nThis will COMPLETELY REPLACE all current data with the backup data.\n\n✓ Current data will be lost\n✓ This action cannot be undone\n✓ It is recommended to export current data first\n\nDo you want to continue?')) {
            return;
        }
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const data = JSON.parse(event.target.result);
                if (!data.version || !data.exportDate) {
                    if (!confirm('⚠️ This file may be from an older version or corrupted.\n\nAttempt to import anyway?')) {
                        return;
                    }
                }
                restoreAllApplicationData(data);
                showToast('✅ JSON backup restored successfully! Refreshing page...', 'success');
                logAuditEntry('import', 'full-backup-json', 'system', { filename: file.name, size: file.size }, 'Full JSON backup restored');
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } catch (error) {
                showToast('❌ Error importing JSON backup: ' + error.message, 'error');
                console.error('JSON import error:', error);
            }
        };
        reader.readAsText(file);
    };
    input.click();
}
function arrayToCSV(data, fields) {
    if (!data || data.length === 0) return '';
    let csv = fields.join('|') + '\n';
    data.forEach(item => {
        const row = fields.map(field => {
            let value = item[field];
            if (typeof value === 'object' && value !== null) {
                value = JSON.stringify(value).replace(/\|/g, '¦'); // Replace pipes to avoid breaking delimiter
            }
            if (value === null || value === undefined) {
                value = '';
            }
            value = String(value).replace(/\n/g, ' ').replace(/\r/g, '');
            return value;
        });
        csv += row.join('|') + '\n';
    });
    return csv;
}
function exportFullBackupCSV() {
    try {
        const data = getAllApplicationData();
        const dateStr = new Date().toISOString().split('T')[0];
        const timeStr = new Date().toISOString().split('T')[1].split('.')[0].replace(/:/g, '-');
        const csvFiles = [];
        if (data.members && data.members.length > 0) {
            const csv = arrayToCSV(data.members, ['id', 'name', 'birthday', 'phone', 'email', 'homegroup', 'sponsor', 'city', 'isServant', 'servantPosition', 'servantSince']);
            csvFiles.push({ name: 'members.csv', content: csv });
        }
        if (data.events && data.events.length > 0) {
            const csv = arrayToCSV(data.events, ['id', 'title', 'date', 'time', 'location', 'description', 'type']);
            csvFiles.push({ name: 'events.csv', content: csv });
        }
        if (data.groupConscienceLog && data.groupConscienceLog.length > 0) {
            const csv = arrayToCSV(data.groupConscienceLog, ['id', 'date', 'item', 'submittedBy', 'status', 'votesFor', 'votesAgainst', 'votesAbstain', 'workflowStatus', 'researchPeriodStart', 'researchPeriodEnd', 'minorityPercentage', 'requiresFollowUp']);
            csvFiles.push({ name: 'group_conscience_log.csv', content: csv });
        }
        if (data.chairpersonLog && data.chairpersonLog.length > 0) {
            const csv = arrayToCSV(data.chairpersonLog, ['id', 'date', 'time', 'chairperson', 'headCount', 'tradition', 'orangeCan']);
            csvFiles.push({ name: 'chairperson_log.csv', content: csv });
        }
        if (data.servicePositions && data.servicePositions.length > 0) {
            const csv = arrayToCSV(data.servicePositions, ['id', 'name', 'description', 'termLength', 'currentHolder', 'startDate']);
            csvFiles.push({ name: 'service_positions.csv', content: csv });
        }
        if (data.budgetCategories && data.budgetCategories.length > 0) {
            const csv = arrayToCSV(data.budgetCategories, ['id', 'category', 'monthlyBudget']);
            csvFiles.push({ name: 'budget_categories.csv', content: csv });
        }
        if (data.expenses && data.expenses.length > 0) {
            const csv = arrayToCSV(data.expenses, ['id', 'date', 'category', 'description', 'amount']);
            csvFiles.push({ name: 'expenses.csv', content: csv });
        }
        if (data.announcements && data.announcements.length > 0) {
            const csv = arrayToCSV(data.announcements, ['id', 'date', 'text']);
            csvFiles.push({ name: 'announcements.csv', content: csv });
        }
        if (data.meetingMinutes && data.meetingMinutes.length > 0) {
            const csv = arrayToCSV(data.meetingMinutes, ['id', 'date', 'title', 'attendees', 'facilitator', 'notes']);
            csvFiles.push({ name: 'meeting_minutes.csv', content: csv });
        }
        if (data.literatureInventory && data.literatureInventory.length > 0) {
            const csv = arrayToCSV(data.literatureInventory, ['id', 'title', 'type', 'quantity', 'price', 'lowStockThreshold']);
            csvFiles.push({ name: 'literature_inventory.csv', content: csv });
        }
        if (data.auditLog && data.auditLog.length > 0) {
            const recentAudit = data.auditLog.slice(-1000);
            const csv = arrayToCSV(recentAudit, ['timestamp', 'user', 'action', 'entityType', 'entityId']);
            csvFiles.push({ name: 'audit_log.csv', content: csv });
        }
        if (data.meetingFeedback && data.meetingFeedback.length > 0) {
            const csv = arrayToCSV(data.meetingFeedback, ['id', 'date', 'average', 'comments', 'submittedBy']);
            csvFiles.push({ name: 'meeting_feedback.csv', content: csv });
        }

        if (data.roleRotation && data.roleRotation.length > 0) {
            const csv = arrayToCSV(data.roleRotation, ['id', 'role', 'member', 'startDate', 'endDate', 'status']);
            csvFiles.push({ name: 'role_rotation.csv', content: csv });
        }
        if (data.virtualMeetings && data.virtualMeetings.length > 0) {
            const csv = arrayToCSV(data.virtualMeetings, ['id', 'date', 'platform', 'meetingLink', 'attendees', 'duration']);
            csvFiles.push({ name: 'virtual_meetings.csv', content: csv });
        }
        if (data.meetingAnalytics && data.meetingAnalytics.length > 0) {
            const csv = arrayToCSV(data.meetingAnalytics, ['date', 'attendance', 'newcomers', 'celebrations', 'avgRating']);
            csvFiles.push({ name: 'meeting_analytics.csv', content: csv });
        }

        if (data.commLists && data.commLists.length > 0) {
            const csv = arrayToCSV(data.commLists, ['id', 'name', 'description', 'members', 'createdDate']);
            csvFiles.push({ name: 'communication_lists.csv', content: csv });
        }
        if (data.actionItems && data.actionItems.length > 0) {
            const csv = arrayToCSV(data.actionItems, ['id', 'item', 'assignedTo', 'dueDate', 'status', 'priority']);
            csvFiles.push({ name: 'action_items.csv', content: csv });
        }
        if (data.cancellationAlerts && data.cancellationAlerts.length > 0) {
            const csv = arrayToCSV(data.cancellationAlerts, ['id', 'date', 'reason', 'notifiedMembers', 'sentDate']);
            csvFiles.push({ name: 'cancellation_alerts.csv', content: csv });
        }

        if (data.expenseApprovals && data.expenseApprovals.length > 0) {
            const csv = arrayToCSV(data.expenseApprovals, ['id', 'expenseId', 'requestedBy', 'amount', 'status', 'approvedBy', 'approvalDate']);
            csvFiles.push({ name: 'expense_approvals.csv', content: csv });
        }
        if (data.billReminders && data.billReminders.length > 0) {
            const csv = arrayToCSV(data.billReminders, ['id', 'billName', 'amount', 'dueDate', 'frequency', 'status']);
            csvFiles.push({ name: 'bill_reminders.csv', content: csv });
        }
        if (data.financialGoals && data.financialGoals.length > 0) {
            const csv = arrayToCSV(data.financialGoals, ['id', 'goalName', 'targetAmount', 'currentAmount', 'deadline', 'status']);
            csvFiles.push({ name: 'financial_goals.csv', content: csv });
        }
        if (data.expenseReceipts && data.expenseReceipts.length > 0) {
            const csv = arrayToCSV(data.expenseReceipts, ['id', 'expenseId', 'receiptUrl', 'uploadDate', 'uploadedBy']);
            csvFiles.push({ name: 'expense_receipts.csv', content: csv });
        }

        if (data.hiCommitments && data.hiCommitments.length > 0) {
            const csv = arrayToCSV(data.hiCommitments, ['id', 'memberId', 'memberName', 'commitmentDate', 'type', 'notes']);
            csvFiles.push({ name: 'hi_commitments.csv', content: csv });
        }
        if (data.serviceHours && data.serviceHours.length > 0) {
            const csv = arrayToCSV(data.serviceHours, ['id', 'memberId', 'memberName', 'date', 'hours', 'activity']);
            csvFiles.push({ name: 'service_hours.csv', content: csv });
        }
        if (data.sponsorships && data.sponsorships.length > 0) {
            const csv = arrayToCSV(data.sponsorships, ['id', 'sponsorId', 'sponsorName', 'sponseeId', 'sponseeName', 'startDate', 'status']);
            csvFiles.push({ name: 'sponsorships.csv', content: csv });
        }
        if (data.sponsorshipTree && data.sponsorshipTree.length > 0) {
            const csv = arrayToCSV(data.sponsorshipTree, ['memberId', 'memberName', 'sponsorId', 'depth', 'lineage']);
            csvFiles.push({ name: 'sponsorship_tree.csv', content: csv });
        }

        if (data.bigBookStudy && data.bigBookStudy.length > 0) {
            const csv = arrayToCSV(data.bigBookStudy, ['id', 'date', 'chapter', 'facilitator', 'attendees', 'notes']);
            csvFiles.push({ name: 'big_book_study.csv', content: csv });
        }
        if (data.newcomerPacks && data.newcomerPacks.length > 0) {
            const csv = arrayToCSV(data.newcomerPacks, ['id', 'date', 'recipientName', 'contents', 'distributedBy']);
            csvFiles.push({ name: 'newcomer_packs.csv', content: csv });
        }
        if (data.literatureSales && data.literatureSales.length > 0) {
            const csv = arrayToCSV(data.literatureSales, ['id', 'date', 'itemId', 'itemTitle', 'quantity', 'totalPrice', 'soldBy']);
            csvFiles.push({ name: 'literature_sales.csv', content: csv });
        }
        if (data.digitalLibrary && data.digitalLibrary.length > 0) {
            const csv = arrayToCSV(data.digitalLibrary, ['id', 'title', 'type', 'url', 'uploadDate', 'uploadedBy']);
            csvFiles.push({ name: 'digital_library.csv', content: csv });
        }

        if (data.interGroupAttendance && data.interGroupAttendance.length > 0) {
            const csv = arrayToCSV(data.interGroupAttendance, ['id', 'memberId', 'memberName', 'otherGroup', 'date', 'frequency']);
            csvFiles.push({ name: 'inter_group_attendance.csv', content: csv });
        }
        if (data.homeGroupTransfers && data.homeGroupTransfers.length > 0) {
            const csv = arrayToCSV(data.homeGroupTransfers, ['id', 'memberId', 'memberName', 'fromGroup', 'toGroup', 'transferDate', 'reason']);
            csvFiles.push({ name: 'home_group_transfers.csv', content: csv });
        }
        if (data.homeGroupBenefits && data.homeGroupBenefits.length > 0) {
            const csv = arrayToCSV(data.homeGroupBenefits, ['id', 'memberId', 'memberName', 'benefit', 'experienceDate', 'notes']);
            csvFiles.push({ name: 'home_group_benefits.csv', content: csv });
        }
        if (data.commitmentLevels && data.commitmentLevels.length > 0) {
            const csv = arrayToCSV(data.commitmentLevels, ['id', 'memberId', 'memberName', 'level', 'votingEligible', 'lastUpdated']);
            csvFiles.push({ name: 'commitment_levels.csv', content: csv });
        }
        if (data.censusStats && data.censusStats.length > 0) {
            const csv = arrayToCSV(data.censusStats, ['id', 'date', 'totalMembers', 'activeMembers', 'newcomers', 'avgSobriety']);
            csvFiles.push({ name: 'census_stats.csv', content: csv });
        }
        if (data.growthMetrics && data.growthMetrics.length > 0) {
            const csv = arrayToCSV(data.growthMetrics, ['id', 'month', 'memberGrowth', 'retentionRate', 'newcomerRate', 'engagementScore']);
            csvFiles.push({ name: 'growth_metrics.csv', content: csv });
        }

        if (data.multiGroups && data.multiGroups.length > 0) {
            const csv = arrayToCSV(data.multiGroups, ['id', 'groupName', 'meetingDay', 'meetingTime', 'location', 'isActive']);
            csvFiles.push({ name: 'multi_groups.csv', content: csv });
        }

        if (data.accessibilityConcerns && data.accessibilityConcerns.length > 0) {
            const csv = arrayToCSV(data.accessibilityConcerns, ['id', 'memberId', 'memberName', 'concern', 'accommodation', 'dateReported']);
            csvFiles.push({ name: 'accessibility_concerns.csv', content: csv });
        }

        if (data.digitalArchive && data.digitalArchive.length > 0) {
            const csv = arrayToCSV(data.digitalArchive, ['id', 'title', 'date', 'type', 'description', 'fileUrl', 'uploadedBy']);
            csvFiles.push({ name: 'digital_archive.csv', content: csv });
        }
        if (data.oralHistories && data.oralHistories.length > 0) {
            const csv = arrayToCSV(data.oralHistories, ['id', 'memberId', 'memberName', 'interviewDate', 'interviewer', 'duration', 'recordingUrl']);
            csvFiles.push({ name: 'oral_histories.csv', content: csv });
        }
        if (data.milestones && data.milestones.length > 0) {
            const csv = arrayToCSV(data.milestones, ['id', 'date', 'milestone', 'description', 'category', 'recordedBy']);
            csvFiles.push({ name: 'milestones.csv', content: csv });
        }
        if (data.legacies && data.legacies.length > 0) {
            const csv = arrayToCSV(data.legacies, ['id', 'memberId', 'memberName', 'legacy', 'dateRecorded', 'category']);
            csvFiles.push({ name: 'legacies.csv', content: csv });
        }
        if (data.historicalMinutes && data.historicalMinutes.length > 0) {
            const csv = arrayToCSV(data.historicalMinutes, ['id', 'date', 'title', 'description', 'scannedDocUrl', 'uploadedBy']);
            csvFiles.push({ name: 'historical_minutes.csv', content: csv });
        }

        const settingsData = [];
        if (data.qrCheckInSettings && Object.keys(data.qrCheckInSettings).length > 0) {
            settingsData.push({ setting: 'qrCheckInSettings', value: JSON.stringify(data.qrCheckInSettings) });
        }
        if (data.reminderSettings && Object.keys(data.reminderSettings).length > 0) {
            settingsData.push({ setting: 'reminderSettings', value: JSON.stringify(data.reminderSettings) });
        }
        if (data.welcomePacketSettings && Object.keys(data.welcomePacketSettings).length > 0) {
            settingsData.push({ setting: 'welcomePacketSettings', value: JSON.stringify(data.welcomePacketSettings) });
        }
        if (data.calendarIntegration && Object.keys(data.calendarIntegration).length > 0) {
            settingsData.push({ setting: 'calendarIntegration', value: JSON.stringify(data.calendarIntegration) });
        }
        if (data.smsSettings && Object.keys(data.smsSettings).length > 0) {
            settingsData.push({ setting: 'smsSettings', value: JSON.stringify(data.smsSettings) });
        }
        if (data.emailAutomation && Object.keys(data.emailAutomation).length > 0) {
            settingsData.push({ setting: 'emailAutomation', value: JSON.stringify(data.emailAutomation) });
        }
        if (data.cloudBackupSettings && Object.keys(data.cloudBackupSettings).length > 0) {
            settingsData.push({ setting: 'cloudBackupSettings', value: JSON.stringify(data.cloudBackupSettings) });
        }
        if (data.languageSettings && Object.keys(data.languageSettings).length > 0) {
            settingsData.push({ setting: 'languageSettings', value: JSON.stringify(data.languageSettings) });
        }
        if (data.largePrintEnabled !== undefined) {
            settingsData.push({ setting: 'largePrintEnabled', value: String(data.largePrintEnabled) });
        }
        if (settingsData.length > 0) {
            const csv = arrayToCSV(settingsData, ['setting', 'value']);
            csvFiles.push({ name: 'application_settings.csv', content: csv });
        }

        const metadata = {
            exportDate: data.exportDate,
            version: data.version,
            backupType: 'full-csv',
            filesCount: csvFiles.length,
            featureCount: data.featureCount || 90,
            instructions: 'To restore: Import this backup using the CSV Import button in Settings'
        };
        csvFiles.push({
            name: '_backup_metadata.json',
            content: JSON.stringify(metadata, null, 2)
        });
        let combinedCSV = `HomeGroup Backup - Pipe-Delimited CSV\nExport Date: ${data.exportDate}\nVersion: ${data.version}\n\n`;
        csvFiles.forEach(file => {
            combinedCSV += `\n${'='.repeat(80)}\n`;
            combinedCSV += `FILE: ${file.name}\n`;
            combinedCSV += `${'='.repeat(80)}\n`;
            combinedCSV += file.content;
            combinedCSV += `\n`;
        });
        const blob = new Blob([combinedCSV], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `aa-group-backup-${dateStr}_${timeStr}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast(`✅ CSV backup exported! ${csvFiles.length} files included.`, 'success');
        logAuditEntry('export', 'full-backup-csv', 'system', { filesCount: csvFiles.length, size: blob.size }, 'Full CSV backup exported');
    } catch (error) {
        showToast('❌ Error exporting CSV backup: ' + error.message, 'error');
        console.error('CSV export error:', error);
    }
}
function importFullBackupCSV() {
    showToast('⚠️ CSV import requires the JSON backup file. Please use JSON Import for full restore, or manually import CSV files into a spreadsheet to review data.', 'info');
}
function restoreAllApplicationData(data) {
    if (data.events) storage.saveEvents(data.events);
    if (data.members) storage.saveMembers(data.members);
    if (data.announcements) storage.saveAnnouncements(data.announcements);
    if (data.photos) storage.savePhotos(data.photos);

    if (data.chairpersonLog) storage.saveChairpersonLog(data.chairpersonLog);
    if (data.meetingMinutes) storage.saveMeetingMinutes(data.meetingMinutes);
    if (data.meetingFeedback) localStorage.setItem('meetingFeedback', JSON.stringify(data.meetingFeedback));
    if (data.roleRotation) localStorage.setItem('roleRotation', JSON.stringify(data.roleRotation));
    if (data.virtualMeetings) localStorage.setItem('virtualMeetings', JSON.stringify(data.virtualMeetings));
    if (data.qrCheckInSettings) localStorage.setItem('qrCheckInSettings', JSON.stringify(data.qrCheckInSettings));
    if (data.meetingAnalytics) localStorage.setItem('meetingAnalytics', JSON.stringify(data.meetingAnalytics));

    if (data.groupConscienceLog) storage.saveGroupConscienceLog(data.groupConscienceLog);
    if (data.liveGCItems) storage.saveLiveGCItems(data.liveGCItems);
    if (data.proposedAgendaItems) storage.saveProposedAgendaItems(data.proposedAgendaItems);
    if (data.gcComments) storage.saveGCComments(data.gcComments);
    if (data.gcActionItems) storage.saveGCActionItems(data.gcActionItems);
    if (data.gcSettings) storage.saveGCSettings(data.gcSettings);
    if (data.motionTemplates) storage.saveMotionTemplates(data.motionTemplates);
    if (data.traditionChecks) storage.saveTraditionChecks(data.traditionChecks);
    if (data.unityChecks) storage.saveUnityChecks(data.unityChecks);
    if (data.minorityOpinions) storage.saveMinorityOpinions(data.minorityOpinions);
    if (data.conflicts) localStorage.setItem('conflicts', JSON.stringify(data.conflicts));
    if (data.inventoryQuestions) localStorage.setItem('inventoryQuestions', JSON.stringify(data.inventoryQuestions));

    if (data.messages) storage.saveMessages(data.messages);
    if (data.commLists) localStorage.setItem('commLists', JSON.stringify(data.commLists));
    if (data.reminderSettings) localStorage.setItem('reminderSettings', JSON.stringify(data.reminderSettings));
    if (data.notifications) localStorage.setItem('notifications', JSON.stringify(data.notifications));
    if (data.actionItems) localStorage.setItem('actionItems', JSON.stringify(data.actionItems));
    if (data.cancellationAlerts) localStorage.setItem('cancellationAlerts', JSON.stringify(data.cancellationAlerts));
    if (data.welcomePacketSettings) localStorage.setItem('welcomePacketSettings', JSON.stringify(data.welcomePacketSettings));

    if (data.servicePositions) storage.saveServicePositions(data.servicePositions);
    if (data.serviceElections) storage.saveServiceElections(data.serviceElections);
    if (data.electionBallots) storage.saveElectionBallots(data.electionBallots);
    if (data.nominations) storage.saveNominations(data.nominations);
    if (data.groupPositions) storage.saveGroupPositions(data.groupPositions);
    if (data.speakingQueue) storage.saveSpeakingQueue(data.speakingQueue);
    if (data.hiCommitments) localStorage.setItem('hiCommitments', JSON.stringify(data.hiCommitments));
    if (data.serviceHours) localStorage.setItem('serviceHours', JSON.stringify(data.serviceHours));

    if (data.budgetCategories) storage.saveBudgetCategories(data.budgetCategories);
    if (data.expenses) storage.saveExpenses(data.expenses);
    if (data.budgetProposals) storage.saveBudgetProposals(data.budgetProposals);
    if (data.expenseApprovals) localStorage.setItem('expenseApprovals', JSON.stringify(data.expenseApprovals));
    if (data.billReminders) localStorage.setItem('billReminders', JSON.stringify(data.billReminders));
    if (data.financialGoals) localStorage.setItem('financialGoals', JSON.stringify(data.financialGoals));
    if (data.expenseReceipts) localStorage.setItem('expenseReceipts', JSON.stringify(data.expenseReceipts));
    if (data.treasurerBalance) localStorage.setItem('treasurerBalance', data.treasurerBalance);
    if (data.reserveTarget) localStorage.setItem('reserveTarget', data.reserveTarget);
    if (data.monthlyExpenses) localStorage.setItem('monthlyExpenses', data.monthlyExpenses);
    if (data.reserveMonths) localStorage.setItem('reserveMonths', data.reserveMonths);

    if (data.sponsorships) localStorage.setItem('sponsorships', JSON.stringify(data.sponsorships));
    if (data.sponsorshipTree) localStorage.setItem('sponsorshipTree', JSON.stringify(data.sponsorshipTree));

    if (data.literatureInventory) storage.saveLiteratureInventory(data.literatureInventory);
    if (data.literatureLoans) storage.saveLiteratureLoans(data.literatureLoans);
    if (data.bigBookStudy) localStorage.setItem('bigBookStudy', JSON.stringify(data.bigBookStudy));
    if (data.newcomerPacks) localStorage.setItem('newcomerPacks', JSON.stringify(data.newcomerPacks));
    if (data.literatureSales) localStorage.setItem('literatureSales', JSON.stringify(data.literatureSales));
    if (data.digitalLibrary) localStorage.setItem('digitalLibrary', JSON.stringify(data.digitalLibrary));

    if (data.interGroupAttendance) localStorage.setItem('interGroupAttendance', JSON.stringify(data.interGroupAttendance));
    if (data.homeGroupTransfers) localStorage.setItem('homeGroupTransfers', JSON.stringify(data.homeGroupTransfers));
    if (data.homeGroupBenefits) localStorage.setItem('homeGroupBenefits', JSON.stringify(data.homeGroupBenefits));
    if (data.commitmentLevels) localStorage.setItem('commitmentLevels', JSON.stringify(data.commitmentLevels));
    if (data.censusStats) localStorage.setItem('censusStats', JSON.stringify(data.censusStats));
    if (data.growthMetrics) localStorage.setItem('growthMetrics', JSON.stringify(data.growthMetrics));

    if (data.multiGroups) localStorage.setItem('multiGroups', JSON.stringify(data.multiGroups));
    if (data.calendarIntegration) localStorage.setItem('calendarIntegration', JSON.stringify(data.calendarIntegration));
    if (data.smsSettings) localStorage.setItem('smsSettings', JSON.stringify(data.smsSettings));
    if (data.emailAutomation) localStorage.setItem('emailAutomation', JSON.stringify(data.emailAutomation));
    if (data.cloudBackupSettings) localStorage.setItem('cloudBackupSettings', JSON.stringify(data.cloudBackupSettings));

    if (data.accessibilityConcerns) localStorage.setItem('accessibilityConcerns', JSON.stringify(data.accessibilityConcerns));
    if (data.languageSettings) localStorage.setItem('languageSettings', JSON.stringify(data.languageSettings));
    if (data.largePrintEnabled !== undefined) localStorage.setItem('largePrintEnabled', data.largePrintEnabled.toString());

    if (data.digitalArchive) localStorage.setItem('digitalArchive', JSON.stringify(data.digitalArchive));
    if (data.oralHistories) localStorage.setItem('oralHistories', JSON.stringify(data.oralHistories));
    if (data.milestones) localStorage.setItem('milestones', JSON.stringify(data.milestones));
    if (data.legacies) localStorage.setItem('legacies', JSON.stringify(data.legacies));
    if (data.historicalMinutes) localStorage.setItem('historicalMinutes', JSON.stringify(data.historicalMinutes));

    if (data.districtMotions) storage.saveDistrictMotions(data.districtMotions);

    if (data.templates) storage.saveTemplates(data.templates);
    if (data.votingSettings) storage.saveVotingSettings(data.votingSettings);
    if (data.quorumRules) storage.saveQuorumRules(data.quorumRules);
    if (data.inventorySchedules) storage.saveInventorySchedules(data.inventorySchedules);
    if (data.decisionImpacts) storage.saveDecisionImpacts(data.decisionImpacts);
    if (data.participationData) storage.saveParticipationData(data.participationData);
    if (data.userRole) storage.saveUserRole(data.userRole);
    if (data.educationalProgress) storage.saveEducationalProgress(data.educationalProgress);
    if (data.privacySettings) storage.savePrivacySettings(data.privacySettings);
    if (data.accessLevels) storage.saveAccessLevels(data.accessLevels);
    if (data.traditionOfDay) storage.saveTraditionOfDay(data.traditionOfDay);
    if (data.spiritualPrinciples) storage.saveSpiritualPrinciples(data.spiritualPrinciples);
    if (data.serviceStructure) storage.saveServiceStructure(data.serviceStructure);
    if (data.groupInventories) localStorage.setItem('groupInventories', JSON.stringify(data.groupInventories));
    if (data.backupSettings) localStorage.setItem('backupSettings', JSON.stringify(data.backupSettings));
    if (data.currentUser) localStorage.setItem('currentUser', data.currentUser);
    if (data.treasurerBalance) localStorage.setItem('treasurerBalance', data.treasurerBalance);
    if (data.reserveTarget) localStorage.setItem('reserveTarget', data.reserveTarget);
    if (data.monthlyExpenses) localStorage.setItem('monthlyExpenses', data.monthlyExpenses);
    if (data.reserveMonths) localStorage.setItem('reserveMonths', data.reserveMonths);
}
function addExpense() {
    const date = document.getElementById('expense-date').value;
    const category = document.getElementById('expense-category').value;
    const description = document.getElementById('expense-description').value.trim();
    const amount = parseFloat(document.getElementById('expense-amount').value);
    if (!date || !category || !description || isNaN(amount) || amount < 0) {
        showToast('Please fill in all fields with valid data', 'error');
        return;
    }
    const expenses = storage.getExpenses();
    expenses.push({
        id: genId(),
        date: date,
        category: category,
        description: description,
        amount: amount
    });
    storage.saveExpenses(expenses);
    showToast('Expense logged!', 'success');
    document.getElementById('expense-date').value = '';
    document.getElementById('expense-category').value = '';
    document.getElementById('expense-description').value = '';
    document.getElementById('expense-amount').value = '';
    updateExpensesTable();
    updateBudgetTable();
}
function updateExpensesTable() {
    const tbody = document.getElementById('expenses-table');
    const expenses = storage.getExpenses();
    tbody.innerHTML = '';
    expenses.sort((a, b) => new Date(b.date) - new Date(a.date));
    expenses.slice(0, 20).forEach(exp => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${new Date(exp.date).toLocaleDateString()}</td>
            <td>${exp.category}</td>
            <td>${exp.description}</td>
            <td>$${exp.amount.toFixed(2)}</td>
            <td>
                <button class="btn secondary" data-action="delete-expense" data-id="${escapeAttribute(exp.id)}">Delete</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
    if (expenses.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5">No expenses logged</td></tr>';
    }
}
function deleteExpense(id) {
    if (!confirm('Delete this expense?')) return;
    let expenses = storage.getExpenses();
    expenses = expenses.filter(e => e.id !== id);
    storage.saveExpenses(expenses);
    updateExpensesTable();
    updateBudgetTable();
    showToast('Expense deleted', 'success');
}
function populateExpenseCategories() {
    const select = document.getElementById('expense-category');
    const categories = storage.getBudgetCategories();
    select.innerHTML = '<option value="">Select category...</option>';
    categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.category;
        option.textContent = cat.category;
        select.appendChild(option);
    });
}
function generateMonthlyReport() {
    const month = document.getElementById('report-month').value;
    if (!month) {
        showToast('Please select a month', 'error');
        return;
    }
    const expenses = storage.getExpenses();
    const categories = storage.getBudgetCategories();
    const reportDiv = document.getElementById('monthly-report');
    const monthExpenses = expenses.filter(e => e.date.startsWith(month));
    let totalSpent = 0;
    let totalBudget = 0;
    let reportHTML = `<h4>Financial Report for ${month}</h4>`;
    reportHTML += '<table style="width: 100%; margin-top: 1rem;"><thead><tr><th>Category</th><th>Budget</th><th>Spent</th><th>Variance</th></tr></thead><tbody>';
    categories.forEach(cat => {
        const catExpenses = monthExpenses.filter(e => e.category === cat.category);
        const spent = catExpenses.reduce((sum, e) => sum + e.amount, 0);
        const variance = cat.monthlyBudget - spent;
        totalBudget += cat.monthlyBudget;
        totalSpent += spent;
        reportHTML += `
            <tr>
                <td>${cat.category}</td>
                <td>$${cat.monthlyBudget.toFixed(2)}</td>
                <td>$${spent.toFixed(2)}</td>
                <td style="color: ${variance < 0 ? '#e74c3c' : '#2ecc71'}">$${variance.toFixed(2)}</td>
            </tr>
        `;
    });
    const totalVariance = totalBudget - totalSpent;
    reportHTML += `
        <tr style="font-weight: bold; border-top: 2px solid #3498db;">
            <td>TOTAL</td>
            <td>$${totalBudget.toFixed(2)}</td>
            <td>$${totalSpent.toFixed(2)}</td>
            <td style="color: ${totalVariance < 0 ? '#e74c3c' : '#2ecc71'}">$${totalVariance.toFixed(2)}</td>
        </tr>
    `;
    reportHTML += '</tbody></table>';
    reportHTML += `<p style="margin-top: 1rem;"><strong>Total Expenses:</strong> ${monthExpenses.length}</p>`;
    reportDiv.innerHTML = reportHTML;
    generateYoYChart();
}
function generateYoYChart() {
    const expenses = storage.getExpenses();
    const chartDiv = document.getElementById('yoy-chart');
    const monthlyTotals = {};
    expenses.forEach(exp => {
        const month = exp.date.substring(0, 7);
        if (!monthlyTotals[month]) monthlyTotals[month] = 0;
        monthlyTotals[month] += exp.amount;
    });
    const months = Object.keys(monthlyTotals).sort().slice(-12);
    if (months.length === 0) {
        chartDiv.innerHTML = '<p>Not enough data for chart</p>';
        return;
    }
    let chartHTML = '<h4>Last 12 Months Spending</h4>';
    chartHTML += '<div style="margin-top: 1rem;">';
    const maxAmount = Math.max(...months.map(m => monthlyTotals[m]));
    months.forEach(month => {
        const amount = monthlyTotals[month];
        const barWidth = (amount / maxAmount) * 100;
        chartHTML += `
            <div style="margin-bottom: 0.5rem;">
                <div style="font-size: 0.85rem; margin-bottom: 2px;">${month}: $${amount.toFixed(2)}</div>
                <div style="background: #3498db; height: 20px; width: ${barWidth}%; border-radius: 3px;"></div>
            </div>
        `;
    });
    chartHTML += '</div>';
    chartDiv.innerHTML = chartHTML;
}
function saveGroupSettings() {
    const settings = {
        qrCodeUrl: document.getElementById('group-qr-code-url').value.trim(),
        zoomLink: document.getElementById('group-zoom-link').value.trim(),
        contactName: document.getElementById('group-contact-name').value.trim(),
        contactPhone: document.getElementById('group-contact-phone').value.trim()
    };
    localStorage.setItem('groupSettings', JSON.stringify(settings));
    applyGroupSettings();
    showToast('Group settings saved!', 'success');
}
function loadGroupSettings() {
    const settings = JSON.parse(localStorage.getItem('groupSettings') || '{}');
    const qrInput = document.getElementById('group-qr-code-url');
    const zoomInput = document.getElementById('group-zoom-link');
    const nameInput = document.getElementById('group-contact-name');
    const phoneInput = document.getElementById('group-contact-phone');
    if (qrInput) qrInput.value = settings.qrCodeUrl || '';
    if (zoomInput) zoomInput.value = settings.zoomLink || '';
    if (nameInput) nameInput.value = settings.contactName || '';
    if (phoneInput) phoneInput.value = settings.contactPhone || '';
    applyGroupSettings();
}
function applyGroupSettings() {
    const settings = JSON.parse(localStorage.getItem('groupSettings') || '{}');
    const qrBox = document.getElementById('qr-code-box');
    const qrImg = document.getElementById('qr-code-img');
    const qrContact = document.getElementById('qr-code-contact');
    if (settings.qrCodeUrl) {
        qrImg.src = settings.qrCodeUrl;
        qrBox.style.display = 'block';
        if (settings.contactName && settings.contactPhone) {
            qrContact.textContent = `For questions, please contact ${settings.contactName} at ${settings.contactPhone}.`;
        } else if (settings.contactName) {
            qrContact.textContent = `For questions, please contact ${settings.contactName}.`;
        } else {
            qrContact.textContent = '';
        }
    } else {
        qrBox.style.display = 'none';
    }
    const zoomBtn = document.getElementById('zoom-meeting-btn');
    const zoomNote = document.getElementById('zoom-meeting-note');
    if (settings.zoomLink) {
        zoomBtn.href = settings.zoomLink;
        zoomBtn.style.display = 'block';
        zoomNote.style.display = 'block';
    } else {
        zoomBtn.style.display = 'none';
        zoomNote.style.display = 'none';
    }
}
function saveCurrentUser() {
    const name = document.getElementById('current-user-name').value.trim();
    if (!name) {
        showToast('Please enter your name', 'error');
        return;
    }
    storage.saveCurrentUser(name);
    showToast('Name saved!', 'success');
}
function loadCurrentUser() {
    const name = storage.getCurrentUser();
    const input = document.getElementById('current-user-name');
    if (input) {
        input.value = name;
    }
}
function checkStorageUsage() {
    try {
        let totalSize = 0;
        for (let key in localStorage) {
            if (localStorage.hasOwnProperty(key)) {
                totalSize += localStorage[key].length + key.length;
            }
        }
        const sizeInKB = (totalSize / 1024).toFixed(2);
        const estimatedLimit = 5120; // Most browsers allow ~5MB (5120 KB)
        const percentage = (totalSize / (estimatedLimit * 1024)) * 100;
        document.getElementById('storage-used').textContent = sizeInKB;
        const progressBar = document.getElementById('storage-progress-bar');
        progressBar.style.width = Math.min(percentage, 100) + '%';
        const warningDiv = document.getElementById('storage-warning');
        const criticalDiv = document.getElementById('storage-critical');
        warningDiv.style.display = 'none';
        criticalDiv.style.display = 'none';
        if (percentage > 90) {
            progressBar.style.background = 'linear-gradient(90deg, #c0392b, #e74c3c)';
            criticalDiv.style.display = 'block';
        } else if (percentage > 80) {
            progressBar.style.background = 'linear-gradient(90deg, #d68910, #f39c12)';
            warningDiv.style.display = 'block';
        } else {
            progressBar.style.background = 'linear-gradient(90deg, #27ae60, #2ecc71)';
        }
        progressBar.textContent = percentage.toFixed(1) + '%';
        return {sizeInKB, percentage};
    } catch (e) {
        console.error('Error checking storage:', e);
        return null;
    }
}
function saveTemplate() {
    const name = document.getElementById('template-name').value.trim();
    const type = document.getElementById('template-type').value;
    const content = document.getElementById('template-content').value.trim();
    if (!name || !content) {
        showToast('Please enter template name and content', 'error');
        return;
    }
    const templates = storage.getTemplates();
    templates.push({
        id: genId(),
        name: name,
        type: type,
        content: content,
        created: new Date().toISOString()
    });
    storage.saveTemplates(templates);
    showToast('Template saved!', 'success');
    document.getElementById('template-name').value = '';
    document.getElementById('template-type').value = 'meeting-format';
    document.getElementById('template-content').value = '';
    filterTemplates('all');
}
function filterTemplates(type) {
    const templates = storage.getTemplates();
    const container = document.getElementById('templates-list');
    document.getElementById('all-templates-btn').classList.toggle('active', type === 'all');
    document.getElementById('meeting-templates-btn').classList.toggle('active', type === 'meeting-format');
    document.getElementById('speaker-templates-btn').classList.toggle('active', type === 'speaker-checklist');
    document.getElementById('event-templates-btn').classList.toggle('active', type === 'event-planning');
    const filtered = type === 'all' ? templates : templates.filter(t => t.type === type);
    container.innerHTML = '';
    if (filtered.length === 0) {
        container.innerHTML = '<p>No templates saved</p>';
        return;
    }
    filtered.forEach(tmpl => {
        const card = document.createElement('div');
        card.className = 'template-card';
        const header = document.createElement('div');
        header.className = 'template-header';
        const title = document.createElement('h4');
        title.textContent = tmpl.name;
        const badge = document.createElement('span');
        badge.className = 'template-type-badge';
        badge.textContent = tmpl.type.replace('-', ' ').toUpperCase();
        header.appendChild(title);
        header.appendChild(badge);
        const content = document.createElement('pre');
        content.style.whiteSpace = 'pre-wrap';
        content.style.fontSize = '0.9rem';
        content.style.marginTop = '10px';
        content.textContent = tmpl.content;
        const btnContainer = document.createElement('div');
        btnContainer.style.marginTop = '10px';
        const useBtn = document.createElement('button');
        useBtn.className = 'btn';
        useBtn.textContent = 'Use Template';
        useBtn.onclick = () => useTemplate(tmpl.id);
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn secondary';
        deleteBtn.style.marginLeft = '8px';
        deleteBtn.textContent = 'Delete';
        deleteBtn.onclick = () => deleteTemplate(tmpl.id);
        btnContainer.appendChild(useBtn);
        btnContainer.appendChild(deleteBtn);
        card.appendChild(header);
        card.appendChild(content);
        card.appendChild(btnContainer);
        container.appendChild(card);
    });
}
function useTemplate(id) {
    const templates = storage.getTemplates();
    const template = templates.find(t => t.id === id);
    if (template) {
        navigator.clipboard.writeText(template.content).then(() => {
            showToast('Template copied to clipboard!', 'success');
        }).catch(() => {
            showToast('Could not copy template', 'error');
        });
    }
}
function deleteTemplate(id) {
    if (!confirm('Delete this template?')) return;
    let templates = storage.getTemplates();
    templates = templates.filter(t => t.id !== id);
    storage.saveTemplates(templates);
    filterTemplates('all');
    showToast('Template deleted', 'success');
}
function initializeNewAAFeatures() {
    updateAreaMotionsList();
    updateGroupPositionMotionDropdown();
    updateAssemblyAgendasList();

    const members = storage.getMembers();
    const hotlineVolunteerSelect = document.getElementById('hotline-volunteer');
    if (hotlineVolunteerSelect) {
        hotlineVolunteerSelect.innerHTML = '<option value="">-- Select Volunteer --</option>' +
            members.map(m => `<option value="${m.id}">${escapeHtml(m.name)}</option>`).join('');
    }
    const specialEventCoordinator = document.getElementById('special-event-coordinator');
    if (specialEventCoordinator) {
        specialEventCoordinator.innerHTML = '<option value="">-- Select Coordinator --</option>' +
            members.map(m => `<option value="${m.id}">${escapeHtml(m.name)}</option>`).join('');
    }
    updateIRMeetingsList();
    updateHotlineScheduleList();
    updateSpecialEventsList();
    updatePIActivitiesList();

    const panelLeaderSelect = document.getElementById('panel-leader');
    if (panelLeaderSelect) {
        panelLeaderSelect.innerHTML = '<option value="">-- Select Leader --</option>' +
            members.map(m => `<option value="${m.id}">${escapeHtml(m.name)}</option>`).join('');
    }
    const panelSpeakersSelect = document.getElementById('panel-speakers');
    if (panelSpeakersSelect) {
        panelSpeakersSelect.innerHTML = members.map(m => `<option value="${m.id}">${escapeHtml(m.name)}</option>`).join('');
    }
    const certMemberSelect = document.getElementById('cert-member');
    if (certMemberSelect) {
        certMemberSelect.innerHTML = '<option value="">-- Select Member --</option>' +
            members.map(m => `<option value="${m.id}">${escapeHtml(m.name)}</option>`).join('');
    }
    updateFacilitiesList();
    updatePanelFacilityDropdown();
    updateCertFacilityDropdown();
    updateHIPanelsTable();
    updateCertificationsList();

    const presenterSelect = document.getElementById('pres-presenter');
    if (presenterSelect) {
        presenterSelect.innerHTML = members.map(m => `<option value="${m.id}">${escapeHtml(m.name)}</option>`).join('');
    }
    const btgContactSelect = document.getElementById('btg-contact');
    if (btgContactSelect) {
        btgContactSelect.innerHTML = '<option value="">-- Select Contact --</option>' +
            members.map(m => `<option value="${m.id}">${escapeHtml(m.name)}</option>`).join('');
    }
    updateProfessionalsList();
    updatePresentationsList();
    updateBTGReferralsList();

    const outreachCoordinator = document.getElementById('outreach-coordinator');
    if (outreachCoordinator) {
        outreachCoordinator.innerHTML = '<option value="">-- Select Coordinator --</option>' +
            members.map(m => `<option value="${m.id}">${escapeHtml(m.name)}</option>`).join('');
    }
    const outreachLogVolunteers = document.getElementById('outreach-log-volunteers');
    if (outreachLogVolunteers) {
        outreachLogVolunteers.innerHTML = members.map(m => `<option value="${m.id}">${escapeHtml(m.name)}</option>`).join('');
    }
    updateMediaContactsList();
    updateOutreachEventsList();
    updateOutreachLogList();

    const bridgeContactSelect = document.getElementById('bridge-contact');
    if (bridgeContactSelect) {
        bridgeContactSelect.innerHTML = '<option value="">-- Select Contact --</option>' +
            members.map(m => `<option value="${m.id}">${escapeHtml(m.name)}</option>`).join('');
    }
    updateTreatmentFacilitiesList();
    updateBridgeFacilityDropdown();
    updateBridgingCommitmentsList();
    updateFollowUpBridgeDropdown();

    const correctionsClearanceMemberSelect = document.getElementById('corrections-clearance-member');
    if (correctionsClearanceMemberSelect) {
        correctionsClearanceMemberSelect.innerHTML = '<option value="">-- Select Member --</option>' +
            members.map(m => `<option value="${m.id}">${escapeHtml(m.name)}</option>`).join('');
    }
    const prereleaseContactSelect = document.getElementById('prerelease-contact');
    if (prereleaseContactSelect) {
        prereleaseContactSelect.innerHTML = '<option value="">-- Select Contact --</option>' +
            members.map(m => `<option value="${m.id}">${escapeHtml(m.name)}</option>`).join('');
    }
    updateCorrectionsFacilitiesList();
    updateCorrectionsClearanceFacilityDropdown();
    updatePreReleaseFacilityDropdown();
    updatePreReleaseList();
    updateCorrespondencePreReleaseDropdown();
    updateCorrespondenceLog();

    const eventMgmtCoordinatorSelect = document.getElementById('event-mgmt-coordinator');
    if (eventMgmtCoordinatorSelect) {
        eventMgmtCoordinatorSelect.innerHTML = '<option value="">-- Select Coordinator --</option>' +
            members.map(m => `<option value="${m.id}">${escapeHtml(m.name)}</option>`).join('');
    }
    const volunteerMemberSelect = document.getElementById('volunteer-member');
    if (volunteerMemberSelect) {
        volunteerMemberSelect.innerHTML = '<option value="">-- Select Volunteer --</option>' +
            members.map(m => `<option value="${m.id}">${escapeHtml(m.name)}</option>`).join('');
    }
    updateEventsMgmtList();
    updateEventDropdowns();
    updateSpeakersList();
    updateVolunteersSchedule();
    updateEventBudgetSummary();
    updateTicketSalesSummary();

    const interviewInterviewerSelect = document.getElementById('interview-interviewer');
    if (interviewInterviewerSelect) {
        interviewInterviewerSelect.innerHTML = '<option value="">-- Select Interviewer --</option>' +
            members.map(m => `<option value="${m.id}">${escapeHtml(m.name)}</option>`).join('');
    }
    filterArchives();
    updateInterviewsList();

    const translatorMemberSelect = document.getElementById('translator-member');
    if (translatorMemberSelect) {
        translatorMemberSelect.innerHTML = '<option value="">-- Select Member --</option>' +
            members.map(m => `<option value="${m.id}">${escapeHtml(m.name)}</option>`).join('');
    }
    const materialTranslatorSelect = document.getElementById('material-translator');
    if (materialTranslatorSelect) {
        const translators = storage.getTranslators();
        materialTranslatorSelect.innerHTML = '<option value="">-- Select Translator --</option>' +
            translators.map(t => {
                const member = members.find(m => m.id === t.member);
                return `<option value="${t.id}">${member ? escapeHtml(member.name) : 'Unknown'} - ${escapeHtml(t.language)}</option>`;
            }).join('');
    }
    updateTranslatorsList();
    updateMaterialsByLanguage();
    updateInterpretersList();
    updateInterpreterScheduleDropdown();
    updateInterpreterScheduleList();
}

function init() {
    initDefaults();
    initNav();
    initDictionary();
    initCalendarNav();
    updateEventsTable();
    updateBirthdaysTable();
    updateAnnouncementsList();
    updateGallery();
    updateHome();
    renderCalendar();
    showHistory('genesis-history');
    updateChairpersonLogTable();
    updateGCLogTable();
    updateLiveGCTable();
    updateChairpersonAnnouncements();
    populateAttendeeDropdown();
    populateMemberDropdowns();
    renderServantReportInputs();
    setupAudioRecorder();
    updateProposedAgendaTable();
    loadGCSettings();
    updateActionItemsTable();
    performGCHistorySearch(); // Call direct function to avoid debounce on init
    updateGCStatistics();
    refreshGCTrends();
    populateNewFeatureDropdowns();
    refreshStandingItems();
    refreshConsentAgenda();
    refreshEmailHistory();
    refreshReconsiderationRequests();
    refreshProxyVotes();
    refreshDecisionReversals();
    loadGroupSettings();
    loadCurrentUser();
    populateMessageRecipients();
    showMessages('inbox');
    populateServicePositionHolders();
    updateServicePositionsTable();
    updateRotationCalendar();
    populateNominationPositions();
    updateNominationsList();
    populateExpenseCategories();
    updateBudgetTable();
    updateExpensesTable();
    filterTemplates('all');
    checkCrashRecovery();
    setTimeout(() => checkAndPromptBackup(), 3000); // Check backup after 3 seconds
    setInterval(autoSaveToSession, 5 * 60 * 1000);
    autoSaveToSession();
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('expense-date').value = today;
    refreshAnalytics();
    loadAccessibilitySettings();
    checkStorageUsage();
    setTimeout(() => checkUpcomingGCMeetings(), 2000); // Delay 2 seconds for better UX
    updateNotificationBadge();
    scheduleAutomatedBackups();
    checkUpcomingTermExpirations();
    checkMemberEngagement();
    initSmartNotificationSystem();
    checkUpcomingBirthdaysAndAnniversaries();
    checkActionItemReminders();
    updatePrudentReserveProgressBar();
    renderDecisionImpacts();
    populateImpactGCMotions();
    searchLessonsLearned();
    const projRevenueType = document.getElementById('projection-revenue-type');
    if (projRevenueType) {
        projRevenueType.addEventListener('change', function() {
            const amountGroup = document.getElementById('projection-revenue-amount-group');
            if (this.value === 'none') {
                amountGroup.style.display = 'none';
            } else {
                amountGroup.style.display = 'block';
            }
        });
    }
    setInterval(() => {
        checkUpcomingTermExpirations();
        checkMemberEngagement();
        scheduleAutomatedBackups();
        checkUpcomingBirthdaysAndAnniversaries();
        checkActionItemReminders();
        updatePrudentReserveProgressBar();
    }, 3600000); // Check hourly

    initializeNewAAFeatures();
    const mainEl = document.querySelector('main');
    const backToTopBtn = document.getElementById('back-to-top-btn');
    mainEl.addEventListener('scroll', () => {
        const historySection = document.getElementById('history-section');
        if (historySection.classList.contains('active') && mainEl.scrollTop > 100) {
            backToTopBtn.style.display = 'block';
        } else {
            backToTopBtn.style.display = 'none';
        }
    });
    backToTopBtn.addEventListener('click', () => {
        mainEl.scrollTo({ top: 0, behavior: 'smooth' });
    });
    initNewSections();
    loadVotingSettings();
    renderMotionTemplates();
    renderSpeakingQueue();
    renderCurrentPositions();
    renderElectionHistory();
    renderBudgetProposals();
    renderLiteratureInventory();
    renderLiteratureLoans();
    renderDistrictMotions();
    populateElectionPositions();
    populateSpeakersDropdown();
    populateLiteratureLoanMembers();
    renderQuorumRules();
    renderMinutesArchive();
    populateMinutesGCSelect();
    renderParticipationAnalytics();
    renderDecisionImpacts();
    renderFinancialHealth();
    renderInventorySchedules();
    populateImpactGCMotions();
    updateRoleView();
    loadPrivacySettings();
    displayTraditionOfDay();
    renderPrincipleTaggedList();
    populatePrincipleMotionSelect();
    renderMinorityOpinions();
    populateMinorityMotionSelect();
    loadServiceStructure();
    updateQuorumDisplay();
    setupKeyboardShortcuts();
}
function setupKeyboardShortcuts() {
    document.addEventListener('keydown', (e) => {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
            return;
        }
        if (e.altKey && e.key.toLowerCase() === 'h') {
            e.preventDefault();
            goToSection('home-section');
            showToast('Navigated to Home (Alt+H)', 'info');
        }
        if (e.altKey && e.key.toLowerCase() === 'g') {
            e.preventDefault();
            goToSection('gc-decisions-section');
            showToast('Navigated to Group Conscience (Alt+G)', 'info');
        }
        if (e.altKey && e.key.toLowerCase() === 'f') {
            e.preventDefault();
            goToSection('finance-section');
            showToast('Navigated to Finance (Alt+F)', 'info');
        }
        if (e.altKey && e.key.toLowerCase() === 's') {
            e.preventDefault();
            displayUniversalSearch();
            showToast('Universal Search (Alt+S)', 'info');
        }
        if (e.altKey && e.key.toLowerCase() === 'n') {
            e.preventDefault();
            showNotificationCenter();
            showToast('Notification Center (Alt+N)', 'info');
        }
        if (e.altKey && e.key.toLowerCase() === 'p') {
            e.preventDefault();
            goToSection('parliamentary-section');
            showToast('Navigated to Parliamentary Procedure (Alt+P)', 'info');
        }
        if (e.altKey && e.key.toLowerCase() === 'm') {
            e.preventDefault();
            goToSection('birthdays-section');
            showToast('Navigated to Members (Alt+M)', 'info');
        }
        if (e.key === '?' && !e.shiftKey) {
            e.preventDefault();
            showKeyboardShortcuts();
        }
    });
}
function showKeyboardShortcuts() {
    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';
    modal.innerHTML = `
        <div style="background: #34495e; padding: 2rem; border-radius: 8px; max-width: 600px; width: 90%;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2 style="color: #3498db; margin: 0;"><i class="fas fa-keyboard"></i> Keyboard Shortcuts</h2>
                <button onclick="this.closest('div[style*=fixed]').remove()" style="background: none; border: none; color: #e74c3c; font-size: 2rem; cursor: pointer;">&times;</button>
            </div>
            <div class="box" style="margin-bottom: 1rem;">
                <h3>Navigation</h3>
                <div style="display: grid; gap: 0.5rem;">
                    <div style="display: flex; justify-content: space-between;">
                        <span><kbd>Alt + H</kbd></span>
                        <span>Home</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span><kbd>Alt + G</kbd></span>
                        <span>Group Conscience</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span><kbd>Alt + F</kbd></span>
                        <span>Finance</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span><kbd>Alt + P</kbd></span>
                        <span>Parliamentary Procedure</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span><kbd>Alt + M</kbd></span>
                        <span>Members</span>
                    </div>
                </div>
            </div>
            <div class="box">
                <h3>Actions</h3>
                <div style="display: grid; gap: 0.5rem;">
                    <div style="display: flex; justify-content: space-between;">
                        <span><kbd>Alt + S</kbd></span>
                        <span>Universal Search</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span><kbd>Alt + N</kbd></span>
                        <span>Notifications</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span><kbd>?</kbd></span>
                        <span>Show this help</span>
                    </div>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}
let attendanceChart = null;
let gcParticipationChart = null;
function refreshAnalytics() {
    renderAttendanceTrends();
    renderEngagementMetrics();
    renderGCParticipation();
    renderServiceEngagement();
    renderActivitySummary();
}
function renderAttendanceTrends() {
    const days = parseInt(document.getElementById('analytics-time-range').value);
    const events = JSON.parse(localStorage.getItem('events') || '[]');
    const endDate = new Date();
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - days);
    const relevantEvents = events.filter(e => {
        const eventDate = new Date(e.date);
        return eventDate >= startDate && eventDate <= endDate;
    });
    const weeklyData = {};
    relevantEvents.forEach(event => {
        const eventDate = new Date(event.date);
        const weekStart = new Date(eventDate);
        weekStart.setDate(eventDate.getDate() - eventDate.getDay());
        const weekKey = weekStart.toISOString().split('T')[0];
        if (!weeklyData[weekKey]) {
            weeklyData[weekKey] = { count: 0, totalAttendance: 0 };
        }
        weeklyData[weekKey].count++;
        weeklyData[weekKey].totalAttendance += (event.attendees || []).length;
    });
    const labels = Object.keys(weeklyData).sort();
    const attendanceData = labels.map(key => weeklyData[key].totalAttendance);
    const eventCounts = labels.map(key => weeklyData[key].count);
    const ctx = document.getElementById('attendance-chart').getContext('2d');
    if (attendanceChart) {
        attendanceChart.destroy();
    }
    attendanceChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels.map(date => new Date(date).toLocaleDateString()),
            datasets: [{
                label: 'Total Attendance',
                data: attendanceData,
                borderColor: '#3498db',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    labels: { color: '#ecf0f1' }
                }
            },
            scales: {
                x: {
                    ticks: { color: '#ecf0f1' },
                    grid: { color: 'rgba(236, 240, 241, 0.1)' }
                },
                y: {
                    ticks: { color: '#ecf0f1' },
                    grid: { color: 'rgba(236, 240, 241, 0.1)' },
                    beginAtZero: true
                }
            }
        }
    });
}
function renderEngagementMetrics() {
    const members = JSON.parse(localStorage.getItem('members') || '[]');
    const events = JSON.parse(localStorage.getItem('events') || '[]');
    const messages = JSON.parse(localStorage.getItem('messages') || '[]');
    const gcMotions = JSON.parse(localStorage.getItem('groupConscienceMotions') || '[]');
    const totalMembers = members.length;
    const activeMembers = members.filter(m => m.isServant ||
        events.some(e => (e.attendees || []).includes(m.id))).length;
    const engagementRate = totalMembers > 0 ?
        ((activeMembers / totalMembers) * 100).toFixed(1) : 0;
    const recentMessages = messages.filter(m => {
        const msgDate = new Date(m.timestamp);
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        return msgDate >= thirtyDaysAgo;
    }).length;
    const html = `
        <div style="background: #34495e; padding: 1rem; border-radius: 6px; text-align: center;">
            <div style="font-size: 2rem; color: #3498db; font-weight: bold;">${totalMembers}</div>
            <div style="color: #95a5a6;">Total Members</div>
        </div>
        <div style="background: #34495e; padding: 1rem; border-radius: 6px; text-align: center;">
            <div style="font-size: 2rem; color: #2ecc71; font-weight: bold;">${activeMembers}</div>
            <div style="color: #95a5a6;">Active Members</div>
        </div>
        <div style="background: #34495e; padding: 1rem; border-radius: 6px; text-align: center;">
            <div style="font-size: 2rem; color: #e74c3c; font-weight: bold;">${engagementRate}%</div>
            <div style="color: #95a5a6;">Engagement Rate</div>
        </div>
        <div style="background: #34495e; padding: 1rem; border-radius: 6px; text-align: center;">
            <div style="font-size: 2rem; color: #f39c12; font-weight: bold;">${recentMessages}</div>
            <div style="color: #95a5a6;">Messages (30d)</div>
        </div>
    `;
    document.getElementById('engagement-metrics').innerHTML = html;
}
function renderGCParticipation() {
    const gcMotions = JSON.parse(localStorage.getItem('groupConscienceMotions') || '[]');
    const members = JSON.parse(localStorage.getItem('members') || '[]');
    const totalMotions = gcMotions.length;
    const votedMotions = gcMotions.filter(m => m.status === 'approved' || m.status === 'rejected').length;
    const pendingMotions = gcMotions.filter(m => m.status === 'open').length;
    let totalVotes = 0;
    let totalPossibleVotes = 0;
    gcMotions.forEach(motion => {
        if (motion.votes) {
            totalVotes += motion.votes.yes + motion.votes.no + motion.votes.abstain;
            totalPossibleVotes += members.length;
        }
    });
    const participationRate = totalPossibleVotes > 0 ?
        ((totalVotes / totalPossibleVotes) * 100).toFixed(1) : 0;
    const statsHtml = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
            <div style="background: #34495e; padding: 1rem; border-radius: 6px; text-align: center;">
                <div style="font-size: 1.5rem; color: #3498db; font-weight: bold;">${totalMotions}</div>
                <div style="color: #95a5a6; font-size: 0.9rem;">Total Motions</div>
            </div>
            <div style="background: #34495e; padding: 1rem; border-radius: 6px; text-align: center;">
                <div style="font-size: 1.5rem; color: #2ecc71; font-weight: bold;">${votedMotions}</div>
                <div style="color: #95a5a6; font-size: 0.9rem;">Voted On</div>
            </div>
            <div style="background: #34495e; padding: 1rem; border-radius: 6px; text-align: center;">
                <div style="font-size: 1.5rem; color: #f39c12; font-weight: bold;">${pendingMotions}</div>
                <div style="color: #95a5a6; font-size: 0.9rem;">Pending</div>
            </div>
            <div style="background: #34495e; padding: 1rem; border-radius: 6px; text-align: center;">
                <div style="font-size: 1.5rem; color: #e74c3c; font-weight: bold;">${participationRate}%</div>
                <div style="color: #95a5a6; font-size: 0.9rem;">Participation</div>
            </div>
        </div>
    `;
    document.getElementById('gc-participation-stats').innerHTML = statsHtml;
    const ctx = document.getElementById('gc-participation-chart').getContext('2d');
    if (gcParticipationChart) {
        gcParticipationChart.destroy();
    }
    const approved = gcMotions.filter(m => m.status === 'approved').length;
    const rejected = gcMotions.filter(m => m.status === 'rejected').length;
    const open = gcMotions.filter(m => m.status === 'open').length;
    gcParticipationChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Approved', 'Rejected', 'Open'],
            datasets: [{
                data: [approved, rejected, open],
                backgroundColor: ['#2ecc71', '#e74c3c', '#f39c12']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    labels: { color: '#ecf0f1' }
                }
            }
        }
    });
}
function renderServiceEngagement() {
    const positions = JSON.parse(localStorage.getItem('servicePositions') || '[]');
    const filled = positions.filter(p => p.holder && p.holder.trim() !== '').length;
    const vacant = positions.length - filled;
    const fillRate = positions.length > 0 ?
        ((filled / positions.length) * 100).toFixed(1) : 0;
    const html = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
            <div style="background: #34495e; padding: 1rem; border-radius: 6px; text-align: center;">
                <div style="font-size: 1.5rem; color: #3498db; font-weight: bold;">${positions.length}</div>
                <div style="color: #95a5a6; font-size: 0.9rem;">Total Positions</div>
            </div>
            <div style="background: #34495e; padding: 1rem; border-radius: 6px; text-align: center;">
                <div style="font-size: 1.5rem; color: #2ecc71; font-weight: bold;">${filled}</div>
                <div style="color: #95a5a6; font-size: 0.9rem;">Filled</div>
            </div>
            <div style="background: #34495e; padding: 1rem; border-radius: 6px; text-align: center;">
                <div style="font-size: 1.5rem; color: #e74c3c; font-weight: bold;">${vacant}</div>
                <div style="color: #95a5a6; font-size: 0.9rem;">Vacant</div>
            </div>
            <div style="background: #34495e; padding: 1rem; border-radius: 6px; text-align: center;">
                <div style="font-size: 1.5rem; color: #f39c12; font-weight: bold;">${fillRate}%</div>
                <div style="color: #95a5a6; font-size: 0.9rem;">Fill Rate</div>
            </div>
        </div>
    `;
    document.getElementById('service-engagement-stats').innerHTML = html;
}
function renderActivitySummary() {
    const events = JSON.parse(localStorage.getItem('events') || '[]');
    const messages = JSON.parse(localStorage.getItem('messages') || '[]');
    const announcements = JSON.parse(localStorage.getItem('announcements') || '[]');
    const gcMotions = JSON.parse(localStorage.getItem('groupConscienceMotions') || '[]');
    const now = new Date();
    const sevenDaysAgo = new Date();
    sevenDaysAgo.setDate(now.getDate() - 7);
    const recentEvents = events.filter(e => new Date(e.date) >= sevenDaysAgo).length;
    const recentMessages = messages.filter(m => new Date(m.timestamp) >= sevenDaysAgo).length;
    const recentAnnouncements = announcements.filter(a => new Date(a.timestamp) >= sevenDaysAgo).length;
    const recentMotions = gcMotions.filter(m => m.createdAt && new Date(m.createdAt) >= sevenDaysAgo).length;
    const html = `
        <div style="background: #34495e; padding: 1rem; border-radius: 6px;">
            <h4 style="color: #3498db; margin-bottom: 0.75rem;">Last 7 Days</h4>
            <ul style="list-style: none; padding: 0;">
                <li style="padding: 0.5rem 0; border-bottom: 1px solid #2c3e50;">
                    <i class="fas fa-calendar-alt" style="color: #3498db; margin-right: 0.5rem;"></i>
                    <strong>${recentEvents}</strong> events scheduled
                </li>
                <li style="padding: 0.5rem 0; border-bottom: 1px solid #2c3e50;">
                    <i class="fas fa-comment" style="color: #2ecc71; margin-right: 0.5rem;"></i>
                    <strong>${recentMessages}</strong> messages sent
                </li>
                <li style="padding: 0.5rem 0; border-bottom: 1px solid #2c3e50;">
                    <i class="fas fa-bullhorn" style="color: #f39c12; margin-right: 0.5rem;"></i>
                    <strong>${recentAnnouncements}</strong> announcements posted
                </li>
                <li style="padding: 0.5rem 0;">
                    <i class="fas fa-vote-yea" style="color: #e74c3c; margin-right: 0.5rem;"></i>
                    <strong>${recentMotions}</strong> GC motions created
                </li>
            </ul>
        </div>
    `;
    document.getElementById('activity-summary').innerHTML = html;
}
function changeTheme() {
    const theme = document.getElementById('theme-mode').value;
    const body = document.body;
    const nav = document.querySelector('nav');
    const boxes = document.querySelectorAll('.box');
    body.classList.remove('light-theme', 'high-contrast-theme');
    if (theme === 'light') {
        body.style.background = '#ecf0f1';
        body.style.color = '#2c3e50';
        if (nav) {
            nav.style.background = '#bdc3c7';
            nav.style.color = '#2c3e50';
        }
        document.querySelectorAll('h1, h2, h3').forEach(h => {
            h.style.color = '#2980b9';
        });
        boxes.forEach(box => {
            box.style.background = '#ffffff';
            box.style.color = '#2c3e50';
        });
    } else if (theme === 'high-contrast') {
        body.style.background = '#000000';
        body.style.color = '#ffffff';
        if (nav) {
            nav.style.background = '#1a1a1a';
            nav.style.color = '#ffffff';
        }
        document.querySelectorAll('h1, h2, h3').forEach(h => {
            h.style.color = '#ffff00';
        });
        boxes.forEach(box => {
            box.style.background = '#1a1a1a';
            box.style.color = '#ffffff';
        });
    } else {
        body.style.background = '#2c3e50';
        body.style.color = '#ecf0f1';
        if (nav) {
            nav.style.background = '#34495e';
            nav.style.color = '#ecf0f1';
        }
        document.querySelectorAll('h1, h2, h3').forEach(h => {
            h.style.color = '#3498db';
        });
        boxes.forEach(box => {
            box.style.background = '#34495e';
            box.style.color = '#ecf0f1';
        });
    }
    localStorage.setItem('theme', theme);
    showToast('Theme changed', 'success');
}
function changeFontSize(size) {
    document.documentElement.style.fontSize = size + '%';
    document.getElementById('font-size-slider').value = size;
    document.getElementById('font-size-display').textContent = size + '%';
    localStorage.setItem('fontSize', size);
    showToast('Font size updated', 'success');
}
function toggleScreenReaderMode() {
    const enabled = document.getElementById('screen-reader-mode').checked;
    if (enabled) {
        const skipNav = document.createElement('a');
        skipNav.href = '#main-content';
        skipNav.textContent = 'Skip to main content';
        skipNav.id = 'skip-nav';
        skipNav.style.cssText = 'position: absolute; left: -9999px; z-index: 999; padding: 1em; background: #3498db; color: white; text-decoration: none;';
        skipNav.addEventListener('focus', function() {
            this.style.left = '0';
        });
        skipNav.addEventListener('blur', function() {
            this.style.left = '-9999px';
        });
        document.body.insertBefore(skipNav, document.body.firstChild);
        const main = document.querySelector('main');
        if (main) main.id = 'main-content';
        const navItems = document.querySelectorAll('nav li');
        navItems.forEach(item => {
            const section = item.getAttribute('data-section');
            if (section) {
                item.setAttribute('role', 'button');
                item.setAttribute('aria-label', `Navigate to ${item.textContent}`);
                item.setAttribute('tabindex', '0');
            }
        });
        showToast('Screen reader optimizations enabled', 'success');
    } else {
        const skipNav = document.getElementById('skip-nav');
        if (skipNav) skipNav.remove();
        showToast('Screen reader optimizations disabled', 'success');
    }
    localStorage.setItem('screenReaderMode', enabled);
}
function toggleReduceAnimations() {
    const enabled = document.getElementById('reduce-animations').checked;
    if (enabled) {
        const style = document.createElement('style');
        style.id = 'reduce-animations-style';
        style.textContent = `
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        `;
        document.head.appendChild(style);
    } else {
        const style = document.getElementById('reduce-animations-style');
        if (style) style.remove();
    }
    localStorage.setItem('reduceAnimations', enabled);
    showToast(`Animations ${enabled ? 'reduced' : 'restored'}`, 'success');
}
function toggleFocusIndicators() {
    const enabled = document.getElementById('focus-indicators').checked;
    if (enabled) {
        const style = document.createElement('style');
        style.id = 'focus-indicators-style';
        style.textContent = `
            *:focus {
                outline: 3px solid #3498db !important;
                outline-offset: 2px !important;
            }
        `;
        document.head.appendChild(style);
    } else {
        const style = document.getElementById('focus-indicators-style');
        if (style) style.remove();
    }
    localStorage.setItem('focusIndicators', enabled);
    showToast(`Focus indicators ${enabled ? 'enhanced' : 'normal'}`, 'success');
}
function toggleDyslexiaFont() {
    const enabled = document.getElementById('dyslexia-font').checked;
    if (enabled) {
        document.body.style.fontFamily = 'Comic Sans MS, Verdana, sans-serif';
    } else {
        document.body.style.fontFamily = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
    }
    localStorage.setItem('dyslexiaFont', enabled);
    showToast(`Dyslexia-friendly font ${enabled ? 'enabled' : 'disabled'}`, 'success');
}
function loadAccessibilitySettings() {
    const theme = localStorage.getItem('theme') || 'dark';
    document.getElementById('theme-mode').value = theme;
    changeTheme();
    const fontSize = localStorage.getItem('fontSize') || '100';
    changeFontSize(parseInt(fontSize));
    const screenReaderMode = localStorage.getItem('screenReaderMode') === 'true';
    document.getElementById('screen-reader-mode').checked = screenReaderMode;
    if (screenReaderMode) toggleScreenReaderMode();
    const reduceAnimations = localStorage.getItem('reduceAnimations') === 'true';
    document.getElementById('reduce-animations').checked = reduceAnimations;
    if (reduceAnimations) toggleReduceAnimations();
    const focusIndicators = localStorage.getItem('focusIndicators') === 'true';
    document.getElementById('focus-indicators').checked = focusIndicators;
    if (focusIndicators) toggleFocusIndicators();
    const dyslexiaFont = localStorage.getItem('dyslexiaFont') === 'true';
    document.getElementById('dyslexia-font').checked = dyslexiaFont;
    if (dyslexiaFont) toggleDyslexiaFont();
}
document.addEventListener('DOMContentLoaded', init);
document.addEventListener('click', function(e) {
    const btn = e.target.closest('[data-action]');
    if (!btn) return;
    const action = btn.dataset.action;
    const id = btn.dataset.id;
    const status = btn.dataset.status; // For actions that need additional data
    switch(action) {
        case 'view-gc': openGCDetailsModal(id); break;
        case 'edit-gc': editGCLog(id); break;
        case 'delete-gc': deleteGCLog(id); break;
        case 'delete-live-gc': deleteLiveGCItem(id); break;
        case 'view-proposed': viewProposedAgendaItem(id); break;
        case 'delete-proposed': deleteProposedAgendaItem(id); break;
        case 'edit-action': editActionItem(id); break;
        case 'delete-action': deleteActionItem(id); break;
        case 'view-action-details': viewActionItemDetails(id); break;
        case 'update-amendment': updateAmendmentStatus(id, status); break;
        case 'delete-comment': deleteGCComment(id); break;
        case 'view-chain': viewMotionChain(id); break;
        case 'update-gc-status': updateGCItemStatus(id, status); break;
        case 'remove-gc-item': removeGCItem(id); break;
        case 'edit-event': editEvent(id); break;
        case 'delete-event': deleteEvent(id); break;
        case 'edit-member': editMember(id); break;
        case 'delete-member': deleteMember(id); break;
        case 'edit-member-roster': editMemberFromRoster(id); break;
        case 'delete-member-roster': deleteMemberAndRefreshRoster(id); break;
        case 'edit-chairperson': editChairpersonLog(id); break;
        case 'delete-chairperson': deleteChairpersonLog(id); break;
        case 'delete-position': deleteServicePosition(id); break;
        case 'delete-nomination': deleteNomination(id); break;
        case 'delete-budget-category': deleteBudgetCategory(id); break;
        case 'delete-expense': deleteExpense(id); break;
        case 'edit-format': editFormat(id); break;
        case 'delete-format': deleteFormat(id); break;
        case 'edit-commitment': editCommitment(id); break;
        case 'delete-commitment': deleteCommitment(id); break;
        case 'delete-attendance': deleteAttendance(id); break;
        case 'view-bylaw': viewByLaw(id); break;
        case 'delete-sponsorship': deleteSponsorship(id); break;
        case 'use-template': useMotionTemplate(id); break;
        case 'edit-template': editMotionTemplate(id); break;
        case 'delete-template': deleteMotionTemplate(id); break;
        case 'edit-lit-item': editLiteratureItem(id); break;
        case 'delete-lit-item': deleteLiteratureItem(id); break;
    }
});
function handleFormatSubmit() {
    const name = document.getElementById('format-name').value.trim();
    const description = document.getElementById('format-description').value.trim();
    const order = parseInt(document.getElementById('format-order').value);
    const editId = document.getElementById('format-edit-id').value;
    if (!name || !order) {
        showToast('Please fill all required fields', 'error');
        return;
    }
    let formats = JSON.parse(localStorage.getItem('meetingFormats') || '[]');
    if (editId) {
        const index = formats.findIndex(f => f.id === editId);
        formats[index] = { ...formats[index], name, description, order };
        showToast('Format updated successfully', 'success');
    } else {
        const newFormat = { id: Date.now().toString(), name, description, order };
        formats.push(newFormat);
        showToast('Format added successfully', 'success');
    }
    localStorage.setItem('meetingFormats', JSON.stringify(formats));
    loadFormatRotationTable();
    loadUpcomingFormats();
    updateCurrentWeekFormat();
    resetFormatForm();
}
function cancelFormatEdit() {
    resetFormatForm();
}
function resetFormatForm() {
    document.getElementById('format-name').value = '';
    document.getElementById('format-description').value = '';
    document.getElementById('format-order').value = '';
    document.getElementById('format-edit-id').value = '';
    document.getElementById('format-form-btn').textContent = 'Add Format';
    document.getElementById('format-form-cancel-btn').style.display = 'none';
}
function loadFormatRotationTable() {
    const formats = JSON.parse(localStorage.getItem('meetingFormats') || '[]').sort((a, b) => a.order - b.order);
    const tbody = document.getElementById('format-rotation-body');
    tbody.innerHTML = '';
    formats.forEach(format => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${format.order}</td>
            <td>${DOMPurify.sanitize(format.name)}</td>
            <td>${DOMPurify.sanitize(format.description)}</td>
            <td>
                <button class="btn secondary" data-action="edit-format" data-id="${escapeAttribute(format.id)}" style="padding: 0.25rem 0.5rem; font-size: 0.85rem;">Edit</button>
                <button class="btn secondary" data-action="delete-format" data-id="${escapeAttribute(format.id)}" style="padding: 0.25rem 0.5rem; font-size: 0.85rem; margin-left: 0.25rem;">Delete</button>
            </td>
        `;
    });
}
function editFormat(id) {
    const formats = JSON.parse(localStorage.getItem('meetingFormats') || '[]');
    const format = formats.find(f => f.id === id);
    if (format) {
        document.getElementById('format-name').value = format.name;
        document.getElementById('format-description').value = format.description;
        document.getElementById('format-order').value = format.order;
        document.getElementById('format-edit-id').value = id;
        document.getElementById('format-form-btn').textContent = 'Update Format';
        document.getElementById('format-form-cancel-btn').style.display = 'inline-block';
    }
}
function deleteFormat(id) {
    if (!confirm('Delete this format?')) return;
    let formats = JSON.parse(localStorage.getItem('meetingFormats') || '[]');
    formats = formats.filter(f => f.id !== id);
    localStorage.setItem('meetingFormats', JSON.stringify(formats));
    loadFormatRotationTable();
    loadUpcomingFormats();
    showToast('Format deleted', 'success');
}
function loadUpcomingFormats() {
    const formats = JSON.parse(localStorage.getItem('meetingFormats') || '[]').sort((a, b) => a.order - b.order);
    const container = document.getElementById('upcoming-formats-list');
    if (formats.length === 0) {
        container.innerHTML = '<p>No formats configured</p>';
        return;
    }
    const today = new Date();
    let html = '<ul style="list-style: none; padding: 0;">';
    for (let i = 0; i < 8; i++) {
        const weekDate = new Date(today);
        weekDate.setDate(today.getDate() + (i * 7));
        const formatIndex = i % formats.length;
        const format = formats[formatIndex];
        html += `<li style="padding: 0.5rem; border-bottom: 1px solid #7f8c8d;">
            <strong>${weekDate.toLocaleDateString()}</strong>: ${DOMPurify.sanitize(format.name)}
        </li>`;
    }
    html += '</ul>';
    container.innerHTML = html;
}
function updateCurrentWeekFormat() {
    const formats = JSON.parse(localStorage.getItem('meetingFormats') || '[]').sort((a, b) => a.order - b.order);
    if (formats.length === 0) {
        document.getElementById('current-format-name').textContent = 'No Format Set';
        document.getElementById('current-week-date').textContent = '';
        return;
    }
    const today = new Date();
    const weekNumber = Math.floor((today - new Date(today.getFullYear(), 0, 1)) / (7 * 24 * 60 * 60 * 1000));
    const formatIndex = weekNumber % formats.length;
    const currentFormat = formats[formatIndex];
    document.getElementById('current-format-name').textContent = currentFormat.name;
    document.getElementById('current-week-date').textContent = today.toLocaleDateString();
}
function handleCommitmentSubmit() {
    const date = document.getElementById('commitment-date').value;
    const role = document.getElementById('commitment-role').value;
    const member = document.getElementById('commitment-member').value;
    const reminder = document.getElementById('commitment-reminder').checked;
    const editId = document.getElementById('commitment-edit-id').value;
    if (!date || !role || !member) {
        showToast('Please fill all required fields', 'error');
        return;
    }
    let commitments = JSON.parse(localStorage.getItem('meetingCommitments') || '[]');
    if (editId) {
        const index = commitments.findIndex(c => c.id === editId);
        commitments[index] = { ...commitments[index], date, role, member, reminder };
        showToast('Commitment updated successfully', 'success');
    } else {
        const newCommitment = { id: Date.now().toString(), date, role, member, reminder };
        commitments.push(newCommitment);
        showToast('Commitment added successfully', 'success');
    }
    localStorage.setItem('meetingCommitments', JSON.stringify(commitments));
    loadCommitmentTable();
    loadCurrentWeekCommitments();
    resetCommitmentForm();
}
function cancelCommitmentEdit() {
    resetCommitmentForm();
}
function resetCommitmentForm() {
    document.getElementById('commitment-date').value = '';
    document.getElementById('commitment-role').selectedIndex = 0;
    document.getElementById('commitment-member').selectedIndex = 0;
    document.getElementById('commitment-reminder').checked = true;
    document.getElementById('commitment-edit-id').value = '';
    document.getElementById('commitment-form-btn').textContent = 'Sign Up';
    document.getElementById('commitment-form-cancel-btn').style.display = 'none';
}
function loadCommitmentTable() {
    const commitments = JSON.parse(localStorage.getItem('meetingCommitments') || '[]').sort((a, b) => new Date(a.date) - new Date(b.date));
    const tbody = document.getElementById('commitment-body');
    tbody.innerHTML = '';
    commitments.forEach(commitment => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${new Date(commitment.date).toLocaleDateString()}</td>
            <td>${DOMPurify.sanitize(commitment.role)}</td>
            <td>${DOMPurify.sanitize(commitment.member)}</td>
            <td>
                <button class="btn secondary" data-action="edit-commitment" data-id="${escapeAttribute(commitment.id)}" style="padding: 0.25rem 0.5rem; font-size: 0.85rem;">Edit</button>
                <button class="btn secondary" data-action="delete-commitment" data-id="${escapeAttribute(commitment.id)}" style="padding: 0.25rem 0.5rem; font-size: 0.85rem; margin-left: 0.25rem;">Delete</button>
            </td>
        `;
    });
}
function editCommitment(id) {
    const commitments = JSON.parse(localStorage.getItem('meetingCommitments') || '[]');
    const commitment = commitments.find(c => c.id === id);
    if (commitment) {
        document.getElementById('commitment-date').value = commitment.date;
        document.getElementById('commitment-role').value = commitment.role;
        document.getElementById('commitment-member').value = commitment.member;
        document.getElementById('commitment-reminder').checked = commitment.reminder;
        document.getElementById('commitment-edit-id').value = id;
        document.getElementById('commitment-form-btn').textContent = 'Update';
        document.getElementById('commitment-form-cancel-btn').style.display = 'inline-block';
    }
}
function deleteCommitment(id) {
    if (!confirm('Delete this commitment?')) return;
    let commitments = JSON.parse(localStorage.getItem('meetingCommitments') || '[]');
    commitments = commitments.filter(c => c.id !== id);
    localStorage.setItem('meetingCommitments', JSON.stringify(commitments));
    loadCommitmentTable();
    loadCurrentWeekCommitments();
    showToast('Commitment deleted', 'success');
}
function loadCurrentWeekCommitments() {
    const container = document.getElementById('current-week-commitments');
    const commitments = JSON.parse(localStorage.getItem('meetingCommitments') || '[]');
    const today = new Date();
    const weekStart = new Date(today.setDate(today.getDate() - today.getDay()));
    const weekEnd = new Date(weekStart);
    weekEnd.setDate(weekEnd.getDate() + 7);
    const thisWeek = commitments.filter(c => {
        const commitDate = new Date(c.date);
        return commitDate >= weekStart && commitDate < weekEnd;
    });
    if (thisWeek.length === 0) {
        container.innerHTML = '<p>No commitments this week</p>';
        return;
    }
    let html = '<ul style="list-style: none; padding: 0;">';
    thisWeek.forEach(c => {
        html += `<li style="padding: 0.5rem; border-bottom: 1px solid #7f8c8d;">
            <strong>${c.role}:</strong> ${DOMPurify.sanitize(c.member)} (${new Date(c.date).toLocaleDateString()})
        </li>`;
    });
    html += '</ul>';
    container.innerHTML = html;
}
function handleAttendanceSubmit() {
    const date = document.getElementById('attendance-date').value;
    const memberSelect = document.getElementById('attendance-members');
    const selectedMembers = Array.from(memberSelect.selectedOptions).map(opt => opt.value);
    const visitors = parseInt(document.getElementById('attendance-visitors').value) || 0;
    if (!date || selectedMembers.length === 0) {
        showToast('Please select date and at least one member', 'error');
        return;
    }
    const attendance = {
        id: Date.now().toString(),
        date,
        members: selectedMembers,
        visitors,
        total: selectedMembers.length + visitors
    };
    let attendanceLog = JSON.parse(localStorage.getItem('attendanceLog') || '[]');
    attendanceLog.push(attendance);
    localStorage.setItem('attendanceLog', JSON.stringify(attendanceLog));
    showToast('Attendance saved successfully', 'success');
    loadAttendanceHistory();
    updateAttendanceStats();
    document.getElementById('attendance-date').value = '';
    document.getElementById('attendance-visitors').value = '0';
    memberSelect.selectedIndex = -1;
}
function loadAttendanceHistory() {
    const log = JSON.parse(localStorage.getItem('attendanceLog') || '[]').reverse();
    const tbody = document.getElementById('attendance-history-body');
    tbody.innerHTML = '';
    log.slice(0, 10).forEach(entry => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${new Date(entry.date).toLocaleDateString()}</td>
            <td>${entry.members.length}</td>
            <td>${entry.visitors}</td>
            <td>${entry.total}</td>
            <td>
                <button class="btn secondary" data-action="delete-attendance" data-id="${escapeAttribute(entry.id)}" style="padding: 0.25rem 0.5rem; font-size: 0.85rem;">Delete</button>
            </td>
        `;
    });
}
function deleteAttendance(id) {
    if (!confirm('Delete this attendance record?')) return;
    let log = JSON.parse(localStorage.getItem('attendanceLog') || '[]');
    log = log.filter(a => a.id !== id);
    localStorage.setItem('attendanceLog', JSON.stringify(log));
    loadAttendanceHistory();
    updateAttendanceStats();
    showToast('Attendance record deleted', 'success');
}
function updateAttendanceStats() {
    const log = JSON.parse(localStorage.getItem('attendanceLog') || '[]');
    if (log.length === 0) return;
    const avgAttendance = Math.round(log.reduce((sum, a) => sum + a.total, 0) / log.length);
    const uniqueMembers = new Set(log.flatMap(a => a.members)).size;
    const thisMonth = new Date().getMonth();
    const monthlyVisitors = log.filter(a => new Date(a.date).getMonth() === thisMonth)
        .reduce((sum, a) => sum + a.visitors, 0);
    document.getElementById('avg-attendance').textContent = avgAttendance;
    document.getElementById('regular-members').textContent = uniqueMembers;
    document.getElementById('monthly-visitors').textContent = monthlyVisitors;
}
function searchGCDecisions() {
    const searchTerm = document.getElementById('gc-search').value.toLowerCase();
    const status = document.getElementById('gc-filter-status').value;
    const year = document.getElementById('gc-filter-year').value;
    let decisions = JSON.parse(localStorage.getItem('gcLog') || '[]');
    if (searchTerm) {
        decisions = decisions.filter(d =>
            d.item.toLowerCase().includes(searchTerm) ||
            d.submittedBy.toLowerCase().includes(searchTerm)
        );
    }
    if (status !== 'all') {
        decisions = decisions.filter(d => d.status === status);
    }
    if (year !== 'all') {
        decisions = decisions.filter(d => new Date(d.date).getFullYear().toString() === year);
    }
    displayGCDecisions(decisions);
}
function displayGCDecisions(decisions) {
    const container = document.getElementById('gc-decisions-list');
    if (decisions.length === 0) {
        container.innerHTML = '<p>No decisions found</p>';
        return;
    }
    let html = '';
    decisions.forEach(d => {
        html += `
            <div class="box mb-2" style="cursor: pointer;" data-action="view-chain" data-id="${escapeAttribute(d.id)}">
                <div><strong>${new Date(d.date).toLocaleDateString()}</strong></div>
                <div>${DOMPurify.sanitize(d.item)}</div>
                <div style="font-size: 0.85rem; color: #95a5a6;">
                    Status: ${d.status} | Submitted by: ${DOMPurify.sanitize(d.submittedBy)}
                </div>
            </div>
        `;
    });
    container.innerHTML = html;
}
function linkGCMotions() {
    const primaryId = document.getElementById('gc-link-primary').value;
    const relatedId = document.getElementById('gc-link-related').value;
    const linkType = document.getElementById('gc-link-type').value;
    if (!primaryId || !relatedId) {
        showToast('Please select both motions', 'error');
        return;
    }
    let links = JSON.parse(localStorage.getItem('gcMotionLinks') || '[]');
    links.push({ primaryId, relatedId, linkType, timestamp: Date.now() });
    localStorage.setItem('gcMotionLinks', JSON.stringify(links));
    showToast('Motions linked successfully', 'success');
}
function viewMotionChain(motionId) {
    const decisions = JSON.parse(localStorage.getItem('gcLog') || '[]');
    const links = JSON.parse(localStorage.getItem('gcMotionLinks') || '[]');
    const motion = decisions.find(d => d.id === motionId);
    if (!motion) return;
    let html = `<h4>Primary Motion</h4>
        <div class="box mb-2">
            <div><strong>${new Date(motion.date).toLocaleDateString()}</strong></div>
            <div>${DOMPurify.sanitize(motion.item)}</div>
            <div>Status: ${motion.status}</div>
        </div>`;
    const relatedLinks = links.filter(l => l.primaryId === motionId || l.relatedId === motionId);
    if (relatedLinks.length > 0) {
        html += '<h4 class="mt-2">Related Motions</h4>';
        relatedLinks.forEach(link => {
            const relatedId = link.primaryId === motionId ? link.relatedId : link.primaryId;
            const related = decisions.find(d => d.id === relatedId);
            if (related) {
                html += `
                    <div class="box mb-2">
                        <div style="font-size: 0.75rem; color: #3498db;">${link.linkType.toUpperCase()}</div>
                        <div><strong>${new Date(related.date).toLocaleDateString()}</strong></div>
                        <div>${DOMPurify.sanitize(related.item)}</div>
                    </div>
                `;
            }
        });
    }
    document.getElementById('motion-chain-display').innerHTML = html;
}
function loadInventoryTemplate() {
    const type = document.getElementById('inventory-type').value;
    const container = document.getElementById('inventory-questions-container');
    if (!type) {
        container.innerHTML = '';
        return;
    }
    const templates = {
        'traditions': [
            'Does our group place principles before personalities?',
            'Is our group self-supporting through our own contributions?',
            'Does our group have any outside affiliations?',
            'Is our group autonomous except in matters affecting other groups?',
            'Do we practice attraction rather than promotion?'
        ],
        'concepts': [
            'Does our group understand the concept of ultimate responsibility?',
            'How does our group practice the concept of delegation of authority?',
            'Are we providing adequate support to our GSR?',
            'Does our group participate in the Conference process?'
        ],
        'group-health': [
            'Are newcomers made to feel welcome?',
            'Is there regular attendance and participation?',
            'Are service positions filled regularly?',
            'Is there healthy rotation of service positions?',
            'Are we meeting our financial obligations?'
        ],
        'annual': [
            'How has our group grown this year?',
            'What challenges has our group faced?',
            'Are we fulfilling our primary purpose?',
            'What can we improve next year?'
        ]
    };
    const questions = templates[type] || [];
    let html = '<div class="box">';
    questions.forEach((q, i) => {
        html += `
            <div class="form-group">
                <label>${i + 1}. ${q}</label>
                <textarea id="inventory-q${i}" rows="2" placeholder="Group response..."></textarea>
            </div>
        `;
    });
    html += '</div>';
    container.innerHTML = html;
}
function exportInventoryResults() {
    const type = document.getElementById('inventory-type').value;
    if (!type) {
        showToast('Please select an inventory type first', 'error');
        return;
    }
    showToast('Inventory results exported', 'success');
}
function submitAnonymousFeedback() {
    const feedback = document.getElementById('anonymous-feedback-text').value.trim();
    if (!feedback) {
        showToast('Please enter feedback', 'error');
        return;
    }
    let feedbackList = JSON.parse(localStorage.getItem('anonymousFeedback') || '[]');
    feedbackList.push({
        id: Date.now().toString(),
        feedback,
        timestamp: new Date().toISOString()
    });
    localStorage.setItem('anonymousFeedback', JSON.stringify(feedbackList));
    document.getElementById('anonymous-feedback-text').value = '';
    loadAnonymousFeedback();
    showToast('Feedback submitted anonymously', 'success');
}
function loadAnonymousFeedback() {
    const feedbackList = JSON.parse(localStorage.getItem('anonymousFeedback') || '[]').reverse();
    const container = document.getElementById('anonymous-feedback-list');
    if (feedbackList.length === 0) {
        container.innerHTML = '<p>No feedback submitted yet</p>';
        return;
    }
    let html = '';
    feedbackList.forEach(f => {
        html += `
            <div class="box mb-2">
                <div style="font-size: 0.75rem; color: #95a5a6;">${new Date(f.timestamp).toLocaleDateString()}</div>
                <div>${DOMPurify.sanitize(f.feedback)}</div>
            </div>
        `;
    });
    container.innerHTML = html;
}
function handleByLawSubmit() {
    const title = document.getElementById('bylaw-title').value.trim();
    const version = document.getElementById('bylaw-version').value.trim();
    const content = document.getElementById('bylaw-content').value.trim();
    const notes = document.getElementById('bylaw-amendment-notes').value.trim();
    const date = document.getElementById('bylaw-effective-date').value;
    if (!title || !version || !content || !date) {
        showToast('Please fill all required fields', 'error');
        return;
    }
    let bylaws = JSON.parse(localStorage.getItem('groupByLaws') || '[]');
    const newByLaw = {
        id: Date.now().toString(),
        title,
        version,
        content,
        notes,
        effectiveDate: date,
        timestamp: new Date().toISOString()
    };
    bylaws.push(newByLaw);
    localStorage.setItem('groupByLaws', JSON.stringify(bylaws));
    showToast('Document saved successfully', 'success');
    loadByLawsHistory();
    loadCurrentByLaws();
    resetByLawForm();
}
function cancelByLawEdit() {
    resetByLawForm();
}
function resetByLawForm() {
    document.getElementById('bylaw-title').value = '';
    document.getElementById('bylaw-version').value = '';
    document.getElementById('bylaw-content').value = '';
    document.getElementById('bylaw-amendment-notes').value = '';
    document.getElementById('bylaw-effective-date').value = '';
    document.getElementById('bylaw-edit-id').value = '';
}
function loadByLawsHistory() {
    const bylaws = JSON.parse(localStorage.getItem('groupByLaws') || '[]').reverse();
    const tbody = document.getElementById('bylaws-history-body');
    tbody.innerHTML = '';
    bylaws.forEach(bylaw => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${DOMPurify.sanitize(bylaw.title)}</td>
            <td>${DOMPurify.sanitize(bylaw.version)}</td>
            <td>${new Date(bylaw.effectiveDate).toLocaleDateString()}</td>
            <td>
                <button class="btn secondary" data-action="view-bylaw" data-id="${escapeAttribute(bylaw.id)}" style="padding: 0.25rem 0.5rem; font-size: 0.85rem;">View</button>
            </td>
        `;
    });
}
function loadCurrentByLaws() {
    const bylaws = JSON.parse(localStorage.getItem('groupByLaws') || '[]');
    const container = document.getElementById('bylaws-current-list');
    const latest = {};
    bylaws.forEach(b => {
        if (!latest[b.title] || new Date(b.effectiveDate) > new Date(latest[b.title].effectiveDate)) {
            latest[b.title] = b;
        }
    });
    if (Object.keys(latest).length === 0) {
        container.innerHTML = '<p>No documents available</p>';
        return;
    }
    let html = '';
    Object.values(latest).forEach(b => {
        html += `
            <div class="box mb-2">
                <h4>${DOMPurify.sanitize(b.title)}</h4>
                <div style="font-size: 0.85rem; color: #95a5a6;">Version ${DOMPurify.sanitize(b.version)} - Effective ${new Date(b.effectiveDate).toLocaleDateString()}</div>
                <button class="btn secondary mt-2" data-action="view-bylaw" data-id="${escapeAttribute(b.id)}" style="padding: 0.25rem 0.5rem; font-size: 0.85rem;">View Full Document</button>
            </div>
        `;
    });
    container.innerHTML = html;
}
function viewByLaw(id) {
    const bylaws = JSON.parse(localStorage.getItem('groupByLaws') || '[]');
    const bylaw = bylaws.find(b => b.id === id);
    if (bylaw) {
        alert(`${bylaw.title}\nVersion: ${bylaw.version}\n\n${bylaw.content}`);
    }
}
function generateByLawPDF() {
    const selectId = document.getElementById('pdf-document-select').value;
    if (!selectId) {
        showToast('Please select a document to export', 'error');
        return;
    }
    const bylaws = JSON.parse(localStorage.getItem('groupByLaws') || '[]');
    const bylaw = bylaws.find(b => b.id === selectId);
    if (!bylaw) {
        showToast('Document not found', 'error');
        return;
    }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let yPos = 20;
    doc.setFontSize(18);
    doc.setFont(undefined, 'bold');
    doc.text(bylaw.title, doc.internal.pageSize.width / 2, yPos, { align: 'center' });
    yPos += 10;
    doc.setFontSize(12);
    doc.setFont(undefined, 'normal');
    doc.text(`Version ${bylaw.version}`, doc.internal.pageSize.width / 2, yPos, { align: 'center' });
    yPos += 6;
    doc.setFontSize(10);
    doc.text(`Effective Date: ${new Date(bylaw.effectiveDate).toLocaleDateString()}`, doc.internal.pageSize.width / 2, yPos, { align: 'center' });
    yPos += 15;
    doc.setFontSize(11);
    doc.setFont(undefined, 'normal');
    const paragraphs = bylaw.content.split('\n\n');
    paragraphs.forEach(paragraph => {
        if (yPos > 270) {
            doc.addPage();
            yPos = 20;
        }
        const lines = doc.splitTextToSize(paragraph.trim(), 180);
        doc.text(lines, 14, yPos);
        yPos += lines.length * 5 + 5; // Add spacing between paragraphs
    });
    if (bylaw.notes && bylaw.notes.trim()) {
        if (yPos > 240) {
            doc.addPage();
            yPos = 20;
        }
        yPos += 10;
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text('Amendment Notes:', 14, yPos);
        yPos += 7;
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        const notesLines = doc.splitTextToSize(bylaw.notes, 180);
        doc.text(notesLines, 14, yPos);
        yPos += notesLines.length * 5;
    }
    const pageCount = doc.internal.getNumberOfPages();
    doc.setFontSize(9);
    doc.setTextColor(100, 100, 100);
    for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, doc.internal.pageSize.height - 10);
        doc.text(`Page ${i} of ${pageCount}`, doc.internal.pageSize.width - 30, doc.internal.pageSize.height - 10);
    }
    const filename = `${bylaw.title.replace(/[^a-z0-9]/gi, '_')}_v${bylaw.version}.pdf`;
    doc.save(filename);
    showToast('Bylaws document exported to PDF successfully!', 'success');
}
function handleSponsorshipSubmit() {
    const sponsor = document.getElementById('sponsor-name').value;
    const sponsee = document.getElementById('sponsee-name').value;
    const type = document.getElementById('sponsorship-type').value;
    const startDate = document.getElementById('sponsorship-start-date').value;
    const currentStep = document.getElementById('current-step').value;
    if (!sponsor || !sponsee || !startDate) {
        showToast('Please fill all required fields', 'error');
        return;
    }
    let sponsorships = JSON.parse(localStorage.getItem('sponsorships') || '[]');
    const newSponsorship = {
        id: Date.now().toString(),
        sponsor,
        sponsee,
        type,
        startDate,
        currentStep: currentStep || null
    };
    sponsorships.push(newSponsorship);
    localStorage.setItem('sponsorships', JSON.stringify(sponsorships));
    showToast('Sponsorship relationship added', 'success');
    loadSponsorshipTable();
    loadSponsorshipTree();
    resetSponsorshipForm();
}
function cancelSponsorshipEdit() {
    resetSponsorshipForm();
}
function resetSponsorshipForm() {
    document.getElementById('sponsor-name').selectedIndex = 0;
    document.getElementById('sponsee-name').selectedIndex = 0;
    document.getElementById('sponsorship-type').selectedIndex = 0;
    document.getElementById('sponsorship-start-date').value = '';
    document.getElementById('current-step').selectedIndex = 0;
    document.getElementById('sponsorship-edit-id').value = '';
}
function loadSponsorshipTable() {
    const sponsorships = JSON.parse(localStorage.getItem('sponsorships') || '[]');
    const tbody = document.getElementById('sponsorship-body');
    tbody.innerHTML = '';
    sponsorships.forEach(s => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${DOMPurify.sanitize(s.sponsor)}</td>
            <td>${DOMPurify.sanitize(s.sponsee)}</td>
            <td>${s.type}</td>
            <td>${new Date(s.startDate).toLocaleDateString()}</td>
            <td>${s.currentStep ? 'Step ' + s.currentStep : 'N/A'}</td>
            <td>
                <button class="btn secondary" data-action="delete-sponsorship" data-id="${escapeAttribute(s.id)}" style="padding: 0.25rem 0.5rem; font-size: 0.85rem;">Delete</button>
            </td>
        `;
    });
}
function deleteSponsorship(id) {
    if (!confirm('Delete this sponsorship relationship?')) return;
    let sponsorships = JSON.parse(localStorage.getItem('sponsorships') || '[]');
    sponsorships = sponsorships.filter(s => s.id !== id);
    localStorage.setItem('sponsorships', JSON.stringify(sponsorships));
    loadSponsorshipTable();
    loadSponsorshipTree();
    showToast('Sponsorship relationship deleted', 'success');
}
function loadSponsorshipTree() {
    const container = document.getElementById('sponsorship-tree');
    container.innerHTML = '<p>Sponsorship tree visualization - Feature coming soon</p>';
}
function handleGSRReportSubmit() {
    const date = document.getElementById('gsr-report-date').value;
    const meetingType = document.getElementById('gsr-meeting-type').value;
    const content = document.getElementById('gsr-report-content').value.trim();
    const actionItems = document.getElementById('gsr-action-items').value.trim();
    if (!date || !content) {
        showToast('Please fill all required fields', 'error');
        return;
    }
    let reports = JSON.parse(localStorage.getItem('gsrReports') || '[]');
    reports.push({
        id: Date.now().toString(),
        date,
        meetingType,
        content,
        actionItems,
        timestamp: new Date().toISOString()
    });
    localStorage.setItem('gsrReports', JSON.stringify(reports));
    showToast('GSR report saved successfully', 'success');
    loadGSRReports();
    document.getElementById('gsr-report-date').value = '';
    document.getElementById('gsr-report-content').value = '';
    document.getElementById('gsr-action-items').value = '';
}
function cancelGSRReportEdit() {
    document.getElementById('gsr-report-date').value = '';
    document.getElementById('gsr-report-content').value = '';
    document.getElementById('gsr-action-items').value = '';
}
function loadGSRReports() {
    const reports = JSON.parse(localStorage.getItem('gsrReports') || '[]').reverse();
    const container = document.getElementById('gsr-reports-list');
    if (reports.length === 0) {
        container.innerHTML = '<p>No GSR reports yet</p>';
        return;
    }
    let html = '';
    reports.slice(0, 5).forEach(r => {
        html += `
            <div class="box mb-2">
                <div><strong>${new Date(r.date).toLocaleDateString()}</strong> - ${r.meetingType}</div>
                <div style="margin-top: 0.5rem;">${DOMPurify.sanitize(r.content)}</div>
                ${r.actionItems ? `<div style="margin-top: 0.5rem; color: #f39c12;"><strong>Action Items:</strong> ${DOMPurify.sanitize(r.actionItems)}</div>` : ''}
            </div>
        `;
    });
    container.innerHTML = html;
}
function addDistrictMeeting() {
    const date = document.getElementById('district-schedule-date').value;
    const time = document.getElementById('district-schedule-time').value;
    const location = document.getElementById('district-schedule-location').value;
    if (!date || !time || !location) {
        showToast('Please fill all fields', 'error');
        return;
    }
    let meetings = JSON.parse(localStorage.getItem('districtMeetings') || '[]');
    meetings.push({
        id: Date.now().toString(),
        date,
        time,
        location
    });
    localStorage.setItem('districtMeetings', JSON.stringify(meetings));
    showToast('Meeting added to schedule', 'success');
    loadDistrictMeetings();
    document.getElementById('district-schedule-date').value = '';
    document.getElementById('district-schedule-time').value = '';
    document.getElementById('district-schedule-location').value = '';
}
function loadDistrictMeetings() {
    const meetings = JSON.parse(localStorage.getItem('districtMeetings') || '[]')
        .filter(m => new Date(m.date) >= new Date())
        .sort((a, b) => new Date(a.date) - new Date(b.date));
    const container = document.getElementById('district-meetings-list');
    if (meetings.length === 0) {
        container.innerHTML = '<p>No upcoming meetings</p>';
        return;
    }
    let html = '<ul style="list-style: none; padding: 0;">';
    meetings.forEach(m => {
        html += `
            <li style="padding: 0.5rem; border-bottom: 1px solid #7f8c8d;">
                <strong>${new Date(m.date).toLocaleDateString()}</strong> at ${m.time}<br>
                Location: ${DOMPurify.sanitize(m.location)}
            </li>
        `;
    });
    html += '</ul>';
    container.innerHTML = html;
}
function addDCMCommunication() {
    const date = document.getElementById('dcm-comm-date').value;
    const content = document.getElementById('dcm-comm-content').value.trim();
    if (!date || !content) {
        showToast('Please fill all fields', 'error');
        return;
    }
    let communications = JSON.parse(localStorage.getItem('dcmCommunications') || '[]');
    communications.push({
        id: Date.now().toString(),
        date,
        content
    });
    localStorage.setItem('dcmCommunications', JSON.stringify(communications));
    showToast('Communication logged', 'success');
    loadDCMCommunications();
    document.getElementById('dcm-comm-date').value = '';
    document.getElementById('dcm-comm-content').value = '';
}
function loadDCMCommunications() {
    const communications = JSON.parse(localStorage.getItem('dcmCommunications') || '[]').reverse();
    const container = document.getElementById('dcm-comm-history');
    if (communications.length === 0) {
        container.innerHTML = '<p>No communications logged</p>';
        return;
    }
    let html = '';
    communications.slice(0, 5).forEach(c => {
        html += `
            <div class="box mb-2">
                <div><strong>${new Date(c.date).toLocaleDateString()}</strong></div>
                <div>${DOMPurify.sanitize(c.content)}</div>
            </div>
        `;
    });
    container.innerHTML = html;
}
function calculateReserveTarget() {
    const monthlyExpenses = parseFloat(document.getElementById('monthly-expenses').value) || 0;
    const months = parseInt(document.getElementById('reserve-months').value) || 3;
    const target = monthlyExpenses * months;
    document.getElementById('reserve-target').value = target.toFixed(2);
    showToast(`Reserve target calculated: $${target.toFixed(2)}`, 'success');
}
function saveReserveSettings() {
    const target = parseFloat(document.getElementById('reserve-target').value) || 0;
    const monthlyExpenses = parseFloat(document.getElementById('monthly-expenses').value) || 0;
    const months = parseInt(document.getElementById('reserve-months').value) || 3;
    localStorage.setItem('reserveTarget', target);
    localStorage.setItem('monthlyExpenses', monthlyExpenses);
    localStorage.setItem('reserveMonths', months);
    localStorage.setItem('reserveSettings', JSON.stringify({ target, monthlyExpenses, months }));
    showToast('Reserve settings saved', 'success');
    updateReserveStatus();
    updatePrudentReserveProgressBar(); // Quick Win #2
}
function updateReserveStatus() {
    const settings = JSON.parse(localStorage.getItem('reserveSettings') || '{}');
    document.getElementById('display-reserve-target').textContent = (settings.target || 0).toFixed(2);
    updatePrudentReserveProgressBar(); // Quick Win #2
}
function load7thTraditionPeriod(period) {
    showToast(`Loading ${period} view`, 'success');
}
function saveContributionGoal() {
    const goal = parseFloat(document.getElementById('contribution-goal').value) || 0;
    localStorage.setItem('contributionGoal', goal);
    showToast('Contribution goal saved', 'success');
}
function updateChipInventory() {
    const type = document.getElementById('chip-type').value;
    const quantity = parseInt(document.getElementById('chip-quantity').value) || 0;
    const threshold = parseInt(document.getElementById('chip-low-threshold').value) || 5;
    let inventory = JSON.parse(localStorage.getItem('chipInventory') || '{}');
    inventory[type] = { quantity, threshold };
    localStorage.setItem('chipInventory', JSON.stringify(inventory));
    showToast('Chip inventory updated', 'success');
    loadChipInventory();
    checkChipAlerts();
}
function loadChipInventory() {
    const inventory = JSON.parse(localStorage.getItem('chipInventory') || '{}');
    const tbody = document.getElementById('chip-inventory-body');
    tbody.innerHTML = '';
    const chipTypes = ['24-hour', '30-day', '60-day', '90-day', '6-month', '9-month', '1-year', '18-month', 'multi-year'];
    chipTypes.forEach(type => {
        const data = inventory[type] || { quantity: 0, threshold: 5 };
        const status = data.quantity <= data.threshold ? 'LOW STOCK' : 'OK';
        const statusColor = data.quantity <= data.threshold ? '#e74c3c' : '#2ecc71';
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${type}</td>
            <td>${data.quantity}</td>
            <td style="color: ${statusColor};">${status}</td>
            <td>${data.threshold}</td>
        `;
    });
}
function checkChipAlerts() {
    const inventory = JSON.parse(localStorage.getItem('chipInventory') || '{}');
    const container = document.getElementById('chip-alerts');
    const lowStock = Object.entries(inventory).filter(([type, data]) => data.quantity <= data.threshold);
    if (lowStock.length === 0) {
        container.innerHTML = '<p style="color: #2ecc71;">All chip levels are good</p>';
        return;
    }
    let html = '<ul style="list-style: none; padding: 0; color: #e74c3c;">';
    lowStock.forEach(([type, data]) => {
        html += `<li style="padding: 0.25rem;"><i class="fas fa-exclamation-triangle"></i> ${type}: ${data.quantity} remaining</li>`;
    });
    html += '</ul>';
    container.innerHTML = html;
}
function logChipDistribution() {
    const type = document.getElementById('dist-chip-type').value;
    const recipient = document.getElementById('dist-recipient').value.trim();
    const date = document.getElementById('dist-date').value;
    if (!date) {
        showToast('Please select a date', 'error');
        return;
    }
    let distributions = JSON.parse(localStorage.getItem('chipDistributions') || '[]');
    distributions.push({
        id: Date.now().toString(),
        type,
        recipient,
        date
    });
    localStorage.setItem('chipDistributions', JSON.stringify(distributions));
    let inventory = JSON.parse(localStorage.getItem('chipInventory') || '{}');
    if (inventory[type] && inventory[type].quantity > 0) {
        inventory[type].quantity--;
        localStorage.setItem('chipInventory', JSON.stringify(inventory));
        loadChipInventory();
        checkChipAlerts();
    }
    showToast('Chip distribution logged', 'success');
    loadChipDistributions();
    document.getElementById('dist-recipient').value = '';
    document.getElementById('dist-date').value = '';
}
function loadChipDistributions() {
    const distributions = JSON.parse(localStorage.getItem('chipDistributions') || '[]').reverse();
    const tbody = document.getElementById('chip-distribution-body');
    tbody.innerHTML = '';
    distributions.slice(0, 10).forEach(d => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${new Date(d.date).toLocaleDateString()}</td>
            <td>${d.type}</td>
            <td>${DOMPurify.sanitize(d.recipient) || 'Anonymous'}</td>
        `;
    });
}
function addLiveGCItem() {
    const item = document.getElementById('live-gc-new-item').value.trim();
    if (!item) {
        showToast('Please enter an item', 'error');
        return;
    }
    let queue = JSON.parse(localStorage.getItem('liveGCQueue') || '[]');
    queue.push({
        id: Date.now().toString(),
        item,
        status: 'pending',
        timestamp: new Date().toISOString()
    });
    localStorage.setItem('liveGCQueue', JSON.stringify(queue));
    showToast('Item added to queue', 'success');
    loadLiveGCQueue();
    document.getElementById('live-gc-new-item').value = '';
}
function loadLiveGCQueue() {
    const queue = JSON.parse(localStorage.getItem('liveGCQueue') || '[]');
    const tbody = document.getElementById('live-gc-queue-body');
    tbody.innerHTML = '';
    queue.forEach(item => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${DOMPurify.sanitize(item.item)}</td>
            <td>${item.status}</td>
            <td>
                <button class="btn secondary" data-action="update-gc-status" data-id="${escapeAttribute(item.id)}" data-status="discussed" style="padding: 0.25rem 0.5rem; font-size: 0.85rem;">Mark Discussed</button>
                <button class="btn secondary" data-action="remove-gc-item" data-id="${escapeAttribute(item.id)}" style="padding: 0.25rem 0.5rem; font-size: 0.85rem; margin-left: 0.25rem;">Remove</button>
            </td>
        `;
    });
}
function updateGCItemStatus(id, status) {
    let queue = JSON.parse(localStorage.getItem('liveGCQueue') || '[]');
    const item = queue.find(i => i.id === id);
    if (item) {
        item.status = status;
        localStorage.setItem('liveGCQueue', JSON.stringify(queue));
        loadLiveGCQueue();
        showToast('Status updated', 'success');
    }
}
function initiateEmergencyGC() {
    const confirmed = confirm('⚠️ EMERGENCY GC PROTOCOL ⚠️\n\nThis should only be used for crisis situations requiring immediate group conscience decision.\n\nExamples: Venue loss, safety concerns, financial crisis, legal issues.\n\nProceed with Emergency GC Protocol?');
    if (!confirmed) return;
    document.querySelectorAll('section').forEach(sec => sec.classList.remove('active'));
    document.getElementById('emergency-gc-section').classList.add('active');
    document.getElementById('emergency-gc-section').style.display = 'block';
    document.querySelectorAll('nav li').forEach(li => li.classList.remove('active'));
    const facilitatorSelect = document.getElementById('emergency-facilitator');
    facilitatorSelect.innerHTML = '<option value="">Select facilitator...</option>';
    const members = storage.getMembers();
    members.forEach(m => {
        const option = document.createElement('option');
        option.value = m.name;
        option.textContent = m.name;
        facilitatorSelect.appendChild(option);
    });
    const now = new Date();
    const dateTimeLocal = now.toISOString().slice(0, 16);
    document.getElementById('emergency-date').value = dateTimeLocal;
    loadEmergencyGCHistory();
    createSmartNotification(
        'Emergency GC Protocol Initiated',
        'An emergency group conscience protocol has been started. Check the Emergency GC section for details.',
        'urgent',
        'emergency-gc-section'
    );
    showToast('Emergency GC Protocol initiated', 'warning');
}
const emergencyProtocols = {
    'venue-loss': {
        title: 'Venue Loss / Location Crisis',
        checklist: [
            'Confirm venue is no longer available',
            'Document reason for venue loss',
            'Identify alternate meeting locations',
            'Check availability and cost of alternatives',
            'Confirm meeting schedule compatibility',
            'Notify all members of situation',
            'Arrange transportation/accessibility for new location',
            'Update meeting schedules (AA.org, local directories)',
            'Notify intergroup/central office of change'
        ]
    },
    'safety-concern': {
        title: 'Safety/Security Concern',
        checklist: [
            'Document the safety concern in detail',
            'Assess immediate threat level',
            'Contact appropriate authorities if needed',
            'Ensure member safety is prioritized',
            'Determine if meeting can continue safely',
            'Implement temporary safety measures',
            'Notify members of the situation',
            'Consult with area/district for guidance',
            'Document all actions taken'
        ]
    },
    'financial-crisis': {
        title: 'Financial Crisis',
        checklist: [
            'Document the financial emergency',
            'Review current balance and obligations',
            'Identify immediate financial needs',
            'Determine shortfall amount',
            'Review prudent reserve status',
            'Consider immediate cost reductions',
            'Notify treasurer and trusted servants',
            'Prepare emergency budget proposal',
            'Plan for special 7th tradition appeal if needed'
        ]
    },
    'member-conduct': {
        title: 'Serious Member Conduct Issue',
        checklist: [
            'Document the conduct issue objectively',
            'Review AA Tradition 1 (group welfare)',
            'Consult AA guidelines on disruptive behavior',
            'Consider safety of all members',
            'Determine if immediate action required',
            'Review group\'s existing conduct policies',
            'Consult with experienced members/sponsors',
            'Consider temporary measures if needed',
            'Plan for fair group conscience process'
        ]
    },
    'legal-issue': {
        title: 'Legal/Liability Issue',
        checklist: [
            'Document the legal issue in detail',
            'Determine if immediate legal counsel needed',
            'Contact AA General Service Office if appropriate',
            'Notify group insurance provider if applicable',
            'Preserve all relevant documentation',
            'Do not admit fault or make statements',
            'Consult with district/area for guidance',
            'Consider group\'s liability coverage',
            'Follow AA\'s suggested legal protocols'
        ]
    },
    'service-disruption': {
        title: 'Critical Service Disruption',
        checklist: [
            'Identify which critical service is disrupted',
            'Assess impact on group function',
            'Determine cause of disruption',
            'Identify immediate alternatives',
            'Notify affected members',
            'Implement temporary solutions',
            'Contact service providers if applicable',
            'Document disruption timeline',
            'Plan for service restoration'
        ]
    },
    'other': {
        title: 'Other Emergency',
        checklist: [
            'Clearly define the emergency situation',
            'Assess urgency and impact',
            'Determine why regular GC process won\'t work',
            'Identify immediate actions needed',
            'Consider member safety first',
            'Review relevant AA traditions and concepts',
            'Consult with experienced members if time allows',
            'Document all circumstances',
            'Plan for regular GC review of decision'
        ]
    }
};
function loadEmergencyProtocol(type) {
    if (!type) {
        document.getElementById('emergency-protocol-container').style.display = 'none';
        return;
    }
    const protocol = emergencyProtocols[type];
    if (!protocol) return;
    document.getElementById('emergency-protocol-container').style.display = 'block';
    const checklistDiv = document.getElementById('emergency-checklist');
    checklistDiv.innerHTML = `
        <h4 style="color: #f39c12; margin-bottom: 1rem;">${protocol.title}</h4>
        <div style="background: #2c3e50; padding: 1rem; border-radius: 4px;">
            ${protocol.checklist.map((item, idx) => `
                <div style="display: flex; align-items: start; gap: 0.75rem; padding: 0.5rem; margin-bottom: 0.5rem; background: #34495e; border-radius: 4px;">
                    <input type="checkbox" id="checklist-${idx}" style="margin-top: 0.25rem; width: 18px; height: 18px; cursor: pointer;">
                    <label for="checklist-${idx}" style="flex: 1; cursor: pointer; user-select: none;">${escapeHtml(item)}</label>
                </div>
            `).join('')}
        </div>
    `;
    document.getElementById('emergency-protocol-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
}
function submitEmergencyGC() {
    const facilitator = document.getElementById('emergency-facilitator').value;
    const date = document.getElementById('emergency-date').value;
    const situation = document.getElementById('emergency-situation').value.trim();
    const decision = document.getElementById('emergency-decision').value.trim();
    const rationale = document.getElementById('emergency-rationale').value.trim();
    const type = document.getElementById('emergency-type').value;
    const notificationMethod = document.getElementById('emergency-notification-method').value;
    if (!facilitator || !date || !situation || !decision || !rationale || !type) {
        showToast('Please fill in all required fields (*)', 'error');
        return;
    }
    const votesFor = parseInt(document.getElementById('emergency-votes-for').value) || 0;
    const votesAgainst = parseInt(document.getElementById('emergency-votes-against').value) || 0;
    const votesAbstain = parseInt(document.getElementById('emergency-votes-abstain').value) || 0;
    const totalVotes = votesFor + votesAgainst;
    if (totalVotes === 0) {
        if (!confirm('No votes recorded. Continue anyway?')) return;
    }
    let outcome = 'unknown';
    if (totalVotes > 0) {
        const percentFor = (votesFor / totalVotes) * 100;
        outcome = percentFor >= 66.7 ? 'passed' : 'failed';
    }
    const membersReached = parseInt(document.getElementById('emergency-members-reached').value) || 0;
    const quorumMet = document.getElementById('emergency-quorum-met').value;
    const followUp = document.getElementById('emergency-follow-up').value.trim();
    const emergencyGC = {
        id: genId(),
        type: 'emergency',
        emergencyType: type,
        facilitator,
        date,
        situation,
        decision,
        rationale,
        notificationMethod,
        membersReached,
        quorumMet,
        votesFor,
        votesAgainst,
        votesAbstain,
        outcome,
        followUp,
        requiresRatification: true,
        ratified: false,
        submittedDate: new Date().toISOString()
    };
    let emergencyGCs = JSON.parse(localStorage.getItem('emergencyGCs') || '[]');
    emergencyGCs.unshift(emergencyGC);
    localStorage.setItem('emergencyGCs', JSON.stringify(emergencyGCs));
    const gcLog = storage.getGroupConscienceLog();
    gcLog.unshift({
        id: emergencyGC.id,
        date: emergencyGC.date,
        item: `[EMERGENCY] ${emergencyGC.decision}`,
        outcome: emergencyGC.outcome,
        votesFor,
        votesAgainst,
        votesAbstain,
        discussionNotes: `EMERGENCY GC PROTOCOL - ${protocol.title}\n\nSituation: ${situation}\n\nRationale: ${rationale}\n\nNotification: ${notificationMethod}\nMembers Reached: ${membersReached}\nQuorum: ${quorumMet}\n\nFollow-up: ${followUp || 'None specified'}`,
        submittedBy: facilitator,
        isEmergency: true,
        emergencyType: type
    });
    storage.saveGroupConscienceLog(gcLog);
    addAuditLog('CREATE', 'emergency-gc', emergencyGC.id, facilitator, null,
        `Emergency GC: ${type} - ${decision.substring(0, 50)}`, rationale);
    createSmartNotification(
        `Emergency GC Decision: ${outcome.toUpperCase()}`,
        `Emergency decision regarding ${type.replace('-', ' ')}. Decision: ${decision.substring(0, 100)}... Requires ratification at next regular GC.`,
        'urgent',
        'emergency-gc-section'
    );
    const actions = storage.getGCActionItems();
    const nextGCDate = new Date();
    nextGCDate.setDate(nextGCDate.getDate() + 30); // 30 days from now
    actions.push({
        id: genId(),
        description: `Ratify Emergency GC Decision: ${decision.substring(0, 60)}`,
        assignee: facilitator,
        dueDate: nextGCDate.toISOString().split('T')[0],
        priority: 'high',
        relatedGCId: emergencyGC.id,
        dependencies: [],
        status: 'pending',
        progress: 0,
        createdDate: new Date().toISOString().split('T')[0],
        completedDate: null,
        updates: [],
        reminders: {
            sent7Days: false,
            sent3Days: false,
            sent1Day: false,
            sentOverdue: false
        }
    });
    storage.saveGCActionItems(actions);
    showToast('Emergency GC logged successfully. Auto-created ratification action item.', 'success');
    cancelEmergencyGC();
    loadEmergencyGCHistory();
}
function cancelEmergencyGC() {
    document.getElementById('emergency-type').value = '';
    document.getElementById('emergency-facilitator').value = '';
    document.getElementById('emergency-date').value = '';
    document.getElementById('emergency-situation').value = '';
    document.getElementById('emergency-decision').value = '';
    document.getElementById('emergency-rationale').value = '';
    document.getElementById('emergency-notification-method').value = 'phone-tree';
    document.getElementById('emergency-members-reached').value = '';
    document.getElementById('emergency-quorum-met').value = 'yes';
    document.getElementById('emergency-votes-for').value = '0';
    document.getElementById('emergency-votes-against').value = '0';
    document.getElementById('emergency-votes-abstain').value = '0';
    document.getElementById('emergency-follow-up').value = '';
    document.getElementById('emergency-vote-result').textContent = 'Enter votes to see result';
    document.getElementById('emergency-protocol-container').style.display = 'none';
    goToSection('home-section');
}
function loadEmergencyGCHistory() {
    const emergencyGCs = JSON.parse(localStorage.getItem('emergencyGCs') || '[]');
    const container = document.getElementById('emergency-gc-history');
    if (emergencyGCs.length === 0) {
        container.innerHTML = '<p style="text-align: center; padding: 2rem; opacity: 0.7;">No emergency GCs recorded</p>';
        return;
    }
    container.innerHTML = emergencyGCs.slice(0, 10).map(egc => {
        const outcomeColor = egc.outcome === 'passed' ? '#2ecc71' : egc.outcome === 'failed' ? '#e74c3c' : '#f39c12';
        const protocol = emergencyProtocols[egc.emergencyType];
        return `
            <div style="background: #2c3e50; padding: 1rem; border-radius: 4px; margin-bottom: 0.75rem; border-left: 4px solid ${outcomeColor};">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <div style="font-weight: bold; color: #e74c3c; margin-bottom: 0.5rem;">
                            <i class="fas fa-exclamation-triangle"></i> ${escapeHtml(protocol ? protocol.title : egc.emergencyType)}
                        </div>
                        <div style="font-size: 0.95rem; margin-bottom: 0.5rem;">${escapeHtml(egc.decision)}</div>
                        <div style="font-size: 0.85rem; opacity: 0.8;">
                            <div><strong>Date:</strong> ${new Date(egc.date).toLocaleString()}</div>
                            <div><strong>Facilitator:</strong> ${escapeHtml(egc.facilitator)}</div>
                            <div><strong>Votes:</strong> For=${egc.votesFor}, Against=${egc.votesAgainst}, Abstain=${egc.votesAbstain}</div>
                            <div><strong>Outcome:</strong> <span style="color: ${outcomeColor}; font-weight: bold;">${egc.outcome.toUpperCase()}</span></div>
                            ${egc.requiresRatification && !egc.ratified ? '<div style="color: #f39c12; margin-top: 0.5rem;"><i class="fas fa-hourglass-half"></i> Awaiting ratification at next regular GC</div>' : ''}
                            ${egc.ratified ? '<div style="color: #2ecc71; margin-top: 0.5rem;"><i class="fas fa-check-circle"></i> Ratified</div>' : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}
document.addEventListener('DOMContentLoaded', function() {
    const voteInputs = ['emergency-votes-for', 'emergency-votes-against', 'emergency-votes-abstain'];
    voteInputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
            input.addEventListener('input', calculateEmergencyVoteResult);
        }
    });
});
function calculateEmergencyVoteResult() {
    const votesFor = parseInt(document.getElementById('emergency-votes-for').value) || 0;
    const votesAgainst = parseInt(document.getElementById('emergency-votes-against').value) || 0;
    const totalVotes = votesFor + votesAgainst;
    const resultDiv = document.getElementById('emergency-vote-result');
    if (totalVotes === 0) {
        resultDiv.textContent = 'Enter votes to see result';
        resultDiv.style.background = '#34495e';
        resultDiv.style.color = '#ecf0f1';
        return;
    }
    const percentFor = (votesFor / totalVotes) * 100;
    const passed = percentFor >= 66.7; // Substantial unanimity
    resultDiv.textContent = passed ? '✓ MOTION PASSED' : '✗ MOTION FAILED';
    resultDiv.style.background = passed ? '#2ecc71' : '#e74c3c';
    resultDiv.style.color = 'white';
    resultDiv.innerHTML = `
        ${passed ? '✓ MOTION PASSED' : '✗ MOTION FAILED'}<br>
        <span style="font-size: 0.9rem;">${percentFor.toFixed(1)}% in favor (${votesFor}/${totalVotes})</span>
    `;
}
function removeGCItem(id) {
    let queue = JSON.parse(localStorage.getItem('liveGCQueue') || '[]');
    queue = queue.filter(i => i.id !== id);
    localStorage.setItem('liveGCQueue', JSON.stringify(queue));
    loadLiveGCQueue();
    showToast('Item removed', 'success');
}
function initNewSections() {
    const members = JSON.parse(localStorage.getItem('members') || '[]');
    const memberSelects = [
        'commitment-member',
        'sponsor-name',
        'sponsee-name',
        'attendance-members'
    ];
    memberSelects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select) {
            select.innerHTML = '<option value="">-- Select Member --</option>';
            members.forEach(m => {
                const option = document.createElement('option');
                option.value = m.name;
                option.textContent = m.name;
                select.appendChild(option);
            });
        }
    });
    if (document.getElementById('format-rotation-section')) {
        loadFormatRotationTable();
        loadUpcomingFormats();
        updateCurrentWeekFormat();
    }
    if (document.getElementById('commitment-board-section')) {
        loadCommitmentTable();
        loadCurrentWeekCommitments();
    }
    if (document.getElementById('secretary-section')) {
        loadAttendanceHistory();
        updateAttendanceStats();
    }
    if (document.getElementById('gc-decisions-section')) {
        const gcLog = JSON.parse(localStorage.getItem('gcLog') || '[]');
        displayGCDecisions(gcLog);
        const years = [...new Set(gcLog.map(d => new Date(d.date).getFullYear()))];
        const yearSelect = document.getElementById('gc-filter-year');
        if (yearSelect) {
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            });
        }
        const linkSelects = ['gc-link-primary', 'gc-link-related'];
        linkSelects.forEach(selectId => {
            const select = document.getElementById(selectId);
            if (select) {
                select.innerHTML = '<option value="">-- Select Motion --</option>';
                gcLog.forEach(d => {
                    const option = document.createElement('option');
                    option.value = d.id;
                    option.textContent = `${new Date(d.date).toLocaleDateString()} - ${d.item.substring(0, 50)}...`;
                    select.appendChild(option);
                });
            }
        });
    }
    if (document.getElementById('gc-inventory-section')) {
        loadAnonymousFeedback();
    }
    if (document.getElementById('gc-bylaws-section')) {
        loadByLawsHistory();
        loadCurrentByLaws();
    }
    if (document.getElementById('sponsorship-section')) {
        loadSponsorshipTable();
        loadSponsorshipTree();
    }
    if (document.getElementById('district-area-section')) {
        loadGSRReports();
        loadDistrictMeetings();
        loadDCMCommunications();
    }
    if (document.getElementById('prudent-reserve-section')) {
        updateReserveStatus();
    }
    if (document.getElementById('chip-inventory-section')) {
        loadChipInventory();
        checkChipAlerts();
        loadChipDistributions();
    }
    if (document.getElementById('gc-live-section')) {
        loadLiveGCQueue();
    }
    const sponsorshipType = document.getElementById('sponsorship-type');
    if (sponsorshipType) {
        sponsorshipType.addEventListener('change', function() {
            const stepGroup = document.getElementById('step-progress-group');
            if (stepGroup) {
                stepGroup.style.display = this.value === 'program' ? 'block' : 'none';
            }
        });
    }
    requestNotificationPermission();
    checkUpcomingReminders();
}
function sendNotification(title, body, icon = null) {
    if ('Notification' in window && Notification.permission === 'granted') {
        const options = {
            body: body,
            icon: icon || 'logo.svg',
            badge: 'logo.svg',
            vibrate: [200, 100, 200],
            tag: 'rowlett-group-notification'
        };
        const notification = new Notification(title, options);
        notification.onclick = function() {
            window.focus();
            notification.close();
        };
    }
}
let reminderTimeoutId = null;
function checkUpcomingReminders() {
    try {
        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        let events = [];
        try {
            events = JSON.parse(localStorage.getItem('events') || '[]');
        } catch(e) {
            console.error('Error parsing events for reminders:', e);
        }
        const upcomingEvents = events.filter(e => {
            if (!e.date) return false;
            const eventDate = new Date(e.date);
            return eventDate.toDateString() === tomorrow.toDateString();
        });
        if (upcomingEvents.length > 0) {
            upcomingEvents.forEach(event => {
                sendNotification('Upcoming Meeting Tomorrow', event.title + ' at ' + event.time);
            });
        }
        const weekAhead = new Date(today);
        weekAhead.setDate(weekAhead.getDate() + 7);
        let members = [];
        try {
            members = JSON.parse(localStorage.getItem('members') || '[]');
        } catch(e) {
            console.error('Error parsing members for reminders:', e);
        }
        members.forEach(member => {
            if (member.birthday) {
                const birthday = new Date(member.birthday);
                birthday.setFullYear(today.getFullYear());
                if (birthday.toDateString() === weekAhead.toDateString()) {
                    sendNotification('Upcoming Birthday', member.name + '\'s birthday is in one week!');
                }
            }
        });
        const twoDaysAhead = new Date(today);
        twoDaysAhead.setDate(twoDaysAhead.getDate() + 2);
        let commitments = [];
        try {
            commitments = JSON.parse(localStorage.getItem('meetingCommitments') || '[]');
        } catch(e) {
            console.error('Error parsing commitments for reminders:', e);
        }
        const upcomingCommitments = commitments.filter(c => {
            if (!c.date) return false;
            const commitDate = new Date(c.date);
            return c.reminder && commitDate.toDateString() === twoDaysAhead.toDateString();
        });
        upcomingCommitments.forEach(commitment => {
            sendNotification('Meeting Commitment Reminder',
                'You are signed up for ' + commitment.role + ' in 2 days on ' + new Date(commitment.date).toLocaleDateString());
        });
        if (reminderTimeoutId) {
            clearTimeout(reminderTimeoutId);
        }
        reminderTimeoutId = setTimeout(checkUpcomingReminders, 60 * 60 * 1000);
    } catch(e) {
        console.error('Error in checkUpcomingReminders:', e);
    }
}
function stopReminderChecks() {
    if (reminderTimeoutId) {
        clearTimeout(reminderTimeoutId);
        reminderTimeoutId = null;
    }
}
function injectPWAManifest() {
    const manifest = {
        "name": "HomeGroup - AA Home Group Management Portal",
        "short_name": "HomeGroup",
        "description": "Complete Home Group management portal for AA groups",
        "start_url": "./index.html",
        "display": "standalone",
        "background_color": "#2c3e50",
        "theme_color": "#3498db",
        "orientation": "any",
        "icons": [
            {
                "src": "logo.svg",
                "sizes": "any",
                "type": "image/svg+xml",
                "purpose": "any maskable"
            }
        ],
        "categories": ["productivity", "lifestyle"],
        "screenshots": []
    };
    const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
    const manifestURL = URL.createObjectURL(manifestBlob);
    const link = document.createElement('link');
    link.rel = 'manifest';
    link.href = manifestURL;
    document.head.appendChild(link);
    setTimeout(() => {
        URL.revokeObjectURL(manifestURL);
    }, 100);
}
function updateVotingMethodDisplay() {
    const method = document.getElementById('voting-method').value;
    const customGroup = document.getElementById('custom-threshold-group');
    if (method === 'custom') {
        customGroup.style.display = 'block';
    } else {
        customGroup.style.display = 'none';
    }
}
function saveVotingSettings() {
    const method = document.getElementById('voting-method').value;
    const allowAbstain = document.getElementById('allow-abstain').checked;
    let threshold = 66.67;
    switch(method) {
        case 'substantialUnanimity':
            threshold = 66.67;
            break;
        case 'simpleMajority':
            threshold = 50.01;
            break;
        case 'unanimousConsent':
            threshold = 100;
            break;
        case 'senseOfMeeting':
            threshold = 0; // No specific threshold for consensus
            break;
        case 'custom':
            threshold = parseFloat(document.getElementById('custom-threshold').value) || 66.67;
            break;
    }
    storage.saveVotingSettings({ method, threshold, allowAbstain });
    showToast('Voting settings saved!', 'success');
    loadVotingSettings();
}
function loadVotingSettings() {
    const settings = storage.getVotingSettings();
    document.getElementById('voting-method').value = settings.method;
    document.getElementById('allow-abstain').checked = settings.allowAbstain;
    document.getElementById('custom-threshold').value = settings.threshold;
    updateVotingMethodDisplay();
    const methodNames = {
        substantialUnanimity: 'Substantial Unanimity',
        simpleMajority: 'Simple Majority',
        unanimousConsent: 'Unanimous Consent',
        senseOfMeeting: 'Sense of the Meeting',
        custom: 'Custom Threshold'
    };
    const methodDescs = {
        substantialUnanimity: 'Requires 2/3 majority (66.67%)',
        simpleMajority: 'Requires 50% + 1',
        unanimousConsent: 'Requires 100% agreement',
        senseOfMeeting: 'Informal consensus',
        custom: `Requires ${settings.threshold}%`
    };
    document.getElementById('current-method-name').textContent = methodNames[settings.method] || 'Substantial Unanimity';
    document.getElementById('current-method-desc').textContent = methodDescs[settings.method] || 'Requires 2/3 majority (66.67%)';
}
function checkVotePasses(votesFor, votesAgainst, votesAbstain) {
    const settings = storage.getVotingSettings();
    if (settings.method === 'senseOfMeeting') {
        return { passes: true, type: 'consensus' };
    }
    const totalVotes = settings.allowAbstain
        ? votesFor + votesAgainst
        : votesFor + votesAgainst + votesAbstain;
    if (totalVotes === 0) return { passes: false, type: 'no-votes' };
    const percentage = (votesFor / totalVotes) * 100;
    const passes = percentage >= settings.threshold;
    return { passes, percentage: percentage.toFixed(2), threshold: settings.threshold };
}
function saveMotionTemplate() {
    const editId = document.getElementById('template-edit-id').value;
    if (editId) {
        updateMotionTemplate();
        return;
    }
    const name = document.getElementById('template-name').value.trim();
    const category = document.getElementById('template-category').value;
    const template = document.getElementById('template-text').value.trim();
    if (!name || !template) {
        showToast('Please provide template name and text', 'error');
        return;
    }
    const templates = storage.getMotionTemplates();
    templates.push({
        id: genId(),
        name,
        category,
        template,
        createdDate: new Date().toISOString()
    });
    storage.saveMotionTemplates(templates);
    showToast('Template saved!', 'success');
    document.getElementById('template-name').value = '';
    document.getElementById('template-text').value = '';
    renderMotionTemplates();
}
function renderMotionTemplates() {
    const templates = storage.getMotionTemplates();
    const filter = document.getElementById('template-filter-category').value;
    const filtered = filter === 'all' ? templates : templates.filter(t => t.category === filter);
    const list = document.getElementById('motion-templates-list');
    if (filtered.length === 0) {
        list.innerHTML = '<p style="opacity: 0.7;">No templates found.</p>';
        return;
    }
    list.innerHTML = filtered.map(t => `
        <div style="padding: 1rem; margin-bottom: 0.5rem; background: #2c3e50; border-radius: 4px; border-left: 4px solid #3498db;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div style="flex: 1;">
                    <strong style="color: #3498db;">${escapeHtml(t.name)}</strong>
                    <span style="background: #34495e; padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.75rem; margin-left: 0.5rem;">${escapeHtml(t.category)}</span>
                    <p style="margin-top: 0.5rem; font-size: 0.9rem; opacity: 0.9;">${escapeHtml(t.template)}</p>
                </div>
                <div style="display: flex; gap: 0.5rem; margin-left: 1rem;">
                    <button class="btn secondary" data-action="use-template" data-id="${escapeAttribute(t.id)}" style="font-size: 0.85rem;">Use</button>
                    <button class="btn secondary" data-action="edit-template" data-id="${escapeAttribute(t.id)}" style="font-size: 0.85rem;">Edit</button>
                    <button class="btn secondary" data-action="delete-template" data-id="${escapeAttribute(t.id)}" style="font-size: 0.85rem; background: #e74c3c;">Delete</button>
                </div>
            </div>
        </div>
    `).join('');
}
function useMotionTemplate(id) {
    const templates = storage.getMotionTemplates();
    const template = templates.find(t => t.id === id);
    if (!template) return;
    const gcItemField = document.getElementById('gc-item');
    if (gcItemField) {
        gcItemField.value = template.template;
        showToast('Template loaded into motion field!', 'success');
        goToSection('chairperson-section');
    } else {
        navigator.clipboard.writeText(template.template).then(() => {
            showToast('Template copied to clipboard!', 'success');
        });
    }
}
function editMotionTemplate(id) {
    const templates = storage.getMotionTemplates();
    const template = templates.find(t => t.id === id);
    if (!template) return;
    document.getElementById('template-edit-id').value = template.id;
    document.getElementById('template-name').value = template.name;
    document.getElementById('template-category').value = template.category;
    document.getElementById('template-text').value = template.template;
    document.getElementById('template-form-btn').textContent = 'Update Template';
    document.getElementById('template-form-cancel-btn').style.display = 'inline-block';
}
function updateMotionTemplate() {
    const id = document.getElementById('template-edit-id').value;
    const name = document.getElementById('template-name').value.trim();
    const category = document.getElementById('template-category').value;
    const template = document.getElementById('template-text').value.trim();
    if (!name || !template) {
        showToast('Please provide template name and text', 'error');
        return;
    }
    let templates = storage.getMotionTemplates();
    const index = templates.findIndex(t => t.id === id);
    if (index > -1) {
        templates[index] = { ...templates[index], name, category, template };
        storage.saveMotionTemplates(templates);
        showToast('Template updated!', 'success');
        cancelTemplateEdit();
        renderMotionTemplates();
    }
}
function cancelTemplateEdit() {
    document.getElementById('template-edit-id').value = '';
    document.getElementById('template-name').value = '';
    document.getElementById('template-text').value = '';
    document.getElementById('template-form-btn').textContent = 'Add Template';
    document.getElementById('template-form-cancel-btn').style.display = 'none';
}
function deleteMotionTemplate(id) {
    if (!confirm('Delete this template?')) return;
    let templates = storage.getMotionTemplates();
    templates = templates.filter(t => t.id !== id);
    storage.saveMotionTemplates(templates);
    showToast('Template deleted', 'info');
    renderMotionTemplates();
}
function checkTraditionsAndConcepts() {
    const motionText = document.getElementById('check-motion-text').value.trim().toLowerCase();
    if (!motionText) {
        showToast('Please enter a motion to check', 'error');
        return;
    }
    const warnings = [];
    const relevantTraditions = [];
    const relevantConcepts = [];
    const questions = [];
    const traditionChecks = [
        { tradition: 1, keywords: ['outside', 'non-aa', 'affiliate', 'merge'], warning: 'May affect group autonomy or unity', questions: ['Does this keep our group focused on AA\'s primary purpose?'] },
        { tradition: 2, keywords: ['leader', 'boss', 'control', 'authority'], warning: 'May create authority issues', questions: ['Are we empowering a trusted servant or creating a leader?'] },
        { tradition: 3, keywords: ['require', 'must be', 'mandatory'], warning: 'May restrict membership', questions: ['Is our only requirement a desire to stop drinking?'] },
        { tradition: 4, keywords: ['interfere', 'tell', 'dictate'], warning: 'May affect group autonomy', questions: ['Does this interfere with other groups?'] },
        { tradition: 5, keywords: ['purpose', 'mission', 'goal'], warning: 'Check alignment with primary purpose', questions: ['Does this help us carry the message to the alcoholic who still suffers?'] },
        { tradition: 6, keywords: ['endorse', 'sponsor', 'partner', 'facility', 'property'], warning: 'Possible outside issue or endorsement', questions: ['Are we lending the AA name to any outside enterprise?'] },
        { tradition: 7, keywords: ['donation', 'contribution', 'outside', 'fund'], warning: 'Self-support concern', questions: ['Are we remaining self-supporting?', 'Are we accepting contributions from non-members?'] },
        { tradition: 8, keywords: ['pay', 'salary', 'hire', 'employee'], warning: 'Professional vs. non-professional distinction', questions: ['Should this remain non-professional or require special workers?'] },
        { tradition: 9, keywords: ['organization', 'structure', 'board'], warning: 'Check organization complexity', questions: ['Are we creating unnecessary organization?'] },
        { tradition: 10, keywords: ['opinion', 'position', 'stance', 'political'], warning: 'Possible outside controversy', questions: ['Does this involve AA in public controversy?'] },
        { tradition: 11, keywords: ['publicity', 'promote', 'advertise', 'media'], warning: 'Attraction vs. promotion', questions: ['Are we practicing attraction rather than promotion?'] },
        { tradition: 12, keywords: ['name', 'credit', 'recognition', 'fame'], warning: 'Anonymity concern', questions: ['Are we placing principles before personalities?'] }
    ];
    traditionChecks.forEach(check => {
        if (check.keywords.some(kw => motionText.includes(kw))) {
            relevantTraditions.push({ num: check.tradition, warning: check.warning });
            questions.push(...check.questions);
        }
    });
    if (motionText.includes('servant') || motionText.includes('service') || motionText.includes('position')) {
        relevantConcepts.push({ num: 1, text: 'Final responsibility and ultimate authority for AA world services should always reside in the collective conscience of our whole Fellowship.' });
        relevantConcepts.push({ num: 9, text: 'Good service leadership at all levels is indispensable for our future functioning and safety.' });
    }
    if (motionText.includes('money') || motionText.includes('budget') || motionText.includes('financial')) {
        relevantConcepts.push({ num: 8, text: 'The trustees are the principal planners and administrators of overall policy and finance.' });
    }
    questions.push('Does this promote unity within our group?');
    questions.push('Is this decision made in the spirit of love and service?');
    questions.push('Have we sought guidance through group discussion and prayer?');
    document.getElementById('tradition-check-results').style.display = 'block';
    const warningsEl = document.getElementById('tradition-warnings');
    if (relevantTraditions.length > 0) {
        warningsEl.innerHTML = relevantTraditions.map(t => `
            <div style="padding: 0.75rem; background: #2c3e50; border-radius: 4px; margin-bottom: 0.5rem;">
                <strong style="color: #f39c12;">Tradition ${t.num}:</strong> ${escapeHtml(t.warning)}
            </div>
        `).join('');
    } else {
        warningsEl.innerHTML = '<p style="color: #2ecc71;">No obvious tradition concerns detected.</p>';
    }
    const traditionsEl = document.getElementById('relevant-traditions');
    traditionsEl.innerHTML = `
        <p style="font-size: 0.9rem; margin-bottom: 0.5rem;">Consider reviewing these traditions:</p>
        ${relevantTraditions.length > 0 ? relevantTraditions.map(t => `<div style="padding: 0.5rem; background: #2c3e50; border-radius: 4px; margin-bottom: 0.25rem;">Tradition ${t.num}</div>`).join('') : '<p style="opacity: 0.7;">All 12 Traditions are always relevant to group decisions.</p>'}
    `;
    const conceptsEl = document.getElementById('relevant-concepts');
    if (relevantConcepts.length > 0) {
        conceptsEl.innerHTML = relevantConcepts.map(c => `
            <div style="padding: 0.75rem; background: #2c3e50; border-radius: 4px; margin-bottom: 0.5rem;">
                <strong style="color: #9b59b6;">Concept ${c.num}:</strong> ${escapeHtml(c.text)}
            </div>
        `).join('');
    } else {
        conceptsEl.innerHTML = '<p style="opacity: 0.7;">Review the 12 Concepts for World Service as needed.</p>';
    }
    const questionsEl = document.getElementById('guided-questions');
    questionsEl.innerHTML = [...new Set(questions)].map(q => `
        <div style="padding: 0.5rem 0.5rem 0.5rem 1.5rem; margin-bottom: 0.25rem; position: relative;">
            <span style="position: absolute; left: 0.5rem; color: #2ecc71;">•</span>
            ${escapeHtml(q)}
        </div>
    `).join('');
    const checks = storage.getTraditionChecks();
    checks.push({
        id: genId(),
        motionText: document.getElementById('check-motion-text').value,
        timestamp: new Date().toISOString(),
        warnings: relevantTraditions
    });
    storage.saveTraditionChecks(checks);
}
function showTraditionsReference() {
    alert('View the 12 Traditions in the Literature Inventory section or visit aa.org');
}
function showConceptsReference() {
    alert('View the 12 Concepts in the Literature Inventory section or visit aa.org');
}
let currentWorkflowStep = 0;
let speakerTimerInterval = null;
let speakerTimeRemaining = 180; // 3 minutes default
function advanceMotionWorkflow() {
    currentWorkflowStep = (currentWorkflowStep + 1) % 4;
    updateWorkflowDisplay();
}
function resetMotionWorkflow() {
    currentWorkflowStep = 0;
    updateWorkflowDisplay();
}
function updateWorkflowDisplay() {
    const steps = ['step-motion', 'step-second', 'step-discussion', 'step-vote'];
    steps.forEach((step, idx) => {
        const el = document.getElementById(step);
        if (idx === currentWorkflowStep) {
            el.style.background = '#3498db';
            el.style.color = '#fff';
        } else if (idx < currentWorkflowStep) {
            el.style.background = '#27ae60';
            el.style.color = '#fff';
        } else {
            el.style.background = '#34495e';
            el.style.color = '#ecf0f1';
        }
    });
    if (currentWorkflowStep === 2) {
        document.getElementById('discussion-timer-display').style.display = 'block';
    }
}
function addToSpeakingQueue() {
    const speakerName = document.getElementById('speaker-name').value;
    if (!speakerName) {
        showToast('Please select a member', 'error');
        return;
    }
    const queue = storage.getSpeakingQueue();
    queue.push({
        id: genId(),
        name: speakerName,
        timestamp: new Date().toISOString(),
        status: 'waiting'
    });
    storage.saveSpeakingQueue(queue);
    renderSpeakingQueue();
    document.getElementById('speaker-name').value = '';
}
function renderSpeakingQueue() {
    const queue = storage.getSpeakingQueue().filter(s => s.status !== 'done');
    const list = document.getElementById('speaking-queue-list');
    if (queue.length === 0) {
        list.innerHTML = '<p style="opacity: 0.7; text-align: center; padding: 2rem;">No speakers in queue</p>';
        return;
    }
    list.innerHTML = queue.map((speaker, idx) => `
        <div style="padding: 0.75rem; margin-bottom: 0.5rem; background: ${idx === 0 ? '#27ae60' : '#2c3e50'}; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <strong>${idx + 1}. ${escapeHtml(speaker.name)}</strong>
                ${idx === 0 ? '<span style="margin-left: 0.5rem; color: #f1c40f;">● Speaking Now</span>' : ''}
            </div>
            <div style="display: flex; gap: 0.5rem;">
                ${idx === 0 ? '<button class="btn secondary" onclick="markSpeakerDone(\'' + speaker.id + '\')" style="font-size: 0.85rem;">Done</button>' : ''}
                <button class="btn secondary" onclick="removeSpeaker(\'' + speaker.id + '\')" style="font-size: 0.85rem; background: #e74c3c;">Remove</button>
            </div>
        </div>
    `).join('');
}
function markSpeakerDone(id) {
    let queue = storage.getSpeakingQueue();
    const speaker = queue.find(s => s.id === id);
    if (speaker) {
        speaker.status = 'done';
        storage.saveSpeakingQueue(queue);
        renderSpeakingQueue();
        resetSpeakerTimer();
    }
}
function removeSpeaker(id) {
    let queue = storage.getSpeakingQueue();
    queue = queue.filter(s => s.id !== id);
    storage.saveSpeakingQueue(queue);
    renderSpeakingQueue();
}
function startSpeakerTimer() {
    if (speakerTimerInterval) return;
    speakerTimerInterval = setInterval(() => {
        speakerTimeRemaining--;
        updateTimerDisplay();
        if (speakerTimeRemaining <= 0) {
            pauseSpeakerTimer();
            showToast('Time is up!', 'info');
        }
    }, 1000);
}
function pauseSpeakerTimer() {
    if (speakerTimerInterval) {
        clearInterval(speakerTimerInterval);
        speakerTimerInterval = null;
    }
}
function resetSpeakerTimer() {
    pauseSpeakerTimer();
    speakerTimeRemaining = 180;
    updateTimerDisplay();
}
function updateTimerDisplay() {
    const minutes = Math.floor(speakerTimeRemaining / 60);
    const seconds = speakerTimeRemaining % 60;
    document.getElementById('timer-display').textContent =
        `${minutes}:${seconds.toString().padStart(2, '0')}`;
}
function callForSecond() {
    showToast('Calling for a second to the motion...', 'info');
    advanceMotionWorkflow();
}
function openDiscussion() {
    showToast('Discussion is now open', 'info');
    currentWorkflowStep = 2;
    updateWorkflowDisplay();
}
function closeDiscussion() {
    showToast('Discussion is closed', 'info');
}
function callTheQuestion() {
    if (confirm('Are you ready to vote on this motion?')) {
        currentWorkflowStep = 3;
        updateWorkflowDisplay();
        showToast('Ready to vote!', 'success');
    }
}
function tableMotion() {
    if (confirm('Table this motion until the next meeting?')) {
        showToast('Motion has been tabled', 'info');
        resetMotionWorkflow();
        storage.saveSpeakingQueue([]);
        renderSpeakingQueue();
    }
}
function pointOfInformation() {
    showToast('Point of Information recognized', 'info');
}
function pointOfOrder() {
    showToast('Point of Order recognized', 'info');
}
function pointOfPrivilege() {
    showToast('Point of Personal Privilege recognized', 'info');
}
function parliamentaryInquiry() {
    const inquiry = prompt('What is your parliamentary inquiry?');
    if (inquiry && inquiry.trim()) {
        const response = prompt('Chair\'s response to the inquiry:');
        const record = {
            date: new Date().toISOString(),
            inquiry: inquiry.trim(),
            response: response ? response.trim() : 'No response recorded',
            timestamp: Date.now()
        };
        const inquiries = storage.getParliamentaryInquiries();
        inquiries.push(record);
        storage.saveParliamentaryInquiries(inquiries);
        showToast('Parliamentary inquiry recorded', 'success');
    }
}
function divisionOfAssembly() {
    if (confirm('Request Division of Assembly?\n\nThis will require a counted vote to verify the voice vote result.')) {
        showToast('Division of Assembly requested - proceeding with counted vote', 'info');
        document.getElementById('voting-method').value = 'roll-call';
        updateVotingMethod();
    }
}
function withdrawMotion() {
    if (confirm('Withdraw the current motion?\n\nThe proposer may withdraw before voting begins. This requires unanimous consent.')) {
        showToast('Motion withdrawn by proposer', 'info');
        resetMotionWorkflow();
    }
}
function divisionOfQuestion() {
    showToast('Division of Question workspace opened', 'info');
    document.getElementById('original-motion-text').focus();
}
function processDivisionOfQuestion() {
    const original = document.getElementById('original-motion-text').value.trim();
    const part1 = document.getElementById('divided-part-1').value.trim();
    const part2 = document.getElementById('divided-part-2').value.trim();
    const part3 = document.getElementById('divided-part-3').value.trim();
    if (!original || !part1 || !part2) {
        showToast('Please provide original motion and at least 2 parts', 'warning');
        return;
    }
    if (confirm('Process Division of Question?\n\nThis requires 2/3 vote. Each part will be voted on separately.')) {
        const parts = [part1, part2];
        if (part3) parts.push(part3);
        const division = {
            date: new Date().toISOString(),
            originalMotion: original,
            parts: parts,
            results: [],
            timestamp: Date.now()
        };
        const divisions = storage.getDividedQuestions();
        divisions.push(division);
        storage.saveDividedQuestions(divisions);
        const statusDiv = document.getElementById('division-status');
        statusDiv.innerHTML = `
            <div style="padding: 1rem; background: #2ecc71; border-radius: 4px; margin-top: 1rem;">
                <strong>Division Approved (2/3 vote)</strong><br>
                <p style="margin-top: 0.5rem;">Vote on each part separately:</p>
                ${parts.map((part, idx) => `
                    <button class="btn mt-2" onclick="voteDividedPart(${divisions.length - 1}, ${idx})" style="width: 100%; background: #3498db;">
                        Vote on Part ${idx + 1}: ${part.substring(0, 50)}${part.length > 50 ? '...' : ''}
                    </button>
                `).join('')}
            </div>
        `;
        document.getElementById('original-motion-text').value = '';
        document.getElementById('divided-part-1').value = '';
        document.getElementById('divided-part-2').value = '';
        document.getElementById('divided-part-3').value = '';
        showToast('Division of Question processed - vote on each part', 'success');
    }
}
function voteDividedPart(divisionIdx, partIdx) {
    const divisions = storage.getDividedQuestions();
    const division = divisions[divisionIdx];
    const part = division.parts[partIdx];
    const result = confirm(`Vote on Part ${partIdx + 1}:\n\n"${part}"\n\nClick OK for YES, Cancel for NO`);
    if (!division.results) division.results = [];
    division.results[partIdx] = result ? 'Passed' : 'Failed';
    storage.saveDividedQuestions(divisions);
    showToast(`Part ${partIdx + 1} ${result ? 'PASSED' : 'FAILED'}`, result ? 'success' : 'error');
}
function appealChairRuling() {
    const issue = prompt('What procedural issue is being questioned?');
    if (issue && issue.trim()) {
        const ruling = prompt('Chair\'s ruling on this issue:');
        if (ruling && ruling.trim()) {
            if (confirm('Appeal the Chair\'s Ruling?\n\nThis requires a second and will be put to a vote.\n\nClick OK to appeal.')) {
                const appealed = confirm('Did the appeal get a second?\n\nClick OK if seconded, Cancel if not.');
                if (appealed) {
                    const sustained = confirm('Vote on sustaining the Chair\'s ruling:\n\nOK = Sustain Chair\'s ruling\nCancel = Overturn Chair\'s ruling');
                    const record = {
                        date: new Date().toISOString(),
                        issue: issue.trim(),
                        ruling: ruling.trim(),
                        appealed: true,
                        result: sustained ? 'Sustained' : 'Overturned',
                        timestamp: Date.now()
                    };
                    const rulings = storage.getChairRulings();
                    rulings.push(record);
                    storage.saveChairRulings(rulings);
                    refreshChairRulings();
                    showToast(`Chair's ruling ${sustained ? 'SUSTAINED' : 'OVERTURNED'}`, sustained ? 'success' : 'warning');
                } else {
                    showToast('Appeal failed - no second', 'error');
                }
            } else {
                const record = {
                    date: new Date().toISOString(),
                    issue: issue.trim(),
                    ruling: ruling.trim(),
                    appealed: false,
                    result: 'Not Appealed',
                    timestamp: Date.now()
                };
                const rulings = storage.getChairRulings();
                rulings.push(record);
                storage.saveChairRulings(rulings);
                refreshChairRulings();
                showToast('Chair\'s ruling recorded', 'info');
            }
        }
    }
}
function objectionToConsideration() {
    if (confirm('Objection to Consideration of a Question?\n\nThis must be raised before debate begins. Requires 2/3 vote to sustain objection.\n\nSustaining the objection prevents consideration of the motion.')) {
        const sustained = confirm('Vote on the objection:\n\nOK = Sustain objection (2/3 vote - motion is NOT considered)\nCancel = Objection fails (motion proceeds)');
        if (sustained) {
            showToast('Objection SUSTAINED - motion will not be considered', 'warning');
            resetMotionWorkflow();
        } else {
            showToast('Objection failed - motion proceeds to consideration', 'info');
        }
    }
}
function suspendRules() {
    const rule = prompt('Which rule(s) do you want to suspend?');
    if (rule && rule.trim()) {
        const purpose = prompt('Purpose for suspending this rule:');
        const duration = prompt('Duration of suspension (e.g., "for this motion", "for this meeting"):');
        if (purpose && duration) {
            if (confirm('Suspend the Rules?\n\nThis requires a 2/3 vote.\n\nNote: Cannot suspend fundamental rights or bylaws.')) {
                const passed = confirm('Vote on suspension:\n\nOK = Suspension PASSES (2/3 vote)\nCancel = Suspension FAILS');
                const record = {
                    date: new Date().toISOString(),
                    rule: rule.trim(),
                    purpose: purpose.trim(),
                    duration: duration.trim(),
                    result: passed ? 'Approved' : 'Failed',
                    timestamp: Date.now()
                };
                const suspensions = storage.getRulesSuspensions();
                suspensions.push(record);
                storage.saveRulesSuspensions(suspensions);
                refreshRulesSuspensions();
                showToast(`Rules suspension ${passed ? 'APPROVED' : 'FAILED'}`, passed ? 'success' : 'error');
            }
        }
    }
}
function takeFromTable() {
    const tabledMotions = storage.getTabledMotions();
    if (tabledMotions.length === 0) {
        showToast('No tabled motions available', 'info');
        return;
    }
    const motionIdx = prompt(`Select motion to take from table (0-${tabledMotions.length - 1}):\n\n` +
        tabledMotions.map((m, i) => `${i}: ${m.motion}`).join('\n'));
    const idx = parseInt(motionIdx);
    if (idx >= 0 && idx < tabledMotions.length) {
        if (confirm(`Take this motion from the table?\n\n"${tabledMotions[idx].motion}"\n\nRequires majority vote.`)) {
            const motion = tabledMotions.splice(idx, 1)[0];
            storage.saveTabledMotions(tabledMotions);
            showToast('Motion taken from table - resuming discussion', 'success');
            document.getElementById('motion-text').value = motion.motion;
            refreshTabledMotions();
        }
    }
}
function proposeAmendment() {
    const text = document.getElementById('amendment-text').value.trim();
    const type = document.querySelector('input[name="amendment-type"]:checked').value;
    if (!text) {
        showToast('Please enter amendment text', 'error');
        return;
    }
    showToast(`${type === 'friendly' ? 'Friendly' : 'Unfriendly'} amendment proposed`, 'success');
    document.getElementById('amendment-text').value = '';
    const list = document.getElementById('active-amendments-list');
    const amendDiv = document.createElement('div');
    amendDiv.style.cssText = 'padding: 0.5rem; background: #2c3e50; border-radius: 4px; margin-top: 0.5rem;';
    amendDiv.innerHTML = `<strong>${type === 'friendly' ? 'Friendly' : 'Unfriendly'}:</strong> ${escapeHtml(text)}`;
    list.appendChild(amendDiv);
}
const MotionTypes = {
    MAIN: { precedence: 0, debatable: true, amendable: true, voteRequired: 'majority', displayName: 'Main Motion' },
    AMEND: { precedence: 1, debatable: true, amendable: true, voteRequired: 'majority', displayName: 'Amendment' },
    REFER: { precedence: 2, debatable: true, amendable: true, voteRequired: 'majority', displayName: 'Refer to Committee' },
    POSTPONE: { precedence: 3, debatable: true, amendable: true, voteRequired: 'majority', displayName: 'Postpone' },
    LIMIT_DEBATE: { precedence: 4, debatable: false, amendable: true, voteRequired: '2/3', displayName: 'Limit Debate' },
    PREVIOUS_QUESTION: { precedence: 5, debatable: false, amendable: false, voteRequired: '2/3', displayName: 'Previous Question' },
    TABLE: { precedence: 6, debatable: false, amendable: false, voteRequired: 'majority', displayName: 'Table Motion' },
    POINT_OF_ORDER: { precedence: 99, debatable: false, amendable: false, voteRequired: 'chair', displayName: 'Point of Order' }
};
function updateVotingMethod() {
    const method = document.getElementById('voting-method').value;
    const voteCounter = document.getElementById('vote-counter');
    if (method === 'voice') {
        voteCounter.style.display = 'none';
        showToast('Voice vote selected - Chair will call for ayes and nays', 'info');
    } else {
        voteCounter.style.display = 'block';
        showToast(`${method.replace('-', ' ')} voting method selected`, 'info');
    }
}
function calculateVoteResult() {
    const votesFor = parseInt(document.getElementById('votes-for-input').value) || 0;
    const votesAgainst = parseInt(document.getElementById('votes-against-input').value) || 0;
    const votesAbstain = parseInt(document.getElementById('votes-abstain-input').value) || 0;
    const totalVotes = votesFor + votesAgainst;
    const votingMethod = document.getElementById('voting-method').value;
    const gcSettings = storage.getGCSettings();
    const members = storage.getMembers().length;
    const quorumMin = Math.max(gcSettings.quorumMinimum || 5, Math.ceil(members * ((gcSettings.quorumPercentage || 40) / 100)));
    if (totalVotes < quorumMin) {
        showToast(`Quorum not met! Need ${quorumMin} voting members, only ${totalVotes} voted.`, 'error');
        document.getElementById('vote-result').style.display = 'block';
        document.getElementById('vote-result-text').innerHTML = '<span style="color: #e74c3c;">QUORUM NOT MET</span>';
        document.getElementById('vote-result-details').textContent = `Required: ${quorumMin} | Present: ${totalVotes}`;
        return;
    }
    let passed = false;
    let requiredVotes = 0;
    let passThreshold = '';
    if (votingMethod === 'consensus') {
        requiredVotes = Math.ceil(totalVotes * 0.667);
        passed = votesFor >= requiredVotes;
        passThreshold = '2/3 (Substantial Unanimity)';
    } else {
        passed = votesFor > votesAgainst;
        passThreshold = 'Simple Majority';
    }
    const forPercentage = ((votesFor / totalVotes) * 100).toFixed(1);
    const againstPercentage = ((votesAgainst / totalVotes) * 100).toFixed(1);
    const minorityPercentage = parseFloat(againstPercentage);
    document.getElementById('vote-result').style.display = 'block';
    const resultColor = passed ? '#2ecc71' : '#e74c3c';
    document.getElementById('vote-result-text').innerHTML = `<span style="color: ${resultColor};">${passed ? 'MOTION PASSED' : 'MOTION FAILED'}</span>`;
    document.getElementById('vote-result-details').innerHTML = `
        For: ${votesFor} (${forPercentage}%) | Against: ${votesAgainst} (${againstPercentage}%) | Abstain: ${votesAbstain}<br>
        Threshold: ${passThreshold} | Total Voting: ${totalVotes}
    `;
    if (passed && minorityPercentage >= 33) {
        document.getElementById('minority-report-section').style.display = 'block';
        document.getElementById('minority-not-needed').style.display = 'none';
        showToast('Significant minority (&gt;33%) - minority may record concerns per AA Tradition', 'warning');
    } else {
        document.getElementById('minority-report-section').style.display = 'none';
        document.getElementById('minority-not-needed').style.display = 'block';
    }
    document.getElementById('quorum-required').textContent = quorumMin;
    document.getElementById('quorum-present').textContent = totalVotes;
    const quorumStatus = document.getElementById('quorum-status');
    quorumStatus.style.background = '#2ecc71';
    quorumStatus.style.color = 'white';
    quorumStatus.innerHTML = '<i class="fas fa-check-circle"></i> Quorum Met';
    showToast(passed ? 'Motion passed!' : 'Motion failed', passed ? 'success' : 'error');
}
function saveMinorityReport() {
    const concerns = document.getElementById('minority-concerns').value.trim();
    if (!concerns) {
        showToast('Please enter minority concerns', 'error');
        return;
    }
    showToast('Minority report saved and will be included in meeting minutes', 'success');
    logAuditEntry('create', 'minority-report', storage.getCurrentUser(), { concerns }, 'Minority opinion recorded');
    document.getElementById('minority-concerns').value = '';
    document.getElementById('minority-report-section').style.display = 'none';
    document.getElementById('minority-not-needed').style.display = 'block';
}
function updateQuorumDisplay() {
    const gcSettings = storage.getGCSettings();
    const members = storage.getMembers().length;
    const quorumMin = Math.max(gcSettings.quorumMinimum || 5, Math.ceil(members * ((gcSettings.quorumPercentage || 40) / 100)));
    document.getElementById('quorum-required').textContent = quorumMin;
    document.getElementById('quorum-status').innerHTML = '<i class="fas fa-info-circle"></i> Enter attendance to check quorum';
    document.getElementById('quorum-status').style.background = '#34495e';
    document.getElementById('quorum-status').style.color = '#ecf0f1';
}
function getMotionImpactLinks(gcLogId) {
    const log = storage.getGroupConscienceLog().find(l => l.id === gcLogId);
    if (!log) return [];
    const impacts = [];
    if (log.item.toLowerCase().includes('budget') || log.item.toLowerCase().includes('expense') || log.item.toLowerCase().includes('$')) {
        const budgetCategories = storage.getBudgetCategories();
        const relatedCategories = budgetCategories.filter(cat =>
            log.item.toLowerCase().includes(cat.category.toLowerCase())
        );
        if (relatedCategories.length > 0) {
            impacts.push({
                module: 'Budget',
                icon: 'fa-dollar-sign',
                description: `May affect ${relatedCategories.map(c => c.category).join(', ')} budget`,
                actionFn: 'goToSection(\'finance-section\')',
                actionText: 'View Budget'
            });
        }
    }
    const positions = storage.getServicePositions();
    const mentionedPositions = positions.filter(pos =>
        log.item.toLowerCase().includes(pos.name.toLowerCase())
    );
    if (mentionedPositions.length > 0) {
        impacts.push({
            module: 'Service',
            icon: 'fa-users-cog',
            description: `Related to ${mentionedPositions.map(p => p.name).join(', ')}`,
            actionFn: 'goToSection(\'service-positions-section\')',
            actionText: 'View Positions'
        });
    }
    const actionItems = storage.getGCActionItems().filter(item => item.gcId === gcLogId);
    if (actionItems.length > 0) {
        impacts.push({
            module: 'Action Items',
            icon: 'fa-tasks',
            description: `${actionItems.length} action item(s) created`,
            actionFn: 'goToSection(\'gc-decisions-section\')',
            actionText: 'View Tasks'
        });
    }
    const traditionAlignment = getMotionTraditionAlignment(log.item);
    if (traditionAlignment) {
        impacts.push({
            module: 'AA Traditions',
            icon: 'fa-book',
            description: `Aligns with Tradition #${traditionAlignment.tradition}`,
            actionFn: 'showTraditionsReference()',
            actionText: 'View Tradition'
        });
    }
    return impacts;
}
function openMember360View(memberId) {
    const member = storage.getMembers().find(m => m.id === memberId);
    if (!member) {
        showToast('Member not found', 'error');
        return;
    }
    const positions = storage.getServicePositions().filter(p => p.currentHolder === member.name);
    const gcParticipation = storage.getGroupConscienceLog().filter(log =>
        (Array.isArray(log.attendees) && log.attendees.includes(member.name)) ||
        log.submittedBy === member.name
    );
    const messages = storage.getMessages().filter(m => m.from === member.name || m.to === member.name);
    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; overflow-y: auto;';
    modal.innerHTML = `
        <div style="background: #34495e; padding: 2rem; border-radius: 8px; max-width: 900px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2 style="color: #3498db; margin: 0;">${escapeHtml(member.name)} - Complete Profile</h2>
                <button onclick="this.closest('div[style*=fixed]').remove()" style="background: none; border: none; color: #e74c3c; font-size: 2rem; cursor: pointer;">&times;</button>
            </div>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                <div class="box">
                    <h3>Contact Information</h3>
                    <p><strong>Email:</strong> ${escapeHtml(member.email || 'Not provided')}</p>
                    <p><strong>Phone:</strong> ${escapeHtml(member.phone || 'Not provided')}</p>
                    <p><strong>Home Group:</strong> ${escapeHtml(member.homegroup || 'This group')}</p>
                    <p><strong>Sponsor:</strong> ${escapeHtml(member.sponsor || 'Not listed')}</p>
                    <p><strong>Clean Date:</strong> ${member.birthday ? new Date(member.birthday).toLocaleDateString() : 'Not provided'}</p>
                </div>
                <div class="box">
                    <h3>Group Participation</h3>
                    <p><strong>GC Meetings Attended:</strong> ${gcParticipation.length}</p>
                    <p><strong>Motions Submitted:</strong> ${gcParticipation.filter(log => log.submittedBy === member.name).length}</p>
                    <p><strong>Messages:</strong> ${messages.length}</p>
                    <button class="btn mt-2" onclick="goToSection('messaging-section')">Send Message</button>
                </div>
            </div>
            <div class="box mb-4">
                <h3><i class="fas fa-users-cog"></i> Service Positions (${positions.length})</h3>
                ${positions.length > 0 ? `
                    <table>
                        <thead><tr><th>Position</th><th>Start Date</th><th>Term Ends</th></tr></thead>
                        <tbody>
                            ${positions.map(pos => {
                                const endDate = pos.startDate && pos.termLength !== 'Indefinite' ? new Date(new Date(pos.startDate).setMonth(new Date(pos.startDate).getMonth() + parseInt(pos.termLength))) : null;
                                return `
                                    <tr>
                                        <td>${escapeHtml(pos.name)}</td>
                                        <td>${pos.startDate ? new Date(pos.startDate).toLocaleDateString() : 'N/A'}</td>
                                        <td>${endDate ? endDate.toLocaleDateString() : 'Indefinite'}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                ` : '<p style="opacity: 0.7;">No current service positions</p>'}
                <button class="btn mt-2" onclick="goToSection('service-positions-section')">View All Positions</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}
let liveMeetingData = null;
let meetingTimer = null;
function startLiveMeeting() {
    liveMeetingData = {
        id: genId(),
        startTime: new Date().toISOString(),
        attendees: [],
        motions: [],
        speakers: [],
        actionItems: []
    };
    showToast('Live GC session started! All actions will be recorded automatically.', 'success');
    logAuditEntry('create', 'live-meeting', storage.getCurrentUser(), liveMeetingData, 'Started live GC session');
}
function endLiveMeeting() {
    if (!liveMeetingData) return;
    liveMeetingData.endTime = new Date().toISOString();
    showToast('Meeting ended! Review and save meeting minutes.', 'success');
    logAuditEntry('create', 'meeting-end', storage.getCurrentUser(), liveMeetingData, 'Ended live GC session');
    liveMeetingData = null;
}
let currentElection = null;
function startElection() {
    const positionId = document.getElementById('election-position').value;
    const date = document.getElementById('election-date').value;
    const anonymous = document.getElementById('election-anonymous').checked;
    const method = document.getElementById('election-method').value;
    if (!positionId || !date) {
        showToast('Please select position and date', 'error');
        return;
    }
    const positions = storage.getGroupPositions();
    const position = positions.find(p => p.id === positionId);
    currentElection = {
        id: genId(),
        positionId,
        positionTitle: position.title,
        date,
        anonymous,
        method,
        status: 'nominating',
        nominees: [],
        ballots: []
    };
    document.getElementById('current-election-info').style.display = 'block';
    document.getElementById('current-election-position').textContent = position.title;
    showToast(`Election started for ${position.title}`, 'success');
    renderNominees();
}
function nominateMember() {
    if (!currentElection) {
        showToast('Please start an election first', 'error');
        return;
    }
    const memberId = document.getElementById('nominee-select').value;
    if (!memberId) {
        showToast('Please select a member', 'error');
        return;
    }
    const members = storage.getMembers();
    const member = members.find(m => m.id === memberId);
    if (currentElection.nominees.find(n => n.memberId === memberId)) {
        showToast('This member is already nominated', 'error');
        return;
    }
    currentElection.nominees.push({
        memberId,
        memberName: member.name,
        timestamp: new Date().toISOString()
    });
    showToast(`${member.name} nominated`, 'success');
    renderNominees();
}
function renderNominees() {
    if (!currentElection) return;
    const list = document.getElementById('nominees-list');
    if (currentElection.nominees.length === 0) {
        list.innerHTML = '<p style="opacity: 0.7;">No nominees yet</p>';
        return;
    }
    list.innerHTML = currentElection.nominees.map(n => `
        <div style="padding: 0.75rem; background: #2c3e50; border-radius: 4px; margin-top: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
            <strong>${escapeHtml(n.memberName)}</strong>
            <button class="btn secondary" onclick="removeNominee('${escapeAttribute(n.memberId)}')" style="font-size: 0.85rem; background: #e74c3c;">Remove</button>
        </div>
    `).join('');
    renderBallotInterface();
}
function removeNominee(memberId) {
    if (!currentElection) return;
    currentElection.nominees = currentElection.nominees.filter(n => n.memberId !== memberId);
    renderNominees();
}
function renderBallotInterface() {
    if (!currentElection || currentElection.nominees.length === 0) {
        document.getElementById('ballot-interface').innerHTML = '<p style="opacity: 0.7;">Add nominees to begin voting</p>';
        return;
    }
    const ballot = document.getElementById('ballot-interface');
    ballot.innerHTML = `
        <p class="mb-2"><strong>Cast your vote:</strong></p>
        ${currentElection.nominees.map(n => `
            <div style="padding: 0.5rem; background: #2c3e50; border-radius: 4px; margin-bottom: 0.5rem;">
                <label style="cursor: pointer; display: flex; align-items: center;">
                    <input type="radio" name="ballot-vote" value="${escapeAttribute(n.memberId)}" style="margin-right: 0.5rem;">
                    ${escapeHtml(n.memberName)}
                </label>
            </div>
        `).join('')}
        <button class="btn mt-2" onclick="castBallot()">Cast Ballot</button>
        <button class="btn secondary mt-2 ml-2" onclick="finalizeElection()">Finalize Election</button>
    `;
}
function castBallot() {
    if (!currentElection) return;
    const selected = document.querySelector('input[name="ballot-vote"]:checked');
    if (!selected) {
        showToast('Please select a nominee', 'error');
        return;
    }
    currentElection.ballots.push({
        vote: selected.value,
        timestamp: new Date().toISOString()
    });
    showToast('Ballot cast!', 'success');
    document.querySelectorAll('input[name="ballot-vote"]').forEach(r => r.checked = false);
    if (!currentElection.anonymous) {
        const tallies = {};
        currentElection.ballots.forEach(b => {
            tallies[b.vote] = (tallies[b.vote] || 0) + 1;
        });
        console.log('Current tallies:', tallies);
    }
}
function finalizeElection() {
    if (!currentElection || currentElection.ballots.length === 0) {
        showToast('No ballots have been cast', 'error');
        return;
    }
    const tallies = {};
    currentElection.ballots.forEach(b => {
        tallies[b.vote] = (tallies[b.vote] || 0) + 1;
    });
    const sortedCandidates = Object.entries(tallies).sort((a, b) => b[1] - a[1]);
    const winnerId = sortedCandidates[0][0];
    const winnerVotes = sortedCandidates[0][1];
    const totalVotes = currentElection.ballots.length;
    const winner = currentElection.nominees.find(n => n.memberId === winnerId);
    currentElection.status = 'completed';
    currentElection.winner = winner;
    currentElection.finalTally = tallies;
    currentElection.completedDate = new Date().toISOString();
    const elections = storage.getServiceElections();
    elections.push(currentElection);
    storage.saveServiceElections(elections);
    showToast(`${winner.memberName} elected with ${winnerVotes}/${totalVotes} votes!`, 'success');
    updateServicePositionHolder(currentElection.positionId, winnerId, winner.memberName);
    currentElection = null;
    document.getElementById('current-election-info').style.display = 'none';
    document.getElementById('ballot-interface').innerHTML = '';
    document.getElementById('nominees-list').innerHTML = '';
    renderElectionHistory();
    renderCurrentPositions();
}
function updateServicePositionHolder(positionId, memberId, memberName) {
    const positions = storage.getGroupPositions();
    const position = positions.find(p => p.id === positionId);
    if (position) {
        const termEnd = new Date();
        termEnd.setMonth(termEnd.getMonth() + position.term);
        position.currentHolder = memberName;
        position.currentHolderId = memberId;
        position.termStart = new Date().toISOString();
        position.termEnd = termEnd.toISOString();
        storage.saveGroupPositions(positions);
    }
}
function renderCurrentPositions() {
    const positions = storage.getGroupPositions();
    const tbody = document.getElementById('current-positions-body');
    tbody.innerHTML = positions.map(p => {
        const termEnd = p.termEnd ? new Date(p.termEnd) : null;
        const now = new Date();
        const daysRemaining = termEnd ? Math.floor((termEnd - now) / (1000 * 60 * 60 * 24)) : null;
        let status = 'Vacant';
        let statusColor = '#95a5a6';
        if (p.currentHolder) {
            if (daysRemaining > 90) {
                status = 'Active';
                statusColor = '#2ecc71';
            } else if (daysRemaining > 30) {
                status = 'Expiring Soon';
                statusColor = '#f39c12';
            } else if (daysRemaining > 0) {
                status = 'Expiring Very Soon';
                statusColor = '#e67e22';
            } else {
                status = 'Expired';
                statusColor = '#e74c3c';
            }
        }
        return `
            <tr>
                <td>${escapeHtml(p.title)}</td>
                <td>${p.currentHolder ? escapeHtml(p.currentHolder) : 'Vacant'}</td>
                <td>${termEnd ? termEnd.toLocaleDateString() : 'N/A'}</td>
                <td style="color: ${statusColor};">${status}</td>
            </tr>
        `;
    }).join('');
}
function renderElectionHistory() {
    const elections = storage.getServiceElections().sort((a, b) => new Date(b.completedDate) - new Date(a.completedDate));
    const list = document.getElementById('election-history-list');
    if (elections.length === 0) {
        list.innerHTML = '<p style="opacity: 0.7;">No elections recorded yet</p>';
        return;
    }
    list.innerHTML = elections.map(e => `
        <div style="padding: 0.75rem; background: #2c3e50; border-radius: 4px; margin-bottom: 0.5rem;">
            <strong>${escapeHtml(e.positionTitle)}</strong><br>
            <span style="font-size: 0.85rem; opacity: 0.8;">Winner: ${escapeHtml(e.winner.memberName)}</span><br>
            <span style="font-size: 0.85rem; opacity: 0.8;">Date: ${new Date(e.completedDate).toLocaleDateString()}</span>
        </div>
    `).join('');
}
function updateElectionEligibility() {
    const positionId = document.getElementById('election-position').value;
    if (!positionId) {
        document.getElementById('position-requirements').style.display = 'none';
        return;
    }
    const positions = storage.getGroupPositions();
    const position = positions.find(p => p.id === positionId);
    if (position) {
        document.getElementById('position-requirements').style.display = 'block';
        document.getElementById('position-req-details').innerHTML = `
            <div style="margin-top: 0.5rem;">
                <div>Term: ${position.term} months</div>
                <div>Min. Sobriety: ${position.minSobriety} months</div>
                <div>${escapeHtml(position.description)}</div>
            </div>
        `;
    }
}
let budgetLineItemCounter = 0;
function addBudgetLineItem() {
    const container = document.getElementById('budget-line-items');
    const id = budgetLineItemCounter++;
    const item = document.createElement('div');
    item.className = 'budget-line-item';
    item.style.cssText = 'padding: 0.75rem; background: #2c3e50; border-radius: 4px; margin-bottom: 0.5rem;';
    item.innerHTML = `
        <div style="display: flex; gap: 0.5rem; align-items: center;">
            <input type="text" placeholder="Category" id="budget-cat-${id}" style="flex: 2;">
            <input type="number" step="0.01" placeholder="Amount" id="budget-amt-${id}" onchange="updateBudgetTotal()" style="flex: 1;">
            <button class="btn secondary" onclick="this.parentElement.parentElement.remove(); updateBudgetTotal();" style="font-size: 0.85rem;">Remove</button>
        </div>
    `;
    container.appendChild(item);
}
function updateBudgetTotal() {
    const items = document.querySelectorAll('.budget-line-item');
    let total = 0;
    items.forEach(item => {
        const amtInput = item.querySelector('input[type="number"]');
        if (amtInput) {
            total += parseFloat(amtInput.value) || 0;
        }
    });
    document.getElementById('total-proposed-budget').textContent = total.toFixed(2);
}
function submitBudgetProposal() {
    const year = parseInt(document.getElementById('budget-year').value);
    const type = document.getElementById('budget-type').value;
    if (!year) {
        showToast('Please enter fiscal year', 'error');
        return;
    }
    const items = [];
    document.querySelectorAll('.budget-line-item').forEach(item => {
        const cat = item.querySelector('input[type="text"]').value.trim();
        const amt = parseFloat(item.querySelector('input[type="number"]').value) || 0;
        if (cat && amt > 0) {
            items.push({ category: cat, amount: amt });
        }
    });
    if (items.length === 0) {
        showToast('Please add at least one budget line item', 'error');
        return;
    }
    const total = items.reduce((sum, item) => sum + item.amount, 0);
    const proposals = storage.getBudgetProposals();
    proposals.push({
        id: genId(),
        year,
        type,
        items,
        total,
        status: 'pending',
        submittedDate: new Date().toISOString()
    });
    storage.saveBudgetProposals(proposals);
    showToast('Budget proposal submitted for Group Conscience approval!', 'success');
    document.getElementById('budget-line-items').innerHTML = '';
    document.getElementById('budget-year').value = '';
    updateBudgetTotal();
    renderBudgetProposals();
}
function renderBudgetProposals() {
    const proposals = storage.getBudgetProposals();
    const pending = proposals.filter(p => p.status === 'pending');
    const approved = proposals.filter(p => p.status === 'approved');
    const pendingList = document.getElementById('pending-budgets-list');
    if (pending.length === 0) {
        pendingList.innerHTML = '<p style="opacity: 0.7;">No pending budget proposals</p>';
    } else {
        pendingList.innerHTML = pending.map(p => `
            <div style="padding: 1rem; background: #2c3e50; border-radius: 4px; margin-bottom: 0.5rem;">
                <strong>${p.type === 'annual' ? 'Annual Budget' : p.type === 'amendment' ? 'Budget Amendment' : 'Special Project'} - FY ${p.year}</strong><br>
                <span style="font-size: 0.9rem;">Total: $${p.total.toFixed(2)}</span><br>
                <span style="font-size: 0.85rem; opacity: 0.8;">Submitted: ${new Date(p.submittedDate).toLocaleDateString()}</span>
                <div style="margin-top: 0.5rem;">
                    <button class="btn secondary" onclick="approveBudget('${p.id}')" style="font-size: 0.85rem;">Approve</button>
                    <button class="btn secondary" onclick="rejectBudget('${p.id}')" style="font-size: 0.85rem; background: #e74c3c; margin-left: 0.5rem;">Reject</button>
                </div>
            </div>
        `).join('');
    }
    const approvedList = document.getElementById('approved-budgets-list');
    if (approved.length === 0) {
        approvedList.innerHTML = '<p style="opacity: 0.7;">No approved budgets</p>';
    } else {
        approvedList.innerHTML = approved.map(p => `
            <div style="padding: 1rem; background: #27ae60; border-radius: 4px; margin-bottom: 0.5rem;">
                <strong>${p.type === 'annual' ? 'Annual Budget' : p.type === 'amendment' ? 'Budget Amendment' : 'Special Project'} - FY ${p.year}</strong><br>
                <span style="font-size: 0.9rem;">Total: $${p.total.toFixed(2)}</span>
            </div>
        `).join('');
    }
}
function approveBudget(id) {
    let proposals = storage.getBudgetProposals();
    const proposal = proposals.find(p => p.id === id);
    if (proposal) {
        proposal.status = 'approved';
        proposal.approvedDate = new Date().toISOString();
        storage.saveBudgetProposals(proposals);
        showToast('Budget approved!', 'success');
        renderBudgetProposals();
    }
}
function rejectBudget(id) {
    if (!confirm('Reject this budget proposal?')) return;
    let proposals = storage.getBudgetProposals();
    proposals = proposals.filter(p => p.id !== id);
    storage.saveBudgetProposals(proposals);
    showToast('Budget proposal rejected', 'info');
    renderBudgetProposals();
}
function saveLiteratureItem() {
    const editId = document.getElementById('lit-edit-id').value;
    if (editId) {
        updateLiteratureItem();
        return;
    }
    const name = document.getElementById('lit-item-name').value.trim();
    const type = document.getElementById('lit-item-type').value;
    const quantity = parseInt(document.getElementById('lit-quantity').value) || 0;
    const minQuantity = parseInt(document.getElementById('lit-min-quantity').value) || 0;
    const cost = parseFloat(document.getElementById('lit-cost').value) || 0;
    const loanable = document.getElementById('lit-loanable').checked;
    if (!name) {
        showToast('Please enter item name', 'error');
        return;
    }
    const inventory = storage.getLiteratureInventory();
    inventory.push({
        id: genId(),
        name,
        type,
        quantity,
        minQuantity,
        cost,
        loanable
    });
    storage.saveLiteratureInventory(inventory);
    showToast('Literature item added!', 'success');
    document.getElementById('lit-item-name').value = '';
    document.getElementById('lit-quantity').value = '';
    document.getElementById('lit-min-quantity').value = '';
    document.getElementById('lit-cost').value = '';
    document.getElementById('lit-loanable').checked = false;
    renderLiteratureInventory();
}
function renderLiteratureInventory() {
    const inventory = storage.getLiteratureInventory();
    const tbody = document.getElementById('literature-inventory-body');
    const alertsDiv = document.getElementById('lit-low-stock-alerts');
    if (inventory.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5">No items in inventory</td></tr>';
        alertsDiv.innerHTML = '<p style="opacity: 0.7;">No alerts</p>';
        return;
    }
    const lowStock = inventory.filter(item => item.quantity <= item.minQuantity);
    tbody.innerHTML = inventory.map(item => {
        const isLow = item.quantity <= item.minQuantity;
        const status = isLow ? 'Low Stock' : 'OK';
        const statusColor = isLow ? '#e74c3c' : '#2ecc71';
        return `
            <tr>
                <td>${escapeHtml(item.name)}</td>
                <td>${escapeHtml(item.type)}</td>
                <td>${item.quantity}</td>
                <td style="color: ${statusColor};">${status}</td>
                <td>
                    <button class="btn secondary" data-action="edit-lit-item" data-id="${escapeAttribute(item.id)}" style="font-size: 0.85rem;">Edit</button>
                    <button class="btn secondary" data-action="delete-lit-item" data-id="${escapeAttribute(item.id)}" style="font-size: 0.85rem; background: #e74c3c;">Delete</button>
                </td>
            </tr>
        `;
    }).join('');
    if (lowStock.length > 0) {
        alertsDiv.innerHTML = lowStock.map(item => `
            <div style="padding: 0.75rem; background: #e74c3c; border-radius: 4px; margin-bottom: 0.5rem;">
                <strong>${escapeHtml(item.name)}</strong> - Only ${item.quantity} left (min: ${item.minQuantity})
            </div>
        `).join('');
    } else {
        alertsDiv.innerHTML = '<p style="color: #2ecc71;">All items adequately stocked</p>';
    }
    updateLiteratureLoanDropdowns();
}
function updateLiteratureLoanDropdowns() {
    const inventory = storage.getLiteratureInventory().filter(item => item.loanable && item.quantity > 0);
    const loanItemSelect = document.getElementById('loan-item');
    loanItemSelect.innerHTML = '<option value="">-- Select Item --</option>' +
        inventory.map(item => `<option value="${escapeAttribute(item.id)}">${escapeHtml(item.name)} (${item.quantity} available)</option>`).join('');
}
function checkOutLiterature() {
    const memberId = document.getElementById('loan-member').value;
    const itemId = document.getElementById('loan-item').value;
    const dueDate = document.getElementById('loan-due-date').value;
    if (!memberId || !itemId || !dueDate) {
        showToast('Please fill all fields', 'error');
        return;
    }
    const members = storage.getMembers();
    const member = members.find(m => m.id === memberId);
    const inventory = storage.getLiteratureInventory();
    const item = inventory.find(i => i.id === itemId);
    if (!item || item.quantity < 1) {
        showToast('Item not available', 'error');
        return;
    }
    item.quantity--;
    storage.saveLiteratureInventory(inventory);
    const loans = storage.getLiteratureLoans();
    loans.push({
        id: genId(),
        memberId,
        memberName: member.name,
        itemId,
        itemName: item.name,
        dueDate,
        checkoutDate: new Date().toISOString(),
        status: 'active'
    });
    storage.saveLiteratureLoans(loans);
    showToast(`Checked out to ${member.name}`, 'success');
    document.getElementById('loan-member').value = '';
    document.getElementById('loan-item').value = '';
    document.getElementById('loan-due-date').value = '';
    renderLiteratureLoans();
    renderLiteratureInventory();
}
function renderLiteratureLoans() {
    const loans = storage.getLiteratureLoans().filter(l => l.status === 'active');
    const tbody = document.getElementById('literature-loans-body');
    if (loans.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5">No active loans</td></tr>';
        return;
    }
    const now = new Date();
    tbody.innerHTML = loans.map(loan => {
        const dueDate = new Date(loan.dueDate);
        const isOverdue = dueDate < now;
        const status = isOverdue ? 'Overdue' : 'Active';
        const statusColor = isOverdue ? '#e74c3c' : '#2ecc71';
        return `
            <tr>
                <td>${escapeHtml(loan.memberName)}</td>
                <td>${escapeHtml(loan.itemName)}</td>
                <td>${dueDate.toLocaleDateString()}</td>
                <td style="color: ${statusColor};">${status}</td>
                <td>
                    <button class="btn secondary" onclick="returnLiterature('${escapeAttribute(loan.id)}')" style="font-size: 0.85rem;">Return</button>
                </td>
            </tr>
        `;
    }).join('');
}
function returnLiterature(loanId) {
    let loans = storage.getLiteratureLoans();
    const loan = loans.find(l => l.id === loanId);
    if (loan) {
        const inventory = storage.getLiteratureInventory();
        const item = inventory.find(i => i.id === loan.itemId);
        if (item) {
            item.quantity++;
            storage.saveLiteratureInventory(inventory);
        }
        loan.status = 'returned';
        loan.returnDate = new Date().toISOString();
        storage.saveLiteratureLoans(loans);
        showToast('Literature returned', 'success');
        renderLiteratureLoans();
        renderLiteratureInventory();
    }
}
function submitLiteraturePurchaseRequest() {
    const items = document.getElementById('purchase-items').value.trim();
    const cost = parseFloat(document.getElementById('purchase-estimated-cost').value) || 0;
    if (!items) {
        showToast('Please describe items to purchase', 'error');
        return;
    }
    const logs = storage.getGroupConscienceLog();
    logs.push({
        id: genId(),
        date: new Date().toISOString().split('T')[0],
        item: `Motion to purchase literature: ${items} (Estimated cost: $${cost.toFixed(2)})`,
        submittedBy: storage.getCurrentUser(),
        status: 'pending',
        votesFor: 0,
        votesAgainst: 0,
        votesAbstain: 0,
        attendees: [],
        servantReports: []
    });
    storage.saveGroupConscienceLog(logs);
    showToast('Purchase request submitted to Group Conscience!', 'success');
    document.getElementById('purchase-items').value = '';
    document.getElementById('purchase-estimated-cost').value = '';
}
function editLiteratureItem(id) {
    const inventory = storage.getLiteratureInventory();
    const item = inventory.find(i => i.id === id);
    if (!item) return;
    document.getElementById('lit-edit-id').value = item.id;
    document.getElementById('lit-item-name').value = item.name;
    document.getElementById('lit-item-type').value = item.type;
    document.getElementById('lit-quantity').value = item.quantity;
    document.getElementById('lit-min-quantity').value = item.minQuantity;
    document.getElementById('lit-cost').value = item.cost;
    document.getElementById('lit-loanable').checked = item.loanable;
    document.getElementById('lit-form-btn').textContent = 'Update Item';
    document.getElementById('lit-form-cancel-btn').style.display = 'inline-block';
}
function updateLiteratureItem() {
    const id = document.getElementById('lit-edit-id').value;
    const name = document.getElementById('lit-item-name').value.trim();
    const type = document.getElementById('lit-item-type').value;
    const quantity = parseInt(document.getElementById('lit-quantity').value) || 0;
    const minQuantity = parseInt(document.getElementById('lit-min-quantity').value) || 0;
    const cost = parseFloat(document.getElementById('lit-cost').value) || 0;
    const loanable = document.getElementById('lit-loanable').checked;
    let inventory = storage.getLiteratureInventory();
    const index = inventory.findIndex(i => i.id === id);
    if (index > -1) {
        inventory[index] = { id, name, type, quantity, minQuantity, cost, loanable };
        storage.saveLiteratureInventory(inventory);
        showToast('Item updated!', 'success');
        cancelLitEdit();
        renderLiteratureInventory();
    }
}
function cancelLitEdit() {
    document.getElementById('lit-edit-id').value = '';
    document.getElementById('lit-item-name').value = '';
    document.getElementById('lit-quantity').value = '';
    document.getElementById('lit-min-quantity').value = '';
    document.getElementById('lit-cost').value = '';
    document.getElementById('lit-loanable').checked = false;
    document.getElementById('lit-form-btn').textContent = 'Add Item';
    document.getElementById('lit-form-cancel-btn').style.display = 'none';
}
function deleteLiteratureItem(id) {
    if (!confirm('Delete this item?')) return;
    let inventory = storage.getLiteratureInventory();
    inventory = inventory.filter(i => i.id !== id);
    storage.saveLiteratureInventory(inventory);
    showToast('Item deleted', 'info');
    renderLiteratureInventory();
}
function saveDistrictMotion() {
    const editId = document.getElementById('district-motion-edit-id').value;
    if (editId) {
        updateDistrictMotion();
        return;
    }
    const source = document.getElementById('district-motion-source').value;
    const title = document.getElementById('district-motion-title').value.trim();
    const text = document.getElementById('district-motion-text').value.trim();
    const deadline = document.getElementById('district-motion-deadline').value;
    const background = document.getElementById('district-motion-background').value.trim();
    if (!title || !text) {
        showToast('Please provide title and motion text', 'error');
        return;
    }
    const motions = storage.getDistrictMotions();
    motions.push({
        id: genId(),
        source,
        title,
        text,
        deadline,
        background,
        status: 'pending',
        createdDate: new Date().toISOString()
    });
    storage.saveDistrictMotions(motions);
    showToast('District/Area motion added!', 'success');
    document.getElementById('district-motion-title').value = '';
    document.getElementById('district-motion-text').value = '';
    document.getElementById('district-motion-deadline').value = '';
    document.getElementById('district-motion-background').value = '';
    renderDistrictMotions();
}
function renderDistrictMotions() {
    const motions = storage.getDistrictMotions();
    const pending = motions.filter(m => m.status === 'pending');
    const responded = motions.filter(m => m.status !== 'pending');
    const pendingList = document.getElementById('pending-district-motions-list');
    if (pending.length === 0) {
        pendingList.innerHTML = '<p style="opacity: 0.7;">No pending district/area motions</p>';
    } else {
        pendingList.innerHTML = pending.map(m => {
            const deadline = m.deadline ? new Date(m.deadline) : null;
            const isUrgent = deadline && (deadline - new Date()) < (7 * 24 * 60 * 60 * 1000);
            return `
                <div style="padding: 1rem; background: #2c3e50; border-radius: 4px; margin-bottom: 0.5rem; border-left: 4px solid ${isUrgent ? '#e74c3c' : '#3498db'};">
                    <strong style="color: ${isUrgent ? '#e74c3c' : '#3498db'};">${escapeHtml(m.title)}</strong>
                    <span style="background: #34495e; padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.75rem; margin-left: 0.5rem;">${escapeHtml(m.source)}</span>
                    <p style="margin-top: 0.5rem; font-size: 0.9rem;">${escapeHtml(m.text)}</p>
                    ${m.deadline ? `<div style="margin-top: 0.5rem; font-size: 0.85rem; opacity: 0.8;">Deadline: ${deadline.toLocaleDateString()}</div>` : ''}
                    ${m.background ? `<div style="margin-top: 0.5rem; font-size: 0.85rem; opacity: 0.8;">Background: ${escapeHtml(m.background)}</div>` : ''}
                </div>
            `;
        }).join('');
    }
    const historyList = document.getElementById('district-motions-history-list');
    if (responded.length === 0) {
        historyList.innerHTML = '<p style="opacity: 0.7;">No position history</p>';
    } else {
        historyList.innerHTML = responded.map(m => `
            <div style="padding: 0.75rem; background: #2c3e50; border-radius: 4px; margin-bottom: 0.5rem;">
                <strong>${escapeHtml(m.title)}</strong><br>
                <span style="font-size: 0.85rem; opacity: 0.8;">Position: ${escapeHtml(m.groupPosition || 'Unknown')}</span><br>
                <span style="font-size: 0.85rem; opacity: 0.8;">Date: ${new Date(m.positionDate).toLocaleDateString()}</span>
            </div>
        `).join('');
    }
    const select = document.getElementById('position-motion-select');
    select.innerHTML = '<option value="">-- Select Motion --</option>' +
        pending.map(m => `<option value="${escapeAttribute(m.id)}">${escapeHtml(m.title)}</option>`).join('');
}
function recordGroupPosition() {
    const motionId = document.getElementById('position-motion-select').value;
    const position = document.getElementById('group-position').value;
    const rationale = document.getElementById('position-rationale').value.trim();
    const voteCount = document.getElementById('position-vote-count').value.trim();
    if (!motionId) {
        showToast('Please select a motion', 'error');
        return;
    }
    let motions = storage.getDistrictMotions();
    const motion = motions.find(m => m.id === motionId);
    if (motion) {
        motion.status = 'responded';
        motion.groupPosition = position;
        motion.rationale = rationale;
        motion.voteCount = voteCount;
        motion.positionDate = new Date().toISOString();
        storage.saveDistrictMotions(motions);
        showToast('Group position recorded!', 'success');
        document.getElementById('position-motion-select').value = '';
        document.getElementById('position-rationale').value = '';
        document.getElementById('position-vote-count').value = '';
        renderDistrictMotions();
    }
}
function updateDistrictMotion() {
    const id = document.getElementById('district-motion-edit-id').value;
    const source = document.getElementById('district-motion-source').value;
    const title = document.getElementById('district-motion-title').value.trim();
    const text = document.getElementById('district-motion-text').value.trim();
    const deadline = document.getElementById('district-motion-deadline').value;
    const background = document.getElementById('district-motion-background').value.trim();
    let motions = storage.getDistrictMotions();
    const index = motions.findIndex(m => m.id === id);
    if (index > -1) {
        motions[index] = { ...motions[index], source, title, text, deadline, background };
        storage.saveDistrictMotions(motions);
        showToast('Motion updated!', 'success');
        cancelDistrictMotionEdit();
        renderDistrictMotions();
    }
}
function cancelDistrictMotionEdit() {
    document.getElementById('district-motion-edit-id').value = '';
    document.getElementById('district-motion-title').value = '';
    document.getElementById('district-motion-text').value = '';
    document.getElementById('district-motion-deadline').value = '';
    document.getElementById('district-motion-background').value = '';
    document.getElementById('district-motion-form-btn').textContent = 'Add Motion';
    document.getElementById('district-motion-cancel-btn').style.display = 'none';
}
function saveQuorumRule() {
    const editId = document.getElementById('quorum-edit-id').value;
    if (editId) {
        updateQuorumRule();
        return;
    }
    const category = document.getElementById('quorum-category').value.trim();
    const percent = parseInt(document.getElementById('quorum-percent').value) || 50;
    const minCount = parseInt(document.getElementById('quorum-min-count').value) || 5;
    const description = document.getElementById('quorum-desc').value.trim();
    const allowProxy = document.getElementById('quorum-allow-proxy').checked;
    if (!category) {
        showToast('Please enter a category name', 'error');
        return;
    }
    const rules = storage.getQuorumRules();
    rules.push({
        id: genId(),
        category,
        quorumPercent: percent,
        quorumMin: minCount,
        description,
        allowProxy
    });
    storage.saveQuorumRules(rules);
    showToast('Quorum rule added!', 'success');
    document.getElementById('quorum-category').value = '';
    document.getElementById('quorum-percent').value = '';
    document.getElementById('quorum-min-count').value = '';
    document.getElementById('quorum-desc').value = '';
    document.getElementById('quorum-allow-proxy').checked = false;
    renderQuorumRules();
}
function renderQuorumRules() {
    const rules = storage.getQuorumRules();
    const tbody = document.getElementById('quorum-rules-body');
    const categorySelect = document.getElementById('live-quorum-category');
    if (rules.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4">No quorum rules defined</td></tr>';
        return;
    }
    tbody.innerHTML = rules.map(r => `
        <tr>
            <td><strong>${escapeHtml(r.category)}</strong><br><span style="font-size: 0.85rem; opacity: 0.8;">${escapeHtml(r.description)}</span></td>
            <td>${r.quorumPercent}% or ${r.quorumMin} min</td>
            <td>${r.allowProxy ? '<span style="color: #2ecc71;">✓ Yes</span>' : '<span style="opacity: 0.5;">No</span>'}</td>
            <td>
                <button class="btn secondary" onclick="editQuorumRule('${escapeAttribute(r.id)}')" style="font-size: 0.85rem;">Edit</button>
                <button class="btn secondary" onclick="deleteQuorumRule('${escapeAttribute(r.id)}')" style="font-size: 0.85rem; background: #e74c3c;">Delete</button>
            </td>
        </tr>
    `).join('');
    if (categorySelect) {
        categorySelect.innerHTML = '<option value="">-- Select Category --</option>' +
            rules.map(r => `<option value="${escapeAttribute(r.id)}">${escapeHtml(r.category)}</option>`).join('');
    }
}
function checkLiveQuorum() {
    const attendees = parseInt(document.getElementById('live-quorum-attendees').value) || 0;
    const ruleId = document.getElementById('live-quorum-category').value;
    const totalMembers = storage.getMembers().length;
    if (!ruleId || !attendees) {
        showToast('Please fill all fields', 'error');
        return;
    }
    const rules = storage.getQuorumRules();
    const rule = rules.find(r => r.id === ruleId);
    if (!rule) return;
    const requiredByPercent = Math.ceil((totalMembers * rule.quorumPercent) / 100);
    const required = Math.max(requiredByPercent, rule.quorumMin);
    const hasMet = attendees >= required;
    const resultDiv = document.getElementById('live-quorum-result');
    resultDiv.style.display = 'block';
    resultDiv.style.padding = '1rem';
    resultDiv.style.borderRadius = '6px';
    resultDiv.style.background = hasMet ? '#27ae60' : '#e74c3c';
    resultDiv.innerHTML = `
        <h4 style="margin-bottom: 0.5rem;">${hasMet ? '✓ Quorum MET' : '✗ Quorum NOT MET'}</h4>
        <p><strong>Category:</strong> ${escapeHtml(rule.category)}</p>
        <p><strong>Present:</strong> ${attendees} of ${totalMembers} members</p>
        <p><strong>Required:</strong> ${required} (${rule.quorumPercent}% or ${rule.quorumMin} minimum)</p>
        ${rule.allowProxy ? '<p style="color: #f1c40f;"><strong>Note:</strong> Proxy voting is allowed for this category</p>' : ''}
    `;
}
function editQuorumRule(id) {
    const rules = storage.getQuorumRules();
    const rule = rules.find(r => r.id === id);
    if (!rule) return;
    document.getElementById('quorum-edit-id').value = rule.id;
    document.getElementById('quorum-category').value = rule.category;
    document.getElementById('quorum-percent').value = rule.quorumPercent;
    document.getElementById('quorum-min-count').value = rule.quorumMin;
    document.getElementById('quorum-desc').value = rule.description;
    document.getElementById('quorum-allow-proxy').checked = rule.allowProxy;
    document.getElementById('quorum-form-btn').textContent = 'Update Rule';
    document.getElementById('quorum-cancel-btn').style.display = 'inline-block';
}
function updateQuorumRule() {
    const id = document.getElementById('quorum-edit-id').value;
    const category = document.getElementById('quorum-category').value.trim();
    const percent = parseInt(document.getElementById('quorum-percent').value) || 50;
    const minCount = parseInt(document.getElementById('quorum-min-count').value) || 5;
    const description = document.getElementById('quorum-desc').value.trim();
    const allowProxy = document.getElementById('quorum-allow-proxy').checked;
    let rules = storage.getQuorumRules();
    const index = rules.findIndex(r => r.id === id);
    if (index > -1) {
        rules[index] = { id, category, quorumPercent: percent, quorumMin: minCount, description, allowProxy };
        storage.saveQuorumRules(rules);
        showToast('Quorum rule updated!', 'success');
        cancelQuorumEdit();
        renderQuorumRules();
    }
}
function cancelQuorumEdit() {
    document.getElementById('quorum-edit-id').value = '';
    document.getElementById('quorum-category').value = '';
    document.getElementById('quorum-percent').value = '';
    document.getElementById('quorum-min-count').value = '';
    document.getElementById('quorum-desc').value = '';
    document.getElementById('quorum-allow-proxy').checked = false;
    document.getElementById('quorum-form-btn').textContent = 'Add Rule';
    document.getElementById('quorum-cancel-btn').style.display = 'none';
}
function deleteQuorumRule(id) {
    if (!confirm('Delete this quorum rule?')) return;
    let rules = storage.getQuorumRules();
    rules = rules.filter(r => r.id !== id);
    storage.saveQuorumRules(rules);
    showToast('Quorum rule deleted', 'info');
    renderQuorumRules();
}
let currentMinutesData = null;
function generateMinutesFromGC() {
    const gcId = document.getElementById('minutes-gc-select').value;
    if (!gcId) {
        showToast('Please select a meeting', 'error');
        return;
    }
    const logs = storage.getGroupConscienceLog();
    const gc = logs.find(l => l.id === gcId);
    if (!gc) return;
    const secretary = document.getElementById('secretary-name').value || 'Secretary';
    const minutes = {
        id: genId(),
        gcId: gc.id,
        date: gc.date,
        generatedDate: new Date().toISOString(),
        status: 'draft',
        content: {
            opening: `The ${new Date(gc.date).toLocaleDateString()} Group Conscience meeting was called to order.`,
            attendees: gc.attendees || [],
            attendeeCount: (gc.attendees || []).length,
            motions: [{
                item: gc.item,
                submittedBy: gc.submittedBy,
                votesFor: gc.votesFor || 0,
                votesAgainst: gc.votesAgainst || 0,
                votesAbstain: gc.votesAbstain || 0,
                status: gc.status,
                discussion: gc.discussion || ''
            }],
            servantReports: gc.servantReports || [],
            actionItems: [],
            closing: 'Meeting adjourned.',
            secretary
        }
    };
    currentMinutesData = minutes;
    renderMinutesPreview(minutes);
}
function renderMinutesPreview(minutes) {
    const preview = document.getElementById('minutes-preview');
    const date = new Date(minutes.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    preview.innerHTML = `
        <div style="font-family: 'Times New Roman', serif; line-height: 1.6;">
            <h2 style="text-align: center; margin-bottom: 1.5rem;">MEETING MINUTES</h2>
            <h3 style="text-align: center; margin-bottom: 2rem;">${date}</h3>
            <p><strong>Opening:</strong> ${escapeHtml(minutes.content.opening)}</p>
            <h4 style="margin-top: 1.5rem;">Attendance</h4>
            <p>Members Present: ${minutes.content.attendeeCount}</p>
            <h4 style="margin-top: 1.5rem;">Motions & Decisions</h4>
            ${minutes.content.motions.map((m, idx) => `
                <div style="margin: 1rem 0; padding-left: 1rem; border-left: 3px solid #3498db;">
                    <p><strong>Motion ${idx + 1}:</strong> ${escapeHtml(m.item)}</p>
                    <p><strong>Submitted by:</strong> ${escapeHtml(m.submittedBy || 'Unknown')}</p>
                    <p><strong>Voting:</strong> For: ${m.votesFor}, Against: ${m.votesAgainst}, Abstain: ${m.votesAbstain}</p>
                    <p><strong>Result:</strong> <span style="color: ${m.status === 'approved' ? '#2ecc71' : m.status === 'rejected' ? '#e74c3c' : '#f39c12'};">${escapeHtml(m.status || 'Pending').toUpperCase()}</span></p>
                    ${m.discussion ? `<p><strong>Discussion:</strong> ${escapeHtml(m.discussion)}</p>` : ''}
                </div>
            `).join('')}
            ${minutes.content.servantReports && minutes.content.servantReports.length > 0 ? `
                <h4 style="margin-top: 1.5rem;">Trusted Servant Reports</h4>
                ${minutes.content.servantReports.map(r => `
                    <p><strong>${escapeHtml(r.position)}:</strong> ${escapeHtml(r.report)}</p>
                `).join('')}
            ` : ''}
            <p style="margin-top: 2rem;"><strong>Closing:</strong> ${escapeHtml(minutes.content.closing)}</p>
            <div style="margin-top: 3rem; border-top: 1px solid #95a5a6; padding-top: 1rem;">
                <p><strong>Minutes prepared by:</strong> ${escapeHtml(minutes.content.secretary)}</p>
                <p><strong>Status:</strong> ${minutes.status === 'approved' ? '<span style="color: #2ecc71;">APPROVED</span>' : '<span style="color: #f39c12;">DRAFT</span>'}</p>
                <p><strong>Generated:</strong> ${new Date(minutes.generatedDate).toLocaleString()}</p>
            </div>
        </div>
    `;
}
function saveMinutes() {
    if (!currentMinutesData) {
        showToast('No minutes to save', 'error');
        return;
    }
    const minutes = storage.getMeetingMinutes();
    minutes.push(currentMinutesData);
    storage.saveMeetingMinutes(minutes);
    showToast('Minutes saved as draft!', 'success');
    renderMinutesArchive();
}
function approveMinutes() {
    if (!currentMinutesData) {
        showToast('No minutes to approve', 'error');
        return;
    }
    if (!confirm('Mark these minutes as approved?')) return;
    currentMinutesData.status = 'approved';
    currentMinutesData.approvedDate = new Date().toISOString();
    const minutes = storage.getMeetingMinutes();
    const existingIndex = minutes.findIndex(m => m.id === currentMinutesData.id);
    if (existingIndex > -1) {
        minutes[existingIndex] = currentMinutesData;
    } else {
        minutes.push(currentMinutesData);
    }
    storage.saveMeetingMinutes(minutes);
    showToast('Minutes approved!', 'success');
    renderMinutesPreview(currentMinutesData);
    renderMinutesArchive();
}
function exportMinutesPDF() {
    if (!currentMinutesData) {
        showToast('No minutes to export', 'error');
        return;
    }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const minutes = currentMinutesData;
    const date = new Date(minutes.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    let yPos = 20;
    doc.setFontSize(18);
    doc.setFont(undefined, 'bold');
    doc.text('MEETING MINUTES', doc.internal.pageSize.width / 2, yPos, { align: 'center' });
    doc.setFont(undefined, 'normal');
    yPos += 15;
    doc.setFontSize(12);
    doc.text(`Date: ${date}`, 14, yPos);
    yPos += 7;
    doc.text(`Group: ${minutes.content.groupName || 'HomeGroup'}`, 14, yPos);
    yPos += 7;
    doc.text(`Facilitator: ${minutes.content.facilitator || 'N/A'}`, 14, yPos);
    yPos += 10;
    doc.setFontSize(11);
    doc.setFont(undefined, 'bold');
    doc.text('Opening:', 14, yPos);
    doc.setFont(undefined, 'normal');
    yPos += 6;
    const openingLines = doc.splitTextToSize(minutes.content.opening, 180);
    doc.text(openingLines, 14, yPos);
    yPos += openingLines.length * 5 + 5;
    doc.setFont(undefined, 'bold');
    doc.text('Attendance:', 14, yPos);
    doc.setFont(undefined, 'normal');
    yPos += 6;
    doc.text(`Members Present: ${minutes.content.attendeeCount}`, 14, yPos);
    yPos += 10;
    if (yPos > 240) {
        doc.addPage();
        yPos = 20;
    }
    if (minutes.content.motions && minutes.content.motions.length > 0) {
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text('Motions & Decisions:', 14, yPos);
        doc.setFont(undefined, 'normal');
        yPos += 8;
        const motionTableData = minutes.content.motions.map((m, idx) => [
            `${idx + 1}`,
            m.item.substring(0, 60) + (m.item.length > 60 ? '...' : ''),
            m.status.toUpperCase(),
            m.votes || 'N/A'
        ]);
        doc.autoTable({
            startY: yPos,
            head: [['#', 'Motion', 'Status', 'Votes']],
            body: motionTableData,
            theme: 'grid',
            headStyles: { fillColor: [52, 152, 219], textColor: 255 },
            styles: { fontSize: 9 },
            columnStyles: {
                0: { cellWidth: 10 },
                1: { cellWidth: 110 },
                2: { cellWidth: 30 },
                3: { cellWidth: 35 }
            }
        });
        yPos = doc.lastAutoTable.finalY + 10;
    }
    if (yPos > 240) {
        doc.addPage();
        yPos = 20;
    }
    if (minutes.content.servantReports && minutes.content.servantReports.length > 0) {
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text('Servant Reports:', 14, yPos);
        doc.setFont(undefined, 'normal');
        yPos += 8;
        minutes.content.servantReports.forEach(report => {
            if (yPos > 260) {
                doc.addPage();
                yPos = 20;
            }
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text(`${report.position}:`, 14, yPos);
            doc.setFont(undefined, 'normal');
            yPos += 5;
            const reportLines = doc.splitTextToSize(report.report, 180);
            doc.text(reportLines, 14, yPos);
            yPos += reportLines.length * 4 + 5;
        });
        yPos += 5;
    }
    if (yPos > 250) {
        doc.addPage();
        yPos = 20;
    }
    doc.setFontSize(11);
    doc.setFont(undefined, 'bold');
    doc.text('Closing:', 14, yPos);
    doc.setFont(undefined, 'normal');
    yPos += 6;
    const closingLines = doc.splitTextToSize(minutes.content.closing, 180);
    doc.text(closingLines, 14, yPos);
    yPos += closingLines.length * 5 + 10;
    if (yPos > 240) {
        doc.addPage();
        yPos = 20;
    }
    doc.setFontSize(9);
    doc.text(`Minutes prepared by: ${minutes.content.secretary || 'N/A'}`, 14, yPos);
    yPos += 5;
    doc.text(`Status: ${minutes.status === 'approved' ? 'APPROVED' : 'DRAFT'}`, 14, yPos);
    yPos += 5;
    doc.text(`Generated: ${new Date(minutes.generatedDate).toLocaleString()}`, 14, yPos);
    const pageCount = doc.internal.getNumberOfPages();
    doc.setFontSize(9);
    doc.setTextColor(100, 100, 100);
    for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.text(`Page ${i} of ${pageCount}`, doc.internal.pageSize.width / 2, doc.internal.pageSize.height - 10, { align: 'center' });
    }
    const filename = `meeting-minutes-${new Date(minutes.date).toISOString().split('T')[0]}.pdf`;
    doc.save(filename);
    showToast('Meeting minutes exported to PDF successfully!', 'success');
}
function exportMemberDirectoryPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const members = storage.getMembers();
    if (members.length === 0) {
        showToast('No members to export', 'error');
        return;
    }
    doc.setFontSize(20);
    doc.text("Member Directory", 14, 22);
    doc.setFontSize(10);
    doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 30);
    doc.text(`Total Members: ${members.length}`, 14, 36);
    const tableData = members.map(m => [
        m.name || 'N/A',
        m.phone || 'N/A',
        m.email || 'N/A',
        m.city || 'N/A',
        m.homegroup === 'yes' ? 'Yes' : 'No',
        m.isServant === 'yes' ? 'Yes' : 'No'
    ]);
    doc.autoTable({
        head: [['Name', 'Phone', 'Email', 'City', 'Home Group', 'Servant']],
        body: tableData,
        startY: 42,
        styles: { fontSize: 8 },
        headStyles: { fillColor: [52, 152, 219] }
    });
    doc.save('Member_Directory.pdf');
    showToast('Member Directory PDF generated!', 'success');
}
function exportServicePositionsPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const positions = storage.getServicePositions();
    if (positions.length === 0) {
        showToast('No service positions to export', 'error');
        return;
    }
    doc.setFontSize(20);
    doc.text("Service Positions Report", 14, 22);
    doc.setFontSize(10);
    doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 30);
    const tableData = positions.map(p => [
        p.position || 'N/A',
        p.holder || 'Vacant',
        p.startDate ? new Date(p.startDate).toLocaleDateString() : 'N/A',
        p.endDate ? new Date(p.endDate).toLocaleDateString() : 'N/A',
        p.term || 'N/A'
    ]);
    doc.autoTable({
        head: [['Position', 'Current Holder', 'Start Date', 'End Date', 'Term Length']],
        body: tableData,
        startY: 36,
        headStyles: { fillColor: [46, 204, 113] }
    });
    doc.save('Service_Positions.pdf');
    showToast('Service Positions PDF generated!', 'success');
}
function exportLiteratureInventoryPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const inventory = storage.getLiteratureInventory();
    if (inventory.length === 0) {
        showToast('No literature inventory to export', 'error');
        return;
    }
    doc.setFontSize(20);
    doc.text("Literature Inventory Report", 14, 22);
    doc.setFontSize(10);
    doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 30);
    const tableData = inventory.map(item => [
        item.title || 'N/A',
        item.type || 'N/A',
        item.quantity?.toString() || '0',
        `$${item.price?.toFixed(2) || '0.00'}`,
        `$${((item.quantity || 0) * (item.price || 0)).toFixed(2)}`
    ]);
    doc.autoTable({
        head: [['Title', 'Type', 'Quantity', 'Unit Price', 'Total Value']],
        body: tableData,
        startY: 36,
        headStyles: { fillColor: [155, 89, 182] }
    });
    const totalValue = inventory.reduce((sum, item) => sum + ((item.quantity || 0) * (item.price || 0)), 0);
    const finalY = doc.lastAutoTable.finalY || 36;
    doc.setFontSize(12);
    doc.text(`Total Inventory Value: $${totalValue.toFixed(2)}`, 14, finalY + 10);
    doc.save('Literature_Inventory.pdf');
    showToast('Literature Inventory PDF generated!', 'success');
}
function exportServiceHoursReportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const hours = storage.getServiceHours() || [];
    if (hours.length === 0) {
        showToast('No service hours to export', 'error');
        return;
    }
    doc.setFontSize(20);
    doc.text("Service Hours Report", 14, 22);
    doc.setFontSize(10);
    doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 30);
    const memberHours = {};
    hours.forEach(h => {
        if (!memberHours[h.member]) memberHours[h.member] = 0;
        memberHours[h.member] += parseFloat(h.hours) || 0;
    });
    const tableData = Object.entries(memberHours)
        .sort((a, b) => b[1] - a[1])
        .map(([member, hours]) => [member, hours.toFixed(1)]);
    doc.autoTable({
        head: [['Member', 'Total Hours']],
        body: tableData,
        startY: 36,
        headStyles: { fillColor: [231, 76, 60] }
    });
    const totalHours = Object.values(memberHours).reduce((sum, h) => sum + h, 0);
    const finalY = doc.lastAutoTable.finalY || 36;
    doc.setFontSize(12);
    doc.text(`Total Service Hours: ${totalHours.toFixed(1)}`, 14, finalY + 10);
    doc.save('Service_Hours_Report.pdf');
    showToast('Service Hours PDF generated!', 'success');
}
function exportAnalyticsDashboardPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const members = storage.getMembers();
    const events = storage.getEvents();
    const gcLog = storage.getGroupConscienceLog();
    doc.setFontSize(22);
    doc.setTextColor(26, 188, 156);
    doc.text("Analytics Dashboard Report", 14, 22);
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(10);
    doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 30);
    doc.setFontSize(14);
    doc.text("Group Overview", 14, 42);
    doc.setFontSize(10);
    doc.text(`Total Members: ${members.length}`, 20, 50);
    doc.text(`Home Group Members: ${members.filter(m => m.homegroup === 'yes').length}`, 20, 56);
    doc.text(`Active Servants: ${members.filter(m => m.isServant === 'yes').length}`, 20, 62);
    doc.text(`Newcomers: ${members.filter(m => m.newcomer === 'yes').length}`, 20, 68);
    doc.setFontSize(14);
    doc.text("Engagement Metrics", 14, 80);
    doc.setFontSize(10);
    const recentEvents = events.filter(e => {
        const eventDate = new Date(e.date);
        const ninetyDaysAgo = new Date();
        ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);
        return eventDate >= ninetyDaysAgo;
    });
    doc.text(`Events (Last 90 Days): ${recentEvents.length}`, 20, 88);
    const recentGC = gcLog.filter(g => {
        const gcDate = new Date(g.date);
        const ninetyDaysAgo = new Date();
        ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);
        return gcDate >= ninetyDaysAgo;
    });
    doc.text(`GC Decisions (Last 90 Days): ${recentGC.length}`, 20, 94);
    doc.text(`Passed: ${recentGC.filter(g => g.status === 'passed').length}`, 20, 100);
    doc.text(`Failed: ${recentGC.filter(g => g.status === 'failed').length}`, 20, 106);
    doc.save('Analytics_Dashboard.pdf');
    showToast('Analytics Dashboard PDF generated!', 'success');
}
function exportAttendanceReportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const events = storage.getEvents().filter(e => e.type === 'meeting');
    doc.setFontSize(20);
    doc.text("Attendance Report", 14, 22);
    doc.setFontSize(10);
    doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 30);
    doc.text(`Total Meetings: ${events.length}`, 14, 36);
    const recentMeetings = events.slice(-20).reverse();
    const tableData = recentMeetings.map(e => [
        new Date(e.date).toLocaleDateString(),
        e.name || 'Regular Meeting',
        e.attendance?.toString() || 'N/A'
    ]);
    doc.autoTable({
        head: [['Date', 'Meeting', 'Attendance']],
        body: tableData,
        startY: 42,
        headStyles: { fillColor: [52, 152, 219] }
    });
    doc.save('Attendance_Report.pdf');
    showToast('Attendance Report PDF generated!', 'success');
}
function exportBudgetReportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const categories = storage.getBudgetCategories();
    const expenses = storage.getExpenses();
    doc.setFontSize(20);
    doc.text("Budget vs Actual Report", 14, 22);
    doc.setFontSize(10);
    doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 30);
    const tableData = categories.map(cat => {
        const spent = expenses
            .filter(e => e.category === cat.name)
            .reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
        const budget = parseFloat(cat.amount || 0);
        const remaining = budget - spent;
        const percent = budget > 0 ? ((spent / budget) * 100).toFixed(1) : '0';
        return [
            cat.name,
            `$${budget.toFixed(2)}`,
            `$${spent.toFixed(2)}`,
            `$${remaining.toFixed(2)}`,
            `${percent}%`
        ];
    });
    doc.autoTable({
        head: [['Category', 'Budget', 'Spent', 'Remaining', '% Used']],
        body: tableData,
        startY: 36,
        headStyles: { fillColor: [241, 196, 15] }
    });
    doc.save('Budget_Report.pdf');
    showToast('Budget Report PDF generated!', 'success');
}
function exportDistrictAreaReportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const facilities = storage.getFacilities() || [];
    const professionals = storage.getProfessionals() || [];
    const mediaContacts = storage.getMediaContacts() || [];
    doc.setFontSize(22);
    doc.setTextColor(142, 68, 173);
    doc.text("District & Area Service Report", 14, 22);
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(10);
    doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 30);
    doc.setFontSize(14);
    doc.text("H&I Panel Summary", 14, 42);
    doc.setFontSize(10);
    doc.text(`Total Facilities: ${facilities.length}`, 20, 50);
    doc.text(`Active Facilities: ${facilities.filter(f => f.status === 'active').length}`, 20, 56);
    doc.setFontSize(14);
    doc.text("CPC (Cooperation with Professional Community)", 14, 68);
    doc.setFontSize(10);
    doc.text(`Professional Contacts: ${professionals.length}`, 20, 76);
    doc.text(`Active Contacts: ${professionals.filter(p => p.status === 'active').length}`, 20, 82);
    doc.setFontSize(14);
    doc.text("PI (Public Information)", 14, 94);
    doc.setFontSize(10);
    doc.text(`Media Contacts: ${mediaContacts.length}`, 20, 102);
    if (facilities.length > 0) {
        doc.setFontSize(14);
        doc.text("H&I Facilities Detail", 14, 118);
        const facilityData = facilities.slice(0, 15).map(f => [
            f.name || 'N/A',
            f.type || 'N/A',
            f.status || 'N/A'
        ]);
        doc.autoTable({
            head: [['Facility Name', 'Type', 'Status']],
            body: facilityData,
            startY: 122,
            styles: { fontSize: 9 },
            headStyles: { fillColor: [142, 68, 173] }
        });
    }
    doc.save('District_Area_Service_Report.pdf');
    showToast('District & Area Service Report PDF generated!', 'success');
}
function exportFinancialAnalyticsPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const expenses = storage.getExpenses() || [];
    const categories = storage.getBudgetCategories() || [];
    doc.setFontSize(22);
    doc.setTextColor(241, 196, 15);
    doc.text("Financial Analytics Report", 14, 22);
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(10);
    doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 30);
    doc.setFontSize(14);
    doc.text("Financial Summary", 14, 42);
    const totalExpenses = expenses.reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
    const totalBudget = categories.reduce((sum, c) => sum + parseFloat(c.amount || 0), 0);
    doc.setFontSize(10);
    doc.text(`Total Annual Budget: $${(totalBudget * 12).toFixed(2)}`, 20, 50);
    doc.text(`Year-to-Date Expenses: $${totalExpenses.toFixed(2)}`, 20, 56);
    doc.text(`Remaining Budget: $${((totalBudget * 12) - totalExpenses).toFixed(2)}`, 20, 62);
    doc.setFontSize(14);
    doc.text("Expenses by Category", 14, 74);
    const categoryTotals = {};
    expenses.forEach(e => {
        const cat = e.category || 'Uncategorized';
        if (!categoryTotals[cat]) categoryTotals[cat] = 0;
        categoryTotals[cat] += parseFloat(e.amount || 0);
    });
    const expenseData = Object.entries(categoryTotals)
        .sort((a, b) => b[1] - a[1])
        .map(([cat, amount]) => [cat, `$${amount.toFixed(2)}`]);
    doc.autoTable({
        head: [['Category', 'Total Spent']],
        body: expenseData,
        startY: 78,
        headStyles: { fillColor: [241, 196, 15] }
    });
    doc.save('Financial_Analytics.pdf');
    showToast('Financial Analytics PDF generated!', 'success');
}
function exportQuarterlyReportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const expenses = storage.getExpenses() || [];
    const categories = storage.getBudgetCategories() || [];
    const quarter = document.getElementById('quarter-select')?.value || 'Q1 (Jan-Mar)';
    const year = document.getElementById('quarter-year')?.value || new Date().getFullYear();
    doc.setFontSize(22);
    doc.setTextColor(41, 128, 185);
    doc.text(`Quarterly Financial Report - ${quarter} ${year}`, 14, 22);
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(10);
    doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 30);
    doc.setFontSize(14);
    doc.text("Financial Summary", 14, 42);
    const totalExpenses = expenses.reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
    const totalBudget = categories.reduce((sum, c) => sum + parseFloat(c.amount || 0), 0);
    doc.setFontSize(10);
    doc.text(`Total Quarterly Budget: $${(totalBudget * 3).toFixed(2)}`, 20, 50);
    doc.text(`Total Expenses This Quarter: $${totalExpenses.toFixed(2)}`, 20, 56);
    doc.text(`Remaining Budget: $${((totalBudget * 3) - totalExpenses).toFixed(2)}`, 20, 62);
    doc.text(`Budget Utilization: ${totalBudget > 0 ? ((totalExpenses / (totalBudget * 3)) * 100).toFixed(1) : '0'}%`, 20, 68);
    doc.setFontSize(14);
    doc.text("Expense Breakdown by Category", 14, 80);
    const categoryTotals = {};
    expenses.forEach(e => {
        const cat = e.category || 'Uncategorized';
        if (!categoryTotals[cat]) categoryTotals[cat] = 0;
        categoryTotals[cat] += parseFloat(e.amount || 0);
    });
    const expenseData = Object.entries(categoryTotals)
        .sort((a, b) => b[1] - a[1])
        .map(([cat, amount]) => {
            const budgetCat = categories.find(c => c.name === cat);
            const budget = budgetCat ? parseFloat(budgetCat.amount || 0) * 3 : 0;
            const variance = budget - amount;
            return [cat, `$${amount.toFixed(2)}`, `$${budget.toFixed(2)}`, `$${variance.toFixed(2)}`];
        });
    doc.autoTable({
        head: [['Category', 'Actual', 'Budget', 'Variance']],
        body: expenseData,
        startY: 84,
        headStyles: { fillColor: [41, 128, 185] }
    });
    const finalY = doc.lastAutoTable.finalY || 84;
    doc.setFontSize(12);
    doc.text("Recommendations:", 14, finalY + 15);
    doc.setFontSize(10);
    const overBudget = expenseData.filter(e => parseFloat(e[3].replace('$', '').replace('-', '')) < 0);
    if (overBudget.length > 0) {
        doc.text(`• ${overBudget.length} category(ies) over budget - review necessary`, 20, finalY + 22);
    } else {
        doc.text("• All categories within budget", 20, finalY + 22);
    }
    doc.save(`Quarterly_Report_${quarter.replace(/\s+/g, '_')}_${year}.pdf`);
    showToast('Quarterly Report PDF generated!', 'success');
}
function exportSponsorshipReportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const members = storage.getMembers() || [];
    const sponsorships = members.filter(m => m.sponsor || m.isServant === 'yes');
    doc.setFontSize(22);
    doc.setTextColor(26, 188, 156);
    doc.text("Sponsorship Network Report", 14, 22);
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(10);
    doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 30);
    doc.text(`Total Members: ${members.length}`, 14, 36);
    doc.text(`Members with Sponsors: ${members.filter(m => m.sponsor).length}`, 14, 42);
    doc.text(`Active Sponsors: ${sponsorships.filter(m => m.isServant === 'yes').length}`, 14, 48);
    doc.setFontSize(14);
    doc.text("Sponsorship Relationships", 14, 60);
    const sponsorData = members
        .filter(m => m.sponsor)
        .map(m => [
            m.name || 'N/A',
            m.sponsor || 'N/A',
            m.stepProgress || 'Not Started',
            m.lastContact || 'N/A'
        ]);
    if (sponsorData.length > 0) {
        doc.autoTable({
            head: [['Sponsee', 'Sponsor', 'Step Progress', 'Last Contact']],
            body: sponsorData,
            startY: 64,
            headStyles: { fillColor: [26, 188, 156] },
            styles: { fontSize: 9 }
        });
    } else {
        doc.text("No sponsorship relationships recorded", 20, 70);
    }
    const finalY = doc.lastAutoTable?.finalY || 70;
    doc.setFontSize(14);
    doc.text("Sponsorship Statistics", 14, finalY + 15);
    doc.setFontSize(10);
    const avgSponsees = members.filter(m => m.isServant === 'yes').length > 0
        ? (members.filter(m => m.sponsor).length / members.filter(m => m.isServant === 'yes').length).toFixed(1)
        : '0';
    doc.text(`Average sponsees per sponsor: ${avgSponsees}`, 20, finalY + 22);
    doc.text(`Sponsorship coverage: ${((members.filter(m => m.sponsor).length / members.length) * 100).toFixed(1)}%`, 20, finalY + 28);
    doc.save('Sponsorship_Network_Report.pdf');
    showToast('Sponsorship Report PDF generated!', 'success');
}
function exportSpecialEventsPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const events = storage.getEventsMgmt() || [];
    const speakers = storage.getSpeakers() || [];
    const volunteers = storage.getEventVolunteers() || [];
    doc.setFontSize(22);
    doc.setTextColor(155, 89, 182);
    doc.text("Special Events Report", 14, 22);
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(10);
    doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 30);
    doc.text(`Total Events: ${events.length}`, 14, 36);
    doc.text(`Upcoming Events: ${events.filter(e => new Date(e.date) > new Date()).length}`, 14, 42);
    doc.text(`Total Speakers Booked: ${speakers.length}`, 14, 48);
    doc.text(`Total Volunteers: ${volunteers.length}`, 14, 54);
    doc.setFontSize(14);
    doc.text("Event Schedule", 14, 66);
    const eventData = events
        .sort((a, b) => new Date(a.date) - new Date(b.date))
        .slice(0, 15)
        .map(e => [
            e.name || 'N/A',
            new Date(e.date).toLocaleDateString(),
            e.venue || 'N/A',
            e.expectedAttendance?.toString() || 'N/A',
            e.budget ? `$${parseFloat(e.budget).toFixed(2)}` : 'N/A'
        ]);
    if (eventData.length > 0) {
        doc.autoTable({
            head: [['Event Name', 'Date', 'Venue', 'Expected', 'Budget']],
            body: eventData,
            startY: 70,
            headStyles: { fillColor: [155, 89, 182] },
            styles: { fontSize: 9 }
        });
    } else {
        doc.text("No events scheduled", 20, 75);
    }
    const finalY = doc.lastAutoTable?.finalY || 75;
    if (speakers.length > 0) {
        doc.setFontSize(14);
        doc.text("Booked Speakers", 14, finalY + 15);
        const speakerData = speakers.slice(0, 10).map(s => [
            s.name || 'N/A',
            s.topic || 'N/A',
            s.date ? new Date(s.date).toLocaleDateString() : 'TBD'
        ]);
        doc.autoTable({
            head: [['Speaker', 'Topic', 'Date']],
            body: speakerData,
            startY: finalY + 19,
            headStyles: { fillColor: [155, 89, 182] },
            styles: { fontSize: 9 }
        });
    }
    doc.save('Special_Events_Report.pdf');
    showToast('Special Events PDF generated!', 'success');
}
function renderMinutesArchive() {
    const minutes = storage.getMeetingMinutes().sort((a, b) => new Date(b.date) - new Date(a.date));
    const list = document.getElementById('minutes-archive-list');
    if (minutes.length === 0) {
        list.innerHTML = '<p style="opacity: 0.7;">No minutes archived yet</p>';
        return;
    }
    list.innerHTML = minutes.map(m => `
        <div style="padding: 0.75rem; background: #2c3e50; border-radius: 4px; margin-bottom: 0.5rem; cursor: pointer;" onclick="loadMinutes('${escapeAttribute(m.id)}')">
            <strong>${new Date(m.date).toLocaleDateString()}</strong>
            <span style="background: ${m.status === 'approved' ? '#27ae60' : '#f39c12'}; padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.75rem; margin-left: 0.5rem;">${escapeHtml(m.status)}</span>
        </div>
    `).join('');
}
function loadMinutes(id) {
    const minutes = storage.getMeetingMinutes();
    const min = minutes.find(m => m.id === id);
    if (min) {
        currentMinutesData = min;
        renderMinutesPreview(min);
    }
}
function saveSecretarySettings() {
    const name = document.getElementById('secretary-name').value;
    const autoGen = document.getElementById('auto-generate-minutes').checked;
    localStorage.setItem('secretaryName', name);
    localStorage.setItem('autoGenerateMinutes', autoGen);
    showToast('Secretary settings saved!', 'success');
}
function populateMinutesGCSelect() {
    const logs = storage.getGroupConscienceLog().sort((a, b) => new Date(b.date) - new Date(a.date));
    const select = document.getElementById('minutes-gc-select');
    if (select) {
        select.innerHTML = '<option value="">-- Select Meeting --</option>' +
            logs.map(l => `<option value="${escapeAttribute(l.id)}">${new Date(l.date).toLocaleDateString()} - ${escapeHtml(l.item.substring(0, 50))}...</option>`).join('');
    }
}
function renderParticipationAnalytics() {
    const logs = storage.getGroupConscienceLog();
    const members = storage.getMembers();
    const recentLogs = logs.slice(-6);
    const avgAttendance = recentLogs.length > 0
        ? Math.round(recentLogs.reduce((sum, l) => sum + (l.attendees || []).length, 0) / recentLogs.length)
        : 0;
    const totalVotes = logs.reduce((sum, l) => sum + (l.votesFor || 0) + (l.votesAgainst || 0) + (l.votesAbstain || 0), 0);
    const potentialVotes = logs.length * members.length;
    const votingParticipation = potentialVotes > 0 ? ((totalVotes / potentialVotes) * 100).toFixed(1) : 0;
    const engagementScore = Math.min(100, Math.round((avgAttendance / Math.max(members.length, 1)) * 100));
    document.getElementById('avg-attendance').textContent = avgAttendance;
    document.getElementById('voting-participation').textContent = votingParticipation + '%';
    document.getElementById('avg-meeting-length').textContent = '90'; // Placeholder
    document.getElementById('engagement-score').textContent = engagementScore + '%';
}
function saveDecisionImpact() {
    const gcId = document.getElementById('impact-gc-motion').value;
    const months = parseInt(document.getElementById('impact-months').value) || 0;
    const achieved = document.getElementById('impact-achieved').value;
    const rating = parseInt(document.getElementById('impact-rating').value) || 3;
    const lessons = document.getElementById('impact-lessons').value.trim();
    if (!gcId) {
        showToast('Please select a motion', 'error');
        return;
    }
    const logs = storage.getGroupConscienceLog();
    const motion = logs.find(l => l.id === gcId);
    const category = categorizeLesson(motion ? motion.item : '');
    const impacts = storage.getDecisionImpacts();
    impacts.push({
        id: genId(),
        gcId,
        motionText: motion ? motion.item : '',
        months,
        achieved,
        rating,
        lessons,
        category: category,
        assessmentDate: new Date().toISOString()
    });
    storage.saveDecisionImpacts(impacts);
    showToast('Impact assessment saved!', 'success');
    document.getElementById('impact-lessons').value = '';
    renderDecisionImpacts();
    searchLessonsLearned(); // Update institutional memory
}
function renderDecisionImpacts() {
    const impacts = storage.getDecisionImpacts().sort((a, b) => new Date(b.assessmentDate) - new Date(a.assessmentDate));
    const list = document.getElementById('impact-list');
    const insightsDiv = document.getElementById('decision-insights');
    if (!list || !insightsDiv) {
        return;
    }
    if (impacts.length === 0) {
        list.innerHTML = '<p style="opacity: 0.7;">No impact assessments yet</p>';
        return;
    }
    list.innerHTML = impacts.map(i => `
        <div style="padding: 1rem; background: #2c3e50; border-radius: 4px; margin-bottom: 0.5rem;">
            <p style="font-size: 0.9rem;"><strong>${escapeHtml(i.motionText)}</strong></p>
            <div style="margin-top: 0.5rem; font-size: 0.85rem;">
                <span style="color: ${i.achieved === 'yes' ? '#2ecc71' : i.achieved === 'no' ? '#e74c3c' : '#f39c12'};">
                    Goal: ${i.achieved === 'yes' ? '✓ Achieved' : i.achieved === 'no' ? '✗ Not Achieved' : '⊙ Partial'}
                </span>
                <span style="margin-left: 1rem;">Rating: ${'★'.repeat(i.rating)}${'☆'.repeat(5 - i.rating)}</span>
            </div>
            <p style="margin-top: 0.5rem; font-size: 0.85rem; opacity: 0.8;">${escapeHtml(i.lessons)}</p>
        </div>
    `).join('');
    const avgRating = impacts.length > 0
        ? (impacts.reduce((sum, i) => sum + i.rating, 0) / impacts.length).toFixed(1)
        : 0;
    const achievedCount = impacts.filter(i => i.achieved === 'yes').length;
    insightsDiv.innerHTML = `
        <p><strong>Average Decision Rating:</strong> ${avgRating}/5 ★</p>
        <p><strong>Goals Fully Achieved:</strong> ${achievedCount} of ${impacts.length} (${impacts.length > 0 ? Math.round((achievedCount / impacts.length) * 100) : 0}%)</p>
        <p style="margin-top: 1rem; font-size: 0.9rem; opacity: 0.8;">Groups that track decision impacts tend to make better decisions over time.</p>
    `;
}
function populateImpactGCMotions() {
    const logs = storage.getGroupConscienceLog();
    const select = document.getElementById('impact-gc-motion');
    if (select) {
        select.innerHTML = '<option value="">-- Select Motion --</option>' +
            logs.map(l => {
                const date = new Date(l.date).toLocaleDateString();
                const preview = l.item.substring(0, 60) + (l.item.length > 60 ? '...' : '');
                return `<option value="${escapeAttribute(l.id)}" data-text="${escapeAttribute(l.item)}">${escapeHtml(date)} - ${escapeHtml(preview)}</option>`;
            }).join('');
    }
}
function renderFinancialHealth() {
    const balance = calculateCurrentBalance();
    const reserve = calculatePrudentReserveAmount();
    const health = calculateContributionHealth();
    document.getElementById('current-balance').textContent = '$' + balance.toFixed(2);
    document.getElementById('prudent-reserve').textContent = '$' + reserve.toFixed(2);
    document.getElementById('contribution-health').textContent = health.toFixed(0) + '%';
}
function calculateCurrentBalance() {
    const expenses = storage.getExpenses();
    const chairpersonLogs = storage.getChairpersonLog();
    const totalIncome = chairpersonLogs.reduce((sum, log) => {
        return sum + (parseFloat(log.tradition) || 0) + (parseFloat(log.orangeCan) || 0);
    }, 0);
    const totalExpenses = expenses.reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
    return totalIncome - totalExpenses;
}
function calculatePrudentReserveAmount() {
    const expenses = storage.getExpenses();
    const threeMonthsAgo = new Date();
    threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
    const recentExpenses = expenses.filter(e => new Date(e.date) >= threeMonthsAgo);
    const avgMonthlyExpenses = recentExpenses.reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0) / 3;
    return avgMonthlyExpenses * 3; // 3 months prudent reserve
}
function calculateContributionHealth() {
    const chairpersonLogs = storage.getChairpersonLog();
    if (chairpersonLogs.length === 0) return 0;
    const sixMonthsAgo = new Date();
    sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
    const recentLogs = chairpersonLogs.filter(log => new Date(log.date) >= sixMonthsAgo);
    if (recentLogs.length === 0) return 0;
    const avgContribution = recentLogs.reduce((sum, log) => {
        return sum + (parseFloat(log.tradition) || 0);
    }, 0) / recentLogs.length;
    const healthyTarget = 100;
    return Math.min(100, (avgContribution / healthyTarget) * 100);
}
function calculateAffordability() {
    const amount = parseFloat(document.getElementById('afford-amount').value) || 0;
    const category = document.getElementById('afford-category').value;
    const balance = calculateCurrentBalance();
    const reserve = calculatePrudentReserveAmount();
    let annualizedCost = amount;
    if (category === 'monthly') annualizedCost = amount * 12;
    if (category === 'annual') annualizedCost = amount;
    const afterExpense = balance - amount;
    const canAfford = afterExpense >= reserve;
    const result = document.getElementById('affordability-result');
    result.style.display = 'block';
    result.style.padding = '1rem';
    result.style.borderRadius = '6px';
    result.style.background = canAfford ? '#27ae60' : '#e74c3c';
    result.innerHTML = `
        <h4>${canAfford ? '✓ We CAN afford this' : '✗ We CANNOT afford this'}</h4>
        <p><strong>Current Balance:</strong> $${balance.toFixed(2)}</p>
        <p><strong>After Expense:</strong> $${afterExpense.toFixed(2)}</p>
        <p><strong>Prudent Reserve:</strong> $${reserve.toFixed(2)}</p>
        <p><strong>Remaining Above Reserve:</strong> $${Math.max(0, afterExpense - reserve).toFixed(2)}</p>
        ${!canAfford ? '<p style="color: #f1c40f; margin-top: 0.5rem;"><strong>Warning:</strong> This would put us below prudent reserve!</p>' : ''}
    `;
}
let projectionChart = null;
function runFinancialProjection() {
    const amount = parseFloat(document.getElementById('projection-amount').value) || 0;
    const type = document.getElementById('projection-type').value;
    const period = parseInt(document.getElementById('projection-period').value);
    const revenueType = document.getElementById('projection-revenue-type').value;
    const revenueAmount = parseFloat(document.getElementById('projection-revenue-amount').value) || 0;
    if (amount <= 0) {
        showToast('Please enter a valid amount', 'error');
        return;
    }
    const logs = storage.getChairpersonLog();
    const recentLogs = logs.slice(-6); // Last 6 entries
    const avgContribution = recentLogs.length > 0
        ? recentLogs.reduce((sum, l) => sum + (parseFloat(l.seventhTradition) || 0), 0) / recentLogs.length
        : 100; // Default $100/meeting
    const monthlyIncome = avgContribution * 4;
    let currentBalance = calculateCurrentBalance();
    const projections = [];
    let balance = currentBalance;
    for (let month = 0; month <= period; month++) {
        let monthlyExpense = 0;
        if (type === 'oneTime' && month === 0) {
            monthlyExpense = amount;
        } else if (type === 'monthly') {
            monthlyExpense = amount;
        } else if (type === 'annual') {
            monthlyExpense = month % 12 === 0 ? amount : 0;
        }
        let monthlyRevenue = monthlyIncome;
        if (revenueType === 'increase') {
            monthlyRevenue += revenueAmount;
        } else if (revenueType === 'decrease') {
            monthlyRevenue -= revenueAmount;
        }
        balance = balance + monthlyRevenue - monthlyExpense;
        projections.push({
            month: month,
            balance: balance,
            revenue: monthlyRevenue,
            expense: monthlyExpense
        });
    }
    const finalBalance = projections[projections.length - 1].balance;
    const totalExpense = projections.reduce((sum, p) => sum + p.expense, 0);
    const totalRevenue = projections.reduce((sum, p) => sum + p.revenue, 0);
    const prudentReserve = monthlyIncome * 3; // 3 months operating
    const summaryDiv = document.getElementById('projection-summary');
    summaryDiv.style.display = 'block';
    const belowReserve = finalBalance < prudentReserve;
    summaryDiv.style.borderLeft = `4px solid ${belowReserve ? '#e74c3c' : '#2ecc71'}`;
    summaryDiv.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; text-align: center;">
            <div>
                <div style="font-size: 1.5rem; font-weight: bold; color: ${finalBalance > currentBalance ? '#2ecc71' : '#e74c3c'};">
                    $${finalBalance.toFixed(2)}
                </div>
                <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.25rem;">Final Balance</div>
            </div>
            <div>
                <div style="font-size: 1.5rem; font-weight: bold; color: #3498db;">
                    $${totalRevenue.toFixed(2)}
                </div>
                <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.25rem;">Total Revenue</div>
            </div>
            <div>
                <div style="font-size: 1.5rem; font-weight: bold; color: #e74c3c;">
                    $${totalExpense.toFixed(2)}
                </div>
                <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.25rem;">Total Expense</div>
            </div>
            <div>
                <div style="font-size: 1.5rem; font-weight: bold; color: ${!belowReserve ? '#2ecc71' : '#f39c12'};">
                    ${!belowReserve ? '✓' : '⚠'}
                </div>
                <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.25rem;">Reserve Status</div>
            </div>
        </div>
        ${belowReserve ? `<p style="color: #f39c12; margin-top: 0.75rem; font-size: 0.85rem;"><strong>⚠ Warning:</strong> This decision would put the group below prudent reserve ($${prudentReserve.toFixed(2)}) by month ${projections.findIndex(p => p.balance < prudentReserve)}.</p>` : ''}
    `;
    const chartCanvas = document.getElementById('projection-chart');
    chartCanvas.style.display = 'block';
    if (projectionChart) {
        projectionChart.destroy();
    }
    const ctx = chartCanvas.getContext('2d');
    projectionChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: projections.map(p => `Month ${p.month}`),
            datasets: [
                {
                    label: 'Projected Balance',
                    data: projections.map(p => p.balance),
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    tension: 0.3,
                    fill: true
                },
                {
                    label: 'Prudent Reserve',
                    data: projections.map(() => prudentReserve),
                    borderColor: '#2ecc71',
                    borderDash: [5, 5],
                    fill: false,
                    pointRadius: 0
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    labels: { color: '#ecf0f1' }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': $' + context.parsed.y.toFixed(2);
                        }
                    }
                }
            },
            scales: {
                x: {
                    ticks: { color: '#ecf0f1' },
                    grid: { color: 'rgba(127, 140, 141, 0.2)' }
                },
                y: {
                    ticks: {
                        color: '#ecf0f1',
                        callback: function(value) {
                            return '$' + value.toFixed(0);
                        }
                    },
                    grid: { color: 'rgba(127, 140, 141, 0.2)' }
                }
            }
        }
    });
    const insightsDiv = document.getElementById('projection-insights');
    const netChange = finalBalance - currentBalance;
    insightsDiv.innerHTML = `
        <h4 style="margin-bottom: 0.5rem;">Key Insights</h4>
        <ul style="list-style: none; padding: 0;">
            <li style="padding: 0.5rem; background: #34495e; margin-bottom: 0.5rem; border-radius: 4px;">
                <strong>Net Change:</strong> ${netChange >= 0 ? '+' : ''}$${netChange.toFixed(2)} over ${period} months
            </li>
            <li style="padding: 0.5rem; background: #34495e; margin-bottom: 0.5rem; border-radius: 4px;">
                <strong>Monthly Impact:</strong> ${type === 'monthly' ? `Ongoing -$${amount.toFixed(2)}/month` : type === 'oneTime' ? 'One-time expense' : `-$${amount.toFixed(2)}/year`}
            </li>
            <li style="padding: 0.5rem; background: #34495e; margin-bottom: 0.5rem; border-radius: 4px;">
                <strong>Reserve Cushion:</strong> ${!belowReserve ? `Maintains $${(finalBalance - prudentReserve).toFixed(2)} above reserve` : `Falls below reserve`}
            </li>
            ${revenueType !== 'none' ? `
            <li style="padding: 0.5rem; background: #34495e; margin-bottom: 0.5rem; border-radius: 4px;">
                <strong>Revenue Assumption:</strong> ${revenueType === 'increase' ? 'Increases' : 'Decreases'} by $${revenueAmount.toFixed(2)}/month
            </li>
            ` : ''}
        </ul>
        <p style="margin-top: 1rem; font-size: 0.85rem; opacity: 0.7; font-style: italic;">
            💡 These projections assume current contribution levels remain stable. Actual results may vary.
        </p>
    `;
}
function categorizeLesson(motionText) {
    const text = motionText.toLowerCase();
    if (text.includes('budget') || text.includes('money') || text.includes('expense') || text.includes('contribution') || text.includes('financial') || text.includes('$')) {
        return 'financial';
    } else if (text.includes('service') || text.includes('gsr') || text.includes('secretary') || text.includes('treasurer') || text.includes('position')) {
        return 'service';
    } else if (text.includes('meeting') || text.includes('format') || text.includes('schedule') || text.includes('time')) {
        return 'meeting';
    } else if (text.includes('tradition') || text.includes('concept') || text.includes('warranty')) {
        return 'traditions';
    } else if (text.includes('fellowship') || text.includes('social') || text.includes('event')) {
        return 'fellowship';
    } else {
        return 'other';
    }
}
function searchLessonsLearned() {
    const searchInput = document.getElementById('memory-search');
    const categorySelect = document.getElementById('memory-category-filter');
    const ratingSelect = document.getElementById('memory-rating-filter');
    if (!searchInput || !categorySelect || !ratingSelect) {
        return;
    }
    const searchTerm = searchInput.value.toLowerCase();
    const categoryFilter = categorySelect.value;
    const ratingFilter = ratingSelect.value;
    let impacts = storage.getDecisionImpacts();
    if (searchTerm) {
        impacts = impacts.filter(i =>
            (i.motionText && i.motionText.toLowerCase().includes(searchTerm)) ||
            (i.lessons && i.lessons.toLowerCase().includes(searchTerm))
        );
    }
    if (categoryFilter) {
        impacts = impacts.filter(i => i.category === categoryFilter);
    }
    if (ratingFilter) {
        impacts = impacts.filter(i => i.rating === parseInt(ratingFilter));
    }
    impacts.sort((a, b) => new Date(b.assessmentDate) - new Date(a.assessmentDate));
    const listDiv = document.getElementById('lessons-list');
    if (!listDiv) {
        return;
    }
    if (impacts.length === 0) {
        listDiv.innerHTML = '<p style="opacity: 0.7; text-align: center; padding: 2rem;">No lessons match your search criteria.</p>';
    } else {
        listDiv.innerHTML = impacts.map(i => {
            const date = new Date(i.assessmentDate).toLocaleDateString();
            const categoryColors = {
                financial: '#f39c12',
                service: '#3498db',
                meeting: '#9b59b6',
                fellowship: '#e74c3c',
                traditions: '#2ecc71',
                other: '#95a5a6'
            };
            return `
                <div style="padding: 1rem; background: #2c3e50; border-radius: 4px; margin-bottom: 0.75rem; border-left: 4px solid ${categoryColors[i.category] || '#95a5a6'};">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                        <span style="font-size: 0.75rem; background: ${categoryColors[i.category] || '#95a5a6'}; padding: 0.2rem 0.5rem; border-radius: 3px;">
                            ${i.category ? i.category.charAt(0).toUpperCase() + i.category.slice(1) : 'Other'}
                        </span>
                        <span style="font-size: 0.75rem; opacity: 0.7;">${date}</span>
                    </div>
                    <p style="font-size: 0.9rem; font-weight: bold; margin-bottom: 0.5rem;">${escapeHtml(i.motionText)}</p>
                    <div style="margin-bottom: 0.5rem;">
                        <span style="font-size: 0.85rem;">Rating: ${'★'.repeat(i.rating)}${'☆'.repeat(5 - i.rating)}</span>
                        <span style="margin-left: 1rem; font-size: 0.85rem; color: ${i.achieved === 'yes' ? '#2ecc71' : i.achieved === 'no' ? '#e74c3c' : '#f39c12'};">
                            ${i.achieved === 'yes' ? '✓ Achieved' : i.achieved === 'no' ? '✗ Not Achieved' : '⊙ Partial'}
                        </span>
                    </div>
                    <p style="font-size: 0.85rem; opacity: 0.9; font-style: italic; background: #34495e; padding: 0.5rem; border-radius: 3px; margin-top: 0.5rem;">
                        "${escapeHtml(i.lessons)}"
                    </p>
                </div>
            `;
        }).join('');
    }
    updateMemoryStats();
    generatePatternInsights();
}
function updateMemoryStats() {
    const totalLessonsEl = document.getElementById('total-lessons');
    const avgRatingEl = document.getElementById('avg-lesson-rating');
    const commonCategoryEl = document.getElementById('common-category');
    if (!totalLessonsEl || !avgRatingEl || !commonCategoryEl) {
        return;
    }
    const impacts = storage.getDecisionImpacts();
    totalLessonsEl.textContent = impacts.length;
    const avgRating = impacts.length > 0
        ? (impacts.reduce((sum, i) => sum + i.rating, 0) / impacts.length).toFixed(1)
        : '--';
    avgRatingEl.textContent = avgRating;
    const categoryCounts = {};
    impacts.forEach(i => {
        const cat = i.category || 'other';
        categoryCounts[cat] = (categoryCounts[cat] || 0) + 1;
    });
    const mostCommon = Object.entries(categoryCounts).sort((a, b) => b[1] - a[1])[0];
    commonCategoryEl.textContent = mostCommon
        ? `${mostCommon[0].charAt(0).toUpperCase() + mostCommon[0].slice(1)} (${mostCommon[1]})`
        : '--';
}
function generatePatternInsights() {
    const impacts = storage.getDecisionImpacts();
    const insightsDiv = document.getElementById('pattern-insights');
    if (!insightsDiv) {
        return;
    }
    if (impacts.length < 3) {
        insightsDiv.innerHTML = '<p style="opacity: 0.7;">Patterns will appear here once you have 3 or more lessons logged.</p>';
        return;
    }
    const patterns = [];
    const financialDecisions = impacts.filter(i => i.category === 'financial');
    if (financialDecisions.length >= 2) {
        const successRate = (financialDecisions.filter(i => i.achieved === 'yes').length / financialDecisions.length) * 100;
        patterns.push(`💰 Financial decisions have a ${successRate.toFixed(0)}% success rate (${financialDecisions.length} decisions tracked)`);
    }
    const serviceDecisions = impacts.filter(i => i.category === 'service');
    if (serviceDecisions.length >= 2) {
        const avgRating = serviceDecisions.reduce((sum, i) => sum + i.rating, 0) / serviceDecisions.length;
        patterns.push(`🤝 Service structure decisions average ${avgRating.toFixed(1)}/5 stars (${serviceDecisions.length} decisions)`);
    }
    const highRatedDecisions = impacts.filter(i => i.rating >= 4);
    if (highRatedDecisions.length >= 2) {
        patterns.push(`⭐ ${highRatedDecisions.length} decisions rated 4+ stars - review their lessons for best practices`);
    }
    const lowRatedDecisions = impacts.filter(i => i.rating <= 2);
    if (lowRatedDecisions.length >= 1) {
        patterns.push(`⚠️ ${lowRatedDecisions.length} decision(s) rated 2 stars or lower - consider reviewing or reversing`);
    }
    const recentDecisions = impacts.slice(-5);
    const recentAvgRating = recentDecisions.reduce((sum, i) => sum + i.rating, 0) / recentDecisions.length;
    const olderDecisions = impacts.slice(0, -5);
    if (olderDecisions.length > 0) {
        const olderAvgRating = olderDecisions.reduce((sum, i) => sum + i.rating, 0) / olderDecisions.length;
        if (recentAvgRating > olderAvgRating + 0.5) {
            patterns.push(`📈 Decision quality is improving! Recent avg: ${recentAvgRating.toFixed(1)} vs historical: ${olderAvgRating.toFixed(1)}`);
        } else if (recentAvgRating < olderAvgRating - 0.5) {
            patterns.push(`📉 Decision quality declining. Recent avg: ${recentAvgRating.toFixed(1)} vs historical: ${olderAvgRating.toFixed(1)}`);
        }
    }
    insightsDiv.innerHTML = patterns.length > 0
        ? '<ul style="list-style: none; padding: 0;">' +
          patterns.map(p => `<li style="padding: 0.5rem 0; border-bottom: 1px solid #34495e;">${p}</li>`).join('') +
          '</ul>'
        : '<p style="opacity: 0.7;">No significant patterns detected yet. Keep logging lessons to discover insights!</p>';
}
function scheduleInventory() {
    const type = document.getElementById('inventory-type').value;
    const customName = document.getElementById('inventory-custom-name').value.trim();
    const date = document.getElementById('inventory-scheduled-date').value;
    const frequency = document.getElementById('inventory-frequency').value;
    const notes = document.getElementById('inventory-notes').value.trim();
    if (!date) {
        showToast('Please select a date', 'error');
        return;
    }
    const name = type === 'custom' ? customName : type;
    const schedules = storage.getInventorySchedules();
    schedules.push({
        id: genId(),
        type,
        name,
        scheduledDate: date,
        frequency,
        notes,
        status: 'scheduled',
        createdDate: new Date().toISOString()
    });
    storage.saveInventorySchedules(schedules);
    showToast('Inventory scheduled!', 'success');
    document.getElementById('inventory-notes').value = '';
    renderInventorySchedules();
}
function renderInventorySchedules() {
    const schedules = storage.getInventorySchedules();
    const upcoming = schedules.filter(s => s.status === 'scheduled' && new Date(s.scheduledDate) >= new Date());
    const completed = schedules.filter(s => s.status === 'completed');
    const upcomingList = document.getElementById('upcoming-inventories-list');
    const completedList = document.getElementById('completed-inventories-list');
    upcomingList.innerHTML = upcoming.length > 0
        ? upcoming.map(s => `
            <div style="padding: 0.75rem; background: #2c3e50; border-radius: 4px; margin-bottom: 0.5rem;">
                <strong>${escapeHtml(s.name)}</strong><br>
                <span style="font-size: 0.85rem;">Date: ${new Date(s.scheduledDate).toLocaleDateString()}</span><br>
                <span style="font-size: 0.85rem;">Frequency: ${escapeHtml(s.frequency)}</span>
                <div style="margin-top: 0.5rem;">
                    <button class="btn secondary" onclick="completeInventory('${escapeAttribute(s.id)}')" style="font-size: 0.85rem;">Mark Complete</button>
                </div>
            </div>
        `).join('')
        : '<p style="opacity: 0.7;">No upcoming inventories</p>';
    completedList.innerHTML = completed.length > 0
        ? completed.map(s => `
            <div style="padding: 0.75rem; background: #27ae60; border-radius: 4px; margin-bottom: 0.5rem;">
                <strong>${escapeHtml(s.name)}</strong><br>
                <span style="font-size: 0.85rem;">Completed: ${s.completedDate ? new Date(s.completedDate).toLocaleDateString() : 'N/A'}</span>
            </div>
        `).join('')
        : '<p style="opacity: 0.7;">No completed inventories</p>';
}
function completeInventory(id) {
    let schedules = storage.getInventorySchedules();
    const schedule = schedules.find(s => s.id === id);
    if (schedule) {
        schedule.status = 'completed';
        schedule.completedDate = new Date().toISOString();
        if (schedule.frequency !== 'once') {
            const nextDate = new Date(schedule.scheduledDate);
            switch (schedule.frequency) {
                case 'quarterly': nextDate.setMonth(nextDate.getMonth() + 3); break;
                case 'semiannual': nextDate.setMonth(nextDate.getMonth() + 6); break;
                case 'annual': nextDate.setFullYear(nextDate.getFullYear() + 1); break;
            }
            schedules.push({
                ...schedule,
                id: genId(),
                scheduledDate: nextDate.toISOString().split('T')[0],
                status: 'scheduled',
                createdDate: new Date().toISOString()
            });
        }
        storage.saveInventorySchedules(schedules);
        showToast('Inventory marked complete!', 'success');
        renderInventorySchedules();
    }
}
function updateRoleView() {
    const role = document.getElementById('user-role-select').value;
    const benefits = {
        member: 'Standard view with all features',
        gsr: 'Prioritized district motions, GSR reports, and area information',
        treasurer: 'Financial dashboard, expense tracking, and budget tools highlighted',
        secretary: 'Quick access to minutes, attendance, and meeting logs',
        chairperson: 'Meeting management tools, parliamentary procedure, and agenda building',
        literature: 'Literature inventory, loans, and purchase requests prioritized'
    };
    document.getElementById('role-benefits').innerHTML = `<p>${benefits[role]}</p>`;
}
function saveUserRole() {
    const role = document.getElementById('user-role-select').value;
    storage.saveUserRole(role);
    showToast(`Role set to ${role}!`, 'success');
}
function showDashboard(role) {
    const dashboardDiv = document.getElementById('role-dashboard');
    const titleEl = document.getElementById('dashboard-title');
    const contentEl = document.getElementById('dashboard-content');
    dashboardDiv.style.display = 'block';
    const dashboards = {
        gsr: {
            title: 'GSR Dashboard',
            content: `
                <h4>District Motions Pending Response</h4>
                <div id="gsr-district-motions"></div>
                <h4 class="mt-3">Upcoming Area Events</h4>
                <p>Area Assembly: [Date TBD]</p>
                <h4 class="mt-3">Quick Actions</h4>
                <button class="btn" onclick="goToSection('district-motions-section')">Manage District Motions</button>
            `
        },
        treasurer: {
            title: 'Treasurer Dashboard',
            content: `
                <h4>Financial Summary</h4>
                <p><strong>Current Balance:</strong> $[Amount]</p>
                <p><strong>Prudent Reserve:</strong> $[Amount]</p>
                <h4 class="mt-3">Pending Expenses</h4>
                <p>Review pending expenses in Finance section</p>
                <h4 class="mt-3">Quick Actions</h4>
                <button class="btn" onclick="goToSection('finance-section')">View Finances</button>
                <button class="btn secondary ml-2" onclick="goToSection('financial-health-section')">Financial Health</button>
            `
        },
        secretary: {
            title: 'Secretary Dashboard',
            content: `
                <h4>Recent Meetings</h4>
                <p>Last GC: [Date]</p>
                <p>Draft Minutes: [Count]</p>
                <h4 class="mt-3">Quick Actions</h4>
                <button class="btn" onclick="goToSection('meeting-minutes-section')">Manage Minutes</button>
                <button class="btn secondary ml-2" onclick="goToSection('chairperson-section')">Attendance Logs</button>
            `
        },
        chairperson: {
            title: 'Chairperson Dashboard',
            content: `
                <h4>Next Meeting Preparation</h4>
                <p>Tabled items: [Count]</p>
                <p>Proposed agenda items: [Count]</p>
                <h4 class="mt-3">Quick Actions</h4>
                <button class="btn" onclick="goToSection('parliamentary-section')">Parliamentary Tools</button>
                <button class="btn secondary ml-2" onclick="goToSection('gc-live-section')">Live GC Session</button>
            `
        }
    };
    const dashboard = dashboards[role] || { title: 'Dashboard', content: '<p>Select a role to view dashboard</p>' };
    titleEl.textContent = dashboard.title;
    contentEl.innerHTML = dashboard.content;
}
function savePrivacySettings() {
    const anonymousVoting = document.getElementById('privacy-anonymous-voting');
    const hideNames = document.getElementById('privacy-hide-names-export');
    const encryptSensitive = document.getElementById('privacy-encrypt-sensitive');
    const redactLastnames = document.getElementById('privacy-redact-lastnames');
    const settings = {
        anonymousVoting: anonymousVoting ? anonymousVoting.checked : false,
        hideNamesInExports: hideNames ? hideNames.checked : false,
        encryptSensitive: encryptSensitive ? encryptSensitive.checked : false,
        autoRedactLastNames: redactLastnames ? redactLastnames.checked : false
    };
    storage.savePrivacySettings(settings);
    showToast('Privacy settings saved!', 'success');
}
function loadPrivacySettings() {
    const settings = storage.getPrivacySettings();
    const anonymousVoting = document.getElementById('privacy-anonymous-voting');
    if (anonymousVoting) anonymousVoting.checked = settings.anonymousVoting || false;
    const hideNames = document.getElementById('privacy-hide-names-export');
    if (hideNames) hideNames.checked = settings.hideNamesInExports || false;
    const encryptSensitive = document.getElementById('privacy-encrypt-sensitive');
    if (encryptSensitive) encryptSensitive.checked = settings.encryptSensitive || false;
    const redactLastnames = document.getElementById('privacy-redact-lastnames');
    if (redactLastnames) redactLastnames.checked = settings.autoRedactLastNames || false;
}
function redactName(fullName) {
    const settings = storage.getPrivacySettings();
    if (!settings.autoRedactLastNames) return fullName;
    const parts = fullName.trim().split(' ');
    if (parts.length === 1) return fullName;
    const firstName = parts[0];
    const lastInitial = parts[parts.length - 1].charAt(0);
    return `${firstName} ${lastInitial}.`;
}
const traditions = [
    { num: 1, text: "Our common welfare should come first; personal recovery depends upon A.A. unity." },
    { num: 2, text: "For our group purpose there is but one ultimate authority—a loving God as He may express Himself in our group conscience. Our leaders are but trusted servants; they do not govern." },
    { num: 3, text: "The only requirement for A.A. membership is a desire to stop drinking." },
    { num: 4, text: "Each group should be autonomous except in matters affecting other groups or A.A. as a whole." },
    { num: 5, text: "Each group has but one primary purpose—to carry its message to the alcoholic who still suffers." },
    { num: 6, text: "An A.A. group ought never endorse, finance, or lend the A.A. name to any related facility or outside enterprise, lest problems of money, property, and prestige divert us from our primary purpose." },
    { num: 7, text: "Every A.A. group ought to be fully self-supporting, declining outside contributions." },
    { num: 8, text: "Alcoholics Anonymous should remain forever nonprofessional, but our service centers may employ special workers." },
    { num: 9, text: "A.A., as such, ought never be organized; but we may create service boards or committees directly responsible to those they serve." },
    { num: 10, text: "Alcoholics Anonymous has no opinion on outside issues; hence the A.A. name ought never be drawn into public controversy." },
    { num: 11, text: "Our public relations policy is based on attraction rather than promotion; we need always maintain personal anonymity at the level of press, radio, and films." },
    { num: 12, text: "Anonymity is the spiritual foundation of all our Traditions, ever reminding us to place principles before personalities." }
];
function displayTraditionOfDay() {
    const element = document.getElementById('tradition-of-day-display');
    if (!element) return;
    const todayData = storage.getTraditionOfDay();
    const today = new Date().toDateString();
    let traditionNum;
    if (todayData.date !== today) {
        traditionNum = Math.floor(Math.random() * 12) + 1;
        storage.saveTraditionOfDay({ tradition: traditionNum, date: today });
    } else {
        traditionNum = todayData.tradition;
    }
    const tradition = traditions[traditionNum - 1];
    element.innerHTML = `
        <h4 style="color: white; font-size: 1.5rem;">Tradition ${tradition.num}</h4>
        <p style="margin-top: 1rem; line-height: 1.6;">${tradition.text}</p>
    `;
}
function randomizeTradition() {
    const element = document.getElementById('tradition-of-day-display');
    if (!element) return;
    const randomNum = Math.floor(Math.random() * 12) + 1;
    const tradition = traditions[randomNum - 1];
    element.innerHTML = `
        <h4 style="color: white; font-size: 1.5rem;">Tradition ${tradition.num}</h4>
        <p style="margin-top: 1rem; line-height: 1.6;">${tradition.text}</p>
    `;
}
function checkTraditionViolations(motionText) {
    const warnings = [];
    const lowerText = motionText.toLowerCase();
    if (lowerText.match(/endorse|endorsement|affiliation|affiliate|lend.*name|partnership/)) {
        warnings.push({
            tradition: 6,
            severity: 'high',
            message: 'This motion may involve endorsement or affiliation with an outside entity (Tradition 6)'
        });
    }
    if (lowerText.match(/outside contribution|outside donation|accept.*from|grant|sponsor(ship)?.*from/)) {
        warnings.push({
            tradition: 7,
            severity: 'high',
            message: 'This motion may involve accepting outside contributions (Tradition 7)'
        });
    }
    if (lowerText.match(/politic|religious|controversial|public.*issue|government/)) {
        warnings.push({
            tradition: 10,
            severity: 'medium',
            message: 'This motion may involve outside issues or public controversy (Tradition 10)'
        });
    }
    if (lowerText.match(/public.*announcement|press release|media|newspaper|full name.*public/)) {
        warnings.push({
            tradition: 12,
            severity: 'medium',
            message: 'This motion may compromise member anonymity (Tradition 12)'
        });
    }
    return warnings;
}
function saveSpiritualPrincipleTags() {
    const motionSelect = document.getElementById('principle-motion-select');
    if (!motionSelect) return;
    const motionId = motionSelect.value;
    if (!motionId) {
        showToast('Please select a motion', 'error');
        return;
    }
    const checkboxes = document.querySelectorAll('.principle-checkbox:checked');
    const principles = Array.from(checkboxes).map(cb => cb.value);
    if (principles.length === 0) {
        showToast('Please select at least one principle', 'error');
        return;
    }
    const logs = storage.getGroupConscienceLog();
    const motion = logs.find(l => l.id === motionId);
    const principleData = storage.getSpiritualPrinciples();
    principleData.push({
        id: genId(),
        motionId,
        motionText: motion ? motion.item : '',
        principles,
        date: new Date().toISOString()
    });
    storage.saveSpiritualPrinciples(principleData);
    showToast('Spiritual principles tagged!', 'success');
    checkboxes.forEach(cb => cb.checked = false);
    renderPrincipleTaggedList();
}
function renderPrincipleTaggedList() {
    const list = document.getElementById('principle-tagged-list');
    if (!list) return;
    const principleData = storage.getSpiritualPrinciples().sort((a, b) => new Date(b.date) - new Date(a.date));
    if (principleData.length === 0) {
        list.innerHTML = '<p style="opacity: 0.7;">No tagged motions yet</p>';
        return;
    }
    list.innerHTML = principleData.map(p => `
        <div style="padding: 1rem; background: #34495e; border-radius: 4px; margin-bottom: 0.5rem;">
            <p style="font-size: 0.9rem;"><strong>${escapeHtml(p.motionText.substring(0, 80))}${p.motionText.length > 80 ? '...' : ''}</strong></p>
            <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                ${p.principles.map(pr => `<span style="background: #3498db; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem;">${pr}</span>`).join('')}
            </div>
        </div>
    `).join('');
}
function populatePrincipleMotionSelect() {
    const logs = storage.getGroupConscienceLog();
    const select = document.getElementById('principle-motion-select');
    if (select) {
        select.innerHTML = '<option value="">-- Select Motion --</option>' +
            logs.map(l => {
                const date = new Date(l.date).toLocaleDateString();
                const preview = l.item.substring(0, 60) + (l.item.length > 60 ? '...' : '');
                return `<option value="${escapeAttribute(l.id)}">${escapeHtml(date)} - ${escapeHtml(preview)}</option>`;
            }).join('');
    }
}
function startGroupInventory() {
    const questionsDiv = document.getElementById('group-inventory-questions');
    if (!questionsDiv) return;
    if (questionsDiv.style.display === 'none') {
        questionsDiv.style.display = 'block';
    } else {
        questionsDiv.style.display = 'none';
    }
}
function saveMinorityOpinion() {
    const motionSelect = document.getElementById('minority-motion-select');
    const opinionTextEl = document.getElementById('minority-opinion-text');
    const voteCountEl = document.getElementById('minority-vote-count');
    if (!motionSelect || !opinionTextEl || !voteCountEl) return;
    const motionId = motionSelect.value;
    const opinionText = opinionTextEl.value.trim();
    const voteCount = parseInt(voteCountEl.value) || 0;
    if (!motionId || !opinionText) {
        showToast('Please select a motion and enter the minority opinion', 'error');
        return;
    }
    const logs = storage.getGroupConscienceLog();
    const motion = logs.find(l => l.id === motionId);
    const opinions = storage.getMinorityOpinions();
    opinions.push({
        id: genId(),
        motionId,
        motionText: motion ? motion.item : '',
        opinion: opinionText,
        voteCount,
        date: new Date().toISOString()
    });
    storage.saveMinorityOpinions(opinions);
    showToast('Minority opinion recorded!', 'success');
    opinionTextEl.value = '';
    voteCountEl.value = '';
    renderMinorityOpinions();
}
function renderMinorityOpinions() {
    const list = document.getElementById('minority-opinions-list');
    if (!list) return;
    const opinions = storage.getMinorityOpinions().sort((a, b) => new Date(b.date) - new Date(a.date));
    if (opinions.length === 0) {
        list.innerHTML = '<p style="opacity: 0.7;">No minority opinions recorded yet</p>';
        return;
    }
    list.innerHTML = opinions.map(o => `
        <div style="padding: 1rem; background: #34495e; border-radius: 4px; margin-bottom: 0.5rem; border-left: 3px solid #f39c12;">
            <p style="font-size: 0.85rem; opacity: 0.8;">${new Date(o.date).toLocaleDateString()}</p>
            <p style="font-size: 0.9rem; margin-top: 0.5rem;"><strong>${escapeHtml(o.motionText.substring(0, 60))}${o.motionText.length > 60 ? '...' : ''}</strong></p>
            <p style="font-size: 0.9rem; margin-top: 0.5rem;">${escapeHtml(o.opinion)}</p>
            <p style="font-size: 0.85rem; margin-top: 0.5rem; opacity: 0.8;">Minority count: ${o.voteCount}</p>
        </div>
    `).join('');
}
function populateMinorityMotionSelect() {
    const logs = storage.getGroupConscienceLog();
    const select = document.getElementById('minority-motion-select');
    if (select) {
        select.innerHTML = '<option value="">-- Select Motion --</option>' +
            logs.map(l => {
                const date = new Date(l.date).toLocaleDateString();
                const preview = l.item.substring(0, 60) + (l.item.length > 60 ? '...' : '');
                return `<option value="${escapeAttribute(l.id)}">${escapeHtml(date)} - ${escapeHtml(preview)}</option>`;
            }).join('');
    }
}
function tableCurrentMotion() {
    const liveItems = storage.getLiveGCItems();
    if (liveItems.length === 0) {
        showToast('No current motion to table', 'info');
        return;
    }
    const currentItem = liveItems[0];
    if (confirm(`Table this motion for future discussion?\n\n"${currentItem.item}"`)) {
        const proposedItems = storage.getProposedAgendaItems();
        proposedItems.push({
            id: genId(),
            item: currentItem.item + ' (Tabled for further discussion)',
            proposedBy: 'Group',
            date: new Date().toISOString(),
            priority: 'high'
        });
        storage.saveProposedAgendaItems(proposedItems);
        liveItems.shift();
        storage.saveLiveGCItems(liveItems);
        showToast('Motion tabled - added to next meeting agenda', 'success');
        updateLiveGCTable();
        updateProposedAgendaTable();
    }
}
function formCommittee() {
    const committeeName = prompt('Enter committee name/purpose:');
    if (!committeeName) return;
    showToast(`Ad hoc committee formed: ${committeeName}\nAdd members via Service Positions section`, 'success');
}
function openCommonGroundDialog() {
    alert('Common Ground Exercise:\n\n1. What do we all agree on?\n2. What is our shared goal?\n3. What are we trying to accomplish?\n4. Can we find a middle path?\n\nDiscuss these questions to find unity.');
}
function saveServiceStructure() {
    const groupName = document.getElementById('structure-group-name');
    const district = document.getElementById('structure-district');
    const area = document.getElementById('structure-area');
    const gsrName = document.getElementById('structure-gsr-name');
    const structure = {
        group: {
            name: groupName ? groupName.value.trim() : '',
            district: district ? district.value.trim() : '',
            area: area ? area.value.trim() : '',
            gsrName: gsrName ? gsrName.value.trim() : ''
        }
    };
    storage.saveServiceStructure(structure);
    showToast('Service structure information saved!', 'success');
}
function loadServiceStructure() {
    const structure = storage.getServiceStructure();
    if (structure.group) {
        if (document.getElementById('structure-group-name')) {
            document.getElementById('structure-group-name').value = structure.group.name || '';
        }
        if (document.getElementById('structure-district')) {
            document.getElementById('structure-district').value = structure.group.district || '';
        }
        if (document.getElementById('structure-area')) {
            document.getElementById('structure-area').value = structure.group.area || '';
        }
        if (document.getElementById('structure-gsr-name')) {
            document.getElementById('structure-gsr-name').value = structure.group.gsrName || '';
        }
    }
}
function populateElectionPositions() {
    const positions = storage.getGroupPositions();
    const select = document.getElementById('election-position');
    if (select) {
        select.innerHTML = '<option value="">-- Select Position --</option>' +
            positions.map(p => `<option value="${escapeAttribute(p.id)}">${escapeHtml(p.title)}</option>`).join('');
    }
    const nomineeSelect = document.getElementById('nominee-select');
    if (nomineeSelect) {
        const members = storage.getMembers();
        nomineeSelect.innerHTML = '<option value="">-- Select Member --</option>' +
            members.map(m => `<option value="${escapeAttribute(m.id)}">${escapeHtml(m.name)}</option>`).join('');
    }
}
function populateSpeakersDropdown() {
    const members = storage.getMembers();
    const select = document.getElementById('speaker-name');
    if (select) {
        select.innerHTML = '<option value="">-- Select Member --</option>' +
            members.map(m => `<option value="${escapeHtml(m.name)}">${escapeHtml(m.name)}</option>`).join('');
    }
}
function populateLiteratureLoanMembers() {
    const members = storage.getMembers();
    const select = document.getElementById('loan-member');
    if (select) {
        select.innerHTML = '<option value="">-- Select Member --</option>' +
            members.map(m => `<option value="${escapeAttribute(m.id)}">${escapeHtml(m.name)}</option>`).join('');
    }
}
function addStandingAgendaItem() {
    const title = document.getElementById('standing-item-title').value.trim();
    const frequency = document.getElementById('standing-item-frequency').value;
    const time = parseInt(document.getElementById('standing-item-time').value) || 10;
    const assignee = document.getElementById('standing-item-assignee').value;
    const consent = document.getElementById('standing-item-consent').value;
    const description = document.getElementById('standing-item-description').value.trim();
    if (!title) {
        showToast('Please enter item title', 'error');
        return;
    }
    const items = storage.getStandingAgendaItems();
    items.push({
        id: genId(),
        title,
        frequency,
        time,
        assignee,
        consent,
        description,
        active: true,
        created: new Date().toISOString()
    });
    storage.saveStandingAgendaItems(items);
    document.getElementById('standing-item-title').value = '';
    document.getElementById('standing-item-description').value = '';
    refreshStandingItems();
    showToast('Standing item added successfully', 'success');
}
function refreshStandingItems() {
    const items = storage.getStandingAgendaItems();
    const tbody = document.getElementById('standing-items-body');
    if (!tbody) return;
    tbody.innerHTML = items.map(item => `
        <tr>
            <td>${escapeHtml(item.title)}</td>
            <td>${escapeHtml(item.frequency)}</td>
            <td>${escapeHtml(item.assignee || 'None')}</td>
            <td>${item.time} min</td>
            <td>${item.consent === 'yes' ? '<span style="color: #2ecc71;">Yes</span>' : 'No'}</td>
            <td><span style="color: ${item.active ? '#2ecc71' : '#95a5a6'};">${item.active ? 'Active' : 'Inactive'}</span></td>
            <td>
                <button class="btn small" onclick="toggleStandingItem('${item.id}')" style="background: #3498db;">
                    ${item.active ? 'Deactivate' : 'Activate'}
                </button>
                <button class="btn small" onclick="deleteStandingItem('${item.id}')" style="background: #e74c3c;">Delete</button>
            </td>
        </tr>
    `).join('');
}
function toggleStandingItem(id) {
    const items = storage.getStandingAgendaItems();
    const item = items.find(i => i.id === id);
    if (item) {
        item.active = !item.active;
        storage.saveStandingAgendaItems(items);
        refreshStandingItems();
    }
}
function deleteStandingItem(id) {
    if (!confirm('Delete this standing item?')) return;
    const items = storage.getStandingAgendaItems().filter(i => i.id !== id);
    storage.saveStandingAgendaItems(items);
    refreshStandingItems();
    showToast('Standing item deleted', 'success');
}
function refreshTabledMotions() {
    const motions = storage.getTabledMotions();
    const tbody = document.getElementById('tabled-motions-body');
    const noMotions = document.getElementById('no-tabled-motions');
    if (!tbody) return;
    if (motions.length === 0) {
        tbody.innerHTML = '';
        if (noMotions) noMotions.style.display = 'block';
        return;
    }
    if (noMotions) noMotions.style.display = 'none';
    tbody.innerHTML = motions.map((motion, idx) => {
        const daysTabled = Math.floor((Date.now() - motion.timestamp) / (1000 * 60 * 60 * 24));
        return `
            <tr>
                <td>${new Date(motion.timestamp).toLocaleDateString()}</td>
                <td>${escapeHtml(motion.motion)}</td>
                <td>${escapeHtml(motion.proposedBy || 'N/A')}</td>
                <td>${daysTabled}</td>
                <td>
                    <button class="btn small" onclick="takeFromTable()" style="background: #f39c12;">Resume</button>
                </td>
            </tr>
        `;
    }).join('');
}
function refreshChairRulings() {
    const rulings = storage.getChairRulings();
    const tbody = document.getElementById('chair-rulings-body');
    const noRulings = document.getElementById('no-chair-rulings');
    if (!tbody) return;
    if (rulings.length === 0) {
        tbody.innerHTML = '';
        if (noRulings) noRulings.style.display = 'block';
        return;
    }
    if (noRulings) noRulings.style.display = 'none';
    tbody.innerHTML = rulings.map(ruling => `
        <tr>
            <td>${new Date(ruling.date).toLocaleDateString()}</td>
            <td>${escapeHtml(ruling.issue)}</td>
            <td>${escapeHtml(ruling.ruling)}</td>
            <td>${ruling.appealed ? '<span style="color: #e74c3c;">Yes</span>' : 'No'}</td>
            <td>${escapeHtml(ruling.result)}</td>
        </tr>
    `).join('');
}
function refreshRulesSuspensions() {
    const suspensions = storage.getRulesSuspensions();
    const tbody = document.getElementById('rules-suspensions-body');
    const noSuspensions = document.getElementById('no-rules-suspensions');
    if (!tbody) return;
    if (suspensions.length === 0) {
        tbody.innerHTML = '';
        if (noSuspensions) noSuspensions.style.display = 'block';
        return;
    }
    if (noSuspensions) noSuspensions.style.display = 'none';
    tbody.innerHTML = suspensions.map(suspension => `
        <tr>
            <td>${new Date(suspension.date).toLocaleDateString()}</td>
            <td>${escapeHtml(suspension.rule)}</td>
            <td>${escapeHtml(suspension.purpose)}</td>
            <td>${escapeHtml(suspension.duration)}</td>
            <td><span style="color: ${suspension.result === 'Approved' ? '#2ecc71' : '#e74c3c'};">${escapeHtml(suspension.result)}</span></td>
        </tr>
    `).join('');
}
let currentAmendments = [];
function addAmendment() {
    const text = document.getElementById('amendment-text').value.trim();
    const type = document.getElementById('amendment-type').value;
    const proposer = document.getElementById('amendment-proposer').value.trim();
    const status = document.getElementById('amendment-status').value;
    if (!text) {
        showToast('Please enter amendment text', 'error');
        return;
    }
    currentAmendments.push({
        id: genId(),
        text,
        type,
        proposer,
        status,
        timestamp: new Date().toISOString()
    });
    document.getElementById('amendment-text').value = '';
    updateAmendmentsList();
    showToast('Amendment added', 'success');
}
function updateAmendmentsList() {
    const list = document.getElementById('amendments-list');
    if (!list) return;
    list.innerHTML = currentAmendments.map((a, idx) => `
        <div style="padding: 0.75rem; background: #2c3e50; border-radius: 4px; margin-bottom: 0.5rem; border-left: 3px solid ${a.type === 'friendly' ? '#2ecc71' : '#e74c3c'};">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div style="flex: 1;">
                    <div style="font-size: 0.85rem; opacity: 0.7; margin-bottom: 0.25rem;">
                        Amendment #${idx + 1} - ${a.type === 'friendly' ? 'Friendly' : 'Unfriendly'} - ${a.status}
                    </div>
                    <div>${escapeHtml(a.text)}</div>
                    <div style="font-size: 0.75rem; opacity: 0.7; margin-top: 0.25rem;">
                        Proposed by: ${escapeHtml(a.proposer || 'Unknown')}
                    </div>
                </div>
                <button class="btn small" onclick="removeAmendment(${idx})" style="background: #e74c3c; margin-left: 1rem;">Remove</button>
            </div>
        </div>
    `).join('');
    document.getElementById('gc-amendments-data').value = JSON.stringify(currentAmendments);
}
function removeAmendment(index) {
    currentAmendments.splice(index, 1);
    updateAmendmentsList();
}
let currentDiscussions = [];
function addDiscussionComment() {
    const comment = document.getElementById('discussion-comment').value.trim();
    const author = document.getElementById('discussion-author').value;
    const type = document.getElementById('discussion-type').value;
    if (!comment || !author) {
        showToast('Please fill in all fields', 'error');
        return;
    }
    currentDiscussions.push({
        id: genId(),
        comment,
        author,
        type,
        timestamp: new Date().toISOString()
    });
    document.getElementById('discussion-comment').value = '';
    updateDiscussionThread();
    showToast('Comment added', 'success');
}
function updateDiscussionThread() {
    const thread = document.getElementById('discussion-thread');
    if (!thread) return;
    const typeColors = {
        question: '#3498db',
        comment: '#95a5a6',
        concern: '#e74c3c',
        support: '#2ecc71'
    };
    thread.innerHTML = currentDiscussions.map((d, idx) => `
        <div style="padding: 0.75rem; background: #2c3e50; border-radius: 4px; margin-bottom: 0.5rem; border-left: 3px solid ${typeColors[d.type]};">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div style="flex: 1;">
                    <div style="font-size: 0.85rem; opacity: 0.7; margin-bottom: 0.25rem;">
                        <strong>${escapeHtml(d.author)}</strong> - ${d.type} - ${new Date(d.timestamp).toLocaleString()}
                    </div>
                    <div>${escapeHtml(d.comment)}</div>
                </div>
                <button class="btn small" onclick="removeDiscussion(${idx})" style="background: #e74c3c; margin-left: 1rem;">Remove</button>
            </div>
        </div>
    `).join('');
    document.getElementById('gc-discussion-data').value = JSON.stringify(currentDiscussions);
}
function removeDiscussion(index) {
    currentDiscussions.splice(index, 1);
    updateDiscussionThread();
}
function clearGCSearch() {
    document.getElementById('gc-search').value = '';
    document.getElementById('gc-filter-status').value = '';
    document.getElementById('gc-filter-category').value = '';
    document.getElementById('gc-filter-date-from').value = '';
    document.getElementById('gc-filter-date-to').value = '';
    document.getElementById('gc-filter-submitter').value = '';
    searchGCHistory();
}
function showRelatedDecisions() {
    const searchTerm = document.getElementById('gc-search').value.toLowerCase();
    if (!searchTerm) {
        showToast('Enter a search term to find related decisions', 'error');
        return;
    }
    const gcLog = storage.getGroupConscienceLog();
    const related = gcLog.filter(item => {
        const itemText = (item.item || '').toLowerCase();
        const words = searchTerm.split(' ');
        return words.some(word => itemText.includes(word));
    });
    const suggestions = document.getElementById('search-suggestions');
    const suggestionsList = document.getElementById('suggestions-list');
    if (related.length > 0) {
        suggestions.style.display = 'block';
        suggestionsList.innerHTML = related.slice(0, 5).map(item => `
            <div style="padding: 0.5rem; background: #2c3e50; border-radius: 4px; margin-top: 0.5rem;">
                <strong>${item.date}</strong>: ${escapeHtml(item.item).substring(0, 100)}...
            </div>
        `).join('');
    } else {
        suggestions.style.display = 'none';
    }
}
function exportSearchResults() {
    const gcLog = storage.getGroupConscienceLog();
    showToast('Exporting search results...', 'success');
}
function saveEmailSettings() {
    const settings = {
        fromAddress: document.getElementById('email-from-address').value.trim(),
        fromName: document.getElementById('email-from-name').value.trim(),
        recipientList: document.getElementById('email-recipient-list').value.trim()
    };
    storage.saveEmailSettings(settings);
    showToast('Email settings saved', 'success');
}
function generateAndEmailAgenda() {
    const meetingDate = document.getElementById('agenda-meeting-date').value;
    const includeStanding = document.getElementById('agenda-include-standing').checked;
    const includeTabled = document.getElementById('agenda-include-tabled').checked;
    if (!meetingDate) {
        showToast('Please select meeting date', 'error');
        return;
    }
    const settings = storage.getEmailSettings();
    const proposedItems = storage.getProposedAgendaItems();
    const standingItems = includeStanding ? storage.getStandingAgendaItems().filter(i => i.active) : [];
    const tabledMotions = includeTabled ? storage.getTabledMotions() : [];
    let agendaText = `GROUP CONSCIENCE MEETING AGENDA\nDate: ${meetingDate}\n\n`;
    if (standingItems.length > 0) {
        agendaText += `STANDING ITEMS:\n`;
        standingItems.forEach((item, i) => {
            agendaText += `${i + 1}. ${item.title} (${item.time} min) - ${item.assignee || 'Unassigned'}\n`;
        });
        agendaText += `\n`;
    }
    if (tabledMotions.length > 0) {
        agendaText += `TABLED MOTIONS:\n`;
        tabledMotions.forEach((item, i) => {
            agendaText += `${i + 1}. ${item.motion}\n`;
        });
        agendaText += `\n`;
    }
    if (proposedItems.length > 0) {
        agendaText += `PROPOSED ITEMS:\n`;
        proposedItems.forEach((item, i) => {
            agendaText += `${i + 1}. ${item.title} (${item.estimatedTime || 15} min) - ${item.submitter}\n`;
        });
    }
    const preview = document.getElementById('agenda-preview');
    preview.style.display = 'block';
    preview.innerHTML = `<pre>${escapeHtml(agendaText)}</pre>`;
    const mailto = `mailto:${settings.recipientList}?subject=GC Agenda - ${meetingDate}&body=${encodeURIComponent(agendaText)}`;
    window.location.href = mailto;
    const history = storage.getEmailHistory();
    history.push({
        id: genId(),
        type: 'agenda',
        meetingDate,
        dateSent: new Date().toISOString(),
        recipients: settings.recipientList
    });
    storage.saveEmailHistory(history);
    refreshEmailHistory();
}
function generateAndEmailMinutes() {
    const meetingDate = document.getElementById('minutes-meeting-date').value;
    const includeDiscussion = document.getElementById('minutes-include-discussion').checked;
    const includeAmendments = document.getElementById('minutes-include-amendments').checked;
    if (!meetingDate) {
        showToast('Please select meeting date', 'error');
        return;
    }
    const settings = storage.getEmailSettings();
    const gcLog = storage.getGroupConscienceLog().filter(item => item.date === meetingDate);
    let minutesText = `GROUP CONSCIENCE MEETING MINUTES\nDate: ${meetingDate}\n\n`;
    gcLog.forEach((item, i) => {
        minutesText += `${i + 1}. ${item.item}\n`;
        minutesText += `   Result: ${item.status}\n`;
        minutesText += `   Votes: ${item.votesFor || 0} For, ${item.votesAgainst || 0} Against, ${item.votesAbstain || 0} Abstain\n\n`;
    });
    const preview = document.getElementById('minutes-preview');
    preview.style.display = 'block';
    preview.innerHTML = `<pre>${escapeHtml(minutesText)}</pre>`;
    const mailto = `mailto:${settings.recipientList}?subject=GC Minutes - ${meetingDate}&body=${encodeURIComponent(minutesText)}`;
    window.location.href = mailto;
    const history = storage.getEmailHistory();
    history.push({
        id: genId(),
        type: 'minutes',
        meetingDate,
        dateSent: new Date().toISOString(),
        recipients: settings.recipientList
    });
    storage.saveEmailHistory(history);
    refreshEmailHistory();
}
function refreshEmailHistory() {
    const history = storage.getEmailHistory();
    const tbody = document.getElementById('email-history-body');
    if (!tbody) return;
    tbody.innerHTML = history.slice(-10).reverse().map(item => `
        <tr>
            <td>${new Date(item.dateSent).toLocaleString()}</td>
            <td><span style="text-transform: capitalize;">${item.type}</span></td>
            <td>${item.meetingDate}</td>
            <td>${item.recipients.split(',').length} recipients</td>
            <td><button class="btn small" onclick="viewEmailDetails('${item.id}')">View</button></td>
        </tr>
    `).join('');
}
function viewEmailDetails(emailId) {
    const history = storage.getEmailHistory();
    const email = history.find(e => e.id === emailId);
    if (!email) {
        showToast('Email record not found', 'error');
        return;
    }
    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 2rem;';
    modal.innerHTML = `
        <div style="background: #2c3e50; border-radius: 8px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; padding: 2rem; position: relative;">
            <button onclick="this.closest('div[style*=fixed]').remove()" style="position: absolute; top: 1rem; right: 1rem; background: #e74c3c; border: none; color: white; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
                <i class="fas fa-times"></i> Close
            </button>
            <h2 style="color: #e67e22; margin-bottom: 1.5rem;"><i class="fas fa-envelope"></i> Email Details</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                <div>
                    <strong>Type:</strong> <span style="text-transform: capitalize;">${email.type}</span>
                </div>
                <div>
                    <strong>Meeting Date:</strong> ${email.meetingDate}
                </div>
                <div>
                    <strong>Date Sent:</strong> ${new Date(email.dateSent).toLocaleString()}
                </div>
                <div>
                    <strong>Recipients:</strong> ${email.recipients.split(',').length} people
                </div>
            </div>
            <div style="margin-bottom: 1.5rem;">
                <h4 style="margin-bottom: 0.5rem;">Recipients List</h4>
                <div style="padding: 1rem; background: #34495e; border-radius: 4px; font-size: 0.9rem;">
                    ${email.recipients.split(',').map(r => r.trim()).join(', ')}
                </div>
            </div>
            <div style="padding: 1.5rem; background: #34495e; border-radius: 4px;">
                <h4 style="margin-bottom: 1rem;">Email Preview</h4>
                <div style="background: white; color: #2c3e50; padding: 1.5rem; border-radius: 4px; font-family: Arial, sans-serif; white-space: pre-wrap;">
                    ${email.content || 'No content preview available'}
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}
function loadMemberVotingHistory() {
    const memberId = document.getElementById('voting-history-member').value;
    const period = document.getElementById('voting-history-period').value;
    if (!memberId) {
        document.getElementById('member-voting-stats').style.display = 'none';
        return;
    }
    const gcLog = storage.getGroupConscienceLog();
    const records = storage.getMemberVotingRecords();
    const cutoffDate = new Date();
    if (period !== 'all') {
        cutoffDate.setDate(cutoffDate.getDate() - parseInt(period));
    }
    const memberVotes = records[memberId] || [];
    const filteredVotes = memberVotes.filter(v => {
        if (period === 'all') return true;
        return new Date(v.date) >= cutoffDate;
    });
    const participated = filteredVotes.length;
    const votedFor = filteredVotes.filter(v => v.vote === 'for').length;
    const votedAgainst = filteredVotes.filter(v => v.vote === 'against').length;
    const abstained = filteredVotes.filter(v => v.vote === 'abstain').length;
    const totalDecisions = gcLog.filter(item => {
        if (period === 'all') return true;
        return new Date(item.date) >= cutoffDate;
    }).length;
    const participationRate = totalDecisions > 0 ? ((participated / totalDecisions) * 100).toFixed(1) : 0;
    document.getElementById('member-voting-stats').style.display = 'block';
    document.getElementById('votes-participated').textContent = participated;
    document.getElementById('votes-for-total').textContent = votedFor;
    document.getElementById('votes-against-total').textContent = votedAgainst;
    document.getElementById('votes-abstain-total').textContent = abstained;
    document.getElementById('participation-rate').textContent = `${participationRate}%`;
    const tbody = document.getElementById('member-voting-history-body');
    if (!tbody) return;
    tbody.innerHTML = filteredVotes.map(v => `
        <tr>
            <td>${v.date}</td>
            <td>${escapeHtml(v.motion).substring(0, 50)}...</td>
            <td><span style="color: ${v.vote === 'for' ? '#2ecc71' : v.vote === 'against' ? '#e74c3c' : '#95a5a6'};">${v.vote}</span></td>
            <td>${v.result}</td>
            <td>${v.consensus ? 'Yes' : 'No'}</td>
        </tr>
    `).join('');
}
function saveDecisionImplementation() {
    const decisionId = document.getElementById('impl-decision').value;
    const status = document.getElementById('impl-status').value;
    const startDate = document.getElementById('impl-start-date').value;
    const targetDate = document.getElementById('impl-target-date').value;
    const actualDate = document.getElementById('impl-actual-date').value;
    const progress = parseInt(document.getElementById('impl-progress').value);
    const milestones = document.getElementById('impl-milestones').value.trim();
    const challenges = document.getElementById('impl-challenges').value.trim();
    const outcome = document.getElementById('impl-outcome').value;
    const owner = document.getElementById('impl-owner').value;
    if (!decisionId) {
        showToast('Please select a decision to track', 'error');
        return;
    }
    const tracking = storage.getImplementationTracking();
    const existing = tracking.find(t => t.decisionId === decisionId);
    const data = {
        decisionId,
        status,
        startDate,
        targetDate,
        actualDate,
        progress,
        milestones,
        challenges,
        outcome,
        owner,
        lastUpdated: new Date().toISOString()
    };
    if (existing) {
        Object.assign(existing, data);
    } else {
        data.id = genId();
        tracking.push(data);
    }
    storage.saveImplementationTracking(tracking);
    refreshImplementationTracking();
    showToast('Implementation tracking saved', 'success');
}
function refreshImplementationTracking() {
    const tracking = storage.getImplementationTracking();
    const gcLog = storage.getGroupConscienceLog();
    const tbody = document.getElementById('implementation-tracking-body');
    if (!tbody) return;
    tbody.innerHTML = tracking.map(t => {
        const decision = gcLog.find(d => d.id === t.decisionId);
        const decisionText = decision ? decision.item : 'Unknown';
        return `
            <tr>
                <td>${escapeHtml(decisionText).substring(0, 40)}...</td>
                <td><span style="color: ${getStatusColor(t.status)};">${t.status}</span></td>
                <td>${t.progress}%</td>
                <td>${t.owner || 'Unassigned'}</td>
                <td>${t.targetDate || 'Not set'}</td>
                <td>${t.outcome || 'Not assessed'}</td>
                <td><button class="btn small" onclick="editImplementation('${t.id}')">Edit</button></td>
            </tr>
        `;
    }).join('');
}
function getStatusColor(status) {
    const colors = {
        'planned': '#3498db',
        'in-progress': '#f39c12',
        'completed': '#2ecc71',
        'delayed': '#e67e22',
        'blocked': '#e74c3c',
        'abandoned': '#95a5a6'
    };
    return colors[status] || '#95a5a6';
}
function refreshConsentAgenda() {
    const proposedItems = storage.getProposedAgendaItems();
    const standingItems = storage.getStandingAgendaItems().filter(i => i.active && i.consent === 'yes');
    const consentItems = [
        ...standingItems.map(i => ({...i, type: 'Standing', isStanding: true})),
        ...proposedItems.filter(i => i.consent).map(i => ({...i, type: 'Proposed', isStanding: false}))
    ];
    const tbody = document.getElementById('consent-agenda-body');
    if (!tbody) return;
    tbody.innerHTML = consentItems.map(item => `
        <tr>
            <td><input type="checkbox" class="consent-item-check" data-id="${item.id}"></td>
            <td>${escapeHtml(item.title || item.item)}</td>
            <td>${item.type}</td>
            <td>${escapeHtml(item.submitter || item.assignee || 'N/A')}</td>
            <td><button class="btn small" onclick="pullFromConsent('${item.id}')" style="background: #f39c12;">Pull</button></td>
        </tr>
    `).join('');
}
function toggleAllConsentItems() {
    const selectAll = document.getElementById('consent-select-all').checked;
    document.querySelectorAll('.consent-item-check').forEach(cb => cb.checked = selectAll);
}
function approveConsentAgenda() {
    const checkedIds = Array.from(document.querySelectorAll('.consent-item-check:checked')).map(cb => cb.dataset.id);
    if (checkedIds.length === 0) {
        showToast('No items selected', 'error');
        return;
    }
    if (!confirm(`Approve ${checkedIds.length} consent items?`)) return;
    const history = storage.getConsentHistory();
    history.push({
        id: genId(),
        date: new Date().toISOString(),
        itemCount: checkedIds.length,
        items: checkedIds
    });
    storage.saveConsentHistory(history);
    showToast(`${checkedIds.length} items approved via consent`, 'success');
    refreshConsentAgenda();
    updateConsentHistory();
}
function pullConsentItems() {
    const checkedIds = Array.from(document.querySelectorAll('.consent-item-check:checked')).map(cb => cb.dataset.id);
    if (checkedIds.length === 0) {
        showToast('No items selected to pull', 'error');
        return;
    }
    showToast(`${checkedIds.length} items pulled for full discussion`, 'success');
}
function pullFromConsent(itemId) {
    const proposedItems = storage.getProposedAgendaItems();
    const standingItems = storage.getStandingAgendaItems();
    const proposedItem = proposedItems.find(i => i.id === itemId);
    if (proposedItem) {
        proposedItem.consent = false;
        storage.saveProposedAgendaItems(proposedItems);
        showToast('Item pulled from consent agenda for full discussion', 'success');
        refreshConsentAgenda();
        updateProposedAgendaTable();
        return;
    }
    const standingItem = standingItems.find(i => i.id === itemId);
    if (standingItem) {
        standingItem.consent = 'no';
        storage.saveStandingAgendaItems(standingItems);
        showToast('Standing item pulled from consent agenda for full discussion', 'success');
        refreshConsentAgenda();
        refreshStandingItems();
        return;
    }
    showToast('Item not found', 'error');
}
function updateConsentHistory() {
    const history = storage.getConsentHistory();
    const div = document.getElementById('consent-history');
    if (!div) return;
    div.innerHTML = history.slice(-5).reverse().map(h => `
        <div style="padding: 0.5rem; background: #2c3e50; border-radius: 4px; margin-bottom: 0.5rem;">
            <strong>${new Date(h.date).toLocaleDateString()}</strong>: ${h.itemCount} items approved
        </div>
    `).join('') || '<em>No consent items approved yet</em>';
}
function checkAndUpdateWorkflowStatuses() {
    const gcLog = storage.getGroupConscienceLog();
    const today = new Date();
    let updated = 0;
    gcLog.forEach(item => {
        if (item.workflowStatus === 'research' && item.researchEndDate) {
            const endDate = new Date(item.researchEndDate);
            if (today >= endDate) {
                item.workflowStatus = 'voting';
                updated++;
            }
        }
        if (item.workflowStatus === 'tabled' && item.tableUntilDate) {
            const untilDate = new Date(item.tableUntilDate);
            if (today >= untilDate) {
                item.workflowStatus = 'voting';
                updated++;
            }
        }
    });
    if (updated > 0) {
        storage.saveGroupConscienceLog(gcLog);
        console.log(`Auto-updated ${updated} GC item workflow statuses`);
    }
}
setInterval(checkAndUpdateWorkflowStatuses, 3600000);
function loadOriginalDecision() {
    const decisionId = document.getElementById('reconsider-original-decision').value;
    if (!decisionId) {
        document.getElementById('original-decision-summary').style.display = 'none';
        return;
    }
    const gcLog = storage.getGroupConscienceLog();
    const decision = gcLog.find(d => d.id === decisionId);
    if (decision) {
        const summary = document.getElementById('original-decision-summary');
        summary.style.display = 'block';
        const details = document.getElementById('original-decision-details');
        details.innerHTML = `
            <div style="margin-bottom: 0.5rem;"><strong>Date:</strong> ${decision.date}</div>
            <div style="margin-bottom: 0.5rem;"><strong>Motion:</strong> ${escapeHtml(decision.item)}</div>
            <div style="margin-bottom: 0.5rem;"><strong>Result:</strong> ${decision.status}</div>
            <div><strong>Votes:</strong> ${decision.votesFor || 0} For, ${decision.votesAgainst || 0} Against, ${decision.votesAbstain || 0} Abstain</div>
        `;
    }
}
function submitReconsiderationRequest() {
    const decisionId = document.getElementById('reconsider-original-decision').value;
    const requestedBy = document.getElementById('reconsider-requested-by').value;
    const reason = document.getElementById('reconsider-reason').value;
    const justification = document.getElementById('reconsider-justification').value.trim();
    const proposedDate = document.getElementById('reconsider-proposed-date').value;
    const researchPeriod = parseInt(document.getElementById('reconsider-research-period').value);
    const proposedChange = document.getElementById('reconsider-proposed-change').value.trim();
    if (!decisionId || !requestedBy || !justification) {
        showToast('Please fill in all required fields', 'error');
        return;
    }
    const requests = storage.getReconsiderationRequests();
    const gcLog = storage.getGroupConscienceLog();
    const originalDecision = gcLog.find(d => d.id === decisionId);
    requests.push({
        id: genId(),
        decisionId,
        originalMotion: originalDecision ? originalDecision.item : 'Unknown',
        requestedBy,
        reason,
        justification,
        proposedDate,
        researchPeriod,
        proposedChange,
        status: 'pending',
        submittedDate: new Date().toISOString()
    });
    storage.saveReconsiderationRequests(requests);
    refreshReconsiderationRequests();
    showToast('Reconsideration request submitted', 'success');
    document.getElementById('reconsider-original-decision').value = '';
    document.getElementById('reconsider-justification').value = '';
    document.getElementById('reconsider-proposed-change').value = '';
    document.getElementById('original-decision-summary').style.display = 'none';
}
function refreshReconsiderationRequests() {
    const requests = storage.getReconsiderationRequests();
    const tbody = document.getElementById('reconsideration-requests-body');
    if (!tbody) return;
    tbody.innerHTML = requests.filter(r => r.status === 'pending').map(req => `
        <tr>
            <td>${escapeHtml(req.originalMotion).substring(0, 50)}...</td>
            <td>${escapeHtml(req.requestedBy)}</td>
            <td>${escapeHtml(req.reason)}</td>
            <td>${req.proposedDate || 'TBD'}</td>
            <td><span style="color: #f39c12;">${req.status}</span></td>
            <td>
                <button class="btn small" onclick="approveReconsideration('${req.id}')" style="background: #2ecc71;">Approve</button>
                <button class="btn small" onclick="denyReconsideration('${req.id}')" style="background: #e74c3c;">Deny</button>
            </td>
        </tr>
    `).join('') || '<tr><td colspan="6" style="text-align: center; opacity: 0.7;">No pending requests</td></tr>';
}
function approveReconsideration(requestId) {
    const requests = storage.getReconsiderationRequests();
    const request = requests.find(r => r.id === requestId);
    if (request) {
        request.status = 'approved';
        storage.saveReconsiderationRequests(requests);
        refreshReconsiderationRequests();
        showToast('Reconsideration request approved', 'success');
    }
}
function denyReconsideration(requestId) {
    if (!confirm('Deny this reconsideration request?')) return;
    const requests = storage.getReconsiderationRequests();
    const request = requests.find(r => r.id === requestId);
    if (request) {
        request.status = 'denied';
        storage.saveReconsiderationRequests(requests);
        refreshReconsiderationRequests();
        showToast('Reconsideration request denied', 'success');
    }
}
function exportToGoogleCalendar() {
    const date = document.getElementById('cal-meeting-date').value;
    const time = document.getElementById('cal-meeting-time').value;
    const duration = parseFloat(document.getElementById('cal-duration').value);
    const location = document.getElementById('cal-location').value;
    if (!date) {
        showToast('Please select a meeting date', 'error');
        return;
    }
    const startDateTime = `${date}T${time || '18:00'}:00`;
    const endTime = new Date(`${date}T${time || '18:00'}:00`);
    endTime.setHours(endTime.getHours() + (duration || 1.5));
    const endDateTime = endTime.toISOString().slice(0, 19);
    const googleUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent('Group Conscience Meeting')}&dates=${startDateTime.replace(/[-:]/g, '')}/${endDateTime.replace(/[-:]/g, '')}&details=${encodeURIComponent('Group Conscience Meeting')}&location=${encodeURIComponent(location || '')}`;
    window.open(googleUrl, '_blank');
    saveCalendarEvent('GC Meeting', date, time, 'google');
}
function exportToOutlook() {
    const date = document.getElementById('cal-meeting-date').value;
    const time = document.getElementById('cal-meeting-time').value;
    const duration = parseFloat(document.getElementById('cal-duration').value);
    const location = document.getElementById('cal-location').value;
    if (!date) {
        showToast('Please select a meeting date', 'error');
        return;
    }
    const startDateTime = `${date}T${time || '18:00'}:00`;
    const endTime = new Date(`${date}T${time || '18:00'}:00`);
    endTime.setHours(endTime.getHours() + (duration || 1.5));
    const endDateTime = endTime.toISOString().slice(0, 19);
    const outlookUrl = `https://outlook.live.com/calendar/0/deeplink/compose?subject=${encodeURIComponent('Group Conscience Meeting')}&startdt=${startDateTime}&enddt=${endDateTime}&location=${encodeURIComponent(location || '')}`;
    window.open(outlookUrl, '_blank');
    saveCalendarEvent('GC Meeting', date, time, 'outlook');
}
function exportToICS() {
    const date = document.getElementById('cal-meeting-date').value;
    const time = document.getElementById('cal-meeting-time').value;
    const duration = parseFloat(document.getElementById('cal-duration').value);
    const location = document.getElementById('cal-location').value;
    if (!date) {
        showToast('Please select a meeting date', 'error');
        return;
    }
    const startDateTime = new Date(`${date}T${time || '18:00'}:00`);
    const endTime = new Date(startDateTime);
    endTime.setHours(endTime.getHours() + (duration || 1.5));
    const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
BEGIN:VEVENT
DTSTART:${startDateTime.toISOString().replace(/[-:]/g, '').split('.')[0]}Z
DTEND:${endTime.toISOString().replace(/[-:]/g, '').split('.')[0]}Z
SUMMARY:Group Conscience Meeting
LOCATION:${location || ''}
DESCRIPTION:Group Conscience Meeting
END:VEVENT
END:VCALENDAR`;
    const blob = new Blob([icsContent], { type: 'text/calendar' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `gc-meeting-${date}.ics`;
    a.click();
    URL.revokeObjectURL(url);
    saveCalendarEvent('GC Meeting', date, time, 'ics');
    showToast('Calendar file downloaded', 'success');
}
function exportDeadlineToGoogleCalendar() {
    const title = document.getElementById('cal-decision-title').value.trim();
    const date = document.getElementById('cal-deadline-date').value;
    const reminder = document.getElementById('cal-reminder').value;
    if (!title || !date) {
        showToast('Please fill in required fields', 'error');
        return;
    }
    const googleUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title + ' - Deadline')}&dates=${date.replace(/-/g, '')}/${date.replace(/-/g, '')}&details=${encodeURIComponent('Decision deadline: ' + title)}`;
    window.open(googleUrl, '_blank');
    saveCalendarEvent(title, date, null, 'google');
}
function exportDeadlineToOutlook() {
    const title = document.getElementById('cal-decision-title').value.trim();
    const date = document.getElementById('cal-deadline-date').value;
    if (!title || !date) {
        showToast('Please fill in required fields', 'error');
        return;
    }
    const outlookUrl = `https://outlook.live.com/calendar/0/deeplink/compose?subject=${encodeURIComponent(title + ' - Deadline')}&startdt=${date}T09:00:00&enddt=${date}T10:00:00&allday=true`;
    window.open(outlookUrl, '_blank');
    saveCalendarEvent(title, date, null, 'outlook');
}
function exportDeadlineToICS() {
    const title = document.getElementById('cal-decision-title').value.trim();
    const date = document.getElementById('cal-deadline-date').value;
    if (!title || !date) {
        showToast('Please fill in required fields', 'error');
        return;
    }
    const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
BEGIN:VEVENT
DTSTART;VALUE=DATE:${date.replace(/-/g, '')}
SUMMARY:${title} - Deadline
DESCRIPTION:Decision deadline: ${title}
END:VEVENT
END:VCALENDAR`;
    const blob = new Blob([icsContent], { type: 'text/calendar' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `decision-deadline-${date}.ics`;
    a.click();
    URL.revokeObjectURL(url);
    saveCalendarEvent(title, date, null, 'ics');
    showToast('Calendar file downloaded', 'success');
}
function saveCalendarEvent(title, date, time, platform) {
    const events = storage.getCalendarEvents();
    events.push({
        id: genId(),
        title,
        date,
        time,
        platform,
        exported: new Date().toISOString()
    });
    storage.saveCalendarEvents(events);
}
let roiChart;
function calculateROI() {
    const title = document.getElementById('roi-decision-title').value.trim();
    const initialCost = parseFloat(document.getElementById('roi-initial-cost').value) || 0;
    const ongoingCost = parseFloat(document.getElementById('roi-ongoing-cost').value) || 0;
    const revenueImpact = parseFloat(document.getElementById('roi-revenue-impact').value) || 0;
    const expenseSavings = parseFloat(document.getElementById('roi-expense-savings').value) || 0;
    const timeframe = parseInt(document.getElementById('roi-timeframe').value) || 12;
    if (!title || initialCost === 0) {
        showToast('Please enter decision title and initial cost', 'error');
        return;
    }
    const monthlyBenefit = revenueImpact + expenseSavings - ongoingCost;
    const totalCost = initialCost + (ongoingCost * timeframe);
    const totalBenefit = monthlyBenefit * timeframe;
    const netImpact = totalBenefit - totalCost;
    const roiPercentage = totalCost > 0 ? ((netImpact / totalCost) * 100) : 0;
    const paybackMonths = monthlyBenefit > 0 ? Math.ceil(initialCost / monthlyBenefit) : null;
    document.getElementById('roi-results').style.display = 'block';
    document.getElementById('roi-total-cost-display').textContent = `$${totalCost.toFixed(2)}`;
    document.getElementById('roi-net-impact-display').textContent = `$${netImpact.toFixed(2)}`;
    document.getElementById('roi-net-impact-display').style.color = netImpact >= 0 ? '#2ecc71' : '#e74c3c';
    document.getElementById('roi-payback-display').textContent = paybackMonths ? `${paybackMonths} months` : 'N/A';
    document.getElementById('roi-percentage-display').textContent = `${roiPercentage.toFixed(1)}%`;
    document.getElementById('roi-percentage-display').style.color = roiPercentage >= 0 ? '#2ecc71' : '#e74c3c';
    const recommendation = document.getElementById('roi-recommendation');
    if (netImpact > 0) {
        recommendation.style.background = '#2ecc71';
        recommendation.innerHTML = `<strong>✓ Recommended:</strong> Positive financial impact of $${netImpact.toFixed(2)} over ${timeframe} months`;
    } else if (netImpact === 0) {
        recommendation.style.background = '#f39c12';
        recommendation.innerHTML = `<strong>⚠ Neutral:</strong> Break-even decision with no financial gain or loss`;
    } else {
        recommendation.style.background = '#e74c3c';
        recommendation.innerHTML = `<strong>✗ Not Recommended:</strong> Negative financial impact of $${Math.abs(netImpact).toFixed(2)} over ${timeframe} months`;
    }
    const currentBalance = calculateCurrentBalance();
    const budgetImpact = document.getElementById('budget-impact-details');
    budgetImpact.innerHTML = `
        <div style="margin-bottom: 0.5rem;"><strong>Current Balance:</strong> $${currentBalance.toFixed(2)}</div>
        <div style="margin-bottom: 0.5rem;"><strong>After Initial Purchase:</strong> $${(currentBalance - initialCost).toFixed(2)}</div>
        <div style="margin-bottom: 0.5rem;"><strong>Monthly Cash Flow Impact:</strong> ${monthlyBenefit >= 0 ? '+' : ''}$${monthlyBenefit.toFixed(2)}</div>
        <div><strong>Balance after ${timeframe} months:</strong> $${(currentBalance - initialCost + (monthlyBenefit * timeframe)).toFixed(2)}</div>
    `;
    renderROIChart(timeframe, initialCost, monthlyBenefit, currentBalance);
    const calculations = storage.getROICalculations();
    calculations.push({
        id: genId(),
        title,
        initialCost,
        ongoingCost,
        revenueImpact,
        expenseSavings,
        timeframe,
        netImpact,
        roiPercentage,
        calculatedDate: new Date().toISOString()
    });
    storage.saveROICalculations(calculations);
}
function renderROIChart(timeframe, initialCost, monthlyBenefit, currentBalance) {
    const ctx = document.getElementById('roi-chart');
    if (!ctx) return;
    const labels = [];
    const balanceData = [];
    let balance = currentBalance - initialCost;
    for (let i = 0; i <= timeframe; i++) {
        labels.push(`Month ${i}`);
        balanceData.push(balance);
        if (i < timeframe) balance += monthlyBenefit;
    }
    if (roiChart) roiChart.destroy();
    roiChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels,
            datasets: [{
                label: 'Projected Balance',
                data: balanceData,
                borderColor: monthlyBenefit >= 0 ? '#2ecc71' : '#e74c3c',
                backgroundColor: monthlyBenefit >= 0 ? 'rgba(46, 204, 113, 0.1)' : 'rgba(231, 76, 60, 0.1)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: true },
                title: { display: true, text: 'Financial Impact Over Time' }
            }
        }
    });
}
function toggleProxyInstructions() {
    const scope = document.getElementById('proxy-scope').value;
    const instructionsDiv = document.getElementById('proxy-directed-instructions');
    instructionsDiv.style.display = scope === 'directed' ? 'block' : 'none';
}
function submitProxyDesignation() {
    const member = document.getElementById('proxy-member').value;
    const designatedVoter = document.getElementById('proxy-designated-voter').value;
    const meetingDate = document.getElementById('proxy-meeting-date').value;
    const scope = document.getElementById('proxy-scope').value;
    const instructions = document.getElementById('proxy-instructions').value.trim();
    const reason = document.getElementById('proxy-reason').value;
    if (!member || !designatedVoter || !meetingDate) {
        showToast('Please fill in all required fields', 'error');
        return;
    }
    if (member === designatedVoter) {
        showToast('Cannot designate yourself as proxy', 'error');
        return;
    }
    const proxies = storage.getProxyVotes();
    proxies.push({
        id: genId(),
        member,
        designatedVoter,
        meetingDate,
        scope,
        instructions: scope === 'directed' ? instructions : '',
        reason,
        status: 'active',
        createdDate: new Date().toISOString()
    });
    storage.saveProxyVotes(proxies);
    refreshProxyVotes();
    showToast('Proxy designation submitted', 'success');
    document.getElementById('proxy-meeting-date').value = '';
    document.getElementById('proxy-instructions').value = '';
}
function refreshProxyVotes() {
    const proxies = storage.getProxyVotes();
    const members = storage.getMembers();
    const tbody = document.getElementById('active-proxies-body');
    if (!tbody) return;
    const activeTodayProxies = proxies.filter(p => p.status === 'active' && new Date(p.meetingDate) >= new Date());
    tbody.innerHTML = activeTodayProxies.map(proxy => {
        const memberName = members.find(m => m.id === proxy.member)?.name || proxy.member;
        const voterName = members.find(m => m.id === proxy.designatedVoter)?.name || proxy.designatedVoter;
        return `
            <tr>
                <td>${escapeHtml(memberName)}</td>
                <td>${escapeHtml(voterName)}</td>
                <td>${proxy.meetingDate}</td>
                <td>${proxy.scope === 'general' ? 'General' : 'Directed'}</td>
                <td><button class="btn small" onclick="revokeProxy('${proxy.id}')" style="background: #e74c3c;">Revoke</button></td>
            </tr>
        `;
    }).join('') || '<tr><td colspan="5" style="text-align: center; opacity: 0.7;">No active proxies</td></tr>';
}
function revokeProxy(proxyId) {
    if (!confirm('Revoke this proxy designation?')) return;
    const proxies = storage.getProxyVotes();
    const proxy = proxies.find(p => p.id === proxyId);
    if (proxy) {
        proxy.status = 'revoked';
        storage.saveProxyVotes(proxies);
        refreshProxyVotes();
        showToast('Proxy revoked', 'success');
    }
}
function loadReversalDecision() {
    const decisionId = document.getElementById('reversal-original-decision').value;
    if (!decisionId) {
        document.getElementById('reversal-original-summary').style.display = 'none';
        return;
    }
    const gcLog = storage.getGroupConscienceLog();
    const decision = gcLog.find(d => d.id === decisionId);
    if (decision) {
        const summary = document.getElementById('reversal-original-summary');
        summary.style.display = 'block';
        const details = document.getElementById('reversal-original-details');
        details.innerHTML = `
            <div style="margin-bottom: 0.5rem;"><strong>Date:</strong> ${decision.date}</div>
            <div style="margin-bottom: 0.5rem;"><strong>Motion:</strong> ${escapeHtml(decision.item)}</div>
            <div style="margin-bottom: 0.5rem;"><strong>Result:</strong> ${decision.status}</div>
        `;
        const originalDate = new Date(decision.date);
        const today = new Date();
        const monthsElapsed = Math.floor((today - originalDate) / (1000 * 60 * 60 * 24 * 30));
        document.getElementById('reversal-months-elapsed').value = monthsElapsed;
    }
}
function saveDecisionReversal() {
    const originalId = document.getElementById('reversal-original-decision').value;
    const newId = document.getElementById('reversal-new-decision').value;
    const reason = document.getElementById('reversal-reason-category').value;
    const explanation = document.getElementById('reversal-explanation').value.trim();
    const reversalDate = document.getElementById('reversal-date').value;
    const monthsElapsed = parseInt(document.getElementById('reversal-months-elapsed').value);
    const lessonsLearned = document.getElementById('reversal-lessons-learned').value.trim();
    if (!originalId || !newId || !explanation || !lessonsLearned) {
        showToast('Please fill in all required fields', 'error');
        return;
    }
    const gcLog = storage.getGroupConscienceLog();
    const originalDecision = gcLog.find(d => d.id === originalId);
    const newDecision = gcLog.find(d => d.id === newId);
    const reversals = storage.getDecisionReversals();
    reversals.push({
        id: genId(),
        originalId,
        newId,
        originalMotion: originalDecision ? originalDecision.item : 'Unknown',
        newMotion: newDecision ? newDecision.item : 'Unknown',
        reason,
        explanation,
        reversalDate: reversalDate || new Date().toISOString().split('T')[0],
        monthsElapsed,
        lessonsLearned,
        recordedDate: new Date().toISOString()
    });
    storage.saveDecisionReversals(reversals);
    refreshDecisionReversals();
    showToast('Decision reversal recorded', 'success');
    document.getElementById('reversal-explanation').value = '';
    document.getElementById('reversal-lessons-learned').value = '';
    document.getElementById('reversal-original-summary').style.display = 'none';
}
function refreshDecisionReversals() {
    const reversals = storage.getDecisionReversals();
    const tbody = document.getElementById('decision-reversals-body');
    if (!tbody) return;
    tbody.innerHTML = reversals.map(rev => `
        <tr>
            <td>${escapeHtml(rev.originalMotion).substring(0, 40)}...</td>
            <td>${escapeHtml(rev.newMotion).substring(0, 40)}...</td>
            <td>${escapeHtml(rev.reason)}</td>
            <td>${rev.monthsElapsed} months</td>
            <td>${escapeHtml(rev.lessonsLearned).substring(0, 50)}...</td>
            <td><button class="btn small" onclick="viewReversalDetails('${rev.id}')">View</button></td>
        </tr>
    `).join('') || '<tr><td colspan="6" style="text-align: center; opacity: 0.7;">No reversals recorded</td></tr>';
    document.getElementById('total-reversals-count').textContent = reversals.length;
    if (reversals.length > 0) {
        const avgTime = reversals.reduce((sum, r) => sum + r.monthsElapsed, 0) / reversals.length;
        document.getElementById('avg-reversal-time').textContent = `${avgTime.toFixed(1)} mo`;
        const reasonCounts = {};
        reversals.forEach(r => {
            reasonCounts[r.reason] = (reasonCounts[r.reason] || 0) + 1;
        });
        const mostCommon = Object.keys(reasonCounts).reduce((a, b) => reasonCounts[a] > reasonCounts[b] ? a : b, '');
        document.getElementById('most-common-reason').textContent = mostCommon;
        renderReversalReasonsChart(reasonCounts);
    }
}
function viewReversalDetails(reversalId) {
    const reversals = storage.getDecisionReversals();
    const reversal = reversals.find(r => r.id === reversalId);
    if (!reversal) {
        showToast('Reversal not found', 'error');
        return;
    }
    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 2rem;';
    modal.innerHTML = `
        <div style="background: #2c3e50; border-radius: 8px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; padding: 2rem; position: relative;">
            <button onclick="this.closest('div[style*=fixed]').remove()" style="position: absolute; top: 1rem; right: 1rem; background: #e74c3c; border: none; color: white; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
                <i class="fas fa-times"></i> Close
            </button>
            <h2 style="color: #e74c3c; margin-bottom: 1.5rem;"><i class="fas fa-exchange-alt"></i> Decision Reversal Details</h2>
            <div style="margin-bottom: 1.5rem; padding: 1rem; background: #34495e; border-radius: 4px;">
                <h3 style="color: #f39c12; margin-bottom: 1rem;">Original Decision</h3>
                <p style="font-size: 1.1rem; margin-bottom: 0.5rem;">${escapeHtml(reversal.originalMotion)}</p>
            </div>
            <div style="margin-bottom: 1.5rem; padding: 1rem; background: #34495e; border-radius: 4px;">
                <h3 style="color: #2ecc71; margin-bottom: 1rem;">New Decision</h3>
                <p style="font-size: 1.1rem; margin-bottom: 0.5rem;">${escapeHtml(reversal.newMotion)}</p>
            </div>
            <div style="margin-bottom: 1rem;">
                <strong>Reversal Date:</strong> ${reversal.reversalDate}
            </div>
            <div style="margin-bottom: 1rem;">
                <strong>Time Elapsed:</strong> ${reversal.monthsElapsed} months
            </div>
            <div style="margin-bottom: 1rem;">
                <strong>Reason Category:</strong> <span style="color: #f39c12;">${reversal.reason.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase())}</span>
            </div>
            <div style="margin-bottom: 1.5rem; padding: 1rem; background: #34495e; border-radius: 4px;">
                <h4 style="margin-bottom: 0.5rem;">Detailed Explanation</h4>
                <p style="white-space: pre-wrap;">${escapeHtml(reversal.explanation)}</p>
            </div>
            <div style="padding: 1rem; background: #16a085; border-radius: 4px;">
                <h4 style="margin-bottom: 0.5rem;"><i class="fas fa-lightbulb"></i> Lessons Learned</h4>
                <p style="white-space: pre-wrap;">${escapeHtml(reversal.lessonsLearned)}</p>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}
let reversalReasonsChart;
function renderReversalReasonsChart(reasonCounts) {
    const ctx = document.getElementById('reversal-reasons-chart');
    if (!ctx) return;
    const labels = Object.keys(reasonCounts);
    const data = Object.values(reasonCounts);
    const colors = ['#e74c3c', '#f39c12', '#3498db', '#2ecc71', '#9b59b6', '#1abc9c', '#e67e22', '#95a5a6', '#34495e'];
    if (reversalReasonsChart) reversalReasonsChart.destroy();
    reversalReasonsChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels.map(l => l.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase())),
            datasets: [{
                data: data,
                backgroundColor: colors.slice(0, labels.length),
                borderWidth: 2,
                borderColor: '#2c3e50'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'bottom'
                },
                title: {
                    display: true,
                    text: 'Reversal Reasons Distribution',
                    color: '#ecf0f1'
                }
            }
        }
    });
}
function updateWellnessSummary() {
    const members = storage.getMembers();
    const attendance = JSON.parse(localStorage.getItem('memberAttendance') || '{}');
    const summary = document.getElementById('wellness-summary');
    if (!summary) return;

    const today = new Date();
    let seenLast7Days = 0, seenLast30Days = 0, notSeenOver30Days = 0;

    members.forEach(member => {
        const lastSeen = attendance[member.id];
        if (lastSeen) {
            const lastSeenDate = new Date(lastSeen);
            const daysSince = Math.floor((today - lastSeenDate) / (1000 * 60 * 60 * 24));
            if (daysSince <= 7) seenLast7Days++;
            else if (daysSince <= 30) seenLast30Days++;
            else notSeenOver30Days++;
        } else {
            notSeenOver30Days++;
        }
    });

    summary.innerHTML = `
        <div class="box" style="text-align: center; border-left: 4px solid #2ecc71;">
            <h3 style="color: #2ecc71; font-size: 2rem; margin-bottom: 0.5rem;">${seenLast7Days}</h3>
            <p>Seen Last 7 Days</p>
        </div>
        <div class="box" style="text-align: center; border-left: 4px solid #3498db;">
            <h3 style="color: #3498db; font-size: 2rem; margin-bottom: 0.5rem;">${seenLast30Days}</h3>
            <p>Seen Last 30 Days</p>
        </div>
        <div class="box" style="text-align: center; border-left: 4px solid #e74c3c;">
            <h3 style="color: #e74c3c; font-size: 2rem; margin-bottom: 0.5rem;">${notSeenOver30Days}</h3>
            <p>Not Seen Over 30 Days</p>
        </div>
    `;
}

function updateAbsentMembersList() {
    const members = storage.getMembers();
    const attendance = JSON.parse(localStorage.getItem('memberAttendance') || '{}');
    const tbody = document.getElementById('absent-members-body');
    if (!tbody) return;

    const today = new Date();
    const absentMembers = [];

    members.forEach(member => {
        const lastSeen = attendance[member.id];
        let daysSince = null;
        if (lastSeen) {
            const lastSeenDate = new Date(lastSeen);
            daysSince = Math.floor((today - lastSeenDate) / (1000 * 60 * 60 * 24));
        }

        if (!lastSeen || daysSince > 30) {
            absentMembers.push({
                ...member,
                lastSeenDate: lastSeen || 'Never',
                daysSince: daysSince || 'Unknown'
            });
        }
    });

    if (absentMembers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #95a5a6;">All members have been seen in the last 30 days!</td></tr>';
    } else {
        tbody.innerHTML = absentMembers.map(m => `
            <tr>
                <td>${escapeHtml(m.name)}</td>
                <td>${m.lastSeenDate === 'Never' ? 'Never' : new Date(m.lastSeenDate).toLocaleDateString()}</td>
                <td style="color: ${m.daysSince === 'Unknown' || m.daysSince > 60 ? '#e74c3c' : '#f39c12'};">
                    ${m.daysSince} days
                </td>
                <td>
                    ${m.phone ? `<a href="tel:${m.phone}">${escapeHtml(m.phone)}</a>` : 'No phone'}
                    ${m.email ? `<br><a href="mailto:${m.email}">${escapeHtml(m.email)}</a>` : ''}
                </td>
                <td>
                    <button class="btn" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;" onclick="markMemberSeen('${m.id}')">
                        <i class="fas fa-check"></i> Mark Seen Today
                    </button>
                </td>
            </tr>
        `).join('');
    }
}

function markMemberSeen(memberId) {
    const attendance = JSON.parse(localStorage.getItem('memberAttendance') || '{}');
    attendance[memberId] = new Date().toISOString();
    localStorage.setItem('memberAttendance', JSON.stringify(attendance));
    showToast('Member marked as seen today!', 'success');
    updateWellnessSummary();
    updateAbsentMembersList();
}

function populateTempSponsorDropdown() {
    const members = storage.getMembers();
    const select = document.getElementById('temp-sponsor-newcomer');
    if (!select) return;

    const newcomers = members.filter(m => m.membershipStatus === 'newcomer');
    select.innerHTML = '<option value="">Select newcomer...</option>' +
        newcomers.map(m => `<option value="${m.id}">${escapeHtml(m.name)}</option>`).join('');
}

function requestTemporarySponsor() {
    const newcomerId = document.getElementById('temp-sponsor-newcomer').value;
    const genderPref = document.getElementById('temp-sponsor-gender-pref').value;
    const duration = parseInt(document.getElementById('temp-sponsor-duration').value);

    if (!newcomerId) {
        showToast('Please select a newcomer.', 'error');
        return;
    }

    const members = storage.getMembers();
    const newcomer = members.find(m => m.id === newcomerId);
    if (!newcomer) {
        showToast('Newcomer not found.', 'error');
        return;
    }

    const availableSponsors = members.filter(m =>
        m.availableToSponsor &&
        (!genderPref || m.gender === genderPref) &&
        m.id !== newcomerId
    );

    if (availableSponsors.length === 0) {
        showToast('No available sponsors matching criteria.', 'error');
        return;
    }

    const selectedSponsor = availableSponsors.sort((a, b) => {
        const aSober = a.sobrietyDate ? new Date(a.sobrietyDate) : new Date();
        const bSober = b.sobrietyDate ? new Date(b.sobrietyDate) : new Date();
        return aSober - bSober;
    })[0];

    const tempSponsorships = JSON.parse(localStorage.getItem('tempSponsorships') || '[]');
    tempSponsorships.push({
        id: genId(),
        newcomerId: newcomer.id,
        newcomerName: newcomer.name,
        sponsorId: selectedSponsor.id,
        sponsorName: selectedSponsor.name,
        sponsorPhone: selectedSponsor.phone,
        sponsorEmail: selectedSponsor.email,
        startDate: new Date().toISOString(),
        endDate: new Date(Date.now() + duration * 24 * 60 * 60 * 1000).toISOString(),
        status: 'active'
    });
    localStorage.setItem('tempSponsorships', JSON.stringify(tempSponsorships));

    showToast(`Temporary sponsor ${selectedSponsor.name} assigned to ${newcomer.name}!`, 'success');
    updateTempSponsorList();

    document.getElementById('temp-sponsor-newcomer').value = '';
    document.getElementById('temp-sponsor-gender-pref').value = '';
    document.getElementById('temp-sponsor-duration').value = '30';
}

function updateTempSponsorList() {
    const tempSponsorships = JSON.parse(localStorage.getItem('tempSponsorships') || '[]');
    const container = document.getElementById('temp-sponsor-list');
    if (!container) return;

    const activeSponsorships = tempSponsorships.filter(s => s.status === 'active');

    if (activeSponsorships.length === 0) {
        container.innerHTML = '<p style="color: #95a5a6; text-align: center;">No active temporary sponsorships.</p>';
    } else {
        container.innerHTML = activeSponsorships.map(s => {
            const endDate = new Date(s.endDate);
            const daysRemaining = Math.ceil((endDate - new Date()) / (1000 * 60 * 60 * 24));
            const isExpiringSoon = daysRemaining <= 7;

            return `
                <div class="box mb-4" style="border-left: 4px solid ${isExpiringSoon ? '#e74c3c' : '#3498db'};">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h4 style="color: #3498db; margin-bottom: 0.5rem;">${escapeHtml(s.newcomerName)}</h4>
                            <p style="margin-bottom: 0.5rem;"><strong>Temporary Sponsor:</strong> ${escapeHtml(s.sponsorName)}</p>
                            <p style="margin-bottom: 0.5rem; font-size: 0.9rem;">
                                <i class="fas fa-phone"></i> ${escapeHtml(s.sponsorPhone || 'No phone')}
                                ${s.sponsorEmail ? `<br><i class="fas fa-envelope"></i> ${escapeHtml(s.sponsorEmail)}` : ''}
                            </p>
                            <p style="font-size: 0.9rem; color: ${isExpiringSoon ? '#e74c3c' : '#95a5a6'};">
                                ${daysRemaining > 0 ? `${daysRemaining} days remaining` : 'Expired'}
                            </p>
                        </div>
                        <div>
                            <button class="btn secondary" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;"
                                onclick="endTempSponsorship('${s.id}')">
                                <i class="fas fa-check"></i> End Sponsorship
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
}

function endTempSponsorship(id) {
    const tempSponsorships = JSON.parse(localStorage.getItem('tempSponsorships') || '[]');
    const sponsorship = tempSponsorships.find(s => s.id === id);
    if (sponsorship) {
        sponsorship.status = 'completed';
        sponsorship.endedAt = new Date().toISOString();
        localStorage.setItem('tempSponsorships', JSON.stringify(tempSponsorships));
        showToast('Temporary sponsorship ended.', 'success');
        updateTempSponsorList();
    }
}

function populateEmergencyContactDropdown() {
    const members = storage.getMembers();
    const select = document.getElementById('emergency-contact-member');
    if (!select) return;

    select.innerHTML = '<option value="">Select member...</option>' +
        members.map(m => `<option value="${m.id}">${escapeHtml(m.name)}</option>`).join('');
}

function saveEmergencyContact() {
    const memberId = document.getElementById('emergency-contact-member').value;
    const tier = document.getElementById('emergency-contact-tier').value;
    const available24_7 = document.getElementById('emergency-contact-available-24-7').checked;

    if (!memberId) {
        showToast('Please select a member.', 'error');
        return;
    }

    const members = storage.getMembers();
    const member = members.find(m => m.id === memberId);
    if (!member) {
        showToast('Member not found.', 'error');
        return;
    }

    const emergencyContacts = JSON.parse(localStorage.getItem('emergencyContacts') || '[]');

    const existing = emergencyContacts.find(c => c.memberId === memberId && c.tier === tier);
    if (existing) {
        showToast('Member is already in this tier.', 'error');
        return;
    }

    emergencyContacts.push({
        id: genId(),
        memberId: member.id,
        name: member.name,
        phone: member.phone,
        email: member.email,
        tier: tier,
        available24_7: available24_7,
        addedAt: new Date().toISOString()
    });
    localStorage.setItem('emergencyContacts', JSON.stringify(emergencyContacts));

    showToast(`${member.name} added to emergency contact network!`, 'success');
    updateEmergencyContactDisplay();

    document.getElementById('emergency-contact-member').value = '';
    document.getElementById('emergency-contact-tier').value = '1';
    document.getElementById('emergency-contact-available-24-7').checked = false;
}

function updateEmergencyContactDisplay() {
    const emergencyContacts = JSON.parse(localStorage.getItem('emergencyContacts') || '[]');

    for (let tier = 1; tier <= 3; tier++) {
        const container = document.getElementById(`tier-${tier}-contacts`);
        if (!container) continue;

        const tierContacts = emergencyContacts.filter(c => c.tier === tier.toString());

        if (tierContacts.length === 0) {
            container.innerHTML = '<p style="color: #95a5a6; font-size: 0.9rem;">No contacts in this tier.</p>';
        } else {
            container.innerHTML = tierContacts.map(c => `
                <div class="box mb-2" style="padding: 0.75rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${escapeHtml(c.name)}</strong>
                            ${c.available24_7 ? '<span style="color: #2ecc71; margin-left: 0.5rem;"><i class="fas fa-clock"></i> 24/7</span>' : ''}
                            <br>
                            <span style="font-size: 0.9rem;">
                                <i class="fas fa-phone"></i> <a href="tel:${c.phone}">${escapeHtml(c.phone || 'No phone')}</a>
                                ${c.email ? `<br><i class="fas fa-envelope"></i> <a href="mailto:${c.email}">${escapeHtml(c.email)}</a>` : ''}
                            </span>
                        </div>
                        <button class="btn secondary" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;"
                            onclick="removeEmergencyContact('${c.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }
    }
}

function removeEmergencyContact(id) {
    if (!confirm('Remove this member from emergency contacts?')) return;

    let emergencyContacts = JSON.parse(localStorage.getItem('emergencyContacts') || '[]');
    emergencyContacts = emergencyContacts.filter(c => c.id !== id);
    localStorage.setItem('emergencyContacts', JSON.stringify(emergencyContacts));

    showToast('Contact removed from emergency network.', 'success');
    updateEmergencyContactDisplay();
}

function submitProblemBoxItem() {
    const category = document.getElementById('problem-box-category').value;
    const text = document.getElementById('problem-box-text').value.trim();
    const urgent = document.getElementById('problem-box-urgent').checked;

    if (!text) {
        showToast('Please enter a suggestion or concern.', 'error');
        return;
    }

    const problemBoxItems = JSON.parse(localStorage.getItem('problemBoxItems') || '[]');
    problemBoxItems.push({
        id: genId(),
        category: category,
        text: text,
        urgent: urgent,
        status: 'pending',
        submittedAt: new Date().toISOString()
    });
    localStorage.setItem('problemBoxItems', JSON.stringify(problemBoxItems));

    showToast('Thank you! Your feedback has been submitted anonymously.', 'success');

    document.getElementById('problem-box-text').value = '';
    document.getElementById('problem-box-category').value = 'meeting-format';
    document.getElementById('problem-box-urgent').checked = false;

    updateProblemBoxDisplay();
}

function updateProblemBoxDisplay() {
    const problemBoxItems = JSON.parse(localStorage.getItem('problemBoxItems') || '[]');
    const container = document.getElementById('problem-box-items');
    if (!container) return;

    const pendingItems = problemBoxItems.filter(item => item.status === 'pending');

    if (pendingItems.length === 0) {
        container.innerHTML = '<p style="color: #95a5a6; text-align: center;">No pending items.</p>';
    } else {
        container.innerHTML = pendingItems.map(item => {
            const categoryColors = {
                'meeting-format': '#3498db',
                'fellowship': '#2ecc71',
                'service': '#9b59b6',
                'facility': '#f39c12',
                'traditions': '#e74c3c',
                'other': '#95a5a6'
            };
            const color = categoryColors[item.category] || '#95a5a6';

            return `
                <div class="box mb-2" style="border-left: 4px solid ${color}; ${item.urgent ? 'background: #3d2d2d;' : ''}">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <div style="margin-bottom: 0.5rem;">
                                <span style="background: ${color}; color: white; padding: 2px 8px; border-radius: 3px; font-size: 0.75rem; font-weight: bold;">
                                    ${item.category.replace(/-/g, ' ').toUpperCase()}
                                </span>
                                ${item.urgent ? '<span style="background: #e74c3c; color: white; padding: 2px 8px; border-radius: 3px; font-size: 0.75rem; font-weight: bold; margin-left: 0.5rem;">URGENT</span>' : ''}
                            </div>
                            <p style="margin-bottom: 0.5rem;">${escapeHtml(item.text)}</p>
                            <p style="font-size: 0.85rem; color: #95a5a6;">
                                Submitted: ${new Date(item.submittedAt).toLocaleDateString()}
                            </p>
                        </div>
                        <div style="margin-left: 1rem;">
                            <button class="btn" style="padding: 0.3rem 0.6rem; font-size: 0.8rem; margin-bottom: 0.5rem;"
                                onclick="resolveProblemBoxItem('${item.id}')">
                                <i class="fas fa-check"></i> Resolve
                            </button>
                            <br>
                            <button class="btn secondary" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;"
                                onclick="deleteProblemBoxItem('${item.id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
}

function resolveProblemBoxItem(id) {
    const problemBoxItems = JSON.parse(localStorage.getItem('problemBoxItems') || '[]');
    const item = problemBoxItems.find(i => i.id === id);
    if (item) {
        item.status = 'resolved';
        item.resolvedAt = new Date().toISOString();
        localStorage.setItem('problemBoxItems', JSON.stringify(problemBoxItems));
        showToast('Item marked as resolved.', 'success');
        updateProblemBoxDisplay();
    }
}

function deleteProblemBoxItem(id) {
    if (!confirm('Delete this item?')) return;

    let problemBoxItems = JSON.parse(localStorage.getItem('problemBoxItems') || '[]');
    problemBoxItems = problemBoxItems.filter(i => i.id !== id);
    localStorage.setItem('problemBoxItems', JSON.stringify(problemBoxItems));

    showToast('Item deleted.', 'success');
    updateProblemBoxDisplay();
}

function submitSatisfactionSurvey() {
    const meetingSatisfaction = document.getElementById('survey-meeting-satisfaction').value;
    const fellowshipRating = document.getElementById('survey-fellowship-rating').value;
    const gcParticipation = document.getElementById('survey-gc-participation').value;
    const newcomerWelcome = document.getElementById('survey-newcomer-welcome').value;
    const comments = document.getElementById('survey-comments').value.trim();

    if (!meetingSatisfaction || !fellowshipRating || !gcParticipation || !newcomerWelcome) {
        showToast('Please answer all required questions.', 'error');
        return;
    }

    const surveys = JSON.parse(localStorage.getItem('satisfactionSurveys') || '[]');
    surveys.push({
        id: genId(),
        meetingSatisfaction: parseInt(meetingSatisfaction),
        fellowshipRating: parseInt(fellowshipRating),
        gcParticipation: parseInt(gcParticipation),
        newcomerWelcome: parseInt(newcomerWelcome),
        comments: comments,
        submittedAt: new Date().toISOString()
    });
    localStorage.setItem('satisfactionSurveys', JSON.stringify(surveys));

    showToast('Thank you for your feedback!', 'success');

    document.getElementById('survey-meeting-satisfaction').value = '';
    document.getElementById('survey-fellowship-rating').value = '';
    document.getElementById('survey-gc-participation').value = '';
    document.getElementById('survey-newcomer-welcome').value = '';
    document.getElementById('survey-comments').value = '';

    updateSurveyResults();
}

function updateSurveyResults() {
    const surveys = JSON.parse(localStorage.getItem('satisfactionSurveys') || '[]');
    const container = document.getElementById('survey-results');
    const countEl = document.getElementById('survey-response-count');

    if (!container) return;
    if (countEl) countEl.textContent = surveys.length;

    if (surveys.length === 0) {
        container.innerHTML = '<p style="color: #95a5a6; text-align: center;">No survey responses yet.</p>';
        return;
    }

    const avgMeeting = (surveys.reduce((sum, s) => sum + s.meetingSatisfaction, 0) / surveys.length).toFixed(1);
    const avgFellowship = (surveys.reduce((sum, s) => sum + s.fellowshipRating, 0) / surveys.length).toFixed(1);
    const avgGC = (surveys.reduce((sum, s) => sum + s.gcParticipation, 0) / surveys.length).toFixed(1);
    const avgNewcomer = (surveys.reduce((sum, s) => sum + s.newcomerWelcome, 0) / surveys.length).toFixed(1);

    const getColor = (rating) => {
        if (rating >= 4) return '#2ecc71';
        if (rating >= 3) return '#f39c12';
        return '#e74c3c';
    };

    container.innerHTML = `
        <div class="grid grid-cols-2">
            <div class="box" style="text-align: center; border-left: 4px solid ${getColor(avgMeeting)};">
                <h4 style="color: ${getColor(avgMeeting)}; font-size: 2rem; margin-bottom: 0.5rem;">${avgMeeting}/5</h4>
                <p>Meeting Format Satisfaction</p>
            </div>
            <div class="box" style="text-align: center; border-left: 4px solid ${getColor(avgFellowship)};">
                <h4 style="color: ${getColor(avgFellowship)}; font-size: 2rem; margin-bottom: 0.5rem;">${avgFellowship}/5</h4>
                <p>Fellowship Atmosphere</p>
            </div>
            <div class="box" style="text-align: center; border-left: 4px solid ${getColor(avgGC)};">
                <h4 style="color: ${getColor(avgGC)}; font-size: 2rem; margin-bottom: 0.5rem;">${avgGC}/5</h4>
                <p>Feel Heard at GC Meetings</p>
            </div>
            <div class="box" style="text-align: center; border-left: 4px solid ${getColor(avgNewcomer)};">
                <h4 style="color: ${getColor(avgNewcomer)}; font-size: 2rem; margin-bottom: 0.5rem;">${avgNewcomer}/5</h4>
                <p>Newcomer Welcome</p>
            </div>
        </div>

        ${surveys.filter(s => s.comments).length > 0 ? `
            <div class="box mt-4">
                <h4>Recent Comments</h4>
                ${surveys.filter(s => s.comments).slice(-5).reverse().map(s => `
                    <div style="padding: 0.5rem; margin: 0.5rem 0; background: #2c3e50; border-left: 3px solid #3498db; border-radius: 3px;">
                        <p style="font-size: 0.9rem;">"${escapeHtml(s.comments)}"</p>
                        <p style="font-size: 0.75rem; color: #95a5a6; margin-top: 0.25rem;">
                            ${new Date(s.submittedAt).toLocaleDateString()}
                        </p>
                    </div>
                `).join('')}
            </div>
        ` : ''}
    `;
}

function updateStreakLeaderboard() {
    const members = storage.getMembers();
    const attendance = JSON.parse(localStorage.getItem('memberAttendance') || '{}');
    const streaks = calculateAllStreaks(members, attendance);
    const container = document.getElementById('streak-leaderboard');
    if (!container) return;

    const topStreaks = streaks.sort((a, b) => b.currentStreak - a.currentStreak).slice(0, 5);

    if (topStreaks.length === 0 || topStreaks[0].currentStreak === 0) {
        container.innerHTML = '<p style="color: #95a5a6; text-align: center;">No attendance data yet. Start tracking attendance!</p>';
    } else {
        container.innerHTML = topStreaks.map((s, index) => {
            const medal = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : '';
            return `
                <div class="box mb-2" style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem;">
                    <div>
                        <span style="font-size: 1.5rem; margin-right: 0.5rem;">${medal}</span>
                        <strong>${escapeHtml(s.name)}</strong>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 1.5rem; color: #2ecc71; font-weight: bold;">
                            ${s.currentStreak} <i class="fas fa-fire"></i>
                        </div>
                        <div style="font-size: 0.8rem; color: #95a5a6;">
                            ${s.currentStreak === 1 ? '1 day' : s.currentStreak + ' days'}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
}

function updateAllStreaks() {
    const members = storage.getMembers();
    const attendance = JSON.parse(localStorage.getItem('memberAttendance') || '{}');
    const streaks = calculateAllStreaks(members, attendance);
    const tbody = document.getElementById('all-streaks-body');
    if (!tbody) return;

    if (streaks.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #95a5a6;">No members found.</td></tr>';
    } else {
        tbody.innerHTML = streaks.map(s => {
            const badges = getStreakBadges(s.bestStreak);
            return `
                <tr>
                    <td>${escapeHtml(s.name)}</td>
                    <td style="color: #2ecc71; font-weight: bold;">
                        ${s.currentStreak > 0 ? s.currentStreak + ' days <i class="fas fa-fire"></i>' : '0'}
                    </td>
                    <td>${s.bestStreak} days</td>
                    <td>${badges}</td>
                    <td>${s.lastAttendance ? new Date(s.lastAttendance).toLocaleDateString() : 'Never'}</td>
                </tr>
            `;
        }).join('');
    }
}

function calculateAllStreaks(members, attendance) {
    return members.map(member => {
        const lastSeen = attendance[member.id];
        const currentStreak = calculateStreak(member.id, attendance);
        const bestStreak = parseInt(localStorage.getItem(`bestStreak_${member.id}`) || '0');

        if (currentStreak > bestStreak) {
            localStorage.setItem(`bestStreak_${member.id}`, currentStreak.toString());
        }

        return {
            name: member.name,
            currentStreak: currentStreak,
            bestStreak: Math.max(currentStreak, bestStreak),
            lastAttendance: lastSeen
        };
    });
}

function calculateStreak(memberId, attendance) {
    const lastSeen = attendance[memberId];
    if (!lastSeen) return 0;

    const lastSeenDate = new Date(lastSeen);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    lastSeenDate.setHours(0, 0, 0, 0);

    const daysSince = Math.floor((today - lastSeenDate) / (1000 * 60 * 60 * 24));

    if (daysSince > 7) return 0;

    return daysSince <= 1 ? Math.max(1, parseInt(localStorage.getItem(`streak_${memberId}`) || '1')) : 0;
}

function getStreakBadges(streak) {
    const badges = [];
    if (streak >= 365) badges.push('<span style="background: linear-gradient(135deg, #4169e1, #6495ed); color: white; padding: 3px 8px; border-radius: 3px; font-size: 0.75rem; margin-right: 0.25rem;"><i class="fas fa-crown"></i> 365</span>');
    if (streak >= 180) badges.push('<span style="background: linear-gradient(135deg, #c0c0c0, #e0e0e0); color: #333; padding: 3px 8px; border-radius: 3px; font-size: 0.75rem; margin-right: 0.25rem;"><i class="fas fa-star"></i> 180</span>');
    if (streak >= 90) badges.push('<span style="background: linear-gradient(135deg, #cd7f32, #e89a3c); color: white; padding: 3px 8px; border-radius: 3px; font-size: 0.75rem; margin-right: 0.25rem;"><i class="fas fa-medal"></i> 90</span>');
    if (streak >= 30) badges.push('<span style="background: linear-gradient(135deg, #ffd700, #ffed4e); color: #333; padding: 3px 8px; border-radius: 3px; font-size: 0.75rem;"><i class="fas fa-trophy"></i> 30</span>');
    return badges.join('') || '<span style="color: #95a5a6;">None yet</span>';
}

function populateCommitmentMemberDropdown() {
    const members = storage.getMembers();
    const select = document.getElementById('commitment-member');
    if (!select) return;

    select.innerHTML = '<option value="">Select member...</option>' +
        members.map(m => `<option value="${m.id}">${escapeHtml(m.name)}</option>`).join('');
}

function logCommitment() {
    const memberId = document.getElementById('commitment-member').value;
    const type = document.getElementById('commitment-type').value;
    const date = document.getElementById('commitment-date').value;
    const notes = document.getElementById('commitment-notes').value.trim();

    if (!memberId || !type || !date) {
        showToast('Please fill in all required fields.', 'error');
        return;
    }

    const members = storage.getMembers();
    const member = members.find(m => m.id === memberId);
    if (!member) {
        showToast('Member not found.', 'error');
        return;
    }

    const commitments = JSON.parse(localStorage.getItem('commitments') || '[]');
    commitments.push({
        id: genId(),
        memberId: member.id,
        memberName: member.name,
        type: type,
        date: date,
        notes: notes,
        loggedAt: new Date().toISOString()
    });
    localStorage.setItem('commitments', JSON.stringify(commitments));

    showToast('Commitment logged successfully!', 'success');

    document.getElementById('commitment-member').value = '';
    document.getElementById('commitment-type').value = 'coffee';
    document.getElementById('commitment-date').value = '';
    document.getElementById('commitment-notes').value = '';

    updateCommitmentHistory();
    updateCommitmentLeaderboard();
}

function updateCommitmentHistory() {
    const commitments = JSON.parse(localStorage.getItem('commitments') || '[]');
    const container = document.getElementById('commitment-history');
    if (!container) return;

    const recentCommitments = commitments.slice(-20).reverse();

    if (recentCommitments.length === 0) {
        container.innerHTML = '<p style="color: #95a5a6; text-align: center;">No commitments logged yet.</p>';
    } else {
        container.innerHTML = recentCommitments.map(c => {
            const typeIcons = {
                'coffee': '☕',
                'greeter': '👋',
                'setup': '🪑',
                'cleanup': '🧹',
                'literature': '📚',
                'chips': '🏅',
                'other': '✨'
            };
            const icon = typeIcons[c.type] || '✨';

            return `
                <div class="box mb-2" style="padding: 0.75rem; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <span style="font-size: 1.5rem; margin-right: 0.5rem;">${icon}</span>
                        <strong>${escapeHtml(c.memberName)}</strong> - ${c.type.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}
                        <div style="font-size: 0.85rem; color: #95a5a6; margin-top: 0.25rem;">
                            ${new Date(c.date).toLocaleDateString()}
                            ${c.notes ? `<br><em>"${escapeHtml(c.notes)}"</em>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
}

function updateCommitmentLeaderboard() {
    const commitments = JSON.parse(localStorage.getItem('commitments') || '[]');
    const container = document.getElementById('commitment-leaderboard');
    if (!container) return;

    const thisMonth = new Date();
    thisMonth.setDate(1);
    thisMonth.setHours(0, 0, 0, 0);

    const monthlyCommitments = commitments.filter(c => new Date(c.date) >= thisMonth);

    const counts = {};
    monthlyCommitments.forEach(c => {
        counts[c.memberName] = (counts[c.memberName] || 0) + 1;
    });

    const leaderboard = Object.entries(counts)
        .map(([name, count]) => ({ name, count }))
        .sort((a, b) => b.count - a.count)
        .slice(0, 10);

    if (leaderboard.length === 0) {
        container.innerHTML = '<p style="color: #95a5a6; text-align: center;">No commitments this month yet.</p>';
    } else {
        container.innerHTML = leaderboard.map((entry, index) => {
            const medal = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : '';
            return `
                <div class="box mb-2" style="padding: 0.75rem; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <span style="font-size: 1.5rem; margin-right: 0.5rem;">${medal}</span>
                        <strong>${escapeHtml(entry.name)}</strong>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 1.5rem; color: #16a085; font-weight: bold;">
                            ${entry.count}
                        </div>
                        <div style="font-size: 0.8rem; color: #95a5a6;">
                            ${entry.count === 1 ? '1 commitment' : entry.count + ' commitments'}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
}

function submitMeetingFeedback() {
    const meetingType = document.getElementById('feedback-meeting-type').value;
    const rating = document.getElementById('feedback-rating').value;
    const positives = document.getElementById('feedback-positives').value.trim();
    const improvements = document.getElementById('feedback-improvements').value.trim();

    if (!rating) {
        showToast('Please provide a rating.', 'error');
        return;
    }

    const feedbacks = JSON.parse(localStorage.getItem('meetingFeedbacks') || '[]');
    feedbacks.push({
        id: genId(),
        meetingType: meetingType,
        rating: parseInt(rating),
        positives: positives,
        improvements: improvements,
        submittedAt: new Date().toISOString()
    });
    localStorage.setItem('meetingFeedbacks', JSON.stringify(feedbacks));

    showToast('Thank you for your feedback!', 'success');

    document.getElementById('feedback-meeting-type').value = 'speaker';
    document.getElementById('feedback-rating').value = '';
    document.getElementById('feedback-positives').value = '';
    document.getElementById('feedback-improvements').value = '';

    updateFeedbackSummary();
}

function updateFeedbackSummary() {
    const feedbacks = JSON.parse(localStorage.getItem('meetingFeedbacks') || '[]');
    const container = document.getElementById('feedback-summary');
    if (!container) return;

    if (feedbacks.length === 0) {
        container.innerHTML = '<p style="color: #95a5a6; text-align: center;">No feedback submitted yet.</p>';
        return;
    }

    const byType = {};
    feedbacks.forEach(f => {
        if (!byType[f.meetingType]) {
            byType[f.meetingType] = { ratings: [], positives: [], improvements: [] };
        }
        byType[f.meetingType].ratings.push(f.rating);
        if (f.positives) byType[f.meetingType].positives.push(f.positives);
        if (f.improvements) byType[f.meetingType].improvements.push(f.improvements);
    });

    container.innerHTML = Object.entries(byType).map(([type, data]) => {
        const avgRating = (data.ratings.reduce((a, b) => a + b, 0) / data.ratings.length).toFixed(1);
        const color = avgRating >= 4 ? '#2ecc71' : avgRating >= 3 ? '#f39c12' : '#e74c3c';

        return `
            <div class="box mb-4" style="border-left: 4px solid ${color};">
                <h4 style="color: ${color}; margin-bottom: 1rem;">
                    ${type.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}
                </h4>
                <div class="grid grid-cols-2 mb-4">
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; color: ${color}; font-weight: bold;">${avgRating}/5</div>
                        <div style="font-size: 0.9rem; color: #95a5a6;">Average Rating</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold;">${data.ratings.length}</div>
                        <div style="font-size: 0.9rem; color: #95a5a6;">Responses</div>
                    </div>
                </div>
                ${data.positives.length > 0 ? `
                    <div class="mb-2">
                        <strong style="color: #2ecc71;">What's Working:</strong>
                        <ul style="margin: 0.5rem 0 0 1.5rem;">
                            ${data.positives.slice(-3).map(p => `<li style="font-size: 0.9rem;">${escapeHtml(p)}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
                ${data.improvements.length > 0 ? `
                    <div>
                        <strong style="color: #f39c12;">Suggestions:</strong>
                        <ul style="margin: 0.5rem 0 0 1.5rem;">
                            ${data.improvements.slice(-3).map(i => `<li style="font-size: 0.9rem;">${escapeHtml(i)}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
            </div>
        `;
    }).join('');
}

function bookSpeaker() {
    const name = document.getElementById('speaker-name').value.trim();
    const date = document.getElementById('speaker-date').value;
    const phone = document.getElementById('speaker-phone').value.trim();
    const email = document.getElementById('speaker-email').value.trim();
    const topic = document.getElementById('speaker-topic').value.trim();
    const notes = document.getElementById('speaker-notes').value.trim();

    if (!name || !date) {
        showToast('Please provide speaker name and date.', 'error');
        return;
    }

    const speakers = JSON.parse(localStorage.getItem('speakers') || '[]');
    speakers.push({
        id: genId(),
        name: name,
        date: date,
        phone: phone,
        email: email,
        topic: topic,
        notes: notes,
        status: 'confirmed',
        bookedAt: new Date().toISOString()
    });
    localStorage.setItem('speakers', JSON.stringify(speakers));

    showToast(`Speaker ${name} booked for ${new Date(date).toLocaleDateString()}!`, 'success');

    document.getElementById('speaker-name').value = '';
    document.getElementById('speaker-date').value = '';
    document.getElementById('speaker-phone').value = '';
    document.getElementById('speaker-email').value = '';
    document.getElementById('speaker-topic').value = '';
    document.getElementById('speaker-notes').value = '';

    updateSpeakerSchedule();
}

function updateSpeakerSchedule() {
    const speakers = JSON.parse(localStorage.getItem('speakers') || '[]');
    const tbody = document.getElementById('speaker-schedule-body');
    if (!tbody) return;

    const upcoming = speakers
        .filter(s => new Date(s.date) >= new Date())
        .sort((a, b) => new Date(a.date) - new Date(b.date));

    if (upcoming.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #95a5a6;">No speakers scheduled yet.</td></tr>';
    } else {
        tbody.innerHTML = upcoming.map(s => `
            <tr>
                <td>${new Date(s.date).toLocaleDateString()}</td>
                <td><strong>${escapeHtml(s.name)}</strong></td>
                <td>${escapeHtml(s.topic || 'Not specified')}</td>
                <td>
                    ${s.phone ? `<i class="fas fa-phone"></i> ${escapeHtml(s.phone)}<br>` : ''}
                    ${s.email ? `<i class="fas fa-envelope"></i> ${escapeHtml(s.email)}` : ''}
                </td>
                <td>
                    <button class="btn secondary" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;"
                        onclick="cancelSpeaker('${s.id}')">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </td>
            </tr>
        `).join('');
    }
}

function cancelSpeaker(id) {
    if (!confirm('Cancel this speaker booking?')) return;

    let speakers = JSON.parse(localStorage.getItem('speakers') || '[]');
    speakers = speakers.filter(s => s.id !== id);
    localStorage.setItem('speakers', JSON.stringify(speakers));

    showToast('Speaker booking cancelled.', 'success');
    updateSpeakerSchedule();
}

function populateChipMemberDropdown() {
    const members = storage.getMembers();
    const select = document.getElementById('chip-member');
    if (!select) return;

    select.innerHTML = '<option value="">Select member...</option>' +
        members.map(m => `<option value="${m.id}">${escapeHtml(m.name)}</option>`).join('');
}

function scheduleChipCeremony() {
    const memberId = document.getElementById('chip-member').value;
    const milestone = document.getElementById('chip-milestone').value;
    const date = document.getElementById('chip-date').value;
    const years = document.getElementById('chip-years').value;
    const notify = document.getElementById('chip-notify').checked;

    if (!memberId || !milestone || !date) {
        showToast('Please fill in all required fields.', 'error');
        return;
    }

    if (milestone === 'multiple-years' && !years) {
        showToast('Please specify number of years.', 'error');
        return;
    }

    const members = storage.getMembers();
    const member = members.find(m => m.id === memberId);
    if (!member) {
        showToast('Member not found.', 'error');
        return;
    }

    const ceremonies = JSON.parse(localStorage.getItem('chipCeremonies') || '[]');
    ceremonies.push({
        id: genId(),
        memberId: member.id,
        memberName: member.name,
        milestone: milestone,
        years: years ? parseInt(years) : null,
        date: date,
        notify: notify,
        status: 'scheduled',
        scheduledAt: new Date().toISOString()
    });
    localStorage.setItem('chipCeremonies', JSON.stringify(ceremonies));

    showToast(`Chip ceremony scheduled for ${member.name}!`, 'success');

    document.getElementById('chip-member').value = '';
    document.getElementById('chip-milestone').value = '24-hours';
    document.getElementById('chip-date').value = '';
    document.getElementById('chip-years').value = '';
    document.getElementById('chip-notify').checked = false;

    updateUpcomingChipCeremonies();
}

function updateUpcomingChipCeremonies() {
    const ceremonies = JSON.parse(localStorage.getItem('chipCeremonies') || '[]');
    const container = document.getElementById('upcoming-chip-ceremonies');
    if (!container) return;

    const upcoming = ceremonies
        .filter(c => c.status === 'scheduled' && new Date(c.date) >= new Date())
        .sort((a, b) => new Date(a.date) - new Date(b.date));

    if (upcoming.length === 0) {
        container.innerHTML = '<p style="color: #95a5a6; text-align: center;">No upcoming chip ceremonies.</p>';
    } else {
        container.innerHTML = upcoming.map(c => {
            const chipColors = {
                '24-hours': '#ecf0f1',
                '30-days': '#ecf0f1',
                '60-days': '#ecf0f1',
                '90-days': '#e74c3c',
                '6-months': '#2ecc71',
                '9-months': '#f39c12',
                '1-year': '#cd7f32',
                '18-months': '#9b59b6',
                'multiple-years': '#3498db'
            };
            const color = chipColors[c.milestone] || '#95a5a6';

            return `
                <div class="box mb-2" style="border-left: 4px solid ${color}; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>${escapeHtml(c.memberName)}</strong>
                        <div style="margin-top: 0.25rem;">
                            <span style="background: ${color}; color: ${color === '#ecf0f1' ? '#333' : 'white'}; padding: 3px 8px; border-radius: 3px; font-size: 0.75rem; font-weight: bold;">
                                ${c.milestone === 'multiple-years' ? c.years + ' YEARS' : c.milestone.toUpperCase()}
                            </span>
                        </div>
                        <div style="font-size: 0.85rem; color: #95a5a6; margin-top: 0.5rem;">
                            <i class="fas fa-calendar"></i> ${new Date(c.date).toLocaleDateString()}
                            ${c.notify ? '<i class="fas fa-bell" style="margin-left: 0.5rem;"></i>' : ''}
                        </div>
                    </div>
                    <button class="btn secondary" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;"
                        onclick="completeChipCeremony('${c.id}')">
                        <i class="fas fa-check"></i> Complete
                    </button>
                </div>
            `;
        }).join('');
    }
}

function completeChipCeremony(id) {
    const ceremonies = JSON.parse(localStorage.getItem('chipCeremonies') || '[]');
    const ceremony = ceremonies.find(c => c.id === id);
    if (ceremony) {
        ceremony.status = 'completed';
        ceremony.completedAt = new Date().toISOString();
        localStorage.setItem('chipCeremonies', JSON.stringify(ceremonies));
        showToast('Chip ceremony marked as completed!', 'success');
        updateUpcomingChipCeremonies();
    }
}

function updateMeetingAnalytics() {
    const attendance = JSON.parse(localStorage.getItem('meetingAttendanceRecords') || '[]');
    const trends = document.getElementById('attendance-trends');
    if (!trends) return;
    trends.innerHTML = '<p>Analytics dashboard - track meeting popularity</p>';
}

function populateRotationMembers() {
    const members = storage.getMembers();
    const select = document.getElementById('rotation-members');
    if (!select) return;
    select.innerHTML = members.map(m => `<option value="${m.id}">${escapeHtml(m.name)}</option>`).join('');
}
function saveRoleRotation() {
    const role = document.getElementById('rotation-role').value;
    const selected = Array.from(document.getElementById('rotation-members').selectedOptions).map(o => o.value);
    const rotations = JSON.parse(localStorage.getItem('roleRotations') || '{}');
    rotations[role] = selected;
    localStorage.setItem('roleRotations', JSON.stringify(rotations));
    showToast('Rotation saved!', 'success');
    updateRoleAssignments();
}
function updateRoleAssignments() {
    const container = document.getElementById('role-assignments');
    if (!container) return;
    container.innerHTML = '<p>Upcoming role assignments will appear here</p>';
}

function saveVirtualMeeting() {
    const name = document.getElementById('virtual-meeting-name').value.trim();
    const platform = document.getElementById('virtual-platform').value;
    const link = document.getElementById('virtual-meeting-link').value.trim();
    if (!name || !link) return showToast('Please fill in required fields', 'error');
    const meetings = JSON.parse(localStorage.getItem('virtualMeetings') || '[]');
    meetings.push({id: genId(), name, platform, link, addedAt: new Date().toISOString()});
    localStorage.setItem('virtualMeetings', JSON.stringify(meetings));
    showToast('Virtual meeting saved!', 'success');
    updateVirtualMeetingsList();
}
function updateVirtualMeetingsList() {
    const meetings = JSON.parse(localStorage.getItem('virtualMeetings') || '[]');
    const container = document.getElementById('virtual-meetings-list');
    if (!container) return;
    if (meetings.length === 0) {
        container.innerHTML = '<p style="color: #95a5a6;">No virtual meetings configured.</p>';
    } else {
        container.innerHTML = meetings.map(m => `
            <div class="box mb-2" style="padding: 0.75rem;">
                <strong>${escapeHtml(m.name)}</strong> - ${m.platform}
                <br><a href="${m.link}" target="_blank">${m.link}</a>
            </div>
        `).join('');
    }
}

function populateQRMeetingSelect() {
    const events = storage.getEvents();
    const select = document.getElementById('qr-meeting-select');
    if (!select) return;
    select.innerHTML = '<option value="">Select...</option>' + events.map(e => `<option value="${e.id}">${escapeHtml(e.title)}</option>`).join('');
}
function generateMeetingQR() {
    const meetingId = document.getElementById('qr-meeting-select').value;
    if (!meetingId) return showToast('Please select a meeting', 'error');
    const canvas = document.getElementById('qr-code-canvas');
    const display = document.getElementById('qr-code-display');
    if (canvas && display) {
        const ctx = canvas.getContext('2d');
        canvas.width = 300;
        canvas.height = 300;
        ctx.fillStyle = '#fff';
        ctx.fillRect(0, 0, 300, 300);
        ctx.fillStyle = '#000';
        ctx.font = '14px Arial';
        ctx.fillText('QR Code Placeholder', 80, 150);
        ctx.fillText('Meeting ID: ' + meetingId, 80, 170);
        display.style.display = 'block';
    }
}
function downloadMeetingQR() {
    const canvas = document.getElementById('qr-code-canvas');
    if (canvas) {
        const link = document.createElement('a');
        link.download = 'meeting-qr.png';
        link.href = canvas.toDataURL();
        link.click();
    }
}

function populateCommListMembers() {
    const members = storage.getMembers();
    const select = document.getElementById('comm-list-members');
    if (!select) return;
    select.innerHTML = members.map(m => `<option value="${m.id}">${escapeHtml(m.name)}</option>`).join('');
}
function saveCommList() {
    const name = document.getElementById('comm-list-name').value.trim();
    const selected = Array.from(document.getElementById('comm-list-members').selectedOptions).map(o => o.value);
    if (!name || selected.length === 0) return showToast('Fill in all fields', 'error');
    const lists = JSON.parse(localStorage.getItem('commLists') || '[]');
    lists.push({id: genId(), name, members: selected, createdAt: new Date().toISOString()});
    localStorage.setItem('commLists', JSON.stringify(lists));
    showToast('List saved!', 'success');
    updateCommListsDisplay();
}
function updateCommListsDisplay() {
    const lists = JSON.parse(localStorage.getItem('commLists') || '[]');
    const container = document.getElementById('comm-lists-display');
    if (!container) return;
    container.innerHTML = lists.length === 0 ? '<p style="color: #95a5a6;">No lists created.</p>' :
        lists.map(l => `<div class="box mb-2"><strong>${escapeHtml(l.name)}</strong> - ${l.members.length} members</div>`).join('');
}

function populateReminderMeetings() {
    const events = storage.getEvents();
    const select = document.getElementById('reminder-meeting');
    if (!select) return;
    select.innerHTML = events.map(e => `<option value="${e.id}">${escapeHtml(e.title)}</option>`).join('');
}
function saveReminderSettings() {
    const meetingId = document.getElementById('reminder-meeting').value;
    const hours = document.getElementById('reminder-hours').value;
    if (!meetingId) return showToast('Select a meeting', 'error');
    const reminders = JSON.parse(localStorage.getItem('meetingReminders') || '[]');
    reminders.push({meetingId, hours: parseInt(hours), enabled: true});
    localStorage.setItem('meetingReminders', JSON.stringify(reminders));
    showToast('Reminder saved!', 'success');
    updateRemindersList();
}
function updateRemindersList() {
    const reminders = JSON.parse(localStorage.getItem('meetingReminders') || '[]');
    const container = document.getElementById('reminders-list');
    if (!container) return;
    container.innerHTML = reminders.length === 0 ? '<p style="color: #95a5a6;">No reminders set.</p>' :
        `<p>${reminders.length} reminder(s) configured</p>`;
}

function saveNotificationSettings() {
    const days = document.getElementById('notif-days-advance').value;
    localStorage.setItem('notificationDaysAdvance', days);
    showToast('Settings saved!', 'success');
}
function updateUpcomingBirthdaysList() {
    const members = storage.getMembers();
    const container = document.getElementById('upcoming-birthdays-list');
    if (!container) return;
    const upcoming = members.filter(m => m.birthday).slice(0, 10);
    container.innerHTML = upcoming.length === 0 ? '<p style="color: #95a5a6;">No upcoming birthdays.</p>' :
        upcoming.map(m => `<div class="box mb-2">${escapeHtml(m.name)}</div>`).join('');
}

function populateActionItemAssigned() {
    const members = storage.getMembers();
    const select = document.getElementById('action-item-assigned');
    if (!select) return;
    select.innerHTML = members.map(m => `<option value="${m.id}">${escapeHtml(m.name)}</option>`).join('');
}
function createActionItem() {
    const title = document.getElementById('action-item-title').value.trim();
    const assigned = document.getElementById('action-item-assigned').value;
    const due = document.getElementById('action-item-due').value;
    if (!title || !assigned || !due) return showToast('Fill in all fields', 'error');
    const items = JSON.parse(localStorage.getItem('actionItems') || '[]');
    items.push({id: genId(), title, assigned, due, status: 'open', createdAt: new Date().toISOString()});
    localStorage.setItem('actionItems', JSON.stringify(items));
    showToast('Action item created!', 'success');
    updateActionItemsList();
}
function updateActionItemsList() {
    const items = JSON.parse(localStorage.getItem('actionItems') || '[]');
    const container = document.getElementById('action-items-list');
    if (!container) return;
    const open = items.filter(i => i.status === 'open');
    container.innerHTML = open.length === 0 ? '<p style="color: #95a5a6;">No open action items.</p>' :
        open.map(i => `<div class="box mb-2"><strong>${escapeHtml(i.title)}</strong> - Due: ${i.due}</div>`).join('');
}

function populateCancelMeeting() {
    const events = storage.getEvents();
    const select = document.getElementById('cancel-meeting');
    if (!select) return;
    select.innerHTML = events.map(e => `<option value="${e.id}">${escapeHtml(e.title)}</option>`).join('');
}
function sendCancellationAlert() {
    const meetingId = document.getElementById('cancel-meeting').value;
    const reason = document.getElementById('cancel-reason').value.trim();
    if (!meetingId || !reason) return showToast('Fill in all fields', 'error');
    const alerts = JSON.parse(localStorage.getItem('cancellationAlerts') || '[]');
    alerts.push({meetingId, reason, sentAt: new Date().toISOString()});
    localStorage.setItem('cancellationAlerts', JSON.stringify(alerts));
    showToast('Alert sent!', 'success');
    updateCancellationHistory();
}
function updateCancellationHistory() {
    const alerts = JSON.parse(localStorage.getItem('cancellationAlerts') || '[]');
    const container = document.getElementById('cancellation-history');
    if (!container) return;
    container.innerHTML = alerts.length === 0 ? '<p style="color: #95a5a6;">No alerts sent.</p>' :
        `<p>${alerts.length} alert(s) sent</p>`;
}

function populateWelcomeNewcomer() {
    const members = storage.getMembers();
    const select = document.getElementById('welcome-newcomer');
    if (!select) return;
    const newcomers = members.filter(m => m.membershipStatus === 'newcomer');
    select.innerHTML = newcomers.map(m => `<option value="${m.id}">${escapeHtml(m.name)}</option>`).join('');
}
function generateWelcomePacket() {
    const newcomerId = document.getElementById('welcome-newcomer').value;
    if (!newcomerId) return showToast('Select a newcomer', 'error');
    const packets = JSON.parse(localStorage.getItem('welcomePackets') || '[]');
    packets.push({newcomerId, generatedAt: new Date().toISOString()});
    localStorage.setItem('welcomePackets', JSON.stringify(packets));
    showToast('Packet generated!', 'success');
    updateWelcomePacketsList();
}
function updateWelcomePacketsList() {
    const packets = JSON.parse(localStorage.getItem('welcomePackets') || '[]');
    const container = document.getElementById('welcome-packets-list');
    if (!container) return;
    container.innerHTML = packets.length === 0 ? '<p style="color: #95a5a6;">No packets generated.</p>' :
        `<p>${packets.length} packet(s) generated</p>`;
}

function logBigBookStudy() {
    const chapter = document.getElementById('bb-chapter').value;
    const date = document.getElementById('bb-date').value;
    if (!date) return showToast('Select a date', 'error');
    const studies = JSON.parse(localStorage.getItem('bigBookStudies') || '[]');
    studies.push({chapter, date, loggedAt: new Date().toISOString()});
    localStorage.setItem('bigBookStudies', JSON.stringify(studies));
    showToast('Study logged!', 'success');
    updateBigBookProgress();
}
function updateBigBookProgress() {
    const studies = JSON.parse(localStorage.getItem('bigBookStudies') || '[]');
    const container = document.getElementById('bigbook-progress');
    if (!container) return;
    container.innerHTML = studies.length === 0 ? '<p style="color: #95a5a6;">No studies logged.</p>' :
        `<p>${studies.length} chapter(s) studied</p>`;
}

function populateLoanMember() {
    const members = storage.getMembers();
    const select = document.getElementById('loan-member');
    if (!select) return;
    select.innerHTML = members.map(m => `<option value="${m.id}">${escapeHtml(m.name)}</option>`).join('');
}
function loanLiterature() {
    const memberId = document.getElementById('loan-member').value;
    const item = document.getElementById('loan-item').value.trim();
    const due = document.getElementById('loan-due').value;
    if (!memberId || !item || !due) return showToast('Fill in all fields', 'error');
    const loans = JSON.parse(localStorage.getItem('literatureLoans') || '[]');
    loans.push({id: genId(), memberId, item, due, status: 'active', loanedAt: new Date().toISOString()});
    localStorage.setItem('literatureLoans', JSON.stringify(loans));
    showToast('Item loaned!', 'success');
    updateLiteratureLoansList();
}
function updateLiteratureLoansList() {
    const loans = JSON.parse(localStorage.getItem('literatureLoans') || '[]');
    const container = document.getElementById('literature-loans-list');
    if (!container) return;
    const active = loans.filter(l => l.status === 'active');
    container.innerHTML = active.length === 0 ? '<p style="color: #95a5a6;">No active loans.</p>' :
        active.map(l => `<div class="box mb-2"><strong>${escapeHtml(l.item)}</strong> - Due: ${l.due}</div>`).join('');
}

function populatePackNewcomer() {
    const members = storage.getMembers();
    const select = document.getElementById('pack-newcomer');
    if (!select) return;
    const newcomers = members.filter(m => m.membershipStatus === 'newcomer');
    select.innerHTML = newcomers.map(m => `<option value="${m.id}">${escapeHtml(m.name)}</option>`).join('');
}
function distributeNewcomerPack() {
    const newcomerId = document.getElementById('pack-newcomer').value;
    if (!newcomerId) return showToast('Select a newcomer', 'error');
    const packs = JSON.parse(localStorage.getItem('newcomerPacks') || '[]');
    packs.push({newcomerId, distributedAt: new Date().toISOString()});
    localStorage.setItem('newcomerPacks', JSON.stringify(packs));
    showToast('Pack distributed!', 'success');
    updateNewcomerPacksHistory();
}
function updateNewcomerPacksHistory() {
    const packs = JSON.parse(localStorage.getItem('newcomerPacks') || '[]');
    const container = document.getElementById('newcomer-packs-history');
    if (!container) return;
    container.innerHTML = packs.length === 0 ? '<p style="color: #95a5a6;">No packs distributed.</p>' :
        `<p>${packs.length} pack(s) distributed</p>`;
}

function recordLiteratureSale() {
    const item = document.getElementById('sale-item').value.trim();
    const price = parseFloat(document.getElementById('sale-price').value);
    if (!item || !price) return showToast('Fill in all fields', 'error');
    const sales = JSON.parse(localStorage.getItem('literatureSales') || '[]');
    sales.push({id: genId(), item, price, soldAt: new Date().toISOString()});
    localStorage.setItem('literatureSales', JSON.stringify(sales));
    showToast('Sale recorded!', 'success');
    updateLiteratureSalesSummary();
}
function updateLiteratureSalesSummary() {
    const sales = JSON.parse(localStorage.getItem('literatureSales') || '[]');
    const container = document.getElementById('literature-sales-summary');
    if (!container) return;
    const total = sales.reduce((sum, s) => sum + s.price, 0);
    container.innerHTML = sales.length === 0 ? '<p style="color: #95a5a6;">No sales recorded.</p>' :
        `<div class="box mb-2"><strong>Total Sales:</strong> $${total.toFixed(2)}<br><strong>Items Sold:</strong> ${sales.length}</div>`;
}

function generateStudyGuide() {
    const topic = document.getElementById('guide-topic').value;
    const number = document.getElementById('guide-number').value;
    const container = document.getElementById('study-guide-output');
    if (!container) return;
    const guides = {
        step: 'Step Study Guide for Step ' + number,
        tradition: 'Tradition Study Guide for Tradition ' + number
    };
    container.innerHTML = `<div class="box"><h4>${guides[topic] || 'Study Guide'}</h4><p>Discussion questions and topics for ${topic} ${number}</p></div>`;
}

function populateInterGroupMembers() {
    const members = storage.getMembers();
    const select = document.getElementById('inter-member');
    if (!select) return;
    select.innerHTML = members.map(m => `<option value="${m.id}">${escapeHtml(m.name)}</option>`).join('');
}
function addInterGroupAttendance() {
    const memberId = document.getElementById('inter-member').value;
    const groupName = document.getElementById('inter-group-name').value.trim();
    if (!memberId || !groupName) return showToast('Fill in all fields', 'error');
    const attendance = JSON.parse(localStorage.getItem('interGroupAttendance') || '[]');
    attendance.push({id: genId(), memberId, groupName, recordedAt: new Date().toISOString()});
    localStorage.setItem('interGroupAttendance', JSON.stringify(attendance));
    showToast('Attendance recorded!', 'success');
    updateInterGroupList();
}
function updateInterGroupList() {
    const attendance = JSON.parse(localStorage.getItem('interGroupAttendance') || '[]');
    const container = document.getElementById('inter-group-list');
    if (!container) return;
    container.innerHTML = attendance.length === 0 ? '<p style="color: #95a5a6;">No inter-group attendance recorded.</p>' :
        attendance.slice(-10).map(a => `<div class="box mb-2">${escapeHtml(a.groupName)}</div>`).join('');
}

function populateTransferMembers() {
    const members = storage.getMembers();
    const select = document.getElementById('transfer-member');
    if (!select) return;
    select.innerHTML = members.map(m => `<option value="${m.id}">${escapeHtml(m.name)}</option>`).join('');
}
function processTransfer() {
    const memberId = document.getElementById('transfer-member').value;
    const type = document.getElementById('transfer-type').value;
    if (!memberId) return showToast('Select a member', 'error');
    const transfers = JSON.parse(localStorage.getItem('homeGroupTransfers') || '[]');
    transfers.push({id: genId(), memberId, type, processedAt: new Date().toISOString()});
    localStorage.setItem('homeGroupTransfers', JSON.stringify(transfers));
    showToast('Transfer processed!', 'success');
    updateTransferHistory();
}
function updateTransferHistory() {
    const transfers = JSON.parse(localStorage.getItem('homeGroupTransfers') || '[]');
    const container = document.getElementById('transfer-history');
    if (!container) return;
    container.innerHTML = transfers.length === 0 ? '<p style="color: #95a5a6;">No transfers recorded.</p>' :
        transfers.slice(-10).map(t => `<div class="box mb-2">${t.type === 'incoming' ? 'Incoming' : 'Outgoing'} transfer</div>`).join('');
}

function updateVotingEligibility() {
    const members = storage.getMembers();
    const container = document.getElementById('voting-eligible-list');
    if (!container) return;
    const eligible = members.filter(m => m.membershipStatus === 'homegroup');
    container.innerHTML = eligible.length === 0 ? '<p style="color: #95a5a6;">No eligible voters.</p>' :
        eligible.map(m => `<div class="box mb-2">${escapeHtml(m.name)}</div>`).join('');
}

function updateCommitmentLevels() {
    const members = storage.getMembers();
    const container = document.getElementById('commitment-levels');
    if (!container) return;
    const homeGroupMembers = members.filter(m => m.membershipStatus === 'homegroup');
    container.innerHTML = `<div class="box mb-2"><strong>Home Group Members:</strong> ${homeGroupMembers.length}<br><strong>Total Members:</strong> ${members.length}</div>`;
}

function updateCensusStats() {
    const members = storage.getMembers();
    const container = document.getElementById('census-stats');
    if (!container) return;
    const byStatus = {homegroup: 0, regular: 0, newcomer: 0, visitor: 0};
    members.forEach(m => { if (byStatus[m.membershipStatus] !== undefined) byStatus[m.membershipStatus]++; });
    container.innerHTML = `<div class="box mb-4">
        <strong>Home Group:</strong> ${byStatus.homegroup}<br>
        <strong>Regular:</strong> ${byStatus.regular}<br>
        <strong>Newcomer:</strong> ${byStatus.newcomer}<br>
        <strong>Visitor:</strong> ${byStatus.visitor}</div>`;
}

function updateGrowthMetrics() {
    const members = storage.getMembers();
    const container = document.getElementById('growth-chart');
    if (!container) return;
    showToast('Growth chart would display membership trends over time', 'info');
}

function updateGroupsList() {
    const groups = JSON.parse(localStorage.getItem('multiGroups') || '[]');
    const container = document.getElementById('groups-list');
    if (!container) return;
    container.innerHTML = groups.length === 0 ? '<p style="color: #95a5a6;">No groups added.</p>' :
        groups.map(g => `<div class="box mb-2">${escapeHtml(g.name)}</div>`).join('');
}

function populateInterviewMembers() {
    const members = storage.getMembers();
    const select = document.getElementById('interview-member');
    if (!select) return;
    select.innerHTML = members.map(m => `<option value="${m.id}">${escapeHtml(m.name)}</option>`).join('');
}
function updateOralHistoriesList() {
    const histories = JSON.parse(localStorage.getItem('oralHistories') || '[]');
    const container = document.getElementById('oral-histories-list');
    if (!container) return;
    container.innerHTML = histories.length === 0 ? '<p style="color: #95a5a6;">No oral histories recorded.</p>' :
        `<p>${histories.length} interview(s) recorded</p>`;
}

function updateMilestonesList() {
    const milestones = JSON.parse(localStorage.getItem('milestones') || '[]');
    const container = document.getElementById('milestones-list');
    if (!container) return;
    container.innerHTML = milestones.length === 0 ? '<p style="color: #95a5a6;">No milestones added.</p>' :
        milestones.map(m => `<div class="box mb-2"><strong>${escapeHtml(m.title)}</strong> - ${m.date}</div>`).join('');
}

function updateLegacyList() {
    const legacies = JSON.parse(localStorage.getItem('legacies') || '[]');
    const container = document.getElementById('legacy-list');
    if (!container) return;
    container.innerHTML = legacies.length === 0 ? '<p style="color: #95a5a6;">No legacies recorded.</p>' :
        legacies.map(l => `<div class="box mb-2"><strong>${escapeHtml(l.name)}</strong><p>${escapeHtml(l.tribute)}</p></div>`).join('');
}

function updateAccessibilityConcernsList() {
    const concerns = JSON.parse(localStorage.getItem('accessibilityConcerns') || '[]');
    const container = document.getElementById('accessibility-concerns-list');
    if (!container) return;
    container.innerHTML = concerns.length === 0 ? '<p style="color: #95a5a6;">No concerns submitted.</p>' :
        concerns.map(c => `<div class="box mb-2">${escapeHtml(c.concern)}</div>`).join('');
}

function updateContributionComparison() {
    const container = document.getElementById('contribution-stats');
    if (!container) return;
    const expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
    const thisYear = expenses.filter(e => new Date(e.date).getFullYear() === new Date().getFullYear());
    const lastYear = expenses.filter(e => new Date(e.date).getFullYear() === new Date().getFullYear() - 1);
    container.innerHTML = `<p><strong>This Year:</strong> $${thisYear.reduce((s,e)=>s+parseFloat(e.amount||0),0).toFixed(2)}</p>
        <p><strong>Last Year:</strong> $${lastYear.reduce((s,e)=>s+parseFloat(e.amount||0),0).toFixed(2)}</p>`;
}

function submitExpenseApproval() {
    const amount = parseFloat(document.getElementById('approval-amount').value);
    const purpose = document.getElementById('approval-purpose').value.trim();
    if (!amount || !purpose) return showToast('Fill in all fields', 'error');
    const approvals = JSON.parse(localStorage.getItem('expenseApprovals') || '[]');
    approvals.push({id: genId(), amount, purpose, status: 'pending', submittedAt: new Date().toISOString()});
    localStorage.setItem('expenseApprovals', JSON.stringify(approvals));
    showToast('Submitted for approval!', 'success');
    updatePendingApprovals();
}
function updatePendingApprovals() {
    const approvals = JSON.parse(localStorage.getItem('expenseApprovals') || '[]');
    const container = document.getElementById('pending-approvals');
    if (!container) return;
    const pending = approvals.filter(a => a.status === 'pending');
    container.innerHTML = pending.length === 0 ? '<p style="color: #95a5a6;">No pending approvals.</p>' :
        pending.map(a => `<div class="box mb-2"><strong>$${a.amount.toFixed(2)}</strong> - ${escapeHtml(a.purpose)}</div>`).join('');
}

function addBillReminder() {
    const name = document.getElementById('bill-name').value.trim();
    const amount = parseFloat(document.getElementById('bill-amount').value);
    const due = parseInt(document.getElementById('bill-due').value);
    if (!name || !amount || !due) return showToast('Fill in all fields', 'error');
    const bills = JSON.parse(localStorage.getItem('recurringBills') || '[]');
    bills.push({id: genId(), name, amount, dueDay: due});
    localStorage.setItem('recurringBills', JSON.stringify(bills));
    showToast('Bill reminder added!', 'success');
    updateUpcomingBills();
}
function updateUpcomingBills() {
    const bills = JSON.parse(localStorage.getItem('recurringBills') || '[]');
    const container = document.getElementById('upcoming-bills');
    if (!container) return;
    container.innerHTML = bills.length === 0 ? '<p style="color: #95a5a6;">No bills.</p>' :
        bills.map(b => `<div class="box mb-2"><strong>${escapeHtml(b.name)}</strong> - $${b.amount.toFixed(2)} (Due: Day ${b.dueDay})</div>`).join('');
}

function calculateSuggestedContribution() {
    const attendees = parseInt(document.getElementById('calc-attendees').value);
    const expenses = parseFloat(document.getElementById('calc-expenses').value);
    if (!attendees || !expenses) return showToast('Fill in all fields', 'error');
    const perPerson = expenses / (attendees * 4);
    const container = document.getElementById('contribution-result');
    if (container) container.innerHTML = `<div class="box"><h3 style="color: #2ecc71;">$${perPerson.toFixed(2)}</h3><p>per person per meeting</p></div>`;
}

function createFinancialGoal() {
    const name = document.getElementById('goal-name').value.trim();
    const target = parseFloat(document.getElementById('goal-target').value);
    const deadline = document.getElementById('goal-deadline').value;
    if (!name || !target || !deadline) return showToast('Fill in all fields', 'error');
    const goals = JSON.parse(localStorage.getItem('financialGoals') || '[]');
    goals.push({id: genId(), name, target, deadline, current: 0, createdAt: new Date().toISOString()});
    localStorage.setItem('financialGoals', JSON.stringify(goals));
    showToast('Goal created!', 'success');
    updateFinancialGoalsList();
}
function updateFinancialGoalsList() {
    const goals = JSON.parse(localStorage.getItem('financialGoals') || '[]');
    const container = document.getElementById('financial-goals-list');
    if (!container) return;
    container.innerHTML = goals.length === 0 ? '<p style="color: #95a5a6;">No goals.</p>' :
        goals.map(g => `<div class="box mb-2"><strong>${escapeHtml(g.name)}</strong> - $${g.current}/$${g.target}</div>`).join('');
}

function uploadReceipt() {
    const file = document.getElementById('receipt-file').files[0];
    const amount = parseFloat(document.getElementById('receipt-amount').value);
    const desc = document.getElementById('receipt-desc').value.trim();
    if (!file || !amount || !desc) return showToast('Fill in all fields', 'error');
    const receipts = JSON.parse(localStorage.getItem('receipts') || '[]');
    receipts.push({id: genId(), fileName: file.name, amount, description: desc, uploadedAt: new Date().toISOString()});
    localStorage.setItem('receipts', JSON.stringify(receipts));
    showToast('Receipt uploaded!', 'success');
    updateReceiptsList();
}
function updateReceiptsList() {
    const receipts = JSON.parse(localStorage.getItem('receipts') || '[]');
    const container = document.getElementById('receipts-list');
    if (!container) return;
    container.innerHTML = receipts.length === 0 ? '<p style="color: #95a5a6;">No receipts.</p>' :
        receipts.map(r => `<div class="box mb-2"><strong>${escapeHtml(r.description)}</strong> - $${r.amount.toFixed(2)}</div>`).join('');
}

function generateQuarterlyReport() {
    const quarter = document.getElementById('quarter-select').value;
    const year = document.getElementById('quarter-year').value;
    const container = document.getElementById('quarterly-report-output');
    if (container) container.innerHTML = `<div class="box"><h3>Quarterly Report</h3><p>${quarter} ${year}</p></div>`;
}

function generateSponsorshipTree() {
    const members = storage.getMembers();
    const container = document.getElementById('sponsorship-tree-display');
    if (!container) return;
    const tree = members.filter(m => m.sponsor).map(m => `<p>${escapeHtml(m.sponsor)} → ${escapeHtml(m.name)}</p>`).join('');
    container.innerHTML = tree || '<p style="color: #95a5a6;">No sponsorship data.</p>';
}

function populateHIMember() {
    const members = storage.getMembers();
    const select = document.getElementById('hi-member');
    if (!select) return;
    select.innerHTML = members.map(m => `<option value="${m.id}">${escapeHtml(m.name)}</option>`).join('');
}
function addHICommitment() {
    const memberId = document.getElementById('hi-member').value;
    const facility = document.getElementById('hi-facility').value.trim();
    const frequency = document.getElementById('hi-frequency').value;
    if (!memberId || !facility) return showToast('Fill in all fields', 'error');
    const commitments = JSON.parse(localStorage.getItem('hiCommitments') || '[]');
    commitments.push({id: genId(), memberId, facility, frequency, addedAt: new Date().toISOString()});
    localStorage.setItem('hiCommitments', JSON.stringify(commitments));
    showToast('H&I commitment added!', 'success');
    updateHICommitmentsList();
}
function updateHICommitmentsList() {
    const commitments = JSON.parse(localStorage.getItem('hiCommitments') || '[]');
    const container = document.getElementById('hi-commitments-list');
    if (!container) return;
    container.innerHTML = commitments.length === 0 ? '<p style="color: #95a5a6;">No commitments.</p>' :
        commitments.map(c => `<div class="box mb-2"><strong>${escapeHtml(c.facility)}</strong> - ${c.frequency}</div>`).join('');
}

function populateServiceMember() {
    const members = storage.getMembers();
    const select = document.getElementById('service-member');
    if (!select) return;
    select.innerHTML = members.map(m => `<option value="${m.id}">${escapeHtml(m.name)}</option>`).join('');
}
function logServiceHours() {
    const memberId = document.getElementById('service-member').value;
    const hours = parseFloat(document.getElementById('service-hours').value);
    const type = document.getElementById('service-type').value.trim();
    const date = document.getElementById('service-date').value;
    if (!memberId || !hours || !type || !date) return showToast('Fill in all fields', 'error');
    const serviceHours = JSON.parse(localStorage.getItem('serviceHours') || '[]');
    serviceHours.push({id: genId(), memberId, hours, type, date, loggedAt: new Date().toISOString()});
    localStorage.setItem('serviceHours', JSON.stringify(serviceHours));
    showToast('Service hours logged!', 'success');
    updateServiceHoursLeaderboard();
}
function updateServiceHoursLeaderboard() {
    const serviceHours = JSON.parse(localStorage.getItem('serviceHours') || '[]');
    const container = document.getElementById('service-hours-leaderboard');
    if (!container) return;
    const byMember = {};
    serviceHours.forEach(s => { byMember[s.memberId] = (byMember[s.memberId] || 0) + s.hours; });
    const sorted = Object.entries(byMember).sort((a,b) => b[1] - a[1]).slice(0, 10);
    container.innerHTML = sorted.length === 0 ? '<p style="color: #95a5a6;">No service hours logged.</p>' :
        sorted.map(([id, hours]) => `<div class="box mb-2">${hours.toFixed(1)} hours</div>`).join('');
}

function logConflict() {
    const desc = document.getElementById('conflict-desc').value.trim();
    const severity = document.getElementById('conflict-severity').value;
    if (!desc) return showToast('Enter a description', 'error');
    const conflicts = JSON.parse(localStorage.getItem('conflicts') || '[]');
    conflicts.push({id: genId(), description: desc, severity, status: 'active', loggedAt: new Date().toISOString()});
    localStorage.setItem('conflicts', JSON.stringify(conflicts));
    showToast('Conflict logged', 'success');
    updateConflictsList();
}
function updateConflictsList() {
    const conflicts = JSON.parse(localStorage.getItem('conflicts') || '[]');
    const container = document.getElementById('conflicts-list');
    if (!container) return;
    const active = conflicts.filter(c => c.status === 'active');
    container.innerHTML = active.length === 0 ? '<p style="color: #95a5a6;">No active conflicts.</p>' :
        active.map(c => `<div class="box mb-2" style="border-left: 4px solid ${c.severity==='High'?'#e74c3c':c.severity==='Medium'?'#f39c12':'#95a5a6'};">
            ${escapeHtml(c.description)}</div>`).join('');
}

function loadInventoryQuestions() {
    const questions = [
        'Are our meetings welcoming to newcomers?',
        'Are we following the Twelve Traditions?',
        'Is our group financially self-supporting?',
        'Are we carrying the message effectively?',
        'Are we practicing the spiritual principles?',
        'Do we have adequate participation in service?',
        'Are we united in our primary purpose?'
    ];
    const container = document.getElementById('inventory-questions-display');
    if (container) container.innerHTML = questions.map(q => `<div class="box mb-2">${q}</div>`).join('');
}

function loadTraditionCurriculum() {
    const traditions = Array.from({length: 12}, (_, i) => `Tradition ${i + 1}`);
    const container = document.getElementById('tradition-curriculum');
    if (container) container.innerHTML = traditions.map((t, i) =>
        `<div class="box mb-2"><strong>Month ${i + 1}:</strong> ${t}</div>`).join('');
}

function loadConceptCurriculum() {
    const concepts = Array.from({length: 12}, (_, i) => `Concept ${i + 1}`);
    const container = document.getElementById('concept-curriculum');
    if (container) container.innerHTML = concepts.map((c, i) =>
        `<div class="box mb-2"><strong>Month ${i + 1}:</strong> ${c}</div>`).join('');
}

function exportToGoogleCal() { showToast('Google Calendar export (requires API setup)', 'info'); }
function setupCloudBackup() { showToast('Cloud backup setup', 'info'); }
function addGroup() {
    const name = document.getElementById('group-name-input').value.trim();
    if (!name) return showToast('Enter group name', 'error');
    const groups = JSON.parse(localStorage.getItem('multiGroups') || '[]');
    groups.push({id: genId(), name, createdAt: new Date().toISOString()});
    localStorage.setItem('multiGroups', JSON.stringify(groups));
    showToast('Group added!', 'success');
}
function promptPWAInstall() {
    if (window.deferredPrompt) {
        window.deferredPrompt.prompt();
        window.deferredPrompt.userChoice.then(choice => {
            showToast(choice.outcome === 'accepted' ? 'App installed!' : 'Installation cancelled', 'info');
        });
    } else {
        showToast('Install from browser menu or already installed', 'info');
    }
}

function changeLanguage() { showToast('Multi-language support (requires translation files)', 'info'); }
function toggleLargePrint() {
    const enabled = document.getElementById('large-print-toggle').checked;
    document.body.style.fontSize = enabled ? '1.25rem' : '';
    showToast(enabled ? 'Large print enabled' : 'Large print disabled', 'success');
}
function submitAccessibilityConcern() {
    const concern = document.getElementById('accessibility-concern').value.trim();
    if (!concern) return showToast('Enter a concern', 'error');
    const concerns = JSON.parse(localStorage.getItem('accessibilityConcerns') || '[]');
    concerns.push({id: genId(), concern, submittedAt: new Date().toISOString()});
    localStorage.setItem('accessibilityConcerns', JSON.stringify(concerns));
    showToast('Concern submitted!', 'success');
}

function uploadArchive() { showToast('Archive file uploaded!', 'success'); }
function startInterview() { showToast('Recording started (requires audio recording setup)', 'info'); }
function addMilestone() {
    const title = document.getElementById('milestone-title').value.trim();
    const date = document.getElementById('milestone-date').value;
    if (!title || !date) return showToast('Fill in all fields', 'error');
    const milestones = JSON.parse(localStorage.getItem('milestones') || '[]');
    milestones.push({id: genId(), title, date, addedAt: new Date().toISOString()});
    localStorage.setItem('milestones', JSON.stringify(milestones));
    showToast('Milestone added!', 'success');
}
function addLegacy() {
    const name = document.getElementById('legacy-name').value.trim();
    const tribute = document.getElementById('legacy-tribute').value.trim();
    if (!name || !tribute) return showToast('Fill in all fields', 'error');
    const legacies = JSON.parse(localStorage.getItem('legacies') || '[]');
    legacies.push({id: genId(), name, tribute, addedAt: new Date().toISOString()});
    localStorage.setItem('legacies', JSON.stringify(legacies));
    showToast('Legacy added!', 'success');
}
function searchMinutes() { showToast('Search functionality coming soon', 'info'); }
function updateDigitalArchiveList() {
    const list = document.getElementById('archive-list');
    if (!list) return;
    const archive = JSON.parse(localStorage.getItem('digitalArchive') || '[]');
    if (archive.length === 0) {
        list.innerHTML = '<p style="opacity: 0.6;">No archived items yet.</p>';
        return;
    }
    list.innerHTML = archive.map(item => `
        <div class="box mb-2" style="padding: 0.75rem;">
            <strong>${escapeHtml(item.title || 'Untitled')}</strong><br>
            <small>${new Date(item.date).toLocaleDateString()}</small>
        </div>
    `).join('');
}
function updateHistoricalMinutesList() {
    const list = document.getElementById('historical-minutes-list');
    if (!list) return;
    const minutes = JSON.parse(localStorage.getItem('historicalMinutes') || '[]');
    if (minutes.length === 0) {
        list.innerHTML = '<p style="opacity: 0.6;">No historical minutes found.</p>';
        return;
    }
    list.innerHTML = minutes.map(item => `
        <div class="box mb-2" style="padding: 0.75rem;">
            <strong>${escapeHtml(item.title || 'Untitled')}</strong><br>
            <small>${new Date(item.date).toLocaleDateString()}</small>
        </div>
    `).join('');
}

function handleAreaMotionSubmit() {
    const id = document.getElementById('area-motion-edit-id').value;
    const motionNumber = document.getElementById('area-motion-number').value.trim();
    const date = document.getElementById('area-motion-date').value;
    const type = document.getElementById('area-motion-type').value;
    const title = document.getElementById('area-motion-title').value.trim();
    const description = document.getElementById('area-motion-description').value.trim();
    const background = document.getElementById('area-motion-background').value.trim();
    if (!motionNumber || !date || !title || !description) {
        return showToast('Fill in all required fields', 'error');
    }
    const motions = storage.getAreaMotions();
    if (id) {
        const idx = motions.findIndex(m => m.id === id);
        if (idx !== -1) {
            motions[idx] = {...motions[idx], motionNumber, date, type, title, description, background, updatedAt: new Date().toISOString()};
            showToast('Area motion updated!', 'success');
        }
    } else {
        motions.push({id: genId(), motionNumber, date, type, title, description, background, status: 'pending', createdAt: new Date().toISOString()});
        showToast('Area motion added!', 'success');
    }
    storage.saveAreaMotions(motions);
    clearAreaMotionForm();
    updateAreaMotionsList();
    updateGroupPositionMotionDropdown();
}
function clearAreaMotionForm() {
    document.getElementById('area-motion-edit-id').value = '';
    document.getElementById('area-motion-number').value = '';
    document.getElementById('area-motion-date').value = '';
    document.getElementById('area-motion-type').value = 'policy';
    document.getElementById('area-motion-title').value = '';
    document.getElementById('area-motion-description').value = '';
    document.getElementById('area-motion-background').value = '';
    document.getElementById('area-motion-form-btn').textContent = 'Save Area Motion';
    document.getElementById('area-motion-form-cancel-btn').style.display = 'none';
}
function cancelAreaMotionEdit() {
    clearAreaMotionForm();
}
function updateAreaMotionsList() {
    const list = document.getElementById('area-motions-list');
    if (!list) return;
    const motions = storage.getAreaMotions().sort((a,b) => new Date(b.date) - new Date(a.date));
    if (motions.length === 0) {
        list.innerHTML = '<p style="opacity: 0.6;">No area motions logged yet.</p>';
        return;
    }
    list.innerHTML = motions.map(m => {
        const statusColor = m.status === 'voted' ? '#2ecc71' : '#f39c12';
        return `
            <div class="box mb-2" style="padding: 0.75rem; border-left: 4px solid ${statusColor};">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                    <div style="flex: 1;">
                        <strong style="color: #3498db;">${escapeHtml(m.motionNumber)}</strong> - ${escapeHtml(m.title)}<br>
                        <small style="opacity: 0.7;">${new Date(m.date).toLocaleDateString()} | Type: ${escapeHtml(m.type)}</small>
                    </div>
                    <div>
                        <button class="btn" onclick="editAreaMotion('${m.id}')" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">Edit</button>
                        <button class="btn secondary" onclick="deleteAreaMotion('${m.id}')" style="padding: 0.3rem 0.6rem; font-size: 0.8rem; margin-left: 0.3rem;">Delete</button>
                    </div>
                </div>
                <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #7f8c8d;">
                    <p style="font-size: 0.9rem;">${escapeHtml(m.description)}</p>
                    ${m.background ? `<p style="font-size: 0.85rem; margin-top: 0.5rem; opacity: 0.8;"><em>Background:</em> ${escapeHtml(m.background)}</p>` : ''}
                    <div style="margin-top: 0.5rem;">
                        <span style="padding: 2px 8px; border-radius: 3px; font-size: 0.75rem; background: ${statusColor}; color: white;">${m.status.toUpperCase()}</span>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}
function editAreaMotion(id) {
    const motions = storage.getAreaMotions();
    const motion = motions.find(m => m.id === id);
    if (!motion) return;
    document.getElementById('area-motion-edit-id').value = motion.id;
    document.getElementById('area-motion-number').value = motion.motionNumber;
    document.getElementById('area-motion-date').value = motion.date;
    document.getElementById('area-motion-type').value = motion.type;
    document.getElementById('area-motion-title').value = motion.title;
    document.getElementById('area-motion-description').value = motion.description;
    document.getElementById('area-motion-background').value = motion.background || '';
    document.getElementById('area-motion-form-btn').textContent = 'Update Area Motion';
    document.getElementById('area-motion-form-cancel-btn').style.display = 'inline-block';
    document.querySelector('[data-section="area-assembly-section"]').scrollIntoView({behavior: 'smooth'});
}
function deleteAreaMotion(id) {
    if (!confirm('Delete this area motion?')) return;
    let motions = storage.getAreaMotions();
    motions = motions.filter(m => m.id !== id);
    storage.saveAreaMotions(motions);
    updateAreaMotionsList();
    updateGroupPositionMotionDropdown();
    showToast('Area motion deleted', 'success');
}
function filterAreaMotions(filter) {
    showToast(`Filtering: ${filter}`, 'info');
    updateAreaMotionsList();
}
function recordGroupPosition() {
    const motionId = document.getElementById('group-position-motion').value;
    const vote = document.getElementById('group-position-vote').value;
    const date = document.getElementById('group-position-date').value;
    const notes = document.getElementById('group-position-notes').value.trim();
    const instructions = document.getElementById('group-position-instructions').value.trim();
    if (!motionId || !vote || !date) {
        return showToast('Fill in all required fields', 'error');
    }
    const positions = storage.getGroupPositions();
    positions.push({id: genId(), motionId, vote, date, notes, instructions, recordedAt: new Date().toISOString()});
    storage.saveGroupPositions(positions);
    const motions = storage.getAreaMotions();
    const motionIdx = motions.findIndex(m => m.id === motionId);
    if (motionIdx !== -1) {
        motions[motionIdx].status = 'voted';
        storage.saveAreaMotions(motions);
    }
    document.getElementById('group-position-motion').value = '';
    document.getElementById('group-position-vote').value = 'for';
    document.getElementById('group-position-date').value = '';
    document.getElementById('group-position-notes').value = '';
    document.getElementById('group-position-instructions').value = '';
    updateAreaMotionsList();
    showToast('Group position recorded!', 'success');
}
function updateGroupPositionMotionDropdown() {
    const select = document.getElementById('group-position-motion');
    if (!select) return;
    const motions = storage.getAreaMotions().sort((a,b) => new Date(b.date) - new Date(a.date));
    select.innerHTML = '<option value="">-- Select Motion --</option>' + motions.map(m =>
        `<option value="${m.id}">${escapeHtml(m.motionNumber)} - ${escapeHtml(m.title)}</option>`
    ).join('');
}
function uploadAssemblyAgenda() {
    const date = document.getElementById('assembly-agenda-date').value;
    const location = document.getElementById('assembly-agenda-location').value.trim();
    const content = document.getElementById('assembly-agenda-content').value.trim();
    if (!date || !location || !content) {
        return showToast('Fill in all fields', 'error');
    }
    const agendas = storage.getAssemblyAgendas();
    agendas.push({id: genId(), date, location, content, uploadedAt: new Date().toISOString()});
    storage.saveAssemblyAgendas(agendas);
    document.getElementById('assembly-agenda-date').value = '';
    document.getElementById('assembly-agenda-location').value = '';
    document.getElementById('assembly-agenda-content').value = '';
    updateAssemblyAgendasList();
    showToast('Assembly agenda saved!', 'success');
}
function updateAssemblyAgendasList() {
    const list = document.getElementById('assembly-agendas-list');
    if (!list) return;
    const agendas = storage.getAssemblyAgendas().sort((a,b) => new Date(b.date) - new Date(a.date));
    if (agendas.length === 0) {
        list.innerHTML = '<p style="opacity: 0.6; margin-top: 1rem;">No agendas uploaded yet.</p>';
        return;
    }
    list.innerHTML = agendas.map(a => `
        <div class="box mb-2 mt-2" style="padding: 0.75rem;">
            <strong>${new Date(a.date).toLocaleDateString()}</strong> - ${escapeHtml(a.location)}<br>
            <button class="btn secondary" onclick="deleteAssemblyAgenda('${a.id}')" style="margin-top: 0.5rem; padding: 0.3rem 0.6rem; font-size: 0.8rem;">Delete</button>
        </div>
    `).join('');
}
function deleteAssemblyAgenda(id) {
    if (!confirm('Delete this agenda?')) return;
    let agendas = storage.getAssemblyAgendas();
    agendas = agendas.filter(a => a.id !== id);
    storage.saveAssemblyAgendas(agendas);
    updateAssemblyAgendasList();
    showToast('Agenda deleted', 'success');
}

function handleIRMeetingSubmit() {
    const id = document.getElementById('ir-meeting-edit-id').value;
    const date = document.getElementById('ir-meeting-date').value;
    const type = document.getElementById('ir-meeting-type').value;
    const location = document.getElementById('ir-meeting-location').value.trim();
    const notes = document.getElementById('ir-meeting-notes').value.trim();
    const actionItems = document.getElementById('ir-action-items').value.trim();
    if (!date || !location || !notes) {
        return showToast('Fill in all required fields', 'error');
    }
    const meetings = storage.getIRMeetings();
    if (id) {
        const idx = meetings.findIndex(m => m.id === id);
        if (idx !== -1) {
            meetings[idx] = {...meetings[idx], date, type, location, notes, actionItems, updatedAt: new Date().toISOString()};
            showToast('IR meeting notes updated!', 'success');
        }
    } else {
        meetings.push({id: genId(), date, type, location, notes, actionItems, createdAt: new Date().toISOString()});
        showToast('IR meeting notes added!', 'success');
    }
    storage.saveIRMeetings(meetings);
    clearIRMeetingForm();
    updateIRMeetingsList();
}
function clearIRMeetingForm() {
    document.getElementById('ir-meeting-edit-id').value = '';
    document.getElementById('ir-meeting-date').value = '';
    document.getElementById('ir-meeting-type').value = 'regular';
    document.getElementById('ir-meeting-location').value = '';
    document.getElementById('ir-meeting-notes').value = '';
    document.getElementById('ir-action-items').value = '';
    document.getElementById('ir-meeting-form-btn').textContent = 'Save IR Notes';
    document.getElementById('ir-meeting-form-cancel-btn').style.display = 'none';
}
function cancelIRMeetingEdit() {
    clearIRMeetingForm();
}
function updateIRMeetingsList() {
    const list = document.getElementById('ir-meetings-list');
    if (!list) return;
    const meetings = storage.getIRMeetings().sort((a,b) => new Date(b.date) - new Date(a.date));
    if (meetings.length === 0) {
        list.innerHTML = '<p style="opacity: 0.6;">No IR meeting notes yet.</p>';
        return;
    }
    list.innerHTML = meetings.map(m => `
        <div class="box mb-2" style="padding: 0.75rem;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div style="flex: 1;">
                    <strong style="color: #3498db;">${new Date(m.date).toLocaleDateString()}</strong> - ${escapeHtml(m.type)}<br>
                    <small style="opacity: 0.7;">${escapeHtml(m.location)}</small>
                    <p style="margin-top: 0.5rem; font-size: 0.9rem;">${escapeHtml(m.notes).substring(0,150)}${m.notes.length > 150 ? '...' : ''}</p>
                    ${m.actionItems ? `<p style="margin-top: 0.5rem; font-size: 0.85rem; color: #f39c12;"><strong>Action Items:</strong> ${escapeHtml(m.actionItems)}</p>` : ''}
                </div>
                <div>
                    <button class="btn" onclick="editIRMeeting('${m.id}')" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">Edit</button>
                    <button class="btn secondary" onclick="deleteIRMeeting('${m.id}')" style="padding: 0.3rem 0.6rem; font-size: 0.8rem; margin-left: 0.3rem;">Delete</button>
                </div>
            </div>
        </div>
    `).join('');
}
function editIRMeeting(id) {
    const meetings = storage.getIRMeetings();
    const meeting = meetings.find(m => m.id === id);
    if (!meeting) return;
    document.getElementById('ir-meeting-edit-id').value = meeting.id;
    document.getElementById('ir-meeting-date').value = meeting.date;
    document.getElementById('ir-meeting-type').value = meeting.type;
    document.getElementById('ir-meeting-location').value = meeting.location;
    document.getElementById('ir-meeting-notes').value = meeting.notes;
    document.getElementById('ir-meeting-action-items').value = meeting.actionItems || '';
    document.getElementById('ir-meeting-form-btn').textContent = 'Update IR Notes';
    document.getElementById('ir-meeting-form-cancel-btn').style.display = 'inline-block';
}
function deleteIRMeeting(id) {
    if (!confirm('Delete these IR meeting notes?')) return;
    let meetings = storage.getIRMeetings();
    meetings = meetings.filter(m => m.id !== id);
    storage.saveIRMeetings(meetings);
    updateIRMeetingsList();
    showToast('IR meeting notes deleted', 'success');
}
function scheduleHotlineShift() {
    const volunteer = document.getElementById('hotline-volunteer').value;
    const date = document.getElementById('hotline-shift-date').value;
    const time = document.getElementById('hotline-shift-time').value;
    const contact = document.getElementById('hotline-contact').value.trim();
    if (!volunteer || !date || !time || !contact) {
        return showToast('Fill in all fields', 'error');
    }
    const shifts = storage.getHotlineShifts();
    shifts.push({id: genId(), volunteer, date, time, contact, scheduledAt: new Date().toISOString()});
    storage.saveHotlineShifts(shifts);
    document.getElementById('hotline-volunteer').value = '';
    document.getElementById('hotline-shift-date').value = '';
    document.getElementById('hotline-shift-time').value = 'morning';
    document.getElementById('hotline-contact').value = '';
    updateHotlineScheduleList();
    showToast('Hotline shift scheduled!', 'success');
}
function updateHotlineScheduleList() {
    const list = document.getElementById('hotline-schedule-list');
    if (!list) return;
    const shifts = storage.getHotlineShifts().sort((a,b) => new Date(a.date) - new Date(b.date));
    const members = storage.getMembers();
    if (shifts.length === 0) {
        list.innerHTML = '<p style="opacity: 0.6; margin-top: 1rem;">No shifts scheduled yet.</p>';
        return;
    }
    list.innerHTML = shifts.map(s => {
        const member = members.find(m => m.id === s.volunteer);
        return `
            <div class="box mb-2 mt-2" style="padding: 0.75rem;">
                <strong>${new Date(s.date).toLocaleDateString()}</strong> - ${escapeHtml(s.time)}<br>
                <small>${member ? escapeHtml(member.name) : 'Unknown'} | ${escapeHtml(s.contact)}</small><br>
                <button class="btn secondary" onclick="deleteHotlineShift('${s.id}')" style="margin-top: 0.5rem; padding: 0.3rem 0.6rem; font-size: 0.8rem;">Delete</button>
            </div>
        `;
    }).join('');
}
function deleteHotlineShift(id) {
    if (!confirm('Delete this shift?')) return;
    let shifts = storage.getHotlineShifts();
    shifts = shifts.filter(s => s.id !== id);
    storage.saveHotlineShifts(shifts);
    updateHotlineScheduleList();
    showToast('Shift deleted', 'success');
}
function addSpecialEvent() {
    const name = document.getElementById('special-event-name').value.trim();
    const date = document.getElementById('special-event-date').value;
    const location = document.getElementById('special-event-location').value.trim();
    const coordinator = document.getElementById('special-event-coordinator').value;
    const details = document.getElementById('special-event-details').value.trim();
    const volunteersNeeded = document.getElementById('special-event-volunteers-needed').value;
    if (!name || !date || !location) {
        return showToast('Fill in required fields', 'error');
    }
    const events = storage.getSpecialEvents();
    events.push({id: genId(), name, date, location, coordinator, details, volunteersNeeded, createdAt: new Date().toISOString()});
    storage.saveSpecialEvents(events);
    document.getElementById('special-event-name').value = '';
    document.getElementById('special-event-date').value = '';
    document.getElementById('special-event-location').value = '';
    document.getElementById('special-event-coordinator').value = '';
    document.getElementById('special-event-details').value = '';
    document.getElementById('special-event-volunteers-needed').value = '';
    updateSpecialEventsList();
    showToast('Special event added!', 'success');
}
function updateSpecialEventsList() {
    const list = document.getElementById('special-events-list');
    if (!list) return;
    const events = storage.getSpecialEvents().sort((a,b) => new Date(a.date) - new Date(b.date));
    const members = storage.getMembers();
    if (events.length === 0) {
        list.innerHTML = '<p style="opacity: 0.6; margin-top: 1rem;">No special events yet.</p>';
        return;
    }
    list.innerHTML = events.map(e => {
        const coordinator = members.find(m => m.id === e.coordinator);
        return `
            <div class="box mb-2 mt-2" style="padding: 0.75rem;">
                <strong style="color: #3498db;">${escapeHtml(e.name)}</strong><br>
                <small>${new Date(e.date).toLocaleDateString()} | ${escapeHtml(e.location)}</small><br>
                ${coordinator ? `<small>Coordinator: ${escapeHtml(coordinator.name)}</small><br>` : ''}
                ${e.volunteersNeeded ? `<small>Volunteers Needed: ${e.volunteersNeeded}</small><br>` : ''}
                <button class="btn secondary" onclick="deleteSpecialEvent('${e.id}')" style="margin-top: 0.5rem; padding: 0.3rem 0.6rem; font-size: 0.8rem;">Delete</button>
            </div>
        `;
    }).join('');
}
function deleteSpecialEvent(id) {
    if (!confirm('Delete this event?')) return;
    let events = storage.getSpecialEvents();
    events = events.filter(e => e.id !== id);
    storage.saveSpecialEvents(events);
    updateSpecialEventsList();
    showToast('Event deleted', 'success');
}
function logPIActivity() {
    const date = document.getElementById('pi-activity-date').value;
    const type = document.getElementById('pi-activity-type').value;
    const description = document.getElementById('pi-activity-description').value.trim();
    if (!date || !description) {
        return showToast('Fill in all fields', 'error');
    }
    const activities = storage.getPIActivities();
    activities.push({id: genId(), date, type, description, loggedAt: new Date().toISOString()});
    storage.savePIActivities(activities);
    document.getElementById('pi-activity-date').value = '';
    document.getElementById('pi-activity-type').value = 'presentation';
    document.getElementById('pi-activity-description').value = '';
    updatePIActivitiesList();
    showToast('PI activity logged!', 'success');
}
function updatePIActivitiesList() {
    const list = document.getElementById('pi-activities-list');
    if (!list) return;
    const activities = storage.getPIActivities().sort((a,b) => new Date(b.date) - new Date(a.date));
    if (activities.length === 0) {
        list.innerHTML = '<p style="opacity: 0.6; margin-top: 1rem;">No PI activities logged yet.</p>';
        return;
    }
    list.innerHTML = activities.map(a => `
        <div class="box mb-2 mt-2" style="padding: 0.75rem;">
            <strong>${new Date(a.date).toLocaleDateString()}</strong> - ${escapeHtml(a.type)}<br>
            <p style="margin-top: 0.5rem; font-size: 0.9rem;">${escapeHtml(a.description)}</p>
            <button class="btn secondary" onclick="deletePIActivity('${a.id}')" style="margin-top: 0.5rem; padding: 0.3rem 0.6rem; font-size: 0.8rem;">Delete</button>
        </div>
    `).join('');
}
function deletePIActivity(id) {
    if (!confirm('Delete this activity?')) return;
    let activities = storage.getPIActivities();
    activities = activities.filter(a => a.id !== id);
    storage.savePIActivities(activities);
    updatePIActivitiesList();
    showToast('Activity deleted', 'success');
}

function handleFacilitySubmit() {
    const id = document.getElementById('facility-edit-id').value;
    const name = document.getElementById('facility-name').value.trim();
    const type = document.getElementById('facility-type').value;
    const address = document.getElementById('facility-address').value.trim();
    const city = document.getElementById('facility-city').value.trim();
    const contactName = document.getElementById('facility-contact-name').value.trim();
    const contactPhone = document.getElementById('facility-contact-phone').value.trim();
    const contactEmail = document.getElementById('facility-contact-email').value.trim();
    const notes = document.getElementById('facility-notes').value.trim();
    if (!name || !type || !address) {
        return showToast('Fill in required fields', 'error');
    }
    const facilities = storage.getFacilities();
    if (id) {
        const idx = facilities.findIndex(f => f.id === id);
        if (idx !== -1) {
            facilities[idx] = {...facilities[idx], name, type, address, city, contactName, contactPhone, contactEmail, notes, updatedAt: new Date().toISOString()};
            showToast('Facility updated!', 'success');
        }
    } else {
        facilities.push({id: genId(), name, type, address, city, contactName, contactPhone, contactEmail, notes, createdAt: new Date().toISOString()});
        showToast('Facility added!', 'success');
    }
    storage.saveFacilities(facilities);
    clearFacilityForm();
    updateFacilitiesList();
    updatePanelFacilityDropdown();
    updateCertFacilityDropdown();
}
function clearFacilityForm() {
    document.getElementById('facility-edit-id').value = '';
    document.getElementById('facility-name').value = '';
    document.getElementById('facility-type').value = 'hospital';
    document.getElementById('facility-address').value = '';
    document.getElementById('facility-city').value = '';
    document.getElementById('facility-contact-name').value = '';
    document.getElementById('facility-contact-phone').value = '';
    document.getElementById('facility-contact-email').value = '';
    document.getElementById('facility-notes').value = '';
    document.getElementById('facility-form-btn').textContent = 'Save Facility';
    document.getElementById('facility-form-cancel-btn').style.display = 'none';
}
function cancelFacilityEdit() {
    clearFacilityForm();
}
function updateFacilitiesList() {
    const list = document.getElementById('facilities-list');
    if (!list) return;
    const facilities = storage.getFacilities().sort((a,b) => a.name.localeCompare(b.name));
    if (facilities.length === 0) {
        list.innerHTML = '<p style="opacity: 0.6;">No facilities added yet.</p>';
        return;
    }
    list.innerHTML = facilities.map(f => `
        <div class="box mb-2" style="padding: 0.75rem;">
            <strong style="color: #3498db;">${escapeHtml(f.name)}</strong><br>
            <small>${escapeHtml(f.type)} | ${escapeHtml(f.address)}</small><br>
            ${f.contactName ? `<small>Contact: ${escapeHtml(f.contactName)} | ${escapeHtml(f.contactPhone)}</small><br>` : ''}
            <button class="btn" onclick="editFacility('${f.id}')" style="margin-top: 0.5rem; padding: 0.3rem 0.6rem; font-size: 0.8rem;">Edit</button>
            <button class="btn secondary" onclick="deleteFacility('${f.id}')" style="padding: 0.3rem 0.6rem; font-size: 0.8rem; margin-left: 0.3rem;">Delete</button>
        </div>
    `).join('');
}
function editFacility(id) {
    const facilities = storage.getFacilities();
    const facility = facilities.find(f => f.id === id);
    if (!facility) return;
    document.getElementById('facility-edit-id').value = facility.id;
    document.getElementById('facility-name').value = facility.name;
    document.getElementById('facility-type').value = facility.type;
    document.getElementById('facility-address').value = facility.address;
    document.getElementById('facility-city').value = facility.city || '';
    document.getElementById('facility-contact-name').value = facility.contactName || '';
    document.getElementById('facility-contact-phone').value = facility.contactPhone || '';
    document.getElementById('facility-contact-email').value = facility.contactEmail || '';
    document.getElementById('facility-notes').value = facility.notes || '';
    document.getElementById('facility-form-btn').textContent = 'Update Facility';
    document.getElementById('facility-form-cancel-btn').style.display = 'inline-block';
}
function deleteFacility(id) {
    if (!confirm('Delete this facility?')) return;
    let facilities = storage.getFacilities();
    facilities = facilities.filter(f => f.id !== id);
    storage.saveFacilities(facilities);
    updateFacilitiesList();
    updatePanelFacilityDropdown();
    updateCertFacilityDropdown();
    showToast('Facility deleted', 'success');
}
function schedulePanelMeeting() {
    const facility = document.getElementById('panel-facility').value;
    const date = document.getElementById('panel-date').value;
    const time = document.getElementById('panel-time').value;
    const leader = document.getElementById('panel-leader').value;
    const speakersSelect = document.getElementById('panel-speakers');
    const speakers = Array.from(speakersSelect.selectedOptions).map(opt => opt.value);
    const format = document.getElementById('panel-format').value;
    if (!facility || !date || !time || !leader || speakers.length === 0) {
        return showToast('Fill in all fields and select at least one speaker', 'error');
    }
    const panels = storage.getHIPanels();
    panels.push({id: genId(), facility, date, time, leader, speakers, format, scheduledAt: new Date().toISOString()});
    storage.saveHIPanels(panels);
    document.getElementById('panel-facility').value = '';
    document.getElementById('panel-date').value = '';
    document.getElementById('panel-time').value = '';
    document.getElementById('panel-leader').value = '';
    document.getElementById('panel-speakers').selectedIndex = -1;
    document.getElementById('panel-format').value = 'speaker';
    updateHIPanelsTable();
    showToast('H&I panel scheduled!', 'success');
}
function updateHIPanelsTable() {
    const tbody = document.getElementById('hi-panels-body');
    if (!tbody) return;
    const panels = storage.getHIPanels().sort((a,b) => new Date(a.date) - new Date(b.date));
    const facilities = storage.getFacilities();
    const members = storage.getMembers();
    if (panels.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; opacity: 0.6;">No panels scheduled yet.</td></tr>';
        return;
    }
    tbody.innerHTML = panels.map(p => {
        const facility = facilities.find(f => f.id === p.facility);
        const leader = members.find(m => m.id === p.leader);
        const speakerNames = p.speakers.map(sid => {
            const speaker = members.find(m => m.id === sid);
            return speaker ? speaker.name : 'Unknown';
        }).join(', ');
        return `
            <tr>
                <td>${new Date(p.date).toLocaleDateString()}</td>
                <td>${p.time}</td>
                <td>${facility ? escapeHtml(facility.name) : 'Unknown'}</td>
                <td>${leader ? escapeHtml(leader.name) : 'Unknown'}</td>
                <td>${escapeHtml(speakerNames)}</td>
                <td>${escapeHtml(p.format)}</td>
                <td>
                    <button class="btn secondary" onclick="deleteHIPanel('${p.id}')" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">Delete</button>
                </td>
            </tr>
        `;
    }).join('');
}
function deleteHIPanel(id) {
    if (!confirm('Delete this panel?')) return;
    let panels = storage.getHIPanels();
    panels = panels.filter(p => p.id !== id);
    storage.saveHIPanels(panels);
    updateHIPanelsTable();
    showToast('Panel deleted', 'success');
}
function addMemberCertification() {
    const member = document.getElementById('cert-member').value;
    const facility = document.getElementById('cert-facility').value;
    const date = document.getElementById('cert-date').value;
    const expiry = document.getElementById('cert-expiry').value;
    const notes = document.getElementById('cert-notes').value.trim();
    if (!member || !facility || !date) {
        return showToast('Fill in required fields', 'error');
    }
    const certifications = storage.getMemberCertifications();
    certifications.push({id: genId(), member, facility, date, expiry, notes, addedAt: new Date().toISOString()});
    storage.saveMemberCertifications(certifications);
    document.getElementById('cert-member').value = '';
    document.getElementById('cert-facility').value = '';
    document.getElementById('cert-date').value = '';
    document.getElementById('cert-expiry').value = '';
    document.getElementById('cert-notes').value = '';
    updateCertificationsList();
    showToast('Certification added!', 'success');
}
function updateCertificationsList() {
    const list = document.getElementById('certifications-list');
    if (!list) return;
    const certifications = storage.getMemberCertifications().sort((a,b) => new Date(b.date) - new Date(a.date));
    const members = storage.getMembers();
    const facilities = storage.getFacilities();
    if (certifications.length === 0) {
        list.innerHTML = '<p style="opacity: 0.6; margin-top: 1rem;">No certifications recorded yet.</p>';
        return;
    }
    list.innerHTML = certifications.map(c => {
        const member = members.find(m => m.id === c.member);
        const facility = facilities.find(f => f.id === c.facility);
        return `
            <div class="box mb-2 mt-2" style="padding: 0.75rem;">
                <strong>${member ? escapeHtml(member.name) : 'Unknown'}</strong> - ${facility ? escapeHtml(facility.name) : 'Unknown'}<br>
                <small>Certified: ${new Date(c.date).toLocaleDateString()}${c.expiry ? ` | Expires: ${new Date(c.expiry).toLocaleDateString()}` : ''}</small><br>
                ${c.notes ? `<p style="margin-top: 0.5rem; font-size: 0.85rem;">${escapeHtml(c.notes)}</p>` : ''}
                <button class="btn secondary" onclick="deleteCertification('${c.id}')" style="margin-top: 0.5rem; padding: 0.3rem 0.6rem; font-size: 0.8rem;">Delete</button>
            </div>
        `;
    }).join('');
}
function deleteCertification(id) {
    if (!confirm('Delete this certification?')) return;
    let certifications = storage.getMemberCertifications();
    certifications = certifications.filter(c => c.id !== id);
    storage.saveMemberCertifications(certifications);
    updateCertificationsList();
    showToast('Certification deleted', 'success');
}
function updatePanelFacilityDropdown() {
    const select = document.getElementById('panel-facility');
    if (!select) return;
    const facilities = storage.getFacilities().sort((a,b) => a.name.localeCompare(b.name));
    select.innerHTML = '<option value="">-- Select Facility --</option>' + facilities.map(f =>
        `<option value="${f.id}">${escapeHtml(f.name)}</option>`
    ).join('');
}
function updateCertFacilityDropdown() {
    const select = document.getElementById('cert-facility');
    if (!select) return;
    const facilities = storage.getFacilities().sort((a,b) => a.name.localeCompare(b.name));
    select.innerHTML = '<option value="">-- Select Facility --</option>' + facilities.map(f =>
        `<option value="${f.id}">${escapeHtml(f.name)}</option>`
    ).join('');
}

function handleProfessionalSubmit() {
    const id = document.getElementById('prof-edit-id').value;
    const name = document.getElementById('prof-name').value.trim();
    const title = document.getElementById('prof-title').value.trim();
    const type = document.getElementById('prof-type').value;
    const organization = document.getElementById('prof-organization').value.trim();
    const address = document.getElementById('prof-address').value.trim();
    const phone = document.getElementById('prof-phone').value.trim();
    const email = document.getElementById('prof-email').value.trim();
    const specialty = document.getElementById('prof-specialty').value.trim();
    const referralSource = document.getElementById('prof-referral-source').value;
    const notes = document.getElementById('prof-notes').value.trim();
    if (!name || !type) {
        return showToast('Fill in required fields', 'error');
    }
    const professionals = storage.getProfessionals();
    if (id) {
        const idx = professionals.findIndex(p => p.id === id);
        if (idx !== -1) {
            professionals[idx] = {...professionals[idx], name, title, type, organization, address, phone, email, specialty, referralSource, notes, updatedAt: new Date().toISOString()};
            showToast('Professional contact updated!', 'success');
        }
    } else {
        professionals.push({id: genId(), name, title, type, organization, address, phone, email, specialty, referralSource, notes, createdAt: new Date().toISOString()});
        showToast('Professional contact added!', 'success');
    }
    storage.saveProfessionals(professionals);
    clearProfessionalForm();
    updateProfessionalsList();
}
function clearProfessionalForm() {
    document.getElementById('prof-edit-id').value = '';
    document.getElementById('prof-name').value = '';
    document.getElementById('prof-title').value = '';
    document.getElementById('prof-type').value = 'physician';
    document.getElementById('prof-organization').value = '';
    document.getElementById('prof-address').value = '';
    document.getElementById('prof-phone').value = '';
    document.getElementById('prof-email').value = '';
    document.getElementById('prof-specialty').value = '';
    document.getElementById('prof-referral-source').value = 'refers-clients';
    document.getElementById('prof-notes').value = '';
    document.getElementById('prof-form-btn').textContent = 'Save Contact';
    document.getElementById('prof-form-cancel-btn').style.display = 'none';
}
function cancelProfessionalEdit() {
    clearProfessionalForm();
}
function updateProfessionalsList() {
    const list = document.getElementById('professionals-list');
    if (!list) return;
    const professionals = storage.getProfessionals().sort((a,b) => a.name.localeCompare(b.name));
    if (professionals.length === 0) {
        list.innerHTML = '<p style="opacity: 0.6;">No professional contacts yet.</p>';
        return;
    }
    list.innerHTML = professionals.map(p => `
        <div class="box mb-2" style="padding: 0.75rem;">
            <strong style="color: #3498db;">${escapeHtml(p.name)}</strong> ${p.title ? `, ${escapeHtml(p.title)}` : ''}<br>
            <small>${escapeHtml(p.type)} | ${p.organization ? escapeHtml(p.organization) : ''}</small><br>
            ${p.phone ? `<small>Phone: ${escapeHtml(p.phone)}</small><br>` : ''}
            ${p.email ? `<small>Email: ${escapeHtml(p.email)}</small><br>` : ''}
            <button class="btn" onclick="editProfessional('${p.id}')" style="margin-top: 0.5rem; padding: 0.3rem 0.6rem; font-size: 0.8rem;">Edit</button>
            <button class="btn secondary" onclick="deleteProfessional('${p.id}')" style="padding: 0.3rem 0.6rem; font-size: 0.8rem; margin-left: 0.3rem;">Delete</button>
        </div>
    `).join('');
}
function editProfessional(id) {
    const professionals = storage.getProfessionals();
    const professional = professionals.find(p => p.id === id);
    if (!professional) return;
    document.getElementById('prof-edit-id').value = professional.id;
    document.getElementById('prof-name').value = professional.name;
    document.getElementById('prof-title').value = professional.title || '';
    document.getElementById('prof-type').value = professional.type;
    document.getElementById('prof-organization').value = professional.organization || '';
    document.getElementById('prof-address').value = professional.address || '';
    document.getElementById('prof-phone').value = professional.phone || '';
    document.getElementById('prof-email').value = professional.email || '';
    document.getElementById('prof-specialty').value = professional.specialty || '';
    document.getElementById('prof-referral-source').value = professional.referralSource || 'refers-clients';
    document.getElementById('prof-notes').value = professional.notes || '';
    document.getElementById('prof-form-btn').textContent = 'Update Contact';
    document.getElementById('prof-form-cancel-btn').style.display = 'inline-block';
}
function deleteProfessional(id) {
    if (!confirm('Delete this professional contact?')) return;
    let professionals = storage.getProfessionals();
    professionals = professionals.filter(p => p.id !== id);
    storage.saveProfessionals(professionals);
    updateProfessionalsList();
    showToast('Professional contact deleted', 'success');
}
function logPresentation() {
    const date = document.getElementById('pres-date').value;
    const location = document.getElementById('pres-location').value.trim();
    const audience = document.getElementById('pres-audience').value;
    const presenterSelect = document.getElementById('pres-presenter');
    const presenters = Array.from(presenterSelect.selectedOptions).map(opt => opt.value);
    const attendees = document.getElementById('pres-attendees').value;
    const literature = document.getElementById('pres-literature').value.trim();
    const summary = document.getElementById('pres-summary').value.trim();
    if (!date || !location || !summary || presenters.length === 0) {
        return showToast('Fill in required fields and select at least one presenter', 'error');
    }
    const presentations = storage.getPresentations();
    presentations.push({id: genId(), date, location, audience, presenters, attendees, literature, summary, loggedAt: new Date().toISOString()});
    storage.savePresentations(presentations);
    document.getElementById('pres-date').value = '';
    document.getElementById('pres-location').value = '';
    document.getElementById('pres-audience').value = 'medical';
    document.getElementById('pres-presenter').selectedIndex = -1;
    document.getElementById('pres-attendees').value = '';
    document.getElementById('pres-literature').value = '';
    document.getElementById('pres-summary').value = '';
    updatePresentationsList();
    showToast('Presentation logged!', 'success');
}
function updatePresentationsList() {
    const list = document.getElementById('presentations-list');
    if (!list) return;
    const presentations = storage.getPresentations().sort((a,b) => new Date(b.date) - new Date(a.date));
    const members = storage.getMembers();
    if (presentations.length === 0) {
        list.innerHTML = '<p style="opacity: 0.6;">No presentations logged yet.</p>';
        return;
    }
    list.innerHTML = presentations.map(p => {
        const presenterNames = p.presenters.map(pid => {
            const presenter = members.find(m => m.id === pid);
            return presenter ? presenter.name : 'Unknown';
        }).join(', ');
        return `
            <div class="box mb-2" style="padding: 0.75rem;">
                <strong style="color: #3498db;">${new Date(p.date).toLocaleDateString()}</strong> - ${escapeHtml(p.location)}<br>
                <small>Audience: ${escapeHtml(p.audience)} | Presenters: ${escapeHtml(presenterNames)}</small><br>
                ${p.attendees ? `<small>Attendees: ${p.attendees}</small><br>` : ''}
                <p style="margin-top: 0.5rem; font-size: 0.9rem;">${escapeHtml(p.summary).substring(0,150)}${p.summary.length > 150 ? '...' : ''}</p>
                ${p.literature ? `<p style="margin-top: 0.5rem; font-size: 0.85rem;"><em>Literature:</em> ${escapeHtml(p.literature)}</p>` : ''}
                <button class="btn secondary" onclick="deletePresentation('${p.id}')" style="margin-top: 0.5rem; padding: 0.3rem 0.6rem; font-size: 0.8rem;">Delete</button>
            </div>
        `;
    }).join('');
}
function deletePresentation(id) {
    if (!confirm('Delete this presentation?')) return;
    let presentations = storage.getPresentations();
    presentations = presentations.filter(p => p.id !== id);
    storage.savePresentations(presentations);
    updatePresentationsList();
    showToast('Presentation deleted', 'success');
}
function addBTGReferral() {
    const name = document.getElementById('btg-referral-name').value.trim();
    const from = document.getElementById('btg-referral-from').value.trim();
    const date = document.getElementById('btg-referral-date').value;
    const contact = document.getElementById('btg-contact').value;
    const contactPhone = document.getElementById('btg-contact-phone').value.trim();
    const notes = document.getElementById('btg-notes').value.trim();
    if (!name || !from || !date || !contact) {
        return showToast('Fill in required fields', 'error');
    }
    const referrals = storage.getBTGReferrals();
    referrals.push({id: genId(), name, from, date, contact, contactPhone, notes, status: 'active', addedAt: new Date().toISOString()});
    storage.saveBTGReferrals(referrals);
    document.getElementById('btg-referral-name').value = '';
    document.getElementById('btg-referral-from').value = '';
    document.getElementById('btg-referral-date').value = '';
    document.getElementById('btg-contact').value = '';
    document.getElementById('btg-contact-phone').value = '';
    document.getElementById('btg-notes').value = '';
    updateBTGReferralsList();
    showToast('BTG referral added!', 'success');
}
function updateBTGReferralsList() {
    const list = document.getElementById('btg-referrals-list');
    if (!list) return;
    const referrals = storage.getBTGReferrals().filter(r => r.status === 'active').sort((a,b) => new Date(b.date) - new Date(a.date));
    const members = storage.getMembers();
    if (referrals.length === 0) {
        list.innerHTML = '<p style="opacity: 0.6;">No active BTG referrals.</p>';
        return;
    }
    list.innerHTML = referrals.map(r => {
        const contact = members.find(m => m.id === r.contact);
        return `
            <div class="box mb-2" style="padding: 0.75rem;">
                <strong style="color: #3498db;">${escapeHtml(r.name)}</strong><br>
                <small>From: ${escapeHtml(r.from)} | Date: ${new Date(r.date).toLocaleDateString()}</small><br>
                ${contact ? `<small>Contact: ${escapeHtml(contact.name)} | ${escapeHtml(r.contactPhone)}</small><br>` : ''}
                ${r.notes ? `<p style="margin-top: 0.5rem; font-size: 0.85rem;">${escapeHtml(r.notes)}</p>` : ''}
                <button class="btn secondary" onclick="completeBTGReferral('${r.id}')" style="margin-top: 0.5rem; padding: 0.3rem 0.6rem; font-size: 0.8rem;">Mark Complete</button>
            </div>
        `;
    }).join('');
}
function completeBTGReferral(id) {
    const referrals = storage.getBTGReferrals();
    const idx = referrals.findIndex(r => r.id === id);
    if (idx !== -1) {
        referrals[idx].status = 'completed';
        referrals[idx].completedAt = new Date().toISOString();
        storage.saveBTGReferrals(referrals);
        updateBTGReferralsList();
        showToast('BTG referral marked complete', 'success');
    }
}

function handleMediaContactSubmit() {
    const id = document.getElementById('media-edit-id').value;
    const name = document.getElementById('media-name').value.trim();
    const outlet = document.getElementById('media-outlet').value.trim();
    const type = document.getElementById('media-type').value;
    const phone = document.getElementById('media-phone').value.trim();
    const email = document.getElementById('media-email').value.trim();
    const beat = document.getElementById('media-beat').value.trim();
    const notes = document.getElementById('media-notes').value.trim();
    if (!name || !outlet) {
        return showToast('Fill in required fields', 'error');
    }
    const contacts = storage.getMediaContacts();
    if (id) {
        const idx = contacts.findIndex(c => c.id === id);
        if (idx !== -1) {
            contacts[idx] = {...contacts[idx], name, outlet, type, phone, email, beat, notes, updatedAt: new Date().toISOString()};
            showToast('Media contact updated!', 'success');
        }
    } else {
        contacts.push({id: genId(), name, outlet, type, phone, email, beat, notes, createdAt: new Date().toISOString()});
        showToast('Media contact added!', 'success');
    }
    storage.saveMediaContacts(contacts);
    clearMediaContactForm();
    updateMediaContactsList();
}
function clearMediaContactForm() {
    document.getElementById('media-edit-id').value = '';
    document.getElementById('media-name').value = '';
    document.getElementById('media-outlet').value = '';
    document.getElementById('media-type').value = 'newspaper';
    document.getElementById('media-phone').value = '';
    document.getElementById('media-email').value = '';
    document.getElementById('media-beat').value = '';
    document.getElementById('media-notes').value = '';
    document.getElementById('media-form-btn').textContent = 'Save Media Contact';
    document.getElementById('media-form-cancel-btn').style.display = 'none';
}
function cancelMediaContactEdit() {
    clearMediaContactForm();
}
function updateMediaContactsList() {
    const list = document.getElementById('media-contacts-list');
    if (!list) return;
    const contacts = storage.getMediaContacts().sort((a,b) => a.name.localeCompare(b.name));
    if (contacts.length === 0) {
        list.innerHTML = '<p style="opacity: 0.6;">No media contacts yet.</p>';
        return;
    }
    list.innerHTML = contacts.map(c => `
        <div class="box mb-2" style="padding: 0.75rem;">
            <strong style="color: #3498db;">${escapeHtml(c.name)}</strong><br>
            <small>${escapeHtml(c.outlet)} | ${escapeHtml(c.type)}</small><br>
            ${c.phone ? `<small>Phone: ${escapeHtml(c.phone)}</small><br>` : ''}
            ${c.email ? `<small>Email: ${escapeHtml(c.email)}</small><br>` : ''}
            ${c.beat ? `<small>Beat: ${escapeHtml(c.beat)}</small><br>` : ''}
            <button class="btn" onclick="editMediaContact('${c.id}')" style="margin-top: 0.5rem; padding: 0.3rem 0.6rem; font-size: 0.8rem;">Edit</button>
            <button class="btn secondary" onclick="deleteMediaContact('${c.id}')" style="padding: 0.3rem 0.6rem; font-size: 0.8rem; margin-left: 0.3rem;">Delete</button>
        </div>
    `).join('');
}
function editMediaContact(id) {
    const contacts = storage.getMediaContacts();
    const contact = contacts.find(c => c.id === id);
    if (!contact) return;
    document.getElementById('media-edit-id').value = contact.id;
    document.getElementById('media-name').value = contact.name;
    document.getElementById('media-outlet').value = contact.outlet;
    document.getElementById('media-type').value = contact.type;
    document.getElementById('media-phone').value = contact.phone || '';
    document.getElementById('media-email').value = contact.email || '';
    document.getElementById('media-beat').value = contact.beat || '';
    document.getElementById('media-notes').value = contact.notes || '';
    document.getElementById('media-form-btn').textContent = 'Update Media Contact';
    document.getElementById('media-form-cancel-btn').style.display = 'inline-block';
}
function deleteMediaContact(id) {
    if (!confirm('Delete this media contact?')) return;
    let contacts = storage.getMediaContacts();
    contacts = contacts.filter(c => c.id !== id);
    storage.saveMediaContacts(contacts);
    updateMediaContactsList();
    showToast('Media contact deleted', 'success');
}
function loadPRTemplate() {
    const type = document.getElementById('pr-template-type').value;
    const content = document.getElementById('pr-content');
    const templates = {
        event: `FOR IMMEDIATE RELEASE\n\n[Group Name] Announces [Event Name]\n\n[City, State] - [Date] - [Group Name] is pleased to announce [Event Name], taking place on [Date] at [Location].\n\n[Event details, speakers, topics]\n\nFor more information about Alcoholics Anonymous, visit aa.org or call [Local AA Hotline].\n\n###`,
        milestone: `FOR IMMEDIATE RELEASE\n\n[Group Name] Celebrates [Milestone]\n\n[City, State] - [Date] - [Group Name] is celebrating [milestone description].\n\n[Details about the milestone and significance]\n\nAlcoholics Anonymous is a fellowship of people who share their experience, strength and hope with each other.\n\n###`,
        psa: `PUBLIC SERVICE ANNOUNCEMENT\n\nAlcoholics Anonymous Offers Hope and Help\n\nIf you think you have a problem with alcohol, Alcoholics Anonymous offers a solution. AA is a fellowship of people who share their experience, strength and hope with each other.\n\nMeetings are held throughout [Location]. For more information, visit aa.org or call [Hotline].\n\n###`,
        response: `FOR IMMEDIATE RELEASE\n\n[Group Name] Response to [News/Article Title]\n\n[City, State] - [Date] - In response to [article/news], [Group Name] would like to clarify the following:\n\n[Response points]\n\nAlcoholics Anonymous maintains anonymity at the level of press, radio, and films.\n\n###`,
        awareness: `FOR IMMEDIATE RELEASE\n\nAlcoholics Anonymous Observes [Awareness Month]\n\n[City, State] - [Date] - During [Awareness Month], Alcoholics Anonymous reminds the community that help is available for those struggling with alcohol.\n\n[Details about AA's message and availability]\n\nFor more information, visit aa.org.\n\n###`
    };
    content.value = templates[type] || '';
}
function savePressRelease() {
    const type = document.getElementById('pr-template-type').value;
    const content = document.getElementById('pr-content').value.trim();
    if (!content) {
        return showToast('Please enter content', 'error');
    }
    const releases = storage.getPressReleases();
    releases.push({id: genId(), type, content, createdAt: new Date().toISOString()});
    storage.savePressReleases(releases);
    showToast('Press release saved!', 'success');
}
function copyPRToClipboard() {
    const content = document.getElementById('pr-content').value;
    if (!content) return showToast('No content to copy', 'error');
    navigator.clipboard.writeText(content).then(() => {
        showToast('Copied to clipboard!', 'success');
    }).catch(() => {
        showToast('Failed to copy', 'error');
    });
}
function addOutreachEvent() {
    const name = document.getElementById('outreach-event-name').value.trim();
    const date = document.getElementById('outreach-event-date').value;
    const time = document.getElementById('outreach-event-time').value;
    const location = document.getElementById('outreach-event-location').value.trim();
    const type = document.getElementById('outreach-event-type').value;
    const volunteers = document.getElementById('outreach-volunteers').value;
    const materials = document.getElementById('outreach-materials').value.trim();
    const coordinator = document.getElementById('outreach-coordinator').value;
    if (!name || !date || !location) {
        return showToast('Fill in required fields', 'error');
    }
    const events = storage.getOutreachEvents();
    events.push({id: genId(), name, date, time, location, type, volunteers, materials, coordinator, createdAt: new Date().toISOString()});
    storage.saveOutreachEvents(events);
    document.getElementById('outreach-event-name').value = '';
    document.getElementById('outreach-event-date').value = '';
    document.getElementById('outreach-event-time').value = '';
    document.getElementById('outreach-event-location').value = '';
    document.getElementById('outreach-event-type').value = 'health-fair';
    document.getElementById('outreach-volunteers').value = '';
    document.getElementById('outreach-materials').value = '';
    document.getElementById('outreach-coordinator').value = '';
    updateOutreachEventsList();
    showToast('Outreach event created!', 'success');
}
function updateOutreachEventsList() {
    const list = document.getElementById('outreach-events-list');
    if (!list) return;
    const events = storage.getOutreachEvents().sort((a,b) => new Date(a.date) - new Date(b.date));
    const members = storage.getMembers();
    if (events.length === 0) {
        list.innerHTML = '<p style="opacity: 0.6;">No outreach events scheduled yet.</p>';
        return;
    }
    list.innerHTML = events.map(e => {
        const coordinator = members.find(m => m.id === e.coordinator);
        return `
            <div class="box mb-2" style="padding: 0.75rem;">
                <strong style="color: #3498db;">${escapeHtml(e.name)}</strong><br>
                <small>${new Date(e.date).toLocaleDateString()}${e.time ? ` at ${e.time}` : ''} | ${escapeHtml(e.location)}</small><br>
                <small>Type: ${escapeHtml(e.type)}</small><br>
                ${coordinator ? `<small>Coordinator: ${escapeHtml(coordinator.name)}</small><br>` : ''}
                ${e.volunteers ? `<small>Volunteers Needed: ${e.volunteers}</small><br>` : ''}
                <button class="btn secondary" onclick="deleteOutreachEvent('${e.id}')" style="margin-top: 0.5rem; padding: 0.3rem 0.6rem; font-size: 0.8rem;">Delete</button>
            </div>
        `;
    }).join('');
}
function deleteOutreachEvent(id) {
    if (!confirm('Delete this event?')) return;
    let events = storage.getOutreachEvents();
    events = events.filter(e => e.id !== id);
    storage.saveOutreachEvents(events);
    updateOutreachEventsList();
    showToast('Event deleted', 'success');
}
function logOutreachActivity() {
    const date = document.getElementById('outreach-log-date').value;
    const type = document.getElementById('outreach-log-type').value;
    const location = document.getElementById('outreach-log-location').value.trim();
    const volunteersSelect = document.getElementById('outreach-log-volunteers');
    const volunteers = Array.from(volunteersSelect.selectedOptions).map(opt => opt.value);
    const reach = document.getElementById('outreach-log-reach').value;
    const literature = document.getElementById('outreach-log-literature').value.trim();
    const notes = document.getElementById('outreach-log-notes').value.trim();
    if (!date || !location || !notes) {
        return showToast('Fill in required fields', 'error');
    }
    const logs = storage.getOutreachLogs();
    logs.push({id: genId(), date, type, location, volunteers, reach, literature, notes, loggedAt: new Date().toISOString()});
    storage.saveOutreachLogs(logs);
    document.getElementById('outreach-log-date').value = '';
    document.getElementById('outreach-log-type').value = 'display';
    document.getElementById('outreach-log-location').value = '';
    document.getElementById('outreach-log-volunteers').selectedIndex = -1;
    document.getElementById('outreach-log-reach').value = '';
    document.getElementById('outreach-log-literature').value = '';
    document.getElementById('outreach-log-notes').value = '';
    updateOutreachLogList();
    showToast('Outreach activity logged!', 'success');
}
function updateOutreachLogList() {
    const list = document.getElementById('outreach-log-list');
    if (!list) return;
    const logs = storage.getOutreachLogs().sort((a,b) => new Date(b.date) - new Date(a.date));
    const members = storage.getMembers();
    if (logs.length === 0) {
        list.innerHTML = '<p style="opacity: 0.6; margin-top: 1rem;">No outreach activities logged yet.</p>';
        return;
    }
    list.innerHTML = logs.map(l => {
        const volunteerNames = l.volunteers.map(vid => {
            const volunteer = members.find(m => m.id === vid);
            return volunteer ? volunteer.name : 'Unknown';
        }).join(', ');
        return `
            <div class="box mb-2 mt-2" style="padding: 0.75rem;">
                <strong style="color: #3498db;">${new Date(l.date).toLocaleDateString()}</strong> - ${escapeHtml(l.type)}<br>
                <small>${escapeHtml(l.location)}</small><br>
                ${volunteerNames ? `<small>Volunteers: ${escapeHtml(volunteerNames)}</small><br>` : ''}
                ${l.reach ? `<small>Reach: ${l.reach} people</small><br>` : ''}
                <p style="margin-top: 0.5rem; font-size: 0.9rem;">${escapeHtml(l.notes).substring(0,150)}${l.notes.length > 150 ? '...' : ''}</p>
                ${l.literature ? `<p style="margin-top: 0.5rem; font-size: 0.85rem;"><em>Literature:</em> ${escapeHtml(l.literature)}</p>` : ''}
                <button class="btn secondary" onclick="deleteOutreachLog('${l.id}')" style="margin-top: 0.5rem; padding: 0.3rem 0.6rem; font-size: 0.8rem;">Delete</button>
            </div>
        `;
    }).join('');
}
function deleteOutreachLog(id) {
    if (!confirm('Delete this log entry?')) return;
    let logs = storage.getOutreachLogs();
    logs = logs.filter(l => l.id !== id);
    storage.saveOutreachLogs(logs);
    updateOutreachLogList();
    showToast('Log entry deleted', 'success');
}

function handleTreatmentFacilitySubmit() {
    const id = document.getElementById('treatment-facility-edit-id').value;
    const name = document.getElementById('treatment-facility-name').value.trim();
    const type = document.getElementById('treatment-facility-type').value;
    const address = document.getElementById('treatment-facility-address').value.trim();
    const contact = document.getElementById('treatment-facility-contact').value.trim();
    const phone = document.getElementById('treatment-facility-phone').value.trim();
    const schedule = document.getElementById('treatment-facility-schedule').value.trim();
    if (!name || !address) return showToast('Fill in required fields', 'error');
    const facilities = storage.getTreatmentFacilities();
    if (id) {
        const idx = facilities.findIndex(f => f.id === id);
        if (idx !== -1) {
            facilities[idx] = {...facilities[idx], name, type, address, contact, phone, schedule, updatedAt: new Date().toISOString()};
            showToast('Facility updated!', 'success');
        }
    } else {
        facilities.push({id: genId(), name, type, address, contact, phone, schedule, createdAt: new Date().toISOString()});
        showToast('Treatment facility added!', 'success');
    }
    storage.saveTreatmentFacilities(facilities);
    clearTreatmentFacilityForm();
    updateTreatmentFacilitiesList();
    updateBridgeFacilityDropdown();
}
function clearTreatmentFacilityForm() {
    document.getElementById('treatment-facility-edit-id').value = '';
    document.getElementById('treatment-facility-name').value = '';
    document.getElementById('treatment-facility-type').value = 'inpatient';
    document.getElementById('treatment-facility-address').value = '';
    document.getElementById('treatment-facility-contact').value = '';
    document.getElementById('treatment-facility-phone').value = '';
    document.getElementById('treatment-facility-schedule').value = '';
    document.getElementById('treatment-facility-form-btn').textContent = 'Save Facility';
    document.getElementById('treatment-facility-form-cancel-btn').style.display = 'none';
}
function cancelTreatmentFacilityEdit() { clearTreatmentFacilityForm(); }
function updateTreatmentFacilitiesList() {
    const list = document.getElementById('treatment-facilities-list');
    if (!list) return;
    const facilities = storage.getTreatmentFacilities().sort((a,b) => a.name.localeCompare(b.name));
    if (facilities.length === 0) {
        list.innerHTML = '<p style="opacity: 0.6;">No treatment facilities added yet.</p>';
        return;
    }
    list.innerHTML = facilities.map(f => `
        <div class="box mb-2" style="padding: 0.75rem;">
            <strong style="color: #3498db;">${escapeHtml(f.name)}</strong><br>
            <small>${escapeHtml(f.type)} | ${escapeHtml(f.address)}</small><br>
            ${f.contact ? `<small>Contact: ${escapeHtml(f.contact)} | ${escapeHtml(f.phone)}</small><br>` : ''}
            ${f.schedule ? `<small>Schedule: ${escapeHtml(f.schedule)}</small><br>` : ''}
            <button class="btn" onclick="editTreatmentFacility('${f.id}')" style="margin-top: 0.5rem; padding: 0.3rem 0.6rem; font-size: 0.8rem;">Edit</button>
            <button class="btn secondary" onclick="deleteTreatmentFacility('${f.id}')" style="padding: 0.3rem 0.6rem; font-size: 0.8rem; margin-left: 0.3rem;">Delete</button>
        </div>
    `).join('');
}
function editTreatmentFacility(id) {
    const facilities = storage.getTreatmentFacilities();
    const facility = facilities.find(f => f.id === id);
    if (!facility) return;
    document.getElementById('treatment-facility-edit-id').value = facility.id;
    document.getElementById('treatment-facility-name').value = facility.name;
    document.getElementById('treatment-facility-type').value = facility.type;
    document.getElementById('treatment-facility-address').value = facility.address;
    document.getElementById('treatment-facility-contact').value = facility.contact || '';
    document.getElementById('treatment-facility-phone').value = facility.phone || '';
    document.getElementById('treatment-facility-schedule').value = facility.schedule || '';
    document.getElementById('treatment-facility-form-btn').textContent = 'Update Facility';
    document.getElementById('treatment-facility-form-cancel-btn').style.display = 'inline-block';
}
function deleteTreatmentFacility(id) {
    if (!confirm('Delete this facility?')) return;
    let facilities = storage.getTreatmentFacilities();
    facilities = facilities.filter(f => f.id !== id);
    storage.saveTreatmentFacilities(facilities);
    updateTreatmentFacilitiesList();
    updateBridgeFacilityDropdown();
    showToast('Facility deleted', 'success');
}
function updateBridgeFacilityDropdown() {
    const select = document.getElementById('bridge-facility');
    if (!select) return;
    const facilities = storage.getTreatmentFacilities().sort((a,b) => a.name.localeCompare(b.name));
    select.innerHTML = '<option value="">-- Select Facility --</option>' + facilities.map(f =>
        `<option value="${f.id}">${escapeHtml(f.name)}</option>`
    ).join('');
}
function addBridgingCommitment() {
    const facility = document.getElementById('bridge-facility').value;
    const clientName = document.getElementById('bridge-client-name').value.trim();
    const releaseDate = document.getElementById('bridge-release-date').value;
    const contact = document.getElementById('bridge-contact').value;
    const contactPhone = document.getElementById('bridge-contact-phone').value.trim();
    const notes = document.getElementById('bridge-notes').value.trim();
    if (!facility || !clientName || !releaseDate || !contact) return showToast('Fill in required fields', 'error');
    const commitments = storage.getBridgingCommitments();
    commitments.push({id: genId(), facility, clientName, releaseDate, contact, contactPhone, notes, status: 'active', createdAt: new Date().toISOString()});
    storage.saveBridgingCommitments(commitments);
    document.getElementById('bridge-facility').value = '';
    document.getElementById('bridge-client-name').value = '';
    document.getElementById('bridge-release-date').value = '';
    document.getElementById('bridge-contact').value = '';
    document.getElementById('bridge-contact-phone').value = '';
    document.getElementById('bridge-notes').value = '';
    updateBridgingCommitmentsList();
    updateFollowUpBridgeDropdown();
    showToast('Bridging commitment created!', 'success');
}
function updateBridgingCommitmentsList() {
    const list = document.getElementById('bridging-commitments-list');
    if (!list) return;
    const commitments = storage.getBridgingCommitments().filter(c => c.status === 'active').sort((a,b) => new Date(a.releaseDate) - new Date(b.releaseDate));
    const facilities = storage.getTreatmentFacilities();
    const members = storage.getMembers();
    if (commitments.length === 0) {
        list.innerHTML = '<p style="opacity: 0.6;">No active bridging commitments.</p>';
        return;
    }
    list.innerHTML = commitments.map(c => {
        const facility = facilities.find(f => f.id === c.facility);
        const contact = members.find(m => m.id === c.contact);
        return `
            <div class="box mb-2" style="padding: 0.75rem;">
                <strong style="color: #3498db;">${escapeHtml(c.clientName)}</strong><br>
                <small>Facility: ${facility ? escapeHtml(facility.name) : 'Unknown'}</small><br>
                <small>Release Date: ${new Date(c.releaseDate).toLocaleDateString()}</small><br>
                ${contact ? `<small>Contact: ${escapeHtml(contact.name)} | ${escapeHtml(c.contactPhone)}</small><br>` : ''}
                ${c.notes ? `<p style="margin-top: 0.5rem; font-size: 0.85rem;">${escapeHtml(c.notes)}</p>` : ''}
                <button class="btn secondary" onclick="completeBridgingCommitment('${c.id}')" style="margin-top: 0.5rem; padding: 0.3rem 0.6rem; font-size: 0.8rem;">Mark Complete</button>
            </div>
        `;
    }).join('');
}
function completeBridgingCommitment(id) {
    const commitments = storage.getBridgingCommitments();
    const idx = commitments.findIndex(c => c.id === id);
    if (idx !== -1) {
        commitments[idx].status = 'completed';
        commitments[idx].completedAt = new Date().toISOString();
        storage.saveBridgingCommitments(commitments);
        updateBridgingCommitmentsList();
        updateFollowUpBridgeDropdown();
        showToast('Bridging commitment marked complete', 'success');
    }
}
function updateFollowUpBridgeDropdown() {
    const select = document.getElementById('followup-bridge');
    if (!select) return;
    const commitments = storage.getBridgingCommitments().filter(c => c.status === 'active').sort((a,b) => new Date(a.releaseDate) - new Date(b.releaseDate));
    select.innerHTML = '<option value="">-- Select Commitment --</option>' + commitments.map(c =>
        `<option value="${c.id}">${escapeHtml(c.clientName)} - ${new Date(c.releaseDate).toLocaleDateString()}</option>`
    ).join('');
}
function logFollowUp() {
    const bridgeId = document.getElementById('followup-bridge').value;
    const date = document.getElementById('followup-date').value;
    const status = document.getElementById('followup-status').value;
    const notes = document.getElementById('followup-notes').value.trim();
    if (!bridgeId || !date || !notes) return showToast('Fill in all fields', 'error');
    const followups = storage.getFollowUps();
    followups.push({id: genId(), bridgeId, date, status, notes, loggedAt: new Date().toISOString()});
    storage.saveFollowUps(followups);
    document.getElementById('followup-bridge').value = '';
    document.getElementById('followup-date').value = '';
    document.getElementById('followup-status').value = 'contacted';
    document.getElementById('followup-notes').value = '';
    showToast('Follow-up logged!', 'success');
}

function handleCorrectionsFacilitySubmit() {
    const id = document.getElementById('corrections-facility-edit-id').value;
    const name = document.getElementById('corrections-facility-name').value.trim();
    const type = document.getElementById('corrections-facility-type').value;
    const address = document.getElementById('corrections-facility-address').value.trim();
    const contact = document.getElementById('corrections-facility-contact').value.trim();
    const phone = document.getElementById('corrections-facility-phone').value.trim();
    const clearanceReq = document.getElementById('corrections-clearance-req').value.trim();
    if (!name || !address) return showToast('Fill in required fields', 'error');
    const facilities = storage.getCorrectionsFacilities();
    if (id) {
        const idx = facilities.findIndex(f => f.id === id);
        if (idx !== -1) {
            facilities[idx] = {...facilities[idx], name, type, address, contact, phone, clearanceReq, updatedAt: new Date().toISOString()};
            showToast('Facility updated!', 'success');
        }
    } else {
        facilities.push({id: genId(), name, type, address, contact, phone, clearanceReq, createdAt: new Date().toISOString()});
        showToast('Correctional facility added!', 'success');
    }
    storage.saveCorrectionsFacilities(facilities);
    clearCorrectionsFacilityForm();
    updateCorrectionsFacilitiesList();
    updateCorrectionsClearanceFacilityDropdown();
    updatePreReleaseFacilityDropdown();
}
function clearCorrectionsFacilityForm() {
    document.getElementById('corrections-facility-edit-id').value = '';
    document.getElementById('corrections-facility-name').value = '';
    document.getElementById('corrections-facility-type').value = 'county-jail';
    document.getElementById('corrections-facility-address').value = '';
    document.getElementById('corrections-facility-contact').value = '';
    document.getElementById('corrections-facility-phone').value = '';
    document.getElementById('corrections-clearance-req').value = '';
    document.getElementById('corrections-facility-form-btn').textContent = 'Save Facility';
    document.getElementById('corrections-facility-form-cancel-btn').style.display = 'none';
}
function cancelCorrectionsFacilityEdit() { clearCorrectionsFacilityForm(); }
function updateCorrectionsFacilitiesList() {
    const list = document.getElementById('corrections-facilities-list');
    if (!list) return;
    const facilities = storage.getCorrectionsFacilities().sort((a,b) => a.name.localeCompare(b.name));
    if (facilities.length === 0) {
        list.innerHTML = '<p style="opacity: 0.6;">No facilities added yet.</p>';
        return;
    }
    list.innerHTML = facilities.map(f => `
        <div class="box mb-2" style="padding: 0.75rem;">
            <strong style="color: #3498db;">${escapeHtml(f.name)}</strong><br>
            <small>${escapeHtml(f.type)} | ${escapeHtml(f.address)}</small><br>
            ${f.contact ? `<small>Contact: ${escapeHtml(f.contact)}</small><br>` : ''}
            <button class="btn" onclick="editCorrectionsFacility('${f.id}')" style="margin-top: 0.5rem; padding: 0.3rem 0.6rem; font-size: 0.8rem;">Edit</button>
            <button class="btn secondary" onclick="deleteCorrectionsFacility('${f.id}')" style="padding: 0.3rem 0.6rem; font-size: 0.8rem; margin-left: 0.3rem;">Delete</button>
        </div>
    `).join('');
}
function editCorrectionsFacility(id) {
    const facilities = storage.getCorrectionsFacilities();
    const facility = facilities.find(f => f.id === id);
    if (!facility) return;
    document.getElementById('corrections-facility-edit-id').value = facility.id;
    document.getElementById('corrections-facility-name').value = facility.name;
    document.getElementById('corrections-facility-type').value = facility.type;
    document.getElementById('corrections-facility-address').value = facility.address;
    document.getElementById('corrections-facility-contact').value = facility.contact || '';
    document.getElementById('corrections-facility-phone').value = facility.phone || '';
    document.getElementById('corrections-clearance-req').value = facility.clearanceReq || '';
    document.getElementById('corrections-facility-form-btn').textContent = 'Update Facility';
    document.getElementById('corrections-facility-form-cancel-btn').style.display = 'inline-block';
}
function deleteCorrectionsFacility(id) {
    if (!confirm('Delete this facility?')) return;
    let facilities = storage.getCorrectionsFacilities();
    facilities = facilities.filter(f => f.id !== id);
    storage.saveCorrectionsFacilities(facilities);
    updateCorrectionsFacilitiesList();
    updateCorrectionsClearanceFacilityDropdown();
    updatePreReleaseFacilityDropdown();
    showToast('Facility deleted', 'success');
}
function updateCorrectionsClearanceFacilityDropdown() {
    const select = document.getElementById('corrections-clearance-facility');
    if (!select) return;
    const facilities = storage.getCorrectionsFacilities().sort((a,b) => a.name.localeCompare(b.name));
    select.innerHTML = '<option value="">-- Select Facility --</option>' + facilities.map(f =>
        `<option value="${f.id}">${escapeHtml(f.name)}</option>`
    ).join('');
}
function addCorrectionsClearance() {
    const member = document.getElementById('corrections-clearance-member').value;
    const facility = document.getElementById('corrections-clearance-facility').value;
    const date = document.getElementById('corrections-clearance-date').value;
    const expiry = document.getElementById('corrections-clearance-expiry').value;
    const notes = document.getElementById('corrections-clearance-notes').value.trim();
    if (!member || !facility || !date) return showToast('Fill in required fields', 'error');
    const clearances = storage.getCorrectionsClearances();
    clearances.push({id: genId(), member, facility, date, expiry, notes, addedAt: new Date().toISOString()});
    storage.saveCorrectionsClearances(clearances);
    document.getElementById('corrections-clearance-member').value = '';
    document.getElementById('corrections-clearance-facility').value = '';
    document.getElementById('corrections-clearance-date').value = '';
    document.getElementById('corrections-clearance-expiry').value = '';
    document.getElementById('corrections-clearance-notes').value = '';
    showToast('Clearance added!', 'success');
}
function updatePreReleaseFacilityDropdown() {
    const select = document.getElementById('prerelease-facility');
    if (!select) return;
    const facilities = storage.getCorrectionsFacilities().sort((a,b) => a.name.localeCompare(b.name));
    select.innerHTML = '<option value="">-- Select Facility --</option>' + facilities.map(f =>
        `<option value="${f.id}">${escapeHtml(f.name)}</option>`
    ).join('');
}
function addPreReleaseContact() {
    const name = document.getElementById('prerelease-name').value.trim();
    const facility = document.getElementById('prerelease-facility').value;
    const date = document.getElementById('prerelease-date').value;
    const contact = document.getElementById('prerelease-contact').value;
    const correspondence = document.getElementById('prerelease-correspondence').value;
    const needs = document.getElementById('prerelease-needs').value.trim();
    if (!name || !facility || !date || !contact) return showToast('Fill in required fields', 'error');
    const contacts = storage.getPreReleaseContacts();
    contacts.push({id: genId(), name, facility, date, contact, correspondence, needs, status: 'active', createdAt: new Date().toISOString()});
    storage.savePreReleaseContacts(contacts);
    document.getElementById('prerelease-name').value = '';
    document.getElementById('prerelease-facility').value = '';
    document.getElementById('prerelease-date').value = '';
    document.getElementById('prerelease-contact').value = '';
    document.getElementById('prerelease-correspondence').value = 'mail';
    document.getElementById('prerelease-needs').value = '';
    updatePreReleaseList();
    updateCorrespondencePreReleaseDropdown();
    showToast('Pre-release contact added!', 'success');
}
function updatePreReleaseList() {
    const list = document.getElementById('prerelease-list');
    if (!list) return;
    const contacts = storage.getPreReleaseContacts().filter(c => c.status === 'active').sort((a,b) => new Date(a.date) - new Date(b.date));
    const facilities = storage.getCorrectionsFacilities();
    const members = storage.getMembers();
    if (contacts.length === 0) {
        list.innerHTML = '<p style="opacity: 0.6; margin-top: 1rem;">No active pre-release contacts.</p>';
        return;
    }
    list.innerHTML = contacts.map(c => {
        const facility = facilities.find(f => f.id === c.facility);
        const contact = members.find(m => m.id === c.contact);
        return `
            <div class="box mb-2 mt-2" style="padding: 0.75rem;">
                <strong style="color: #3498db;">${escapeHtml(c.name)}</strong><br>
                <small>Facility: ${facility ? escapeHtml(facility.name) : 'Unknown'}</small><br>
                <small>Release: ${new Date(c.date).toLocaleDateString()}</small><br>
                ${contact ? `<small>Contact: ${escapeHtml(contact.name)}</small><br>` : ''}
                <button class="btn secondary" onclick="completePreRelease('${c.id}')" style="margin-top: 0.5rem; padding: 0.3rem 0.6rem; font-size: 0.8rem;">Mark Complete</button>
            </div>
        `;
    }).join('');
}
function completePreRelease(id) {
    const contacts = storage.getPreReleaseContacts();
    const idx = contacts.findIndex(c => c.id === id);
    if (idx !== -1) {
        contacts[idx].status = 'completed';
        contacts[idx].completedAt = new Date().toISOString();
        storage.savePreReleaseContacts(contacts);
        updatePreReleaseList();
        updateCorrespondencePreReleaseDropdown();
        showToast('Pre-release contact marked complete', 'success');
    }
}
function updateCorrespondencePreReleaseDropdown() {
    const select = document.getElementById('correspondence-prerelease');
    if (!select) return;
    const contacts = storage.getPreReleaseContacts().filter(c => c.status === 'active').sort((a,b) => new Date(a.date) - new Date(b.date));
    select.innerHTML = '<option value="">-- Select Contact --</option>' + contacts.map(c =>
        `<option value="${c.id}">${escapeHtml(c.name)} - ${new Date(c.date).toLocaleDateString()}</option>`
    ).join('');
}
function logCorrespondence() {
    const preReleaseId = document.getElementById('correspondence-prerelease').value;
    const date = document.getElementById('correspondence-date').value;
    const type = document.getElementById('correspondence-type').value;
    const summary = document.getElementById('correspondence-summary').value.trim();
    if (!preReleaseId || !date || !summary) return showToast('Fill in all fields', 'error');
    const log = storage.getCorrespondenceLog();
    log.push({id: genId(), preReleaseId, date, type, summary, loggedAt: new Date().toISOString()});
    storage.saveCorrespondenceLog(log);
    document.getElementById('correspondence-prerelease').value = '';
    document.getElementById('correspondence-date').value = '';
    document.getElementById('correspondence-type').value = 'sent';
    document.getElementById('correspondence-summary').value = '';
    updateCorrespondenceLog();
    showToast('Correspondence logged!', 'success');
}
function updateCorrespondenceLog() {
    const list = document.getElementById('correspondence-log');
    if (!list) return;
    const log = storage.getCorrespondenceLog().sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 20);
    const contacts = storage.getPreReleaseContacts();
    if (log.length === 0) {
        list.innerHTML = '<p style="opacity: 0.6;">No correspondence logged yet.</p>';
        return;
    }
    list.innerHTML = log.map(l => {
        const contact = contacts.find(c => c.id === l.preReleaseId);
        return `
            <div class="box mb-2" style="padding: 0.75rem;">
                <strong>${new Date(l.date).toLocaleDateString()}</strong> - ${escapeHtml(l.type)}<br>
                <small>${contact ? escapeHtml(contact.name) : 'Unknown'}</small><br>
                <p style="margin-top: 0.5rem; font-size: 0.85rem;">${escapeHtml(l.summary)}</p>
            </div>
        `;
    }).join('');
}

function handleEventMgmtSubmit() {
    const id = document.getElementById('event-mgmt-edit-id').value;
    const name = document.getElementById('event-mgmt-name').value.trim();
    const type = document.getElementById('event-mgmt-type').value;
    const date = document.getElementById('event-mgmt-date').value;
    const time = document.getElementById('event-mgmt-time').value;
    const location = document.getElementById('event-mgmt-location').value.trim();
    const coordinator = document.getElementById('event-mgmt-coordinator').value;
    const budget = document.getElementById('event-mgmt-budget').value;
    const capacity = document.getElementById('event-mgmt-capacity').value;
    if (!name || !date || !location) return showToast('Fill in required fields', 'error');
    const events = storage.getEventsMgmt();
    if (id) {
        const idx = events.findIndex(e => e.id === id);
        if (idx !== -1) {
            events[idx] = {...events[idx], name, type, date, time, location, coordinator, budget, capacity, updatedAt: new Date().toISOString()};
            showToast('Event updated!', 'success');
        }
    } else {
        events.push({id: genId(), name, type, date, time, location, coordinator, budget, capacity, createdAt: new Date().toISOString()});
        showToast('Event created!', 'success');
    }
    storage.saveEventsMgmt(events);
    clearEventMgmtForm();
    updateEventsMgmtList();
    updateEventDropdowns();
}
function clearEventMgmtForm() {
    document.getElementById('event-mgmt-edit-id').value = '';
    document.getElementById('event-mgmt-name').value = '';
    document.getElementById('event-mgmt-type').value = 'unity-day';
    document.getElementById('event-mgmt-date').value = '';
    document.getElementById('event-mgmt-time').value = '';
    document.getElementById('event-mgmt-location').value = '';
    document.getElementById('event-mgmt-coordinator').value = '';
    document.getElementById('event-mgmt-budget').value = '';
    document.getElementById('event-mgmt-capacity').value = '';
    document.getElementById('event-mgmt-form-btn').textContent = 'Create Event';
    document.getElementById('event-mgmt-form-cancel-btn').style.display = 'none';
}
function cancelEventMgmtEdit() { clearEventMgmtForm(); }
function updateEventsMgmtList() {
    const list = document.getElementById('events-mgmt-list');
    if (!list) return;
    const events = storage.getEventsMgmt().sort((a,b) => new Date(a.date) - new Date(b.date));
    const members = storage.getMembers();
    if (events.length === 0) {
        list.innerHTML = '<p style="opacity: 0.6;">No events scheduled yet.</p>';
        return;
    }
    list.innerHTML = events.map(e => {
        const coordinator = members.find(m => m.id === e.coordinator);
        return `
            <div class="box mb-2" style="padding: 0.75rem;">
                <strong style="color: #3498db;">${escapeHtml(e.name)}</strong><br>
                <small>${escapeHtml(e.type)} | ${new Date(e.date).toLocaleDateString()}${e.time ? ` at ${e.time}` : ''}</small><br>
                <small>Location: ${escapeHtml(e.location)}</small><br>
                ${coordinator ? `<small>Coordinator: ${escapeHtml(coordinator.name)}</small><br>` : ''}
                ${e.budget ? `<small>Budget: $${parseFloat(e.budget).toFixed(2)}</small><br>` : ''}
                <button class="btn" onclick="editEventMgmt('${e.id}')" style="margin-top: 0.5rem; padding: 0.3rem 0.6rem; font-size: 0.8rem;">Edit</button>
                <button class="btn secondary" onclick="deleteEventMgmt('${e.id}')" style="padding: 0.3rem 0.6rem; font-size: 0.8rem; margin-left: 0.3rem;">Delete</button>
            </div>
        `;
    }).join('');
}
function editEventMgmt(id) {
    const events = storage.getEventsMgmt();
    const event = events.find(e => e.id === id);
    if (!event) return;
    document.getElementById('event-mgmt-edit-id').value = event.id;
    document.getElementById('event-mgmt-name').value = event.name;
    document.getElementById('event-mgmt-type').value = event.type;
    document.getElementById('event-mgmt-date').value = event.date;
    document.getElementById('event-mgmt-time').value = event.time || '';
    document.getElementById('event-mgmt-location').value = event.location;
    document.getElementById('event-mgmt-coordinator').value = event.coordinator || '';
    document.getElementById('event-mgmt-budget').value = event.budget || '';
    document.getElementById('event-mgmt-capacity').value = event.capacity || '';
    document.getElementById('event-mgmt-form-btn').textContent = 'Update Event';
    document.getElementById('event-mgmt-form-cancel-btn').style.display = 'inline-block';
}
function deleteEventMgmt(id) {
    if (!confirm('Delete this event?')) return;
    let events = storage.getEventsMgmt();
    events = events.filter(e => e.id !== id);
    storage.saveEventsMgmt(events);
    updateEventsMgmtList();
    updateEventDropdowns();
    showToast('Event deleted', 'success');
}
function updateEventDropdowns() {
    const selects = ['speaker-event', 'volunteer-event', 'event-expense-event', 'ticket-event'];
    const events = storage.getEventsMgmt().sort((a,b) => new Date(a.date) - new Date(b.date));
    selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select) {
            select.innerHTML = '<option value="">-- Select Event --</option>' + events.map(e =>
                `<option value="${e.id}">${escapeHtml(e.name)} - ${new Date(e.date).toLocaleDateString()}</option>`
            ).join('');
        }
    });
}
function bookSpeaker() {
    const eventId = document.getElementById('speaker-event').value;
    const name = document.getElementById('speaker-name').value.trim();
    const topic = document.getElementById('speaker-topic').value.trim();
    const timeSlot = document.getElementById('speaker-time-slot').value;
    const duration = document.getElementById('speaker-duration').value;
    const contact = document.getElementById('speaker-contact').value.trim();
    const confirmed = document.getElementById('speaker-confirmed').value;
    if (!eventId || !name) return showToast('Select event and enter speaker name', 'error');
    const speakers = storage.getSpeakers();
    speakers.push({id: genId(), eventId, name, topic, timeSlot, duration, contact, confirmed, bookedAt: new Date().toISOString()});
    storage.saveSpeakers(speakers);
    document.getElementById('speaker-event').value = '';
    document.getElementById('speaker-name').value = '';
    document.getElementById('speaker-topic').value = '';
    document.getElementById('speaker-time-slot').value = '';
    document.getElementById('speaker-duration').value = '';
    document.getElementById('speaker-contact').value = '';
    document.getElementById('speaker-confirmed').value = 'pending';
    updateSpeakersList();
    showToast('Speaker booked!', 'success');
}
function updateSpeakersList() {
    const list = document.getElementById('speakers-list');
    if (!list) return;
    const speakers = storage.getSpeakers().sort((a,b) => (a.timeSlot || '').localeCompare(b.timeSlot || ''));
    const events = storage.getEventsMgmt();
    if (speakers.length === 0) {
        list.innerHTML = '<p style="opacity: 0.6;">No speakers booked yet.</p>';
        return;
    }
    list.innerHTML = speakers.map(s => {
        const event = events.find(e => e.id === s.eventId);
        const statusColor = {pending: '#f39c12', confirmed: '#2ecc71', tentative: '#3498db', declined: '#e74c3c'}[s.confirmed] || '#95a5a6';
        return `
            <div class="box mb-2" style="padding: 0.75rem; border-left: 4px solid ${statusColor};">
                <strong>${escapeHtml(s.name)}</strong>${s.topic ? ` - "${escapeHtml(s.topic)}"` : ''}<br>
                <small>Event: ${event ? escapeHtml(event.name) : 'Unknown'}</small><br>
                ${s.timeSlot ? `<small>Time: ${s.timeSlot}${s.duration ? ` (${s.duration} min)` : ''}</small><br>` : ''}
                <span style="padding: 2px 6px; border-radius: 3px; font-size: 0.7rem; background: ${statusColor}; color: white;">${s.confirmed.toUpperCase()}</span>
                <button class="btn secondary" onclick="deleteSpeaker('${s.id}')" style="margin-top: 0.5rem; padding: 0.3rem 0.6rem; font-size: 0.8rem;">Delete</button>
            </div>
        `;
    }).join('');
}
function deleteSpeaker(id) {
    if (!confirm('Remove this speaker?')) return;
    let speakers = storage.getSpeakers();
    speakers = speakers.filter(s => s.id !== id);
    storage.saveSpeakers(speakers);
    updateSpeakersList();
    showToast('Speaker removed', 'success');
}
function signUpVolunteer() {
    const eventId = document.getElementById('volunteer-event').value;
    const role = document.getElementById('volunteer-role').value;
    const member = document.getElementById('volunteer-member').value;
    const shift = document.getElementById('volunteer-shift').value.trim();
    if (!eventId || !role || !member) return showToast('Fill in all fields', 'error');
    const volunteers = storage.getEventVolunteers();
    volunteers.push({id: genId(), eventId, role, member, shift, signedUpAt: new Date().toISOString()});
    storage.saveEventVolunteers(volunteers);
    document.getElementById('volunteer-event').value = '';
    document.getElementById('volunteer-role').value = 'setup';
    document.getElementById('volunteer-member').value = '';
    document.getElementById('volunteer-shift').value = '';
    updateVolunteersSchedule();
    showToast('Volunteer signed up!', 'success');
}
function updateVolunteersSchedule() {
    const list = document.getElementById('volunteers-schedule');
    if (!list) return;
    const volunteers = storage.getEventVolunteers();
    const events = storage.getEventsMgmt();
    const members = storage.getMembers();
    if (volunteers.length === 0) {
        list.innerHTML = '<p style="opacity: 0.6;">No volunteers signed up yet.</p>';
        return;
    }
    list.innerHTML = volunteers.map(v => {
        const event = events.find(e => e.id === v.eventId);
        const member = members.find(m => m.id === v.member);
        return `
            <div class="box mb-2" style="padding: 0.75rem;">
                <strong>${member ? escapeHtml(member.name) : 'Unknown'}</strong><br>
                <small>Event: ${event ? escapeHtml(event.name) : 'Unknown'}</small><br>
                <small>Role: ${escapeHtml(v.role)}${v.shift ? ` | ${escapeHtml(v.shift)}` : ''}</small><br>
                <button class="btn secondary" onclick="deleteVolunteer('${v.id}')" style="margin-top: 0.5rem; padding: 0.3rem 0.6rem; font-size: 0.8rem;">Remove</button>
            </div>
        `;
    }).join('');
}
function deleteVolunteer(id) {
    if (!confirm('Remove this volunteer?')) return;
    let volunteers = storage.getEventVolunteers();
    volunteers = volunteers.filter(v => v.id !== id);
    storage.saveEventVolunteers(volunteers);
    updateVolunteersSchedule();
    showToast('Volunteer removed', 'success');
}
function logEventExpense() {
    const eventId = document.getElementById('event-expense-event').value;
    const category = document.getElementById('event-expense-category').value;
    const amount = document.getElementById('event-expense-amount').value;
    const paid = document.getElementById('event-expense-paid').value;
    const notes = document.getElementById('event-expense-notes').value.trim();
    if (!eventId || !amount) return showToast('Select event and enter amount', 'error');
    const expenses = storage.getEventExpenses();
    expenses.push({id: genId(), eventId, category, amount: parseFloat(amount), paid, notes, loggedAt: new Date().toISOString()});
    storage.saveEventExpenses(expenses);
    document.getElementById('event-expense-event').value = '';
    document.getElementById('event-expense-category').value = 'venue';
    document.getElementById('event-expense-amount').value = '';
    document.getElementById('event-expense-paid').value = 'planned';
    document.getElementById('event-expense-notes').value = '';
    updateEventBudgetSummary();
    showToast('Expense logged!', 'success');
}
function updateEventBudgetSummary() {
    const summary = document.getElementById('event-budget-summary');
    if (!summary) return;
    const expenses = storage.getEventExpenses();
    const events = storage.getEventsMgmt();
    if (events.length === 0) {
        summary.innerHTML = '<p style="opacity: 0.6;">No events to show budget for.</p>';
        return;
    }
    const eventBudgets = events.map(event => {
        const eventExpenses = expenses.filter(ex => ex.eventId === event.id);
        const totalExpenses = eventExpenses.reduce((sum, ex) => sum + ex.amount, 0);
        const budgetAmount = parseFloat(event.budget) || 0;
        const remaining = budgetAmount - totalExpenses;
        const pctUsed = budgetAmount > 0 ? (totalExpenses / budgetAmount * 100).toFixed(1) : 0;
        return {event, totalExpenses, budgetAmount, remaining, pctUsed};
    });
    summary.innerHTML = eventBudgets.map(({event, totalExpenses, budgetAmount, remaining, pctUsed}) => {
        const statusColor = remaining >= 0 ? '#2ecc71' : '#e74c3c';
        return `
            <div class="box mb-2" style="padding: 0.75rem;">
                <strong>${escapeHtml(event.name)}</strong><br>
                <small>Budget: $${budgetAmount.toFixed(2)} | Spent: $${totalExpenses.toFixed(2)}</small><br>
                <small style="color: ${statusColor};">Remaining: $${remaining.toFixed(2)} (${pctUsed}% used)</small>
            </div>
        `;
    }).join('');
}
function updateTicketSales() {
    const eventId = document.getElementById('ticket-event').value;
    const price = document.getElementById('ticket-price').value;
    const sold = document.getElementById('tickets-sold').value;
    if (!eventId || !price || !sold) return showToast('Fill in all fields', 'error');
    const revenue = parseFloat(price) * parseInt(sold);
    document.getElementById('ticket-revenue').value = revenue.toFixed(2);
    const sales = storage.getTicketSales();
    const existingIdx = sales.findIndex(s => s.eventId === eventId);
    if (existingIdx !== -1) {
        sales[existingIdx] = {eventId, price: parseFloat(price), sold: parseInt(sold), revenue, updatedAt: new Date().toISOString()};
    } else {
        sales.push({eventId, price: parseFloat(price), sold: parseInt(sold), revenue, createdAt: new Date().toISOString()});
    }
    storage.saveTicketSales(sales);
    updateTicketSalesSummary();
    showToast('Ticket sales updated!', 'success');
}
function updateTicketSalesSummary() {
    const summary = document.getElementById('ticket-sales-summary');
    if (!summary) return;
    const sales = storage.getTicketSales();
    const events = storage.getEventsMgmt();
    if (sales.length === 0) {
        summary.innerHTML = '<p style="opacity: 0.6;">No ticket sales recorded yet.</p>';
        return;
    }
    summary.innerHTML = sales.map(s => {
        const event = events.find(e => e.id === s.eventId);
        return `
            <div class="box mb-2" style="padding: 0.75rem;">
                <strong>${event ? escapeHtml(event.name) : 'Unknown Event'}</strong><br>
                <small>Tickets Sold: ${s.sold} @ $${s.price.toFixed(2)} each</small><br>
                <strong style="color: #2ecc71;">Total Revenue: $${s.revenue.toFixed(2)}</strong>
            </div>
        `;
    }).join('');
}

function handleArchiveSubmit() {
    const id = document.getElementById('archive-edit-id').value;
    const title = document.getElementById('archive-title').value.trim();
    const category = document.getElementById('archive-category').value;
    const date = document.getElementById('archive-date').value;
    const year = document.getElementById('archive-year').value;
    const description = document.getElementById('archive-description').value.trim();
    const tags = document.getElementById('archive-tags').value.trim();
    const location = document.getElementById('archive-location').value.trim();
    const fileInput = document.getElementById('archive-file');
    const fileName = fileInput.files.length > 0 ? fileInput.files[0].name : '';
    if (!title || !category || !year) return showToast('Fill in required fields', 'error');
    const documents = storage.getArchiveDocuments();
    if (id) {
        const idx = documents.findIndex(d => d.id === id);
        if (idx !== -1) {
            documents[idx] = {...documents[idx], title, category, date, year: parseInt(year), description, tags, location, fileName, updatedAt: new Date().toISOString()};
            showToast('Archive document updated!', 'success');
        }
    } else {
        documents.push({id: genId(), title, category, date, year: parseInt(year), description, tags, location, fileName, createdAt: new Date().toISOString()});
        showToast('Archive document added!', 'success');
    }
    storage.saveArchiveDocuments(documents);
    clearArchiveForm();
    filterArchives();
}
function clearArchiveForm() {
    document.getElementById('archive-edit-id').value = '';
    document.getElementById('archive-title').value = '';
    document.getElementById('archive-category').value = 'minutes';
    document.getElementById('archive-date').value = '';
    document.getElementById('archive-year').value = '';
    document.getElementById('archive-description').value = '';
    document.getElementById('archive-tags').value = '';
    document.getElementById('archive-location').value = '';
    document.getElementById('archive-file').value = '';
    document.getElementById('archive-form-btn').textContent = 'Save Archive Document';
    document.getElementById('archive-form-cancel-btn').style.display = 'none';
}
function cancelArchiveEdit() { clearArchiveForm(); }
function searchArchives() {
    filterArchives();
}
function filterArchives() {
    const list = document.getElementById('archives-list');
    if (!list) return;
    const searchTerm = document.getElementById('archive-search').value.toLowerCase();
    const categoryFilter = document.getElementById('archive-filter-category').value;
    const decadeFilter = document.getElementById('archive-filter-decade').value;
    let documents = storage.getArchiveDocuments().sort((a,b) => b.year - a.year);
    if (searchTerm) {
        documents = documents.filter(d =>
            d.title.toLowerCase().includes(searchTerm) ||
            d.description.toLowerCase().includes(searchTerm) ||
            (d.tags && d.tags.toLowerCase().includes(searchTerm))
        );
    }
    if (categoryFilter && categoryFilter !== 'all') {
        documents = documents.filter(d => d.category === categoryFilter);
    }
    if (decadeFilter && decadeFilter !== 'all') {
        const decadeMap = {'2020s': [2020, 2029], '2010s': [2010, 2019], '2000s': [2000, 2009], '1990s': [1990, 1999], '1980s': [1980, 1989], '1970s': [1970, 1979], '1960s': [1960, 1969], '1950s': [1950, 1959], 'earlier': [1935, 1949]};
        const [start, end] = decadeMap[decadeFilter] || [0, 9999];
        documents = documents.filter(d => d.year >= start && d.year <= end);
    }
    if (documents.length === 0) {
        list.innerHTML = '<p style="opacity: 0.6;">No documents found.</p>';
        return;
    }
    list.innerHTML = documents.map(d => `
        <div class="box mb-2" style="padding: 0.75rem;">
            <strong style="color: #3498db;">${escapeHtml(d.title)}</strong> (${d.year})<br>
            <small>${escapeHtml(d.category)}${d.date ? ` | ${new Date(d.date).toLocaleDateString()}` : ''}</small><br>
            ${d.description ? `<p style="margin-top: 0.5rem; font-size: 0.85rem;">${escapeHtml(d.description)}</p>` : ''}
            ${d.tags ? `<small style="opacity: 0.7;">Tags: ${escapeHtml(d.tags)}</small><br>` : ''}
            ${d.location ? `<small>Location: ${escapeHtml(d.location)}</small><br>` : ''}
            ${d.fileName ? `<small>File: ${escapeHtml(d.fileName)}</small><br>` : ''}
            <button class="btn" onclick="editArchive('${d.id}')" style="margin-top: 0.5rem; padding: 0.3rem 0.6rem; font-size: 0.8rem;">Edit</button>
            <button class="btn secondary" onclick="deleteArchive('${d.id}')" style="padding: 0.3rem 0.6rem; font-size: 0.8rem; margin-left: 0.3rem;">Delete</button>
        </div>
    `).join('');
}
function editArchive(id) {
    const documents = storage.getArchiveDocuments();
    const doc = documents.find(d => d.id === id);
    if (!doc) return;
    document.getElementById('archive-edit-id').value = doc.id;
    document.getElementById('archive-title').value = doc.title;
    document.getElementById('archive-category').value = doc.category;
    document.getElementById('archive-date').value = doc.date || '';
    document.getElementById('archive-year').value = doc.year;
    document.getElementById('archive-description').value = doc.description || '';
    document.getElementById('archive-tags').value = doc.tags || '';
    document.getElementById('archive-location').value = doc.location || '';
    document.getElementById('archive-form-btn').textContent = 'Update Archive Document';
    document.getElementById('archive-form-cancel-btn').style.display = 'inline-block';
}
function deleteArchive(id) {
    if (!confirm('Delete this archive document?')) return;
    let documents = storage.getArchiveDocuments();
    documents = documents.filter(d => d.id !== id);
    storage.saveArchiveDocuments(documents);
    filterArchives();
    showToast('Archive document deleted', 'success');
}
function addInterview() {
    const name = document.getElementById('interview-name').value.trim();
    const date = document.getElementById('interview-date').value;
    const sobrietyDate = document.getElementById('interview-sobriety-date').value;
    const joinedGroup = document.getElementById('interview-joined-group').value;
    const interviewer = document.getElementById('interview-interviewer').value;
    const format = document.getElementById('interview-format').value;
    const topics = document.getElementById('interview-topics').value.trim();
    const summary = document.getElementById('interview-summary').value.trim();
    if (!name || !date || !summary) return showToast('Fill in required fields', 'error');
    const interviews = storage.getInterviews();
    interviews.push({id: genId(), name, date, sobrietyDate, joinedGroup: parseInt(joinedGroup), interviewer, format, topics, summary, createdAt: new Date().toISOString()});
    storage.saveInterviews(interviews);
    document.getElementById('interview-name').value = '';
    document.getElementById('interview-date').value = '';
    document.getElementById('interview-sobriety-date').value = '';
    document.getElementById('interview-joined-group').value = '';
    document.getElementById('interview-interviewer').value = '';
    document.getElementById('interview-format').value = 'audio';
    document.getElementById('interview-topics').value = '';
    document.getElementById('interview-summary').value = '';
    updateInterviewsList();
    showToast('Interview saved!', 'success');
}
function updateInterviewsList() {
    const list = document.getElementById('interviews-list');
    if (!list) return;
    const interviews = storage.getInterviews().sort((a,b) => new Date(b.date) - new Date(a.date));
    const members = storage.getMembers();
    if (interviews.length === 0) {
        list.innerHTML = '<p style="opacity: 0.6;">No interviews recorded yet.</p>';
        return;
    }
    list.innerHTML = interviews.map(i => {
        const interviewer = members.find(m => m.id === i.interviewer);
        const sobrietyYears = i.sobrietyDate ? ((new Date() - new Date(i.sobrietyDate)) / (1000 * 60 * 60 * 24 * 365)).toFixed(1) : '?';
        return `
            <div class="box mb-2" style="padding: 0.75rem;">
                <strong style="color: #3498db;">${escapeHtml(i.name)}</strong><br>
                <small>${new Date(i.date).toLocaleDateString()} | ${escapeHtml(i.format)}</small><br>
                ${i.sobrietyDate ? `<small>Sobriety: ${sobrietyYears} years</small><br>` : ''}
                ${i.joinedGroup ? `<small>Joined Group: ${i.joinedGroup}</small><br>` : ''}
                <p style="margin-top: 0.5rem; font-size: 0.85rem;">${escapeHtml(i.summary).substring(0,100)}${i.summary.length > 100 ? '...' : ''}</p>
                <button class="btn secondary" onclick="deleteInterview('${i.id}')" style="margin-top: 0.5rem; padding: 0.3rem 0.6rem; font-size: 0.8rem;">Delete</button>
            </div>
        `;
    }).join('');
}
function deleteInterview(id) {
    if (!confirm('Delete this interview?')) return;
    let interviews = storage.getInterviews();
    interviews = interviews.filter(i => i.id !== id);
    storage.saveInterviews(interviews);
    updateInterviewsList();
    showToast('Interview deleted', 'success');
}

function addTranslator() {
    const member = document.getElementById('translator-member').value;
    const language = document.getElementById('translator-language').value;
    const proficiency = document.getElementById('translator-proficiency').value;
    const availability = document.getElementById('translator-availability').value.trim();
    if (!member || !language) return showToast('Select member and language', 'error');
    const translators = storage.getTranslators();
    translators.push({id: genId(), member, language, proficiency, availability, addedAt: new Date().toISOString()});
    storage.saveTranslators(translators);
    document.getElementById('translator-member').value = '';
    document.getElementById('translator-language').value = 'spanish';
    document.getElementById('translator-proficiency').value = 'native';
    document.getElementById('translator-availability').value = '';
    updateTranslatorsList();
    showToast('Translator added!', 'success');
}
function updateTranslatorsList() {
    const list = document.getElementById('translators-list');
    if (!list) return;
    const translators = storage.getTranslators();
    const members = storage.getMembers();
    if (translators.length === 0) {
        list.innerHTML = '<p style="opacity: 0.6; margin-top: 1rem;">No translators registered yet.</p>';
        return;
    }
    list.innerHTML = translators.map(t => {
        const member = members.find(m => m.id === t.member);
        return `
            <div class="box mb-2 mt-2" style="padding: 0.75rem;">
                <strong>${member ? escapeHtml(member.name) : 'Unknown'}</strong><br>
                <small>${escapeHtml(t.language)} - ${escapeHtml(t.proficiency)}</small><br>
                ${t.availability ? `<small>${escapeHtml(t.availability)}</small><br>` : ''}
                <button class="btn secondary" onclick="deleteTranslator('${t.id}')" style="margin-top: 0.5rem; padding: 0.3rem 0.6rem; font-size: 0.8rem;">Remove</button>
            </div>
        `;
    }).join('');
}
function deleteTranslator(id) {
    if (!confirm('Remove this translator?')) return;
    let translators = storage.getTranslators();
    translators = translators.filter(t => t.id !== id);
    storage.saveTranslators(translators);
    updateTranslatorsList();
    showToast('Translator removed', 'success');
}
function addMaterial() {
    const title = document.getElementById('material-title').value.trim();
    const language = document.getElementById('material-language').value;
    const type = document.getElementById('material-type').value;
    const content = document.getElementById('material-content').value.trim();
    const translator = document.getElementById('material-translator').value;
    if (!title || !content) return showToast('Fill in title and content', 'error');
    const materials = storage.getLanguageMaterials();
    materials.push({id: genId(), title, language, type, content, translator, createdAt: new Date().toISOString()});
    storage.saveLanguageMaterials(materials);
    document.getElementById('material-title').value = '';
    document.getElementById('material-language').value = 'spanish';
    document.getElementById('material-type').value = 'format';
    document.getElementById('material-content').value = '';
    document.getElementById('material-translator').value = '';
    updateMaterialsByLanguage();
    showToast('Material saved!', 'success');
}
function updateMaterialsByLanguage() {
    const div = document.getElementById('materials-by-language');
    if (!div) return;
    const materials = storage.getLanguageMaterials();
    const translators = storage.getTranslators();
    const members = storage.getMembers();
    if (materials.length === 0) {
        div.innerHTML = '<p style="opacity: 0.6;">No translated materials yet.</p>';
        return;
    }
    const byLanguage = {};
    materials.forEach(m => {
        if (!byLanguage[m.language]) byLanguage[m.language] = [];
        byLanguage[m.language].push(m);
    });
    div.innerHTML = Object.entries(byLanguage).map(([lang, mats]) => `
        <div class="box mb-3" style="padding: 0.75rem;">
            <h4 style="text-transform: capitalize; color: #3498db;">${escapeHtml(lang)} (${mats.length})</h4>
            ${mats.map(m => {
                const translator = translators.find(t => t.id === m.translator);
                const member = translator ? members.find(mem => mem.id === translator.member) : null;
                return `
                    <div style="padding: 0.5rem; margin-top: 0.5rem; border-left: 2px solid #7f8c8d;">
                        <strong>${escapeHtml(m.title)}</strong> (${escapeHtml(m.type)})<br>
                        ${member ? `<small>Translated by: ${escapeHtml(member.name)}</small><br>` : ''}
                        <button class="btn secondary" onclick="deleteMaterial('${m.id}')" style="margin-top: 0.3rem; padding: 0.2rem 0.5rem; font-size: 0.75rem;">Delete</button>
                    </div>
                `;
            }).join('')}
        </div>
    `).join('');
}
function deleteMaterial(id) {
    if (!confirm('Delete this material?')) return;
    let materials = storage.getLanguageMaterials();
    materials = materials.filter(m => m.id !== id);
    storage.saveLanguageMaterials(materials);
    updateMaterialsByLanguage();
    showToast('Material deleted', 'success');
}
function addInterpreter() {
    const name = document.getElementById('interpreter-name').value.trim();
    const certification = document.getElementById('interpreter-certification').value;
    const contact = document.getElementById('interpreter-contact').value.trim();
    const rate = document.getElementById('interpreter-rate').value.trim();
    if (!name || !contact) return showToast('Fill in name and contact', 'error');
    const interpreters = storage.getInterpreters();
    interpreters.push({id: genId(), name, certification, contact, rate, addedAt: new Date().toISOString()});
    storage.saveInterpreters(interpreters);
    document.getElementById('interpreter-name').value = '';
    document.getElementById('interpreter-certification').value = 'rid-ci';
    document.getElementById('interpreter-contact').value = '';
    document.getElementById('interpreter-rate').value = '';
    updateInterpretersList();
    updateInterpreterScheduleDropdown();
    showToast('Interpreter added!', 'success');
}
function updateInterpretersList() {
    const list = document.getElementById('interpreters-list');
    if (!list) return;
    const interpreters = storage.getInterpreters();
    if (interpreters.length === 0) {
        list.innerHTML = '<p style="opacity: 0.6; margin-top: 1rem;">No interpreters registered yet.</p>';
        return;
    }
    list.innerHTML = interpreters.map(i => `
        <div class="box mb-2 mt-2" style="padding: 0.75rem;">
            <strong>${escapeHtml(i.name)}</strong><br>
            <small>${escapeHtml(i.certification)} | ${escapeHtml(i.contact)}</small><br>
            ${i.rate ? `<small>Rate: ${escapeHtml(i.rate)}</small><br>` : ''}
            <button class="btn secondary" onclick="deleteInterpreter('${i.id}')" style="margin-top: 0.5rem; padding: 0.3rem 0.6rem; font-size: 0.8rem;">Remove</button>
        </div>
    `).join('');
}
function deleteInterpreter(id) {
    if (!confirm('Remove this interpreter?')) return;
    let interpreters = storage.getInterpreters();
    interpreters = interpreters.filter(i => i.id !== id);
    storage.saveInterpreters(interpreters);
    updateInterpretersList();
    updateInterpreterScheduleDropdown();
    showToast('Interpreter removed', 'success');
}
function updateInterpreterScheduleDropdown() {
    const select = document.getElementById('interp-schedule-interpreter');
    if (!select) return;
    const interpreters = storage.getInterpreters();
    select.innerHTML = '<option value="">-- Select Interpreter --</option>' + interpreters.map(i =>
        `<option value="${i.id}">${escapeHtml(i.name)}</option>`
    ).join('');
}
function scheduleInterpreter() {
    const meeting = document.getElementById('interp-schedule-meeting').value.trim();
    const date = document.getElementById('interp-schedule-date').value;
    const time = document.getElementById('interp-schedule-time').value;
    const interpreter = document.getElementById('interp-schedule-interpreter').value;
    const confirmed = document.getElementById('interp-schedule-confirmed').value;
    if (!meeting || !date || !interpreter) return showToast('Fill in required fields', 'error');
    const schedule = storage.getInterpreterSchedule();
    schedule.push({id: genId(), meeting, date, time, interpreter, confirmed, scheduledAt: new Date().toISOString()});
    storage.saveInterpreterSchedule(schedule);
    document.getElementById('interp-schedule-meeting').value = '';
    document.getElementById('interp-schedule-date').value = '';
    document.getElementById('interp-schedule-time').value = '';
    document.getElementById('interp-schedule-interpreter').value = '';
    document.getElementById('interp-schedule-confirmed').value = 'pending';
    updateInterpreterScheduleList();
    showToast('Interpreter scheduled!', 'success');
}
function updateInterpreterScheduleList() {
    const list = document.getElementById('interpreter-schedule');
    if (!list) return;
    const schedule = storage.getInterpreterSchedule().sort((a,b) => new Date(a.date) - new Date(b.date));
    const interpreters = storage.getInterpreters();
    if (schedule.length === 0) {
        list.innerHTML = '<p style="opacity: 0.6; margin-top: 1rem;">No interpreters scheduled yet.</p>';
        return;
    }
    list.innerHTML = schedule.map(s => {
        const interpreter = interpreters.find(i => i.id === s.interpreter);
        const statusColor = {pending: '#f39c12', confirmed: '#2ecc71', cancelled: '#e74c3c'}[s.confirmed] || '#95a5a6';
        return `
            <div class="box mb-2 mt-2" style="padding: 0.75rem; border-left: 4px solid ${statusColor};">
                <strong>${escapeHtml(s.meeting)}</strong><br>
                <small>${new Date(s.date).toLocaleDateString()}${s.time ? ` at ${s.time}` : ''}</small><br>
                <small>Interpreter: ${interpreter ? escapeHtml(interpreter.name) : 'Unknown'}</small><br>
                <span style="padding: 2px 6px; border-radius: 3px; font-size: 0.7rem; background: ${statusColor}; color: white;">${s.confirmed.toUpperCase()}</span>
                <button class="btn secondary" onclick="deleteScheduledInterpreter('${s.id}')" style="margin-top: 0.5rem; padding: 0.3rem 0.6rem; font-size: 0.8rem;">Delete</button>
            </div>
        `;
    }).join('');
}
function deleteScheduledInterpreter(id) {
    if (!confirm('Remove this scheduled interpreter?')) return;
    let schedule = storage.getInterpreterSchedule();
    schedule = schedule.filter(s => s.id !== id);
    storage.saveInterpreterSchedule(schedule);
    updateInterpreterScheduleList();
    showToast('Schedule deleted', 'success');
}
function saveCaptionSetup() {
    const platform = document.getElementById('caption-platform').value;
    const service = document.getElementById('caption-service').value;
    const enabled = document.getElementById('caption-enabled').value;
    const notes = document.getElementById('caption-notes').value.trim();
    const setup = {platform, service, enabled, notes, updatedAt: new Date().toISOString()};
    storage.saveCaptionSetup(setup);
    showToast('Caption setup saved!', 'success');
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', injectPWAManifest);
} else {
    injectPWAManifest();
}
    </script>
</body>
</html>