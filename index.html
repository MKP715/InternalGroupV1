<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rowlett Group Home</title>
    <!-- Link to the custom favicon logo -->
    <!-- Include Tailwind CSS for utility classes and Font Awesome for icons -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- DOMPurify for XSS Protection -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"></script>
    <!-- Link to the custom favicon logo -->
    <link rel="icon" type="image/svg+xml" href="logo.svg">
    <style>
        /* Basic reset and typography */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #2c3e50; /* Dark Slate Gray */
            color: #ecf0f1; /* Silver */
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-y: scroll; /* Persistent vertical scrollbar */
            overflow-x: hidden; /* Prevent horizontal scrollbar */
        }

        h1, h2, h3 {
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: #3498db; /* Metallic Blue */
        }

        /* Navigation bar */
        nav {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            background: #34495e; /* Wet Asphalt */
            color: #ecf0f1;
            padding: 0.5rem 1rem;
            border-bottom: 2px solid #3498db; /* Metallic Blue */
        }
        nav .logo {
            display: flex;
            align-items: center;
            font-size: 1.25rem;
        }
        nav .logo svg {
            width: 32px;
            height: 32px;
            margin-right: 0.5rem;
        }
        nav ul {
            list-style: none;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-right: 4rem;
        }
        nav li {
            cursor: pointer;
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            transition: background 0.2s;
            position: relative;
        }
        nav li:hover, nav li.active {
            background: #3498db; /* Metallic Blue */
            color: #ffffff;
        }

        /* Dropdown menu styles */
        nav li.has-dropdown {
            padding-right: 1.5rem;
        }
        nav li.has-dropdown::after {
            content: '\f107'; /* Font Awesome down arrow */
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.75rem;
            transition: transform 0.2s;
        }
        nav li.has-dropdown:hover::after {
            transform: translateY(-50%) rotate(180deg);
        }
        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            min-width: 200px;
            background: #2c3e50;
            border: 1px solid #3498db;
            border-radius: 4px;
            margin-top: 0.25rem;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        nav li:hover .dropdown-menu,
        nav li.dropdown-open .dropdown-menu {
            display: block;
        }
        .dropdown-menu li {
            padding: 0.5rem 1rem;
            border-radius: 0;
            border-bottom: 1px solid #34495e;
        }
        .dropdown-menu li:last-child {
            border-bottom: none;
        }
        .dropdown-menu li:hover {
            background: #34495e;
        }
        .dropdown-menu li.active {
            background: #2980b9;
        }
        /* Right-align the last dropdown (settings) */
        nav ul li.has-dropdown:last-child .dropdown-menu {
            left: auto;
            right: 0;
        }

        /* Main content area */
        main {
            flex: 1;
            padding: 1rem;
            width: 100%;
            max-width: none;
            margin: 0;
            overflow-y: auto;
        }
        section {
            display: none;
        }
        section.active {
            display: block;
        }

        /* Home overview boxes */
        .grid {
            display: grid;
            gap: 1rem;
        }
        .grid-cols-2 {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }
        .box {
            background: #34495e; /* Wet Asphalt */
            border: 1px solid #7f8c8d; /* Silver-Gray */
            border-radius: 6px;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            color: #ecf0f1; /* Silver */
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }
        th, td {
            padding: 0.5rem;
            border-bottom: 1px solid #7f8c8d; /* Silver-Gray */
            text-align: left;
        }
        th {
            background: #2c3e50; /* Dark Slate Gray */
            color: #3498db; /* Metallic Blue */
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 4px;
            background: #3498db; /* Metallic Blue */
            color: #fff;
            border: 1px solid #2980b9; /* Darker Blue */
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }
        .btn:hover {
            background: #2980b9;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .btn.secondary {
            background: #7f8c8d; /* Silver-Gray */
            border-color: #95a5a6;
        }
        .btn.secondary:hover {
            background: #95a5a6;
        }

        /* Form styling */
        .form-group {
            margin-bottom: 0.75rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.25rem;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #7f8c8d; /* Silver-Gray */
            border-radius: 4px;
            background: #34495e; /* Wet Asphalt */
            color: #ecf0f1; /* Silver */
        }

        /* Specific style for the roster search input to ensure visibility */
        #roster-search {
            padding: 0.5rem;
            border: 1px solid #7f8c8d; /* Silver-Gray */
            border-radius: 4px;
            background: #34495e; /* Wet Asphalt */
            color: #ecf0f1; /* Silver */
        }

        /* Gallery */
        #gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
        }
        #gallery-grid img {
            width: 100%;
            height: auto;
            border-radius: 6px;
            object-fit: cover;
            cursor: pointer;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            max-width: 80%;
            max-height: 80%;
        }
        .modal-close {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #fff;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 101;
        }

        /* Next & previous buttons */
        .prev, .next {
            cursor: pointer;
            position: absolute;
            top: 50%;
            width: auto;
            padding: 16px;
            margin-top: -22px;
            color: white;
            font-weight: bold;
            font-size: 20px;
            transition: 0.6s ease;
            border-radius: 0 3px 3px 0;
            user-select: none;
            -webkit-user-select: none;
        }
        .next {
            right: 0;
            border-radius: 3px 0 0 3px;
        }
        .prev {
            left: 0;
        }
        .prev:hover, .next:hover {
            background-color: rgba(0,0,0,0.8);
        }

        /* History section */
        .history-nav {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .history-nav button {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #7f8c8d;
            border-radius: 4px;
            background: #34495e; /* Wet Asphalt */
            color: #ecf0f1; /* Silver */
            cursor: pointer;
            transition: background 0.2s;
        }
        .history-nav button.active {
            background: #3498db; /* Metallic Blue */
            border-color: #2980b9;
        }
        /* Timeline styles adapted from the original history pages.  */
        .timeline-container {
            position: relative;
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        .timeline-container::after {
            content: '';
            position: absolute;
            width: 6px;
            background-color: #7f8c8d; /* Silver-Gray */
            top: 0;
            bottom: 0;
            left: 50%;
            margin-left: -3px;
            border-radius: 3px;
        }
        .timeline-block {
            padding: 10px 40px;
            position: relative;
            background-color: inherit;
            width: 50%;
        }
        .timeline-block.left {
            left: 0;
        }
        .timeline-block.right {
            left: 50%;
        }
        .timeline-block::after {
            content: '';
            position: absolute;
            width: 25px;
            height: 25px;
            right: -14px;
            background-color: #34495e; /* Wet Asphalt */
            border: 4px solid #3498db; /* Metallic Blue */
            top: 25px;
            border-radius: 50%;
            z-index: 1;
            transition: all 0.3s ease;
        }
        .timeline-block.right::after {
            left: -12px;
            right: auto;
        }
        .timeline-content {
            padding: 20px 30px;
            background-color: #2c3e50; /* Dark Slate Gray */
            color: #ecf0f1; /* Silver */
            position: relative;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .timeline-content:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .timeline-block:hover::after {
            transform: scale(1.2);
            border-color: #FBBF24; /* amber-400 */
        }
        /* Info popups are hidden by default. They will appear on hover via timeline-content:hover .info-popup. */
        .info-popup {
            position: absolute;
            bottom: calc(100% + 15px);
            left: 50%;
            transform: translateX(-50%) scale(0.95);
            width: 90%;
            min-width: 250px;
            background-color: #34495e; /* Wet Asphalt */
            color: #ecf0f1; /* Silver */
            padding: 15px;
            border-radius: 8px;
            z-index: 10;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .timeline-content:hover .info-popup {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) scale(1);
        }
        /* History content sections */
        .history-content {
            display: none;
        }
        .history-content.active {
            display: block;
        }
        /* Calendar styles */
        #calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            border: 1px solid #7f8c8d; /* Silver-Gray */
            border-radius: 6px;
            overflow: hidden;
        }
        .calendar-day {
            border-right: 1px solid #7f8c8d;
            border-bottom: 1px solid #7f8c8d;
            min-height: 110px;
            padding: 4px;
            font-size: 0.8rem;
            position: relative;
        }
        .calendar-day:nth-child(7n) {
            border-right: none;
        }
        .calendar-day-name {
            font-weight: bold;
            background-color: #2c3e50; /* Dark Slate Gray */
            color: #3498db; /* Metallic Blue */
            text-align: center;
            padding: 4px 0;
            border-bottom: 1px solid #7f8c8d;
        }
        .calendar-day-number {
            font-weight: bold;
            margin-bottom: 4px;
        }
        .calendar-event {
            background-color: #3498db; /* Metallic Blue */
            color: white;
            border-radius: 3px;
            border-left: 5px solid #2980b9; /* Default category color */
            padding: 2px 4px;
            font-size: 0.7rem;
            margin-bottom: 2px;
            display: block;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            position: relative; /* For tooltip positioning */
            cursor: help;
        }
        /* Tooltip styles */
        .calendar-event .tooltip {
            visibility: hidden;
            width: 220px;
            background-color: #34495e;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 10;
            bottom: 110%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
            white-space: normal;
            font-size: 0.8rem;
            line-height: 1.4;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .calendar-event:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
        .calendar-event .tooltip strong {
            color: #3498db; /* Metallic Blue */
        }
        /* Toast Notification styles */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
        }
        .toast {
            background-color: #34495e; /* Wet Asphalt */
            color: #ecf0f1; /* Silver */
            padding: 15px 20px;
            border-radius: 6px;
            border-left: 5px solid #3498db; /* Default: info */
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.4s ease;
        }
        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        .toast.success { border-left-color: #2ecc71; /* Green */ }
        .toast.error { border-left-color: #e74c3c; /* Red */ }

        /* Back to Top Button */
        #back-to-top-btn {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 30px;
            z-index: 99;
            font-size: 18px;
            border: none;
            outline: none;
            background-color: #3498db;
            color: white;
            cursor: pointer;
            padding: 15px;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            line-height: 18px;
            text-align: center;
        }
        #back-to-top-btn:hover {
            background-color: #2980b9;
        }

        /* Finance tab styles */
        .finance-tab {
            display: none;
        }
        .finance-tab.active {
            display: block;
        }

        /* Announcement priority badges */
        .announcement-item {
            position: relative;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            background: #34495e;
            border-left: 5px solid #7f8c8d;
        }
        .announcement-item.urgent {
            border-left-color: #e74c3c;
            background: #3d2d2d;
        }
        .announcement-item.normal {
            border-left-color: #3498db;
        }
        .announcement-item.info {
            border-left-color: #95a5a6;
        }
        .priority-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 8px;
        }
        .priority-badge.urgent {
            background: #e74c3c;
            color: white;
        }
        .priority-badge.normal {
            background: #3498db;
            color: white;
        }
        .priority-badge.info {
            background: #95a5a6;
            color: white;
        }
        .read-receipt-indicator {
            font-size: 0.75rem;
            color: #95a5a6;
            margin-top: 5px;
        }
        .mark-as-read-btn {
            font-size: 0.75rem;
            padding: 4px 8px;
            margin-top: 5px;
        }

        /* Vote Progress Bars */
        .vote-progress-container {
            margin: 1rem 0;
        }
        .vote-progress-item {
            margin-bottom: 0.75rem;
        }
        .vote-progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }
        .vote-progress-bar-bg {
            background: #2c3e50;
            border-radius: 10px;
            overflow: hidden;
            height: 24px;
            border: 1px solid #7f8c8d;
            position: relative;
        }
        .vote-progress-bar-fill {
            height: 100%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        .vote-progress-bar-fill.for {
            background: linear-gradient(90deg, #27ae60, #2ecc71);
        }
        .vote-progress-bar-fill.against {
            background: linear-gradient(90deg, #c0392b, #e74c3c);
        }
        .vote-progress-bar-fill.abstain {
            background: linear-gradient(90deg, #d68910, #f39c12);
        }

        /* GC Trends Dashboard */
        .trends-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        .trend-chart-container {
            background: #34495e;
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid #7f8c8d;
        }
        .trend-chart-container h4 {
            color: #3498db;
            margin-bottom: 0.5rem;
        }

        /* Amendment Tracking */
        .amendment-timeline {
            border-left: 3px solid #3498db;
            padding-left: 1rem;
            margin: 1rem 0;
        }
        .amendment-item {
            position: relative;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: #34495e;
            border-radius: 6px;
        }
        .amendment-item::before {
            content: '';
            position: absolute;
            left: -1.5rem;
            top: 1rem;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #3498db;
            border: 2px solid #2c3e50;
        }
        .amendment-item.adopted::before {
            background: #2ecc71;
        }
        .amendment-item.rejected::before {
            background: #e74c3c;
        }

        /* Notification Badge */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
        }

        /* Notification Banner Animations */
        @keyframes slideDown {
            from {
                transform: translateX(-50%) translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }
        @keyframes slideUp {
            from {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
            to {
                transform: translateX(-50%) translateY(-100%);
                opacity: 0;
            }
        }

        /* Message styles */
        .message-item {
            background: #34495e;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            border-left: 4px solid #3498db;
        }
        .message-item.unread {
            background: #2d3e4e;
            border-left-color: #e74c3c;
        }
        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .message-subject {
            font-weight: bold;
            color: #3498db;
        }
        .message-date {
            font-size: 0.85rem;
            color: #95a5a6;
        }

        /* Template card styles */
        .template-card {
            background: #34495e;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            border-left: 4px solid #3498db;
        }
        .template-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .template-type-badge {
            font-size: 0.75rem;
            padding: 3px 8px;
            border-radius: 3px;
            background: #2980b9;
            color: white;
        }

        /* Service position card */
        .position-card {
            background: #34495e;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        .term-warning {
            color: #f39c12;
            font-weight: bold;
        }
        .term-expired {
            color: #e74c3c;
            font-weight: bold;
        }

        /* Nomination card */
        .nomination-card {
            background: #2c3e50;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 4px;
            border-left: 3px solid #3498db;
        }

        /* Chart container */
        #yoy-chart {
            min-height: 300px;
        }

        /* Utility classes */
        .mt-4 { margin-top: 1rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }

        /* ========================================
           PRINT STYLESHEETS
           ======================================== */
        @media print {
            /* Hide navigation and UI elements */
            nav, #toast-container, #back-to-top-btn, .btn, button {
                display: none !important;
            }

            /* Reset colors for printing */
            body {
                background: white;
                color: black;
            }

            .box, section {
                background: white !important;
                border: 1px solid #000;
                page-break-inside: avoid;
            }

            /* Optimize tables for printing */
            table {
                border-collapse: collapse;
                width: 100%;
                page-break-inside: avoid;
            }

            th, td {
                border: 1px solid #000;
                padding: 0.5rem;
                color: black !important;
                background: white !important;
            }

            th {
                background: #e0e0e0 !important;
                font-weight: bold;
            }

            /* Page breaks */
            h1, h2, h3 {
                page-break-after: avoid;
                color: black !important;
            }

            /* Show URLs for links */
            a[href]:after {
                content: " (" attr(href) ")";
            }

            /* Optimize charts for printing */
            canvas {
                max-width: 100%;
                page-break-inside: avoid;
            }

            /* Print-specific header */
            @page {
                margin: 2cm;
            }

            body::before {
                content: "Rowlett Group - Printed: " attr(data-print-date);
                display: block;
                text-align: center;
                font-size: 0.8rem;
                padding-bottom: 1rem;
                border-bottom: 1px solid #000;
                margin-bottom: 1rem;
            }
        }
    </style>
</head>
<body>
    <div id="toast-container"></div>
    <button id="back-to-top-btn" title="Go to top"><i class="fas fa-arrow-up"></i></button>
    <nav>
        <div class="logo">
            <!-- Inline SVG to display the logo in the nav -->
            <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <circle cx="50" cy="50" r="48" fill="#3498db"/>
                <text x="50" y="57" text-anchor="middle" font-size="45" fill="white" font-family="Verdana, sans-serif">R</text>
            </svg>
            <span>Rowlett Group</span>
        </div>
        <ul id="nav-menu">
            <li data-section="home-section" class="active">Home</li>

            <li class="has-dropdown">
                Meetings
                <ul class="dropdown-menu">
                    <li data-section="schedule-section">Schedule & Calendar</li>
                    <li data-section="format-rotation-section">Format Rotation</li>
                    <li data-section="companion-section">Meeting Companion</li>
                    <li data-section="commitment-board-section">Commitment Board</li>
                    <li data-section="secretary-section">Secretary Functions</li>
                </ul>
            </li>

            <li class="has-dropdown">
                Fellowship
                <ul class="dropdown-menu">
                    <li data-section="birthdays-section">Birthdays & Anniversaries</li>
                    <li data-section="announcements-section">Announcements</li>
                    <li data-section="messaging-section">Messages</li>
                    <li data-section="gallery-section">Photo Gallery</li>
                </ul>
            </li>

            <li class="has-dropdown">
                Group Conscience
                <ul class="dropdown-menu">
                    <li data-section="gc-live-section">Live GC Session</li>
                    <li data-section="gc-decisions-section">Decision History</li>
                    <li data-section="gc-inventory-section">GC Inventory</li>
                    <li data-section="gc-bylaws-section">Guidelines & By-Laws</li>
                </ul>
            </li>

            <li class="has-dropdown">
                Service
                <ul class="dropdown-menu">
                    <li data-section="service-positions-section">Service Positions</li>
                    <li data-section="sponsorship-section">Sponsorship Tracking</li>
                    <li data-section="district-area-section">District/Area Committee</li>
                </ul>
            </li>

            <li class="has-dropdown">
                Treasury
                <ul class="dropdown-menu">
                    <li data-section="finance-section">Financial Reports</li>
                    <li data-section="seventh-tradition-section">7th Tradition Analysis</li>
                    <li data-section="prudent-reserve-section">Prudent Reserve</li>
                    <li data-section="chip-inventory-section">Chip Inventory</li>
                </ul>
            </li>

            <li class="has-dropdown">
                Reports
                <ul class="dropdown-menu">
                    <li data-section="chairperson-section">Chairperson Reports</li>
                    <li data-section="analytics-section">Group Analytics</li>
                </ul>
            </li>

            <li class="has-dropdown">
                Resources
                <ul class="dropdown-menu">
                    <li data-section="library-section">AA Literature Library</li>
                    <li data-section="history-section">Group History</li>
                    <li data-section="templates-section">Document Templates</li>
                </ul>
            </li>

            <li class="has-dropdown">
                <i class="fas fa-cog"></i>
                <ul class="dropdown-menu">
                    <li data-section="settings-section">General Settings</li>
                    <li data-section="accessibility-section">Accessibility</li>
                </ul>
            </li>
        </ul>
    </nav>

    <main>
        <!-- Home Section -->
        <section id="home-section" class="active">
            <h1>Welcome to the Rowlett Group</h1>
            <p class="mb-4">This internal site serves as your one-stop hub for meeting schedules, member birthdays, group announcements, and more. All data you add here is stored locally in your browser.</p>
            <div class="grid grid-cols-2">
                <div class="box">
                    <h3>Upcoming Meetings</h3>
                    <a id="zoom-meeting-btn" href="#" class="btn" style="display: none; text-align: center; margin-bottom: 1rem;">
                        <i class="fas fa-video"></i> Start Zoom Meeting
                    </a>
                    <p id="zoom-meeting-note" style="font-size: 0.8rem; text-align: center; margin-bottom: 1rem; display: none;">(Requires Zoom to be installed)</p>
                    <ul id="home-upcoming-events" style="margin-bottom: 1rem; min-height: 60px;"></ul>
                    <button class="btn" onclick="goToSection('schedule-section')">View Full Schedule</button>
                </div>
                <div class="box">
                    <h3>Upcoming Birthdays</h3>
                    <ul id="home-upcoming-birthdays" style="margin-bottom: 1rem; min-height: 60px;"></ul>
                    <button class="btn" onclick="goToSection('birthdays-section')">Manage Birthdays</button>
                </div>
                <div class="box">
                    <h3>Recent Announcements</h3>
                    <ul id="home-recent-announcements" style="margin-bottom: 1rem; min-height: 60px;"></ul>
                    <button class="btn" onclick="goToSection('announcements-section')">View All Announcements</button>
                </div>
                <div class="box">
                    <h3>Latest Photos</h3>
                    <div id="home-latest-photos" style="display:flex; gap:0.5rem; overflow-x: auto; margin-bottom: 1rem; min-height: 60px;"></div>
                    <button class="btn" onclick="goToSection('gallery-section')">Browse Gallery</button>
                </div>
                <div id="qr-code-box" class="box" style="text-align: center; display: none;">
                    <h3>7th Tradition</h3>
                    <img id="qr-code-img" src="" alt="7th Tradition QR Code" style="width: 250px; height: 250px; margin: auto; border-radius: 8px;">
                    <p id="qr-code-contact" class="mt-2"></p>
                </div>
            </div>
        </section>

        <!-- Chairperson's Corner Section -->
        <section id="chairperson-section">
            <h2>Chairperson's Corner</h2>
            <p class="mb-4">Track meeting attendance and contributions. All data is stored locally.</p>
            <div class="box mb-4">
                <h3 class="text-lg font-bold">Member Management</h3>
                <button class="btn" onclick="openRosterModal()">View Full Member Roster</button>
            </div>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <!-- Left column for form and table -->
                <div>
                    <div class="box">
                        <h3 id="chairperson-form-title">Log New Entry</h3>
                        <div class="form-group">
                            <label for="log-date">Meeting Date</label>
                            <input type="date" id="log-date">
                        </div>
                        <div class="form-group">
                            <label for="log-time">Meeting Time</label>
                            <input type="time" id="log-time">
                        </div>
                        <div class="form-group">
                            <label for="log-chairperson">Chairperson's Name</label>
                            <select id="log-chairperson"></select>
                        </div>
                        <div class="form-group">
                            <label for="log-headcount">Head Count</label>
                            <input type="number" id="log-headcount" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label for="log-7th-tradition">7th Tradition ($)</label>
                            <input type="number" id="log-7th-tradition" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label for="log-orange-can">Orange Can ($)</label>
                            <input type="number" id="log-orange-can" step="0.01" placeholder="0.00">
                        </div>
                        <input type="hidden" id="log-edit-id">
                        <button id="log-form-btn" class="btn" onclick="handleChairpersonLogSubmit()">Add Log Entry</button>
                        <button id="log-form-cancel-btn" class="btn secondary" onclick="cancelLogEdit()" style="display:none; margin-left: 0.5rem;">Cancel</button>
                    </div>

                    <h3 class="mt-4">Contribution Log</h3>
                    <button class="btn" onclick="exportChairpersonLogToPDF()" style="margin-bottom: 1rem;">Export Log to PDF</button>
                    <table id="chairperson-log-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Chairperson</th>
                                <th>Head Count</th>
                                <th>7th Tradition</th>
                                <th>Orange Can</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="chairperson-log-body"></tbody>
                    </table>
                </div>

                <!-- Right column for Group Conscience Log -->
                <div>
                    <div class="box mb-4">
                        <h3>Active Announcements</h3>
                        <ul id="chairperson-announcements-list"></ul>
                    </div>

                    <!-- Live Group Conscience Module -->
                    <div class="box mb-4">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h3>Live Group Conscience</h3>
                            <button class="btn secondary" onclick="toggleLiveGC()">Show/Hide</button>
                        </div>
                        <div id="live-gc-module" style="display: none;">
                            <h4 class="mt-4">New Business / Open Motions</h4>
                            <div class="form-group">
                                <label for="new-business-item">New Item</label>
                                <textarea id="new-business-item" rows="2" placeholder="Describe the new business item or motion..."></textarea>
                            </div>
                            <button class="btn" onclick="addNewBusinessItem()">Add New Item</button>

                            <h4 class="mt-4">Motions Queue</h4>
                            <table id="live-gc-table">
                                <thead>
                                    <tr>
                                        <th>Item</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="live-gc-body"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="box">
                        <h3 id="gc-form-title">Log Group Conscience Item</h3>
                        <div class="form-group">
                            <label for="gc-date">Date</label>
                            <input type="date" id="gc-date">
                        </div>
                        <div class="form-group">
                            <label for="gc-item">Item/Motion</label>
                            <textarea id="gc-item" rows="2" placeholder="Describe the motion..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="gc-submitted-by">Submitted By</label>
                            <input type="text" id="gc-submitted-by" placeholder="Name">
                        </div>
                        <div class="form-group">
                            <label for="gc-status">Status</label>
                            <select id="gc-status">
                                <option value="passed">Passed</option>
                                <option value="failed">Failed</option>
                                <option value="tabled">Tabled</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="gc-votes-for">Votes For</label>
                            <input type="number" id="gc-votes-for" min="0" placeholder="0" oninput="updateVotePercentages()">
                        </div>
                        <div class="form-group">
                            <label for="gc-votes-against">Votes Against</label>
                            <input type="number" id="gc-votes-against" min="0" placeholder="0" oninput="updateVotePercentages()">
                        </div>
                        <div class="form-group">
                            <label for="gc-votes-abstain">Votes Abstain</label>
                            <input type="number" id="gc-votes-abstain" min="0" placeholder="0" oninput="updateVotePercentages()">
                        </div>
                        <div id="vote-summary" style="padding: 0.75rem; background: #2c3e50; border-radius: 4px; margin-bottom: 0.75rem; font-size: 0.85rem;">
                            <div style="margin-bottom: 0.5rem;"><strong>Total Votes:</strong> <span id="total-votes">0</span></div>

                            <!-- Vote Progress Bars -->
                            <div class="vote-progress-container">
                                <div class="vote-progress-item">
                                    <div class="vote-progress-label">
                                        <span><strong>For:</strong> <span id="votes-for-count">0</span></span>
                                        <span id="percent-for">0%</span>
                                    </div>
                                    <div class="vote-progress-bar-bg">
                                        <div id="progress-bar-for" class="vote-progress-bar-fill for" style="width: 0%;"></div>
                                    </div>
                                </div>

                                <div class="vote-progress-item">
                                    <div class="vote-progress-label">
                                        <span><strong>Against:</strong> <span id="votes-against-count">0</span></span>
                                        <span id="percent-against">0%</span>
                                    </div>
                                    <div class="vote-progress-bar-bg">
                                        <div id="progress-bar-against" class="vote-progress-bar-fill against" style="width: 0%;"></div>
                                    </div>
                                </div>

                                <div class="vote-progress-item">
                                    <div class="vote-progress-label">
                                        <span><strong>Abstain:</strong> <span id="votes-abstain-count">0</span></span>
                                        <span id="percent-abstain">0%</span>
                                    </div>
                                    <div class="vote-progress-bar-bg">
                                        <div id="progress-bar-abstain" class="vote-progress-bar-fill abstain" style="width: 0%;"></div>
                                    </div>
                                </div>
                            </div>

                            <div id="quorum-status" style="margin-top: 0.5rem;"></div>
                        </div>
                        <div class="form-group">
                            <label for="gc-attendees">Members Present</label>
                            <select multiple id="gc-attendees" style="height: 120px; background: #34495e; color: #ecf0f1; border: 1px solid #7f8c8d; border-radius: 4px; padding: 0.5rem; width: 100%;" onchange="updateVotePercentages()"></select>
                            <small style="font-size: 0.75rem; opacity: 0.8;">Hold Ctrl/Cmd to select multiple members</small>
                        </div>
                        <div class="form-group">
                            <label>Servant Reports</label>
                            <div id="gc-servant-reports-container">
                                <!-- Servant report inputs will be dynamically generated here -->
                            </div>
                            <div id="gc-servant-reports-legacy-container" style="display: none;">
                                <label for="gc-servant-reports-legacy">Legacy Reports (read-only)</label>
                                <textarea id="gc-servant-reports-legacy" rows="4" readonly></textarea>
                            </div>
                        </div>
                        <input type="hidden" id="gc-edit-id">
                        <button id="gc-form-btn" class="btn" onclick="handleGCLogSubmit()">Add GC Entry</button>
                        <button id="gc-form-cancel-btn" class="btn secondary" onclick="cancelGCEdit()" style="display:none; margin-left: 0.5rem;">Cancel</button>
                    </div>

                    <h3 class="mt-4">Current Month's Group Conscience</h3>
                    <table id="gc-log-table-current">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Item</th>
                                <th>Submitted By</th>
                                <th>Status</th>
                                <th>Votes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="gc-log-body-current"></tbody>
                    </table>

                    <h3 class="mt-4">Previous Months' Group Conscience</h3>
                    <table id="gc-log-table-previous">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Item</th>
                                <th>Submitted By</th>
                                <th>Status</th>
                                <th>Votes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="gc-log-body-previous"></tbody>
                    </table>
                    <button class="btn mt-2" onclick="exportGroupConscienceLogToPDF()" style="margin-bottom: 1rem;">Export Full GC Log to PDF</button>

                    <!-- Pre-GC Submission System -->
                    <div class="box mt-4">
                        <h3>Pre-GC Agenda Submissions</h3>
                        <p class="mb-2 text-sm" style="font-size: 0.8rem; opacity: 0.8;">Members can submit agenda items before the meeting</p>
                        <div class="form-group">
                            <label for="proposed-item-title">Item Title</label>
                            <input type="text" id="proposed-item-title" placeholder="Brief title for the item">
                        </div>
                        <div class="form-group">
                            <label for="proposed-item-description">Description</label>
                            <textarea id="proposed-item-description" rows="3" placeholder="Detailed description of the proposal..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="proposed-item-submitter">Submitted By</label>
                            <input type="text" id="proposed-item-submitter" placeholder="Your name">
                        </div>
                        <button class="btn" onclick="addProposedAgendaItem()">Submit Agenda Item</button>

                        <h4 class="mt-4">Proposed Agenda Items</h4>
                        <table id="proposed-agenda-table">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Submitter</th>
                                    <th>Date Submitted</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="proposed-agenda-body"></tbody>
                        </table>
                    </div>

                    <!-- GC Settings (Quorum Configuration) -->
                    <div class="box mt-4">
                        <h3>Group Conscience Settings</h3>
                        <div class="form-group">
                            <label for="quorum-percentage">Quorum Percentage (%)</label>
                            <input type="number" id="quorum-percentage" min="1" max="100" placeholder="50">
                            <small style="font-size: 0.75rem; opacity: 0.8;">Percentage of total members required for quorum</small>
                        </div>
                        <div class="form-group">
                            <label for="quorum-minimum">Minimum Quorum Count</label>
                            <input type="number" id="quorum-minimum" min="1" placeholder="5">
                            <small style="font-size: 0.75rem; opacity: 0.8;">Minimum number of members required regardless of percentage</small>
                        </div>
                        <button class="btn" onclick="saveGCSettings()">Save Settings</button>
                    </div>

                    <!-- Action Items Tracking -->
                    <div class="box mt-4">
                        <h3>Action Items & Follow-Up</h3>
                        <p class="mb-2 text-sm" style="font-size: 0.8rem; opacity: 0.8;">Track action items from passed motions</p>
                        <div class="form-group">
                            <label for="action-item-description">Action Item</label>
                            <textarea id="action-item-description" rows="2" placeholder="What needs to be done?"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="action-item-assignee">Assigned To</label>
                            <select id="action-item-assignee"></select>
                        </div>
                        <div class="form-group">
                            <label for="action-item-due-date">Due Date</label>
                            <input type="date" id="action-item-due-date">
                        </div>
                        <div class="form-group">
                            <label for="action-item-related-gc">Related GC Motion (Optional)</label>
                            <select id="action-item-related-gc">
                                <option value="">None</option>
                            </select>
                        </div>
                        <input type="hidden" id="action-item-edit-id">
                        <button id="action-item-btn" class="btn" onclick="handleActionItemSubmit()">Add Action Item</button>
                        <button id="action-item-cancel-btn" class="btn secondary" onclick="cancelActionItemEdit()" style="display:none; margin-left: 0.5rem;">Cancel</button>

                        <h4 class="mt-4">Active Action Items</h4>
                        <table id="action-items-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Assigned To</th>
                                    <th>Due Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="action-items-body"></tbody>
                        </table>
                    </div>

                    <!-- Historical Analysis & Search -->
                    <div class="box mt-4">
                        <h3>Group Conscience History & Analysis</h3>
                        <div class="form-group">
                            <label for="gc-search">Search GC History</label>
                            <input type="text" id="gc-search" placeholder="Search by motion, submitter, or status..." oninput="searchGCHistory()">
                        </div>
                        <div class="form-group">
                            <label for="gc-filter-status">Filter by Status</label>
                            <select id="gc-filter-status" onchange="searchGCHistory()">
                                <option value="">All</option>
                                <option value="passed">Passed</option>
                                <option value="failed">Failed</option>
                                <option value="tabled">Tabled</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="gc-filter-date-from">From Date</label>
                            <input type="date" id="gc-filter-date-from" onchange="searchGCHistory()">
                        </div>
                        <div class="form-group">
                            <label for="gc-filter-date-to">To Date</label>
                            <input type="date" id="gc-filter-date-to" onchange="searchGCHistory()">
                        </div>

                        <h4 class="mt-4">Search Results</h4>
                        <table id="gc-history-search-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Motion</th>
                                    <th>Status</th>
                                    <th>Votes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="gc-history-search-body"></tbody>
                        </table>

                        <h4 class="mt-4">Quick Statistics</h4>
                        <div id="gc-stats" style="padding: 1rem; background: #2c3e50; border-radius: 6px; margin-bottom: 1rem;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                                <div>
                                    <strong style="color: #3498db;">Total Motions:</strong>
                                    <div id="stat-total-motions">0</div>
                                </div>
                                <div>
                                    <strong style="color: #2ecc71;">Passed:</strong>
                                    <div id="stat-passed-motions">0</div>
                                </div>
                                <div>
                                    <strong style="color: #e74c3c;">Failed:</strong>
                                    <div id="stat-failed-motions">0</div>
                                </div>
                                <div>
                                    <strong style="color: #f39c12;">Tabled:</strong>
                                    <div id="stat-tabled-motions">0</div>
                                </div>
                                <div>
                                    <strong style="color: #3498db;">Pass Rate:</strong>
                                    <div id="stat-pass-rate">0%</div>
                                </div>
                            </div>
                        </div>

                        <!-- GC Trends Dashboard -->
                        <h4 class="mt-4">Group Conscience Trends & Analysis</h4>
                        <div class="trends-grid">
                            <div class="trend-chart-container">
                                <h4>Monthly Motion Activity</h4>
                                <canvas id="gc-trends-monthly-chart" width="400" height="250"></canvas>
                            </div>
                            <div class="trend-chart-container">
                                <h4>Pass/Fail/Tabled Distribution</h4>
                                <canvas id="gc-trends-status-chart" width="400" height="250"></canvas>
                            </div>
                            <div class="trend-chart-container">
                                <h4>Voting Participation Trend</h4>
                                <canvas id="gc-trends-participation-chart" width="400" height="250"></canvas>
                            </div>
                            <div class="trend-chart-container">
                                <h4>Top Motion Topics (Keywords)</h4>
                                <div id="gc-top-topics" style="padding: 1rem; max-height: 250px; overflow-y: auto;">
                                    <!-- Top topics will be listed here -->
                                </div>
                            </div>
                        </div>

                        <!-- Annual Summary Report Generator -->
                        <h4 class="mt-4">Annual Summary Report</h4>
                        <div style="padding: 1rem; background: #2c3e50; border-radius: 6px;">
                            <div class="form-group">
                                <label for="annual-report-year">Select Year</label>
                                <select id="annual-report-year">
                                    <!-- Years will be populated dynamically -->
                                </select>
                            </div>
                            <button class="btn" onclick="generateAnnualReport()">
                                <i class="fas fa-file-pdf" style="margin-right: 0.5rem;"></i>Generate Annual PDF Report
                            </button>
                            <button class="btn secondary" onclick="refreshGCTrends()" style="margin-left: 0.5rem;">
                                <i class="fas fa-sync" style="margin-right: 0.5rem;"></i>Refresh Charts
                            </button>
                        </div>
                    </div>

                    <div class="box mt-4">
                        <h3>Record Meeting Audio</h3>
                        <p class="mb-2 text-sm" style="font-size: 0.8rem; opacity: 0.8;">Record audio from your microphone and save it as a local file.</p>
                        <div id="audio-recorder-controls" class="flex items-center gap-2" style="display:flex; gap: 0.5rem; align-items: center;">
                            <button id="record-btn" class="btn"><i class="fas fa-microphone" style="margin-right: 0.5rem;"></i>Start Recording</button>
                            <button id="stop-btn" class="btn secondary" disabled><i class="fas fa-stop" style="margin-right: 0.5rem;"></i>Stop</button>
                        </div>
                        <div id="audio-player-container" class="mt-4" style="display: none;">
                            <audio id="audio-player" controls style="width: 100%;"></audio>
                            <a id="download-link" class="btn mt-2" style="display: none;"><i class="fas fa-download" style="margin-right: 0.5rem;"></i>Download Recording</a>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Meeting Companion Section -->
        <section id="companion-section">
            <h2>Meeting Companion</h2>
            <p class="mb-4">Select a meeting type to view the format and readings.</p>
            <div id="meeting-format-buttons" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                <button class="btn" onclick="showMeetingFormat('open-discussion')">Open Discussion</button>
                <button class="btn" onclick="showMeetingFormat('closed-discussion')">Closed Discussion</button>
                <button class="btn" onclick="showMeetingFormat('big-book')">Big Book Study</button>
                <button class="btn" onclick="showMeetingFormat('12x12')">12x12 Study</button>
                <button class="btn" onclick="showMeetingFormat('personal-story')">Personal Story</button>
                <button class="btn" onclick="showMeetingFormat('foundations')">Foundations Speaker</button>
                <button class="btn" onclick="showMeetingFormat('birthday')">Birthday Night</button>
            </div>
            <h3 class="mt-4">Readings</h3>
            <div id="reading-buttons" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                <button class="btn" onclick="showMeetingFormat('how-it-works')">How It Works</button>
                <button class="btn" onclick="showMeetingFormat('traditions')">The 12 Traditions</button>
                <button class="btn" onclick="showMeetingFormat('promises')">The 9th Step Promises</button>
            </div>

            <h3 class="mt-4">Dictionary</h3>
            <div class="box mt-4">
                <div class="form-group" style="display: flex; gap: 0.5rem;">
                    <input type="text" id="dictionary-search-word" placeholder="Enter a word..." style="flex-grow: 1;">
                    <button id="dictionary-search-btn" class="btn">Search</button>
                </div>
                <div id="dictionary-results" class="mt-4"></div>
            </div>

            <div id="meeting-format-display" class="box mt-4" style="display: none;">
                <!-- Meeting format will be injected here -->
            </div>
        </section>

        <!-- Schedule Section -->
        <section id="schedule-section">
            <h2>Schedule of Meetings & Events</h2>
            <p class="mb-2">Add recurring weekly meetings or special one-time events. Use the calendar to browse by month. Upcoming events for the next 60 days are listed below.</p>

            <!-- Calendar Controls -->
            <div id="calendar-controls" style="display:flex; align-items:center; justify-content: space-between; gap:0.5rem; margin-bottom:0.5rem;">
                <button class="btn secondary" id="prev-month-btn">&lt; Prev</button>
                <h3 id="calendar-month-year" style="flex:1; text-align:center;"></h3>
                <button class="btn secondary" id="next-month-btn">Next &gt;</button>
            </div>
            <div id="calendar-grid"></div>

            <button class="btn" onclick="toggleEventForm()" style="margin-top: 1rem;">Add New Event</button>
            <div id="add-event-form" class="box" style="display:none; margin-top: 1rem;">
                <div class="form-group">
                    <label for="event-title">Title</label>
                    <input type="text" id="event-title" placeholder="e.g. Big Book Study" />
                </div>
                <div class="form-group">
                    <label for="event-date">Date (leave blank for weekly)</label>
                    <input type="date" id="event-date" />
                </div>
                <div class="form-group">
                    <label for="event-day">Day of Week (for weekly meetings)</label>
                    <select id="event-day">
                        <option value="">--Select day--</option>
                        <option value="0">Sunday</option>
                        <option value="1">Monday</option>
                        <option value="2">Tuesday</option>
                        <option value="3">Wednesday</option>
                        <option value="4">Thursday</option>
                        <option value="5">Friday</option>
                        <option value="6">Saturday</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="event-time">Time</label>
                    <input type="time" id="event-time" />
                </div>
                <div class="form-group">
                    <label for="event-category">Category</label>
                    <select id="event-category">
                        <option value="General">General</option>
                        <option value="Open Discussion">Open Discussion</option>
                        <option value="Closed Discussion">Closed Discussion</option>
                        <option value="Big Book Study">Big Book Study</option>
                        <option value="12x12 Study">12x12 Study</option>
                        <option value="Personal Story">Personal Story</option>
                        <option value="Foundations Speaker">Foundations Speaker</option>
                        <option value="Birthday Night">Birthday Night</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="event-reading">Reading</label>
                    <input type="text" id="event-reading" placeholder="e.g. How It Works" />
                </div>
                <div class="form-group">
                    <label for="event-speaker">Speaker</label>
                    <select id="event-speaker"></select>
                </div>
                <div class="form-group">
                    <label for="event-chair">Chairperson</label>
                    <select id="event-chair"></select>
                </div>
                <div class="form-group">
                    <label for="event-description">Description</label>
                    <textarea id="event-description" rows="2" placeholder="Notes or description..."></textarea>
                </div>
                <input type="hidden" id="event-edit-id">
                <button id="event-form-btn" class="btn" onclick="handleEventSubmit()">Add Event</button>
                <button id="event-form-cancel-btn" class="btn secondary" onclick="cancelEventEdit()" style="display:none; margin-left: 0.5rem;">Cancel</button>
            </div>

            <h3 class="mt-4">Upcoming Events (Next 30 Days)</h3>
            <div class="form-group">
                <label for="category-filter">Filter by Category</label>
                <select id="category-filter" onchange="updateEventsTable()">
                    <option value="All">All Categories</option>
                    <option value="General">General</option>
                    <option value="Open Discussion">Open Discussion</option>
                    <option value="Closed Discussion">Closed Discussion</option>
                    <option value="Big Book Study">Big Book Study</option>
                    <option value="12x12 Study">12x12 Study</option>
                    <option value="Personal Story">Personal Story</option>
                    <option value="Foundations Speaker">Foundations Speaker</option>
                    <option value="Birthday Night">Birthday Night</option>
                </select>
            </div>
            <table id="events-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Title</th>
                        <th>Category</th>
                        <th>Time</th>
                        <th>Speaker</th>
                        <th>Chair</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="events-body"></tbody>
            </table>
        </section>

        <!-- Members Section -->
        <section id="birthdays-section">
            <h2>Member Roster & Birthdays</h2>
            <p class="mb-2">Add and manage member information and see upcoming sobriety birthdays.</p>
            <button class="btn" onclick="toggleMemberForm()">Add Member</button>
            <div id="add-member-form" class="box" style="display:none; margin-top: 1rem;">
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <div class="form-group">
                            <label for="member-name">Name*</label>
                            <input type="text" id="member-name" placeholder="Member's name" />
                        </div>
                        <div class="form-group">
                            <label for="member-birthday">Sobriety Date*</label>
                            <input type="date" id="member-birthday" />
                        </div>
                        <div class="form-group">
                            <label for="member-phone">Phone Number</label>
                            <input type="tel" id="member-phone" placeholder="e.g., 123-456-7890" />
                        </div>
                        <div class="form-group">
                            <label for="member-email">Email</label>
                            <input type="email" id="member-email" placeholder="member@example.com" />
                        </div>
                    </div>
                    <div>
                        <div class="form-group">
                            <label for="member-city">City</label>
                            <input type="text" id="member-city" placeholder="e.g., Rowlett" />
                        </div>
                        <div class="form-group">
                            <label for="member-homegroup">Homegroup</label>
                            <input type="text" id="member-homegroup" placeholder="e.g., The Rowlett Group" />
                        </div>
                        <div class="form-group">
                            <label for="member-sponsor">Sponsor</label>
                            <input type="text" id="member-sponsor" placeholder="Sponsor's name" />
                        </div>
                    </div>
                </div>
                <div class="box" style="margin-top: 1rem; border-top: 1px solid #7f8c8d; padding-top: 1rem;">
                    <h4 class="font-bold">Service Position</h4>
                    <div class="form-group" style="display: flex; align-items: center; gap: 1rem;">
                        <input type="checkbox" id="member-is-servant" style="width: auto;"/>
                        <label for="member-is-servant">Is this member a current servant?</label>
                    </div>
                    <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="member-servant-position">Position</label>
                            <input type="text" id="member-servant-position" placeholder="e.g., Treasurer" />
                        </div>
                        <div class="form-group">
                            <label for="member-servant-since">Serving Since</label>
                            <input type="date" id="member-servant-since" />
                        </div>
                    </div>
                </div>
                <input type="hidden" id="member-edit-id">
                <button id="member-form-btn" class="btn" onclick="handleMemberSubmit()">Add Member</button>
                <button id="member-form-cancel-btn" class="btn secondary" onclick="cancelMemberEdit()" style="display:none; margin-left: 0.5rem;">Cancel</button>
            </div>
            
            <h3 class="mt-4">Upcoming & Recent Birthdays</h3>
            <table id="birthdays-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Sobriety Date</th>
                        <th>Next Birthday</th>
                        <th>Years</th>
                        <th>Sober Time</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="birthdays-body"></tbody>
            </table>
        </section>

        <!-- Announcements Section -->
        <section id="announcements-section">
            <h2>Announcements</h2>
            <div class="form-group">
                <label for="announcement-text">Announcement</label>
                <textarea id="announcement-text" rows="2" placeholder="Enter announcement..."></textarea>
            </div>
            <div class="form-group">
                <label for="announcement-priority">Priority Level</label>
                <select id="announcement-priority">
                    <option value="info">Info</option>
                    <option value="normal">Normal</option>
                    <option value="urgent">Urgent</option>
                </select>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="announcement-require-read-receipt" />
                    Require read receipt (for important announcements)
                </label>
            </div>
            <button class="btn" onclick="addAnnouncement()">Add Announcement</button>

            <h3 class="mt-4">Current Announcements</h3>
            <ul id="announcements-list"></ul>
        </section>

        <!-- Member Messaging Section -->
        <section id="messaging-section">
            <h2>Member Messaging</h2>
            <p>Send messages to other members for service work coordination.</p>

            <div class="form-group">
                <label for="message-recipient">Send to:</label>
                <select id="message-recipient">
                    <option value="">Select a member...</option>
                </select>
            </div>
            <div class="form-group">
                <label for="message-subject">Subject</label>
                <input type="text" id="message-subject" placeholder="Message subject..." />
            </div>
            <div class="form-group">
                <label for="message-text">Message</label>
                <textarea id="message-text" rows="4" placeholder="Your message..."></textarea>
            </div>
            <button class="btn" onclick="sendMessage()">Send Message</button>

            <h3 class="mt-4">Messages</h3>
            <div class="history-nav">
                <button onclick="showMessages('inbox')" class="active" id="inbox-btn">Inbox</button>
                <button onclick="showMessages('sent')" id="sent-btn">Sent</button>
            </div>
            <div id="messages-container"></div>
        </section>

        <!-- Service Positions Section -->
        <section id="service-positions-section">
            <h2>Service Position Management</h2>

            <h3>Add/Edit Service Position</h3>
            <div class="form-group">
                <label for="position-name">Position Name</label>
                <input type="text" id="position-name" placeholder="e.g., Chairperson, Secretary, Treasurer..." />
            </div>
            <div class="form-group">
                <label for="position-description">Description & Responsibilities</label>
                <textarea id="position-description" rows="4" placeholder="Enter position responsibilities..."></textarea>
            </div>
            <div class="form-group">
                <label for="position-term-length">Term Length (months)</label>
                <input type="number" id="position-term-length" placeholder="6" min="1" />
            </div>
            <div class="form-group">
                <label for="position-current-holder">Current Holder</label>
                <select id="position-current-holder">
                    <option value="">Vacant</option>
                </select>
            </div>
            <div class="form-group">
                <label for="position-start-date">Term Start Date</label>
                <input type="date" id="position-start-date" />
            </div>
            <button class="btn" onclick="addServicePosition()">Add Position</button>

            <h3 class="mt-4">Current Service Positions</h3>
            <table>
                <thead>
                    <tr>
                        <th>Position</th>
                        <th>Current Holder</th>
                        <th>Term Start</th>
                        <th>Term End</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="service-positions-table"></tbody>
            </table>

            <h3 class="mt-4">Rotation Calendar</h3>
            <p>Upcoming position elections (positions coming up in next 60 days)</p>
            <div id="rotation-calendar"></div>

            <h3 class="mt-4">Nomination System</h3>
            <div class="form-group">
                <label for="nomination-position">Position</label>
                <select id="nomination-position">
                    <option value="">Select position...</option>
                </select>
            </div>
            <div class="form-group">
                <label for="nomination-nominee">Nominee</label>
                <select id="nomination-nominee">
                    <option value="">Select member...</option>
                </select>
            </div>
            <button class="btn" onclick="addNomination()">Submit Nomination</button>

            <h3 class="mt-4">Current Nominations</h3>
            <div id="nominations-list"></div>
        </section>

        <!-- Finance Section -->
        <section id="finance-section">
            <h2>Financial Tracking</h2>

            <div class="history-nav">
                <button onclick="showFinanceTab('budget')" class="active" id="budget-tab">Budget</button>
                <button onclick="showFinanceTab('expenses')" id="expenses-tab">Expenses</button>
                <button onclick="showFinanceTab('reports')" id="reports-tab">Reports</button>
            </div>

            <div id="budget-content" class="finance-tab active">
                <h3>Budget Management</h3>
                <div class="form-group">
                    <label for="budget-category">Category</label>
                    <input type="text" id="budget-category" placeholder="e.g., Rent, Literature, Refreshments..." />
                </div>
                <div class="form-group">
                    <label for="budget-amount">Monthly Budget Amount</label>
                    <input type="number" id="budget-amount" placeholder="0.00" step="0.01" min="0" />
                </div>
                <button class="btn" onclick="addBudgetCategory()">Add Budget Category</button>

                <h3 class="mt-4">Current Budget</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Monthly Budget</th>
                            <th>Spent This Month</th>
                            <th>Remaining</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="budget-table"></tbody>
                </table>
            </div>

            <div id="expenses-content" class="finance-tab">
                <h3>Log Expense</h3>
                <div class="form-group">
                    <label for="expense-date">Date</label>
                    <input type="date" id="expense-date" />
                </div>
                <div class="form-group">
                    <label for="expense-category">Category</label>
                    <select id="expense-category">
                        <option value="">Select category...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="expense-description">Description</label>
                    <input type="text" id="expense-description" placeholder="What was purchased..." />
                </div>
                <div class="form-group">
                    <label for="expense-amount">Amount</label>
                    <input type="number" id="expense-amount" placeholder="0.00" step="0.01" min="0" />
                </div>
                <button class="btn" onclick="addExpense()">Log Expense</button>

                <h3 class="mt-4">Recent Expenses</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Category</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="expenses-table"></tbody>
                </table>
            </div>

            <div id="reports-content" class="finance-tab">
                <h3>Financial Reports</h3>
                <div class="form-group">
                    <label for="report-month">Select Month</label>
                    <input type="month" id="report-month" />
                </div>
                <button class="btn" onclick="generateMonthlyReport()">Generate Report</button>

                <div id="monthly-report" class="box mt-4"></div>

                <h3 class="mt-4">Year-over-Year Comparison</h3>
                <div id="yoy-chart" class="box"></div>
            </div>
        </section>

        <!-- Meeting Format Templates Section -->
        <section id="templates-section">
            <h2>Meeting Format Templates</h2>

            <h3>Create/Edit Template</h3>
            <div class="form-group">
                <label for="template-name">Template Name</label>
                <input type="text" id="template-name" placeholder="e.g., Speaker Meeting, Step Study, Big Book..." />
            </div>
            <div class="form-group">
                <label for="template-type">Template Type</label>
                <select id="template-type">
                    <option value="meeting-format">Meeting Format</option>
                    <option value="speaker-checklist">Speaker Meeting Checklist</option>
                    <option value="event-planning">Event Planning</option>
                </select>
            </div>
            <div class="form-group">
                <label for="template-content">Template Content</label>
                <textarea id="template-content" rows="10" placeholder="Enter template content..."></textarea>
            </div>
            <button class="btn" onclick="saveTemplate()">Save Template</button>

            <h3 class="mt-4">Saved Templates</h3>
            <div class="history-nav">
                <button onclick="filterTemplates('all')" class="active" id="all-templates-btn">All</button>
                <button onclick="filterTemplates('meeting-format')" id="meeting-templates-btn">Meeting Formats</button>
                <button onclick="filterTemplates('speaker-checklist')" id="speaker-templates-btn">Speaker Checklists</button>
                <button onclick="filterTemplates('event-planning')" id="event-templates-btn">Event Planning</button>
            </div>
            <div id="templates-list"></div>
        </section>

        <!-- Gallery Section -->
        <section id="gallery-section">
            <h2>Photo Gallery</h2>
            <p class="mb-2">Upload pictures of fliers or events. Add comma-separated tags to help organize them.</p>
            <div class="form-group">
                <label for="photo-upload">Select Photos</label>
                <input type="file" id="photo-upload" accept="image/*" multiple />
            </div>
            <div class="form-group">
                <label for="photo-tags">Tags (comma-separated)</label>
                <input type="text" id="photo-tags" placeholder="e.g. bbq, anniversary, 2024" />
            </div>
            <button class="btn" onclick="uploadPhotos()">Upload Selected</button>

            <h3 class="mt-4">Filter Photos</h3>
            <div class="form-group">
                <input type="text" id="tag-filter" onkeyup="updateGallery()" placeholder="Filter by tag..." />
            </div>
            <div id="tag-list" class="mb-4"></div>

            <h3 class="mt-4">Photos</h3>
            <div id="gallery-grid"></div>
        </section>

        <!-- The Modal -->
        <div id="photo-modal" class="modal">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <a class="prev" onclick="showPreviousPhoto()">&#10094;</a>
            <a class="next" onclick="showNextPhoto()">&#10095;</a>
            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; max-width: 90vw; max-height: 90vh;">
                <img class="modal-content" id="modal-image" style="max-height: 80vh; object-fit: contain;">
                <div id="modal-caption" style="text-align: center; color: #ccc; padding: 10px 0; font-size: 1rem; height: 2rem;"></div>
            </div>
        </div>

        <!-- History Section -->
        <section id="history-section">
            <h2>History &amp; Resources</h2>
            <!-- History navigation buttons for different timelines -->
            <div class="history-nav">
                <button id="genesis-btn" onclick="showHistory('genesis-history')">Genesis of AA</button>
                <button id="dfw-btn" onclick="showHistory('dfw-history')">Dallas/Fort Worth History</button>
                <button id="rowlett-btn" onclick="showHistory('rowlett-history')">Rowlett Group History</button>
            </div>
            <!-- Embedded histories (hidden by default, toggled via showHistory()) -->
            <div id="genesis-history" class="history-content">
                <h3 class="mb-4 font-bold text-xl">The Genesis of Alcoholics Anonymous</h3>
                <!-- Genesis timeline -->
                <div class="timeline-wrapper">
                <div class="timeline-container">
                
                            <!-- Event 1: 1895 - Bill W. Born -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-blue-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-blue-400 pb-1 mb-2">William Griffith Wilson's Birth</h4>
                                        <p class="text-sm">Born in East Dorset, Vermont. His early life was marked by feelings of isolation and a strong drive for recognition, factors that would later influence his drinking and recovery.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-blue-800">Nov 26, 1895: Bill W. Born <i class="fa-solid fa-baby ml-2 text-blue-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Birth of William Griffith Wilson, co-founder of Alcoholics Anonymous.</p>
                                </div>
                            </div>
                
                            <!-- Event 2: 1879 - Dr. Bob Born -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-purple-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-purple-400 pb-1 mb-2">Robert Holbrook Smith's Birth</h4>
                                        <p class="text-sm">Born in St. Johnsbury, Vermont. He would later become a respected surgeon in Akron, Ohio, and co-founder of AA, despite his long struggle with alcoholism.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-purple-800">Aug 8, 1879: Dr. Bob Born <i class="fa-solid fa-baby ml-2 text-purple-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Birth of Robert Holbrook Smith, co-founder of Alcoholics Anonymous.</p>
                                </div>
                            </div>
                
                            <!-- Event 3: Early 1900s - Bill W.'s Descent & Marriage -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-green-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-green-400 pb-1 mb-2">Bill's Struggle & Lois Wilson</h4>
                                        <p class="text-sm">Bill's drinking progresses, leading to severe consequences. He marries Lois Burnham Wilson in 1918, who would become a steadfast supporter and co-founder of Al-Anon.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-green-800">1910s-30s: Bill's Descent & Lois <i class="fa-solid fa-ring ml-2 text-green-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Bill's alcoholism escalates, bringing financial ruin and repeated hospitalizations, deeply impacting his wife, Lois.</p>
                                </div>
                            </div>
                
                            <!-- Event 4: Early 1900s - Dr. Bob's Hidden Battle & Marriage -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-teal-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-teal-400 pb-1 mb-2">Dr. Bob's Hidden Battle & Anne Smith</h4>
                                        <p class="text-sm">Dr. Bob's alcoholism becomes a decades-long struggle, hidden from many. He marries Anne Ripley Smith, who would become a crucial figure in early AA and Al-Anon, supporting his recovery efforts.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-teal-800">1910s-30s: Dr. Bob's Struggle & Anne <i class="fa-solid fa-house-medical-flag ml-2 text-teal-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Dr. Bob battles severe, often hidden, alcoholism despite his medical career, supported by his wife, Anne.</p>
                                </div>
                            </div>
                
                            <!-- Event 5: November 1934 - Ebby T.'s Visit & Bill's Turning Point -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-cyan-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-cyan-400 pb-1 mb-2">The Spiritual Solution Introduced</h4>
                                        <p class="text-sm">Bill's old drinking friend, Ebby T., visits him, sober, and introduces the idea of a spiritual solution, learned from the Oxford Group. This plants the seed for Bill's own spiritual awakening.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-cyan-800">Nov 1934: Ebby T. & Bill's Shift <i class="fa-solid fa-hand-holding-heart ml-2 text-cyan-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Ebby T. visits Bill, sharing his newfound sobriety through a spiritual experience, igniting hope in Bill during his deepest despair.</p>
                                </div>
                            </div>
                
                            <!-- Event 6: December 1934 - Bill's Spiritual Awakening -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-yellow-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-yellow-400 pb-1 mb-2">The "White Light" Experience</h4>
                                        <p class="text-sm">While hospitalized in Towns Hospital, Bill experiences a profound spiritual awakening after crying out to God in desperation. The obsession with alcohol is lifted, and he finds immediate sobriety.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-yellow-800">Dec 1934: Bill's Awakening <i class="fa-solid fa-lightbulb ml-2 text-yellow-500"></i></h2>
                                    <p class="mt-2 text-slate-700">In Towns Hospital, Bill W. has a powerful spiritual experience that removes his obsession to drink, marking his last drink.</p>
                                </div>
                            </div>
                
                            <!-- Event 7: Early 1935 - Bill's Early Attempts & The Paradox -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-orange-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-orange-400 pb-1 mb-2">The Helper Therapy Principle</h4>
                                        <p class="text-sm">Bill's initial attempts to "convert" other alcoholics fail until he realizes he must share his experience with empathy, not preach. He discovers that helping others is crucial for his own sobriety.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-orange-800">Early 1935: The Paradox Discovered <i class="fa-solid fa-person-digging ml-2 text-orange-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Bill learns that helping other alcoholics is essential for maintaining his own sobriety, laying the groundwork for AA's core service principle.</p>
                                </div>
                            </div>
                
                            <!-- Event 8: May 1935 - Bill W. Meets Dr. Bob (AA's Founding) -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-red-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-red-400 pb-1 mb-2">The Birth of AA</h4>
                                        <p class="text-sm">During a business trip to Akron, Bill, desperate to help another alcoholic to stay sober himself, is introduced to Dr. Bob by Henrietta Seiberling. Their shared experience and mutual need ignite the spark of Alcoholics Anonymous.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-red-800">May 1935: AA is Born <i class="fa-solid fa-handshake ml-2 text-red-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Bill W. meets Dr. Bob in Akron, Ohio. Their first conversation and shared experience mark the official founding of Alcoholics Anonymous.</p>
                                </div>
                            </div>
                
                            <!-- Event 9: June 10, 1935 - Dr. Bob's Last Drink -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-indigo-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-indigo-400 pb-1 mb-2">The Last Drink</h4>
                                        <p class="text-sm">After continued discussions with Bill and a final relapse, Dr. Bob takes his last drink on June 10, 1935, achieving continuous sobriety. This date is celebrated as AA's founding day.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-indigo-800">June 10, 1935: Dr. Bob Sober <i class="fa-solid fa-calendar-check ml-2 text-indigo-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Dr. Bob takes his last drink, achieving continuous sobriety and solidifying the foundation of the new fellowship.</p>
                                </div>
                            </div>
                
                            <!-- Event 10: June 1935 Onwards - The First AA Group in Akron -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-purple-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-purple-400 pb-1 mb-2">Working with Others</h4>
                                        <p class="text-sm">Bill and Dr. Bob begin working with other alcoholics, primarily at Akron City Hospital. They apply their principles of sharing experience, spiritual transformation, and mutual support, forming the nucleus of the first AA group.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-purple-800">June 1935+: Akron Group <i class="fa-solid fa-hospital ml-2 text-purple-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Bill and Dr. Bob begin intensive work with other alcoholics, particularly in hospitals, forming the first AA group in Akron.</p>
                                </div>
                            </div>
                
                            <!-- Event 11: Late 1930s - Evolution of the Twelve Steps -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-green-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-green-400 pb-1 mb-2">From Oxford Group to AA's Principles</h4>
                                        <p class="text-sm">The Twelve Steps evolved from the six principles of the Oxford Group, a spiritual movement that influenced early AA. Bill W. expanded and formalized these into the Twelve Steps, making them more specific to alcoholism and accessible to a wider audience, including those without a traditional religious background.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-green-800">Late 1930s: Steps Evolve <i class="fa-solid fa-scroll ml-2 text-green-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The Twelve Steps are developed and formalized by Bill W., building on earlier spiritual principles.</p>
                                </div>
                            </div>
                
                            <!-- Event 12: 1938-1939 - Drafting of the Twelve Steps -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-teal-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-teal-400 pb-1 mb-2">Codifying the Program</h4>
                                        <p class="text-sm">Bill W., with input from Dr. Bob and early members, drafts the Twelve Steps, codifying the spiritual principles and actions necessary for recovery. These steps become the core program of AA.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-teal-800">1938-1939: Twelve Steps Drafted <i class="fa-solid fa-list-ol ml-2 text-teal-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The Twelve Steps are formally drafted, outlining the program of recovery for alcoholics.</p>
                                </div>
                            </div>
                
                            <!-- Event 13: April 1939 - Publication of "Alcoholics Anonymous" (First Edition) -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-cyan-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-cyan-400 pb-1 mb-2">Carrying the Message to the World</h4>
                                        <p class="text-sm">The foundational text, "Alcoholics Anonymous" (the Big Book), is published. It details the problem of alcoholism, the spiritual solution, and the Twelve Steps, making the program accessible to a wider audience.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-cyan-800">Apr 1939: Big Book (1st Ed.) <i class="fa-solid fa-book-open ml-2 text-cyan-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The book "Alcoholics Anonymous" is published, providing the definitive text for the fellowship's program of recovery.</p>
                                </div>
                            </div>
                
                            <!-- Event 14: Late 1930s - 1940s - Growth & Emergence of Traditions -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-yellow-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-yellow-400 pb-1 mb-2">Maintaining Unity</h4>
                                        <p class="text-sm">As AA grows rapidly, issues of group autonomy, money, and public relations arise. The Twelve Traditions emerge informally and are later codified to ensure the unity and survival of the fellowship.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-yellow-800">1930s-40s: Traditions Emerge <i class="fa-solid fa-users-line ml-2 text-yellow-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Rapid growth leads to the development of the Twelve Traditions, guiding AA's groups and preserving its unity.</p>
                                </div>
                            </div>
                
                            <!-- Event 15: Nov 16, 1950 - Dr. Bob's Passing -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-orange-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-orange-400 pb-1 mb-2">A Legacy of Service</h4>
                                        <p class="text-sm">Dr. Bob passes away in Akron, Ohio, having maintained continuous sobriety since June 10, 1935. His life of dedicated service, particularly in hospitals, leaves an enduring legacy as AA's co-founder.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-orange-800">Nov 16, 1950: Dr. Bob Passes <i class="fa-solid fa-cross ml-2 text-orange-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Dr. Bob, co-founder of AA, passes away, having achieved continuous sobriety and dedicated his life to helping others.</p>
                                </div>
                            </div>
                
                            <!-- Event 16: 1953 - Publication of "Twelve Steps and Twelve Traditions" -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-red-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-red-400 pb-1 mb-2">Deeper Understanding & Guidance</h4>
                                        <p class="text-sm">Written by Bill W., this book provides detailed interpretations and historical context for both the Twelve Steps and the Twelve Traditions. It was created to offer members a deeper understanding of the spiritual principles and the guidelines for group unity, helping AA mature as a fellowship.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-red-800">1953: 12 & 12 Published <i class="fa-solid fa-book-bookmark ml-2 text-red-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The "Twelve Steps and Twelve Traditions" book is published, offering deeper insights into the program and guiding principles.</p>
                                </div>
                            </div>
                
                            <!-- Event 17: 1955 - Publication of "Alcoholics Anonymous" (Second Edition) -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-indigo-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-indigo-400 pb-1 mb-2">Growth and Traditions</h4>
                                        <p class="text-sm">The second edition of the Big Book is published, reflecting AA's significant growth and including the formalized Twelve Traditions.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-indigo-800">1955: Big Book (2nd Ed.) <i class="fa-solid fa-book-reader ml-2 text-indigo-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The second edition of the Big Book is released, documenting AA's growth and formally including the Twelve Traditions.</p>
                                </div>
                            </div>
                
                            <!-- Event 18: 1950s - Development of Concepts for World Service -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-purple-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-purple-400 pb-1 mb-2">Guiding Global Service</h4>
                                        <p class="text-sm">Bill W. develops the Twelve Concepts for World Service to provide a framework for AA's growing global service structure, ensuring effective leadership and decision-making while maintaining group autonomy.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-purple-800">1950s: World Service Concepts <i class="fa-solid fa-globe ml-2 text-purple-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The Twelve Concepts for World Service are developed to guide AA's expanding global service structure.</p>
                                </div>
                            </div>
                
                            <!-- Event 19: 1971 - Bill W.'s Passing -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-green-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-green-400 pb-1 mb-2">A Founder's Legacy</h4>
                                        <p class="text-sm">Bill W. passes away in Miami Beach, Florida. His vision and dedication led to the founding of AA and its global spread, leaving an immeasurable legacy for millions in recovery.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-green-800">Jan 24, 1971: Bill W. Passes <i class="fa-solid fa-person-praying ml-2 text-green-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Bill W., co-founder of AA, passes away, leaving behind a global fellowship dedicated to sobriety.</p>
                                </div>
                            </div>
                
                            <!-- Event 20: 1976 - Publication of "Alcoholics Anonymous" (Third Edition) -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-teal-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-teal-400 pb-1 mb-2">Continued Expansion</h4>
                                        <p class="text-sm">The third edition of the Big Book is published, reflecting further growth in AA membership worldwide and reaffirming the unchanging core principles.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-teal-800">1976: Big Book (3rd Ed.) <i class="fa-solid fa-book-bookmark ml-2 text-teal-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The third edition of the Big Book is released, documenting AA's continued expansion.</p>
                                </div>
                            </div>
                
                            <!-- Event 21: 2001 - Publication of "Alcoholics Anonymous" (Fourth Edition) -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-cyan-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-cyan-400 pb-1 mb-2">Into the New Millennium</h4>
                                        <p class="text-sm">The fourth edition of the Big Book is published, highlighting AA's global reach into the new millennium and the enduring power of its message.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-cyan-800">2001: Big Book (4th Ed.) <i class="fa-solid fa-book-atlas ml-2 text-cyan-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The fourth edition of the Big Book is released, marking AA's presence worldwide at the turn of the millennium.</p>
                                </div>
                            </div>
                
                        </div>
                </div>
            </div>
            <div id="dfw-history" class="history-content">
                <h3 class="mb-4 font-bold text-xl">Dallas/Fort Worth AA History</h3>
                <!-- Dallas/Fort Worth timeline -->
                <div class="timeline-wrapper">
                <div class="timeline-container">
                
                            <!-- Event 1: 1940 - AA Comes to Houston -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-blue-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-blue-400 pb-1 mb-2">Texas Roots</h4>
                                        <p class="text-sm">The first documented AA group in Texas forms in Houston with Larry Jewell. This is significant as Esther E., a key figure in Dallas AA, sobered up here before moving to Dallas.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-blue-800">1940: AA in Houston <i class="fa-solid fa-map-pin ml-2 text-blue-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The first AA group in Texas is established in Houston.</p>
                                </div>
                            </div>
                
                            <!-- Event 2: June 14, 1941 - Ruth T.'s Letter (Dallas) -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-purple-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-purple-400 pb-1 mb-2">First Dallas Outreach</h4>
                                        <p class="text-sm">Ruth T., a Dallas alcoholic, sends the first recorded letter from Dallas to Ruth Hock, Bill W.'s secretary in New York, inquiring about AA activity in the area. This marks the initial plea for help from Dallas.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-purple-800">Jun 14, 1941: Ruth T.'s Plea <i class="fa-solid fa-envelope ml-2 text-purple-500"></i></h2>
                                    <p class="mt-2 text-slate-700">First recorded outreach from Dallas to AA General Service Office.</p>
                                </div>
                            </div>
                
                            <!-- Event 3: 1941 - First Fort Worth Group (Hazy History) -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-green-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-green-400 pb-1 mb-2">Fort Worth's Early Beginnings</h4>
                                        <p class="text-sm">George McL. is credited with starting the first AA group in Fort Worth. Early history is "hazy," but correspondence details an initial meeting with seven attendees.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-green-800">1941: Fort Worth's First Group <i class="fa-solid fa-users ml-2 text-green-500"></i></h2>
                                    <p class="mt-2 text-slate-700">George McL. is credited with starting the first AA group in Fort Worth.</p>
                                </div>
                            </div>
                
                            <!-- Event 4: Dec 1, 1941 - Kent W.'s Arrival (Dallas) -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-teal-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-teal-400 pb-1 mb-2">Energetic but Fleeting Efforts</h4>
                                        <p class="text-sm">Kent W., a sober AA member from Florida, moves to Dallas and eagerly begins promoting AA in local media, planning meetings, and even titled himself "Chief Sponsor" of Dallas AA.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-teal-800">Dec 1, 1941: Kent W. in Dallas <i class="fa-solid fa-bullhorn ml-2 text-teal-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Kent W. arrives in Dallas, eager to establish an AA group.</p>
                                </div>
                            </div>
                
                            <!-- Event 5: Jan 7, 1942 - First Recorded Dallas Meeting (Kent W.) -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-cyan-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-cyan-400 pb-1 mb-2">Initial Surge and Disappearance</h4>
                                        <p class="text-sm">Kent W. holds the first recorded AA meeting in Dallas at the White Plaza Hotel, attended by 12 people. A Dallas Morning News story sparks 72 inquiries. Despite his efforts, Kent W. is "never heard from again," highlighting the fragility of early group formation.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-cyan-800">Jan 7, 1942: 1st Dallas Meeting <i class="fa-solid fa-hotel ml-2 text-cyan-500"></i></h2>
                                    <p class="mt-2 text-slate-700">First recorded AA meeting in Dallas held by Kent W. at the White Plaza Hotel.</p>
                                </div>
                            </div>
                
                            <!-- Event 6: April 2, 1943 - Esther E. Starts "The Dallas Group" -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-yellow-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-yellow-400 pb-1 mb-2">AA Takes Root in Dallas</h4>
                                        <p class="text-sm">Esther E. (whose story "A Flower of the South" is in the Big Book), having sobered up in Houston, moves to Dallas and starts "The Dallas Group" in her home. Ruth T. attends this inaugural meeting.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-yellow-800">Apr 2, 1943: "The Dallas Group" <i class="fa-solid fa-house-chimney ml-2 text-yellow-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Esther E. starts "The Dallas Group" in her home, marking AA truly taking root in Dallas.</p>
                                </div>
                            </div>
                
                            <!-- Event 7: 1945 - Dallas AA First Permanent Home -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-orange-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-orange-400 pb-1 mb-2">Establishing a Presence</h4>
                                        <p class="text-sm">Dallas AA secures its first permanent home at 912 ½ Main Street in downtown. By year-end, fewer than 20 people in the city are sober, but numbers are growing by word-of-mouth.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-orange-800">1945: Dallas AA Home <i class="fa-solid fa-building ml-2 text-orange-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Dallas AA establishes its first permanent home downtown.</p>
                                </div>
                            </div>
                
                            <!-- Event 8: 1946 - Suburban Group Formed (Dallas) -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-red-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-red-400 pb-1 mb-2">Post-War Expansion</h4>
                                        <p class="text-sm">Following World War II, AA membership surges. Searcy W. forms a second group, the Suburban Group, which remains active in Dallas today.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-red-800">1946: Suburban Group <i class="fa-solid fa-people-group ml-2 text-red-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Searcy W. forms the Suburban Group in Dallas.</p>
                                </div>
                            </div>
                
                            <!-- Event 9: Sep 18, 1947 - Dallas Central Office Opens -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-indigo-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-indigo-400 pb-1 mb-2">Organizational Foresight</h4>
                                        <p class="text-sm">The Dallas Central Office holds its first Board meeting and officially opens on Akard Street. Dick P. serves as the first Office Manager, despite suffering physically from Jamaica Ginger Poisoning, demonstrating profound commitment.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-indigo-800">Sep 18, 1947: Dallas Central Office <i class="fa-solid fa-phone ml-2 text-indigo-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The Dallas Central Office officially opens for business.</p>
                                </div>
                            </div>
                
                            <!-- Event 10: 1960 - Esther E. Passes Away -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-purple-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-purple-400 pb-1 mb-2">A Pioneer's Legacy</h4>
                                        <p class="text-sm">Esther E. passes away with slightly more than 19 years of sobriety. Her personal copy of the Big Book, inscribed by Bill W., is displayed at the Dallas Intergroup Office, a tangible link to her foundational role.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-purple-800">1960: Esther E. Passes <i class="fa-solid fa-book-heart ml-2 text-purple-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Esther E., instrumental in establishing AA in Dallas, passes away.</p>
                                </div>
                            </div>
                
                            <!-- Event 11: 1968 - Dallas Intergroup Reorganizes -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-green-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-green-400 pb-1 mb-2">Maturation of Service</h4>
                                        <p class="text-sm">Dallas Intergroup reorganizes, and the Central Office begins operating more formally under the guidance of the then eight or nine AA groups. A member generously loans \$2,000 to stock AA literature.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-green-800">1968: Dallas Intergroup Reorg <i class="fa-solid fa-sitemap ml-2 text-green-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Dallas Intergroup reorganizes for more formal operations.</p>
                                </div>
                            </div>
                
                            <!-- Event 12: 1971 - Dallas Central Office Publishes Directory -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-teal-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-teal-400 pb-1 mb-2">Broadening Reach</h4>
                                        <p class="text-sm">The Dallas Central Office, then located in the Hudson & Hudson Building, publishes a comprehensive meeting directory that includes groups in jails, hospitals, and other facilities, reflecting the broadening reach of AA.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-teal-800">1971: Dallas Meeting Directory <i class="fa-solid fa-address-book ml-2 text-teal-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Dallas Central Office publishes a comprehensive meeting directory.</p>
                                </div>
                            </div>
                
                            <!-- Event 13: 1973 - Dallas Fellowship Grows to 30 Groups -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-cyan-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-cyan-400 pb-1 mb-2">Significant Growth</h4>
                                        <p class="text-sm">The Dallas fellowship experiences substantial growth, reaching 30 active groups, demonstrating the increasing demand for AA's message in the region.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-cyan-800">1973: 30 Dallas Groups <i class="fa-solid fa-chart-line ml-2 text-cyan-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The Dallas AA fellowship grows to 30 groups.</p>
                                </div>
                            </div>
                
                            <!-- Event 14: 1978 - Lambda Dallas Group Founded -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-yellow-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-yellow-400 pb-1 mb-2">Serving Diverse Communities</h4>
                                        <p class="text-sm">The Lambda Dallas Group is founded in Oak Lawn, Dallas' LGBTQ neighborhood. This group plays a vital role in carrying the AA message to thousands within this specific community, highlighting AA's adaptability.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-yellow-800">1978: Lambda Dallas Group <i class="fa-solid fa-rainbow ml-2 text-yellow-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The Lambda Dallas Group is founded, serving the LGBTQ community.</p>
                                </div>
                            </div>
                
                            <!-- Event 15: June 10, 1983 - The Glass House Group Founded (Fort Worth) -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-orange-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-orange-400 pb-1 mb-2">Fort Worth Milestone</h4>
                                        <p class="text-sm">The Glass House group is founded on the west side of Fort Worth by a few members emphasizing spirituality. Its first meeting on Houghton Street notably coincides with AA's 48th anniversary. The podium built by founder Don A. is still in use today.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-orange-800">Jun 10, 1983: Glass House (FW) <i class="fa-solid fa-house-crack ml-2 text-orange-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The Glass House group is founded in Fort Worth.</p>
                                </div>
                            </div>
                
                            <!-- Event 16: 1984 - The Glass House Moves to Hemsell Place -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-red-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-red-400 pb-1 mb-2">Rapid Growth & Incorporation</h4>
                                        <p class="text-sm">Within months, The Glass House outgrows its initial location, leading to the acquisition of its current facility at 6713 Hemsell Place. The move involves extensive volunteer effort, and the group is incorporated by Bryan H., Jim Williams, Kelly Y., and Massie T.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-red-800">1984: Glass House Relocates <i class="fa-solid fa-location-dot ml-2 text-red-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The Glass House group moves to its current Fort Worth facility.</p>
                                </div>
                            </div>
                
                            <!-- Event 17: 1989 - Dallas Intergroup Becomes DIA -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-indigo-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-indigo-400 pb-1 mb-2">Formalizing Structure</h4>
                                        <p class="text-sm">The Dallas Intergroup formalizes its structure by incorporating and becoming the Dallas Intergroup Association (DIA), a non-profit organization, reflecting its maturation as a service entity.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-indigo-800">1989: Dallas Intergroup (DIA) <i class="fa-solid fa-building-columns ml-2 text-indigo-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Dallas Intergroup incorporates as the Dallas Intergroup Association (DIA).</p>
                                </div>
                            </div>
                
                            <!-- Event 18: June 1993 - Bryan Honts (Glass House Founder) Passes -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-purple-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-purple-400 pb-1 mb-2">A Founder Remembered</h4>
                                        <p class="text-sm">Bryan Honts, a founder of The Glass House group in Fort Worth, passes away. His contributions were vital to the group's establishment and early growth.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-purple-800">Jun 1993: Bryan Honts Passes <i class="fa-solid fa-user-tie ml-2 text-purple-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Bryan Honts, a founder of The Glass House group, passes away.</p>
                                </div>
                            </div>
                
                            <!-- Event 19: Jan 1999 - Jim Williams (Glass House Founder) Passes -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-green-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-green-400 pb-1 mb-2">Speaker and Founder</h4>
                                        <p class="text-sm">Jim Williams, a founder of The Glass House group and a prolific AA speaker, passes away. His shares and service significantly impacted many members.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-green-800">Jan 1999: Jim Williams Passes <i class="fa-solid fa-microphone ml-2 text-green-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Jim Williams, a founder and speaker at The Glass House, passes away.</p>
                                </div>
                            </div>
                
                            <!-- Event 20: April 2000 - Dallas AA Central Office Reverts Name -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-teal-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-teal-400 pb-1 mb-2">Clarifying Identity</h4>
                                        <p class="text-sm">The Dallas Intergroup Association (DIA) reverts its name to the Dallas AA Central Office. This change was made to better describe its primary function to potential newcomers seeking help, emphasizing accessibility.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-teal-800">Apr 2000: Dallas Central Office <i class="fa-solid fa-retweet ml-2 text-teal-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Dallas Intergroup Association (DIA) reverts its name to Dallas AA Central Office.</p>
                                </div>
                            </div>
                
                            <!-- Event 21: 2002 - Dr. Rex Howard (Glass House Founder) Passes -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-cyan-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-cyan-400 pb-1 mb-2">Another Founder's Departure</h4>
                                        <p class="text-sm">Dr. Rex Howard, another founder of The Glass House group, passes away. His contributions were integral to the early spiritual emphasis of the group.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-cyan-800">2002: Dr. Rex Howard Passes <i class="fa-solid fa-user-md ml-2 text-cyan-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Dr. Rex Howard, a founder of The Glass House group, passes away.</p>
                                </div>
                            </div>
                
                            <!-- Event 22: 2003 - Searcy W. Passes (Dallas) -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-yellow-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-yellow-400 pb-1 mb-2">Dallas's Oldest Member</h4>
                                        <p class="text-sm">Searcy W., founder of Dallas's Suburban Group and then Dallas's oldest AA member, passes away with 57 years of sobriety, leaving a long legacy of recovery and service.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-yellow-800">2003: Searcy W. Passes <i class="fa-solid fa-star-of-life ml-2 text-yellow-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Searcy W., founder of the Suburban Group and Dallas's oldest AA member, passes away.</p>
                                </div>
                            </div>
                
                            <!-- Event 23: April 2009 - Kelly Young (Glass House Key Figure) Passes -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-orange-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-orange-400 pb-1 mb-2">Spiritual Leadership</h4>
                                        <p class="text-sm">Kelly Young, a key figure at The Glass House group who served as Chairman of its Board for 24 years, passes away after 27 years of active service, leaving a lasting legacy of spiritual leadership.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-orange-800">Apr 2009: Kelly Young Passes <i class="fa-solid fa-hand-holding-medical ml-2 text-orange-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Kelly Young, a key figure at The Glass House group, passes away.</p>
                                </div>
                            </div>
                
                            <!-- Event 24: Present - DFW AA Today -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-red-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-red-400 pb-1 mb-2">Continuing Service</h4>
                                        <p class="text-sm">The Dallas Central Office/DIA supports over 160 AA groups, hosting over 1500 meetings. The Fort Worth AA Central Office serves a wide multi-county area, and NETA 65 serves over 500 AA groups, demonstrating ongoing growth and vital service.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-red-800">Present: DFW AA Today <i class="fa-solid fa-city ml-2 text-red-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Dallas and Fort Worth AA continue to thrive, supporting thousands of members.</p>
                                </div>
                            </div>
                
                        </div>
                </div>
            </div>
            <div id="rowlett-history" class="history-content">
                <h3 class="mb-4 font-bold text-xl">Rowlett Group History</h3>
                <!-- Rowlett Group timeline -->
                <div class="timeline-wrapper">
                <div class="timeline-container">
                            <!-- 1995 -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-sky-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-sky-400 pb-1 mb-2">The Backstory</h4>
                                        <p class="text-sm">The Sunshine Group was struggling financially. Knowing the end was near, members gave notice to their landlord, promising to somehow pay two months of back rent. After it folded, a new vision was born.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-sky-800">1995: A Leap of Faith <i class="fa-solid fa-seedling ml-2 text-sky-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Eight former Sunshine Group members founded a new, non-smoking group. On July 22, the first meeting was held at 4501 Rowlett Road in a tiny 10.5' x 14' room.</p>
                                </div>
                            </div>
                
                            <!-- 1996 -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-teal-50">
                                     <div class="info-popup">
                                        <h4 class="font-bold border-b border-teal-400 pb-1 mb-2">Volunteer Spirit</h4>
                                        <p class="text-sm">Extensive remodeling and refinishing was mostly done by Group volunteers working nights and weekends, creating the group home for the next six years!</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-teal-800">1996: Building Our Home <i class="fa-solid fa-hammer ml-2 text-teal-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The 1st Anniversary BBQ was memorably rained out. That fall, the group room tripled in size, and the Open House featured speaker Searcy W., who held a fifty-year chip!</p>
                                </div>
                            </div>
                            
                            <!-- 1997-1998 -->
                            <div class="timeline-block left">
                                 <div class="timeline-content bg-teal-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-teal-400 pb-1 mb-2">Meeting Growth</h4>
                                        <p class="text-sm">Monthly AA birthday meetings were combined with Al-Anon. The total weekly meeting count grew rapidly: from none to 12 in 1997, then to 17 by the end of 1998.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-teal-800">1997-1998: More Meetings! <i class="fa-solid fa-users ml-2 text-teal-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The group expanded its schedule, adding monthly birthday meetings, multiple noon meetings, and 6 PM meetings to better serve the growing community.</p>
                                 </div>
                            </div>
                
                            <!-- 1999-2002 -->
                            <div class="timeline-block right">
                                 <div class="timeline-content bg-teal-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-teal-400 pb-1 mb-2">Key Events</h4>
                                        <ul class="text-sm list-disc list-inside space-y-1">
                                            <li><b>May 1999:</b> $500 approved to double Al-Anon space with volunteer labor.</li>
                                            <li><b>Feb 2002:</b> Sponsorship workshop featured a four-member panel with a moderator.</li>
                                             <li><b>Aug 2002:</b> 7th Anniversary had ~100 members and guests.</li>
                                        </ul>
                                    </div>
                                    <h2 class="text-2xl font-bold text-teal-800">1999-2002: Service & Structure <i class="fa-solid fa-book-open ml-2 text-teal-500"></i></h2>
                                    <p class="mt-2 text-slate-700">This era focused on service, with a 4th Anniversary party, a Sponsorship Workshop, and the formal designation of the Rowlett Group Bylaws.</p>
                                 </div>
                            </div>
                
                            <!-- 2003 -->
                            <div class="timeline-block left">
                                 <div class="timeline-content bg-amber-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-amber-400 pb-1 mb-2">The Big Move</h4>
                                        <p class="text-sm">Minimum requirements for a new space: affordable rent, 1,000 sq ft, kitchen, bathroom, and storage. The new Garland facility's 2nd birthday night celebrated 27 members representing over 140 years of sobriety.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-amber-800">2003: A Test of Unity <i class="fa-solid fa-truck-moving ml-2 text-amber-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Forced to move, the group relocated to Garland. In an amazing show of unity, 50-60 members moved everything in under an hour, ensuring no meetings were missed.</p>
                                 </div>
                            </div>
                
                            <!-- 2004-2007 -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-amber-50">
                                     <div class="info-popup">
                                        <h4 class="font-bold border-b border-amber-400 pb-1 mb-2">Lease & Name</h4>
                                        <p class="text-sm">In 2006, the lease was extended, with the Rowlett Group becoming the official signatory. In June 2007, the group reconsidered a name change but elected to keep the Rowlett Group name despite being in Garland.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-amber-800">2004-2007: Settling In <i class="fa-solid fa-anchor ml-2 text-amber-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The group held its 2nd inventory, created job descriptions, and hosted workshops. The 12th Anniversary theme was "Imagine Life Without Faith."</p>
                                </div>
                            </div>
                
                             <!-- 2008-2009 -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-amber-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-amber-400 pb-1 mb-2">Fellowship!</h4>
                                        <p class="text-sm">Members insisted on enjoying life: Friday Night Candlelight Meetings followed by Denny's, Starbucks after the Saturday 8 PM meeting with guitars and sing-alongs, July 4th at the lake, and Sober Celebrations with live music by Turning Point.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-amber-800">2008-2009: Thriving! <i class="fa-solid fa-star ml-2 text-amber-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The Chaha/Bass Pro location boomed. Birthday nights were Standing Room Only, and the "Luau" themed 14th Anniversary party was a huge success.</p>
                                </div>
                            </div>
                
                            <!-- 2010-2014 -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-amber-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-amber-400 pb-1 mb-2">A New Home</h4>
                                        <p class="text-sm">In July 2010, 48 members attended a Group Conscience to approve the move "Behind Denny's." Work commenced, and the group held an Open House in lieu of an anniversary party after moving on Oct 30.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-amber-800">2010-2014: Service & A New Move <i class="fa-solid fa-briefcase ml-2 text-amber-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Members carried the message to correctional facilities, providing Big Books. The group hosted workshops and remained active in District/Area service.</p>
                                </div>
                            </div>
                
                            <!-- 2015 -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-red-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-red-400 pb-1 mb-2">A Fateful Year</h4>
                                        <p class="text-sm">The decision to find a new home was made at Denny's in June. The lease at 362 Oaks Trail commenced on August 15. The tornado hit on December 26, minutes after attendees had traveled past the heavily damaged I-30/190 interchange.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-red-800">2015: Resilience & Rebirth <i class="fa-solid fa-heart-pulse ml-2 text-red-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Facing decline, four members decided to stick together, finding a new home at Oaks Trail. The year ended with a tornado narrowly missing the group's birthday night.</p>
                                </div>
                            </div>
                
                            <!-- 2016-2019 -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-indigo-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-indigo-400 pb-1 mb-2">Holding Fast</h4>
                                        <p class="text-sm">Though many AAs came and went, the central core of the group held fast. In 2019, the group signed another three-year lease, bringing the total years at Oaks Trail to seven. Overhead remained low and reserves prudent.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-indigo-800">2016-2019: A New Home <i class="fa-solid fa-house-chimney-heart ml-2 text-indigo-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Slow, steady growth continued. A fresh crop of dedicated AAs took hold, and newcomers were getting and staying sober by way of the twelve steps.</p>
                                </div>
                            </div>
                            
                             <!-- 2020 -->
                            <div class="timeline-block left">
                                <div class="timeline-content bg-indigo-50">
                                     <div class="info-popup">
                                        <h4 class="font-bold border-b border-indigo-400 pb-1 mb-2">Digital Fellowship</h4>
                                        <p class="text-sm">To keep members informed during the pandemic lockdown, the "Rowlett Friends of Bill" private Facebook page was created in April.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-indigo-800">2020: The Pandemic Pivot <i class="fa-solid fa-laptop ml-2 text-indigo-500"></i></h2>
                                    <p class="mt-2 text-slate-700">The COVID-19 pandemic led to our first Zoom meeting on April 1. In-person meetings resumed in May, and in June, Tuesday night became a dedicated Newcomer meeting.</p>
                                </div>
                            </div>
                
                            <!-- 2021-Present -->
                            <div class="timeline-block right">
                                <div class="timeline-content bg-green-50">
                                    <div class="info-popup">
                                        <h4 class="font-bold border-b border-green-400 pb-1 mb-2">Anniversary Update</h4>
                                        <p class="text-sm">The 26th Anniversary Party was planned for August 2021, but once again COVID reared its ugly head, forcing the anniversary to be postponed until February 2022.</p>
                                    </div>
                                    <h2 class="text-2xl font-bold text-green-800">2021-Present: Re-Energized! <i class="fa-solid fa-champagne-glasses ml-2 text-green-500"></i></h2>
                                    <p class="mt-2 text-slate-700">Group unity is stronger than ever. Fellowship dinners are popular, and outdoor Birthday Nights are celebrated with enthusiasm by friends and family.</p>
                                </div>
                            </div>
                
                        </div>
                </div>
            </div>
        </section>

        <!-- Analytics Dashboard Section -->
        <section id="analytics-section">
            <h2>Analytics Dashboard</h2>
            <p class="mb-4">Track group engagement, attendance trends, and participation metrics.</p>

            <!-- Attendance Trends -->
            <div class="box mb-4">
                <h3>Attendance Trends Over Time</h3>
                <div class="form-group">
                    <label for="analytics-time-range">Time Range</label>
                    <select id="analytics-time-range" onchange="refreshAnalytics()">
                        <option value="30">Last 30 Days</option>
                        <option value="60">Last 60 Days</option>
                        <option value="90" selected>Last 90 Days</option>
                        <option value="180">Last 6 Months</option>
                        <option value="365">Last Year</option>
                    </select>
                </div>
                <canvas id="attendance-chart" style="max-height: 300px;"></canvas>
            </div>

            <!-- Active Member Engagement -->
            <div class="box mb-4">
                <h3>Active Member Engagement</h3>
                <div id="engagement-metrics" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <!-- Metrics will be inserted here -->
                </div>
            </div>

            <!-- GC Participation Rates -->
            <div class="box mb-4">
                <h3>Group Conscience Participation Rates</h3>
                <div id="gc-participation-stats">
                    <!-- Stats will be inserted here -->
                </div>
                <canvas id="gc-participation-chart" style="max-height: 250px; margin-top: 1rem;"></canvas>
            </div>

            <!-- Service Position Engagement -->
            <div class="box mb-4">
                <h3>Service Position Engagement</h3>
                <div id="service-engagement-stats">
                    <!-- Stats will be inserted here -->
                </div>
            </div>

            <!-- Recent Activity Summary -->
            <div class="box">
                <h3>Recent Activity Summary</h3>
                <div id="activity-summary">
                    <!-- Activity summary will be inserted here -->
                </div>
            </div>
        </section>

        <!-- Literature Library Section -->
        <section id="library-section">
            <h2>Literature Library</h2>
            <p class="mb-4">Manage group-owned literature, lending system, and reading schedules.</p>

            <!-- Add New Literature -->
            <div class="box mb-4">
                <h3>Add New Literature</h3>
                <div id="add-literature-form" style="display: none;">
                    <div class="form-group">
                        <label for="lit-title">Title *</label>
                        <input type="text" id="lit-title" placeholder="Book or pamphlet title" required />
                    </div>
                    <div class="form-group">
                        <label for="lit-type">Type</label>
                        <select id="lit-type">
                            <option value="book">Book</option>
                            <option value="pamphlet">Pamphlet</option>
                            <option value="workbook">Workbook</option>
                            <option value="guidebook">Guidebook</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="lit-format">Format</label>
                        <select id="lit-format">
                            <option value="physical">Physical Copy</option>
                            <option value="digital">Digital (PDF/eBook)</option>
                            <option value="both">Both Physical & Digital</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="lit-copies">Number of Copies</label>
                        <input type="number" id="lit-copies" min="1" value="1" />
                    </div>
                    <div class="form-group">
                        <label for="lit-location">Location/Shelf</label>
                        <input type="text" id="lit-location" placeholder="Where is it stored?" />
                    </div>
                    <div class="form-group">
                        <label for="lit-notes">Notes</label>
                        <textarea id="lit-notes" rows="2" placeholder="Any additional notes..."></textarea>
                    </div>
                    <button class="btn" onclick="saveLiterature()">Save Literature</button>
                    <button class="btn secondary" onclick="toggleLiteratureForm()">Cancel</button>
                </div>
                <button class="btn" onclick="toggleLiteratureForm()" id="show-lit-form-btn">Add New Literature</button>
            </div>

            <!-- Library Catalog -->
            <div class="box mb-4">
                <h3>Library Catalog</h3>
                <div style="margin-bottom: 1rem;">
                    <input type="text" id="library-search" placeholder="Search library..." onkeyup="renderLibraryCatalog()" />
                </div>
                <div id="library-catalog">
                    <!-- Catalog items will be listed here -->
                </div>
            </div>

            <!-- Lending System -->
            <div class="box mb-4">
                <h3>Current Checkouts</h3>
                <div id="current-checkouts">
                    <!-- Active checkouts will be listed here -->
                </div>
            </div>

            <!-- Reading Schedules -->
            <div class="box">
                <h3>Reading Schedules</h3>
                <button class="btn mb-3" onclick="toggleReadingScheduleForm()">Create New Reading Schedule</button>
                <div id="add-reading-schedule-form" style="display: none; margin-bottom: 1rem; padding: 1rem; background: #34495e; border-radius: 6px;">
                    <div class="form-group">
                        <label for="schedule-name">Schedule Name *</label>
                        <input type="text" id="schedule-name" placeholder="e.g., Big Book Study Group" required />
                    </div>
                    <div class="form-group">
                        <label for="schedule-book">Book/Literature</label>
                        <select id="schedule-book">
                            <!-- Will be populated from library -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="schedule-start">Start Date</label>
                        <input type="date" id="schedule-start" />
                    </div>
                    <div class="form-group">
                        <label for="schedule-frequency">Frequency</label>
                        <select id="schedule-frequency">
                            <option value="weekly">Weekly</option>
                            <option value="biweekly">Bi-weekly</option>
                            <option value="monthly">Monthly</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="schedule-notes">Notes/Reading Plan</label>
                        <textarea id="schedule-notes" rows="3" placeholder="Chapters, pages, or topics per session..."></textarea>
                    </div>
                    <button class="btn" onclick="saveReadingSchedule()">Create Schedule</button>
                    <button class="btn secondary" onclick="toggleReadingScheduleForm()">Cancel</button>
                </div>
                <div id="reading-schedules-list">
                    <!-- Reading schedules will be listed here -->
                </div>
            </div>
        </section>

        <!-- Accessibility Features Section -->
        <section id="accessibility-section">
            <h2>Accessibility Settings</h2>
            <p class="mb-4">Customize your viewing experience for better accessibility.</p>

            <!-- Dark Mode Toggle -->
            <div class="box mb-4">
                <h3>Theme Settings</h3>
                <div class="form-group">
                    <label for="theme-mode">Color Theme</label>
                    <select id="theme-mode" onchange="changeTheme()">
                        <option value="dark">Dark Mode (Default)</option>
                        <option value="light">Light Mode</option>
                        <option value="high-contrast">High Contrast</option>
                    </select>
                </div>
                <p style="font-size: 0.9rem; color: #95a5a6; margin-top: 0.5rem;">
                    Choose a theme that works best for your eyes and environment.
                </p>
            </div>

            <!-- Font Size Controls -->
            <div class="box mb-4">
                <h3>Font Size</h3>
                <div class="form-group">
                    <label for="font-size-slider">Text Size: <span id="font-size-display">100%</span></label>
                    <input type="range" id="font-size-slider" min="80" max="150" value="100" step="10"
                           style="width: 100%;" oninput="changeFontSize(this.value)" />
                </div>
                <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn secondary" onclick="changeFontSize(80)">Small</button>
                    <button class="btn secondary" onclick="changeFontSize(100)">Medium</button>
                    <button class="btn secondary" onclick="changeFontSize(120)">Large</button>
                    <button class="btn secondary" onclick="changeFontSize(150)">Extra Large</button>
                </div>
                <p style="font-size: 0.9rem; color: #95a5a6; margin-top: 1rem;">
                    Sample text: The quick brown fox jumps over the lazy dog. 0123456789
                </p>
            </div>

            <!-- Screen Reader Optimization -->
            <div class="box mb-4">
                <h3>Screen Reader Optimization</h3>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="screen-reader-mode" onchange="toggleScreenReaderMode()" />
                        Enable Screen Reader Optimizations
                    </label>
                </div>
                <p style="font-size: 0.9rem; color: #95a5a6; margin-top: 0.5rem;">
                    This mode adds enhanced ARIA labels, skip navigation links, and improved semantic structure for screen readers.
                </p>
            </div>

            <!-- Additional Accessibility Options -->
            <div class="box mb-4">
                <h3>Additional Options</h3>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="reduce-animations" onchange="toggleReduceAnimations()" />
                        Reduce Animations
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="focus-indicators" onchange="toggleFocusIndicators()" />
                        Enhanced Focus Indicators
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="dyslexia-font" onchange="toggleDyslexiaFont()" />
                        Use Dyslexia-Friendly Font
                    </label>
                </div>
            </div>

            <!-- Keyboard Shortcuts Reference -->
            <div class="box">
                <h3>Keyboard Shortcuts</h3>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th style="text-align: left; padding: 0.5rem; border-bottom: 1px solid #3498db;">Action</th>
                            <th style="text-align: left; padding: 0.5rem; border-bottom: 1px solid #3498db;">Shortcut</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="padding: 0.5rem;">Navigate sections</td>
                            <td style="padding: 0.5rem;"><kbd>Tab</kbd> / <kbd>Shift+Tab</kbd></td>
                        </tr>
                        <tr>
                            <td style="padding: 0.5rem;">Activate button/link</td>
                            <td style="padding: 0.5rem;"><kbd>Enter</kbd> or <kbd>Space</kbd></td>
                        </tr>
                        <tr>
                            <td style="padding: 0.5rem;">Close modal</td>
                            <td style="padding: 0.5rem;"><kbd>Esc</kbd></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Settings Section -->
        <section id="settings-section">
            <h2>Settings & Data Management</h2>

            <div class="box mb-4">
                <h3>Group Settings</h3>
                <p class="mb-2">Configure your group's information and meeting details.</p>
                <div class="form-group">
                    <label for="group-qr-code-url">7th Tradition QR Code URL</label>
                    <input type="text" id="group-qr-code-url" placeholder="Enter QR code image URL (Venmo/PayPal/CashApp QR code)" />
                    <small style="font-size: 0.75rem; opacity: 0.8;">Upload your QR code to an image hosting service and paste the URL here, or leave blank to hide.</small>
                </div>
                <div class="form-group">
                    <label for="group-zoom-link">Zoom Meeting Link</label>
                    <input type="text" id="group-zoom-link" placeholder="zoommtg://zoom.us/join?action=join&confno=XXXXX&pwd=XXXXX" />
                    <small style="font-size: 0.75rem; opacity: 0.8;">Your Zoom meeting link. Leave blank to hide the Zoom button.</small>
                </div>
                <div class="form-group">
                    <label for="group-contact-name">Treasurer/Contact Name</label>
                    <input type="text" id="group-contact-name" placeholder="e.g., Nathan D" />
                </div>
                <div class="form-group">
                    <label for="group-contact-phone">Treasurer/Contact Phone</label>
                    <input type="tel" id="group-contact-phone" placeholder="e.g., 214-555-1234" />
                </div>
                <button class="btn" onclick="saveGroupSettings()">Save Group Settings</button>
            </div>

            <div class="box mb-4">
                <h3>User Identity</h3>
                <p class="mb-2">Set your name for messages and read receipts.</p>
                <div class="form-group">
                    <label for="current-user-name">Your Name</label>
                    <input type="text" id="current-user-name" placeholder="Enter your name..." />
                </div>
                <button class="btn" onclick="saveCurrentUser()">Save Name</button>
            </div>

            <div class="box mb-4">
                <h3>Export Data</h3>
                <p class="mb-2">Download your data as a JSON file for backup.</p>
                <button class="btn" onclick="exportData('all')">Export All Data</button>
                <button class="btn secondary" onclick="exportData('events')">Export Events Only</button>
                <button class="btn secondary" onclick="exportData('birthdays')">Export Birthdays Only</button>
                <button class="btn secondary" onclick="exportData('chairpersonLog')">Export Chairperson Log Only</button>
            </div>

            <div class="box mb-4">
                <h3>Import Data</h3>
                <p class="mb-2">Import data from a previously exported JSON file. <strong>Warning:</strong> This will overwrite existing data of the same type.</p>
                <input type="file" id="import-file" accept=".json">
                <button class="btn" onclick="importData()">Import Data</button>
            </div>

            <div class="box mb-4">
                <h3>Automatic Backup & Version History</h3>
                <p class="mb-2">Automatically save snapshots of your data for recovery.</p>
                <button class="btn" onclick="createBackupSnapshot()">Create Backup Snapshot Now</button>
                <button class="btn secondary" onclick="viewBackupHistory()">View Backup History</button>
                <div id="backup-history" style="margin-top: 1rem;"></div>
            </div>

            <div class="box mb-4">
                <h3>Storage Usage Monitor</h3>
                <p class="mb-2">Track your browser's localStorage usage to prevent data loss.</p>
                <div style="padding: 1rem; background: #2c3e50; border-radius: 6px; margin-bottom: 1rem;">
                    <div style="margin-bottom: 0.5rem;">
                        <strong>Used:</strong> <span id="storage-used">0</span> KB / <span id="storage-limit">~5,000</span> KB
                    </div>
                    <div class="vote-progress-bar-bg" style="height: 30px; margin-bottom: 0.5rem;">
                        <div id="storage-progress-bar" class="vote-progress-bar-fill" style="width: 0%; background: linear-gradient(90deg, #27ae60, #2ecc71);"></div>
                    </div>
                    <div id="storage-warning" style="display: none; color: #f39c12; font-weight: bold;">
                        <i class="fas fa-exclamation-triangle"></i> Warning: Storage is over 80% full. Consider exporting and clearing old data.
                    </div>
                    <div id="storage-critical" style="display: none; color: #e74c3c; font-weight: bold;">
                        <i class="fas fa-exclamation-circle"></i> Critical: Storage is nearly full! Export data immediately to prevent loss.
                    </div>
                </div>
                <button class="btn secondary" onclick="checkStorageUsage()">Refresh Storage Info</button>
            </div>

            <div class="box">
                <h3>Cloud Sync (Export to Cloud)</h3>
                <p class="mb-2">Download your data to manually upload to Google Drive, Dropbox, or other cloud storage.</p>
                <button class="btn" onclick="exportForCloud()">Export for Cloud Backup</button>
                <p style="margin-top: 1rem; font-size: 0.85rem; color: #95a5a6;">Note: After exporting, upload the file to your preferred cloud service. To sync across devices, download the file from cloud storage and import it on your other device.</p>
            </div>
        </section>

        <!-- FORMAT ROTATION SECTION -->
        <section id="format-rotation-section">
            <h2>Meeting Format Rotation</h2>
            <p class="mb-4">Manage automated format rotation patterns for weekly meetings.</p>

            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box mb-4">
                        <h3>Current Week's Format</h3>
                        <div id="current-format-display" style="padding: 1.5rem; background: #2c3e50; border-radius: 6px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #3498db;" id="current-format-name">Big Book Study</div>
                            <div style="margin-top: 0.5rem; color: #95a5a6;" id="current-format-week">Week of: <span id="current-week-date"></span></div>
                        </div>
                    </div>

                    <div class="box">
                        <h3>Add/Edit Format</h3>
                        <div class="form-group">
                            <label for="format-name">Format Name</label>
                            <input type="text" id="format-name" placeholder="e.g., Big Book Study, Step Study, Speaker Meeting">
                        </div>
                        <div class="form-group">
                            <label for="format-description">Description</label>
                            <textarea id="format-description" rows="2" placeholder="Brief description..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="format-order">Rotation Order</label>
                            <input type="number" id="format-order" min="1" placeholder="1">
                            <small style="font-size: 0.75rem; opacity: 0.8;">Order in the rotation cycle</small>
                        </div>
                        <input type="hidden" id="format-edit-id">
                        <button id="format-form-btn" class="btn" onclick="handleFormatSubmit()">Add Format</button>
                        <button id="format-form-cancel-btn" class="btn secondary" onclick="cancelFormatEdit()" style="display:none; margin-left: 0.5rem;">Cancel</button>
                    </div>
                </div>

                <div>
                    <div class="box">
                        <h3>Format Rotation Schedule</h3>
                        <table id="format-rotation-table">
                            <thead>
                                <tr>
                                    <th>Order</th>
                                    <th>Format</th>
                                    <th>Description</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="format-rotation-body"></tbody>
                        </table>
                    </div>

                    <div class="box mt-4">
                        <h3>Upcoming Formats (Next 8 Weeks)</h3>
                        <div id="upcoming-formats-list"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- COMMITMENT BOARD SECTION -->
        <section id="commitment-board-section">
            <h2>Meeting Commitment Board</h2>
            <p class="mb-4">Sign-up system for meeting responsibilities with automated reminders.</p>

            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Sign Up for Commitment</h3>
                        <div class="form-group">
                            <label for="commitment-date">Meeting Date</label>
                            <input type="date" id="commitment-date">
                        </div>
                        <div class="form-group">
                            <label for="commitment-role">Responsibility</label>
                            <select id="commitment-role">
                                <option value="greeter">Greeter</option>
                                <option value="coffee">Coffee Maker</option>
                                <option value="setup">Setup</option>
                                <option value="cleanup">Cleanup</option>
                                <option value="secretary">Secretary</option>
                                <option value="treasurer">Treasurer Report</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="commitment-member">Member Name</label>
                            <select id="commitment-member"></select>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="commitment-reminder" checked>
                                Send reminder notification
                            </label>
                        </div>
                        <input type="hidden" id="commitment-edit-id">
                        <button id="commitment-form-btn" class="btn" onclick="handleCommitmentSubmit()">Sign Up</button>
                        <button id="commitment-form-cancel-btn" class="btn secondary" onclick="cancelCommitmentEdit()" style="display:none; margin-left: 0.5rem;">Cancel</button>
                    </div>
                </div>

                <div>
                    <div class="box">
                        <h3>This Week's Commitments</h3>
                        <div id="current-week-commitments"></div>
                    </div>

                    <div class="box mt-4">
                        <h3>Upcoming Commitments</h3>
                        <table id="commitment-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Role</th>
                                    <th>Member</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="commitment-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECRETARY FUNCTIONS SECTION -->
        <section id="secretary-section">
            <h2>Meeting Secretary Functions</h2>
            <p class="mb-4">Attendance tracking, automated minutes, and meeting statistics.</p>

            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Take Attendance</h3>
                        <div class="form-group">
                            <label for="attendance-date">Meeting Date</label>
                            <input type="date" id="attendance-date">
                        </div>
                        <div class="form-group">
                            <label for="attendance-members">Members Present</label>
                            <select multiple id="attendance-members" style="height: 200px; background: #34495e; color: #ecf0f1; border: 1px solid #7f8c8d; border-radius: 4px; padding: 0.5rem; width: 100%;"></select>
                            <small style="font-size: 0.75rem; opacity: 0.8;">Hold Ctrl/Cmd to select multiple</small>
                        </div>
                        <div class="form-group">
                            <label for="attendance-visitors">Visitors/Newcomers</label>
                            <input type="number" id="attendance-visitors" min="0" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label for="attendance-oldtimers">Old-Timers (10+ years)</label>
                            <div id="attendance-oldtimers-list"></div>
                        </div>
                        <button class="btn" onclick="handleAttendanceSubmit()">Save Attendance</button>
                        <button class="btn secondary" onclick="generateMinutes()" style="margin-left: 0.5rem;">Generate Minutes</button>
                    </div>
                </div>

                <div>
                    <div class="box">
                        <h3>Meeting Statistics</h3>
                        <div id="attendance-stats" style="padding: 1rem; background: #2c3e50; border-radius: 6px;">
                            <div class="mb-2"><strong>Average Attendance:</strong> <span id="avg-attendance">0</span></div>
                            <div class="mb-2"><strong>Regular Members:</strong> <span id="regular-members">0</span></div>
                            <div class="mb-2"><strong>This Month's Visitors:</strong> <span id="monthly-visitors">0</span></div>
                            <div class="mb-2"><strong>Recognized Old-Timers:</strong> <span id="oldtimer-count">0</span></div>
                        </div>
                    </div>

                    <div class="box mt-4">
                        <h3>Recent Attendance</h3>
                        <table id="attendance-history-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Members</th>
                                    <th>Visitors</th>
                                    <th>Total</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="attendance-history-body"></tbody>
                        </table>
                    </div>

                    <div class="box mt-4">
                        <h3>Generated Minutes</h3>
                        <div id="meeting-minutes-preview" style="padding: 1rem; background: #2c3e50; border-radius: 6px; white-space: pre-wrap; font-family: monospace; font-size: 0.85rem;"></div>
                        <button class="btn mt-2" onclick="exportMinutesToPDF()">Export to PDF</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- GC LIVE SESSION (moved from chairperson) -->
        <section id="gc-live-section">
            <h2>Live Group Conscience Session</h2>
            <p class="mb-4">Real-time motion tracking during Group Conscience meetings.</p>

            <div class="box">
                <h3>New Business / Open Motions</h3>
                <div class="form-group">
                    <label for="live-gc-new-item">New Item</label>
                    <textarea id="live-gc-new-item" rows="2" placeholder="Describe the new business item or motion..."></textarea>
                </div>
                <button class="btn" onclick="addLiveGCItem()">Add to Queue</button>
            </div>

            <div class="box mt-4">
                <h3>Active Motions Queue</h3>
                <table id="live-gc-queue-table">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="live-gc-queue-body"></tbody>
                </table>
            </div>
        </section>

        <!-- GC DECISION HISTORY & REFERENCE SECTION -->
        <section id="gc-decisions-section">
            <h2>Group Conscience Decision History</h2>
            <p class="mb-4">Link related motions, track amendments, and view full motion history chains.</p>

            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Search Decisions</h3>
                        <div class="form-group">
                            <label for="gc-search">Search by keyword, topic, or date</label>
                            <input type="text" id="gc-search" placeholder="Search decisions...">
                        </div>
                        <div class="form-group">
                            <label for="gc-filter-status">Filter by Status</label>
                            <select id="gc-filter-status">
                                <option value="all">All Decisions</option>
                                <option value="passed">Passed</option>
                                <option value="failed">Failed</option>
                                <option value="tabled">Tabled</option>
                                <option value="amended">Amended</option>
                                <option value="superseded">Superseded</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="gc-filter-year">Filter by Year</label>
                            <select id="gc-filter-year">
                                <option value="all">All Years</option>
                            </select>
                        </div>
                        <button class="btn" onclick="searchGCDecisions()">Search</button>
                    </div>

                    <div class="box mt-4">
                        <h3>Link Related Motions</h3>
                        <div class="form-group">
                            <label for="gc-link-primary">Primary Motion</label>
                            <select id="gc-link-primary"></select>
                        </div>
                        <div class="form-group">
                            <label for="gc-link-related">Related Motion</label>
                            <select id="gc-link-related"></select>
                        </div>
                        <div class="form-group">
                            <label for="gc-link-type">Relationship Type</label>
                            <select id="gc-link-type">
                                <option value="amends">Amends</option>
                                <option value="supersedes">Supersedes</option>
                                <option value="related">Related To</option>
                                <option value="implements">Implements</option>
                            </select>
                        </div>
                        <button class="btn" onclick="linkGCMotions()">Link Motions</button>
                    </div>
                </div>

                <div>
                    <div class="box">
                        <h3>Decision History</h3>
                        <div id="gc-decisions-list" style="max-height: 600px; overflow-y: auto;"></div>
                    </div>

                    <div class="box mt-4">
                        <h3>Motion Chain Viewer</h3>
                        <p style="font-size: 0.85rem; margin-bottom: 1rem;">Click any motion to view its full history chain</p>
                        <div id="motion-chain-display" style="padding: 1rem; background: #2c3e50; border-radius: 6px;"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- GC INVENTORY SECTION -->
        <section id="gc-inventory-section">
            <h2>Group Conscience Inventory</h2>
            <p class="mb-4">Tradition inventory questions, Concept templates, and anonymous feedback collection.</p>

            <div class="box mb-4">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3>Select Inventory Type</h3>
                    <button class="btn secondary" onclick="exportInventoryResults()">Export Results</button>
                </div>
                <div class="form-group">
                    <select id="inventory-type" onchange="loadInventoryTemplate()">
                        <option value="">-- Select Type --</option>
                        <option value="traditions">12 Traditions Inventory</option>
                        <option value="concepts">12 Concepts Inventory</option>
                        <option value="group-health">Group Health Check</option>
                        <option value="annual">Annual Group Inventory</option>
                    </select>
                </div>
            </div>

            <div id="inventory-questions-container"></div>

            <div class="box mt-4">
                <h3>Anonymous Feedback</h3>
                <p style="font-size: 0.85rem; margin-bottom: 1rem;">Members can submit anonymous feedback about group health</p>
                <div class="form-group">
                    <label for="anonymous-feedback-text">Your Anonymous Feedback</label>
                    <textarea id="anonymous-feedback-text" rows="4" placeholder="Share your thoughts about group health, traditions, or concerns..."></textarea>
                </div>
                <button class="btn" onclick="submitAnonymousFeedback()">Submit Anonymously</button>
            </div>

            <div class="box mt-4">
                <h3>Collected Feedback</h3>
                <div id="anonymous-feedback-list"></div>
            </div>
        </section>

        <!-- GC BY-LAWS SECTION -->
        <section id="gc-bylaws-section">
            <h2>Group Guidelines & By-Laws Repository</h2>
            <p class="mb-4">Store group documents with version control and amendment tracking.</p>

            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Add/Update Document</h3>
                        <div class="form-group">
                            <label for="bylaw-title">Document Title</label>
                            <input type="text" id="bylaw-title" placeholder="e.g., Group Guidelines, By-Laws">
                        </div>
                        <div class="form-group">
                            <label for="bylaw-version">Version</label>
                            <input type="text" id="bylaw-version" placeholder="e.g., 1.0, 2.1">
                        </div>
                        <div class="form-group">
                            <label for="bylaw-content">Document Content</label>
                            <textarea id="bylaw-content" rows="10" placeholder="Enter the full text of the document..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="bylaw-amendment-notes">Amendment Notes</label>
                            <textarea id="bylaw-amendment-notes" rows="2" placeholder="What changed in this version?"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="bylaw-effective-date">Effective Date</label>
                            <input type="date" id="bylaw-effective-date">
                        </div>
                        <input type="hidden" id="bylaw-edit-id">
                        <button id="bylaw-form-btn" class="btn" onclick="handleByLawSubmit()">Save Document</button>
                        <button id="bylaw-form-cancel-btn" class="btn secondary" onclick="cancelByLawEdit()" style="display:none; margin-left: 0.5rem;">Cancel</button>
                    </div>
                </div>

                <div>
                    <div class="box">
                        <h3>Current Documents</h3>
                        <div id="bylaws-current-list"></div>
                    </div>

                    <div class="box mt-4">
                        <h3>Version History</h3>
                        <table id="bylaws-history-table">
                            <thead>
                                <tr>
                                    <th>Document</th>
                                    <th>Version</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="bylaws-history-body"></tbody>
                        </table>
                    </div>

                    <div class="box mt-4">
                        <h3>Generate PDF</h3>
                        <div class="form-group">
                            <label for="pdf-document-select">Select Document</label>
                            <select id="pdf-document-select"></select>
                        </div>
                        <button class="btn" onclick="generateByLawPDF()">Generate PDF</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- SPONSORSHIP TRACKING SECTION -->
        <section id="sponsorship-section">
            <h2>Sponsorship Tracking</h2>
            <p class="mb-4">Track sponsorship relationships with tree visualization and service sponsorship.</p>

            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Add Sponsorship Relationship</h3>
                        <div class="form-group">
                            <label for="sponsor-name">Sponsor</label>
                            <select id="sponsor-name"></select>
                        </div>
                        <div class="form-group">
                            <label for="sponsee-name">Sponsee</label>
                            <select id="sponsee-name"></select>
                        </div>
                        <div class="form-group">
                            <label for="sponsorship-type">Type</label>
                            <select id="sponsorship-type">
                                <option value="program">Program Sponsorship</option>
                                <option value="service">Service Sponsorship</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="sponsorship-start-date">Start Date</label>
                            <input type="date" id="sponsorship-start-date">
                        </div>
                        <div class="form-group" id="step-progress-group" style="display: none;">
                            <label for="current-step">Current Step (Optional)</label>
                            <select id="current-step">
                                <option value="">Not tracking</option>
                                <option value="1">Step 1</option>
                                <option value="2">Step 2</option>
                                <option value="3">Step 3</option>
                                <option value="4">Step 4</option>
                                <option value="5">Step 5</option>
                                <option value="6">Step 6</option>
                                <option value="7">Step 7</option>
                                <option value="8">Step 8</option>
                                <option value="9">Step 9</option>
                                <option value="10">Step 10</option>
                                <option value="11">Step 11</option>
                                <option value="12">Step 12</option>
                            </select>
                        </div>
                        <input type="hidden" id="sponsorship-edit-id">
                        <button id="sponsorship-form-btn" class="btn" onclick="handleSponsorshipSubmit()">Add Relationship</button>
                        <button id="sponsorship-form-cancel-btn" class="btn secondary" onclick="cancelSponsorshipEdit()" style="display:none; margin-left: 0.5rem;">Cancel</button>
                    </div>
                </div>

                <div>
                    <div class="box">
                        <h3>Sponsorship Tree Visualization</h3>
                        <div id="sponsorship-tree" style="min-height: 400px; padding: 1rem; background: #2c3e50; border-radius: 6px; overflow-x: auto;"></div>
                    </div>

                    <div class="box mt-4">
                        <h3>Sponsorship List</h3>
                        <table id="sponsorship-table">
                            <thead>
                                <tr>
                                    <th>Sponsor</th>
                                    <th>Sponsee</th>
                                    <th>Type</th>
                                    <th>Start Date</th>
                                    <th>Progress</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="sponsorship-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- DISTRICT/AREA INTEGRATION SECTION -->
        <section id="district-area-section">
            <h2>District/Area Committee Integration</h2>
            <p class="mb-4">GSR reports, district meeting schedules, and area assembly tracking.</p>

            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Log GSR Report</h3>
                        <div class="form-group">
                            <label for="gsr-report-date">Meeting Date</label>
                            <input type="date" id="gsr-report-date">
                        </div>
                        <div class="form-group">
                            <label for="gsr-meeting-type">Meeting Type</label>
                            <select id="gsr-meeting-type">
                                <option value="district">District Meeting</option>
                                <option value="area">Area Assembly</option>
                                <option value="special">Special Meeting</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="gsr-report-content">Report Summary</label>
                            <textarea id="gsr-report-content" rows="5" placeholder="Summarize key points, motions, and announcements..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="gsr-action-items">Action Items</label>
                            <textarea id="gsr-action-items" rows="3" placeholder="Any action items for the group..."></textarea>
                        </div>
                        <input type="hidden" id="gsr-report-edit-id">
                        <button id="gsr-report-form-btn" class="btn" onclick="handleGSRReportSubmit()">Save Report</button>
                        <button id="gsr-report-form-cancel-btn" class="btn secondary" onclick="cancelGSRReportEdit()" style="display:none; margin-left: 0.5rem;">Cancel</button>
                    </div>

                    <div class="box mt-4">
                        <h3>District Meeting Schedule</h3>
                        <div class="form-group">
                            <label for="district-schedule-date">Meeting Date</label>
                            <input type="date" id="district-schedule-date">
                        </div>
                        <div class="form-group">
                            <label for="district-schedule-time">Time</label>
                            <input type="time" id="district-schedule-time">
                        </div>
                        <div class="form-group">
                            <label for="district-schedule-location">Location</label>
                            <input type="text" id="district-schedule-location" placeholder="Meeting location">
                        </div>
                        <button class="btn" onclick="addDistrictMeeting()">Add to Schedule</button>
                    </div>
                </div>

                <div>
                    <div class="box">
                        <h3>Recent GSR Reports</h3>
                        <div id="gsr-reports-list" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>

                    <div class="box mt-4">
                        <h3>Upcoming District/Area Meetings</h3>
                        <div id="district-meetings-list"></div>
                    </div>

                    <div class="box mt-4">
                        <h3>DCM Communication Log</h3>
                        <div class="form-group">
                            <label for="dcm-comm-date">Date</label>
                            <input type="date" id="dcm-comm-date">
                        </div>
                        <div class="form-group">
                            <label for="dcm-comm-content">Communication</label>
                            <textarea id="dcm-comm-content" rows="3" placeholder="Log communication with DCM..."></textarea>
                        </div>
                        <button class="btn" onclick="addDCMCommunication()">Add Entry</button>
                        <div id="dcm-comm-history" class="mt-4"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- PRUDENT RESERVE SECTION -->
        <section id="prudent-reserve-section">
            <h2>Financial Prudent Reserve Tracking</h2>
            <p class="mb-4">Set reserve targets, visualize operational vs reserve balance, and track trends.</p>

            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Prudent Reserve Settings</h3>
                        <div class="form-group">
                            <label for="reserve-target">Target Reserve Amount ($)</label>
                            <input type="number" id="reserve-target" step="0.01" placeholder="0.00">
                            <small style="font-size: 0.75rem; opacity: 0.8;">Recommended: 3-6 months of operating expenses</small>
                        </div>
                        <div class="form-group">
                            <label for="monthly-expenses">Estimated Monthly Expenses ($)</label>
                            <input type="number" id="monthly-expenses" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label for="reserve-months">Reserve Target (Months)</label>
                            <input type="number" id="reserve-months" min="1" max="12" value="3">
                        </div>
                        <button class="btn" onclick="calculateReserveTarget()">Calculate Target</button>
                        <button class="btn secondary" onclick="saveReserveSettings()" style="margin-left: 0.5rem;">Save Settings</button>
                    </div>

                    <div class="box mt-4">
                        <h3>Current Financial Status</h3>
                        <div id="reserve-status" style="padding: 1rem; background: #2c3e50; border-radius: 6px;">
                            <div class="mb-2"><strong>Total Balance:</strong> $<span id="total-balance">0.00</span></div>
                            <div class="mb-2"><strong>Prudent Reserve:</strong> $<span id="current-reserve">0.00</span></div>
                            <div class="mb-2"><strong>Operating Balance:</strong> $<span id="operating-balance">0.00</span></div>
                            <div class="mb-2"><strong>Reserve Target:</strong> $<span id="display-reserve-target">0.00</span></div>
                            <div class="mb-2"><strong>Status:</strong> <span id="reserve-health-status">--</span></div>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="box">
                        <h3>Reserve vs Operating Balance</h3>
                        <canvas id="reserve-balance-chart" style="max-height: 300px;"></canvas>
                    </div>

                    <div class="box mt-4">
                        <h3>7th Tradition Trend Analysis</h3>
                        <canvas id="seventh-tradition-trend-chart" style="max-height: 300px;"></canvas>
                    </div>

                    <div class="box mt-4">
                        <h3>Contribution Source Breakdown</h3>
                        <canvas id="contribution-source-chart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- 7TH TRADITION ANALYSIS SECTION -->
        <section id="seventh-tradition-section">
            <h2>7th Tradition Analysis</h2>
            <p class="mb-4">Detailed analysis of contribution patterns and trends.</p>

            <div class="box mb-4">
                <h3>Contribution Trends</h3>
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                    <button class="btn" onclick="load7thTraditionPeriod('weekly')">Weekly</button>
                    <button class="btn" onclick="load7thTraditionPeriod('monthly')">Monthly</button>
                    <button class="btn" onclick="load7thTraditionPeriod('quarterly')">Quarterly</button>
                    <button class="btn" onclick="load7thTraditionPeriod('yearly')">Yearly</button>
                </div>
                <canvas id="seventh-tradition-detail-chart"></canvas>
            </div>

            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div class="box">
                    <h3>Statistics</h3>
                    <div id="seventh-tradition-stats">
                        <div class="mb-2"><strong>Average per Meeting:</strong> $<span id="avg-per-meeting">0.00</span></div>
                        <div class="mb-2"><strong>Highest Contribution:</strong> $<span id="highest-contribution">0.00</span></div>
                        <div class="mb-2"><strong>Lowest Contribution:</strong> $<span id="lowest-contribution">0.00</span></div>
                        <div class="mb-2"><strong>YTD Total:</strong> $<span id="ytd-total">0.00</span></div>
                        <div class="mb-2"><strong>Trend:</strong> <span id="contribution-trend">--</span></div>
                    </div>
                </div>

                <div class="box">
                    <h3>Goals & Targets</h3>
                    <div class="form-group">
                        <label for="contribution-goal">Monthly Contribution Goal ($)</label>
                        <input type="number" id="contribution-goal" step="0.01" placeholder="0.00">
                    </div>
                    <button class="btn" onclick="saveContributionGoal()">Save Goal</button>
                    <div id="goal-progress" class="mt-4"></div>
                </div>
            </div>
        </section>

        <!-- CHIP INVENTORY SECTION -->
        <section id="chip-inventory-section">
            <h2>Sobriety Chip Inventory</h2>
            <p class="mb-4">Track chip stock levels, set low stock alerts, and log distributions.</p>

            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <div class="box">
                        <h3>Update Chip Inventory</h3>
                        <div class="form-group">
                            <label for="chip-type">Chip Type</label>
                            <select id="chip-type">
                                <option value="24-hour">24 Hours (White)</option>
                                <option value="30-day">30 Days (Red)</option>
                                <option value="60-day">60 Days (Gold)</option>
                                <option value="90-day">90 Days (Green)</option>
                                <option value="6-month">6 Months (Blue)</option>
                                <option value="9-month">9 Months (Purple)</option>
                                <option value="1-year">1 Year (Bronze)</option>
                                <option value="18-month">18 Months</option>
                                <option value="multi-year">Multi-Year</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="chip-quantity">Current Quantity</label>
                            <input type="number" id="chip-quantity" min="0" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label for="chip-low-threshold">Low Stock Alert Threshold</label>
                            <input type="number" id="chip-low-threshold" min="0" placeholder="5">
                        </div>
                        <button class="btn" onclick="updateChipInventory()">Update Inventory</button>
                    </div>

                    <div class="box mt-4">
                        <h3>Log Chip Distribution</h3>
                        <div class="form-group">
                            <label for="dist-chip-type">Chip Type</label>
                            <select id="dist-chip-type">
                                <option value="24-hour">24 Hours</option>
                                <option value="30-day">30 Days</option>
                                <option value="60-day">60 Days</option>
                                <option value="90-day">90 Days</option>
                                <option value="6-month">6 Months</option>
                                <option value="9-month">9 Months</option>
                                <option value="1-year">1 Year</option>
                                <option value="18-month">18 Months</option>
                                <option value="multi-year">Multi-Year</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="dist-recipient">Recipient (Optional)</label>
                            <input type="text" id="dist-recipient" placeholder="Name">
                        </div>
                        <div class="form-group">
                            <label for="dist-date">Date</label>
                            <input type="date" id="dist-date">
                        </div>
                        <button class="btn" onclick="logChipDistribution()">Log Distribution</button>
                    </div>
                </div>

                <div>
                    <div class="box">
                        <h3>Current Inventory Status</h3>
                        <table id="chip-inventory-table">
                            <thead>
                                <tr>
                                    <th>Chip Type</th>
                                    <th>Quantity</th>
                                    <th>Status</th>
                                    <th>Alert Threshold</th>
                                </tr>
                            </thead>
                            <tbody id="chip-inventory-body"></tbody>
                        </table>
                    </div>

                    <div class="box mt-4">
                        <h3>Low Stock Alerts</h3>
                        <div id="chip-alerts"></div>
                    </div>

                    <div class="box mt-4">
                        <h3>Recent Distributions</h3>
                        <table id="chip-distribution-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Chip Type</th>
                                    <th>Recipient</th>
                                </tr>
                            </thead>
                            <tbody id="chip-distribution-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Member Roster Modal -->
    <!-- GC Details Modal with Discussion/Comments -->
    <div id="gc-details-modal" class="modal">
        <div class="box" style="width: 90%; max-width: 900px; max-height: 90vh; overflow-y: auto; background: #2c3e50; color: #ecf0f1; border: 1px solid #3498db;">
            <span class="modal-close" onclick="closeGCDetailsModal()">&times;</span>
            <h2 style="color: #3498db;">Motion Details & Discussion</h2>
            <div id="gc-details-content" style="margin: 1rem 0;">
                <!-- Motion details will be inserted here -->
            </div>

            <div style="margin-top: 2rem;">
                <h3 style="color: #3498db; margin-bottom: 1rem;">Discussion & Comments</h3>
                <div id="gc-comments-list" style="max-height: 300px; overflow-y: auto; margin-bottom: 1rem; padding: 0.5rem; background: #34495e; border-radius: 6px;">
                    <!-- Comments will be listed here -->
                </div>

                <div class="form-group">
                    <label for="gc-comment-text">Add Comment</label>
                    <textarea id="gc-comment-text" rows="3" placeholder="Add your comment or discussion note..."></textarea>
                </div>
                <div class="form-group">
                    <label for="gc-comment-author">Your Name</label>
                    <input type="text" id="gc-comment-author" placeholder="Name">
                </div>
                <div class="form-group">
                    <label for="gc-comment-type">Comment Type</label>
                    <select id="gc-comment-type">
                        <option value="discussion">Discussion Note</option>
                        <option value="amendment">Proposed Amendment</option>
                        <option value="clarification">Clarification</option>
                        <option value="support">Support Statement</option>
                        <option value="concern">Concern/Opposition</option>
                    </select>
                </div>
                <button class="btn" onclick="addGCComment()">Add Comment</button>
                <button class="btn secondary" onclick="closeGCDetailsModal()" style="margin-left: 0.5rem;">Close</button>
            </div>
        </div>
    </div>

    <div id="roster-modal" class="modal">
        <div class="box" style="width: 90%; max-width: 1200px; max-height: 90vh; overflow-y: auto; background: #2c3e50; color: #ecf0f1; border: 1px solid #3498db;">
            <span class="modal-close" onclick="closeRosterModal()">&times;</span>
            <h2 style="color: #3498db;">Full Member Roster</h2>
            <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                <input type="text" id="roster-search" onkeyup="renderRosterTable()" placeholder="Search by name, email, phone..." style="flex-grow: 1;" />
                <button class="btn" onclick="openMemberFormFromModal()">Add New Member</button>
            </div>
            <div style="overflow-x: auto;">
                <table id="roster-table">
                    <thead>
                        <tr>
                            <th onclick="sortRosterBy('name')" style="cursor: pointer;">Name &#x2195;</th>
                            <th onclick="sortRosterBy('city')" style="cursor: pointer;">City &#x2195;</th>
                            <th onclick="sortRosterBy('homegroup')" style="cursor: pointer;">Homegroup &#x2195;</th>
                            <th>Phone</th>
                            <th>Email</th>
                            <th onclick="sortRosterBy('isServant')" style="cursor: pointer;">Servant? &#x2195;</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="roster-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Embed the application script directly into this file -->
    <script>
// Utility to generate unique IDs based on timestamp
function genId() {
    return Date.now().toString() + Math.random().toString(36).substring(2);
}

// Sanitize user input to prevent XSS attacks
function sanitizeInput(input) {
    if (typeof input !== 'string') return input;
    // Use DOMPurify if available, otherwise basic escaping
    if (typeof DOMPurify !== 'undefined') {
        return DOMPurify.sanitize(input, { ALLOWED_TAGS: [] });
    }
    // Fallback: basic HTML entity encoding
    const div = document.createElement('div');
    div.textContent = input;
    return div.innerHTML;
}

// Sanitize HTML content (for rich text that needs some HTML)
function sanitizeHTML(html) {
    if (typeof html !== 'string') return html;
    if (typeof DOMPurify !== 'undefined') {
        return DOMPurify.sanitize(html, {
            ALLOWED_TAGS: ['b', 'i', 'em', 'strong', 'br', 'p', 'ul', 'ol', 'li'],
            ALLOWED_ATTR: []
        });
    }
    return sanitizeInput(html);
}

// Navigate to a given section and update nav active states
function goToSection(sectionId) {
    // Remove active class from all sections and nav items
    document.querySelectorAll('main section').forEach(sec => sec.classList.remove('active'));
    document.querySelectorAll('nav li').forEach(li => li.classList.remove('active'));

    // Add active class to target section
    const section = document.getElementById(sectionId);
    if (section) {
        section.classList.add('active');
    } else {
        console.warn('Section not found:', sectionId);
        return;
    }

    // Add active class to corresponding nav item
    const navItem = document.querySelector('nav li[data-section="' + sectionId + '"]');
    if (navItem) {
        navItem.classList.add('active');
    }

    // Scroll to top of main content
    const mainEl = document.querySelector('main');
    if (mainEl) {
        mainEl.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Close all dropdowns after navigation
    document.querySelectorAll('nav li.has-dropdown').forEach(dd => {
        dd.classList.remove('dropdown-open');
    });

    // Section-specific initialization
    if (sectionId === 'schedule-section') {
        renderCalendar();
    } else if (sectionId === 'analytics-section') {
        refreshAnalytics();
    } else if (sectionId === 'library-section') {
        renderLibraryCatalog();
        renderCurrentCheckouts();
        renderReadingSchedules();
    } else if (sectionId === 'birthdays-section') {
        updateBirthdaysTable();
    } else if (sectionId === 'announcements-section') {
        updateAnnouncementsList();
    }
}
// Toggle form visibility
function toggleEventForm() {
    const form = document.getElementById('add-event-form');
    if (!form) return;
    const isVisible = form.style.display === 'block';
    form.style.display = isVisible ? 'none' : 'block';
}

function toggleMemberForm() {
    const form = document.getElementById('add-member-form');
    if (!form) return;
    const isVisible = form.style.display === 'block';
    form.style.display = isVisible ? 'none' : 'block';
}
// Toast Notification
function showToast(message, type = 'info') { // type can be 'info', 'success', or 'error'
    const container = document.getElementById('toast-container');
    if (!container) return;
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    container.appendChild(toast);

    // Animate in
    setTimeout(() => {
        toast.classList.add('show');
    }, 100);

    // Animate out and remove
    setTimeout(() => {
        toast.classList.remove('show');
        toast.addEventListener('transitionend', () => {
            toast.remove();
        }, { once: true }); // Use once option to prevent multiple fires
    }, 3000); // Toast disappears after 3 seconds
}

// Input validation utilities
function validateEmail(email) {
    if (!email) return true; // Empty email is allowed
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}

function validatePhone(phone) {
    if (!phone) return true; // Empty phone is allowed
    // Accepts formats: 123-456-7890, (123) 456-7890, 123.456.7890, 1234567890
    const phoneRegex = /^[\d\s\-\(\)\.]+$/;
    return phoneRegex.test(phone) && phone.replace(/\D/g, '').length >= 10;
}

// HTML/attribute escaping utilities
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function escapeAttribute(value) {
    if (typeof value !== 'string') value = String(value);
    return value.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
}

// LocalStorage quota monitoring utilities
function getLocalStorageSize() {
    let total = 0;
    for (let key in localStorage) {
        if (localStorage.hasOwnProperty(key)) {
            total += localStorage[key].length + key.length;
        }
    }
    return total;
}

function checkLocalStorageQuota() {
    try {
        const currentSize = getLocalStorageSize();
        const estimatedLimit = 5 * 1024 * 1024; // 5MB typical limit
        const usagePercent = (currentSize / estimatedLimit) * 100;

        if (usagePercent > 90) {
            showToast(`Warning: localStorage is ${usagePercent.toFixed(1)}% full. Consider exporting and archiving old data.`, 'error');
            return false;
        } else if (usagePercent > 75) {
            showToast(`Notice: localStorage is ${usagePercent.toFixed(1)}% full.`, 'warning');
        }
        return true;
    } catch (e) {
        showToast('Error checking storage quota: ' + e.message, 'error');
        return false;
    }
}

function safeLocalStorageSet(key, value) {
    try {
        localStorage.setItem(key, value);
        return true;
    } catch (e) {
        if (e.name === 'QuotaExceededError' || e.code === 22) {
            const sizeKB = (getLocalStorageSize() / 1024).toFixed(2);
            showToast(`Storage quota exceeded! Current usage: ${sizeKB}KB. Please export and delete old data.`, 'error');
            return false;
        }
        throw e;
    }
}

// Storage wrappers using localStorage with error handling
const storage = {
    getEvents() {
        try { return JSON.parse(localStorage.getItem('events') || '[]'); }
        catch(e) { console.error('Error parsing events:', e); return []; }
    },
    saveEvents(events) { localStorage.setItem('events', JSON.stringify(events)); },
    getMembers() {
        try { return JSON.parse(localStorage.getItem('members') || '[]'); }
        catch(e) { console.error('Error parsing members:', e); return []; }
    },
    saveMembers(m) { localStorage.setItem('members', JSON.stringify(m)); },
    getAnnouncements() {
        try { return JSON.parse(localStorage.getItem('announcements') || '[]'); }
        catch(e) { console.error('Error parsing announcements:', e); return []; }
    },
    saveAnnouncements(a) { localStorage.setItem('announcements', JSON.stringify(a)); },
    getPhotos() {
        try { return JSON.parse(localStorage.getItem('photos') || '[]'); }
        catch(e) { console.error('Error parsing photos:', e); return []; }
    },
    savePhotos(p) {
        const jsonStr = JSON.stringify(p);
        if (!safeLocalStorageSet('photos', jsonStr)) {
            throw new Error('Failed to save photos due to storage quota exceeded');
        }
    },
    getChairpersonLog() {
        try { return JSON.parse(localStorage.getItem('chairpersonLog') || '[]'); }
        catch(e) { console.error('Error parsing chairpersonLog:', e); return []; }
    },
    saveChairpersonLog(log) { localStorage.setItem('chairpersonLog', JSON.stringify(log)); },
    getGroupConscienceLog() {
        try { return JSON.parse(localStorage.getItem('groupConscienceLog') || '[]'); }
        catch(e) { console.error('Error parsing groupConscienceLog:', e); return []; }
    },
    saveGroupConscienceLog(log) { localStorage.setItem('groupConscienceLog', JSON.stringify(log)); },
    getLiveGCItems() {
        try { return JSON.parse(localStorage.getItem('liveGCItems') || '[]'); }
        catch(e) { console.error('Error parsing liveGCItems:', e); return []; }
    },
    saveLiveGCItems(items) { localStorage.setItem('liveGCItems', JSON.stringify(items)); },
    getProposedAgendaItems() {
        try { return JSON.parse(localStorage.getItem('proposedAgendaItems') || '[]'); }
        catch(e) { console.error('Error parsing proposedAgendaItems:', e); return []; }
    },
    saveProposedAgendaItems(items) { localStorage.setItem('proposedAgendaItems', JSON.stringify(items)); },
    getGCComments() {
        try { return JSON.parse(localStorage.getItem('gcComments') || '[]'); }
        catch(e) { console.error('Error parsing gcComments:', e); return []; }
    },
    saveGCComments(comments) { localStorage.setItem('gcComments', JSON.stringify(comments)); },
    getGCActionItems() {
        try { return JSON.parse(localStorage.getItem('gcActionItems') || '[]'); }
        catch(e) { console.error('Error parsing gcActionItems:', e); return []; }
    },
    saveGCActionItems(actions) { localStorage.setItem('gcActionItems', JSON.stringify(actions)); },
    getGCSettings() {
        try { return JSON.parse(localStorage.getItem('gcSettings') || '{"quorumPercentage": 50, "quorumMinimum": 5}'); }
        catch(e) { console.error('Error parsing gcSettings:', e); return {"quorumPercentage": 50, "quorumMinimum": 5}; }
    },
    saveGCSettings(settings) { localStorage.setItem('gcSettings', JSON.stringify(settings)); },

    // New feature storage methods
    getMessages() {
        try { return JSON.parse(localStorage.getItem('messages') || '[]'); }
        catch(e) { console.error('Error parsing messages:', e); return []; }
    },
    saveMessages(messages) { localStorage.setItem('messages', JSON.stringify(messages)); },
    getServicePositions() {
        try { return JSON.parse(localStorage.getItem('servicePositions') || '[]'); }
        catch(e) { console.error('Error parsing servicePositions:', e); return []; }
    },
    saveServicePositions(positions) { localStorage.setItem('servicePositions', JSON.stringify(positions)); },
    getNominations() {
        try { return JSON.parse(localStorage.getItem('nominations') || '[]'); }
        catch(e) { console.error('Error parsing nominations:', e); return []; }
    },
    saveNominations(nominations) { localStorage.setItem('nominations', JSON.stringify(nominations)); },
    getBudgetCategories() {
        try { return JSON.parse(localStorage.getItem('budgetCategories') || '[]'); }
        catch(e) { console.error('Error parsing budgetCategories:', e); return []; }
    },
    saveBudgetCategories(categories) { localStorage.setItem('budgetCategories', JSON.stringify(categories)); },
    getExpenses() {
        try { return JSON.parse(localStorage.getItem('expenses') || '[]'); }
        catch(e) { console.error('Error parsing expenses:', e); return []; }
    },
    saveExpenses(expenses) { localStorage.setItem('expenses', JSON.stringify(expenses)); },
    getTemplates() {
        try { return JSON.parse(localStorage.getItem('templates') || '[]'); }
        catch(e) { console.error('Error parsing templates:', e); return []; }
    },
    saveTemplates(templates) { localStorage.setItem('templates', JSON.stringify(templates)); },
    getAnnouncementReadReceipts() {
        try { return JSON.parse(localStorage.getItem('announcementReadReceipts') || '{}'); }
        catch(e) { console.error('Error parsing announcementReadReceipts:', e); return {}; }
    },
    saveAnnouncementReadReceipts(receipts) { localStorage.setItem('announcementReadReceipts', JSON.stringify(receipts)); },
    getCurrentUser() { return localStorage.getItem('currentUser') || 'Anonymous'; },
    saveCurrentUser(user) { localStorage.setItem('currentUser', user); },

    // Backward compatibility: Import birthdays from old format
    saveBirthdays(birthdays) {
        const existingMembers = this.getMembers();
        birthdays.forEach(b => {
            const existingIndex = existingMembers.findIndex(m => m.id === b.id);
            if (existingIndex >= 0) {
                // Update existing member's birthday
                existingMembers[existingIndex].birthday = b.birthday;
                if (b.phone) existingMembers[existingIndex].phone = b.phone;
                if (b.email) existingMembers[existingIndex].email = b.email;
            } else {
                // Add new member
                existingMembers.push({
                    id: b.id || genId(),
                    name: b.name,
                    birthday: b.birthday,
                    phone: b.phone || '',
                    email: b.email || '',
                    homegroup: 'Yes',
                    sponsor: '',
                    city: '',
                    isServant: false,
                    servantPosition: '',
                    servantSince: ''
                });
            }
        });
        this.saveMembers(existingMembers);
    }
};
// Initialize default data on first load
function initDefaults() {
    // Migration from 'birthdays' to 'members' for backward compatibility
    if (localStorage.getItem('birthdays') && !localStorage.getItem('members')) {
        const oldBirthdays = JSON.parse(localStorage.getItem('birthdays') || '[]');
        const newMembers = oldBirthdays.map(b => ({
            id: b.id,
            name: b.name,
            birthday: b.birthday,
            phone: '',
            email: '',
            homegroup: '',
            sponsor: '',
            city: '',
            isServant: false,
            servantPosition: '',
            servantSince: ''
        }));
        storage.saveMembers(newMembers);
        localStorage.removeItem('birthdays'); // Clean up old data
    }

    if (!localStorage.getItem('events')) {
        storage.saveEvents([]);
    }
    if (!localStorage.getItem('members')) {
        storage.saveMembers([]);
    }
    if (!localStorage.getItem('announcements')) {
        storage.saveAnnouncements([]);
    }
    if (!localStorage.getItem('photos')) {
        // We will now store photos as objects with src and tags
        storage.savePhotos([]);
    } else {
        // Backwards compatibility: convert old string array to new object array
        const photos = storage.getPhotos();
        if (photos.length > 0 && typeof photos[0] === 'string') {
            const newPhotos = photos.map(p => ({ src: p, tags: [] }));
            storage.savePhotos(newPhotos);
        }
    }
    if (!localStorage.getItem('chairpersonLog')) {
        storage.saveChairpersonLog([]);
    }
    if (!localStorage.getItem('groupConscienceLog')) {
        storage.saveGroupConscienceLog([]);
    }
    if (!localStorage.getItem('liveGCItems')) {
        storage.saveLiveGCItems([]);
    }
    if (!localStorage.getItem('proposedAgendaItems')) {
        storage.saveProposedAgendaItems([]);
    }
    if (!localStorage.getItem('gcComments')) {
        storage.saveGCComments([]);
    }
    if (!localStorage.getItem('gcActionItems')) {
        storage.saveGCActionItems([]);
    }
    if (!localStorage.getItem('gcSettings')) {
        storage.saveGCSettings({ quorumPercentage: 50, quorumMinimum: 5 });
    }
}
function handleEventSubmit() {
    const editId = document.getElementById('event-edit-id').value;
    if (editId) {
        updateEvent();
    } else {
        addEvent();
    }
}

function editEvent(id) {
    const events = storage.getEvents();
    const eventToEdit = events.find(ev => ev.id === id);
    if (!eventToEdit) {
        console.error('Event not found for editing');
        return;
    }

    // Show the form
    const form = document.getElementById('add-event-form');
    if (form.style.display === 'none') {
        form.style.display = 'block';
    }

    document.getElementById('event-edit-id').value = eventToEdit.id;
    document.getElementById('event-title').value = eventToEdit.title;
    document.getElementById('event-date').value = eventToEdit.date || '';
    document.getElementById('event-day').value = eventToEdit.dayOfWeek !== null ? eventToEdit.dayOfWeek : '';
    document.getElementById('event-time').value = eventToEdit.time;
    document.getElementById('event-category').value = eventToEdit.category || 'General';
    document.getElementById('event-reading').value = eventToEdit.reading || '';
    document.getElementById('event-speaker').value = eventToEdit.speaker || '';
    document.getElementById('event-chair').value = eventToEdit.chair || '';
    document.getElementById('event-description').value = eventToEdit.description || '';

    document.getElementById('event-form-btn').textContent = 'Save Changes';
    document.getElementById('event-form-cancel-btn').style.display = 'inline-block';

    // Scroll to form for better UX
    document.getElementById('schedule-section').scrollIntoView({ behavior: 'smooth' });
}

function cancelEventEdit() {
    document.getElementById('event-edit-id').value = '';
    document.getElementById('event-title').value = '';
    document.getElementById('event-date').value = '';
    document.getElementById('event-day').value = '';
    document.getElementById('event-time').value = '';
    document.getElementById('event-category').value = 'General';
    document.getElementById('event-reading').value = '';
    document.getElementById('event-speaker').value = '';
    document.getElementById('event-chair').value = '';
    document.getElementById('event-description').value = '';

    document.getElementById('event-form-btn').textContent = 'Add Event';
    document.getElementById('event-form-cancel-btn').style.display = 'none';
}

function updateEvent() {
    const id = document.getElementById('event-edit-id').value;
    if (!id) return;

    const title = document.getElementById('event-title').value.trim();
    const dateVal = document.getElementById('event-date').value;
    const dayVal = document.getElementById('event-day').value;
    const time = document.getElementById('event-time').value;
    const category = document.getElementById('event-category').value;
    const reading = document.getElementById('event-reading').value.trim();
    const speaker = document.getElementById('event-speaker').value.trim();
    const chair = document.getElementById('event-chair').value.trim();
    const description = document.getElementById('event-description').value.trim();

    if (!title || !time || (!dateVal && dayVal === '')) {
        showToast('Please provide at least a title, time, and either a date or day of week.', 'error');
        return;
    }

    let events = storage.getEvents();
    const eventIndex = events.findIndex(ev => ev.id === id);

    if (eventIndex > -1) {
        events[eventIndex] = {
            id,
            title,
            date: dateVal || null,
            dayOfWeek: dateVal ? null : parseInt(dayVal, 10),
            time,
            category,
            reading,
            speaker,
            chair,
            description
        };
        storage.saveEvents(events);
        showToast('Event updated successfully!', 'success');
    }

    cancelEventEdit(); // Resets form and buttons
    updateEventsTable();
    updateHome();
    renderCalendar();
}

// Add an event
function addEvent() {
    const title = document.getElementById('event-title').value.trim();
    const dateVal = document.getElementById('event-date').value;
    const dayVal = document.getElementById('event-day').value;
    const time = document.getElementById('event-time').value;
    const category = document.getElementById('event-category').value;
    const reading = document.getElementById('event-reading').value.trim();
    const speaker = document.getElementById('event-speaker').value.trim();
    const chair = document.getElementById('event-chair').value.trim();
    const description = document.getElementById('event-description').value.trim();
    if (!title || !time || (!dateVal && dayVal === '')) {
        showToast('Please provide at least a title, time, and either a date or day of week.', 'error');
        return;
    }
    const events = storage.getEvents();
    events.push({
        id: genId(),
        title,
        date: dateVal || null,
        dayOfWeek: dateVal ? null : parseInt(dayVal, 10),
        time,
        category,
        reading,
        speaker,
        chair,
        description
    });
    storage.saveEvents(events);
    showToast('Event added successfully!', 'success');
    document.getElementById('event-title').value = '';
    document.getElementById('event-date').value = '';
    document.getElementById('event-day').value = '';
    document.getElementById('event-time').value = '';
    document.getElementById('event-reading').value = '';
    document.getElementById('event-speaker').value = '';
    document.getElementById('event-chair').value = '';
    document.getElementById('event-description').value = '';
    updateEventsTable();
    updateHome();
    renderCalendar();
}
// Delete an event by id
function deleteEvent(id) {
    if (!confirm('Delete this event?')) return;
    let events = storage.getEvents();
    events = events.filter(ev => ev.id !== id);
    storage.saveEvents(events);
    showToast('Event deleted.', 'info');
    updateEventsTable();
    updateHome();
    renderCalendar();
}
// Compute upcoming occurrences within next X days
function computeUpcomingOccurrences(daysAhead = 30) {
    const events = storage.getEvents();
    const now = new Date();
    const end = new Date();
    end.setDate(end.getDate() + daysAhead);
    let occurrences = [];
    events.forEach(ev => {
        if (ev.date) {
            const eventDate = new Date(ev.date + 'T' + (ev.time || '00:00'));
            if (eventDate >= now && eventDate <= end) occurrences.push({ occurDate: eventDate, event: ev });
        } else if (ev.dayOfWeek !== null && ev.dayOfWeek !== undefined) {
            for (let d = 0; d <= daysAhead; d++) {
                const date = new Date(now);
                date.setHours(0, 0, 0, 0);
                date.setDate(date.getDate() + d);
                if (date.getDay() === ev.dayOfWeek) {
                    const timeParts = (ev.time || '00:00').split(':');
                    if (timeParts.length >= 2) {
                        const hours = parseInt(timeParts[0], 10) || 0;
                        const minutes = parseInt(timeParts[1], 10) || 0;
                        date.setHours(hours, minutes, 0, 0);
                    }
                    if (date >= now && date <= end) occurrences.push({ occurDate: new Date(date), event: ev });
                }
            }
        }
    });
    occurrences.sort((a, b) => a.occurDate - b.occurDate);
    return occurrences;
}
// Update events table
function updateEventsTable() {
    const tbody = document.getElementById('events-body');
    const categoryFilter = document.getElementById('category-filter').value;
    tbody.innerHTML = '';
    let occ = computeUpcomingOccurrences(60);

    if (categoryFilter !== 'All') {
        occ = occ.filter(item => (item.event.category || 'General') === categoryFilter);
    }

    occ.forEach(item => {
        const tr = document.createElement('tr');
        const dateStr = item.occurDate.toLocaleDateString();
        const timeStr = item.occurDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        tr.innerHTML = `<td>${escapeHtml(dateStr)}</td><td>${escapeHtml(item.event.title)}</td><td>${escapeHtml(item.event.category || 'General')}</td><td>${escapeHtml(timeStr)}</td><td>${escapeHtml(item.event.speaker || '')}</td><td>${escapeHtml(item.event.chair || '')}</td><td><button class="btn" data-action="edit-event" data-id="${escapeAttribute(item.event.id)}" style="margin-right: 5px;">Edit</button><button class="btn secondary" data-action="delete-event" data-id="${escapeAttribute(item.event.id)}">Delete</button></td>`;
        tbody.appendChild(tr);
    });
    if (occ.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="7">No upcoming events match the filter.</td>';
        tbody.appendChild(tr);
    }
}
function handleMemberSubmit() {
    const editId = document.getElementById('member-edit-id').value;
    if (editId) {
        updateMember();
    } else {
        addMember();
    }
}

function editMember(id) {
    const members = storage.getMembers();
    const memberToEdit = members.find(m => m.id === id);
    if (!memberToEdit) {
        console.error('Member not found for editing');
        return;
    }

    // Show the form
    const form = document.getElementById('add-member-form');
    if (form.style.display === 'none') {
        form.style.display = 'block';
    }

    document.getElementById('member-edit-id').value = memberToEdit.id;
    document.getElementById('member-name').value = memberToEdit.name;
    document.getElementById('member-birthday').value = memberToEdit.birthday;
    document.getElementById('member-phone').value = memberToEdit.phone || '';
    document.getElementById('member-email').value = memberToEdit.email || '';
    document.getElementById('member-homegroup').value = memberToEdit.homegroup || '';
    document.getElementById('member-sponsor').value = memberToEdit.sponsor || '';
    document.getElementById('member-city').value = memberToEdit.city || '';
    document.getElementById('member-is-servant').checked = memberToEdit.isServant || false;
    document.getElementById('member-servant-position').value = memberToEdit.servantPosition || '';
    document.getElementById('member-servant-since').value = memberToEdit.servantSince || '';

    document.getElementById('member-form-btn').textContent = 'Save Changes';
    document.getElementById('member-form-cancel-btn').style.display = 'inline-block';

    document.getElementById('birthdays-section').scrollIntoView({ behavior: 'smooth' });
}

function cancelMemberEdit() {
    document.getElementById('member-edit-id').value = '';
    document.getElementById('member-name').value = '';
    document.getElementById('member-birthday').value = '';
    document.getElementById('member-phone').value = '';
    document.getElementById('member-email').value = '';
    document.getElementById('member-homegroup').value = '';
    document.getElementById('member-sponsor').value = '';
    document.getElementById('member-city').value = '';
    document.getElementById('member-is-servant').checked = false;
    document.getElementById('member-servant-position').value = '';
    document.getElementById('member-servant-since').value = '';


    document.getElementById('member-form-btn').textContent = 'Add Member';
    document.getElementById('member-form-cancel-btn').style.display = 'none';
}

function updateMember() {
    const id = document.getElementById('member-edit-id').value;
    if (!id) return;

    const name = document.getElementById('member-name').value.trim();
    const bdate = document.getElementById('member-birthday').value;
    const email = document.getElementById('member-email').value.trim();
    const phone = document.getElementById('member-phone').value.trim();

    if (!name || !bdate) {
        showToast('Please provide both name and sobriety date.', 'error');
        return;
    }

    if (!validateEmail(email)) {
        showToast('Please enter a valid email address (e.g., user@example.com).', 'error');
        return;
    }

    if (!validatePhone(phone)) {
        showToast('Please enter a valid phone number with at least 10 digits.', 'error');
        return;
    }

    let members = storage.getMembers();
    const memberIndex = members.findIndex(m => m.id === id);

    if (memberIndex > -1) {
        members[memberIndex] = {
            id,
            name,
            birthday: bdate,
            phone: phone,
            email: email,
            homegroup: document.getElementById('member-homegroup').value.trim(),
            sponsor: document.getElementById('member-sponsor').value.trim(),
            city: document.getElementById('member-city').value.trim(),
            isServant: document.getElementById('member-is-servant').checked,
            servantPosition: document.getElementById('member-servant-position').value.trim(),
            servantSince: document.getElementById('member-servant-since').value
        };
        storage.saveMembers(members);
        showToast('Member updated successfully!', 'success');
    }

    cancelMemberEdit(); // Resets form and buttons
    updateBirthdaysTable();
    updateHome();
    populateAttendeeDropdown();
    populateMemberDropdowns();
    renderServantReportInputs();
}

// Add member
function addMember() {
    const name = document.getElementById('member-name').value.trim();
    const bdate = document.getElementById('member-birthday').value;
    const email = document.getElementById('member-email').value.trim();
    const phone = document.getElementById('member-phone').value.trim();

    if (!name || !bdate) {
        showToast('Please provide both name and sobriety date.', 'error');
        return;
    }

    if (!validateEmail(email)) {
        showToast('Please enter a valid email address (e.g., user@example.com).', 'error');
        return;
    }

    if (!validatePhone(phone)) {
        showToast('Please enter a valid phone number with at least 10 digits.', 'error');
        return;
    }

    const members = storage.getMembers();
    members.push({
        id: genId(),
        name,
        birthday: bdate,
        phone: phone,
        email: email,
        homegroup: document.getElementById('member-homegroup').value.trim(),
        sponsor: document.getElementById('member-sponsor').value.trim(),
        city: document.getElementById('member-city').value.trim(),
        isServant: document.getElementById('member-is-servant').checked,
        servantPosition: document.getElementById('member-servant-position').value.trim(),
        servantSince: document.getElementById('member-servant-since').value
    });
    storage.saveMembers(members);
    showToast('Member added successfully!', 'success');
    cancelMemberEdit();
    updateBirthdaysTable();
    updateHome();
    populateAttendeeDropdown();
    populateMemberDropdowns();
    renderServantReportInputs();
}
// Delete member
function deleteMember(id) {
    if (!confirm('Delete this member?')) return;
    let members = storage.getMembers();
    members = members.filter(m => m.id !== id);
    storage.saveMembers(members);
    showToast('Member deleted.', 'info');
    updateBirthdaysTable();
    updateHome();
    populateAttendeeDropdown();
    populateMemberDropdowns();
    renderServantReportInputs();
}

// Helper to find all anniversaries within a given date window
function getAnniversariesInWindow(members, pastDays, futureDays) {
    const now = new Date();
    now.setHours(0,0,0,0);

    const lowerBound = new Date(now);
    lowerBound.setDate(lowerBound.getDate() - pastDays);

    const upperBound = new Date(now);
    upperBound.setDate(upperBound.getDate() + futureDays);

    const relevantMembers = [];

    members.forEach(member => {
        if (!member.birthday) return; // Skip members with no birthday
        const parts = member.birthday.split('-');
        if (parts.length < 3) return; // Invalid date format
        const [origYear, month, day] = parts.map(Number);
        if (isNaN(month) || isNaN(day)) return; // Invalid numbers

        // Check anniversary for the current year
        const thisYearAnniversary = new Date(now.getFullYear(), month - 1, day);
        if (thisYearAnniversary >= lowerBound && thisYearAnniversary <= upperBound) {
            relevantMembers.push({ ...member, displayDate: thisYearAnniversary });
            return; // Move to next member, avoid duplicates
        }

        // Check anniversary for last year (for pastDays window)
        if (now.getFullYear() > origYear) {
             const lastYearAnniversary = new Date(now.getFullYear() - 1, month - 1, day);
             if (lastYearAnniversary >= lowerBound && lastYearAnniversary <= upperBound) {
                relevantMembers.push({ ...member, displayDate: lastYearAnniversary });
                return;
             }
        }

        // Check anniversary for next year (for futureDays window)
        const nextYearAnniversary = new Date(now.getFullYear() + 1, month - 1, day);
        if (nextYearAnniversary >= lowerBound && nextYearAnniversary <= upperBound) {
            relevantMembers.push({ ...member, displayDate: nextYearAnniversary });
        }
    });

    return relevantMembers.sort((a, b) => a.displayDate - b.displayDate);
}

// Calculate sober time
function calculateSoberTime(bdayStr) {
    if (!bdayStr) return { years: 0, months: 0, days: 0 };
    const soberDate = new Date(bdayStr);
    const now = new Date();

    let years = now.getFullYear() - soberDate.getFullYear();
    let months = now.getMonth() - soberDate.getMonth();
    let days = now.getDate() - soberDate.getDate();

    if (days < 0) {
        months--;
        const lastMonth = new Date(now.getFullYear(), now.getMonth(), 0);
        days += lastMonth.getDate();
    }

    if (months < 0) {
        years--;
        months += 12;
    }

    return { years, months, days };
}

// Compute next birthday date relative to now
function nextBirthdayDate(bdayStr) {
    const now = new Date();
    const parts = bdayStr.split('-');
    if (parts.length < 3) return null; // Invalid format
    const [year, month, day] = parts.map(Number);
    if (isNaN(year) || isNaN(month) || isNaN(day)) return null; // Invalid numbers
    const today = new Date(now);
    today.setHours(0, 0, 0, 0);
    let nextDate = new Date(today.getFullYear(), month - 1, day);
    if (nextDate < today) {
        nextDate = new Date(today.getFullYear() + 1, month - 1, day);
    }
    return nextDate;
}
// Update birthdays table
function updateBirthdaysTable() {
    const tbody = document.getElementById('birthdays-body');
    tbody.innerHTML = '';
    const members = storage.getMembers();
    const membersInWindow = getAnniversariesInWindow(members, 15, 60);

    const now = new Date();
    now.setHours(0,0,0,0);

    membersInWindow.forEach(m => {
        const tr = document.createElement('tr');

        // Highlight past birthdays in a muted yellow/gold color
        if (m.displayDate < now) {
            tr.style.backgroundColor = '#6b5d2f';
        }

        const displayDateStr = m.displayDate.toLocaleDateString();
        const origDate = new Date(m.birthday);
        const md = origDate.toLocaleDateString(undefined, { month: 'long', day: 'numeric', year: 'numeric' });

        // Calculate years of sobriety based on the anniversary date
        const years = m.displayDate.getFullYear() - origDate.getFullYear();
        const soberTime = calculateSoberTime(m.birthday);
        const soberTimeStr = `${soberTime.years}y ${soberTime.months}m ${soberTime.days}d`;

        tr.innerHTML = `
            <td>${escapeHtml(m.name)}</td>
            <td>${escapeHtml(md)}</td>
            <td>${escapeHtml(displayDateStr)}</td>
            <td>${escapeHtml(String(years))}</td>
            <td>${escapeHtml(soberTimeStr)}</td>
            <td>
                <button class="btn" data-action="edit-member" data-id="${escapeAttribute(m.id)}" style="margin-right: 5px;">Edit</button>
                <button class="btn secondary" data-action="delete-member" data-id="${escapeAttribute(m.id)}">Delete</button>
            </td>`;
        tbody.appendChild(tr);
    });
    if (membersInWindow.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="6">No recent or upcoming birthdays in the next 60 days.</td>';
        tbody.appendChild(tr);
    }
}
// Add announcement
function addAnnouncement() {
    const text = document.getElementById('announcement-text').value.trim();
    if (!text) {
        showToast('Enter an announcement.', 'error');
        return;
    }
    const priority = document.getElementById('announcement-priority').value;
    const requireReadReceipt = document.getElementById('announcement-require-read-receipt').checked;

    const ann = storage.getAnnouncements();
    ann.unshift({
        id: genId(),
        text,
        dateCreated: new Date().toISOString(),
        active: true,
        priority: priority,
        requireReadReceipt: requireReadReceipt,
        readBy: []
    });
    storage.saveAnnouncements(ann);
    showToast('Announcement added!', 'success');
    document.getElementById('announcement-text').value = '';
    document.getElementById('announcement-priority').value = 'info';
    document.getElementById('announcement-require-read-receipt').checked = false;
    updateAnnouncementsList();
    updateHome();
    updateChairpersonAnnouncements();
}
// Delete announcement
function deleteAnnouncement(id) {
    if (!confirm('Delete this announcement?')) return;
    let ann = storage.getAnnouncements();
    ann = ann.filter(a => a.id !== id);
    storage.saveAnnouncements(ann);
    showToast('Announcement deleted.', 'info');
    updateAnnouncementsList();
    updateHome();
    updateChairpersonAnnouncements();
}
// Toggle announcement active state
function toggleAnnouncementActive(id) {
    let ann = storage.getAnnouncements();
    const index = ann.findIndex(a => a.id === id);
    if (index > -1) {
        ann[index].active = !ann[index].active;
        storage.saveAnnouncements(ann);
        updateAnnouncementsList();
        updateHome();
        updateChairpersonAnnouncements();
    }
}

// Update announcements list
function updateAnnouncementsList() {
    const ul = document.getElementById('announcements-list');
    ul.innerHTML = '';
    const ann = storage.getAnnouncements();
    const currentUser = storage.getCurrentUser();

    ann.forEach(a => {
        const li = document.createElement('div');
        li.className = `announcement-item ${a.priority || 'info'}`;
        if (!a.active) {
            li.style.opacity = '0.5';
        }

        const dateStr = new Date(a.dateCreated).toLocaleDateString();

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = a.active;
        checkbox.style.marginRight = '1rem';
        checkbox.onchange = () => toggleAnnouncementActive(a.id);

        const priorityBadge = document.createElement('span');
        priorityBadge.className = `priority-badge ${a.priority || 'info'}`;
        priorityBadge.textContent = (a.priority || 'info').toUpperCase();

        const text = document.createElement('span');
        text.innerHTML = `<strong>${dateStr}:</strong> ${escapeHtml(a.text)}`;
        text.style.flexGrow = '1';

        const topRow = document.createElement('div');
        topRow.style.display = 'flex';
        topRow.style.alignItems = 'center';
        topRow.style.marginBottom = '8px';
        topRow.appendChild(checkbox);
        topRow.appendChild(text);
        topRow.appendChild(priorityBadge);

        li.appendChild(topRow);

        // Read receipt handling
        if (a.requireReadReceipt) {
            const readBy = a.readBy || [];
            const hasRead = readBy.includes(currentUser);

            const readInfo = document.createElement('div');
            readInfo.className = 'read-receipt-indicator';
            readInfo.innerHTML = `<i class="fas fa-check-circle"></i> Read by ${readBy.length} member(s)`;

            li.appendChild(readInfo);

            if (!hasRead) {
                const markReadBtn = document.createElement('button');
                markReadBtn.className = 'btn mark-as-read-btn';
                markReadBtn.textContent = 'Mark as Read';
                markReadBtn.onclick = () => markAnnouncementAsRead(a.id);
                li.appendChild(markReadBtn);
            }
        }

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn secondary';
        deleteBtn.style.marginTop = '8px';
        deleteBtn.textContent = 'Delete';
        deleteBtn.onclick = () => deleteAnnouncement(a.id);

        li.appendChild(deleteBtn);
        ul.appendChild(li);
    });
    if (ann.length === 0) {
        ul.innerHTML = '<li>No announcements posted</li>';
    }
}

function updateChairpersonAnnouncements() {
    const ul = document.getElementById('chairperson-announcements-list');
    if (!ul) return;
    ul.innerHTML = '';
    const activeAnnouncements = storage.getAnnouncements().filter(a => a.active);
    activeAnnouncements.forEach(a => {
        const li = document.createElement('li');
        const dateStr = new Date(a.dateCreated).toLocaleDateString();
        li.innerHTML = `<strong>${dateStr}:</strong> ${escapeHtml(a.text)}`;
        ul.appendChild(li);
    });
    if (activeAnnouncements.length === 0) {
        ul.innerHTML = '<li>No active announcements</li>';
    }
}
// Modal functions
let currentPhotoIndex = 0;
let currentPhotoList = [];

function updateModalContent() {
    const photo = currentPhotoList[currentPhotoIndex];
    if (!photo) { closeModal(); return; }

    const modalImg = document.getElementById('modal-image');
    const caption = document.getElementById('modal-caption');

    modalImg.src = photo.src;
    caption.textContent = photo.tags && photo.tags.length > 0 ? `Tags: ${photo.tags.join(', ')}` : '';
}

function showNextPhoto() {
    if (currentPhotoList.length === 0) return;
    currentPhotoIndex = (currentPhotoIndex + 1) % currentPhotoList.length;
    updateModalContent();
}

function showPreviousPhoto() {
    if (currentPhotoList.length === 0) return;
    currentPhotoIndex = (currentPhotoIndex - 1 + currentPhotoList.length) % currentPhotoList.length;
    updateModalContent();
}

function handleModalKeys(event) {
    if (event.key === 'Escape') {
        closeModal();
    } else if (event.key === 'ArrowRight') {
        showNextPhoto();
    } else if (event.key === 'ArrowLeft') {
        showPreviousPhoto();
    }
}

function openModal(index, photos) {
    currentPhotoList = photos;
    currentPhotoIndex = index;

    if (currentPhotoList.length === 0) return;

    const modal = document.getElementById('photo-modal');
    modal.style.display = "flex";

    updateModalContent();

    document.addEventListener('keydown', handleModalKeys);
}

function closeModal() {
    const modal = document.getElementById('photo-modal');
    modal.style.display = "none";
    document.removeEventListener('keydown', handleModalKeys);
}
// Photo uploading
function uploadPhotos() {
    const input = document.getElementById('photo-upload');
    const tagsInput = document.getElementById('photo-tags');
    const files = Array.from(input.files);
    if (!files || files.length === 0) {
        showToast('Select one or more images to upload.', 'error');
        return;
    }

    // Check storage quota before uploading
    if (!checkLocalStorageQuota()) {
        showToast('Cannot upload photos: storage quota warning. Please free up space.', 'error');
        return;
    }

    const tags = tagsInput.value.split(',').map(tag => tag.trim()).filter(tag => tag);
    const photos = storage.getPhotos();
    let remaining = files.length;
    files.forEach(file => {
        const reader = new FileReader();
        reader.onload = function (e) {
            photos.push({ src: e.target.result, tags: tags });
            remaining--;
            if (remaining === 0) {
                try {
                    storage.savePhotos(photos);
                    showToast(`${files.length} photo(s) uploaded!`, 'success');
                    input.value = '';
                    tagsInput.value = '';
                    updateGallery();
                    updateHome();
                } catch (err) {
                    showToast('Failed to save photos: ' + err.message, 'error');
                }
            }
        };
        reader.readAsDataURL(file);
    });
}
// Delete photo by index
function deletePhoto(index) {
    if (!confirm('Delete this photo?')) return;
    const photos = storage.getPhotos();
    photos.splice(index, 1);
    storage.savePhotos(photos);
    showToast('Photo deleted.', 'info');
    updateGallery();
    updateHome();
}

// Chairperson's Corner functions
function handleChairpersonLogSubmit() {
    const editId = document.getElementById('log-edit-id').value;
    if (editId) {
        updateChairpersonLog(editId);
    } else {
        addChairpersonLog();
    }
}

function addChairpersonLog() {
    const date = document.getElementById('log-date').value;
    const time = document.getElementById('log-time').value;
    const chairperson = document.getElementById('log-chairperson').value.trim();
    const headcount = document.getElementById('log-headcount').value;
    const tradition = document.getElementById('log-7th-tradition').value;
    const orangeCan = document.getElementById('log-orange-can').value;

    if (!date) {
        showToast('Please select a date.', 'error');
        return;
    }

    const log = storage.getChairpersonLog();
    log.push({
        id: genId(),
        date,
        time,
        chairperson,
        headcount: parseInt(headcount) || 0,
        tradition: parseFloat(tradition) || 0,
        orangeCan: parseFloat(orangeCan) || 0,
    });
    storage.saveChairpersonLog(log);
    showToast('Log entry added.', 'success');
    updateChairpersonLogTable();
    document.getElementById('log-date').value = '';
    document.getElementById('log-time').value = '';
    document.getElementById('log-chairperson').value = '';
    document.getElementById('log-headcount').value = '';
    document.getElementById('log-7th-tradition').value = '';
    document.getElementById('log-orange-can').value = '';
}

function updateChairpersonLogTable() {
    const tbody = document.getElementById('chairperson-log-body');
    tbody.innerHTML = '';
    const log = storage.getChairpersonLog().sort((a, b) => new Date(b.date) - new Date(a.date));

    // Update the table header
    const thead = document.getElementById('chairperson-log-table').querySelector('thead');
    thead.innerHTML = `
        <tr>
            <th>Date</th>
            <th>Time</th>
            <th>Chairperson</th>
            <th>Head Count</th>
            <th>7th Tradition</th>
            <th>Orange Can</th>
            <th>Actions</th>
        </tr>
    `;

    log.forEach(entry => {
        const tr = document.createElement('tr');
        const timeStr = entry.time ? new Date('1970-01-01T' + entry.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'N/A';
        tr.innerHTML = `
            <td>${escapeHtml(new Date(entry.date).toLocaleDateString())}</td>
            <td>${escapeHtml(timeStr)}</td>
            <td>${escapeHtml(entry.chairperson || 'N/A')}</td>
            <td>${escapeHtml(String(entry.headcount))}</td>
            <td>$${escapeHtml(entry.tradition.toFixed(2))}</td>
            <td>$${escapeHtml(entry.orangeCan.toFixed(2))}</td>
            <td>
                <button class="btn" data-action="edit-chairperson" data-id="${escapeAttribute(entry.id)}" style="margin-right: 5px;">Edit</button>
                <button class="btn secondary" data-action="delete-chairperson" data-id="${escapeAttribute(entry.id)}">Delete</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function editChairpersonLog(id) {
    const log = storage.getChairpersonLog();
    const entry = log.find(e => e.id === id);
    if (!entry) return;

    document.getElementById('log-edit-id').value = entry.id;
    document.getElementById('log-date').value = entry.date;
    document.getElementById('log-time').value = entry.time;
    document.getElementById('log-chairperson').value = entry.chairperson;
    document.getElementById('log-headcount').value = entry.headcount;
    document.getElementById('log-7th-tradition').value = entry.tradition;
    document.getElementById('log-orange-can').value = entry.orangeCan;

    document.getElementById('chairperson-form-title').textContent = 'Edit Log Entry';
    document.getElementById('log-form-btn').textContent = 'Save Changes';
    document.getElementById('log-form-cancel-btn').style.display = 'inline-block';
}

function updateChairpersonLog(id) {
    const log = storage.getChairpersonLog();
    const index = log.findIndex(e => e.id === id);
    if (index === -1) return;

    const date = document.getElementById('log-date').value;
    const time = document.getElementById('log-time').value;
    const chairperson = document.getElementById('log-chairperson').value.trim();
    const headcount = document.getElementById('log-headcount').value;
    const tradition = document.getElementById('log-7th-tradition').value;
    const orangeCan = document.getElementById('log-orange-can').value;

    if (!date) {
        showToast('Please select a date.', 'error');
        return;
    }

    log[index] = {
        id,
        date,
        time,
        chairperson,
        headcount: parseInt(headcount) || 0,
        tradition: parseFloat(tradition) || 0,
        orangeCan: parseFloat(orangeCan) || 0,
    };

    storage.saveChairpersonLog(log);
    showToast('Log entry updated.', 'success');
    cancelLogEdit();
    updateChairpersonLogTable();
}

function cancelLogEdit() {
    document.getElementById('log-edit-id').value = '';
    document.getElementById('log-date').value = '';
    document.getElementById('log-time').value = '';
    document.getElementById('log-chairperson').value = '';
    document.getElementById('log-headcount').value = '';
    document.getElementById('log-7th-tradition').value = '';
    document.getElementById('log-orange-can').value = '';

    document.getElementById('chairperson-form-title').textContent = 'Log New Entry';
    document.getElementById('log-form-btn').textContent = 'Add Log Entry';
    document.getElementById('log-form-cancel-btn').style.display = 'none';
}

function deleteChairpersonLog(id) {
    if (!confirm('Delete this log entry?')) return;
    let log = storage.getChairpersonLog();
    log = log.filter(e => e.id !== id);
    storage.saveChairpersonLog(log);
    showToast('Log entry deleted.', 'info');
    updateChairpersonLogTable();
}

// Group Conscience Log Functions
function handleGCLogSubmit() {
    const editId = document.getElementById('gc-edit-id').value;
    if (editId) {
        updateGCLog(editId);
    } else {
        addGCLog();
    }
}

function addGCLog() {
    const servantReportInputs = document.querySelectorAll('.servant-report-input');
    const servantReports = [];
    servantReportInputs.forEach(input => {
        if (input.value.trim() !== '') {
            servantReports.push({
                servantId: input.dataset.servantId,
                servantName: input.dataset.servantName,
                report: input.value.trim()
            });
        }
    });

    const votesFor = parseInt(document.getElementById('gc-votes-for')?.value || 0);
    const votesAgainst = parseInt(document.getElementById('gc-votes-against')?.value || 0);
    const votesAbstain = parseInt(document.getElementById('gc-votes-abstain')?.value || 0);

    const log = {
        id: genId(),
        date: document.getElementById('gc-date').value,
        item: document.getElementById('gc-item').value.trim(),
        submittedBy: document.getElementById('gc-submitted-by').value.trim(),
        status: document.getElementById('gc-status').value,
        votesFor,
        votesAgainst,
        votesAbstain,
        attendees: Array.from(document.getElementById('gc-attendees').selectedOptions).map(opt => opt.value),
        servantReports: servantReports,
    };

    if (!log.date || !log.item) {
        showToast('Please provide at least a date and an item/motion.', 'error');
        return;
    }

    const logs = storage.getGroupConscienceLog();
    logs.push(log);
    storage.saveGroupConscienceLog(logs);
    showToast('Group Conscience entry added.', 'success');
    updateGCLogTable();
    cancelGCEdit(); // Clear form
}

function updateGCLogTable() {
    const currentTbody = document.getElementById('gc-log-body-current');
    const previousTbody = document.getElementById('gc-log-body-previous');
    currentTbody.innerHTML = '';
    previousTbody.innerHTML = '';

    const logs = storage.getGroupConscienceLog().sort((a, b) => new Date(b.date) - new Date(a.date));
    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();

    logs.forEach(log => {
        const logDate = new Date(log.date);
        const logMonth = logDate.getMonth();
        const logYear = logDate.getFullYear();

        const isCurrentMonth = logMonth === currentMonth && logYear === currentYear;
        const tbody = isCurrentMonth ? currentTbody : previousTbody;

        const votesFor = log.votesFor || 0;
        const votesAgainst = log.votesAgainst || 0;
        const votesAbstain = log.votesAbstain || 0;
        const votesDisplay = (votesFor || votesAgainst || votesAbstain)
            ? `${votesFor}-${votesAgainst}-${votesAbstain}`
            : (log.votes || 'N/A');

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${escapeHtml(logDate.toLocaleDateString())}</td>
            <td>${escapeHtml(log.item.substring(0, 50))}${log.item.length > 50 ? '...' : ''}</td>
            <td>${escapeHtml(log.submittedBy || 'N/A')}</td>
            <td style="color: ${log.status === 'passed' ? '#2ecc71' : log.status === 'failed' ? '#e74c3c' : '#f39c12'};">${escapeHtml(log.status.toUpperCase())}</td>
            <td>${escapeHtml(votesDisplay)}</td>
            <td>
                <button class="btn" data-action="view-gc" data-id="${escapeAttribute(log.id)}" style="margin-right: 5px;">View</button>
                <button class="btn" data-action="edit-gc" data-id="${escapeAttribute(log.id)}" style="margin-right: 5px;">Edit</button>
                <button class="btn secondary" data-action="delete-gc" data-id="${escapeAttribute(log.id)}">Delete</button>
            </td>
        `;
        tbody.appendChild(tr);
    });

    if (currentTbody.innerHTML === '') {
        currentTbody.innerHTML = '<tr><td colspan="6">No entries for the current month.</td></tr>';
    }
    if (previousTbody.innerHTML === '') {
        previousTbody.innerHTML = '<tr><td colspan="6">No entries for previous months.</td></tr>';
    }
}

function editGCLog(id) {
    const logs = storage.getGroupConscienceLog();
    const log = logs.find(l => l.id === id);
    if (!log) return;

    document.getElementById('gc-edit-id').value = log.id;
    document.getElementById('gc-date').value = log.date;
    document.getElementById('gc-item').value = log.item;
    document.getElementById('gc-submitted-by').value = log.submittedBy;
    document.getElementById('gc-status').value = log.status;

    // Populate new vote fields (or fall back to old format)
    if (document.getElementById('gc-votes-for')) {
        document.getElementById('gc-votes-for').value = log.votesFor || 0;
        document.getElementById('gc-votes-against').value = log.votesAgainst || 0;
        document.getElementById('gc-votes-abstain').value = log.votesAbstain || 0;
        updateVotePercentages();
    }

    // Handle populating the multi-select dropdown
    const attendees = log.attendees || [];
    const select = document.getElementById('gc-attendees');
    if (Array.isArray(attendees)) {
        Array.from(select.options).forEach(option => {
            option.selected = attendees.includes(option.value);
        });
    } else {
        // For old string data, we can't reliably pre-select. Clear selection.
        select.selectedIndex = -1;
    }

    // Clear existing reports and hide legacy container
    document.querySelectorAll('.servant-report-input').forEach(input => input.value = '');
    const legacyContainer = document.getElementById('gc-servant-reports-legacy-container');
    const legacyTextarea = document.getElementById('gc-servant-reports-legacy');
    legacyContainer.style.display = 'none';

    if (log.servantReports && Array.isArray(log.servantReports)) {
        log.servantReports.forEach(report => {
            const textarea = document.getElementById(`servant-report-${report.servantId}`);
            if (textarea) {
                textarea.value = report.report;
            }
        });
    } else if (log.servantReports && typeof log.servantReports === 'string' && log.servantReports.trim() !== '') {
        legacyContainer.style.display = 'block';
        legacyTextarea.value = log.servantReports;
    }

    document.getElementById('gc-form-title').textContent = 'Edit GC Entry';
    document.getElementById('gc-form-btn').textContent = 'Save Changes';
    document.getElementById('gc-form-cancel-btn').style.display = 'inline-block';
}

function updateGCLog(id) {
    const logs = storage.getGroupConscienceLog();
    const index = logs.findIndex(l => l.id === id);
    if (index === -1) return;

    const servantReportInputs = document.querySelectorAll('.servant-report-input');
    const servantReports = [];
    servantReportInputs.forEach(input => {
        if (input.value.trim() !== '') {
            servantReports.push({
                servantId: input.dataset.servantId,
                servantName: input.dataset.servantName,
                report: input.value.trim()
            });
        }
    });

    const votesFor = parseInt(document.getElementById('gc-votes-for')?.value || 0);
    const votesAgainst = parseInt(document.getElementById('gc-votes-against')?.value || 0);
    const votesAbstain = parseInt(document.getElementById('gc-votes-abstain')?.value || 0);

    const log = {
        id,
        date: document.getElementById('gc-date').value,
        item: document.getElementById('gc-item').value.trim(),
        submittedBy: document.getElementById('gc-submitted-by').value.trim(),
        status: document.getElementById('gc-status').value,
        votesFor,
        votesAgainst,
        votesAbstain,
        attendees: Array.from(document.getElementById('gc-attendees').selectedOptions).map(opt => opt.value),
        servantReports: servantReports,
    };

    if (!log.date || !log.item) {
        showToast('Please provide at least a date and an item/motion.', 'error');
        return;
    }

    logs[index] = log;
    storage.saveGroupConscienceLog(logs);
    showToast('Group Conscience entry updated.', 'success');
    cancelGCEdit();
    updateGCLogTable();
}

function cancelGCEdit() {
    document.getElementById('gc-edit-id').value = '';
    document.getElementById('gc-date').value = '';
    document.getElementById('gc-item').value = '';
    document.getElementById('gc-submitted-by').value = '';
    document.getElementById('gc-status').value = 'passed';

    // Clear new vote fields
    if (document.getElementById('gc-votes-for')) {
        document.getElementById('gc-votes-for').value = '';
        document.getElementById('gc-votes-against').value = '';
        document.getElementById('gc-votes-abstain').value = '';
        updateVotePercentages();
    }

    document.getElementById('gc-attendees').value = '';
    document.querySelectorAll('.servant-report-input').forEach(input => input.value = '');
    document.getElementById('gc-servant-reports-legacy-container').style.display = 'none';
    document.getElementById('gc-servant-reports-legacy').value = '';

    document.getElementById('gc-form-title').textContent = 'Log Group Conscience Item';
    document.getElementById('gc-form-btn').textContent = 'Add GC Entry';
    document.getElementById('gc-form-cancel-btn').style.display = 'none';
}

function deleteGCLog(id) {
    if (!confirm('Delete this Group Conscience entry?')) return;
    let logs = storage.getGroupConscienceLog();
    logs = logs.filter(l => l.id !== id);
    storage.saveGroupConscienceLog(logs);
    showToast('GC entry deleted.', 'info');
    updateGCLogTable();
}

// Live Group Conscience functions
function toggleLiveGC() {
    const module = document.getElementById('live-gc-module');
    module.style.display = module.style.display === 'none' ? 'block' : 'none';
}

function addNewBusinessItem() {
    const itemText = document.getElementById('new-business-item').value.trim();
    if (!itemText) {
        showToast('Please enter an item.', 'error');
        return;
    }

    const items = storage.getLiveGCItems();
    items.push({
        id: genId(),
        item: itemText,
        status: 'Proposed'
    });
    storage.saveLiveGCItems(items);
    showToast('New business item added.', 'success');
    document.getElementById('new-business-item').value = '';
    updateLiveGCTable();
}

function updateLiveGCTable() {
    const tbody = document.getElementById('live-gc-body');
    if (!tbody) return;
    tbody.innerHTML = '';
    const items = storage.getLiveGCItems();

    items.forEach(item => {
        const tr = document.createElement('tr');
        const statusOptions = ['Proposed', 'Active Discussion', 'Tabled']
            .map(s => `<option value="${s}" ${s === item.status ? 'selected' : ''}>${s}</option>`)
            .join('');

        tr.innerHTML = `
            <td>${item.item}</td>
            <td>
                <select onchange="updateLiveGCItemStatus('${item.id}', this.value)">
                    ${statusOptions}
                </select>
            </td>
            <td>
                <button class="btn secondary" data-action="delete-live-gc" data-id="${escapeAttribute(item.id)}">Delete</button>
            </td>
        `;
        tbody.appendChild(tr);
    });

    if (items.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3">No new business items.</td></tr>';
    }
}

function updateLiveGCItemStatus(id, newStatus) {
    let items = storage.getLiveGCItems();
    const index = items.findIndex(item => item.id === id);
    if (index > -1) {
        items[index].status = newStatus;
        storage.saveLiveGCItems(items);
        showToast('Item status updated.', 'success');
        updateLiveGCTable();
    }
}

function deleteLiveGCItem(id) {
    if (!confirm('Delete this item?')) return;
    let items = storage.getLiveGCItems();
    items = items.filter(item => item.id !== id);
    storage.saveLiveGCItems(items);
    showToast('Item deleted.', 'info');
    updateLiveGCTable();
}

// ========== FEATURE 1: Pre-GC Submission System ==========
function addProposedAgendaItem() {
    const title = document.getElementById('proposed-item-title').value.trim();
    const description = document.getElementById('proposed-item-description').value.trim();
    const submitter = document.getElementById('proposed-item-submitter').value.trim();

    if (!title || !description || !submitter) {
        showToast('Please fill in all fields for the agenda item.', 'error');
        return;
    }

    const items = storage.getProposedAgendaItems();
    items.push({
        id: genId(),
        title,
        description,
        submitter,
        dateSubmitted: new Date().toISOString().split('T')[0],
        status: 'pending',
        discussionNotes: ''
    });
    storage.saveProposedAgendaItems(items);
    showToast('Agenda item submitted successfully!', 'success');

    document.getElementById('proposed-item-title').value = '';
    document.getElementById('proposed-item-description').value = '';
    document.getElementById('proposed-item-submitter').value = '';

    updateProposedAgendaTable();
}

function updateProposedAgendaTable() {
    const tbody = document.getElementById('proposed-agenda-body');
    if (!tbody) return;
    tbody.innerHTML = '';
    const items = storage.getProposedAgendaItems().sort((a, b) => new Date(b.dateSubmitted) - new Date(a.dateSubmitted));

    items.forEach(item => {
        const tr = document.createElement('tr');
        const statusColor = item.status === 'converted' ? '#2ecc71' : item.status === 'discussed' ? '#f39c12' : '#3498db';
        tr.innerHTML = `
            <td>${item.title}</td>
            <td>${item.submitter}</td>
            <td>${new Date(item.dateSubmitted).toLocaleDateString()}</td>
            <td style="color: ${statusColor};">${item.status.charAt(0).toUpperCase() + item.status.slice(1)}</td>
            <td>
                <button class="btn" data-action="view-proposed" data-id="${escapeAttribute(item.id)}" style="margin-right: 5px;">View</button>
                <button class="btn secondary" data-action="delete-proposed" data-id="${escapeAttribute(item.id)}">Delete</button>
            </td>
        `;
        tbody.appendChild(tr);
    });

    if (items.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5">No proposed agenda items.</td></tr>';
    }
}

function viewProposedAgendaItem(id) {
    const items = storage.getProposedAgendaItems();
    const item = items.find(i => i.id === id);
    if (!item) return;

    alert(`Title: ${item.title}\n\nDescription: ${item.description}\n\nSubmitted by: ${item.submitter}\nDate: ${new Date(item.dateSubmitted).toLocaleDateString()}\nStatus: ${item.status}`);
}

function deleteProposedAgendaItem(id) {
    if (!confirm('Delete this proposed agenda item?')) return;
    let items = storage.getProposedAgendaItems();
    items = items.filter(i => i.id !== id);
    storage.saveProposedAgendaItems(items);
    showToast('Proposed agenda item deleted.', 'info');
    updateProposedAgendaTable();
}

// ========== FEATURE 2: Voting Transparency & Quorum ==========
function updateVotePercentages() {
    const votesFor = parseInt(document.getElementById('gc-votes-for')?.value || 0);
    const votesAgainst = parseInt(document.getElementById('gc-votes-against')?.value || 0);
    const votesAbstain = parseInt(document.getElementById('gc-votes-abstain')?.value || 0);
    const totalVotes = votesFor + votesAgainst + votesAbstain;

    document.getElementById('total-votes').textContent = totalVotes;

    // Update vote counts
    if (document.getElementById('votes-for-count')) {
        document.getElementById('votes-for-count').textContent = votesFor;
    }
    if (document.getElementById('votes-against-count')) {
        document.getElementById('votes-against-count').textContent = votesAgainst;
    }
    if (document.getElementById('votes-abstain-count')) {
        document.getElementById('votes-abstain-count').textContent = votesAbstain;
    }

    if (totalVotes > 0) {
        const percentFor = ((votesFor / totalVotes) * 100).toFixed(1);
        const percentAgainst = ((votesAgainst / totalVotes) * 100).toFixed(1);
        const percentAbstain = ((votesAbstain / totalVotes) * 100).toFixed(1);

        document.getElementById('percent-for').textContent = percentFor + '%';
        document.getElementById('percent-against').textContent = percentAgainst + '%';
        document.getElementById('percent-abstain').textContent = percentAbstain + '%';

        // Update progress bars
        if (document.getElementById('progress-bar-for')) {
            document.getElementById('progress-bar-for').style.width = percentFor + '%';
        }
        if (document.getElementById('progress-bar-against')) {
            document.getElementById('progress-bar-against').style.width = percentAgainst + '%';
        }
        if (document.getElementById('progress-bar-abstain')) {
            document.getElementById('progress-bar-abstain').style.width = percentAbstain + '%';
        }
    } else {
        document.getElementById('percent-for').textContent = '0%';
        document.getElementById('percent-against').textContent = '0%';
        document.getElementById('percent-abstain').textContent = '0%';

        // Reset progress bars
        if (document.getElementById('progress-bar-for')) {
            document.getElementById('progress-bar-for').style.width = '0%';
        }
        if (document.getElementById('progress-bar-against')) {
            document.getElementById('progress-bar-against').style.width = '0%';
        }
        if (document.getElementById('progress-bar-abstain')) {
            document.getElementById('progress-bar-abstain').style.width = '0%';
        }
    }

    updateQuorumStatus();
}

function updateQuorumStatus() {
    const attendees = document.getElementById('gc-attendees').selectedOptions.length;
    const totalMembers = storage.getMembers().length;
    const settings = storage.getGCSettings();

    const quorumByPercentage = Math.ceil((totalMembers * settings.quorumPercentage) / 100);
    const quorumRequired = Math.max(quorumByPercentage, settings.quorumMinimum);

    const quorumStatus = document.getElementById('quorum-status');
    if (!quorumStatus) return;

    if (attendees >= quorumRequired) {
        quorumStatus.innerHTML = `<strong style="color: #2ecc71;">✓ Quorum Met:</strong> ${attendees} of ${totalMembers} members (${quorumRequired} required)`;
    } else {
        quorumStatus.innerHTML = `<strong style="color: #e74c3c;">✗ No Quorum:</strong> ${attendees} of ${totalMembers} members (${quorumRequired} required)`;
    }
}

function saveGCSettings() {
    const percentage = parseInt(document.getElementById('quorum-percentage').value) || 50;
    const minimum = parseInt(document.getElementById('quorum-minimum').value) || 5;

    if (percentage < 1 || percentage > 100) {
        showToast('Quorum percentage must be between 1 and 100.', 'error');
        return;
    }

    if (minimum < 1) {
        showToast('Minimum quorum must be at least 1.', 'error');
        return;
    }

    storage.saveGCSettings({ quorumPercentage: percentage, quorumMinimum: minimum });
    showToast('GC settings saved successfully!', 'success');
}

function loadGCSettings() {
    const settings = storage.getGCSettings();
    const percentageInput = document.getElementById('quorum-percentage');
    const minimumInput = document.getElementById('quorum-minimum');

    if (percentageInput) percentageInput.value = settings.quorumPercentage;
    if (minimumInput) minimumInput.value = settings.quorumMinimum;
}

// ========== FEATURE 3: Action Items & Follow-Up Tracking ==========
function handleActionItemSubmit() {
    const editId = document.getElementById('action-item-edit-id').value;
    if (editId) {
        updateActionItem(editId);
    } else {
        addActionItem();
    }
}

function addActionItem() {
    const description = document.getElementById('action-item-description').value.trim();
    const assignee = document.getElementById('action-item-assignee').value;
    const dueDate = document.getElementById('action-item-due-date').value;
    const relatedGCId = document.getElementById('action-item-related-gc').value;

    if (!description || !assignee || !dueDate) {
        showToast('Please fill in all required fields.', 'error');
        return;
    }

    const actions = storage.getGCActionItems();
    actions.push({
        id: genId(),
        description,
        assignee,
        dueDate,
        relatedGCId,
        status: 'pending',
        createdDate: new Date().toISOString().split('T')[0],
        completedDate: null
    });

    storage.saveGCActionItems(actions);
    showToast('Action item added!', 'success');
    cancelActionItemEdit();
    updateActionItemsTable();
}

function updateActionItem(id) {
    const actions = storage.getGCActionItems();
    const index = actions.findIndex(a => a.id === id);
    if (index === -1) return;

    const description = document.getElementById('action-item-description').value.trim();
    const assignee = document.getElementById('action-item-assignee').value;
    const dueDate = document.getElementById('action-item-due-date').value;
    const relatedGCId = document.getElementById('action-item-related-gc').value;

    if (!description || !assignee || !dueDate) {
        showToast('Please fill in all required fields.', 'error');
        return;
    }

    actions[index] = {
        ...actions[index],
        description,
        assignee,
        dueDate,
        relatedGCId
    };

    storage.saveGCActionItems(actions);
    showToast('Action item updated!', 'success');
    cancelActionItemEdit();
    updateActionItemsTable();
}

function cancelActionItemEdit() {
    document.getElementById('action-item-edit-id').value = '';
    document.getElementById('action-item-description').value = '';
    document.getElementById('action-item-assignee').value = '';
    document.getElementById('action-item-due-date').value = '';
    document.getElementById('action-item-related-gc').value = '';

    document.getElementById('action-item-btn').textContent = 'Add Action Item';
    document.getElementById('action-item-cancel-btn').style.display = 'none';
}

function updateActionItemsTable() {
    const tbody = document.getElementById('action-items-body');
    if (!tbody) return;
    tbody.innerHTML = '';

    const actions = storage.getGCActionItems().filter(a => a.status !== 'completed').sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

    actions.forEach(action => {
        const tr = document.createElement('tr');
        const today = new Date().toISOString().split('T')[0];
        const isOverdue = action.dueDate < today;
        const dueDateColor = isOverdue ? '#e74c3c' : '#ecf0f1';

        const statusOptions = ['pending', 'in-progress', 'completed']
            .map(s => `<option value="${s}" ${s === action.status ? 'selected' : ''}>${s.charAt(0).toUpperCase() + s.slice(1).replace('-', ' ')}</option>`)
            .join('');

        tr.innerHTML = `
            <td>${action.description.substring(0, 50)}${action.description.length > 50 ? '...' : ''}</td>
            <td>${action.assignee}</td>
            <td style="color: ${dueDateColor};">${new Date(action.dueDate).toLocaleDateString()}${isOverdue ? ' (OVERDUE)' : ''}</td>
            <td>
                <select onchange="updateActionItemStatus('${action.id}', this.value)" style="background: #34495e; color: #ecf0f1; border: 1px solid #7f8c8d; border-radius: 4px; padding: 0.25rem;">
                    ${statusOptions}
                </select>
            </td>
            <td>
                <button class="btn" data-action="edit-action" data-id="${escapeAttribute(action.id)}" style="margin-right: 5px;">Edit</button>
                <button class="btn secondary" data-action="delete-action" data-id="${escapeAttribute(action.id)}">Delete</button>
            </td>
        `;
        tbody.appendChild(tr);
    });

    if (actions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5">No active action items.</td></tr>';
    }

    populateActionItemDropdowns();
}

function editActionItem(id) {
    const actions = storage.getGCActionItems();
    const action = actions.find(a => a.id === id);
    if (!action) return;

    document.getElementById('action-item-edit-id').value = action.id;
    document.getElementById('action-item-description').value = action.description;
    document.getElementById('action-item-assignee').value = action.assignee;
    document.getElementById('action-item-due-date').value = action.dueDate;
    document.getElementById('action-item-related-gc').value = action.relatedGCId || '';

    document.getElementById('action-item-btn').textContent = 'Update Action Item';
    document.getElementById('action-item-cancel-btn').style.display = 'inline-block';
}

function updateActionItemStatus(id, newStatus) {
    const actions = storage.getGCActionItems();
    const index = actions.findIndex(a => a.id === id);
    if (index === -1) return;

    actions[index].status = newStatus;
    if (newStatus === 'completed') {
        actions[index].completedDate = new Date().toISOString().split('T')[0];
    }

    storage.saveGCActionItems(actions);
    showToast('Action item status updated!', 'success');
    updateActionItemsTable();
}

function deleteActionItem(id) {
    if (!confirm('Delete this action item?')) return;
    let actions = storage.getGCActionItems();
    actions = actions.filter(a => a.id !== id);
    storage.saveGCActionItems(actions);
    showToast('Action item deleted.', 'info');
    updateActionItemsTable();
}

function populateActionItemDropdowns() {
    const assigneeSelect = document.getElementById('action-item-assignee');
    const relatedGCSelect = document.getElementById('action-item-related-gc');

    if (assigneeSelect) {
        const currentValue = assigneeSelect.value;
        assigneeSelect.innerHTML = '<option value="">Select member...</option>';
        const members = storage.getMembers().sort((a, b) => a.name.localeCompare(b.name));
        members.forEach(m => {
            const option = document.createElement('option');
            option.value = m.name;
            option.textContent = m.name;
            assigneeSelect.appendChild(option);
        });
        if (currentValue) assigneeSelect.value = currentValue;
    }

    if (relatedGCSelect) {
        const currentValue = relatedGCSelect.value;
        relatedGCSelect.innerHTML = '<option value="">None</option>';
        const gcLogs = storage.getGroupConscienceLog().sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 20);
        gcLogs.forEach(log => {
            const option = document.createElement('option');
            option.value = log.id;
            option.textContent = `${new Date(log.date).toLocaleDateString()} - ${log.item.substring(0, 50)}`;
            relatedGCSelect.appendChild(option);
        });
        if (currentValue) relatedGCSelect.value = currentValue;
    }
}

// ========== FEATURE 4: Discussion Threading & Comments ==========
let currentGCIdForComments = null;

function openGCDetailsModal(id) {
    currentGCIdForComments = id;
    const logs = storage.getGroupConscienceLog();
    const log = logs.find(l => l.id === id);
    if (!log) return;

    const votesFor = log.votesFor || 0;
    const votesAgainst = log.votesAgainst || 0;
    const votesAbstain = log.votesAbstain || 0;
    const totalVotes = votesFor + votesAgainst + votesAbstain;

    let votesDisplay = '';
    if (totalVotes > 0) {
        const percentFor = ((votesFor / totalVotes) * 100).toFixed(1);
        const percentAgainst = ((votesAgainst / totalVotes) * 100).toFixed(1);
        const percentAbstain = ((votesAbstain / totalVotes) * 100).toFixed(1);
        votesDisplay = `
            <div style="margin-top: 1rem;">
                <strong style="display: block; margin-bottom: 0.5rem;">Voting Results (Total: ${totalVotes})</strong>
                <div class="vote-progress-container">
                    <div class="vote-progress-item">
                        <div class="vote-progress-label">
                            <span><strong>For:</strong> ${votesFor}</span>
                            <span>${percentFor}%</span>
                        </div>
                        <div class="vote-progress-bar-bg">
                            <div class="vote-progress-bar-fill for" style="width: ${percentFor}%;"></div>
                        </div>
                    </div>
                    <div class="vote-progress-item">
                        <div class="vote-progress-label">
                            <span><strong>Against:</strong> ${votesAgainst}</span>
                            <span>${percentAgainst}%</span>
                        </div>
                        <div class="vote-progress-bar-bg">
                            <div class="vote-progress-bar-fill against" style="width: ${percentAgainst}%;"></div>
                        </div>
                    </div>
                    <div class="vote-progress-item">
                        <div class="vote-progress-label">
                            <span><strong>Abstain:</strong> ${votesAbstain}</span>
                            <span>${percentAbstain}%</span>
                        </div>
                        <div class="vote-progress-bar-bg">
                            <div class="vote-progress-bar-fill abstain" style="width: ${percentAbstain}%;"></div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else if (log.votes) {
        votesDisplay = `<div style="margin-top: 0.5rem;"><strong>Votes:</strong> ${log.votes}</div>`;
    }

    const attendeesList = Array.isArray(log.attendees) ? log.attendees.join(', ') : (log.attendees || 'N/A');
    const attendeeCount = Array.isArray(log.attendees) ? log.attendees.length : 0;

    // Calculate participation rate
    const totalMembers = storage.getMembers().length;
    const participationRate = totalMembers > 0 ? ((attendeeCount / totalMembers) * 100).toFixed(1) : 0;

    const detailsContent = document.getElementById('gc-details-content');
    detailsContent.innerHTML = `
        <div style="background: #34495e; padding: 1rem; border-radius: 6px;">
            <div><strong>Date:</strong> ${new Date(log.date).toLocaleDateString()}</div>
            <div style="margin-top: 0.5rem;"><strong>Motion:</strong> ${log.item}</div>
            <div style="margin-top: 0.5rem;"><strong>Submitted By:</strong> ${log.submittedBy || 'N/A'}</div>
            <div style="margin-top: 0.5rem;"><strong>Status:</strong> <span style="color: ${log.status === 'passed' ? '#2ecc71' : log.status === 'failed' ? '#e74c3c' : '#f39c12'};">${log.status.toUpperCase()}</span></div>
            ${votesDisplay}
            <div style="margin-top: 0.5rem;">
                <strong>Members Present:</strong> ${attendeeCount} of ${totalMembers} (${participationRate}% turnout)
                <div style="font-size: 0.85rem; opacity: 0.9; margin-top: 0.25rem;">${attendeesList}</div>
            </div>
        </div>
    `;

    loadGCComments(id);
    document.getElementById('gc-details-modal').style.display = 'flex';
}

function closeGCDetailsModal() {
    document.getElementById('gc-details-modal').style.display = 'none';
    currentGCIdForComments = null;
    document.getElementById('gc-comment-text').value = '';
    document.getElementById('gc-comment-author').value = '';
}

function loadGCComments(gcId) {
    const commentsList = document.getElementById('gc-comments-list');
    const allComments = storage.getGCComments();
    const comments = allComments.filter(c => c.gcId === gcId).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

    if (comments.length === 0) {
        commentsList.innerHTML = '<div style="text-align: center; opacity: 0.6; padding: 1rem;">No comments yet.</div>';
        return;
    }

    // Separate amendments from other comments
    const amendments = comments.filter(c => c.type === 'amendment');
    const otherComments = comments.filter(c => c.type !== 'amendment');

    let html = '';

    // Show Amendment Timeline if there are amendments
    if (amendments.length > 0) {
        html += '<div style="margin-bottom: 1.5rem;"><h4 style="color: #f39c12; margin-bottom: 0.75rem;">Amendment History</h4><div class="amendment-timeline">';
        amendments.forEach(amendment => {
            const statusClass = amendment.status || '';
            const statusBadge = amendment.status === 'adopted'
                ? '<span style="background: #2ecc71; color: white; padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.75rem; margin-left: 0.5rem;">ADOPTED</span>'
                : amendment.status === 'rejected'
                ? '<span style="background: #e74c3c; color: white; padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.75rem; margin-left: 0.5rem;">REJECTED</span>'
                : '';

            html += `
                <div class="amendment-item ${statusClass}">
                    <div style="margin-bottom: 0.5rem;">
                        <strong style="color: #f39c12;">${amendment.author}</strong>
                        <span style="font-size: 0.75rem; opacity: 0.7; margin-left: 0.5rem;">${new Date(amendment.timestamp).toLocaleString()}</span>
                        ${statusBadge}
                    </div>
                    <div style="margin-bottom: 0.5rem;">${escapeHtml(amendment.text)}</div>
                    ${!amendment.status ? `
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                            <button class="btn" style="font-size: 0.75rem; padding: 0.3rem 0.6rem;" data-action="update-amendment" data-id="${escapeAttribute(amendment.id)}" data-status="adopted">Mark Adopted</button>
                            <button class="btn secondary" style="font-size: 0.75rem; padding: 0.3rem 0.6rem;" data-action="update-amendment" data-id="${escapeAttribute(amendment.id)}" data-status="rejected">Mark Rejected</button>
                        </div>
                    ` : ''}
                    <button class="btn secondary" style="font-size: 0.75rem; padding: 0.3rem 0.6rem; margin-top: 0.5rem;" data-action="delete-comment" data-id="${escapeAttribute(amendment.id)}">Delete</button>
                </div>
            `;
        });
        html += '</div></div>';
    }

    // Show other comments
    if (otherComments.length > 0) {
        html += '<div><h4 style="color: #3498db; margin-bottom: 0.75rem;">Discussion & Comments</h4>';
        otherComments.forEach(comment => {
            const typeColors = {
                discussion: '#3498db',
                clarification: '#9b59b6',
                support: '#2ecc71',
                concern: '#e74c3c'
            };
            const typeColor = typeColors[comment.type] || '#7f8c8d';

            html += `
            <div style="background: #2c3e50; padding: 0.75rem; border-radius: 4px; margin-bottom: 0.5rem; border-left: 4px solid ${typeColor};">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                        <strong>${comment.author}</strong>
                        <span style="font-size: 0.8rem; opacity: 0.7; margin-left: 0.5rem;">${new Date(comment.timestamp).toLocaleString()}</span>
                        <span style="background: ${typeColor}; padding: 0.1rem 0.4rem; border-radius: 3px; font-size: 0.7rem; margin-left: 0.5rem;">${comment.type}</span>
                    </div>
                    <button data-action="delete-comment" data-id="${escapeAttribute(comment.id)}" style="background: none; border: none; color: #e74c3c; cursor: pointer; font-size: 1.2rem;">&times;</button>
                </div>
                <div style="margin-top: 0.5rem;">${escapeHtml(comment.text)}</div>
            </div>
        `;
        });
        html += '</div>';
    }

    commentsList.innerHTML = html;
}

function updateAmendmentStatus(amendmentId, status) {
    let comments = storage.getGCComments();
    const comment = comments.find(c => c.id === amendmentId);
    if (comment) {
        comment.status = status;
        storage.saveGCComments(comments);
        showToast(`Amendment marked as ${status}!`, 'success');
        loadGCComments(currentGCIdForComments);
    }
}

function addGCComment() {
    if (!currentGCIdForComments) return;

    const text = document.getElementById('gc-comment-text').value.trim();
    const author = document.getElementById('gc-comment-author').value.trim();
    const type = document.getElementById('gc-comment-type').value;

    if (!text || !author) {
        showToast('Please provide both comment text and your name.', 'error');
        return;
    }

    const comments = storage.getGCComments();
    comments.push({
        id: genId(),
        gcId: currentGCIdForComments,
        text,
        author,
        type,
        timestamp: new Date().toISOString()
    });

    storage.saveGCComments(comments);
    showToast('Comment added!', 'success');

    document.getElementById('gc-comment-text').value = '';
    document.getElementById('gc-comment-author').value = '';

    loadGCComments(currentGCIdForComments);
}

function deleteGCComment(id) {
    if (!confirm('Delete this comment?')) return;
    let comments = storage.getGCComments();
    comments = comments.filter(c => c.id !== id);
    storage.saveGCComments(comments);
    showToast('Comment deleted.', 'info');
    if (currentGCIdForComments) {
        loadGCComments(currentGCIdForComments);
    }
}

// ========== FEATURE 5: Historical Analysis & Search ==========
function searchGCHistory() {
    const searchText = document.getElementById('gc-search')?.value.toLowerCase() || '';
    const filterStatus = document.getElementById('gc-filter-status')?.value || '';
    const dateFrom = document.getElementById('gc-filter-date-from')?.value || '';
    const dateTo = document.getElementById('gc-filter-date-to')?.value || '';

    let logs = storage.getGroupConscienceLog();

    if (searchText) {
        logs = logs.filter(log =>
            log.item.toLowerCase().includes(searchText) ||
            (log.submittedBy && log.submittedBy.toLowerCase().includes(searchText))
        );
    }

    if (filterStatus) {
        logs = logs.filter(log => log.status === filterStatus);
    }

    if (dateFrom) {
        logs = logs.filter(log => log.date >= dateFrom);
    }

    if (dateTo) {
        logs = logs.filter(log => log.date <= dateTo);
    }

    logs.sort((a, b) => new Date(b.date) - new Date(a.date));

    const tbody = document.getElementById('gc-history-search-body');
    if (!tbody) return;
    tbody.innerHTML = '';

    logs.forEach(log => {
        const tr = document.createElement('tr');
        const votesFor = log.votesFor || 0;
        const votesAgainst = log.votesAgainst || 0;
        const votesAbstain = log.votesAbstain || 0;
        const votesDisplay = (votesFor || votesAgainst || votesAbstain)
            ? `${votesFor}-${votesAgainst}-${votesAbstain}`
            : (log.votes || 'N/A');

        tr.innerHTML = `
            <td>${new Date(log.date).toLocaleDateString()}</td>
            <td>${log.item.substring(0, 60)}${log.item.length > 60 ? '...' : ''}</td>
            <td style="color: ${log.status === 'passed' ? '#2ecc71' : log.status === 'failed' ? '#e74c3c' : '#f39c12'};">${log.status.toUpperCase()}</td>
            <td>${votesDisplay}</td>
            <td>
                <button class="btn" data-action="view-gc" data-id="${escapeAttribute(log.id)}">View Details</button>
            </td>
        `;
        tbody.appendChild(tr);
    });

    if (logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5">No results found.</td></tr>';
    }

    updateGCStatistics();
}

function updateGCStatistics() {
    const logs = storage.getGroupConscienceLog();
    const total = logs.length;
    const passed = logs.filter(l => l.status === 'passed').length;
    const failed = logs.filter(l => l.status === 'failed').length;
    const tabled = logs.filter(l => l.status === 'tabled').length;
    const passRate = total > 0 ? ((passed / total) * 100).toFixed(1) : 0;

    document.getElementById('stat-total-motions').textContent = total;
    document.getElementById('stat-passed-motions').textContent = passed;
    document.getElementById('stat-failed-motions').textContent = failed;
    document.getElementById('stat-tabled-motions').textContent = tabled;
    document.getElementById('stat-pass-rate').textContent = passRate + '%';
}

// ========== FEATURE: GC Trends Dashboard ==========
let gcTrendsCharts = {
    monthly: null,
    status: null,
    participation: null
};

function refreshGCTrends() {
    renderMonthlyActivityChart();
    renderStatusDistributionChart();
    renderParticipationTrendChart();
    renderTopTopics();
    populateAnnualReportYears();
}

function renderMonthlyActivityChart() {
    const logs = storage.getGroupConscienceLog();
    const monthCounts = {};

    logs.forEach(log => {
        const date = new Date(log.date);
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        monthCounts[monthKey] = (monthCounts[monthKey] || 0) + 1;
    });

    const sortedMonths = Object.keys(monthCounts).sort();
    const last12Months = sortedMonths.slice(-12);
    const counts = last12Months.map(month => monthCounts[month]);

    const ctx = document.getElementById('gc-trends-monthly-chart');
    if (!ctx) return;

    if (gcTrendsCharts.monthly) {
        gcTrendsCharts.monthly.destroy();
    }

    gcTrendsCharts.monthly = new Chart(ctx, {
        type: 'line',
        data: {
            labels: last12Months.map(m => {
                const [year, month] = m.split('-');
                return new Date(year, month - 1).toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
            }),
            datasets: [{
                label: 'Motions per Month',
                data: counts,
                borderColor: '#3498db',
                backgroundColor: 'rgba(52, 152, 219, 0.2)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { color: '#ecf0f1', stepSize: 1 },
                    grid: { color: 'rgba(127, 140, 141, 0.2)' }
                },
                x: {
                    ticks: { color: '#ecf0f1' },
                    grid: { color: 'rgba(127, 140, 141, 0.2)' }
                }
            }
        }
    });
}

function renderStatusDistributionChart() {
    const logs = storage.getGroupConscienceLog();
    const passed = logs.filter(l => l.status === 'passed').length;
    const failed = logs.filter(l => l.status === 'failed').length;
    const tabled = logs.filter(l => l.status === 'tabled').length;

    const ctx = document.getElementById('gc-trends-status-chart');
    if (!ctx) return;

    if (gcTrendsCharts.status) {
        gcTrendsCharts.status.destroy();
    }

    gcTrendsCharts.status = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Passed', 'Failed', 'Tabled'],
            datasets: [{
                data: [passed, failed, tabled],
                backgroundColor: ['#2ecc71', '#e74c3c', '#f39c12'],
                borderWidth: 2,
                borderColor: '#2c3e50'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { color: '#ecf0f1' }
                }
            }
        }
    });
}

function renderParticipationTrendChart() {
    const logs = storage.getGroupConscienceLog().sort((a, b) => new Date(a.date) - new Date(b.date));
    const last10 = logs.slice(-10);

    const participationData = last10.map(log => {
        const totalVotes = (log.votesFor || 0) + (log.votesAgainst || 0) + (log.votesAbstain || 0);
        return totalVotes;
    });

    const labels = last10.map((log, idx) => `Motion ${idx + 1}`);

    const ctx = document.getElementById('gc-trends-participation-chart');
    if (!ctx) return;

    if (gcTrendsCharts.participation) {
        gcTrendsCharts.participation.destroy();
    }

    gcTrendsCharts.participation = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Total Votes Cast',
                data: participationData,
                backgroundColor: '#3498db',
                borderColor: '#2980b9',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { color: '#ecf0f1', stepSize: 1 },
                    grid: { color: 'rgba(127, 140, 141, 0.2)' }
                },
                x: {
                    ticks: { color: '#ecf0f1' },
                    grid: { color: 'rgba(127, 140, 141, 0.2)' }
                }
            }
        }
    });
}

function renderTopTopics() {
    const logs = storage.getGroupConscienceLog();
    const wordCounts = {};

    // Common words to exclude
    const stopWords = new Set(['the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by', 'from', 'is', 'was', 'are', 'were', 'be', 'been', 'being', 'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'should', 'could', 'may', 'might', 'can', 'that', 'this', 'these', 'those', 'we', 'us', 'our']);

    logs.forEach(log => {
        const words = log.item.toLowerCase().split(/\s+/);
        words.forEach(word => {
            const cleaned = word.replace(/[^a-z]/g, '');
            if (cleaned.length > 3 && !stopWords.has(cleaned)) {
                wordCounts[cleaned] = (wordCounts[cleaned] || 0) + 1;
            }
        });
    });

    const topWords = Object.entries(wordCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);

    const container = document.getElementById('gc-top-topics');
    if (!container) return;

    if (topWords.length === 0) {
        container.innerHTML = '<p style="opacity: 0.7;">No topic data available yet.</p>';
        return;
    }

    container.innerHTML = topWords.map(([word, count]) => `
        <div style="padding: 0.5rem; margin-bottom: 0.5rem; background: #2c3e50; border-radius: 4px; display: flex; justify-content: space-between;">
            <span style="text-transform: capitalize;">${word}</span>
            <span style="background: #3498db; padding: 0.2rem 0.6rem; border-radius: 3px; font-weight: bold;">${count}</span>
        </div>
    `).join('');
}

function populateAnnualReportYears() {
    const logs = storage.getGroupConscienceLog();
    const years = new Set();

    logs.forEach(log => {
        const year = new Date(log.date).getFullYear();
        years.add(year);
    });

    const currentYear = new Date().getFullYear();
    years.add(currentYear);

    const select = document.getElementById('annual-report-year');
    if (!select) return;

    select.innerHTML = Array.from(years)
        .sort((a, b) => b - a)
        .map(year => `<option value="${year}">${year}</option>`)
        .join('');
}

function generateAnnualReport() {
    const year = parseInt(document.getElementById('annual-report-year').value);
    if (!year) {
        showToast('Please select a year.', 'error');
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const logs = storage.getGroupConscienceLog().filter(log => {
        return new Date(log.date).getFullYear() === year;
    });

    if (logs.length === 0) {
        showToast(`No GC data found for ${year}.`, 'error');
        return;
    }

    // Title
    doc.setFontSize(20);
    doc.text(`Group Conscience Annual Report - ${year}`, 14, 22);

    // Summary Statistics
    doc.setFontSize(14);
    doc.text('Annual Summary', 14, 35);
    doc.setFontSize(11);

    const passed = logs.filter(l => l.status === 'passed').length;
    const failed = logs.filter(l => l.status === 'failed').length;
    const tabled = logs.filter(l => l.status === 'tabled').length;
    const passRate = logs.length > 0 ? ((passed / logs.length) * 100).toFixed(1) : 0;

    let yPos = 45;
    doc.text(`Total Motions: ${logs.length}`, 14, yPos);
    yPos += 7;
    doc.text(`Passed: ${passed}`, 14, yPos);
    yPos += 7;
    doc.text(`Failed: ${failed}`, 14, yPos);
    yPos += 7;
    doc.text(`Tabled: ${tabled}`, 14, yPos);
    yPos += 7;
    doc.text(`Pass Rate: ${passRate}%`, 14, yPos);
    yPos += 12;

    // Motion Details Table
    doc.setFontSize(14);
    doc.text('Motion Details', 14, yPos);
    yPos += 5;

    const tableData = logs.map(log => [
        new Date(log.date).toLocaleDateString(),
        log.item.substring(0, 50) + (log.item.length > 50 ? '...' : ''),
        log.status.toUpperCase(),
        `${log.votesFor || 0}-${log.votesAgainst || 0}-${log.votesAbstain || 0}`
    ]);

    doc.autoTable({
        startY: yPos,
        head: [['Date', 'Motion', 'Status', 'Votes (F-A-Ab)']],
        body: tableData,
        theme: 'grid',
        headStyles: { fillColor: [52, 152, 219] },
        styles: { fontSize: 9 }
    });

    // Footer
    const pageCount = doc.internal.getNumberOfPages();
    doc.setFontSize(10);
    for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.text(`Page ${i} of ${pageCount}`, doc.internal.pageSize.width / 2, doc.internal.pageSize.height - 10, { align: 'center' });
        doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, doc.internal.pageSize.height - 10);
    }

    doc.save(`GC_Annual_Report_${year}.pdf`);
    showToast(`Annual report for ${year} downloaded successfully!`, 'success');
}

// ========== FEATURE: Notification & Reminder System ==========
function checkUpcomingGCMeetings() {
    // Check localStorage for the last GC meeting date
    const logs = storage.getGroupConscienceLog();
    if (logs.length === 0) return;

    // Sort by date to get the most recent
    const sortedLogs = logs.sort((a, b) => new Date(b.date) - new Date(a.date));
    const lastGCDate = new Date(sortedLogs[0].date);
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    // Calculate days since last GC
    const daysSinceLastGC = Math.floor((today - lastGCDate) / (1000 * 60 * 60 * 24));

    // Assuming monthly GC meetings (30 days), warn at 25+ days
    if (daysSinceLastGC >= 25 && daysSinceLastGC < 40) {
        const daysUntilNext = 30 - daysSinceLastGC;
        if (daysUntilNext > 0) {
            showNotificationBanner(`Group Conscience meeting coming up in approximately ${daysUntilNext} days!`, 'info');
        } else {
            showNotificationBanner(`Group Conscience meeting may be overdue! Last meeting was ${daysSinceLastGC} days ago.`, 'warning');
        }
    }

    // Check for pending proposed agenda items
    const proposedItems = storage.getProposedAgendaItems().filter(item => item.status === 'pending');
    if (proposedItems.length > 0) {
        showNotificationBanner(`${proposedItems.length} proposed agenda item(s) pending for next GC meeting.`, 'info');
    }

    // Check for incomplete action items
    const actionItems = storage.getGCActionItems().filter(item => item.status !== 'completed');
    const overdueActions = actionItems.filter(item => {
        if (!item.dueDate) return false;
        return new Date(item.dueDate) < today;
    });

    if (overdueActions.length > 0) {
        showNotificationBanner(`${overdueActions.length} GC action item(s) are overdue!`, 'urgent');
    }
}

function showNotificationBanner(message, type = 'info') {
    // Check if we've already shown this notification in this session
    const sessionKey = `notification_shown_${message}`;
    if (sessionStorage.getItem(sessionKey)) {
        return; // Don't show duplicate notifications in same session
    }

    const banner = document.createElement('div');
    banner.style.cssText = `
        position: fixed;
        top: 60px;
        left: 50%;
        transform: translateX(-50%);
        background: ${type === 'urgent' ? '#e74c3c' : type === 'warning' ? '#f39c12' : '#3498db'};
        color: white;
        padding: 1rem 2rem;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 1000;
        max-width: 600px;
        text-align: center;
        animation: slideDown 0.3s ease;
    `;
    banner.innerHTML = `
        <div style="display: flex; align-items: center; gap: 1rem;">
            <i class="fas fa-bell" style="font-size: 1.2rem;"></i>
            <span>${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; margin-left: 1rem;">&times;</button>
        </div>
    `;

    document.body.appendChild(banner);

    // Mark as shown for this session
    sessionStorage.setItem(sessionKey, 'true');

    // Auto-remove after 10 seconds
    setTimeout(() => {
        if (banner.parentElement) {
            banner.style.animation = 'slideUp 0.3s ease';
            setTimeout(() => banner.remove(), 300);
        }
    }, 10000);
}

// Request browser notification permission
function requestNotificationPermission() {
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
                showToast('Browser notifications enabled!', 'success');
            }
        });
    }
}

// Show browser notification (if permission granted)
function showBrowserNotification(title, message) {
    if ('Notification' in window && Notification.permission === 'granted') {
        new Notification(title, {
            body: message,
            icon: 'logo.svg',
            badge: 'logo.svg'
        });
    }
}


function exportChairpersonLogToPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const log = storage.getChairpersonLog().sort((a, b) => new Date(a.date) - new Date(b.date));

    if (log.length === 0) {
        showToast('No log entries to export.', 'error');
        return;
    }

    doc.setFontSize(18);
    doc.text("Chairperson's Contribution Log", 14, 22);

    const tableColumn = ["Date", "Time", "Chairperson", "Head Count", "7th Tradition ($)", "Orange Can ($)"];
    const tableRows = [];

    log.forEach(entry => {
        const timeStr = entry.time ? new Date('1970-01-01T' + entry.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'N/A';
        const logData = [
            new Date(entry.date).toLocaleDateString(),
            timeStr,
            entry.chairperson || 'N/A',
            entry.headcount,
            entry.tradition.toFixed(2),
            entry.orangeCan.toFixed(2)
        ];
        tableRows.push(logData);
    });

    doc.autoTable({
        head: [tableColumn],
        body: tableRows,
        startY: 30,
    });

    doc.save('Chairperson_Log_Report.pdf');
    showToast('PDF export generated!', 'success');
}

function exportGroupConscienceLogToPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const logs = storage.getGroupConscienceLog().sort((a, b) => new Date(a.date) - new Date(b.date));

    if (logs.length === 0) {
        showToast('No Group Conscience entries to export.', 'error');
        return;
    }

    doc.setFontSize(18);
    doc.text("Group Conscience Log", 14, 22);

    let y = 30;

    logs.forEach((log, index) => {
        if (y > 260) {
            doc.addPage();
            y = 20;
        }

        doc.setFontSize(14);
        doc.text(`Date: ${new Date(log.date).toLocaleDateString()}`, 14, y);
        y += 7;

        doc.setFontSize(12);
        doc.text(`Motion/Item: ${log.item}`, 14, y);
        y += 7;

        doc.text(`Submitted By: ${log.submittedBy}`, 14, y);
        y += 7;

        doc.text(`Status: ${log.status}`, 14, y);
        y += 7;

        doc.text(`Votes: ${log.votes}`, 14, y);
        y += 7;

        doc.text("Members Present:", 14, y);
        y += 7;
        const attendeesText = Array.isArray(log.attendees) ? log.attendees.join(', ') : (log.attendees || '');
        const attendees = doc.splitTextToSize(attendeesText, 180);
        doc.text(attendees, 14, y);
        y += attendees.length * 5;

        doc.text("Servant Reports:", 14, y);
        y += 7;

        let reportsText = '';
        if (log.servantReports && Array.isArray(log.servantReports) && log.servantReports.length > 0) {
            reportsText = log.servantReports.map(r => `${r.servantName}:\n${r.report}`).join('\n\n');
        } else if (log.servantReports && typeof log.servantReports === 'string') {
            reportsText = log.servantReports;
        } else {
            reportsText = 'No reports submitted.';
        }

        const reports = doc.splitTextToSize(reportsText, 180);
        doc.text(reports, 14, y);
        y += reports.length * 5;

        if (index < logs.length - 1) {
            doc.line(14, y, 200, y); // Separator line
            y += 10;
        }
    });

    doc.save('Group_Conscience_Log.pdf');
    showToast('PDF export generated!', 'success');
}

// Data Management
function exportData(dataType) {
    let data;
    let filename = 'rowlett_group_data.json';
    const keys = {
        events: 'events',
        birthdays: 'birthdays',
        announcements: 'announcements',
        photos: 'photos',
        chairpersonLog: 'chairpersonLog',
        groupConscienceLog: 'groupConscienceLog',
    };

    if (dataType === 'all') {
        data = {};
        Object.keys(keys).forEach(key => {
            data[key] = JSON.parse(localStorage.getItem(keys[key]) || '[]');
        });
        // Handle non-JSON items

    } else if (keys[dataType]) {
        data = { [dataType]: JSON.parse(localStorage.getItem(keys[dataType]) || '[]') };
        filename = `rowlett_group_${dataType}.json`;
    } else {
        showToast('Invalid data type for export.', 'error');
        return;
    }

    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
    showToast('Data exported successfully!', 'success');
}

function importData() {
    const fileInput = document.getElementById('import-file');
    const file = fileInput.files[0];
    if (!file) {
        showToast('Please select a file to import.', 'error');
        return;
    }

    if (!confirm('Are you sure you want to import this data? This will overwrite existing data.')) {
        return;
    }

    const reader = new FileReader();
    reader.onload = function(event) {
        try {
            const data = JSON.parse(event.target.result);
            let imported = false;

            if (data.events) { storage.saveEvents(data.events); imported = true; }
            if (data.birthdays) { storage.saveBirthdays(data.birthdays); imported = true; }
            if (data.announcements) { storage.saveAnnouncements(data.announcements); imported = true; }
            if (data.photos) { storage.savePhotos(data.photos); imported = true; }
            if (data.chairpersonLog) { storage.saveChairpersonLog(data.chairpersonLog); imported = true; }
            if (data.groupConscienceLog) { storage.saveGroupConscienceLog(data.groupConscienceLog); imported = true; }

            if (imported) {
                showToast('Data imported successfully! The page will now reload.', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showToast('The selected file does not contain valid data to import.', 'error');
            }
        } catch (e) {
            showToast('Failed to parse JSON file. Ensure it is a valid backup file.', 'error');
            console.error('Import error:', e);
        }
    };
    reader.readAsText(file);
}

// Update gallery display
function updateGallery() {
    const grid = document.getElementById('gallery-grid');
    const filterInput = document.getElementById('tag-filter');
    const filterValue = filterInput.value.toLowerCase().trim();
    grid.innerHTML = '';

    const photos = storage.getPhotos();
    const filteredPhotos = filterValue ? photos.filter(p => p.tags.some(tag => tag.toLowerCase().includes(filterValue))) : photos;

    filteredPhotos.forEach((photo, idx) => {
        const originalIndex = photos.findIndex(p => p.src === photo.src); // Find original index for deletion
        const wrapper = document.createElement('div');
        wrapper.style.position = 'relative';
        const img = document.createElement('img');
        img.src = photo.src;
        img.onclick = () => openModal(idx, filteredPhotos);
        wrapper.appendChild(img);
        const delBtn = document.createElement('button');
        delBtn.innerHTML = '<i class="fas fa-trash"></i>';
        delBtn.style.position = 'absolute';
        delBtn.style.top = '5px';
        delBtn.style.right = '5px';
        delBtn.style.background = 'rgba(0,0,0,0.7)';
        delBtn.style.color = 'white';
        delBtn.style.border = 'none';
        delBtn.style.borderRadius = '50%';
        delBtn.style.width = '30px';
        delBtn.style.height = '30px';
        delBtn.style.lineHeight = '30px';
        delBtn.style.textAlign = 'center';
        delBtn.style.cursor = 'pointer';
        delBtn.style.fontSize = '14px';
        delBtn.onclick = (e) => {
            e.stopPropagation(); // Prevent modal from opening
            deletePhoto(originalIndex);
        };
        wrapper.appendChild(delBtn);
        grid.appendChild(wrapper);
    });

    if (filteredPhotos.length === 0) {
        grid.innerHTML = '<p>No photos match the filter.</p>';
    }
    renderTagList();
}

function renderTagList() {
    const tagList = document.getElementById('tag-list');
    const photos = storage.getPhotos();
    const allTags = [...new Set(photos.flatMap(p => p.tags))]; // Get unique tags
    tagList.innerHTML = '';
    allTags.forEach(tag => {
        const tagEl = document.createElement('span');
        tagEl.className = 'btn secondary';
        tagEl.textContent = tag;
        tagEl.style.marginRight = '0.5rem';
        tagEl.style.marginBottom = '0.5rem';
        tagEl.style.cursor = 'pointer';
        tagEl.onclick = () => setTagFilter(tag);
        tagList.appendChild(tagEl);
    });
}

function setTagFilter(tag) {
    const filterInput = document.getElementById('tag-filter');
    filterInput.value = tag;
    updateGallery();
}
// Update home overview boxes
function updateHome() {
    const homeEvents = document.getElementById('home-upcoming-events');
    homeEvents.innerHTML = '';
    const occ = computeUpcomingOccurrences(30);
    occ.slice(0, 5).forEach(item => {
        const li = document.createElement('li');
        li.textContent = `${item.occurDate.toLocaleDateString()} ${item.occurDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} — ${item.event.title}`;
        homeEvents.appendChild(li);
    });
    if (occ.length === 0) {
        homeEvents.innerHTML = '<li>No upcoming events</li>';
    }
    const homeBirthdays = document.getElementById('home-upcoming-birthdays');
    homeBirthdays.innerHTML = '';
    const allMembers = storage.getMembers();
    const membersInWindow = getAnniversariesInWindow(allMembers, 15, 60);

    const now = new Date();
    now.setHours(0,0,0,0);

    if (membersInWindow.length > 0) {
        membersInWindow.forEach(m => {
            const li = document.createElement('li');
            const years = m.displayDate.getFullYear() - new Date(m.birthday).getFullYear();
            li.textContent = `${m.name} — ${m.displayDate.toLocaleDateString()} (${years} years)`;

            // Highlight past birthdays
            if (m.displayDate < now) {
                li.style.backgroundColor = '#6b5d2f'; // Muted yellow/gold
                li.style.padding = '2px 4px';
                li.style.borderRadius = '3px';
            }
            homeBirthdays.appendChild(li);
        });
    } else {
        homeBirthdays.innerHTML = '<li>No recent or upcoming birthdays.</li>';
    }
    const homeAnnouncements = document.getElementById('home-recent-announcements');
    homeAnnouncements.innerHTML = '';
    const activeAnnouncements = storage.getAnnouncements().filter(a => a.active).slice(0, 3);
    activeAnnouncements.forEach(a => {
        const li = document.createElement('li');
        const dateStr = new Date(a.dateCreated).toLocaleDateString();
        li.textContent = `${dateStr}: ${a.text}`;
        homeAnnouncements.appendChild(li);
    });
    if (activeAnnouncements.length === 0) {
        homeAnnouncements.innerHTML = '<li>No active announcements</li>';
    }
    const homePhotos = document.getElementById('home-latest-photos');
    homePhotos.innerHTML = '';
    const allPhotos = storage.getPhotos();
    const recentPhotos = allPhotos.slice(-Math.min(3, allPhotos.length)).reverse();
    recentPhotos.forEach(photo => {
        const img = document.createElement('img');
        img.src = photo.src;
        img.style.height = '60px';
        img.style.width = 'auto';
        img.style.borderRadius = '4px';
        img.style.cursor = 'pointer';
        const originalIndex = allPhotos.findIndex(p => p.src === photo.src);
        img.onclick = () => openModal(originalIndex, allPhotos);
        homePhotos.appendChild(img);
    });
    if (allPhotos.length === 0) {
        homePhotos.innerHTML = '<span>No photos yet</span>';
    }
}
// History display: show selected timeline and hide others
function showHistory(id) {
    document.querySelectorAll('.history-content').forEach(sec => sec.classList.remove('active'));
    const target = document.getElementById(id);
    if (target) target.classList.add('active');
    document.querySelectorAll('.history-nav button').forEach(btn => btn.classList.remove('active'));
    if (id === 'genesis-history') document.getElementById('genesis-btn').classList.add('active');
    if (id === 'dfw-history') document.getElementById('dfw-btn').classList.add('active');
    if (id === 'rowlett-history') document.getElementById('rowlett-btn').classList.add('active');
}
// Calendar: state for current month
const categoryColors = {
    "General": "#7f8c8d",
    "Open Discussion": "#2ecc71",
    "Closed Discussion": "#e74c3c",
    "Big Book Study": "#f1c40f",
    "12x12 Study": "#9b59b6",
    "Personal Story": "#1abc9c",
    "Foundations Speaker": "#d35400",
    "Birthday Night": "#e67e22"
};
let currentMonthDate = new Date();
currentMonthDate.setDate(1);
function renderCalendar() {
    const grid = document.getElementById('calendar-grid');
    if (!grid) return;
    grid.innerHTML = '';
    const year = currentMonthDate.getFullYear();
    const month = currentMonthDate.getMonth();
    const monthName = currentMonthDate.toLocaleString('default', { month: 'long', year: 'numeric' });
    document.getElementById('calendar-month-year').textContent = monthName;
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    dayNames.forEach(name => {
        const div = document.createElement('div');
        div.className = 'calendar-day-name';
        div.textContent = name;
        grid.appendChild(div);
    });
    for (let i = 0; i < firstDay; i++) {
        const blank = document.createElement('div');
        blank.className = 'calendar-day';
        blank.style.visibility = 'hidden';
        grid.appendChild(blank);
    }
    for (let d = 1; d <= daysInMonth; d++) {
        const date = new Date(year, month, d);
        const cell = document.createElement('div');
        cell.className = 'calendar-day';
        const num = document.createElement('div');
        num.className = 'calendar-day-number';
        num.textContent = d;
        cell.appendChild(num);
        const events = storage.getEvents();
        events.forEach(ev => {
            let occurs = false;
            if (ev.date) {
                if (ev.date === date.toISOString().substring(0,10)) occurs = true;
            } else if (ev.dayOfWeek !== null && ev.dayOfWeek !== undefined) {
                if (date.getDay() === ev.dayOfWeek) occurs = true;
            }
            if (occurs) {
                const evEl = document.createElement('div');
                evEl.className = 'calendar-event';
                evEl.textContent = ev.title;
                evEl.style.borderLeftColor = categoryColors[ev.category] || categoryColors['General'];

                const tooltip = document.createElement('div');
                tooltip.className = 'tooltip';
                let tooltipContent = `<strong>${escapeHtml(ev.title)}</strong><br>`;
                try {
                    const eventTime = new Date('1970-01-01T' + (ev.time || '00:00'));
                    tooltipContent += `Time: ${eventTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}<br>`;
                } catch(e) { /* Ignore invalid time format */ }
                if (ev.speaker) tooltipContent += `Speaker: ${escapeHtml(ev.speaker)}<br>`;
                if (ev.chair) tooltipContent += `Chair: ${escapeHtml(ev.chair)}<br>`;
                if (ev.description) tooltipContent += `Description: ${escapeHtml(ev.description)}`;
                tooltip.innerHTML = tooltipContent;
                evEl.appendChild(tooltip);

                cell.appendChild(evEl);
            }
        });
        grid.appendChild(cell);
    }
    const totalCells = dayNames.length + firstDay + daysInMonth;
    const remainder = totalCells % 7;
    if (remainder !== 0) {
        for (let i = 0; i < 7 - remainder; i++) {
            const blank = document.createElement('div');
            blank.className = 'calendar-day';
            blank.style.visibility = 'hidden';
            grid.appendChild(blank);
        }
    }
}
// Track if event listeners have been initialized to prevent duplicates
let calendarNavInitialized = false;
let mainNavInitialized = false;
let dictionaryInitialized = false;

function initCalendarNav() {
    if (calendarNavInitialized) return;

    const prevBtn = document.getElementById('prev-month-btn');
    const nextBtn = document.getElementById('next-month-btn');
    if (prevBtn) {
        prevBtn.addEventListener('click', () => {
            currentMonthDate.setMonth(currentMonthDate.getMonth() - 1);
            renderCalendar();
        });
    }
    if (nextBtn) {
        nextBtn.addEventListener('click', () => {
            currentMonthDate.setMonth(currentMonthDate.getMonth() + 1);
            renderCalendar();
        });
    }
    calendarNavInitialized = true;
}
// Navigation click handlers
function initNav() {
    if (mainNavInitialized) return;

    // Handle clicks on menu items with sections
    document.querySelectorAll('nav li[data-section]').forEach(li => {
        li.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent event bubbling to parent dropdown
            const target = li.getAttribute('data-section');
            if (target) {
                goToSection(target);
                // Close all dropdowns after navigation
                document.querySelectorAll('nav li.has-dropdown').forEach(dd => {
                    dd.classList.remove('dropdown-open');
                });
            }
        });
    });

    // Handle clicks on dropdown parent items to toggle open/close
    document.querySelectorAll('nav li.has-dropdown').forEach(parent => {
        parent.addEventListener('click', (e) => {
            // Only toggle if clicking on the parent itself, not dropdown children
            if (e.target === parent || (!e.target.hasAttribute('data-section') && e.target.closest('.has-dropdown') === parent)) {
                e.stopPropagation();
                // Close other dropdowns
                document.querySelectorAll('nav li.has-dropdown').forEach(dd => {
                    if (dd !== parent) {
                        dd.classList.remove('dropdown-open');
                    }
                });
                // Toggle this dropdown
                parent.classList.toggle('dropdown-open');
            }
        });
    });

    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
        if (!e.target.closest('nav')) {
            document.querySelectorAll('nav li.has-dropdown').forEach(dd => {
                dd.classList.remove('dropdown-open');
            });
        }
    });

    mainNavInitialized = true;
}

function initDictionary() {
    if (dictionaryInitialized) return;

    const searchBtn = document.getElementById('dictionary-search-btn');
    const searchInput = document.getElementById('dictionary-search-word');
    if (searchBtn) {
        searchBtn.addEventListener('click', searchDictionary);
    }
    if (searchInput) {
        searchInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                searchDictionary();
            }
        });
    }
    dictionaryInitialized = true;
}
// Meeting Companion: format data and display logic
const contentData = {
    'open-discussion': {
        title: 'Open Discussion Meeting',
        content: [
            { type: 'p', text: '<strong>Chairperson opens the meeting:</strong> "Welcome to the Rowlett Group of Alcoholics Anonymous. My name is ___, and I am an alcoholic."' },
            { type: 'p', text: 'Moment of silence, followed by the Serenity Prayer.' },
            { type: 'p', text: 'Read "How It Works" from Chapter 5 of the Big Book.' },
            { type: 'p', text: 'Acknowledge newcomers and visitors.' },
            { type: 'p', text: 'Introduce the topic for discussion. (e.g., a Step, a Tradition, a reading from AA literature, or a general topic related to recovery).' },
            { type: 'p', text: 'Facilitate sharing, ensuring everyone who wants to share has the opportunity.' },
            { type: 'p', text: 'Close with the Lord\'s Prayer or the Responsibility Declaration.' }
        ]
    },
    'closed-discussion': {
        title: 'Closed Discussion Meeting (for alcoholics only)',
        content: [
            { type: 'p', text: '<strong>Chairperson opens the meeting:</strong> "Welcome to the Rowlett Group of Alcoholics Anonymous. This is a closed meeting, for alcoholics or those who have a desire to stop drinking. My name is ___, and I am an alcoholic."' },
            { type: 'p', text: 'Moment of silence, followed by the Serenity Prayer.' },
            { type: 'p', text: 'Read "How It Works" and the Twelve Traditions.' },
            { type: 'p', text: 'Acknowledge newcomers.' },
            { type: 'p', text: 'Introduce the topic, often focusing on more in-depth aspects of the Steps, Traditions, or personal recovery challenges.' },
            { type: 'p', text: 'Facilitate sharing in a safe, closed environment.' },
            { type: 'p', text: 'Close with the Lord\'s Prayer or the Responsibility Declaration.' }
        ]
    },
    'big-book': {
        title: 'Big Book Study',
        content: [
            { type: 'p', text: '<strong>Chairperson opens the meeting:</strong> "Welcome to the Big Book study of the Rowlett Group. My name is ___, and I am an alcoholic."' },
            { type: 'p', text: 'Moment of silence, followed by the Serenity Prayer.' },
            { type: 'p', text: 'Read a chapter or section from the book "Alcoholics Anonymous."' },
            { type: 'p', text: 'The reader or chairperson may pause to allow for comments or questions, or discussion may follow the reading.' },
            { type: 'p', text: 'Focus is on understanding the text and applying it to personal recovery.' },
            { type: 'p', text: 'Close with the Lord\'s Prayer or the Responsibility Declaration.' }
        ]
    },
    '12x12': {
        title: '12 Steps and 12 Traditions Study',
        content: [
            { type: 'p', text: '<strong>Chairperson opens the meeting:</strong> "Welcome to the 12 & 12 study of the Rowlett Group. My name is ___, and I am an alcoholic."' },
            { type: 'p', text: 'Moment of silence, followed by the Serenity Prayer.' },
            { type: 'p', text: 'Read a Step or Tradition from the book "Twelve Steps and Twelve Traditions."' },
            { type: 'p', text: 'Discussion focuses on the selected Step or Tradition, its meaning, and its application in members\' lives.' },
            { type: 'p', text: 'Close with the Lord\'s Prayer or the Responsibility Declaration.' }
        ]
    },
    'personal-story': {
        title: 'Personal Story Speaker Meeting',
        content: [
            { type: 'p', text: '<strong>Chairperson opens the meeting:</strong> "Welcome to the Rowlett Group of Alcoholics Anonymous. My name is ___, and I am an alcoholic."' },
            { type: 'p', text: 'Moment of silence and Serenity Prayer.' },
            { type: 'p', text: 'Read "How It Works."' },
            { type: 'p', text: 'Introduce the speaker. The speaker shares their experience, strength, and hope: what it was like, what happened, and what it\'s like now.' },
            { type: 'p', text: 'Sharing is typically for a set amount of time (e.g., 20-30 minutes).' },
            { type: 'p', text: 'After the speaker, the meeting may open for brief sharing or proceed to closing.' },
            { type: 'p', text: 'Close with the Lord\'s Prayer or the Responsibility Declaration.' }
        ]
    },
    'foundations': {
        title: 'Foundations Speaker Meeting',
        content: [
            { type: 'p', text: '<strong>Chairperson opens the meeting:</strong> "Welcome to the Foundations meeting of the Rowlett Group. My name is ___, and I am an alcoholic."' },
            { type: 'p', text: 'Moment of silence and Serenity Prayer.' },
            { type: 'p', text: 'Introduce the speaker, who will share on a foundational aspect of AA recovery (e.g., Sponsorship, Service, Home Group, a specific Step).' },
            { type: 'p', text: 'The speaker\'s share is the main focus of the meeting.' },
            { type: 'p', text: 'Close with the Lord\'s Prayer or the Responsibility Declaration.' }
        ]
    },
    'birthday': {
        title: 'Birthday Night Meeting',
        content: [
            { type: 'p', text: '<strong>Chairperson opens the meeting:</strong> "Welcome to the Birthday Night celebration of the Rowlett Group. My name is ___, and I am an alcoholic."' },
            { type: 'p', text: 'Moment of silence and Serenity Prayer.' },
            { type: 'p', text: 'Acknowledge members celebrating a sobriety anniversary this month.' },
            { type: 'p', text: 'Invite each person up to receive a chip. They may share briefly on their recovery.' },
            { type: 'p', text: 'The group celebrates their milestones.' },
            { type: 'p', text: 'Close with the Serenity Prayer, often holding hands in a circle.' }
        ]
    },
    'how-it-works': {
        title: 'How It Works',
        content: [
            { type: 'p', text: 'RARELY HAVE we seen a person fail who has thoroughly followed our path. Those who do not recover are people who cannot or will not completely give themselves to this simple program, usually men and women who are constitutionally incapable of being honest with themselves. There are such unfortunates. They are not at fault; they seem to have been born that way. They are naturally incapable of grasping and developing a manner of living which demands rigorous honesty. Their chances are less than average. There are those, too, who suffer from grave emotional and mental disorders, but many of them do recover if they have the capacity to be honest.' },
            { type: 'p', text: 'Our stories disclose in a general way what we used to be like, what happened, and what we are like now. If you have decided you want what we have and are willing to go to any length to get it-then you are ready to take certain steps.' },
            { type: 'p', text: 'At some of these we balked. We thought we could find an easier, softer way. But we could not. With all the earnestness at our command, we beg of you to be fearless and thorough from the very start. Some of us have tried to hold on to our old ideas and the result was nil until we let go absolutely.' },
            { type: 'p', text: 'Remember that we deal with alcohol - cunning, baffling, powerful! Without help it is too much for us. But there is One who has all power-that One is God. May you find Him now!' },
            { type: 'p', text: 'Half measures availed us nothing. We stood at the turning point. We asked His protection and care with complete abandon.' },
            { type: 'p', text: 'Here are the steps we took, which are suggested as a program of recovery:' },
            { type: 'ol', items: [
                'We admitted we were powerless over alcohol - that our lives had become unmanageable.',
                'Came to believe that a Power greater than ourselves could restore us to sanity.',
                'Made a decision to turn our will and our lives over to the care of God as we understood Him.',
                'Made a searching and fearless moral inventory of ourselves.',
                'Admitted to God, to ourselves and to another human being the exact nature of our wrongs.',
                'Were entirely ready to have God remove all these defects of character.',
                'Humbly asked Him to remove our shortcomings.',
                'Made a list of all persons we had harmed, and became willing to make amends to them all.',
                'Made direct amends to such people wherever possible, except when to do so would injure them or others.',
                'Continued to take personal inventory and when we were wrong promptly admitted it.',
                'Sought through prayer and meditation to improve our conscious contact with God as we understood Him, praying only for knowledge of His will for us and the power to carry that out.',
                'Having had a spiritual awakening as the result of these steps, we tried to carry this message to alcoholics and to practice these principles in all our affairs.'
            ]},
            { type: 'p', text: 'Many of us exclaimed, "What an order! I can\'t go through with it." Do not be discouraged. No one among us has been able to maintain anything like perfect adherence to these principles. We are not saints. The point is, that we are willing to grow along spiritual lines. The principles we have set down are guides to progress. We claim spiritual progress rather than spiritual perfection.' },
            { type: 'p', text: 'Our description of the alcoholic, the chapter to the agnostic, and our personal adventures before and after make clear three pertinent ideas:' },
            { type: 'ul', items: [
                'a. That we were alcoholic and could not manage our own lives.',
                'b. That probably no human power could have relieved our alcoholism.',
                'c. That God could and would if He were sought.'
            ]}
        ]
    },
    'traditions': {
        title: 'The Twelve Traditions',
        content: [
            { type: 'ol', items: [
                'Our common welfare should come first; personal recovery depends upon A.A. unity.',
                'For our group purpose there is but one ultimate authority — a loving God as He may express Himself in our group conscience. Our leaders are but trusted servants; they do not govern.',
                'The only requirement for A.A. membership is a desire to stop drinking.',
                'Each group should be autonomous except in matters affecting other groups or A.A. as a whole.',
                'Each group has but one primary purpose — to carry its message to the alcoholic who still suffers.',
                'An A.A. group ought never endorse, finance, or lend the A.A. name to any related facility or outside enterprise, lest problems of money, property, and prestige divert us from our primary purpose.',
                'Every A.A. group ought to be fully self-supporting, declining outside contributions.',
                'Alcoholics Anonymous should remain forever non-professional, but our service centers may employ special workers.',
                'A.A., as such, ought never be organized; but we may create service boards or committees directly responsible to those they serve.',
                'Alcoholics Anonymous has no opinion on outside issues; hence the A.A. name ought never be drawn into public controversy.',
                'Our public relations policy is based on attraction rather than promotion; we need always maintain personal anonymity at the level of press, radio, and films.',
                'Anonymity is the spiritual foundation of all our traditions, ever reminding us to place principles before personalities.'
            ]}
        ]
    },
    'promises': {
        title: 'The 9th Step Promises',
        content: [
            { type: 'p', text: 'If we are painstaking about this phase of our development, we will be amazed before we are halfway through. We are going to know a new freedom and a new happiness. We will not regret the past nor wish to shut the door on it. We will comprehend the word serenity and we will know peace. No matter how far down the scale we have gone, we will see how our experience can benefit others. That feeling of uselessness and self pity will disappear. We will lose interest in selfish things and gain interest in our fellows. Self seeking will slip away. Our whole attitude and outlook upon life will change. Fear of a Meda and of economic insecurity will leave us. We will intuitively know how to handle situations which used to baffle us. We will suddenly realize that God is doing for us what we could not do for ourselves.' },
            { type: 'p', text: 'Are these extravagant promises? We think not! They are being fulfilled among us – Sometimes quickly, sometimes slowly. They will always materialize if we work for them.' }
        ]
    }
};

function renderMeetingFormat(data) {
    if (!data) return '';
    let html = `<h3>${data.title}</h3>`;
    data.content.forEach(item => {
        if (item.type === 'p') {
            html += `<p>${item.text}</p>`;
        } else if (item.type === 'ol' || item.type === 'ul') {
            const listTag = item.type;
            html += `<${listTag} style="list-style-position: inside;">`;
            item.items.forEach(li => {
                html += `<li>${li}</li>`;
            });
            html += `</${listTag}>`;
        }
    });
    return html;
}

function showMeetingFormat(format) {
    const display = document.getElementById('meeting-format-display');
    const data = contentData[format];
    if (data) {
        display.innerHTML = renderMeetingFormat(data);
        display.style.display = 'block';
    }
}

// Dictionary functions
async function searchDictionary() {
    const word = document.getElementById('dictionary-search-word').value.trim();
    const resultsContainer = document.getElementById('dictionary-results');
    if (!word) {
        showToast('Please enter a word to search.', 'error');
        return;
    }
    resultsContainer.innerHTML = '<p>Searching...</p>';

    // Create abort controller for timeout
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout

    try {
        const response = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word)}`, {
            signal: controller.signal
        });
        clearTimeout(timeoutId);

        if (!response.ok) {
            throw new Error('Word not found. Please check your spelling.');
        }
        const data = await response.json();
        displayDictionaryResults(data);
    } catch (error) {
        clearTimeout(timeoutId);
        let errorMsg = 'An error occurred while searching.';
        if (error.name === 'AbortError') {
            errorMsg = 'Search timed out. Please check your internet connection and try again.';
        } else if (error.message) {
            errorMsg = error.message;
        }
        resultsContainer.innerHTML = `<p style="color: #e74c3c;">${escapeHtml(errorMsg)}</p>`;
        showToast(errorMsg, 'error');
    }
}

function displayDictionaryResults(data) {
    const resultsContainer = document.getElementById('dictionary-results');
    resultsContainer.innerHTML = ''; // Clear previous results or "Searching..." text

    if (!data || data.length === 0) {
        resultsContainer.innerHTML = '<p>No definitions found.</p>';
        return;
    }

    const entry = data[0]; // Displaying the first entry found
    let html = `<h3>${escapeHtml(entry.word)} <span style="font-size: 1rem; color: #bdc3c7;">${escapeHtml(entry.phonetic || '')}</span></h3>`;

    if (entry.meanings && Array.isArray(entry.meanings)) {
        entry.meanings.forEach(meaning => {
            html += `<h4 style="color: #3498db; margin-top: 1rem;">${escapeHtml(meaning.partOfSpeech)}</h4>`;
            html += '<ul style="list-style-type: disc; padding-left: 20px;">';
            if (meaning.definitions && Array.isArray(meaning.definitions)) {
                meaning.definitions.forEach(def => {
                    html += `<li>${escapeHtml(def.definition)}`;
                    if (def.example) {
                        html += `<br><em style="color: #95a5a6;">Example: "${escapeHtml(def.example)}"</em>`;
                    }
                    html += '</li>';
                });
            }
            html += '</ul>';
        });
    }

    // Add audio for pronunciation if available (sanitize URL)
    if (entry.phonetics && Array.isArray(entry.phonetics)) {
        const phoneticWithAudio = entry.phonetics.find(p => p.audio);
        if (phoneticWithAudio && phoneticWithAudio.audio) {
            // Validate that audio URL is from trusted domain
            try {
                const audioUrl = new URL(phoneticWithAudio.audio);
                if (audioUrl.protocol === 'https:' && audioUrl.hostname.endsWith('dictionaryapi.dev')) {
                    html += `<div style="margin-top: 1rem;">
                                <p>Pronunciation:</p>
                                <audio controls src="${escapeAttribute(phoneticWithAudio.audio)}" style="width: 100%;">
                                    Your browser does not support the audio element.
                                </audio>
                             </div>`;
                }
            } catch (e) {
                // Invalid URL, skip audio
            }
        }
    }

    resultsContainer.innerHTML = html;
}


// Chairperson's Corner Roster Modal Logic
let rosterSortColumn = 'name';
let rosterSortDirection = 'asc';

function openRosterModal() {
    document.getElementById('roster-modal').style.display = 'flex';
    renderRosterTable();
}

function closeRosterModal() {
    document.getElementById('roster-modal').style.display = 'none';
}

function sortRosterBy(column) {
    if (rosterSortColumn === column) {
        rosterSortDirection = rosterSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        rosterSortColumn = column;
        rosterSortDirection = 'asc';
    }
    // Update header indicators
    document.querySelectorAll('#roster-table th').forEach(th => {
        th.textContent = th.textContent.replace(/ [↑↓]/, '');
    });
    const header = Array.from(document.querySelectorAll('#roster-table th')).find(th => th.textContent.toLowerCase().startsWith(column));
    if (header) {
        header.textContent += rosterSortDirection === 'asc' ? ' ↓' : ' ↑';
    }
    renderRosterTable();
}

function renderRosterTable() {
    const tbody = document.getElementById('roster-table-body');
    if (!tbody) return;
    const searchTerm = document.getElementById('roster-search').value.toLowerCase();
    tbody.innerHTML = '';

    let members = storage.getMembers();

    // 1. Filter
    if (searchTerm) {
        members = members.filter(m => {
            return m.name.toLowerCase().includes(searchTerm) ||
                   (m.email && m.email.toLowerCase().includes(searchTerm)) ||
                   (m.phone && m.phone.includes(searchTerm)) ||
                   (m.homegroup && m.homegroup.toLowerCase().includes(searchTerm)) ||
                   (m.city && m.city.toLowerCase().includes(searchTerm));
        });
    }

    // 2. Sort
    members.sort((a, b) => {
        let valA = a[rosterSortColumn] === undefined ? '' : a[rosterSortColumn];
        let valB = b[rosterSortColumn] === undefined ? '' : b[rosterSortColumn];

        if (typeof valA === 'boolean') {
            valA = valA ? 1 : 0;
            valB = valB ? 1 : 0;
        } else if (typeof valA === 'string') {
            valA = valA.toLowerCase();
            valB = valB.toLowerCase();
        }

        if (valA < valB) return rosterSortDirection === 'asc' ? -1 : 1;
        if (valA > valB) return rosterSortDirection === 'asc' ? 1 : -1;
        return 0;
    });

    // 3. Render
    if(members.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7">No members found.</td></tr>';
        return;
    }

    members.forEach(member => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${member.name}</td>
            <td>${member.city || ''}</td>
            <td>${member.homegroup || ''}</td>
            <td>${member.phone || ''}</td>
            <td>${member.email || ''}</td>
            <td>${member.isServant ? 'Yes' : 'No'}</td>
            <td>
                <button class="btn" data-action="edit-member-roster" data-id="${escapeAttribute(member.id)}">Edit</button>
                <button class="btn secondary" data-action="delete-member-roster" data-id="${escapeAttribute(member.id)}">Delete</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function editMemberFromRoster(id) {
    closeRosterModal();
    editMember(id);
}

function deleteMemberAndRefreshRoster(id) {
    deleteMember(id);
    renderRosterTable();
}

function openMemberFormFromModal() {
    closeRosterModal();
    const form = document.getElementById('add-member-form');
    form.style.display = 'block';
    goToSection('birthdays-section');
    form.scrollIntoView({ behavior: 'smooth' });
}

function populateAttendeeDropdown() {
    const select = document.getElementById('gc-attendees');
    if (!select) return;
    const members = storage.getMembers().sort((a, b) => a.name.localeCompare(b.name));

    // Preserve selected values if they exist, useful if the list is refreshed while form is open
    const selectedValues = Array.from(select.selectedOptions).map(opt => opt.value);

    select.innerHTML = ''; // Clear existing options
    members.forEach(member => {
        const option = document.createElement('option');
        option.value = member.name;
        option.textContent = member.name;
        if (selectedValues.includes(member.name)) {
            option.selected = true;
        }
        select.appendChild(option);
    });
}

function populateMemberDropdowns() {
    const allMembers = storage.getMembers().sort((a, b) => a.name.localeCompare(b.name));
    const servantMembers = allMembers.filter(m => m.isServant);

    const dropdowns = [
        { id: 'log-chairperson', placeholder: 'Select Chairperson', members: servantMembers, optional: false },
        { id: 'event-speaker', placeholder: 'Select Speaker (optional)', members: allMembers, optional: true },
        { id: 'event-chair', placeholder: 'Select Chairperson (optional)', members: servantMembers, optional: true }
    ];

    dropdowns.forEach(dd_info => {
        const select = document.getElementById(dd_info.id);
        if (!select) return;

        const currentValue = select.value;
        select.innerHTML = '';

        const placeholderOption = document.createElement('option');
        placeholderOption.value = '';
        placeholderOption.textContent = dd_info.placeholder;
        select.appendChild(placeholderOption);

        if (dd_info.optional) {
            const noneOption = document.createElement('option');
            noneOption.value = 'None';
            noneOption.textContent = 'None';
            select.appendChild(noneOption);
        }

        dd_info.members.forEach(member => {
            const option = document.createElement('option');
            option.value = member.name;
            option.textContent = member.name;
            select.appendChild(option);
        });

        select.value = currentValue;
    });
}

function renderServantReportInputs() {
    const container = document.getElementById('gc-servant-reports-container');
    if (!container) return;
    container.innerHTML = '';
    const servants = storage.getMembers().filter(m => m.isServant).sort((a, b) => (a.servantPosition || a.name).localeCompare(b.servantPosition || b.name));

    if (servants.length === 0) {
        container.innerHTML = '<p class="text-sm opacity-75">No servants found. Add servants with positions in the Member Roster to see report fields here.</p>';
        return;
    }

    servants.forEach(s => {
        const servantName = s.servantPosition ? `${s.name} (${s.servantPosition})` : s.name;
        const div = document.createElement('div');
        div.className = 'form-group';
        div.innerHTML = `
            <label for="servant-report-${s.id}">${servantName}</label>
            <textarea id="servant-report-${s.id}" data-servant-id="${s.id}" data-servant-name="${servantName}" class="servant-report-input" rows="2" placeholder="Report for ${servantName}..."></textarea>
        `;
        container.appendChild(div);
    });
}

function setupAudioRecorder() {
    const recordBtn = document.getElementById('record-btn');
    const stopBtn = document.getElementById('stop-btn');
    const audioPlayer = document.getElementById('audio-player');
    const downloadLink = document.getElementById('download-link');
    const playerContainer = document.getElementById('audio-player-container');

    if (!recordBtn) return; // Exit if the recorder elements aren't on the page

    const descriptionP = recordBtn.parentElement.previousElementSibling;

    // Allow audio recording when served from file:// or a secure context.
    if (!window.isSecureContext && location.protocol !== 'file:') {
        showToast('Audio recording requires a secure connection (HTTPS or localhost).', 'error');
        recordBtn.disabled = true;
        descriptionP.innerHTML = '<b>Audio recording is disabled.</b> This feature requires a secure connection (HTTPS or localhost). If you are developing locally, please serve the page via a local web server.';
        return;
    }
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia || !window.MediaRecorder) {
        showToast('Audio recording is not supported on this browser.', 'error');
        recordBtn.disabled = true;
        if (descriptionP && descriptionP.tagName === 'P') {
            descriptionP.innerHTML = '<b>Audio recording is not supported on this browser.</b> Please try a modern browser like Chrome or Firefox.';
            descriptionP.style.opacity = 1;
        }
        return;
    }

    let mediaRecorder;
    let chunks = [];

    async function startRecording() {
        try {
            // Request microphone access
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);

            // Event handler for when data is available
            mediaRecorder.ondataavailable = e => {
                chunks.push(e.data);
            };

            // Event handler for when recording stops
            mediaRecorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'audio/webm' });
                chunks = [];
                const audioURL = window.URL.createObjectURL(blob);
                audioPlayer.src = audioURL;
                downloadLink.href = audioURL;

                // Create a filename with a timestamp
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[-:T]/g, '').replace(/ /g, '_');
                downloadLink.download = `meeting-audio-${timestamp}.webm`;

                // Make the player and download link visible
                playerContainer.style.display = 'block';
                downloadLink.style.display = 'inline-block';

                // Stop the microphone track to turn off the browser's recording indicator
                stream.getTracks().forEach(track => track.stop());
            };

            // Start recording and update UI
            mediaRecorder.start();
            recordBtn.disabled = true;
            stopBtn.disabled = false;
            playerContainer.style.display = 'none';
            downloadLink.style.display = 'none';
            showToast('Recording started...', 'info');

        } catch (err) {
            console.error("Error starting recording:", err);
            if (err.name === "NotAllowedError" || err.name === "PermissionDeniedError") {
                showToast('Microphone permission denied. Please allow access in your browser settings.', 'error');
            } else {
                showToast('Could not start recording. No microphone found or an error occurred.', 'error');
            }
        }
    }

    function stopRecording() {
        if (mediaRecorder && mediaRecorder.state !== "inactive") {
            mediaRecorder.stop();
            recordBtn.disabled = false;
            stopBtn.disabled = true;
            showToast('Recording stopped.', 'info');
        }
    }

    recordBtn.addEventListener('click', startRecording);
    stopBtn.addEventListener('click', stopRecording);
}

// ==================== NEW FEATURES ====================

// Mark announcement as read
function markAnnouncementAsRead(announcementId) {
    const ann = storage.getAnnouncements();
    const announcement = ann.find(a => a.id === announcementId);
    if (announcement) {
        const currentUser = storage.getCurrentUser();
        if (!announcement.readBy) announcement.readBy = [];
        if (!announcement.readBy.includes(currentUser)) {
            announcement.readBy.push(currentUser);
            storage.saveAnnouncements(ann);
            updateAnnouncementsList();
            showToast('Marked as read', 'success');
        }
    }
}

// ========== MEMBER MESSAGING FUNCTIONS ==========

function sendMessage() {
    const recipientId = document.getElementById('message-recipient').value;
    const subject = document.getElementById('message-subject').value.trim();
    const text = document.getElementById('message-text').value.trim();

    if (!recipientId || !subject || !text) {
        showToast('Please fill in all fields', 'error');
        return;
    }

    const currentUser = storage.getCurrentUser();
    const messages = storage.getMessages();

    messages.push({
        id: genId(),
        from: currentUser,
        to: recipientId,
        subject: subject,
        message: text,
        date: new Date().toISOString(),
        read: false
    });

    storage.saveMessages(messages);
    showToast('Message sent!', 'success');

    document.getElementById('message-recipient').value = '';
    document.getElementById('message-subject').value = '';
    document.getElementById('message-text').value = '';

    showMessages('sent');
}

function showMessages(type) {
    const container = document.getElementById('messages-container');
    const messages = storage.getMessages();
    const currentUser = storage.getCurrentUser();

    // Update button states
    document.getElementById('inbox-btn').classList.toggle('active', type === 'inbox');
    document.getElementById('sent-btn').classList.toggle('active', type === 'sent');

    const filteredMessages = type === 'inbox'
        ? messages.filter(m => m.to === currentUser)
        : messages.filter(m => m.from === currentUser);

    container.innerHTML = '';

    if (filteredMessages.length === 0) {
        container.innerHTML = `<p>No ${type} messages</p>`;
        return;
    }

    filteredMessages.sort((a, b) => new Date(b.date) - new Date(a.date));

    filteredMessages.forEach(msg => {
        const div = document.createElement('div');
        div.className = `message-item ${!msg.read && type === 'inbox' ? 'unread' : ''}`;

        const header = document.createElement('div');
        header.className = 'message-header';

        const subj = document.createElement('div');
        subj.className = 'message-subject';
        subj.textContent = msg.subject;

        const date = document.createElement('div');
        date.className = 'message-date';
        date.textContent = new Date(msg.date).toLocaleString();

        header.appendChild(subj);
        header.appendChild(date);

        const fromTo = document.createElement('div');
        fromTo.style.fontSize = '0.85rem';
        fromTo.style.marginBottom = '8px';
        fromTo.textContent = type === 'inbox' ? `From: ${msg.from}` : `To: ${msg.to}`;

        const msgText = document.createElement('div');
        msgText.textContent = msg.message;

        div.appendChild(header);
        div.appendChild(fromTo);
        div.appendChild(msgText);

        if (type === 'inbox' && !msg.read) {
            const markReadBtn = document.createElement('button');
            markReadBtn.className = 'btn';
            markReadBtn.style.marginTop = '8px';
            markReadBtn.textContent = 'Mark as Read';
            markReadBtn.onclick = () => markMessageAsRead(msg.id);
            div.appendChild(markReadBtn);
        }

        container.appendChild(div);
    });
}

function markMessageAsRead(messageId) {
    const messages = storage.getMessages();
    const message = messages.find(m => m.id === messageId);
    if (message) {
        message.read = true;
        storage.saveMessages(messages);
        showMessages('inbox');
        showToast('Marked as read', 'success');
    }
}

function populateMessageRecipients() {
    const select = document.getElementById('message-recipient');
    const members = storage.getMembers();
    const currentUser = storage.getCurrentUser();

    select.innerHTML = '<option value="">Select a member...</option>';

    members.forEach(m => {
        if (m.name !== currentUser) {
            const option = document.createElement('option');
            option.value = m.name;
            option.textContent = m.name;
            select.appendChild(option);
        }
    });
}

// ========== SERVICE POSITION FUNCTIONS ==========

function addServicePosition() {
    const name = document.getElementById('position-name').value.trim();
    const description = document.getElementById('position-description').value.trim();
    const termLength = parseInt(document.getElementById('position-term-length').value);
    const currentHolder = document.getElementById('position-current-holder').value;
    const startDate = document.getElementById('position-start-date').value;

    if (!name || !termLength) {
        showToast('Please enter position name and term length', 'error');
        return;
    }

    const positions = storage.getServicePositions();

    positions.push({
        id: genId(),
        name: name,
        description: description,
        termLength: termLength,
        currentHolder: currentHolder,
        startDate: startDate,
        history: []
    });

    storage.saveServicePositions(positions);
    showToast('Service position added!', 'success');

    document.getElementById('position-name').value = '';
    document.getElementById('position-description').value = '';
    document.getElementById('position-term-length').value = '';
    document.getElementById('position-current-holder').value = '';
    document.getElementById('position-start-date').value = '';

    updateServicePositionsTable();
    updateRotationCalendar();
    populateNominationPositions();
}

function updateServicePositionsTable() {
    const tbody = document.getElementById('service-positions-table');
    const positions = storage.getServicePositions();

    tbody.innerHTML = '';

    positions.forEach(pos => {
        const tr = document.createElement('tr');

        const endDate = pos.startDate ? calculateEndDate(pos.startDate, pos.termLength) : 'N/A';
        const daysRemaining = pos.startDate ? calculateDaysRemaining(pos.startDate, pos.termLength) : null;

        let termStatus = '';
        if (daysRemaining !== null) {
            if (daysRemaining < 0) {
                termStatus = `<span class="term-expired">EXPIRED</span>`;
            } else if (daysRemaining < 60) {
                termStatus = `<span class="term-warning">${daysRemaining} days left</span>`;
            }
        }

        tr.innerHTML = `
            <td>${pos.name}</td>
            <td>${pos.currentHolder || 'Vacant'}</td>
            <td>${pos.startDate ? new Date(pos.startDate).toLocaleDateString() : 'N/A'}</td>
            <td>${endDate} ${termStatus}</td>
            <td>
                <button class="btn secondary" data-action="delete-position" data-id="${escapeAttribute(pos.id)}">Delete</button>
            </td>
        `;

        tbody.appendChild(tr);
    });

    if (positions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5">No service positions defined</td></tr>';
    }
}

function deleteServicePosition(id) {
    if (!confirm('Delete this service position?')) return;
    let positions = storage.getServicePositions();
    positions = positions.filter(p => p.id !== id);
    storage.saveServicePositions(positions);
    updateServicePositionsTable();
    updateRotationCalendar();
    populateNominationPositions();
    showToast('Position deleted', 'success');
}

function calculateEndDate(startDate, termMonths) {
    const start = new Date(startDate);
    // Safe date math: add months by calculating total months then reconstructing date
    const startYear = start.getFullYear();
    const startMonth = start.getMonth();
    const startDay = start.getDate();

    const totalMonths = startYear * 12 + startMonth + termMonths;
    const endYear = Math.floor(totalMonths / 12);
    const endMonth = totalMonths % 12;

    // Create end date, handling month-end overflow (e.g., Jan 31 + 1 month = Feb 28/29)
    const end = new Date(endYear, endMonth, 1);
    const maxDay = new Date(endYear, endMonth + 1, 0).getDate();
    end.setDate(Math.min(startDay, maxDay));

    return end.toLocaleDateString();
}

function calculateDaysRemaining(startDate, termMonths) {
    const start = new Date(startDate);
    // Safe date math: add months by calculating total months then reconstructing date
    const startYear = start.getFullYear();
    const startMonth = start.getMonth();
    const startDay = start.getDate();

    const totalMonths = startYear * 12 + startMonth + termMonths;
    const endYear = Math.floor(totalMonths / 12);
    const endMonth = totalMonths % 12;

    // Create end date, handling month-end overflow
    const end = new Date(endYear, endMonth, 1);
    const maxDay = new Date(endYear, endMonth + 1, 0).getDate();
    end.setDate(Math.min(startDay, maxDay));

    const today = new Date();
    const diffTime = end - today;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    return diffDays;
}

function updateRotationCalendar() {
    const container = document.getElementById('rotation-calendar');
    const positions = storage.getServicePositions();

    const upcomingElections = positions.filter(pos => {
        if (!pos.startDate) return false;
        const days = calculateDaysRemaining(pos.startDate, pos.termLength);
        return days !== null && days >= 0 && days <= 60;
    });

    container.innerHTML = '';

    if (upcomingElections.length === 0) {
        container.innerHTML = '<p>No elections coming up in the next 60 days</p>';
        return;
    }

    upcomingElections.sort((a, b) => {
        const daysA = calculateDaysRemaining(a.startDate, a.termLength);
        const daysB = calculateDaysRemaining(b.startDate, b.termLength);
        return daysA - daysB;
    });

    upcomingElections.forEach(pos => {
        const days = calculateDaysRemaining(pos.startDate, pos.termLength);
        const endDate = calculateEndDate(pos.startDate, pos.termLength);

        const card = document.createElement('div');
        card.className = 'position-card';
        card.innerHTML = `
            <h4>${pos.name}</h4>
            <p><strong>Current:</strong> ${pos.currentHolder || 'Vacant'}</p>
            <p><strong>Term ends:</strong> ${endDate}</p>
            <p class="term-warning">${days} days remaining</p>
        `;
        container.appendChild(card);
    });
}

function addNomination() {
    const positionId = document.getElementById('nomination-position').value;
    const nominee = document.getElementById('nomination-nominee').value;

    if (!positionId || !nominee) {
        showToast('Please select position and nominee', 'error');
        return;
    }

    const nominations = storage.getNominations();
    const positions = storage.getServicePositions();
    const position = positions.find(p => p.id === positionId);

    nominations.push({
        id: genId(),
        positionId: positionId,
        positionName: position.name,
        nominee: nominee,
        nominatedBy: storage.getCurrentUser(),
        date: new Date().toISOString()
    });

    storage.saveNominations(nominations);
    showToast('Nomination submitted!', 'success');

    document.getElementById('nomination-position').value = '';
    document.getElementById('nomination-nominee').value = '';

    updateNominationsList();
}

function updateNominationsList() {
    const container = document.getElementById('nominations-list');
    const nominations = storage.getNominations();

    container.innerHTML = '';

    if (nominations.length === 0) {
        container.innerHTML = '<p>No nominations yet</p>';
        return;
    }

    nominations.forEach(nom => {
        const card = document.createElement('div');
        card.className = 'nomination-card';
        card.innerHTML = `
            <h4>${nom.positionName}</h4>
            <p><strong>Nominee:</strong> ${nom.nominee}</p>
            <p><strong>Nominated by:</strong> ${nom.nominatedBy}</p>
            <p><strong>Date:</strong> ${new Date(nom.date).toLocaleDateString()}</p>
            <button class="btn secondary" data-action="delete-nomination" data-id="${escapeAttribute(nom.id)}">Remove</button>
        `;
        container.appendChild(card);
    });
}

function deleteNomination(id) {
    if (!confirm('Remove this nomination?')) return;
    let nominations = storage.getNominations();
    nominations = nominations.filter(n => n.id !== id);
    storage.saveNominations(nominations);
    updateNominationsList();
    showToast('Nomination removed', 'success');
}

function populateNominationPositions() {
    const select = document.getElementById('nomination-position');
    const positions = storage.getServicePositions();

    select.innerHTML = '<option value="">Select position...</option>';

    positions.forEach(pos => {
        const option = document.createElement('option');
        option.value = pos.id;
        option.textContent = pos.name;
        select.appendChild(option);
    });
}

function populateServicePositionHolders() {
    const select = document.getElementById('position-current-holder');
    const nomineeSelect = document.getElementById('nomination-nominee');
    const members = storage.getMembers();

    select.innerHTML = '<option value="">Vacant</option>';
    nomineeSelect.innerHTML = '<option value="">Select member...</option>';

    members.forEach(m => {
        const option1 = document.createElement('option');
        option1.value = m.name;
        option1.textContent = m.name;
        select.appendChild(option1);

        const option2 = document.createElement('option');
        option2.value = m.name;
        option2.textContent = m.name;
        nomineeSelect.appendChild(option2);
    });
}

// ========== FINANCE FUNCTIONS ==========

function showFinanceTab(tab) {
    document.querySelectorAll('.finance-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.history-nav button').forEach(b => b.classList.remove('active'));

    document.getElementById(`${tab}-content`).classList.add('active');
    document.getElementById(`${tab}-tab`).classList.add('active');

    if (tab === 'budget') updateBudgetTable();
    if (tab === 'expenses') updateExpensesTable();
    if (tab === 'reports') {
        // Set default month to current
        const today = new Date();
        const month = today.toISOString().substring(0, 7);
        document.getElementById('report-month').value = month;
    }
}

function addBudgetCategory() {
    const category = document.getElementById('budget-category').value.trim();
    const amount = parseFloat(document.getElementById('budget-amount').value);

    if (!category || isNaN(amount) || amount < 0) {
        showToast('Please enter valid category and amount', 'error');
        return;
    }

    const categories = storage.getBudgetCategories();

    categories.push({
        id: genId(),
        category: category,
        monthlyBudget: amount
    });

    storage.saveBudgetCategories(categories);
    showToast('Budget category added!', 'success');

    document.getElementById('budget-category').value = '';
    document.getElementById('budget-amount').value = '';

    updateBudgetTable();
    populateExpenseCategories();
}

function updateBudgetTable() {
    const tbody = document.getElementById('budget-table');
    const categories = storage.getBudgetCategories();
    const expenses = storage.getExpenses();

    // Get current month
    const today = new Date();
    const currentMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;

    tbody.innerHTML = '';

    categories.forEach(cat => {
        // Calculate spent this month
        const monthExpenses = expenses.filter(e => {
            const expenseMonth = e.date.substring(0, 7);
            return e.category === cat.category && expenseMonth === currentMonth;
        });

        const spent = monthExpenses.reduce((sum, e) => sum + e.amount, 0);
        const remaining = cat.monthlyBudget - spent;

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${cat.category}</td>
            <td>$${cat.monthlyBudget.toFixed(2)}</td>
            <td>$${spent.toFixed(2)}</td>
            <td style="color: ${remaining < 0 ? '#e74c3c' : '#2ecc71'}">$${remaining.toFixed(2)}</td>
            <td>
                <button class="btn secondary" data-action="delete-budget-category" data-id="${escapeAttribute(cat.id)}">Delete</button>
            </td>
        `;

        tbody.appendChild(tr);
    });

    if (categories.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5">No budget categories defined</td></tr>';
    }
}

function deleteBudgetCategory(id) {
    if (!confirm('Delete this budget category?')) return;
    let categories = storage.getBudgetCategories();
    categories = categories.filter(c => c.id !== id);
    storage.saveBudgetCategories(categories);
    updateBudgetTable();
    populateExpenseCategories();
    showToast('Category deleted', 'success');
}

function addExpense() {
    const date = document.getElementById('expense-date').value;
    const category = document.getElementById('expense-category').value;
    const description = document.getElementById('expense-description').value.trim();
    const amount = parseFloat(document.getElementById('expense-amount').value);

    if (!date || !category || !description || isNaN(amount) || amount < 0) {
        showToast('Please fill in all fields with valid data', 'error');
        return;
    }

    const expenses = storage.getExpenses();

    expenses.push({
        id: genId(),
        date: date,
        category: category,
        description: description,
        amount: amount
    });

    storage.saveExpenses(expenses);
    showToast('Expense logged!', 'success');

    document.getElementById('expense-date').value = '';
    document.getElementById('expense-category').value = '';
    document.getElementById('expense-description').value = '';
    document.getElementById('expense-amount').value = '';

    updateExpensesTable();
    updateBudgetTable();
}

function updateExpensesTable() {
    const tbody = document.getElementById('expenses-table');
    const expenses = storage.getExpenses();

    tbody.innerHTML = '';

    // Sort by date descending
    expenses.sort((a, b) => new Date(b.date) - new Date(a.date));

    // Show last 20 expenses
    expenses.slice(0, 20).forEach(exp => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${new Date(exp.date).toLocaleDateString()}</td>
            <td>${exp.category}</td>
            <td>${exp.description}</td>
            <td>$${exp.amount.toFixed(2)}</td>
            <td>
                <button class="btn secondary" data-action="delete-expense" data-id="${escapeAttribute(exp.id)}">Delete</button>
            </td>
        `;

        tbody.appendChild(tr);
    });

    if (expenses.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5">No expenses logged</td></tr>';
    }
}

function deleteExpense(id) {
    if (!confirm('Delete this expense?')) return;
    let expenses = storage.getExpenses();
    expenses = expenses.filter(e => e.id !== id);
    storage.saveExpenses(expenses);
    updateExpensesTable();
    updateBudgetTable();
    showToast('Expense deleted', 'success');
}

function populateExpenseCategories() {
    const select = document.getElementById('expense-category');
    const categories = storage.getBudgetCategories();

    select.innerHTML = '<option value="">Select category...</option>';

    categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.category;
        option.textContent = cat.category;
        select.appendChild(option);
    });
}

function generateMonthlyReport() {
    const month = document.getElementById('report-month').value;
    if (!month) {
        showToast('Please select a month', 'error');
        return;
    }

    const expenses = storage.getExpenses();
    const categories = storage.getBudgetCategories();
    const reportDiv = document.getElementById('monthly-report');

    const monthExpenses = expenses.filter(e => e.date.startsWith(month));

    let totalSpent = 0;
    let totalBudget = 0;

    let reportHTML = `<h4>Financial Report for ${month}</h4>`;
    reportHTML += '<table style="width: 100%; margin-top: 1rem;"><thead><tr><th>Category</th><th>Budget</th><th>Spent</th><th>Variance</th></tr></thead><tbody>';

    categories.forEach(cat => {
        const catExpenses = monthExpenses.filter(e => e.category === cat.category);
        const spent = catExpenses.reduce((sum, e) => sum + e.amount, 0);
        const variance = cat.monthlyBudget - spent;

        totalBudget += cat.monthlyBudget;
        totalSpent += spent;

        reportHTML += `
            <tr>
                <td>${cat.category}</td>
                <td>$${cat.monthlyBudget.toFixed(2)}</td>
                <td>$${spent.toFixed(2)}</td>
                <td style="color: ${variance < 0 ? '#e74c3c' : '#2ecc71'}">$${variance.toFixed(2)}</td>
            </tr>
        `;
    });

    const totalVariance = totalBudget - totalSpent;

    reportHTML += `
        <tr style="font-weight: bold; border-top: 2px solid #3498db;">
            <td>TOTAL</td>
            <td>$${totalBudget.toFixed(2)}</td>
            <td>$${totalSpent.toFixed(2)}</td>
            <td style="color: ${totalVariance < 0 ? '#e74c3c' : '#2ecc71'}">$${totalVariance.toFixed(2)}</td>
        </tr>
    `;

    reportHTML += '</tbody></table>';

    reportHTML += `<p style="margin-top: 1rem;"><strong>Total Expenses:</strong> ${monthExpenses.length}</p>`;

    reportDiv.innerHTML = reportHTML;

    generateYoYChart();
}

function generateYoYChart() {
    const expenses = storage.getExpenses();
    const chartDiv = document.getElementById('yoy-chart');

    // Group expenses by month
    const monthlyTotals = {};

    expenses.forEach(exp => {
        const month = exp.date.substring(0, 7);
        if (!monthlyTotals[month]) monthlyTotals[month] = 0;
        monthlyTotals[month] += exp.amount;
    });

    // Get last 12 months
    const months = Object.keys(monthlyTotals).sort().slice(-12);

    if (months.length === 0) {
        chartDiv.innerHTML = '<p>Not enough data for chart</p>';
        return;
    }

    // Simple text-based chart
    let chartHTML = '<h4>Last 12 Months Spending</h4>';
    chartHTML += '<div style="margin-top: 1rem;">';

    const maxAmount = Math.max(...months.map(m => monthlyTotals[m]));

    months.forEach(month => {
        const amount = monthlyTotals[month];
        const barWidth = (amount / maxAmount) * 100;

        chartHTML += `
            <div style="margin-bottom: 0.5rem;">
                <div style="font-size: 0.85rem; margin-bottom: 2px;">${month}: $${amount.toFixed(2)}</div>
                <div style="background: #3498db; height: 20px; width: ${barWidth}%; border-radius: 3px;"></div>
            </div>
        `;
    });

    chartHTML += '</div>';

    chartDiv.innerHTML = chartHTML;
}

// ========== BACKUP & SYNC FUNCTIONS ==========

// Group Settings Functions
function saveGroupSettings() {
    const settings = {
        qrCodeUrl: document.getElementById('group-qr-code-url').value.trim(),
        zoomLink: document.getElementById('group-zoom-link').value.trim(),
        contactName: document.getElementById('group-contact-name').value.trim(),
        contactPhone: document.getElementById('group-contact-phone').value.trim()
    };
    localStorage.setItem('groupSettings', JSON.stringify(settings));
    applyGroupSettings();
    showToast('Group settings saved!', 'success');
}

function loadGroupSettings() {
    const settings = JSON.parse(localStorage.getItem('groupSettings') || '{}');
    const qrInput = document.getElementById('group-qr-code-url');
    const zoomInput = document.getElementById('group-zoom-link');
    const nameInput = document.getElementById('group-contact-name');
    const phoneInput = document.getElementById('group-contact-phone');

    if (qrInput) qrInput.value = settings.qrCodeUrl || '';
    if (zoomInput) zoomInput.value = settings.zoomLink || '';
    if (nameInput) nameInput.value = settings.contactName || '';
    if (phoneInput) phoneInput.value = settings.contactPhone || '';

    applyGroupSettings();
}

function applyGroupSettings() {
    const settings = JSON.parse(localStorage.getItem('groupSettings') || '{}');

    // Update QR Code
    const qrBox = document.getElementById('qr-code-box');
    const qrImg = document.getElementById('qr-code-img');
    const qrContact = document.getElementById('qr-code-contact');

    if (settings.qrCodeUrl) {
        qrImg.src = settings.qrCodeUrl;
        qrBox.style.display = 'block';

        // Update contact info
        if (settings.contactName && settings.contactPhone) {
            qrContact.textContent = `For questions, please contact ${settings.contactName} at ${settings.contactPhone}.`;
        } else if (settings.contactName) {
            qrContact.textContent = `For questions, please contact ${settings.contactName}.`;
        } else {
            qrContact.textContent = '';
        }
    } else {
        qrBox.style.display = 'none';
    }

    // Update Zoom Button
    const zoomBtn = document.getElementById('zoom-meeting-btn');
    const zoomNote = document.getElementById('zoom-meeting-note');

    if (settings.zoomLink) {
        zoomBtn.href = settings.zoomLink;
        zoomBtn.style.display = 'block';
        zoomNote.style.display = 'block';
    } else {
        zoomBtn.style.display = 'none';
        zoomNote.style.display = 'none';
    }
}

function saveCurrentUser() {
    const name = document.getElementById('current-user-name').value.trim();
    if (!name) {
        showToast('Please enter your name', 'error');
        return;
    }
    storage.saveCurrentUser(name);
    showToast('Name saved!', 'success');
}

function loadCurrentUser() {
    const name = storage.getCurrentUser();
    const input = document.getElementById('current-user-name');
    if (input) {
        input.value = name;
    }
}

function createBackupSnapshot() {
    const backups = JSON.parse(localStorage.getItem('backupSnapshots') || '[]');

    const snapshot = {
        id: genId(),
        date: new Date().toISOString(),
        data: {
            events: storage.getEvents(),
            members: storage.getMembers(),
            announcements: storage.getAnnouncements(),
            photos: storage.getPhotos(),
            chairpersonLog: storage.getChairpersonLog(),
            groupConscienceLog: storage.getGroupConscienceLog(),
            liveGCItems: storage.getLiveGCItems(),
            proposedAgendaItems: storage.getProposedAgendaItems(),
            gcComments: storage.getGCComments(),
            gcActionItems: storage.getGCActionItems(),
            gcSettings: storage.getGCSettings(),
            messages: storage.getMessages(),
            servicePositions: storage.getServicePositions(),
            nominations: storage.getNominations(),
            budgetCategories: storage.getBudgetCategories(),
            expenses: storage.getExpenses(),
            templates: storage.getTemplates()
        }
    };

    backups.push(snapshot);

    // Keep only last 10 backups
    if (backups.length > 10) {
        backups.shift();
    }

    localStorage.setItem('backupSnapshots', JSON.stringify(backups));
    showToast('Backup snapshot created!', 'success');
    viewBackupHistory();
}

function viewBackupHistory() {
    const container = document.getElementById('backup-history');
    const backups = JSON.parse(localStorage.getItem('backupSnapshots') || '[]');

    if (backups.length === 0) {
        container.innerHTML = '<p>No backup snapshots available. Create one to get started.</p>';
        return;
    }

    container.innerHTML = '<h4>Available Backups</h4>';

    backups.reverse().forEach((backup, index) => {
        const card = document.createElement('div');
        card.className = 'box';
        card.style.marginTop = '10px';
        card.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong>Backup ${backups.length - index}</strong><br>
                    <span style="font-size: 0.85rem; color: #95a5a6;">${new Date(backup.date).toLocaleString()}</span>
                </div>
                <div>
                    <button class="btn" data-action="restore-backup" data-id="${escapeAttribute(backup.id)}">Restore</button>
                    <button class="btn secondary" data-action="delete-backup" data-id="${escapeAttribute(backup.id)}" style="margin-left: 8px;">Delete</button>
                </div>
            </div>
        `;
        container.appendChild(card);
    });
}

function restoreBackup(backupId) {
    if (!confirm('This will restore data from the selected backup and overwrite your current data. Continue?')) {
        return;
    }

    const backups = JSON.parse(localStorage.getItem('backupSnapshots') || '[]');
    const backup = backups.find(b => b.id === backupId);

    if (!backup) {
        showToast('Backup not found', 'error');
        return;
    }

    // Restore all data
    const data = backup.data;
    if (data.events) storage.saveEvents(data.events);
    if (data.members) storage.saveMembers(data.members);
    if (data.announcements) storage.saveAnnouncements(data.announcements);
    if (data.photos) storage.savePhotos(data.photos);
    if (data.chairpersonLog) storage.saveChairpersonLog(data.chairpersonLog);
    if (data.groupConscienceLog) storage.saveGroupConscienceLog(data.groupConscienceLog);
    if (data.liveGCItems) storage.saveLiveGCItems(data.liveGCItems);
    if (data.proposedAgendaItems) storage.saveProposedAgendaItems(data.proposedAgendaItems);
    if (data.gcComments) storage.saveGCComments(data.gcComments);
    if (data.gcActionItems) storage.saveGCActionItems(data.gcActionItems);
    if (data.gcSettings) storage.saveGCSettings(data.gcSettings);
    if (data.messages) storage.saveMessages(data.messages);
    if (data.servicePositions) storage.saveServicePositions(data.servicePositions);
    if (data.nominations) storage.saveNominations(data.nominations);
    if (data.budgetCategories) storage.saveBudgetCategories(data.budgetCategories);
    if (data.expenses) storage.saveExpenses(data.expenses);
    if (data.templates) storage.saveTemplates(data.templates);

    showToast('Data restored from backup!', 'success');

    // Reload page to reflect restored data
    setTimeout(() => location.reload(), 1500);
}

function deleteBackup(backupId) {
    if (!confirm('Delete this backup snapshot?')) return;

    let backups = JSON.parse(localStorage.getItem('backupSnapshots') || '[]');
    backups = backups.filter(b => b.id !== backupId);
    localStorage.setItem('backupSnapshots', JSON.stringify(backups));

    showToast('Backup deleted', 'success');
    viewBackupHistory();
}

// Storage Usage Monitoring
function checkStorageUsage() {
    try {
        // Calculate total size of localStorage
        let totalSize = 0;
        for (let key in localStorage) {
            if (localStorage.hasOwnProperty(key)) {
                totalSize += localStorage[key].length + key.length;
            }
        }

        // Convert to KB
        const sizeInKB = (totalSize / 1024).toFixed(2);
        const estimatedLimit = 5120; // Most browsers allow ~5MB (5120 KB)
        const percentage = (totalSize / (estimatedLimit * 1024)) * 100;

        // Update UI
        document.getElementById('storage-used').textContent = sizeInKB;
        const progressBar = document.getElementById('storage-progress-bar');
        progressBar.style.width = Math.min(percentage, 100) + '%';

        // Change color based on usage
        const warningDiv = document.getElementById('storage-warning');
        const criticalDiv = document.getElementById('storage-critical');

        warningDiv.style.display = 'none';
        criticalDiv.style.display = 'none';

        if (percentage > 90) {
            progressBar.style.background = 'linear-gradient(90deg, #c0392b, #e74c3c)';
            criticalDiv.style.display = 'block';
        } else if (percentage > 80) {
            progressBar.style.background = 'linear-gradient(90deg, #d68910, #f39c12)';
            warningDiv.style.display = 'block';
        } else {
            progressBar.style.background = 'linear-gradient(90deg, #27ae60, #2ecc71)';
        }

        progressBar.textContent = percentage.toFixed(1) + '%';

        return {sizeInKB, percentage};
    } catch (e) {
        console.error('Error checking storage:', e);
        return null;
    }
}

function exportForCloud() {
    // Same as exportData('all') but with a cloud-friendly filename
    const allData = {
        events: storage.getEvents(),
        members: storage.getMembers(),
        announcements: storage.getAnnouncements(),
        photos: storage.getPhotos(),
        chairpersonLog: storage.getChairpersonLog(),
        groupConscienceLog: storage.getGroupConscienceLog(),
        liveGCItems: storage.getLiveGCItems(),
        proposedAgendaItems: storage.getProposedAgendaItems(),
        gcComments: storage.getGCComments(),
        gcActionItems: storage.getGCActionItems(),
        gcSettings: storage.getGCSettings(),
        messages: storage.getMessages(),
        servicePositions: storage.getServicePositions(),
        nominations: storage.getNominations(),
        budgetCategories: storage.getBudgetCategories(),
        expenses: storage.getExpenses(),
        templates: storage.getTemplates(),
        exportDate: new Date().toISOString(),
        version: '2.0'
    };

    const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);

    const dateStr = new Date().toISOString().split('T')[0];
    link.download = `rowlett-group-backup-${dateStr}.json`;

    link.click();
    showToast('Data exported for cloud backup!', 'success');
}

// ========== TEMPLATE FUNCTIONS ==========

function saveTemplate() {
    const name = document.getElementById('template-name').value.trim();
    const type = document.getElementById('template-type').value;
    const content = document.getElementById('template-content').value.trim();

    if (!name || !content) {
        showToast('Please enter template name and content', 'error');
        return;
    }

    const templates = storage.getTemplates();

    templates.push({
        id: genId(),
        name: name,
        type: type,
        content: content,
        created: new Date().toISOString()
    });

    storage.saveTemplates(templates);
    showToast('Template saved!', 'success');

    document.getElementById('template-name').value = '';
    document.getElementById('template-type').value = 'meeting-format';
    document.getElementById('template-content').value = '';

    filterTemplates('all');
}

function filterTemplates(type) {
    const templates = storage.getTemplates();
    const container = document.getElementById('templates-list');

    // Update button states
    document.getElementById('all-templates-btn').classList.toggle('active', type === 'all');
    document.getElementById('meeting-templates-btn').classList.toggle('active', type === 'meeting-format');
    document.getElementById('speaker-templates-btn').classList.toggle('active', type === 'speaker-checklist');
    document.getElementById('event-templates-btn').classList.toggle('active', type === 'event-planning');

    const filtered = type === 'all' ? templates : templates.filter(t => t.type === type);

    container.innerHTML = '';

    if (filtered.length === 0) {
        container.innerHTML = '<p>No templates saved</p>';
        return;
    }

    filtered.forEach(tmpl => {
        const card = document.createElement('div');
        card.className = 'template-card';

        const header = document.createElement('div');
        header.className = 'template-header';

        const title = document.createElement('h4');
        title.textContent = tmpl.name;

        const badge = document.createElement('span');
        badge.className = 'template-type-badge';
        badge.textContent = tmpl.type.replace('-', ' ').toUpperCase();

        header.appendChild(title);
        header.appendChild(badge);

        const content = document.createElement('pre');
        content.style.whiteSpace = 'pre-wrap';
        content.style.fontSize = '0.9rem';
        content.style.marginTop = '10px';
        content.textContent = tmpl.content;

        const btnContainer = document.createElement('div');
        btnContainer.style.marginTop = '10px';

        const useBtn = document.createElement('button');
        useBtn.className = 'btn';
        useBtn.textContent = 'Use Template';
        useBtn.onclick = () => useTemplate(tmpl.id);

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn secondary';
        deleteBtn.style.marginLeft = '8px';
        deleteBtn.textContent = 'Delete';
        deleteBtn.onclick = () => deleteTemplate(tmpl.id);

        btnContainer.appendChild(useBtn);
        btnContainer.appendChild(deleteBtn);

        card.appendChild(header);
        card.appendChild(content);
        card.appendChild(btnContainer);

        container.appendChild(card);
    });
}

function useTemplate(id) {
    const templates = storage.getTemplates();
    const template = templates.find(t => t.id === id);

    if (template) {
        // Copy to clipboard
        navigator.clipboard.writeText(template.content).then(() => {
            showToast('Template copied to clipboard!', 'success');
        }).catch(() => {
            showToast('Could not copy template', 'error');
        });
    }
}

function deleteTemplate(id) {
    if (!confirm('Delete this template?')) return;
    let templates = storage.getTemplates();
    templates = templates.filter(t => t.id !== id);
    storage.saveTemplates(templates);
    filterTemplates('all');
    showToast('Template deleted', 'success');
}


// Initialize the application
function init() {
    initDefaults();
    initNav();
    initDictionary();
    initCalendarNav();
    updateEventsTable();
    updateBirthdaysTable();
    updateAnnouncementsList();
    updateGallery();
    updateHome();
    renderCalendar();
    showHistory('genesis-history');
    updateChairpersonLogTable();
    updateGCLogTable();
    updateLiveGCTable();
    updateChairpersonAnnouncements();
    populateAttendeeDropdown();
    populateMemberDropdowns();
    renderServantReportInputs();
    setupAudioRecorder();

    // Initialize new GC features
    updateProposedAgendaTable();
    loadGCSettings();
    updateActionItemsTable();
    searchGCHistory();
    updateGCStatistics();
    refreshGCTrends();

    // Initialize new features
    loadGroupSettings();
    loadCurrentUser();
    populateMessageRecipients();
    showMessages('inbox');
    populateServicePositionHolders();
    updateServicePositionsTable();
    updateRotationCalendar();
    populateNominationPositions();
    updateNominationsList();
    populateExpenseCategories();
    updateBudgetTable();
    updateExpensesTable();
    filterTemplates('all');

    // Set default date for expense logging to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('expense-date').value = today;

    // Initialize new nice-to-have features
    refreshAnalytics();
    renderLibraryCatalog();
    renderCurrentCheckouts();
    renderReadingSchedules();
    loadAccessibilitySettings();
    checkStorageUsage();

    // Check for upcoming GC meetings and show notifications
    setTimeout(() => checkUpcomingGCMeetings(), 2000); // Delay 2 seconds for better UX

    // Back to Top button logic
    const mainEl = document.querySelector('main');
    const backToTopBtn = document.getElementById('back-to-top-btn');

    mainEl.addEventListener('scroll', () => {
        const historySection = document.getElementById('history-section');
        if (historySection.classList.contains('active') && mainEl.scrollTop > 100) {
            backToTopBtn.style.display = 'block';
        } else {
            backToTopBtn.style.display = 'none';
        }
    });

    backToTopBtn.addEventListener('click', () => {
        mainEl.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // Initialize new sections
    initNewSections();
}

// ============================================
// ANALYTICS DASHBOARD FUNCTIONS
// ============================================

let attendanceChart = null;
let gcParticipationChart = null;

function refreshAnalytics() {
    renderAttendanceTrends();
    renderEngagementMetrics();
    renderGCParticipation();
    renderServiceEngagement();
    renderActivitySummary();
}

function renderAttendanceTrends() {
    const days = parseInt(document.getElementById('analytics-time-range').value);
    const events = JSON.parse(localStorage.getItem('events') || '[]');

    // Calculate date range
    const endDate = new Date();
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - days);

    // Filter events in date range
    const relevantEvents = events.filter(e => {
        const eventDate = new Date(e.date);
        return eventDate >= startDate && eventDate <= endDate;
    });

    // Group by week
    const weeklyData = {};
    relevantEvents.forEach(event => {
        const eventDate = new Date(event.date);
        const weekStart = new Date(eventDate);
        weekStart.setDate(eventDate.getDate() - eventDate.getDay());
        const weekKey = weekStart.toISOString().split('T')[0];

        if (!weeklyData[weekKey]) {
            weeklyData[weekKey] = { count: 0, totalAttendance: 0 };
        }
        weeklyData[weekKey].count++;
        weeklyData[weekKey].totalAttendance += (event.attendees || []).length;
    });

    const labels = Object.keys(weeklyData).sort();
    const attendanceData = labels.map(key => weeklyData[key].totalAttendance);
    const eventCounts = labels.map(key => weeklyData[key].count);

    const ctx = document.getElementById('attendance-chart').getContext('2d');

    if (attendanceChart) {
        attendanceChart.destroy();
    }

    attendanceChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels.map(date => new Date(date).toLocaleDateString()),
            datasets: [{
                label: 'Total Attendance',
                data: attendanceData,
                borderColor: '#3498db',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    labels: { color: '#ecf0f1' }
                }
            },
            scales: {
                x: {
                    ticks: { color: '#ecf0f1' },
                    grid: { color: 'rgba(236, 240, 241, 0.1)' }
                },
                y: {
                    ticks: { color: '#ecf0f1' },
                    grid: { color: 'rgba(236, 240, 241, 0.1)' },
                    beginAtZero: true
                }
            }
        }
    });
}

function renderEngagementMetrics() {
    const members = JSON.parse(localStorage.getItem('members') || '[]');
    const events = JSON.parse(localStorage.getItem('events') || '[]');
    const messages = JSON.parse(localStorage.getItem('messages') || '[]');
    const gcMotions = JSON.parse(localStorage.getItem('groupConscienceMotions') || '[]');

    const totalMembers = members.length;
    const activeMembers = members.filter(m => m.isServant ||
        events.some(e => (e.attendees || []).includes(m.id))).length;
    const engagementRate = totalMembers > 0 ?
        ((activeMembers / totalMembers) * 100).toFixed(1) : 0;

    const recentMessages = messages.filter(m => {
        const msgDate = new Date(m.timestamp);
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        return msgDate >= thirtyDaysAgo;
    }).length;

    const html = `
        <div style="background: #34495e; padding: 1rem; border-radius: 6px; text-align: center;">
            <div style="font-size: 2rem; color: #3498db; font-weight: bold;">${totalMembers}</div>
            <div style="color: #95a5a6;">Total Members</div>
        </div>
        <div style="background: #34495e; padding: 1rem; border-radius: 6px; text-align: center;">
            <div style="font-size: 2rem; color: #2ecc71; font-weight: bold;">${activeMembers}</div>
            <div style="color: #95a5a6;">Active Members</div>
        </div>
        <div style="background: #34495e; padding: 1rem; border-radius: 6px; text-align: center;">
            <div style="font-size: 2rem; color: #e74c3c; font-weight: bold;">${engagementRate}%</div>
            <div style="color: #95a5a6;">Engagement Rate</div>
        </div>
        <div style="background: #34495e; padding: 1rem; border-radius: 6px; text-align: center;">
            <div style="font-size: 2rem; color: #f39c12; font-weight: bold;">${recentMessages}</div>
            <div style="color: #95a5a6;">Messages (30d)</div>
        </div>
    `;

    document.getElementById('engagement-metrics').innerHTML = html;
}

function renderGCParticipation() {
    const gcMotions = JSON.parse(localStorage.getItem('groupConscienceMotions') || '[]');
    const members = JSON.parse(localStorage.getItem('members') || '[]');

    const totalMotions = gcMotions.length;
    const votedMotions = gcMotions.filter(m => m.status === 'approved' || m.status === 'rejected').length;
    const pendingMotions = gcMotions.filter(m => m.status === 'open').length;

    // Calculate participation
    let totalVotes = 0;
    let totalPossibleVotes = 0;

    gcMotions.forEach(motion => {
        if (motion.votes) {
            totalVotes += motion.votes.yes + motion.votes.no + motion.votes.abstain;
            totalPossibleVotes += members.length;
        }
    });

    const participationRate = totalPossibleVotes > 0 ?
        ((totalVotes / totalPossibleVotes) * 100).toFixed(1) : 0;

    const statsHtml = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
            <div style="background: #34495e; padding: 1rem; border-radius: 6px; text-align: center;">
                <div style="font-size: 1.5rem; color: #3498db; font-weight: bold;">${totalMotions}</div>
                <div style="color: #95a5a6; font-size: 0.9rem;">Total Motions</div>
            </div>
            <div style="background: #34495e; padding: 1rem; border-radius: 6px; text-align: center;">
                <div style="font-size: 1.5rem; color: #2ecc71; font-weight: bold;">${votedMotions}</div>
                <div style="color: #95a5a6; font-size: 0.9rem;">Voted On</div>
            </div>
            <div style="background: #34495e; padding: 1rem; border-radius: 6px; text-align: center;">
                <div style="font-size: 1.5rem; color: #f39c12; font-weight: bold;">${pendingMotions}</div>
                <div style="color: #95a5a6; font-size: 0.9rem;">Pending</div>
            </div>
            <div style="background: #34495e; padding: 1rem; border-radius: 6px; text-align: center;">
                <div style="font-size: 1.5rem; color: #e74c3c; font-weight: bold;">${participationRate}%</div>
                <div style="color: #95a5a6; font-size: 0.9rem;">Participation</div>
            </div>
        </div>
    `;

    document.getElementById('gc-participation-stats').innerHTML = statsHtml;

    // Create chart
    const ctx = document.getElementById('gc-participation-chart').getContext('2d');

    if (gcParticipationChart) {
        gcParticipationChart.destroy();
    }

    const approved = gcMotions.filter(m => m.status === 'approved').length;
    const rejected = gcMotions.filter(m => m.status === 'rejected').length;
    const open = gcMotions.filter(m => m.status === 'open').length;

    gcParticipationChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Approved', 'Rejected', 'Open'],
            datasets: [{
                data: [approved, rejected, open],
                backgroundColor: ['#2ecc71', '#e74c3c', '#f39c12']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    labels: { color: '#ecf0f1' }
                }
            }
        }
    });
}

function renderServiceEngagement() {
    const positions = JSON.parse(localStorage.getItem('servicePositions') || '[]');

    const filled = positions.filter(p => p.holder && p.holder.trim() !== '').length;
    const vacant = positions.length - filled;
    const fillRate = positions.length > 0 ?
        ((filled / positions.length) * 100).toFixed(1) : 0;

    const html = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
            <div style="background: #34495e; padding: 1rem; border-radius: 6px; text-align: center;">
                <div style="font-size: 1.5rem; color: #3498db; font-weight: bold;">${positions.length}</div>
                <div style="color: #95a5a6; font-size: 0.9rem;">Total Positions</div>
            </div>
            <div style="background: #34495e; padding: 1rem; border-radius: 6px; text-align: center;">
                <div style="font-size: 1.5rem; color: #2ecc71; font-weight: bold;">${filled}</div>
                <div style="color: #95a5a6; font-size: 0.9rem;">Filled</div>
            </div>
            <div style="background: #34495e; padding: 1rem; border-radius: 6px; text-align: center;">
                <div style="font-size: 1.5rem; color: #e74c3c; font-weight: bold;">${vacant}</div>
                <div style="color: #95a5a6; font-size: 0.9rem;">Vacant</div>
            </div>
            <div style="background: #34495e; padding: 1rem; border-radius: 6px; text-align: center;">
                <div style="font-size: 1.5rem; color: #f39c12; font-weight: bold;">${fillRate}%</div>
                <div style="color: #95a5a6; font-size: 0.9rem;">Fill Rate</div>
            </div>
        </div>
    `;

    document.getElementById('service-engagement-stats').innerHTML = html;
}

function renderActivitySummary() {
    const events = JSON.parse(localStorage.getItem('events') || '[]');
    const messages = JSON.parse(localStorage.getItem('messages') || '[]');
    const announcements = JSON.parse(localStorage.getItem('announcements') || '[]');
    const gcMotions = JSON.parse(localStorage.getItem('groupConscienceMotions') || '[]');

    const now = new Date();
    const sevenDaysAgo = new Date();
    sevenDaysAgo.setDate(now.getDate() - 7);

    const recentEvents = events.filter(e => new Date(e.date) >= sevenDaysAgo).length;
    const recentMessages = messages.filter(m => new Date(m.timestamp) >= sevenDaysAgo).length;
    const recentAnnouncements = announcements.filter(a => new Date(a.timestamp) >= sevenDaysAgo).length;
    const recentMotions = gcMotions.filter(m => m.createdAt && new Date(m.createdAt) >= sevenDaysAgo).length;

    const html = `
        <div style="background: #34495e; padding: 1rem; border-radius: 6px;">
            <h4 style="color: #3498db; margin-bottom: 0.75rem;">Last 7 Days</h4>
            <ul style="list-style: none; padding: 0;">
                <li style="padding: 0.5rem 0; border-bottom: 1px solid #2c3e50;">
                    <i class="fas fa-calendar-alt" style="color: #3498db; margin-right: 0.5rem;"></i>
                    <strong>${recentEvents}</strong> events scheduled
                </li>
                <li style="padding: 0.5rem 0; border-bottom: 1px solid #2c3e50;">
                    <i class="fas fa-comment" style="color: #2ecc71; margin-right: 0.5rem;"></i>
                    <strong>${recentMessages}</strong> messages sent
                </li>
                <li style="padding: 0.5rem 0; border-bottom: 1px solid #2c3e50;">
                    <i class="fas fa-bullhorn" style="color: #f39c12; margin-right: 0.5rem;"></i>
                    <strong>${recentAnnouncements}</strong> announcements posted
                </li>
                <li style="padding: 0.5rem 0;">
                    <i class="fas fa-vote-yea" style="color: #e74c3c; margin-right: 0.5rem;"></i>
                    <strong>${recentMotions}</strong> GC motions created
                </li>
            </ul>
        </div>
    `;

    document.getElementById('activity-summary').innerHTML = html;
}

// ============================================
// LITERATURE LIBRARY FUNCTIONS
// ============================================

function toggleLiteratureForm() {
    const form = document.getElementById('add-literature-form');
    const btn = document.getElementById('show-lit-form-btn');
    const isVisible = form.style.display === 'block';
    form.style.display = isVisible ? 'none' : 'block';
    btn.style.display = isVisible ? 'block' : 'none';
}

function saveLiterature() {
    const title = document.getElementById('lit-title').value.trim();
    if (!title) {
        showToast('Please enter a title', 'error');
        return;
    }

    const literature = {
        id: genId(),
        title: title,
        type: document.getElementById('lit-type').value,
        format: document.getElementById('lit-format').value,
        copies: parseInt(document.getElementById('lit-copies').value) || 1,
        location: document.getElementById('lit-location').value.trim(),
        notes: document.getElementById('lit-notes').value.trim(),
        available: parseInt(document.getElementById('lit-copies').value) || 1,
        checkouts: [],
        addedDate: new Date().toISOString()
    };

    const library = JSON.parse(localStorage.getItem('library') || '[]');
    library.push(literature);
    localStorage.setItem('library', JSON.stringify(library));

    // Clear form
    document.getElementById('lit-title').value = '';
    document.getElementById('lit-type').value = 'book';
    document.getElementById('lit-format').value = 'physical';
    document.getElementById('lit-copies').value = '1';
    document.getElementById('lit-location').value = '';
    document.getElementById('lit-notes').value = '';

    toggleLiteratureForm();
    renderLibraryCatalog();
    renderCurrentCheckouts();
    updateReadingScheduleBookSelect();
    showToast('Literature added successfully!', 'success');
}

function renderLibraryCatalog() {
    const library = JSON.parse(localStorage.getItem('library') || '[]');
    const searchTerm = document.getElementById('library-search').value.toLowerCase();

    const filtered = library.filter(item =>
        item.title.toLowerCase().includes(searchTerm) ||
        item.type.toLowerCase().includes(searchTerm) ||
        (item.notes && item.notes.toLowerCase().includes(searchTerm))
    );

    if (filtered.length === 0) {
        document.getElementById('library-catalog').innerHTML =
            '<p style="color: #95a5a6; text-align: center;">No literature items found.</p>';
        return;
    }

    const html = filtered.map(item => `
        <div style="background: #34495e; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div style="flex: 1;">
                    <h4 style="color: #3498db; margin-bottom: 0.5rem;">${item.title}</h4>
                    <p style="color: #95a5a6; font-size: 0.9rem; margin-bottom: 0.25rem;">
                        <i class="fas fa-book"></i> ${item.type} |
                        <i class="fas fa-file-alt"></i> ${item.format}
                    </p>
                    <p style="color: #95a5a6; font-size: 0.9rem; margin-bottom: 0.25rem;">
                        <i class="fas fa-clone"></i> ${item.available} of ${item.copies} available
                        ${item.location ? ` | <i class="fas fa-map-marker-alt"></i> ${item.location}` : ''}
                    </p>
                    ${item.notes ? `<p style="color: #ecf0f1; font-size: 0.9rem; margin-top: 0.5rem;">${item.notes}</p>` : ''}
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    ${item.available > 0 ?
                        `<button class="btn" data-action="checkout-literature" data-id="${escapeAttribute(item.id)}">Check Out</button>` :
                        `<span style="color: #e74c3c; font-size: 0.9rem;">All checked out</span>`
                    }
                    <button class="btn secondary" data-action="edit-literature" data-id="${escapeAttribute(item.id)}">Edit</button>
                    <button class="btn secondary" data-action="delete-literature" data-id="${escapeAttribute(item.id)}">Delete</button>
                </div>
            </div>
        </div>
    `).join('');

    document.getElementById('library-catalog').innerHTML = html;
}

function checkoutLiterature(litId) {
    const members = JSON.parse(localStorage.getItem('members') || '[]');
    const memberName = prompt('Member name checking out:');
    if (!memberName || memberName.trim() === '') return;

    const dueDate = prompt('Due date (YYYY-MM-DD):',
        new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]);
    if (!dueDate) return;

    const library = JSON.parse(localStorage.getItem('library') || '[]');
    const item = library.find(i => i.id === litId);

    if (!item || item.available <= 0) {
        showToast('Item not available', 'error');
        return;
    }

    const checkout = {
        id: genId(),
        literatureId: litId,
        literatureTitle: item.title,
        memberName: memberName.trim(),
        checkoutDate: new Date().toISOString().split('T')[0],
        dueDate: dueDate,
        returned: false
    };

    if (!item.checkouts) item.checkouts = [];
    item.checkouts.push(checkout);
    item.available--;

    localStorage.setItem('library', JSON.stringify(library));
    renderLibraryCatalog();
    renderCurrentCheckouts();
    showToast('Item checked out successfully!', 'success');
}

function returnLiterature(checkoutId) {
    const library = JSON.parse(localStorage.getItem('library') || '[]');

    library.forEach(item => {
        if (item.checkouts) {
            const checkout = item.checkouts.find(c => c.id === checkoutId);
            if (checkout && !checkout.returned) {
                checkout.returned = true;
                checkout.returnDate = new Date().toISOString().split('T')[0];
                item.available++;
            }
        }
    });

    localStorage.setItem('library', JSON.stringify(library));
    renderLibraryCatalog();
    renderCurrentCheckouts();
    showToast('Item returned successfully!', 'success');
}

function renderCurrentCheckouts() {
    const library = JSON.parse(localStorage.getItem('library') || '[]');
    const allCheckouts = [];

    library.forEach(item => {
        if (item.checkouts) {
            item.checkouts.forEach(checkout => {
                if (!checkout.returned) {
                    allCheckouts.push({...checkout, item: item});
                }
            });
        }
    });

    if (allCheckouts.length === 0) {
        document.getElementById('current-checkouts').innerHTML =
            '<p style="color: #95a5a6; text-align: center;">No items currently checked out.</p>';
        return;
    }

    const html = allCheckouts.map(checkout => {
        const dueDate = new Date(checkout.dueDate);
        const today = new Date();
        const isOverdue = dueDate < today;

        return `
            <div style="background: #34495e; padding: 1rem; border-radius: 6px; margin-bottom: 0.75rem; border-left: 4px solid ${isOverdue ? '#e74c3c' : '#3498db'};">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h4 style="color: #3498db; margin-bottom: 0.25rem;">${checkout.literatureTitle}</h4>
                        <p style="color: #ecf0f1; font-size: 0.9rem;">
                            <i class="fas fa-user"></i> ${checkout.memberName}
                        </p>
                        <p style="color: #95a5a6; font-size: 0.85rem;">
                            Checked out: ${checkout.checkoutDate} |
                            Due: ${checkout.dueDate}
                            ${isOverdue ? '<span style="color: #e74c3c; margin-left: 0.5rem; font-weight: bold;">OVERDUE</span>' : ''}
                        </p>
                    </div>
                    <button class="btn" data-action="return-literature" data-id="${escapeAttribute(checkout.id)}">Mark Returned</button>
                </div>
            </div>
        `;
    }).join('');

    document.getElementById('current-checkouts').innerHTML = html;
}

function editLiterature(litId) {
    const library = JSON.parse(localStorage.getItem('library') || '[]');
    const item = library.find(i => i.id === litId);
    if (!item) return;

    document.getElementById('lit-title').value = item.title;
    document.getElementById('lit-type').value = item.type;
    document.getElementById('lit-format').value = item.format;
    document.getElementById('lit-copies').value = item.copies;
    document.getElementById('lit-location').value = item.location || '';
    document.getElementById('lit-notes').value = item.notes || '';

    // Delete old and will save as new
    deleteLiterature(litId, true);
    toggleLiteratureForm();
}

function deleteLiterature(litId, silent = false) {
    if (!silent && !confirm('Are you sure you want to delete this literature item?')) return;

    let library = JSON.parse(localStorage.getItem('library') || '[]');
    library = library.filter(i => i.id !== litId);
    localStorage.setItem('library', JSON.stringify(library));

    renderLibraryCatalog();
    renderCurrentCheckouts();
    updateReadingScheduleBookSelect();
    if (!silent) showToast('Literature deleted', 'success');
}

function toggleReadingScheduleForm() {
    const form = document.getElementById('add-reading-schedule-form');
    const isVisible = form.style.display === 'block';
    form.style.display = isVisible ? 'none' : 'block';
    if (!isVisible) {
        updateReadingScheduleBookSelect();
    }
}

function updateReadingScheduleBookSelect() {
    const library = JSON.parse(localStorage.getItem('library') || '[]');
    const select = document.getElementById('schedule-book');

    select.innerHTML = '<option value="">Select a book...</option>' +
        library.map(item => `<option value="${item.id}">${item.title}</option>`).join('');
}

function saveReadingSchedule() {
    const name = document.getElementById('schedule-name').value.trim();
    if (!name) {
        showToast('Please enter a schedule name', 'error');
        return;
    }

    const schedule = {
        id: genId(),
        name: name,
        bookId: document.getElementById('schedule-book').value,
        startDate: document.getElementById('schedule-start').value,
        frequency: document.getElementById('schedule-frequency').value,
        notes: document.getElementById('schedule-notes').value.trim(),
        createdDate: new Date().toISOString(),
        active: true
    };

    const schedules = JSON.parse(localStorage.getItem('readingSchedules') || '[]');
    schedules.push(schedule);
    localStorage.setItem('readingSchedules', JSON.stringify(schedules));

    // Clear form
    document.getElementById('schedule-name').value = '';
    document.getElementById('schedule-book').value = '';
    document.getElementById('schedule-start').value = '';
    document.getElementById('schedule-frequency').value = 'weekly';
    document.getElementById('schedule-notes').value = '';

    toggleReadingScheduleForm();
    renderReadingSchedules();
    showToast('Reading schedule created!', 'success');
}

function renderReadingSchedules() {
    const schedules = JSON.parse(localStorage.getItem('readingSchedules') || '[]');
    const library = JSON.parse(localStorage.getItem('library') || '[]');

    if (schedules.length === 0) {
        document.getElementById('reading-schedules-list').innerHTML =
            '<p style="color: #95a5a6; text-align: center;">No reading schedules yet.</p>';
        return;
    }

    const html = schedules.map(schedule => {
        const book = library.find(b => b.id === schedule.bookId);
        const bookTitle = book ? book.title : 'Book not found';

        return `
            <div style="background: #34495e; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <h4 style="color: #3498db; margin-bottom: 0.5rem;">${schedule.name}</h4>
                        <p style="color: #ecf0f1; font-size: 0.9rem; margin-bottom: 0.25rem;">
                            <i class="fas fa-book"></i> ${bookTitle}
                        </p>
                        <p style="color: #95a5a6; font-size: 0.9rem; margin-bottom: 0.25rem;">
                            <i class="fas fa-calendar"></i> Start: ${schedule.startDate || 'Not set'} |
                            <i class="fas fa-redo"></i> ${schedule.frequency}
                        </p>
                        ${schedule.notes ? `<p style="color: #ecf0f1; font-size: 0.9rem; margin-top: 0.5rem; font-style: italic;">${schedule.notes}</p>` : ''}
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn secondary" data-action="toggle-schedule" data-id="${escapeAttribute(schedule.id)}">
                            ${schedule.active ? 'Deactivate' : 'Activate'}
                        </button>
                        <button class="btn secondary" data-action="delete-schedule" data-id="${escapeAttribute(schedule.id)}">Delete</button>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    document.getElementById('reading-schedules-list').innerHTML = html;
}

function toggleScheduleActive(scheduleId) {
    const schedules = JSON.parse(localStorage.getItem('readingSchedules') || '[]');
    const schedule = schedules.find(s => s.id === scheduleId);
    if (schedule) {
        schedule.active = !schedule.active;
        localStorage.setItem('readingSchedules', JSON.stringify(schedules));
        renderReadingSchedules();
        showToast(`Schedule ${schedule.active ? 'activated' : 'deactivated'}`, 'success');
    }
}

function deleteReadingSchedule(scheduleId) {
    if (!confirm('Delete this reading schedule?')) return;

    let schedules = JSON.parse(localStorage.getItem('readingSchedules') || '[]');
    schedules = schedules.filter(s => s.id !== scheduleId);
    localStorage.setItem('readingSchedules', JSON.stringify(schedules));

    renderReadingSchedules();
    showToast('Schedule deleted', 'success');
}

// ============================================
// ACCESSIBILITY FUNCTIONS
// ============================================

function changeTheme() {
    const theme = document.getElementById('theme-mode').value;
    const body = document.body;
    const nav = document.querySelector('nav');
    const boxes = document.querySelectorAll('.box');

    // Remove existing theme classes
    body.classList.remove('light-theme', 'high-contrast-theme');

    if (theme === 'light') {
        body.style.background = '#ecf0f1';
        body.style.color = '#2c3e50';
        if (nav) {
            nav.style.background = '#bdc3c7';
            nav.style.color = '#2c3e50';
        }
        document.querySelectorAll('h1, h2, h3').forEach(h => {
            h.style.color = '#2980b9';
        });
        boxes.forEach(box => {
            box.style.background = '#ffffff';
            box.style.color = '#2c3e50';
        });
    } else if (theme === 'high-contrast') {
        body.style.background = '#000000';
        body.style.color = '#ffffff';
        if (nav) {
            nav.style.background = '#1a1a1a';
            nav.style.color = '#ffffff';
        }
        document.querySelectorAll('h1, h2, h3').forEach(h => {
            h.style.color = '#ffff00';
        });
        boxes.forEach(box => {
            box.style.background = '#1a1a1a';
            box.style.color = '#ffffff';
        });
    } else {
        // Default dark theme
        body.style.background = '#2c3e50';
        body.style.color = '#ecf0f1';
        if (nav) {
            nav.style.background = '#34495e';
            nav.style.color = '#ecf0f1';
        }
        document.querySelectorAll('h1, h2, h3').forEach(h => {
            h.style.color = '#3498db';
        });
        boxes.forEach(box => {
            box.style.background = '#34495e';
            box.style.color = '#ecf0f1';
        });
    }

    localStorage.setItem('theme', theme);
    showToast('Theme changed', 'success');
}

function changeFontSize(size) {
    document.documentElement.style.fontSize = size + '%';
    document.getElementById('font-size-slider').value = size;
    document.getElementById('font-size-display').textContent = size + '%';
    localStorage.setItem('fontSize', size);
    showToast('Font size updated', 'success');
}

function toggleScreenReaderMode() {
    const enabled = document.getElementById('screen-reader-mode').checked;

    if (enabled) {
        // Add skip navigation link
        const skipNav = document.createElement('a');
        skipNav.href = '#main-content';
        skipNav.textContent = 'Skip to main content';
        skipNav.id = 'skip-nav';
        skipNav.style.cssText = 'position: absolute; left: -9999px; z-index: 999; padding: 1em; background: #3498db; color: white; text-decoration: none;';
        skipNav.addEventListener('focus', function() {
            this.style.left = '0';
        });
        skipNav.addEventListener('blur', function() {
            this.style.left = '-9999px';
        });
        document.body.insertBefore(skipNav, document.body.firstChild);

        // Add main content ID
        const main = document.querySelector('main');
        if (main) main.id = 'main-content';

        // Add ARIA labels to navigation
        const navItems = document.querySelectorAll('nav li');
        navItems.forEach(item => {
            const section = item.getAttribute('data-section');
            if (section) {
                item.setAttribute('role', 'button');
                item.setAttribute('aria-label', `Navigate to ${item.textContent}`);
                item.setAttribute('tabindex', '0');
            }
        });

        showToast('Screen reader optimizations enabled', 'success');
    } else {
        // Remove skip nav
        const skipNav = document.getElementById('skip-nav');
        if (skipNav) skipNav.remove();

        showToast('Screen reader optimizations disabled', 'success');
    }

    localStorage.setItem('screenReaderMode', enabled);
}

function toggleReduceAnimations() {
    const enabled = document.getElementById('reduce-animations').checked;

    if (enabled) {
        const style = document.createElement('style');
        style.id = 'reduce-animations-style';
        style.textContent = `
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        `;
        document.head.appendChild(style);
    } else {
        const style = document.getElementById('reduce-animations-style');
        if (style) style.remove();
    }

    localStorage.setItem('reduceAnimations', enabled);
    showToast(`Animations ${enabled ? 'reduced' : 'restored'}`, 'success');
}

function toggleFocusIndicators() {
    const enabled = document.getElementById('focus-indicators').checked;

    if (enabled) {
        const style = document.createElement('style');
        style.id = 'focus-indicators-style';
        style.textContent = `
            *:focus {
                outline: 3px solid #3498db !important;
                outline-offset: 2px !important;
            }
        `;
        document.head.appendChild(style);
    } else {
        const style = document.getElementById('focus-indicators-style');
        if (style) style.remove();
    }

    localStorage.setItem('focusIndicators', enabled);
    showToast(`Focus indicators ${enabled ? 'enhanced' : 'normal'}`, 'success');
}

function toggleDyslexiaFont() {
    const enabled = document.getElementById('dyslexia-font').checked;

    if (enabled) {
        // Use Comic Sans as a more dyslexia-friendly alternative
        document.body.style.fontFamily = 'Comic Sans MS, Verdana, sans-serif';
    } else {
        document.body.style.fontFamily = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
    }

    localStorage.setItem('dyslexiaFont', enabled);
    showToast(`Dyslexia-friendly font ${enabled ? 'enabled' : 'disabled'}`, 'success');
}

function loadAccessibilitySettings() {
    // Load theme
    const theme = localStorage.getItem('theme') || 'dark';
    document.getElementById('theme-mode').value = theme;
    changeTheme();

    // Load font size
    const fontSize = localStorage.getItem('fontSize') || '100';
    changeFontSize(parseInt(fontSize));

    // Load screen reader mode
    const screenReaderMode = localStorage.getItem('screenReaderMode') === 'true';
    document.getElementById('screen-reader-mode').checked = screenReaderMode;
    if (screenReaderMode) toggleScreenReaderMode();

    // Load reduce animations
    const reduceAnimations = localStorage.getItem('reduceAnimations') === 'true';
    document.getElementById('reduce-animations').checked = reduceAnimations;
    if (reduceAnimations) toggleReduceAnimations();

    // Load focus indicators
    const focusIndicators = localStorage.getItem('focusIndicators') === 'true';
    document.getElementById('focus-indicators').checked = focusIndicators;
    if (focusIndicators) toggleFocusIndicators();

    // Load dyslexia font
    const dyslexiaFont = localStorage.getItem('dyslexiaFont') === 'true';
    document.getElementById('dyslexia-font').checked = dyslexiaFont;
    if (dyslexiaFont) toggleDyslexiaFont();
}

document.addEventListener('DOMContentLoaded', init);

// Event delegation for data-action buttons (prevents template literal injection)
document.addEventListener('click', function(e) {
    const btn = e.target.closest('[data-action]');
    if (!btn) return;

    const action = btn.dataset.action;
    const id = btn.dataset.id;
    const status = btn.dataset.status; // For actions that need additional data

    switch(action) {
        // Group Conscience
        case 'view-gc': openGCDetailsModal(id); break;
        case 'edit-gc': editGCLog(id); break;
        case 'delete-gc': deleteGCLog(id); break;
        case 'delete-live-gc': deleteLiveGCItem(id); break;
        case 'view-proposed': viewProposedAgendaItem(id); break;
        case 'delete-proposed': deleteProposedAgendaItem(id); break;
        case 'edit-action': editActionItem(id); break;
        case 'delete-action': deleteActionItem(id); break;
        case 'update-amendment': updateAmendmentStatus(id, status); break;
        case 'delete-comment': deleteGCComment(id); break;
        case 'view-chain': viewMotionChain(id); break;
        case 'update-gc-status': updateGCItemStatus(id, status); break;
        case 'remove-gc-item': removeGCItem(id); break;

        // Events & Members
        case 'edit-event': editEvent(id); break;
        case 'delete-event': deleteEvent(id); break;
        case 'edit-member': editMember(id); break;
        case 'delete-member': deleteMember(id); break;
        case 'edit-member-roster': editMemberFromRoster(id); break;
        case 'delete-member-roster': deleteMemberAndRefreshRoster(id); break;

        // Chairperson
        case 'edit-chairperson': editChairpersonLog(id); break;
        case 'delete-chairperson': deleteChairpersonLog(id); break;

        // Service & Nominations
        case 'delete-position': deleteServicePosition(id); break;
        case 'delete-nomination': deleteNomination(id); break;

        // Budget & Expenses
        case 'delete-budget-category': deleteBudgetCategory(id); break;
        case 'delete-expense': deleteExpense(id); break;

        // Backups
        case 'restore-backup': restoreBackup(id); break;
        case 'delete-backup': deleteBackup(id); break;

        // Literature
        case 'checkout-literature': checkoutLiterature(id); break;
        case 'edit-literature': editLiterature(id); break;
        case 'delete-literature': deleteLiterature(id); break;
        case 'return-literature': returnLiterature(id); break;

        // Reading Schedules
        case 'toggle-schedule': toggleScheduleActive(id); break;
        case 'delete-schedule': deleteReadingSchedule(id); break;

        // Format & Commitments
        case 'edit-format': editFormat(id); break;
        case 'delete-format': deleteFormat(id); break;
        case 'edit-commitment': editCommitment(id); break;
        case 'delete-commitment': deleteCommitment(id); break;

        // Attendance
        case 'delete-attendance': deleteAttendance(id); break;

        // Bylaws
        case 'view-bylaw': viewByLaw(id); break;

        // Sponsorships
        case 'delete-sponsorship': deleteSponsorship(id); break;
    }
});

// ========================================
// NEW FEATURES - JavaScript Functions
// ========================================

// FORMAT ROTATION FUNCTIONS
function handleFormatSubmit() {
    const name = document.getElementById('format-name').value.trim();
    const description = document.getElementById('format-description').value.trim();
    const order = parseInt(document.getElementById('format-order').value);
    const editId = document.getElementById('format-edit-id').value;

    if (!name || !order) {
        showToast('Please fill all required fields', 'error');
        return;
    }

    let formats = JSON.parse(localStorage.getItem('meetingFormats') || '[]');

    if (editId) {
        const index = formats.findIndex(f => f.id === editId);
        formats[index] = { ...formats[index], name, description, order };
        showToast('Format updated successfully', 'success');
    } else {
        const newFormat = { id: Date.now().toString(), name, description, order };
        formats.push(newFormat);
        showToast('Format added successfully', 'success');
    }

    localStorage.setItem('meetingFormats', JSON.stringify(formats));
    loadFormatRotationTable();
    loadUpcomingFormats();
    updateCurrentWeekFormat();
    resetFormatForm();
}

function cancelFormatEdit() {
    resetFormatForm();
}

function resetFormatForm() {
    document.getElementById('format-name').value = '';
    document.getElementById('format-description').value = '';
    document.getElementById('format-order').value = '';
    document.getElementById('format-edit-id').value = '';
    document.getElementById('format-form-btn').textContent = 'Add Format';
    document.getElementById('format-form-cancel-btn').style.display = 'none';
}

function loadFormatRotationTable() {
    const formats = JSON.parse(localStorage.getItem('meetingFormats') || '[]').sort((a, b) => a.order - b.order);
    const tbody = document.getElementById('format-rotation-body');
    tbody.innerHTML = '';

    formats.forEach(format => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${format.order}</td>
            <td>${DOMPurify.sanitize(format.name)}</td>
            <td>${DOMPurify.sanitize(format.description)}</td>
            <td>
                <button class="btn secondary" data-action="edit-format" data-id="${escapeAttribute(format.id)}" style="padding: 0.25rem 0.5rem; font-size: 0.85rem;">Edit</button>
                <button class="btn secondary" data-action="delete-format" data-id="${escapeAttribute(format.id)}" style="padding: 0.25rem 0.5rem; font-size: 0.85rem; margin-left: 0.25rem;">Delete</button>
            </td>
        `;
    });
}

function editFormat(id) {
    const formats = JSON.parse(localStorage.getItem('meetingFormats') || '[]');
    const format = formats.find(f => f.id === id);
    if (format) {
        document.getElementById('format-name').value = format.name;
        document.getElementById('format-description').value = format.description;
        document.getElementById('format-order').value = format.order;
        document.getElementById('format-edit-id').value = id;
        document.getElementById('format-form-btn').textContent = 'Update Format';
        document.getElementById('format-form-cancel-btn').style.display = 'inline-block';
    }
}

function deleteFormat(id) {
    if (!confirm('Delete this format?')) return;
    let formats = JSON.parse(localStorage.getItem('meetingFormats') || '[]');
    formats = formats.filter(f => f.id !== id);
    localStorage.setItem('meetingFormats', JSON.stringify(formats));
    loadFormatRotationTable();
    loadUpcomingFormats();
    showToast('Format deleted', 'success');
}

function loadUpcomingFormats() {
    const formats = JSON.parse(localStorage.getItem('meetingFormats') || '[]').sort((a, b) => a.order - b.order);
    const container = document.getElementById('upcoming-formats-list');
    if (formats.length === 0) {
        container.innerHTML = '<p>No formats configured</p>';
        return;
    }

    const today = new Date();
    let html = '<ul style="list-style: none; padding: 0;">';

    for (let i = 0; i < 8; i++) {
        const weekDate = new Date(today);
        weekDate.setDate(today.getDate() + (i * 7));
        const formatIndex = i % formats.length;
        const format = formats[formatIndex];
        html += `<li style="padding: 0.5rem; border-bottom: 1px solid #7f8c8d;">
            <strong>${weekDate.toLocaleDateString()}</strong>: ${DOMPurify.sanitize(format.name)}
        </li>`;
    }

    html += '</ul>';
    container.innerHTML = html;
}

function updateCurrentWeekFormat() {
    const formats = JSON.parse(localStorage.getItem('meetingFormats') || '[]').sort((a, b) => a.order - b.order);
    if (formats.length === 0) {
        document.getElementById('current-format-name').textContent = 'No Format Set';
        document.getElementById('current-week-date').textContent = '';
        return;
    }

    const today = new Date();
    const weekNumber = Math.floor((today - new Date(today.getFullYear(), 0, 1)) / (7 * 24 * 60 * 60 * 1000));
    const formatIndex = weekNumber % formats.length;
    const currentFormat = formats[formatIndex];

    document.getElementById('current-format-name').textContent = currentFormat.name;
    document.getElementById('current-week-date').textContent = today.toLocaleDateString();
}

// COMMITMENT BOARD FUNCTIONS
function handleCommitmentSubmit() {
    const date = document.getElementById('commitment-date').value;
    const role = document.getElementById('commitment-role').value;
    const member = document.getElementById('commitment-member').value;
    const reminder = document.getElementById('commitment-reminder').checked;
    const editId = document.getElementById('commitment-edit-id').value;

    if (!date || !role || !member) {
        showToast('Please fill all required fields', 'error');
        return;
    }

    let commitments = JSON.parse(localStorage.getItem('meetingCommitments') || '[]');

    if (editId) {
        const index = commitments.findIndex(c => c.id === editId);
        commitments[index] = { ...commitments[index], date, role, member, reminder };
        showToast('Commitment updated successfully', 'success');
    } else {
        const newCommitment = { id: Date.now().toString(), date, role, member, reminder };
        commitments.push(newCommitment);
        showToast('Commitment added successfully', 'success');
    }

    localStorage.setItem('meetingCommitments', JSON.stringify(commitments));
    loadCommitmentTable();
    loadCurrentWeekCommitments();
    resetCommitmentForm();
}

function cancelCommitmentEdit() {
    resetCommitmentForm();
}

function resetCommitmentForm() {
    document.getElementById('commitment-date').value = '';
    document.getElementById('commitment-role').selectedIndex = 0;
    document.getElementById('commitment-member').selectedIndex = 0;
    document.getElementById('commitment-reminder').checked = true;
    document.getElementById('commitment-edit-id').value = '';
    document.getElementById('commitment-form-btn').textContent = 'Sign Up';
    document.getElementById('commitment-form-cancel-btn').style.display = 'none';
}

function loadCommitmentTable() {
    const commitments = JSON.parse(localStorage.getItem('meetingCommitments') || '[]').sort((a, b) => new Date(a.date) - new Date(b.date));
    const tbody = document.getElementById('commitment-body');
    tbody.innerHTML = '';

    commitments.forEach(commitment => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${new Date(commitment.date).toLocaleDateString()}</td>
            <td>${DOMPurify.sanitize(commitment.role)}</td>
            <td>${DOMPurify.sanitize(commitment.member)}</td>
            <td>
                <button class="btn secondary" data-action="edit-commitment" data-id="${escapeAttribute(commitment.id)}" style="padding: 0.25rem 0.5rem; font-size: 0.85rem;">Edit</button>
                <button class="btn secondary" data-action="delete-commitment" data-id="${escapeAttribute(commitment.id)}" style="padding: 0.25rem 0.5rem; font-size: 0.85rem; margin-left: 0.25rem;">Delete</button>
            </td>
        `;
    });
}

function editCommitment(id) {
    const commitments = JSON.parse(localStorage.getItem('meetingCommitments') || '[]');
    const commitment = commitments.find(c => c.id === id);
    if (commitment) {
        document.getElementById('commitment-date').value = commitment.date;
        document.getElementById('commitment-role').value = commitment.role;
        document.getElementById('commitment-member').value = commitment.member;
        document.getElementById('commitment-reminder').checked = commitment.reminder;
        document.getElementById('commitment-edit-id').value = id;
        document.getElementById('commitment-form-btn').textContent = 'Update';
        document.getElementById('commitment-form-cancel-btn').style.display = 'inline-block';
    }
}

function deleteCommitment(id) {
    if (!confirm('Delete this commitment?')) return;
    let commitments = JSON.parse(localStorage.getItem('meetingCommitments') || '[]');
    commitments = commitments.filter(c => c.id !== id);
    localStorage.setItem('meetingCommitments', JSON.stringify(commitments));
    loadCommitmentTable();
    loadCurrentWeekCommitments();
    showToast('Commitment deleted', 'success');
}

function loadCurrentWeekCommitments() {
    const container = document.getElementById('current-week-commitments');
    const commitments = JSON.parse(localStorage.getItem('meetingCommitments') || '[]');
    const today = new Date();
    const weekStart = new Date(today.setDate(today.getDate() - today.getDay()));
    const weekEnd = new Date(weekStart);
    weekEnd.setDate(weekEnd.getDate() + 7);

    const thisWeek = commitments.filter(c => {
        const commitDate = new Date(c.date);
        return commitDate >= weekStart && commitDate < weekEnd;
    });

    if (thisWeek.length === 0) {
        container.innerHTML = '<p>No commitments this week</p>';
        return;
    }

    let html = '<ul style="list-style: none; padding: 0;">';
    thisWeek.forEach(c => {
        html += `<li style="padding: 0.5rem; border-bottom: 1px solid #7f8c8d;">
            <strong>${c.role}:</strong> ${DOMPurify.sanitize(c.member)} (${new Date(c.date).toLocaleDateString()})
        </li>`;
    });
    html += '</ul>';
    container.innerHTML = html;
}

// SECRETARY FUNCTIONS
function handleAttendanceSubmit() {
    const date = document.getElementById('attendance-date').value;
    const memberSelect = document.getElementById('attendance-members');
    const selectedMembers = Array.from(memberSelect.selectedOptions).map(opt => opt.value);
    const visitors = parseInt(document.getElementById('attendance-visitors').value) || 0;

    if (!date || selectedMembers.length === 0) {
        showToast('Please select date and at least one member', 'error');
        return;
    }

    const attendance = {
        id: Date.now().toString(),
        date,
        members: selectedMembers,
        visitors,
        total: selectedMembers.length + visitors
    };

    let attendanceLog = JSON.parse(localStorage.getItem('attendanceLog') || '[]');
    attendanceLog.push(attendance);
    localStorage.setItem('attendanceLog', JSON.stringify(attendanceLog));

    showToast('Attendance saved successfully', 'success');
    loadAttendanceHistory();
    updateAttendanceStats();
    document.getElementById('attendance-date').value = '';
    document.getElementById('attendance-visitors').value = '0';
    memberSelect.selectedIndex = -1;
}

function loadAttendanceHistory() {
    const log = JSON.parse(localStorage.getItem('attendanceLog') || '[]').reverse();
    const tbody = document.getElementById('attendance-history-body');
    tbody.innerHTML = '';

    log.slice(0, 10).forEach(entry => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${new Date(entry.date).toLocaleDateString()}</td>
            <td>${entry.members.length}</td>
            <td>${entry.visitors}</td>
            <td>${entry.total}</td>
            <td>
                <button class="btn secondary" data-action="delete-attendance" data-id="${escapeAttribute(entry.id)}" style="padding: 0.25rem 0.5rem; font-size: 0.85rem;">Delete</button>
            </td>
        `;
    });
}

function deleteAttendance(id) {
    if (!confirm('Delete this attendance record?')) return;
    let log = JSON.parse(localStorage.getItem('attendanceLog') || '[]');
    log = log.filter(a => a.id !== id);
    localStorage.setItem('attendanceLog', JSON.stringify(log));
    loadAttendanceHistory();
    updateAttendanceStats();
    showToast('Attendance record deleted', 'success');
}

function updateAttendanceStats() {
    const log = JSON.parse(localStorage.getItem('attendanceLog') || '[]');
    if (log.length === 0) return;

    const avgAttendance = Math.round(log.reduce((sum, a) => sum + a.total, 0) / log.length);
    const uniqueMembers = new Set(log.flatMap(a => a.members)).size;

    const thisMonth = new Date().getMonth();
    const monthlyVisitors = log.filter(a => new Date(a.date).getMonth() === thisMonth)
        .reduce((sum, a) => sum + a.visitors, 0);

    document.getElementById('avg-attendance').textContent = avgAttendance;
    document.getElementById('regular-members').textContent = uniqueMembers;
    document.getElementById('monthly-visitors').textContent = monthlyVisitors;
}

function generateMinutes() {
    const date = document.getElementById('attendance-date').value;
    if (!date) {
        showToast('Please select a meeting date', 'error');
        return;
    }

    const memberSelect = document.getElementById('attendance-members');
    const selectedMembers = Array.from(memberSelect.selectedOptions).map(opt => opt.text);

    const minutes = `
MEETING MINUTES
Date: ${new Date(date).toLocaleDateString()}

ATTENDANCE:
Members Present: ${selectedMembers.length}
${selectedMembers.map(m => '- ' + m).join('\n')}

Visitors/Newcomers: ${document.getElementById('attendance-visitors').value || 0}

[Additional meeting notes can be added here]

Secretary: _______________
    `.trim();

    document.getElementById('meeting-minutes-preview').textContent = minutes;
    showToast('Minutes generated', 'success');
}

function exportMinutesToPDF() {
    const minutes = document.getElementById('meeting-minutes-preview').textContent;
    if (!minutes) {
        showToast('Please generate minutes first', 'error');
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const lines = doc.splitTextToSize(minutes, 180);
    doc.text(lines, 15, 15);
    doc.save(`meeting-minutes-${new Date().toISOString().split('T')[0]}.pdf`);
    showToast('Minutes exported to PDF', 'success');
}

// GC DECISION HISTORY FUNCTIONS
function searchGCDecisions() {
    const searchTerm = document.getElementById('gc-search').value.toLowerCase();
    const status = document.getElementById('gc-filter-status').value;
    const year = document.getElementById('gc-filter-year').value;

    let decisions = JSON.parse(localStorage.getItem('gcLog') || '[]');

    if (searchTerm) {
        decisions = decisions.filter(d =>
            d.item.toLowerCase().includes(searchTerm) ||
            d.submittedBy.toLowerCase().includes(searchTerm)
        );
    }

    if (status !== 'all') {
        decisions = decisions.filter(d => d.status === status);
    }

    if (year !== 'all') {
        decisions = decisions.filter(d => new Date(d.date).getFullYear().toString() === year);
    }

    displayGCDecisions(decisions);
}

function displayGCDecisions(decisions) {
    const container = document.getElementById('gc-decisions-list');
    if (decisions.length === 0) {
        container.innerHTML = '<p>No decisions found</p>';
        return;
    }

    let html = '';
    decisions.forEach(d => {
        html += `
            <div class="box mb-2" style="cursor: pointer;" data-action="view-chain" data-id="${escapeAttribute(d.id)}">
                <div><strong>${new Date(d.date).toLocaleDateString()}</strong></div>
                <div>${DOMPurify.sanitize(d.item)}</div>
                <div style="font-size: 0.85rem; color: #95a5a6;">
                    Status: ${d.status} | Submitted by: ${DOMPurify.sanitize(d.submittedBy)}
                </div>
            </div>
        `;
    });
    container.innerHTML = html;
}

function linkGCMotions() {
    const primaryId = document.getElementById('gc-link-primary').value;
    const relatedId = document.getElementById('gc-link-related').value;
    const linkType = document.getElementById('gc-link-type').value;

    if (!primaryId || !relatedId) {
        showToast('Please select both motions', 'error');
        return;
    }

    let links = JSON.parse(localStorage.getItem('gcMotionLinks') || '[]');
    links.push({ primaryId, relatedId, linkType, timestamp: Date.now() });
    localStorage.setItem('gcMotionLinks', JSON.stringify(links));

    showToast('Motions linked successfully', 'success');
}

function viewMotionChain(motionId) {
    const decisions = JSON.parse(localStorage.getItem('gcLog') || '[]');
    const links = JSON.parse(localStorage.getItem('gcMotionLinks') || '[]');

    const motion = decisions.find(d => d.id === motionId);
    if (!motion) return;

    let html = `<h4>Primary Motion</h4>
        <div class="box mb-2">
            <div><strong>${new Date(motion.date).toLocaleDateString()}</strong></div>
            <div>${DOMPurify.sanitize(motion.item)}</div>
            <div>Status: ${motion.status}</div>
        </div>`;

    const relatedLinks = links.filter(l => l.primaryId === motionId || l.relatedId === motionId);
    if (relatedLinks.length > 0) {
        html += '<h4 class="mt-2">Related Motions</h4>';
        relatedLinks.forEach(link => {
            const relatedId = link.primaryId === motionId ? link.relatedId : link.primaryId;
            const related = decisions.find(d => d.id === relatedId);
            if (related) {
                html += `
                    <div class="box mb-2">
                        <div style="font-size: 0.75rem; color: #3498db;">${link.linkType.toUpperCase()}</div>
                        <div><strong>${new Date(related.date).toLocaleDateString()}</strong></div>
                        <div>${DOMPurify.sanitize(related.item)}</div>
                    </div>
                `;
            }
        });
    }

    document.getElementById('motion-chain-display').innerHTML = html;
}

// GC INVENTORY FUNCTIONS
function loadInventoryTemplate() {
    const type = document.getElementById('inventory-type').value;
    const container = document.getElementById('inventory-questions-container');

    if (!type) {
        container.innerHTML = '';
        return;
    }

    const templates = {
        'traditions': [
            'Does our group place principles before personalities?',
            'Is our group self-supporting through our own contributions?',
            'Does our group have any outside affiliations?',
            'Is our group autonomous except in matters affecting other groups?',
            'Do we practice attraction rather than promotion?'
        ],
        'concepts': [
            'Does our group understand the concept of ultimate responsibility?',
            'How does our group practice the concept of delegation of authority?',
            'Are we providing adequate support to our GSR?',
            'Does our group participate in the Conference process?'
        ],
        'group-health': [
            'Are newcomers made to feel welcome?',
            'Is there regular attendance and participation?',
            'Are service positions filled regularly?',
            'Is there healthy rotation of service positions?',
            'Are we meeting our financial obligations?'
        ],
        'annual': [
            'How has our group grown this year?',
            'What challenges has our group faced?',
            'Are we fulfilling our primary purpose?',
            'What can we improve next year?'
        ]
    };

    const questions = templates[type] || [];
    let html = '<div class="box">';
    questions.forEach((q, i) => {
        html += `
            <div class="form-group">
                <label>${i + 1}. ${q}</label>
                <textarea id="inventory-q${i}" rows="2" placeholder="Group response..."></textarea>
            </div>
        `;
    });
    html += '</div>';
    container.innerHTML = html;
}

function exportInventoryResults() {
    const type = document.getElementById('inventory-type').value;
    if (!type) {
        showToast('Please select an inventory type first', 'error');
        return;
    }

    showToast('Inventory results exported', 'success');
}

function submitAnonymousFeedback() {
    const feedback = document.getElementById('anonymous-feedback-text').value.trim();
    if (!feedback) {
        showToast('Please enter feedback', 'error');
        return;
    }

    let feedbackList = JSON.parse(localStorage.getItem('anonymousFeedback') || '[]');
    feedbackList.push({
        id: Date.now().toString(),
        feedback,
        timestamp: new Date().toISOString()
    });
    localStorage.setItem('anonymousFeedback', JSON.stringify(feedbackList));

    document.getElementById('anonymous-feedback-text').value = '';
    loadAnonymousFeedback();
    showToast('Feedback submitted anonymously', 'success');
}

function loadAnonymousFeedback() {
    const feedbackList = JSON.parse(localStorage.getItem('anonymousFeedback') || '[]').reverse();
    const container = document.getElementById('anonymous-feedback-list');

    if (feedbackList.length === 0) {
        container.innerHTML = '<p>No feedback submitted yet</p>';
        return;
    }

    let html = '';
    feedbackList.forEach(f => {
        html += `
            <div class="box mb-2">
                <div style="font-size: 0.75rem; color: #95a5a6;">${new Date(f.timestamp).toLocaleDateString()}</div>
                <div>${DOMPurify.sanitize(f.feedback)}</div>
            </div>
        `;
    });
    container.innerHTML = html;
}

// BY-LAWS FUNCTIONS
function handleByLawSubmit() {
    const title = document.getElementById('bylaw-title').value.trim();
    const version = document.getElementById('bylaw-version').value.trim();
    const content = document.getElementById('bylaw-content').value.trim();
    const notes = document.getElementById('bylaw-amendment-notes').value.trim();
    const date = document.getElementById('bylaw-effective-date').value;

    if (!title || !version || !content || !date) {
        showToast('Please fill all required fields', 'error');
        return;
    }

    let bylaws = JSON.parse(localStorage.getItem('groupByLaws') || '[]');
    const newByLaw = {
        id: Date.now().toString(),
        title,
        version,
        content,
        notes,
        effectiveDate: date,
        timestamp: new Date().toISOString()
    };

    bylaws.push(newByLaw);
    localStorage.setItem('groupByLaws', JSON.stringify(bylaws));

    showToast('Document saved successfully', 'success');
    loadByLawsHistory();
    loadCurrentByLaws();
    resetByLawForm();
}

function cancelByLawEdit() {
    resetByLawForm();
}

function resetByLawForm() {
    document.getElementById('bylaw-title').value = '';
    document.getElementById('bylaw-version').value = '';
    document.getElementById('bylaw-content').value = '';
    document.getElementById('bylaw-amendment-notes').value = '';
    document.getElementById('bylaw-effective-date').value = '';
    document.getElementById('bylaw-edit-id').value = '';
}

function loadByLawsHistory() {
    const bylaws = JSON.parse(localStorage.getItem('groupByLaws') || '[]').reverse();
    const tbody = document.getElementById('bylaws-history-body');
    tbody.innerHTML = '';

    bylaws.forEach(bylaw => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${DOMPurify.sanitize(bylaw.title)}</td>
            <td>${DOMPurify.sanitize(bylaw.version)}</td>
            <td>${new Date(bylaw.effectiveDate).toLocaleDateString()}</td>
            <td>
                <button class="btn secondary" data-action="view-bylaw" data-id="${escapeAttribute(bylaw.id)}" style="padding: 0.25rem 0.5rem; font-size: 0.85rem;">View</button>
            </td>
        `;
    });
}

function loadCurrentByLaws() {
    const bylaws = JSON.parse(localStorage.getItem('groupByLaws') || '[]');
    const container = document.getElementById('bylaws-current-list');

    // Get latest version of each document
    const latest = {};
    bylaws.forEach(b => {
        if (!latest[b.title] || new Date(b.effectiveDate) > new Date(latest[b.title].effectiveDate)) {
            latest[b.title] = b;
        }
    });

    if (Object.keys(latest).length === 0) {
        container.innerHTML = '<p>No documents available</p>';
        return;
    }

    let html = '';
    Object.values(latest).forEach(b => {
        html += `
            <div class="box mb-2">
                <h4>${DOMPurify.sanitize(b.title)}</h4>
                <div style="font-size: 0.85rem; color: #95a5a6;">Version ${DOMPurify.sanitize(b.version)} - Effective ${new Date(b.effectiveDate).toLocaleDateString()}</div>
                <button class="btn secondary mt-2" data-action="view-bylaw" data-id="${escapeAttribute(b.id)}" style="padding: 0.25rem 0.5rem; font-size: 0.85rem;">View Full Document</button>
            </div>
        `;
    });
    container.innerHTML = html;
}

function viewByLaw(id) {
    const bylaws = JSON.parse(localStorage.getItem('groupByLaws') || '[]');
    const bylaw = bylaws.find(b => b.id === id);
    if (bylaw) {
        alert(`${bylaw.title}\nVersion: ${bylaw.version}\n\n${bylaw.content}`);
    }
}

function generateByLawPDF() {
    showToast('PDF generation feature coming soon', 'success');
}

// SPONSORSHIP FUNCTIONS
function handleSponsorshipSubmit() {
    const sponsor = document.getElementById('sponsor-name').value;
    const sponsee = document.getElementById('sponsee-name').value;
    const type = document.getElementById('sponsorship-type').value;
    const startDate = document.getElementById('sponsorship-start-date').value;
    const currentStep = document.getElementById('current-step').value;

    if (!sponsor || !sponsee || !startDate) {
        showToast('Please fill all required fields', 'error');
        return;
    }

    let sponsorships = JSON.parse(localStorage.getItem('sponsorships') || '[]');
    const newSponsorship = {
        id: Date.now().toString(),
        sponsor,
        sponsee,
        type,
        startDate,
        currentStep: currentStep || null
    };

    sponsorships.push(newSponsorship);
    localStorage.setItem('sponsorships', JSON.stringify(sponsorships));

    showToast('Sponsorship relationship added', 'success');
    loadSponsorshipTable();
    loadSponsorshipTree();
    resetSponsorshipForm();
}

function cancelSponsorshipEdit() {
    resetSponsorshipForm();
}

function resetSponsorshipForm() {
    document.getElementById('sponsor-name').selectedIndex = 0;
    document.getElementById('sponsee-name').selectedIndex = 0;
    document.getElementById('sponsorship-type').selectedIndex = 0;
    document.getElementById('sponsorship-start-date').value = '';
    document.getElementById('current-step').selectedIndex = 0;
    document.getElementById('sponsorship-edit-id').value = '';
}

function loadSponsorshipTable() {
    const sponsorships = JSON.parse(localStorage.getItem('sponsorships') || '[]');
    const tbody = document.getElementById('sponsorship-body');
    tbody.innerHTML = '';

    sponsorships.forEach(s => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${DOMPurify.sanitize(s.sponsor)}</td>
            <td>${DOMPurify.sanitize(s.sponsee)}</td>
            <td>${s.type}</td>
            <td>${new Date(s.startDate).toLocaleDateString()}</td>
            <td>${s.currentStep ? 'Step ' + s.currentStep : 'N/A'}</td>
            <td>
                <button class="btn secondary" data-action="delete-sponsorship" data-id="${escapeAttribute(s.id)}" style="padding: 0.25rem 0.5rem; font-size: 0.85rem;">Delete</button>
            </td>
        `;
    });
}

function deleteSponsorship(id) {
    if (!confirm('Delete this sponsorship relationship?')) return;
    let sponsorships = JSON.parse(localStorage.getItem('sponsorships') || '[]');
    sponsorships = sponsorships.filter(s => s.id !== id);
    localStorage.setItem('sponsorships', JSON.stringify(sponsorships));
    loadSponsorshipTable();
    loadSponsorshipTree();
    showToast('Sponsorship relationship deleted', 'success');
}

function loadSponsorshipTree() {
    const container = document.getElementById('sponsorship-tree');
    container.innerHTML = '<p>Sponsorship tree visualization - Feature coming soon</p>';
}

// DISTRICT/AREA FUNCTIONS
function handleGSRReportSubmit() {
    const date = document.getElementById('gsr-report-date').value;
    const meetingType = document.getElementById('gsr-meeting-type').value;
    const content = document.getElementById('gsr-report-content').value.trim();
    const actionItems = document.getElementById('gsr-action-items').value.trim();

    if (!date || !content) {
        showToast('Please fill all required fields', 'error');
        return;
    }

    let reports = JSON.parse(localStorage.getItem('gsrReports') || '[]');
    reports.push({
        id: Date.now().toString(),
        date,
        meetingType,
        content,
        actionItems,
        timestamp: new Date().toISOString()
    });

    localStorage.setItem('gsrReports', JSON.stringify(reports));
    showToast('GSR report saved successfully', 'success');
    loadGSRReports();
    document.getElementById('gsr-report-date').value = '';
    document.getElementById('gsr-report-content').value = '';
    document.getElementById('gsr-action-items').value = '';
}

function cancelGSRReportEdit() {
    document.getElementById('gsr-report-date').value = '';
    document.getElementById('gsr-report-content').value = '';
    document.getElementById('gsr-action-items').value = '';
}

function loadGSRReports() {
    const reports = JSON.parse(localStorage.getItem('gsrReports') || '[]').reverse();
    const container = document.getElementById('gsr-reports-list');

    if (reports.length === 0) {
        container.innerHTML = '<p>No GSR reports yet</p>';
        return;
    }

    let html = '';
    reports.slice(0, 5).forEach(r => {
        html += `
            <div class="box mb-2">
                <div><strong>${new Date(r.date).toLocaleDateString()}</strong> - ${r.meetingType}</div>
                <div style="margin-top: 0.5rem;">${DOMPurify.sanitize(r.content)}</div>
                ${r.actionItems ? `<div style="margin-top: 0.5rem; color: #f39c12;"><strong>Action Items:</strong> ${DOMPurify.sanitize(r.actionItems)}</div>` : ''}
            </div>
        `;
    });
    container.innerHTML = html;
}

function addDistrictMeeting() {
    const date = document.getElementById('district-schedule-date').value;
    const time = document.getElementById('district-schedule-time').value;
    const location = document.getElementById('district-schedule-location').value;

    if (!date || !time || !location) {
        showToast('Please fill all fields', 'error');
        return;
    }

    let meetings = JSON.parse(localStorage.getItem('districtMeetings') || '[]');
    meetings.push({
        id: Date.now().toString(),
        date,
        time,
        location
    });

    localStorage.setItem('districtMeetings', JSON.stringify(meetings));
    showToast('Meeting added to schedule', 'success');
    loadDistrictMeetings();
    document.getElementById('district-schedule-date').value = '';
    document.getElementById('district-schedule-time').value = '';
    document.getElementById('district-schedule-location').value = '';
}

function loadDistrictMeetings() {
    const meetings = JSON.parse(localStorage.getItem('districtMeetings') || '[]')
        .filter(m => new Date(m.date) >= new Date())
        .sort((a, b) => new Date(a.date) - new Date(b.date));

    const container = document.getElementById('district-meetings-list');

    if (meetings.length === 0) {
        container.innerHTML = '<p>No upcoming meetings</p>';
        return;
    }

    let html = '<ul style="list-style: none; padding: 0;">';
    meetings.forEach(m => {
        html += `
            <li style="padding: 0.5rem; border-bottom: 1px solid #7f8c8d;">
                <strong>${new Date(m.date).toLocaleDateString()}</strong> at ${m.time}<br>
                Location: ${DOMPurify.sanitize(m.location)}
            </li>
        `;
    });
    html += '</ul>';
    container.innerHTML = html;
}

function addDCMCommunication() {
    const date = document.getElementById('dcm-comm-date').value;
    const content = document.getElementById('dcm-comm-content').value.trim();

    if (!date || !content) {
        showToast('Please fill all fields', 'error');
        return;
    }

    let communications = JSON.parse(localStorage.getItem('dcmCommunications') || '[]');
    communications.push({
        id: Date.now().toString(),
        date,
        content
    });

    localStorage.setItem('dcmCommunications', JSON.stringify(communications));
    showToast('Communication logged', 'success');
    loadDCMCommunications();
    document.getElementById('dcm-comm-date').value = '';
    document.getElementById('dcm-comm-content').value = '';
}

function loadDCMCommunications() {
    const communications = JSON.parse(localStorage.getItem('dcmCommunications') || '[]').reverse();
    const container = document.getElementById('dcm-comm-history');

    if (communications.length === 0) {
        container.innerHTML = '<p>No communications logged</p>';
        return;
    }

    let html = '';
    communications.slice(0, 5).forEach(c => {
        html += `
            <div class="box mb-2">
                <div><strong>${new Date(c.date).toLocaleDateString()}</strong></div>
                <div>${DOMPurify.sanitize(c.content)}</div>
            </div>
        `;
    });
    container.innerHTML = html;
}

// PRUDENT RESERVE FUNCTIONS
function calculateReserveTarget() {
    const monthlyExpenses = parseFloat(document.getElementById('monthly-expenses').value) || 0;
    const months = parseInt(document.getElementById('reserve-months').value) || 3;
    const target = monthlyExpenses * months;
    document.getElementById('reserve-target').value = target.toFixed(2);
    showToast(`Reserve target calculated: $${target.toFixed(2)}`, 'success');
}

function saveReserveSettings() {
    const target = parseFloat(document.getElementById('reserve-target').value) || 0;
    const monthlyExpenses = parseFloat(document.getElementById('monthly-expenses').value) || 0;
    const months = parseInt(document.getElementById('reserve-months').value) || 3;

    localStorage.setItem('reserveSettings', JSON.stringify({ target, monthlyExpenses, months }));
    showToast('Reserve settings saved', 'success');
    updateReserveStatus();
}

function updateReserveStatus() {
    const settings = JSON.parse(localStorage.getItem('reserveSettings') || '{}');
    document.getElementById('display-reserve-target').textContent = (settings.target || 0).toFixed(2);
    // Additional logic to calculate current balances from financial data would go here
}

function load7thTraditionPeriod(period) {
    showToast(`Loading ${period} view`, 'success');
}

function saveContributionGoal() {
    const goal = parseFloat(document.getElementById('contribution-goal').value) || 0;
    localStorage.setItem('contributionGoal', goal);
    showToast('Contribution goal saved', 'success');
}

// CHIP INVENTORY FUNCTIONS
function updateChipInventory() {
    const type = document.getElementById('chip-type').value;
    const quantity = parseInt(document.getElementById('chip-quantity').value) || 0;
    const threshold = parseInt(document.getElementById('chip-low-threshold').value) || 5;

    let inventory = JSON.parse(localStorage.getItem('chipInventory') || '{}');
    inventory[type] = { quantity, threshold };
    localStorage.setItem('chipInventory', JSON.stringify(inventory));

    showToast('Chip inventory updated', 'success');
    loadChipInventory();
    checkChipAlerts();
}

function loadChipInventory() {
    const inventory = JSON.parse(localStorage.getItem('chipInventory') || '{}');
    const tbody = document.getElementById('chip-inventory-body');
    tbody.innerHTML = '';

    const chipTypes = ['24-hour', '30-day', '60-day', '90-day', '6-month', '9-month', '1-year', '18-month', 'multi-year'];

    chipTypes.forEach(type => {
        const data = inventory[type] || { quantity: 0, threshold: 5 };
        const status = data.quantity <= data.threshold ? 'LOW STOCK' : 'OK';
        const statusColor = data.quantity <= data.threshold ? '#e74c3c' : '#2ecc71';

        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${type}</td>
            <td>${data.quantity}</td>
            <td style="color: ${statusColor};">${status}</td>
            <td>${data.threshold}</td>
        `;
    });
}

function checkChipAlerts() {
    const inventory = JSON.parse(localStorage.getItem('chipInventory') || '{}');
    const container = document.getElementById('chip-alerts');

    const lowStock = Object.entries(inventory).filter(([type, data]) => data.quantity <= data.threshold);

    if (lowStock.length === 0) {
        container.innerHTML = '<p style="color: #2ecc71;">All chip levels are good</p>';
        return;
    }

    let html = '<ul style="list-style: none; padding: 0; color: #e74c3c;">';
    lowStock.forEach(([type, data]) => {
        html += `<li style="padding: 0.25rem;"><i class="fas fa-exclamation-triangle"></i> ${type}: ${data.quantity} remaining</li>`;
    });
    html += '</ul>';
    container.innerHTML = html;
}

function logChipDistribution() {
    const type = document.getElementById('dist-chip-type').value;
    const recipient = document.getElementById('dist-recipient').value.trim();
    const date = document.getElementById('dist-date').value;

    if (!date) {
        showToast('Please select a date', 'error');
        return;
    }

    let distributions = JSON.parse(localStorage.getItem('chipDistributions') || '[]');
    distributions.push({
        id: Date.now().toString(),
        type,
        recipient,
        date
    });

    localStorage.setItem('chipDistributions', JSON.stringify(distributions));

    // Decrement inventory
    let inventory = JSON.parse(localStorage.getItem('chipInventory') || '{}');
    if (inventory[type] && inventory[type].quantity > 0) {
        inventory[type].quantity--;
        localStorage.setItem('chipInventory', JSON.stringify(inventory));
        loadChipInventory();
        checkChipAlerts();
    }

    showToast('Chip distribution logged', 'success');
    loadChipDistributions();
    document.getElementById('dist-recipient').value = '';
    document.getElementById('dist-date').value = '';
}

function loadChipDistributions() {
    const distributions = JSON.parse(localStorage.getItem('chipDistributions') || '[]').reverse();
    const tbody = document.getElementById('chip-distribution-body');
    tbody.innerHTML = '';

    distributions.slice(0, 10).forEach(d => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${new Date(d.date).toLocaleDateString()}</td>
            <td>${d.type}</td>
            <td>${DOMPurify.sanitize(d.recipient) || 'Anonymous'}</td>
        `;
    });
}

// LIVE GC FUNCTIONS
function addLiveGCItem() {
    const item = document.getElementById('live-gc-new-item').value.trim();
    if (!item) {
        showToast('Please enter an item', 'error');
        return;
    }

    let queue = JSON.parse(localStorage.getItem('liveGCQueue') || '[]');
    queue.push({
        id: Date.now().toString(),
        item,
        status: 'pending',
        timestamp: new Date().toISOString()
    });

    localStorage.setItem('liveGCQueue', JSON.stringify(queue));
    showToast('Item added to queue', 'success');
    loadLiveGCQueue();
    document.getElementById('live-gc-new-item').value = '';
}

function loadLiveGCQueue() {
    const queue = JSON.parse(localStorage.getItem('liveGCQueue') || '[]');
    const tbody = document.getElementById('live-gc-queue-body');
    tbody.innerHTML = '';

    queue.forEach(item => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${DOMPurify.sanitize(item.item)}</td>
            <td>${item.status}</td>
            <td>
                <button class="btn secondary" data-action="update-gc-status" data-id="${escapeAttribute(item.id)}" data-status="discussed" style="padding: 0.25rem 0.5rem; font-size: 0.85rem;">Mark Discussed</button>
                <button class="btn secondary" data-action="remove-gc-item" data-id="${escapeAttribute(item.id)}" style="padding: 0.25rem 0.5rem; font-size: 0.85rem; margin-left: 0.25rem;">Remove</button>
            </td>
        `;
    });
}

function updateGCItemStatus(id, status) {
    let queue = JSON.parse(localStorage.getItem('liveGCQueue') || '[]');
    const item = queue.find(i => i.id === id);
    if (item) {
        item.status = status;
        localStorage.setItem('liveGCQueue', JSON.stringify(queue));
        loadLiveGCQueue();
        showToast('Status updated', 'success');
    }
}

function removeGCItem(id) {
    let queue = JSON.parse(localStorage.getItem('liveGCQueue') || '[]');
    queue = queue.filter(i => i.id !== id);
    localStorage.setItem('liveGCQueue', JSON.stringify(queue));
    loadLiveGCQueue();
    showToast('Item removed', 'success');
}

// Initialize new sections on load
function initNewSections() {
    // Populate member dropdowns
    const members = JSON.parse(localStorage.getItem('members') || '[]');
    const memberSelects = [
        'commitment-member',
        'sponsor-name',
        'sponsee-name',
        'attendance-members'
    ];

    memberSelects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select) {
            select.innerHTML = '<option value="">-- Select Member --</option>';
            members.forEach(m => {
                const option = document.createElement('option');
                option.value = m.name;
                option.textContent = m.name;
                select.appendChild(option);
            });
        }
    });

    // Initialize all tables and displays
    if (document.getElementById('format-rotation-section')) {
        loadFormatRotationTable();
        loadUpcomingFormats();
        updateCurrentWeekFormat();
    }

    if (document.getElementById('commitment-board-section')) {
        loadCommitmentTable();
        loadCurrentWeekCommitments();
    }

    if (document.getElementById('secretary-section')) {
        loadAttendanceHistory();
        updateAttendanceStats();
    }

    if (document.getElementById('gc-decisions-section')) {
        const gcLog = JSON.parse(localStorage.getItem('gcLog') || '[]');
        displayGCDecisions(gcLog);

        // Populate year filter
        const years = [...new Set(gcLog.map(d => new Date(d.date).getFullYear()))];
        const yearSelect = document.getElementById('gc-filter-year');
        if (yearSelect) {
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            });
        }

        // Populate motion link dropdowns
        const linkSelects = ['gc-link-primary', 'gc-link-related'];
        linkSelects.forEach(selectId => {
            const select = document.getElementById(selectId);
            if (select) {
                select.innerHTML = '<option value="">-- Select Motion --</option>';
                gcLog.forEach(d => {
                    const option = document.createElement('option');
                    option.value = d.id;
                    option.textContent = `${new Date(d.date).toLocaleDateString()} - ${d.item.substring(0, 50)}...`;
                    select.appendChild(option);
                });
            }
        });
    }

    if (document.getElementById('gc-inventory-section')) {
        loadAnonymousFeedback();
    }

    if (document.getElementById('gc-bylaws-section')) {
        loadByLawsHistory();
        loadCurrentByLaws();
    }

    if (document.getElementById('sponsorship-section')) {
        loadSponsorshipTable();
        loadSponsorshipTree();
    }

    if (document.getElementById('district-area-section')) {
        loadGSRReports();
        loadDistrictMeetings();
        loadDCMCommunications();
    }

    if (document.getElementById('prudent-reserve-section')) {
        updateReserveStatus();
    }

    if (document.getElementById('chip-inventory-section')) {
        loadChipInventory();
        checkChipAlerts();
        loadChipDistributions();
    }

    if (document.getElementById('gc-live-section')) {
        loadLiveGCQueue();
    }

    // Show step progress group when program sponsorship is selected
    const sponsorshipType = document.getElementById('sponsorship-type');
    if (sponsorshipType) {
        sponsorshipType.addEventListener('change', function() {
            const stepGroup = document.getElementById('step-progress-group');
            if (stepGroup) {
                stepGroup.style.display = this.value === 'program' ? 'block' : 'none';
            }
        });
    }

    // Initialize notifications and reminders
    requestNotificationPermission();
    checkUpcomingReminders();
}

// ========================================
// BROWSER NOTIFICATIONS
// ========================================
function requestNotificationPermission() {
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }
}

function sendNotification(title, body, icon = null) {
    if ('Notification' in window && Notification.permission === 'granted') {
        const options = {
            body: body,
            icon: icon || 'logo.svg',
            badge: 'logo.svg',
            vibrate: [200, 100, 200],
            tag: 'rowlett-group-notification'
        };

        const notification = new Notification(title, options);

        notification.onclick = function() {
            window.focus();
            notification.close();
        };
    }
}

// Track reminder timeout to allow cancellation
let reminderTimeoutId = null;

function checkUpcomingReminders() {
    try {
        // Check for upcoming meetings
        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);

        let events = [];
        try {
            events = JSON.parse(localStorage.getItem('events') || '[]');
        } catch(e) {
            console.error('Error parsing events for reminders:', e);
        }

        const upcomingEvents = events.filter(e => {
            if (!e.date) return false;
            const eventDate = new Date(e.date);
            return eventDate.toDateString() === tomorrow.toDateString();
        });

        if (upcomingEvents.length > 0) {
            upcomingEvents.forEach(event => {
                sendNotification('Upcoming Meeting Tomorrow', event.title + ' at ' + event.time);
            });
        }

        // Check for upcoming birthdays (7 days ahead)
        const weekAhead = new Date(today);
        weekAhead.setDate(weekAhead.getDate() + 7);

        let members = [];
        try {
            members = JSON.parse(localStorage.getItem('members') || '[]');
        } catch(e) {
            console.error('Error parsing members for reminders:', e);
        }

        members.forEach(member => {
            if (member.birthday) {
                const birthday = new Date(member.birthday);
                birthday.setFullYear(today.getFullYear());

                if (birthday.toDateString() === weekAhead.toDateString()) {
                    sendNotification('Upcoming Birthday', member.name + '\'s birthday is in one week!');
                }
            }
        });

        // Check for commitment reminders (2 days ahead)
        const twoDaysAhead = new Date(today);
        twoDaysAhead.setDate(twoDaysAhead.getDate() + 2);

        let commitments = [];
        try {
            commitments = JSON.parse(localStorage.getItem('meetingCommitments') || '[]');
        } catch(e) {
            console.error('Error parsing commitments for reminders:', e);
        }

        const upcomingCommitments = commitments.filter(c => {
            if (!c.date) return false;
            const commitDate = new Date(c.date);
            return c.reminder && commitDate.toDateString() === twoDaysAhead.toDateString();
        });

        upcomingCommitments.forEach(commitment => {
            sendNotification('Meeting Commitment Reminder',
                'You are signed up for ' + commitment.role + ' in 2 days on ' + new Date(commitment.date).toLocaleDateString());
        });

        // Check again in 1 hour (clear previous timeout to prevent duplicates)
        if (reminderTimeoutId) {
            clearTimeout(reminderTimeoutId);
        }
        reminderTimeoutId = setTimeout(checkUpcomingReminders, 60 * 60 * 1000);
    } catch(e) {
        console.error('Error in checkUpcomingReminders:', e);
    }
}

// Function to stop reminder checks (useful for cleanup)
function stopReminderChecks() {
    if (reminderTimeoutId) {
        clearTimeout(reminderTimeoutId);
        reminderTimeoutId = null;
    }
}

// ========================================
// PWA MANIFEST INJECTION
// ========================================
function injectPWAManifest() {
    const manifest = {
        "name": "Rowlett Group - AA Group Conscience",
        "short_name": "Rowlett Group",
        "description": "Internal AA Group Conscience application for meeting management",
        "start_url": "./index.html",
        "display": "standalone",
        "background_color": "#2c3e50",
        "theme_color": "#3498db",
        "orientation": "any",
        "icons": [
            {
                "src": "logo.svg",
                "sizes": "any",
                "type": "image/svg+xml",
                "purpose": "any maskable"
            }
        ],
        "categories": ["productivity", "lifestyle"],
        "screenshots": []
    };

    const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
    const manifestURL = URL.createObjectURL(manifestBlob);

    const link = document.createElement('link');
    link.rel = 'manifest';
    link.href = manifestURL;
    document.head.appendChild(link);

    // Revoke the object URL after a short delay to free memory
    // (link element should have processed it by then)
    setTimeout(() => {
        URL.revokeObjectURL(manifestURL);
    }, 100);
}

// Initialize PWA
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', injectPWAManifest);
} else {
    injectPWAManifest();
}

    </script>
</body>
</html>